<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> microcorruption - new orleans | #!/slash/note</title>
  <meta name="description" content="[&#39;Caffeine fueled&#39;, &#39;(╯°□°)╯︵ ┻━┻&#39;, &#39;Security guy&#39;, &#39;Metalhead&#39;, &#39;I saw your password&#39;, &#39;KOOBo&#43;KXleKAv&#43;KXlSnjgaM=&#39;]">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="microcorruption - new orleans" />
<meta property="og:description" content="
     


The next post in the series of solving the microcorruption.com ctf challenges continues from the previous small tutorial challenge post. This challenge is titled New Orleans." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leonjza.github.io/blog/2018/03/03/microcorruption-new-orleans/" />
<meta property="article:published_time" content="2018-03-03T22:21:36+02:00" />
<meta property="article:modified_time" content="2018-03-03T22:21:36+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="microcorruption - new orleans"/>
<meta name="twitter:description" content="
     


The next post in the series of solving the microcorruption.com ctf challenges continues from the previous small tutorial challenge post. This challenge is titled New Orleans."/>

  
  
  
  <link rel="stylesheet" href="https://leonjza.github.io/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://leonjza.github.io/images/favicon.png" />

  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44457032-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://leonjza.github.io">
  
    <div id="logo" style="background-image: url(https://leonjza.github.io/images/logo.png)"></div>
  
  <div id="title">
    <h1>#!/slash/note</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="https://leonjza.github.io/">Home</a></li>
      
        <li><a href="https://leonjza.github.io/about/">About Me</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <figure>
    <img src="https://leonjza.github.io/images/microcorruption/microcorruption.png"/> 
</figure>

<p>The next post in the series of solving the <a href="https://microcorruption.com">microcorruption.com</a> ctf challenges continues from the <a href="https://leonjza.github.io/blog/2018/03/03/microcorruption---tutorial/">previous small tutorial challenge</a> post. This challenge is titled <em>New Orleans</em>.</p>
<h2 id="new-orleans">new orleans</h2>
<p>This challenge no longer holds your hand in terms of a nice and easy to follow tutorial. Instead, you are presented with the machine code and the debugger. Lets get to it!</p>
<p>You will immediately notice that there are a lot of functions in the beginning of the code section that do some setup work. Although important, they are not always that interesting. Instead, we are almost always only really interested in what happens once we hit the <code>main</code> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">4438 &lt;<span style="color:#50fa7b">main</span>&gt;
4438:  3150 9<span style="color:#50fa7b">cff</span>      add   <span style="color:#6272a4">#0xff9c, sp
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">443</span>c:  b012 <span style="color:#bd93f9">7</span>e44      call  <span style="color:#6272a4">#0x447e &lt;create_password&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4440</span>:  <span style="color:#bd93f9">3</span>f40 e444      mov   <span style="color:#6272a4">#0x44e4 &#34;Enter the password to continue&#34;, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4444</span>:  b012 <span style="color:#bd93f9">9445</span>      call  <span style="color:#6272a4">#0x4594 &lt;puts&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4448</span>:  <span style="color:#bd93f9">0</span>f41           mov   sp, r15
444<span style="color:#8be9fd;font-style:italic">a:</span>  <span style="color:#50fa7b">b012</span> b244      call  <span style="color:#6272a4">#0x44b2 &lt;get_password&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">444</span>e:  <span style="color:#bd93f9">0</span>f41           mov   sp, r15
4450:  <span style="color:#50fa7b">b012</span> bc44      call  <span style="color:#6272a4">#0x44bc &lt;check_password&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4454</span>:  <span style="color:#bd93f9">0</span>f93           tst   r15
4456:  0520           <span style="color:#50fa7b">jnz</span>   <span style="color:#6272a4">#0x4462 &lt;main+0x2a&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4458</span>:  <span style="color:#bd93f9">3</span>f40 <span style="color:#bd93f9">0345</span>      mov   <span style="color:#6272a4">#0x4503 &#34;Invalid password; try again.&#34;, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">445</span>c:  b012 <span style="color:#bd93f9">9445</span>      call  <span style="color:#6272a4">#0x4594 &lt;puts&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4460</span>:  <span style="color:#bd93f9">063</span>c           jmp   <span style="color:#6272a4">#0x446e &lt;main+0x36&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4462</span>:  <span style="color:#bd93f9">3</span>f40 <span style="color:#bd93f9">2045</span>      mov   <span style="color:#6272a4">#0x4520 &#34;Access Granted!&#34;, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4466</span>:  b012 <span style="color:#bd93f9">9445</span>      call  <span style="color:#6272a4">#0x4594 &lt;puts&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">446</span>a:  b012 d644      call  <span style="color:#6272a4">#0x44d6 &lt;unlock_door&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">446</span>e:  <span style="color:#bd93f9">0</span>f43           clr   r15
4470:  3150 6400      <span style="color:#50fa7b">add</span>   <span style="color:#6272a4">#0x64, sp
</span></code></pre></div><p>A quick look at the <code>call</code>&rsquo;s that get made, we can see the flow is pretty simple. First we run a <code>create_password</code> routine, then <code>get_password</code>, then do a <code>check_password</code>. Depending on the contents of <code>r15</code> once we have done that, we will jump to unlock the lock or not.</p>
<p>Lets take a closer look at <code>create_password</code>. This seems like an odd method to have.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">447<span style="color:#50fa7b">e</span> &lt;create_password&gt;
447<span style="color:#8be9fd;font-style:italic">e:</span>  3<span style="color:#50fa7b">f40</span> <span style="color:#bd93f9">0024</span>      mov   <span style="color:#6272a4">#0x2400, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4482</span>:  ff40 <span style="color:#bd93f9">2</span>e00 <span style="color:#bd93f9">0000</span> mov.b <span style="color:#6272a4">#0x2e, 0x0(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4488</span>:  ff40 <span style="color:#bd93f9">6700</span> <span style="color:#bd93f9">0100</span> mov.b <span style="color:#6272a4">#0x67, 0x1(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">448</span>e:  ff40 <span style="color:#bd93f9">3700</span> <span style="color:#bd93f9">0200</span> mov.b <span style="color:#6272a4">#0x37, 0x2(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4494</span>:  ff40 <span style="color:#bd93f9">4</span>d00 <span style="color:#bd93f9">0300</span> mov.b <span style="color:#6272a4">#0x4d, 0x3(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">449</span>a:  ff40 <span style="color:#bd93f9">4700</span> <span style="color:#bd93f9">0400</span> mov.b <span style="color:#6272a4">#0x47, 0x4(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>a0:  ff40 <span style="color:#bd93f9">4800</span> <span style="color:#bd93f9">0500</span> mov.b <span style="color:#6272a4">#0x48, 0x5(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>a6:  ff40 <span style="color:#bd93f9">2</span>f00 <span style="color:#bd93f9">0600</span> mov.b <span style="color:#6272a4">#0x2f, 0x6(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>ac:  cf43 <span style="color:#bd93f9">0700</span>      mov.b <span style="color:#6272a4">#0x0, 0x7(r15)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>b0:  <span style="color:#bd93f9">3041</span>           ret
</code></pre></div><p>The <code>create_password</code> routine seems to be moving some bytes (using <code>mov.b</code>) at incrementing offsets relative to <code>0x2400</code>. The final <code>mov.b</code> instruction at <code>0x44ac</code> moves a null byte into the last memory location before returning the method call. I guess its obvious what is going on here already.</p>
<p>Lets take a look at <code>check_password</code> too:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">44<span style="color:#50fa7b">bc</span> &lt;check_password&gt;
44<span style="color:#8be9fd;font-style:italic">bc:</span>  0<span style="color:#50fa7b">e43</span>           clr   r14
44<span style="color:#8be9fd;font-style:italic">be:</span>  0<span style="color:#50fa7b">d4f</span>           mov   r15, r13
44<span style="color:#8be9fd;font-style:italic">c0:</span>  0<span style="color:#50fa7b">d5e</span>           add   r14, r13
44<span style="color:#8be9fd;font-style:italic">c2:</span>  <span style="color:#50fa7b">ee9d</span> <span style="color:#bd93f9">0024</span>      cmp.b @r13, <span style="color:#bd93f9">0x2400</span>(r14)
44<span style="color:#8be9fd;font-style:italic">c6:</span>  0520           <span style="color:#50fa7b">jne</span>   <span style="color:#6272a4">#0x44d2 &lt;check_password+0x16&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>c8:  <span style="color:#bd93f9">1</span>e53           inc   r14
44<span style="color:#8be9fd;font-style:italic">ca:</span>  3<span style="color:#50fa7b">e92</span>           cmp   <span style="color:#6272a4">#0x8, r14
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>cc:  f823           jne   <span style="color:#6272a4">#0x44be &lt;check_password+0x2&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>ce:  <span style="color:#bd93f9">1</span>f43           mov   <span style="color:#6272a4">#0x1, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>d0:  <span style="color:#bd93f9">3041</span>           ret
44<span style="color:#8be9fd;font-style:italic">d2:</span>  0<span style="color:#50fa7b">f43</span>           clr   r15
44<span style="color:#8be9fd;font-style:italic">d4:</span>  3041           <span style="color:#50fa7b">ret</span>
</code></pre></div><p>A quick read seems like 8 <code>cmp.b</code> operations are performed from the same offset we have had when <code>create_password</code> started writing those bytes. So, <code>create_password</code> writes the password to memory, <code>check_password</code> just compares those bytes to the ones entered by the user.</p>
<p>Lets debug this application and see what it looks like. First, set a breakpoint just after <code>create_password</code> is done at <code>0x4440</code> with <code>break 4440</code>. This will let us have a peek at <code>0x2400</code> to see what that the memory looks like there. The next break point that might be interesting would be where the character comparisons are occurring in <code>check_password</code> at <code>0x44c2</code>, so add another break point with <code>break 44c2</code>. Finally, hit <code>c</code> to continue the CPU.</p>
<p>Right after we hit our first breakpoint, we can see that the bytes <code>2e67 374d 4748 2f00</code> were written from <code>0x2400</code> onwards.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/new_orleans_create_password.png"/> 
</figure>

<p>Using a small one-liner, we can convert the bytes that were written to ASCII and confirm it matches the section in memory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">~ » python -c <span style="color:#f1fa8c">&#34;print &#39;2e67374d47482f00&#39;.decode(&#39;hex&#39;)&#34;</span>
.g7MGH/
</code></pre></div><p>I am pretty sure this is the password, so continue the CPU and enter <code>.g7MGH/</code> when the interrupt prompts you for a password. Continue the CPU again until we hit our next breakpoint to see the byte comparisons occur. The CPU should step all the way though the loop for the password and finally hit the <code>mov</code> instruction at <code>0x44ce</code> which sets <code>r15</code> to <code>0x1</code> for that <code>tst</code> instruction in <code>main</code> later.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/new_orleans_win_state.png"/> 
</figure>

<p>The <code>tst</code> instruction on register <code>r15</code> should have a non-zero return in the state register <code>sr</code>, resulting in a win condition. This means the password is <code>.g7MGH/</code>!</p>
<h2 id="solution">solution</h2>
<p>Enter a password of <code>.g7MGH/</code> in ASCII or <code>2e67374d47482f00</code> as hex.</p>
<h2 id="other-challenges">other challenges</h2>
<p>For my other write ups in the microcorruption series, checkout <a href="https://leonjza.github.io/categories/microcorruption/">this</a> link</p>
  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Leon Jacobs 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="https://leonjza.github.io/">Home</a></li>
         
        <li><a href="https://leonjza.github.io/about/">About Me</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=https://leonjza.github.io/lib/font-awesome/css/all.min.css>
<script src=https://leonjza.github.io/lib/jquery/jquery.min.js></script>
<script src=https://leonjza.github.io/js/main.js></script>
</html>
