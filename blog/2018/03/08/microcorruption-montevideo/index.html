<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>microcorruption - montevideo | #!/bin/note
</title>
<meta name=keywords content>
<meta name=description content="
     


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:

This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.

Cool. So this one is going to be unbreakable right? Lets see!">
<meta name=author content="Leon Jacobs">
<link rel=canonical href=https://leonjza.github.io/blog/2018/03/08/microcorruption-montevideo/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://leonjza.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://leonjza.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://leonjza.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://leonjza.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://leonjza.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="microcorruption - montevideo">
<meta property="og:description" content="
     


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:

This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.

Cool. So this one is going to be unbreakable right? Lets see!">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2018/03/08/microcorruption-montevideo/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-03-08T18:12:36+02:00">
<meta property="article:modified_time" content="2018-03-08T18:12:36+02:00"><meta property="og:site_name" content="#!/bin/note
">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="microcorruption - montevideo">
<meta name=twitter:description content="
     


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:

This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.

Cool. So this one is going to be unbreakable right? Lets see!">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://leonjza.github.io/posts/"},{"@type":"ListItem","position":3,"name":"microcorruption - montevideo","item":"https://leonjza.github.io/blog/2018/03/08/microcorruption-montevideo/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"microcorruption - montevideo","name":"microcorruption - montevideo","description":"  This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.\nThe challenge has the following description when you start:\n This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.\n Cool. So this one is going to be unbreakable right? Lets see!\n","keywords":[],"articleBody":"  This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.\nThe challenge has the following description when you start:\n This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.\n Cool. So this one is going to be unbreakable right? Lets see!\nmontevideo Montevideo follows a similar code pattern when compared to some of the previous challenges we have done where a simple main routine calls login. Looking at login itself we can see a few new things:\n44f4 login [.. typical getsn call to get the password ..] ; strcpy, thats new! 451a: b012 dc45 call #0x45dc  451e: 3d40 6400 mov #0x64, r13 4522: 0e43 clr r14 4524: 3f40 0024 mov #0x2400, r15  ; memset is also an interesting one! 4528: b012 f045 call #0x45f0  452c: 0f41 mov sp, r15 ; probably checks the password again 452e: b012 4644 call #0x4446  4532: 0f93 tst r15 [.. some messages printed to tell if you unlocked or not ..] 4544: 3150 1000 add #0x10, sp 4548: 3041 ret The calls to strcpy and memset immediately jumped out at me here. I also figured since there is mention of the password size again the bug here might be related to a stack overflow too. To test this, I threw in like 30 A’s into the password field to see if the program breaks.\n   insn address unaligned\n Nice! The program counter (pc) has 0x4141 which most probably comes from our longer-than-its-supposed-to-be password we supplied. With this bug in mind, I quickly had a look at the other routines to see if there is anything interesting happening there. I set up a total of four breakpoints at the following locations:\n 0x4510 at getsn 0x451a at strcpy 0x4528 at memset 0x452e at conditional_unlock_door  Inspecting these routines manually, as well as the memory layout after each function had me draw the following conclusions:\n After getsn is done, the password buffer lives at 0x2400 in memory. Once strcpy is done, the password buffer at 0x2400 is copied into a buffer that starts at 0x43ef. After memset is done, the password buffer at 0x2400 is zeroed out. After conditional_unlock_door with a too long password buffer, the stack is corrupt and the return address to main overridden.  It seems like this challenge is pretty much exactly the same as previous Whitehorse challenge? The conditional_unlock_door routine calls syscall 0x7e, so with our overflow this is not a useful location to jump to as the “HSM” will validate the password. So, like the previous one, we just need a spot to slide in some shellcode.\nBefore we can supply the shellcode though, we need to find out where we are overriding and corrupting the stack for that ret instruction. For this, I just supplied a bunch of A’s and B’s and found that at position 17 and 18 again we have control over the programs execution flow.\n  Next, we choose a location in memory where our password buffer is as the address we should jump to (as a result of the ret) which should also be the start of our shellcode. I simply copied the unlock shellcode from Whitehorse which was 30127f00b0123245. The shellcode itself needs a little work though as the address to the INT routine would be different here.\nTo help with the shellcode modifications we need to do, we can use the assembler/dissasembler provided on microcorruption.com here. Grab the opcodes that form part of our shellcode, paste them into the input box and hit disassemble. Now, with the ASM mnemonics in the input box, update the address to call to 0x454c as that is where it lives in this challenge. Finally, hit assemble and be presented with your shellcode :D\n  I figured a good spot to jump to our shellcode would be just after the ret address at 0x4400, so, my password payload was now going to be:\n# ret is 0x4400, so 0044 little endian [padding to ret] + [ret] + [shellcode] --------------------------------------------- 41 * 16 + 0044 + 30127f00b0124c45 = # final password payload 41414141414141414141414141414141004430127f00b0124c45 Sending this password payload, and inspecting the program after a breakpoint at 0x4548 left the program in a confusing state.\n  It was clear that the jump to 0x4400 was taken as the program counter (pc) was there, but, my shellcode was missing. Well… if you have ever dealt with strcpy before, you may have spotted that this was going to happen as soon as I chose 0x4400 as the address to jump to, as that address contains a nullbyte which is a string terminator for strcpy. Easy fix really, just move along two bytes to avoid a 0x00 byte in our payload. With a two byte shift, our password payload looks something like this now:\n[padding to ret] + [ret] + [pad] + [shellcode] ----------------------------------------------------- 41 * 16 + 0244 + 4242 + 30127f00b0124c45 414141414141414141414141414141410244424230127f00b0124c45   Snap. We have made some progress, but there is still a null byte in our shellcode because of the opcodes that form part of the push #0x7f instruction (3012 7f00). We need to get rid of the 0x00 byte. We can simply modify the shellcode to use any other instructions that will eventually push the value 0xf7 to the stack. Think of things like moving a large value into a register, performing arithmetic and then moving the resultant register value onto the stack instead of the original value as is.\nI used existing instructions in the program as a reference for ideas on how I can modify the shellcode to avoid null bytes. This was the final shellcode I got to work using the disassembler here:\nmov #0x117e, r9 sub #0x10ff, r9 push r9 call #0x454c First, I took a large 2 byte value of 0x117e and moved that to r9. I then took a calculator and subtracted the desired value of 0x7f from 0x117e and got to 0x10ff. That resulted in my second instruction of sub #0x10ff, r9 which should leave the value 0x7f in register r9. Finally, just push r9 onto the stack and call INT.\n  So now, my final password payload looks as follows:\npython -c \"print('41' * 16 + '0244' + '4242' + '39407e113980ff100912b0124c45')\" 414141414141414141414141414141410244424239407e113980ff100912b0124c45   Works! r9 ends up as 0x7f, pushed to the stack and INT is called to unlock the lock.\nsolution Enter 414141414141414141414141414141410244424239407e113980ff100912b0124c45 as hex encoded input.\nother challenges For my other write ups in the microcorruption series, checkout this link.\n","wordCount":"1101","inLanguage":"en","datePublished":"2018-03-08T18:12:36+02:00","dateModified":"2018-03-08T18:12:36+02:00","author":{"@type":"Person","name":"Leon Jacobs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://leonjza.github.io/blog/2018/03/08/microcorruption-montevideo/"},"publisher":{"@type":"Organization","name":"#!/bin/note\n","logo":{"@type":"ImageObject","url":"https://leonjza.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://leonjza.github.io accesskey=h title="#!/bin/note
 (Alt + H)">#!/bin/note
</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://leonjza.github.io/about/ title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/categories title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://leonjza.github.io>Home</a>&nbsp;»&nbsp;<a href=https://leonjza.github.io/posts/>Posts</a></div>
<h1 class=post-title>
microcorruption - montevideo
</h1>
<div class=post-meta>March 8, 2018&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Leon Jacobs&nbsp;|&nbsp;<a href=https://github.com/leonjza/leonjza.github.io/tree/source/content/posts/2018-03-08-microcorruption---montevideo.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#montevideo aria-label=montevideo>montevideo</a></li>
<li>
<a href=#solution aria-label=solution>solution</a></li>
<li>
<a href=#other-challenges aria-label="other challenges">other challenges</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><figure>
<img loading=lazy src=/images/microcorruption/microcorruption.png>
</figure>
<p>This post is part of the series of solving <a href=https://microcorruption.com>microcorruption.com</a> ctf challenges which continues from the <a href=https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/>previous challenge</a> called <em>Whitehorse</em>. This challenge is titled <em>Montevideo</em>.</p>
<p>The challenge has the following description when you start:</p>
<blockquote>
<p>This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.</p>
</blockquote>
<p>Cool. So this one is going to be unbreakable right? Lets see!</p>
<h2 id=montevideo>montevideo<a hidden class=anchor aria-hidden=true href=#montevideo>#</a></h2>
<p>Montevideo follows a similar code pattern when compared to some of the previous challenges we have done where a simple <code>main</code> routine calls <code>login</code>. Looking at <code>login</code> itself we can see a few new things:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#960050;background-color:#1e0010>44</span><span style=color:#a6e22e>f4</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>login</span><span style=color:#960050;background-color:#1e0010>&gt;</span>

<span style=color:#960050;background-color:#1e0010>[</span><span style=color:#a6e22e>..</span> <span style=color:#66d9ef>typical</span> <span style=color:#66d9ef>getsn</span> <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>get</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>password</span> <span style=color:#66d9ef>..</span>]

<span style=color:#75715e>; strcpy, thats new!
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>451</span>a:  <span style=color:#a6e22e>b012</span> <span style=color:#66d9ef>dc45</span>      <span style=color:#66d9ef>call</span>  <span style=color:#75715e>#0x45dc &lt;strcpy&gt;
</span><span style=color:#75715e></span><span style=color:#ae81ff>451</span><span style=color:#66d9ef>e</span>:  <span style=color:#ae81ff>3</span><span style=color:#66d9ef>d40</span> <span style=color:#ae81ff>6400</span>      <span style=color:#66d9ef>mov</span>   <span style=color:#75715e>#0x64, r13
</span><span style=color:#75715e></span><span style=color:#ae81ff>4522</span>:  <span style=color:#ae81ff>0</span><span style=color:#66d9ef>e43</span>           <span style=color:#66d9ef>clr</span>   <span style=color:#66d9ef>r14</span>
<span style=color:#960050;background-color:#1e0010>4524:</span>  <span style=color:#960050;background-color:#1e0010>3</span><span style=color:#a6e22e>f40</span> <span style=color:#ae81ff>0024</span>      <span style=color:#66d9ef>mov</span>   <span style=color:#75715e>#0x2400, r15
</span><span style=color:#75715e></span>
<span style=color:#75715e>; memset is also an interesting one!
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>4528:</span>  <span style=color:#a6e22e>b012</span> <span style=color:#66d9ef>f045</span>      <span style=color:#66d9ef>call</span>  <span style=color:#75715e>#0x45f0 &lt;memset&gt;
</span><span style=color:#75715e></span><span style=color:#ae81ff>452</span><span style=color:#66d9ef>c</span>:  <span style=color:#ae81ff>0</span><span style=color:#66d9ef>f41</span>           <span style=color:#66d9ef>mov</span>   <span style=color:#66d9ef>sp</span>, <span style=color:#66d9ef>r15</span>

<span style=color:#75715e>; probably checks the password again
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>452</span>e:  <span style=color:#a6e22e>b012</span> <span style=color:#ae81ff>4644</span>      <span style=color:#66d9ef>call</span>  <span style=color:#75715e>#0x4446 &lt;conditional_unlock_door&gt;
</span><span style=color:#75715e></span><span style=color:#ae81ff>4532</span>:  <span style=color:#ae81ff>0</span><span style=color:#66d9ef>f93</span>           <span style=color:#66d9ef>tst</span>   <span style=color:#66d9ef>r15</span>

<span style=color:#960050;background-color:#1e0010>[</span><span style=color:#a6e22e>..</span> <span style=color:#66d9ef>some</span> <span style=color:#66d9ef>messages</span> <span style=color:#66d9ef>printed</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>tell</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>you</span> <span style=color:#66d9ef>unlocked</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>..</span>]

<span style=color:#960050;background-color:#1e0010>4544:</span>  <span style=color:#960050;background-color:#1e0010>3150</span> <span style=color:#960050;background-color:#1e0010>1000</span>      <span style=color:#a6e22e>add</span>   <span style=color:#75715e>#0x10, sp
</span><span style=color:#75715e></span><span style=color:#ae81ff>4548</span>:  <span style=color:#ae81ff>3041</span>           <span style=color:#66d9ef>ret</span>
</code></pre></div><p>The calls to <code>strcpy</code> and <code>memset</code> immediately jumped out at me here. I also figured since there is mention of the password size again the bug here might be related to a stack overflow too. To test this, I threw in like 30 <code>A</code>&rsquo;s into the password field to see if the program breaks.</p>
<figure>
<img loading=lazy src=/images/microcorruption/montevideo_stack_overflow.png>
</figure>
<blockquote>
<p>insn address unaligned</p>
</blockquote>
<p>Nice! The program counter (<code>pc</code>) has <code>0x4141</code> which most probably comes from our longer-than-its-supposed-to-be password we supplied. With this bug in mind, I quickly had a look at the other routines to see if there is anything interesting happening there. I set up a total of four breakpoints at the following locations:</p>
<ul>
<li><code>0x4510</code> at <code>getsn</code></li>
<li><code>0x451a</code> at <code>strcpy</code></li>
<li><code>0x4528</code> at <code>memset</code></li>
<li><code>0x452e</code> at <code>conditional_unlock_door</code></li>
</ul>
<p>Inspecting these routines manually, as well as the memory layout after each function had me draw the following conclusions:</p>
<ul>
<li>After <code>getsn</code> is done, the password buffer lives at <code>0x2400</code> in memory.</li>
<li>Once <code>strcpy</code> is done, the password buffer at <code>0x2400</code> is copied into a buffer that starts at <code>0x43ef</code>.</li>
<li>After <code>memset</code> is done, the password buffer at <code>0x2400</code> is zeroed out.</li>
<li>After <code>conditional_unlock_door</code> with a too long password buffer, the stack is corrupt and the return address to <code>main</code> overridden.</li>
</ul>
<p>It seems like this challenge is pretty much exactly the same as previous Whitehorse challenge? The <code>conditional_unlock_door</code> routine calls syscall <code>0x7e</code>, so with our overflow this is not a useful location to jump to as the &ldquo;HSM&rdquo; will validate the password. So, like the previous one, we just need a spot to slide in some shellcode.</p>
<p>Before we can supply the shellcode though, we need to find out where we are overriding and corrupting the stack for that <code>ret</code> instruction. For this, I just supplied a bunch of <code>A</code>&rsquo;s and <code>B</code>&rsquo;s and found that at position 17 and 18 again we have control over the programs execution flow.</p>
<figure>
<img loading=lazy src=/images/microcorruption/monte_video_ret_control.png>
</figure>
<p>Next, we choose a location in memory where our password buffer is as the address we should jump to (as a result of the <code>ret</code>) which should also be the start of our shellcode. I simply copied the unlock shellcode from <a href=https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/>Whitehorse</a> which was <code>30127f00b0123245</code>. The shellcode itself needs a little work though as the address to the <code>INT</code> routine would be different here.</p>
<p>To help with the shellcode modifications we need to do, we can use the assembler/dissasembler provided on microcorruption.com <a href=https://microcorruption.com/assembler>here</a>. Grab the opcodes that form part of our shellcode, paste them into the input box and hit disassemble. Now, with the ASM mnemonics in the input box, update the address to <code>call</code> to <code>0x454c</code> as that is where it lives in this challenge. Finally, hit assemble and be presented with your shellcode :D</p>
<figure>
<img loading=lazy src=/images/microcorruption/montevideo_shellcode_1.png>
</figure>
<p>I figured a good spot to jump to our shellcode would be just after the <code>ret</code> address at <code>0x4400</code>, so, my password payload was now going to be:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># ret is 0x4400, so 0044 little endian

[padding to ret] +  [ret] +    [shellcode]
---------------------------------------------
    41 * 16      +  0044  +  30127f00b0124c45 =

# final password payload
41414141414141414141414141414141004430127f00b0124c45
</code></pre></div><p>Sending this password payload, and inspecting the program after a breakpoint at <code>0x4548</code> left the program in a confusing state.</p>
<figure>
<img loading=lazy src=/images/microcorruption/montevideo_strcpy_nullbyte.png>
</figure>
<p>It was clear that the jump to <code>0x4400</code> was taken as the program counter (<code>pc</code>) was there, but, my shellcode was missing. Well&mldr; if you have ever dealt with <code>strcpy</code> before, you may have spotted that this was going to happen as soon as I chose <code>0x4400</code> as the address to jump to, as that address contains a nullbyte which is a string terminator for <code>strcpy</code>. Easy fix really, just move along two bytes to avoid a <code>0x00</code> byte in our payload. With a two byte shift, our password payload looks something like this now:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[padding to ret] +  [ret] +  [pad] + [shellcode]
-----------------------------------------------------
    41 * 16      +  0244  +  4242  + 30127f00b0124c45

414141414141414141414141414141410244424230127f00b0124c45
</code></pre></div><figure>
<img loading=lazy src=/images/microcorruption/montevideo_null_byte_shellcode.png>
</figure>
<p>Snap. We have made some progress, but there is still a null byte in our shellcode because of the opcodes that form part of the <code>push #0x7f</code> instruction (<code>3012 7f00</code>). We need to get rid of the <code>0x00</code> byte. We can simply modify the shellcode to use any other instructions that will eventually push the value <code>0xf7</code> to the stack. Think of things like moving a large value into a register, performing arithmetic and then moving the resultant register value onto the stack instead of the original value as is.</p>
<p>I used existing instructions in the program as a reference for ideas on how I can modify the shellcode to avoid null bytes. This was the final shellcode I got to work using the disassembler <a href=https://microcorruption.com/assembler>here</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>mov</span>     <span style=color:#75715e>#0x117e, r9
</span><span style=color:#75715e></span><span style=color:#66d9ef>sub</span>     <span style=color:#75715e>#0x10ff, r9
</span><span style=color:#75715e></span><span style=color:#66d9ef>push</span>    <span style=color:#66d9ef>r9</span>
<span style=color:#a6e22e>call</span>    <span style=color:#75715e>#0x454c
</span></code></pre></div><p>First, I took a large 2 byte value of <code>0x117e</code> and moved that to <code>r9</code>. I then took a calculator and subtracted the desired value of <code>0x7f</code> from <code>0x117e</code> and got to <code>0x10ff</code>. That resulted in my second instruction of <code>sub #0x10ff, r9</code> which should leave the value <code>0x7f</code> in register <code>r9</code>. Finally, just push <code>r9</code> onto the stack and call <code>INT</code>.</p>
<figure>
<img loading=lazy src=/images/microcorruption/montevideo_final_shellcode.png>
</figure>
<p>So now, my final password payload looks as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python <span style=color:#f92672>-</span>c <span style=color:#e6db74>&#34;print(&#39;41&#39; * 16 + &#39;0244&#39; + &#39;4242&#39; + &#39;39407e113980ff100912b0124c45&#39;)&#34;</span>
<span style=color:#ae81ff>414141414141414141414141414141410244424239407e113980</span>ff100912b0124c45
</code></pre></div><figure>
<img loading=lazy src=/images/microcorruption/montevideo_unlock.png>
</figure>
<p>Works! <code>r9</code> ends up as <code>0x7f</code>, pushed to the stack and <code>INT</code> is called to unlock the lock.</p>
<h2 id=solution>solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h2>
<p>Enter <code>414141414141414141414141414141410244424239407e113980ff100912b0124c45</code> as hex encoded input.</p>
<h2 id=other-challenges>other challenges<a hidden class=anchor aria-hidden=true href=#other-challenges>#</a></h2>
<p>For my other write ups in the microcorruption series, checkout <a href=https://leonjza.github.io/categories/microcorruption/>this</a> link.</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://leonjza.github.io/blog/2018/03/09/microcorruption-johannesburg/>
<span class=title>« Prev Page</span>
<br>
<span>microcorruption - johannesburg</span>
</a>
<a class=next href=https://leonjza.github.io/blog/2018/03/07/microcorruption-whitehorse/>
<span class=title>Next Page »</span>
<br>
<span>microcorruption - whitehorse</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share microcorruption - montevideo on twitter" href="https://twitter.com/intent/tweet/?text=microcorruption%20-%20montevideo&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2018%2f03%2f08%2fmicrocorruption-montevideo%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share microcorruption - montevideo on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2018%2f03%2f08%2fmicrocorruption-montevideo%2f&title=microcorruption%20-%20montevideo&summary=microcorruption%20-%20montevideo&source=https%3a%2f%2fleonjza.github.io%2fblog%2f2018%2f03%2f08%2fmicrocorruption-montevideo%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share microcorruption - montevideo on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fleonjza.github.io%2fblog%2f2018%2f03%2f08%2fmicrocorruption-montevideo%2f&title=microcorruption%20-%20montevideo"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share microcorruption - montevideo on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fleonjza.github.io%2fblog%2f2018%2f03%2f08%2fmicrocorruption-montevideo%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share microcorruption - montevideo on whatsapp" href="https://api.whatsapp.com/send?text=microcorruption%20-%20montevideo%20-%20https%3a%2f%2fleonjza.github.io%2fblog%2f2018%2f03%2f08%2fmicrocorruption-montevideo%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share microcorruption - montevideo on telegram" href="https://telegram.me/share/url?text=microcorruption%20-%20montevideo&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2018%2f03%2f08%2fmicrocorruption-montevideo%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>@leonjza</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>