<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>no more jailbreak detection an adventure into Android app reversing and smali patching | #!/bin/note
</title>
<meta name=keywords content>
<meta name=description content="introduction
I will start by saying that I am by no means a expert in anything you are about to read. I am also not 100% sure about the correct terminology for this type of patching. Maybe it should have been called binary patching? I don&rsquo;t know, but I do know that I was quite literally shocked by the ease of getting this job done, and figured its time to make some notes for me to reflect on later again.

     


Recently I had the opportunity to poke at an Android .apk. My task was a little different from what I am about to blog about, but the fundamental idea remained the same. I wanted to inspect some traffic of an application, but the application had jailbreak detection built in and refused to run if the device its running on is detected as jailbroken. This had to be bypassed first. To play with the apk, I needed to get some tools setup and learn a few things about the Android environment really fast. There are tons of resources available online to describe to you the general idea behind Android, as well as how its all stitched together. You will quickly come to realize that apps can be written in Java. For the purpose of this post, the focus is to bypass the jailbreak detection the apk had and let it continue normal operations.">
<meta name=author content="Leon Jacobs">
<link rel=canonical href=https://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://leonjza.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://leonjza.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://leonjza.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://leonjza.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://leonjza.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-44457032-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="no more jailbreak detection an adventure into Android app reversing and smali patching">
<meta property="og:description" content="introduction
I will start by saying that I am by no means a expert in anything you are about to read. I am also not 100% sure about the correct terminology for this type of patching. Maybe it should have been called binary patching? I don&rsquo;t know, but I do know that I was quite literally shocked by the ease of getting this job done, and figured its time to make some notes for me to reflect on later again.

     


Recently I had the opportunity to poke at an Android .apk. My task was a little different from what I am about to blog about, but the fundamental idea remained the same. I wanted to inspect some traffic of an application, but the application had jailbreak detection built in and refused to run if the device its running on is detected as jailbroken. This had to be bypassed first. To play with the apk, I needed to get some tools setup and learn a few things about the Android environment really fast. There are tons of resources available online to describe to you the general idea behind Android, as well as how its all stitched together. You will quickly come to realize that apps can be written in Java. For the purpose of this post, the focus is to bypass the jailbreak detection the apk had and let it continue normal operations.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2015-02-09T19:10:23+00:00">
<meta property="article:modified_time" content="2015-02-09T19:10:23+00:00"><meta property="og:site_name" content="#!/bin/note
">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="no more jailbreak detection an adventure into Android app reversing and smali patching">
<meta name=twitter:description content="introduction
I will start by saying that I am by no means a expert in anything you are about to read. I am also not 100% sure about the correct terminology for this type of patching. Maybe it should have been called binary patching? I don&rsquo;t know, but I do know that I was quite literally shocked by the ease of getting this job done, and figured its time to make some notes for me to reflect on later again.

     


Recently I had the opportunity to poke at an Android .apk. My task was a little different from what I am about to blog about, but the fundamental idea remained the same. I wanted to inspect some traffic of an application, but the application had jailbreak detection built in and refused to run if the device its running on is detected as jailbroken. This had to be bypassed first. To play with the apk, I needed to get some tools setup and learn a few things about the Android environment really fast. There are tons of resources available online to describe to you the general idea behind Android, as well as how its all stitched together. You will quickly come to realize that apps can be written in Java. For the purpose of this post, the focus is to bypass the jailbreak detection the apk had and let it continue normal operations.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://leonjza.github.io/posts/"},{"@type":"ListItem","position":3,"name":"no more jailbreak detection an adventure into Android app reversing and smali patching","item":"https://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"no more jailbreak detection an adventure into Android app reversing and smali patching","name":"no more jailbreak detection an adventure into Android app reversing and smali patching","description":"introduction I will start by saying that I am by no means a expert in anything you are about to read. I am also not 100% sure about the correct terminology for this type of patching. Maybe it should have been called binary patching? I don\u0026rsquo;t know, but I do know that I was quite literally shocked by the ease of getting this job done, and figured its time to make some notes for me to reflect on later again.\n  Recently I had the opportunity to poke at an Android .apk. My task was a little different from what I am about to blog about, but the fundamental idea remained the same. I wanted to inspect some traffic of an application, but the application had jailbreak detection built in and refused to run if the device its running on is detected as jailbroken. This had to be bypassed first. To play with the apk, I needed to get some tools setup and learn a few things about the Android environment really fast. There are tons of resources available online to describe to you the general idea behind Android, as well as how its all stitched together. You will quickly come to realize that apps can be written in Java. For the purpose of this post, the focus is to bypass the jailbreak detection the apk had and let it continue normal operations.\n","keywords":[],"articleBody":"introduction I will start by saying that I am by no means a expert in anything you are about to read. I am also not 100% sure about the correct terminology for this type of patching. Maybe it should have been called binary patching? I don’t know, but I do know that I was quite literally shocked by the ease of getting this job done, and figured its time to make some notes for me to reflect on later again.\n  Recently I had the opportunity to poke at an Android .apk. My task was a little different from what I am about to blog about, but the fundamental idea remained the same. I wanted to inspect some traffic of an application, but the application had jailbreak detection built in and refused to run if the device its running on is detected as jailbroken. This had to be bypassed first. To play with the apk, I needed to get some tools setup and learn a few things about the Android environment really fast. There are tons of resources available online to describe to you the general idea behind Android, as well as how its all stitched together. You will quickly come to realize that apps can be written in Java. For the purpose of this post, the focus is to bypass the jailbreak detection the apk had and let it continue normal operations.\nso what about jailbreaking While I refer to jailbreaking, there are a number of terms used out there to describe the same thing. In the Android world, rooting seems to be what is more commonly known. However, the premise remains the same. Rooting/Jailbreaking your device means that you escape the OS implemented sandboxing and gain full root access to your device. Many mobile applications are against this as a compromised sandbox may have occurred unknowingly, effectively meaning that the device is compromised. So, as a safety measure, applications check for this and refuse to run because of it.\nJailbreak detection itself is a interesting field. From simple static file existence checks, to checking the exit codes of calls to fork() and su all the way to inspecting loaded dynalibs (in the iOS world), everything is fair game. While a compromised device is a totally legit reason to not run any sensitive applications (think credential theft, traffic redirection etc), there are cases where a jailbroken device occurred on purpose. In these cases, power users may find application jailbreak detection very annoying :)\ngetting started The very first thing one would obviously need is the application you want to modify. I already had the apk I wanted to modify at hand. If you don’t have it then there are many ways to get an already installed apk off a device. You just need to Google it :) Like, this.\nJust having the apk though was not very useful. I needed something to run it on. I don’t have a hardware device handy so in comes the Android Studio, which includes the SDK and a Emulator. I downloaded the Android Studio here and promptly installed it. I fired it up and clicked next furiously, waiting for more crap to download, till finally it looked like it was done.\n  The next daunting task was to find the SDK updater. I wanted to install the x86 Emulator Accelerator amongst other things. Some searching around got me to the directory ~/Library/Android/sdk/tools which had the android and emulator programs I was after. I fired up the SDK updater with ~/Library/Android/sdk/tools/android and updated/installed all the stuff I wanted (yay more downloading). In the end, my installed packages ended up as follows:\n  preparing an actual emulator With the software I needed for the emulator downloaded and ready, it was time to configure a avd (Android Virtual Device). I fired up the command ~/Library/Android/sdk/tools/android avd and was presented with the Android Virtual Device Manager. I then proceeded to create a New device as follows:\n  Saved that and quit the AVD Manager. That is all that I needed for the hardware portion. To test the avd that I have just made, I chose to run it quickly using ~/Library/Android/sdk/tools/emulator -avd test:\n  Aaaand it works! I was actually testing network connectivity of the apk in question, so I will add the information for that at the end of the post as a small FYI.\nWith the emulator running and working, it was time to install the apk to test. To do this, we use a tool call adb. This can be found in ~/Library/Android/sdk/platform-tools/adb. A number of features are available to us using adb, such as pushing files to and from the device and installing applications. The apk I was testing, was installed while the emulator was running:\nleonjza@laptop » ~/Library/Android/sdk/platform-tools/adb install ~/MyApplication.apk * daemon not running. starting it now on port 5037 * * daemon started successfully * 2383 KB/s (4184313 bytes in 1.714s) pkg: /data/local/tmp/MyApplication.apk Success The application popped up under the menu on the emulator and I was able to launch it. However, the application sees the Andriod Emulator as a jailbroken device, and refuses to start up. Not a problem :)\nNote If you get a error such as INSTALL_FAILED_DUPLICATE_PERMISSION, it usually meant that the application is already installed. Simply uninstall it from the emulator and retry the install. The storage on the emulator was persistent throughout reboots for me which was quite nice too.\nlooking at the apk, getting the juicy bits Before I could even begin to think about where to look for the Jailbreak checking code, I first had to understand very quickly how a apk gets to be, and what it contains. Most importantly, the apk can be unzipped and its contents further examined. Wikipedia does a very good of giving you a rundown on a very high level. Just enough to grasp which parts may be of interest. It seemed like the juicy bits I am after will be in classes.dex. This is what looks like to be the compiled logic in the [dex file format](http://en.wikipedia.org/wiki/Dalvik_(software) understandable by the Dalvik virtual machine. Ok. But how do I make that into something I can understand?\nIn comes dex2jar. A utility that will convert android dex files into Java source. :) I downloaded the latest archive and extracted it. I then extracted classes.dex from the apk too:\nleonjza@Laptop » unzip MyApplication.apk classes.dex Archive: MyApplication.apk inflating: classes.dex With the classes.dex file ready, I ran it through dex2jar:\nleonjza@Laptop » dex2jar-0.0.9.15/dex2jar.sh classes.dex this cmd is deprecated, use the d2j-dex2jar if possible dex2jar version: translator-0.0.9.15 dex2jar classes.dex - classes_dex2jar.jar Done. I now have a jar file that I could open up in something like Luyten and examine further. I downloaded the latest Luyten jar and opened the classes_dex2jar.jar file with java -jar luyten-0.4.3.jar classes_dex2jar.jar. This totally looks like Java sources for the application :D\nI went through quite a large amount of code, trying to piece together how everything fits into one another. After some time, I finally came across RootDetection.class:\n  This is only a section of the code that attempts to detect if the device that the application is running on is rooted. Quite a number of checks are present, however the failure comes in where its only 1 method that is being used to return the Jailbreak status. This method was right at the end and was called isRooted. You will see in the next few paragraphs how trivial it is to bypass this.\ndecompiling the classes.dex With some knowledge about the code, and knowing what I am after (the RootDetection class, isRooted method), it was time to move on to decompiling the dex to smali. This can be done easily using smali/baksmali which is an assembler/disassembler for Android’s dex format. I downloaded the latest versions of smali and baksmali and prepared to disassemble the classes.dex file that we used earlier to get some Java sources out of.\nUsing the baksmali tool, I pushed classes.dex through it to a output directory of out with java -jar baksmali-2.0.5.jar classes.dex -o out. This produced the disassembled version of the classes.dex and allowed me to read through it. I don’t really get a lot of this smali, but it is not that hard to find what you may be looking for. A simple grep may reveal all the answers:\nleonjza@Laptop » grep -Ri isRooted out/ Binary file out//classes.dex matches out//com/MyApplication/utils/RootDetection.smali:.method public isRooted(Landroid/content/pm/PackageManager;)Z Yay. the isRooted method is easily identifiable. Opening the file containing the the isRooted method reveals the smali too:\n.method public isRooted(Landroid/content/pm/PackageManager;)Z .registers 3 .param p1, \"pm\" # Landroid/content/pm/PackageManager; .prologue .line 74 invoke-direct {p0}, Lcom/MyApplication/utils/RootDetection;-isTestKeyBuild()Z [... snip ...] .line 76 :goto_19 return v0 :cond_1a const/4 v0, 0x0 goto :goto_19 .end method Awesome.\npreparing the patch As we can see, isRooted has quite a bit of logic in it. Referring back to the jar file I created with dex2jar, we can deduce that we want isRooted to return false. Makes sense right? Now, I don’t write smali out of my head, but that did not stop me. How can I see what smali code would look like to just return false? Well, I could just write my own .java code, compile it, and check what the output is like once its disassembled right? Yep!\nSo I created RootDetection.java:\npublic class RootDetection { public boolean isRooted() { return false; } } As you can see, isRooted will now just return false as I’d like it to! I had to hack away a bit at it to get the compilation to pass without errors, and this is probably the step that will usually require a bit of intuition. An important thing to note here is that I had to remove the argument from the original isRooted call. I had to keep this in mind when I was going to patch the original method. Anyways, I compiled the file RootDetection.java using the javac command line:\nleonjza@Laptop » javac -source 1.6 -target 1.6 RootDetection.java warning: [options] bootstrap class path not set in conjunction with -source 1.6 1 warning ------------------------------------------------------------ leonjza@Laptop » file RootDetection.class RootDetection.class: compiled Java class data, version 50.0 (Java 1.6) You will notice I specified the -source and -target flags for javac. If I did not do this, baksmali would have not been able to decompile the java class :(\nWith my compiled method ready, it was time to see what this looks like in smali. There was just one more thing stopping me from seeing that though. The compiled java is not in the dex format that Andriod uses. Luckily there is a tool to convert this that comes with the Android sdk and lives in ~/Library/Android/sdk/build-tools/21.1.1/dx. I converted the class to dex format using the command ~/Library/Android/sdk/build-tools/21.1.1/dx --dex --output=RootDetection.dex RootDetection.class. This produced a new file called RootDetection.dex which is recognizable by baksmali. I then proceeded to decompile the generated .dex with baksmali and set the output to RootDetection/ with java -jar baksmali-2.0.5.jar RootDetection.dex -o RootDetection/. Inspecting the generated smali code, I now had a sample of what it would look like if it should simply return false:\n# virtual methods .method public isRooted()Z .registers 2 .prologue .line 4 const/4 v0, 0x0 return v0 .end method The plan now was to simply replace the originally generated smali from the apk’s classes.dex and re-assemble it using smali. I opened up the original isRooted code and replaced it with the sample that I had generated myself. Remembering the argument I had to remove from my compiled version, I figured that because the original method defined .registers 3, and mine defined .registers 2, I had to up it to 3 to keep the method argument in mind. This was the last modification that I did.\nWith the RootDetection class now patched, I re-assembled the classes.dex file from the generated smali code with java -jar smali-2.0.5.jar -o classes.dex out. The Reassembly generated no errors so I assumed it was successful.\nrepackaging and signing the apk With the patch applied and the new classes.dex generated, it was time to repackage the apk. The first step was to add the new classes.dex to the apk:\nleonjza@Laptop » zip MyApplication.apk classes.dex updating: classes.dex (deflated 56%) Next, the package has to be resigned as the classes.dex will no longer have the same hashes in META-INF/MANIFEST.MF as it originally had. Attempts to install the repackeged apk without resigning it may result in a error such as Failure [INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION]. I used a tool called ‘sign’ found here to get hold of sign.jar. This would sign my apk using the test keys. I downloaded it using wget https://github.com/appium/sign/raw/master/dist/sign.jar, and ran it to sign my patched apk with java -jar sign.jar MyApplication_no_root.apk. This produced a file called MyApplication_no_root.s.apk.\nExcellent. The only thing left for me to do was to install the application using adb and see if my patch worked, which it did! :D The usual error message about the jailbreak no longer displayed and I could continue with the rest of my testing.\nnotes about traffic interception I have covered what I originally intended with the jailbreak detection patching, but want to add a few notes about traffic interception using the Emulator.\nI used Burp Suite to intercept traffic and had it running locally, with a proxy open on tcp/8080. To redirect the emulators traffic though, I had to add a startup option to the emulator as follows:\n~/Library/Android/sdk/tools/emulator -avd test -http-proxy localhost:8080 This proved affective and I was able to see http traffic just fine. However, when it came to https traffic, I wanted to take a spoon and remove my eye. Requests would just ‘hang’, the browser would freak out, the application I was testing would just stall, it was just a mess. Some research into the topic revealed I was not the only one planning some personal surgery and a few bright people have come up with some solutions.\nThe first pain I had was even though I installed the PortSwagger CA onto the device (via ~/Library/Android/sdk/platform-tools/adb push ~/Downloads/BurpCa.cer /storage/sdcard and then the devices Settings - Security - Install form SD Card), the certificate validation would still just fail due to date errors. So, I moved the devices date on by 3 days, and viola! Grr.\nThe next pain was the fact that the Emulator (or Android OS?) would not attempt to make a request to hostnames, but to the IP’s directly, making it very hard to trace in Burp. Luckily though, I found a script (and lost the original source, but I take no credit for this), that will help with the rewrites to hostnames and pass them to Burp as expected. This was mostly a problem in the application itself and not so much the web browser. The script to help with this was:\n# TODO's: # - Script currently doesn't treat TCP connections a streamed data. Normally we should buffer input # untill enough data has been received and then do our checks. However since the connections are # local all data is received at once (most of the time) so this code does work :) import twisted from twisted.names import server, dns, client from twisted.internet import reactor, defer from twisted.internet.endpoints import TCP4ServerEndpoint from twisted.protocols import portforward import re from socket import * import struct # symbolic definition of getsockopt parameter SO_ORIGINAL_DST = 80 # Mapping of domain name to given unique IP mappings = dict() # Mapping of given unique IP to domain name reversemappings = dict() # --------------------------------------- DNS SERVER --------------------------------------- # Custom DNS server which assigns a unique IP address to every domain, even if # in reality two domains share the same IP. class ProxyResolver(client.Resolver): # Start with IP 1.1.1.1 def __init__(self, servers): client.Resolver.__init__(self, servers=servers) self.ttl = 10 self.ip = [1, 1, 1, 1] # Helper function: Move to next IP and return it as a string def nextIp(self): self.ip[3] += 1 for i in range(3,1,-1): if (self.ip[i] == 255): self.ip[i] = 1 self.ip[i-1] += 1 return str(self.ip[0]) + \".\" + str(self.ip[1]) + \".\" +str(self.ip[2]) + \".\" +str(self.ip[3]) def lookupAddress(self, name, timeout = None): # If it's the first time a DNS lookup is done for this domain, assign it # a unique IP and update the mappings if (not mappings.has_key(name)): ip = self.nextIp() mappings[name] = ip reversemappings[str(self.ip[0]) + \".\" + str(self.ip[1]) + \".\" +str(self.ip[2]) + \".\" +str(self.ip[3])] = name # Get the mapped IP! ip = mappings[name] print \"DNS:\", name, \"-\", ip # From the manual: \"Defer is useful when you're writing synchronous code to an asynchronous # interface: i.e., some code is calling you expecting a Deferred result, but you don't actually # need to do anything asynchronous. Just return defer.succeed(theResult).\" return defer.succeed([(dns.RRHeader(name, dns.A, dns.IN, self.ttl, dns.Record_A(ip, self.ttl)),), (), ()]) # --------------------------------------- HTTP PROXY --------------------------------------- # Communication between your actual proxy (Burp, WebScarab, ..) and our script. class ProxyClient(portforward.ProxyClient): def __init__(self): self.gotestablished = False self.requestdata = None def setRequestData(self, data): self.requestdata = data def dataReceived(self, data): # TODO: How does this work when proxying a real device?! Connect shouldn't be sent then?! if self.gotestablished or self.requestdata == None: # If the connection has been established just forward the data to the emulator # TODO: Check this portforward.ProxyClient.dataReceived(self, data) else: # TODO: Check this if not \"HTTP/1.0 200 Connection established\\r\\n\\r\\n\" in data: print \"Warning: Unexpected proxy reply:\", repr(data[:30]) else: print \"Proxy CONNECT reply: \", repr(data[:30]) self.gotestablished = True # Forward data to Android self.transport.write(self.requestdata) # TODO: Check this class ProxyClientFactory(portforward.ProxyClientFactory): protocol = ProxyClient # Custom HTTP proxy. Intercepts the CONNECT  command, looks up the corresponding domain name, and # forwards the correct CONNECT  command to your actual proxy. class ProxyServer(portforward.ProxyServer): clientProtocolFactory = ProxyClientFactory def __init__(self): self.receivedfirst = False self.connectre = re.compile(r'CONNECT (\\d+\\.\\d+\\.\\d+\\.\\d+):\\d+ HTTP') self.otherre = re.compile(r'\\w+ http://(\\d+\\.\\d+\\.\\d+\\.\\d+)') self.firstdata = None def dataReceived(self, data): # The first time we recieve data we must check for invisible proxiying and rewrite # the CONNECT/GET requests to use the actual domain name. if not self.receivedfirst: print \"INCOMING TCP CONN: \", repr(data.split(\"\\r\")[0][:40]) # Of course invisible proxying is unnecessairy if the CONNECT command is actually used! # ------------------------- Invisible Proxying Support --------------------------- # TODO: This is UNTESTED and EXPERIMENTAL code \"\"\" # TODO: Get ourselves an Android VMWare image and test this :) # Only do invisible proxifying if there is no CONNECT command # TODO: We should actually check if it *START* with CONNECT if not \"CONNECT\" in data: # We support invisible proxying for real Android devicec, where the computer is configured # as the router, and all HTTP(S) traffic is redirected to our tool. In this scenario we # don't receive a CONNECT request. Instead we get the original destination IP address and # manually construct the CONNECT request. # TODO: Test this on other operating systems than Linux try: # Ask the OS the original destination of the connection dst = socket.getsockopt(self.transport.socket, SOL_IP, SO_ORIGINAL_DST, 16) # Exclamation mark tells unpack that dst is big-endian # 2x : two pad bytes # H : unsigned short (port) # 4s : char string of 4 bytes (ip) # 8x : eight pad bytes srv_port, srv_ip = struct.unpack(\"!2xH4s8x\", dst) if srv_port == 443: self.peer.setRequestData(data) data = \"CONNECT \" + inet_ntoa(srv_ip) + \":\" + str(srv_port) + \" HTTP/1.1\\r\\n\\r\\n\" print \"PROXIFYING HTTPS: \" + repr(data.strip()) # NOTE: If you uncomment this elif block, your proxy must support invisible proxying elif srv_port == 80: # Rewrite to absolute GET request if info available if reversemappings.has_key(inet_ntoa(srv_ip)): data = re.sub(r'^GET ', \"GET http://\" + reversemappings[inet_ntoa(srv_ip)] + \":\" + str(srv_port), data) else: print \"Warning: got redirected HTTP request but unable to find destination hostname:port\" except Exception, e: print \"Something went wrong with invisible proxying:\", e.getMessage() \"\"\" # ------------------- Rewrite CONNECT/GET/POST with domain name --------------------- resultconnect = self.connectre.match(data) resultother = self.otherre.match(data) # TODO: We shouldn't use a normal replace after using regular expressions.. # Replace IP in CONNECT if (resultconnect != None and reversemappings.has_key(resultconnect.group(1))): data = data.replace(resultconnect.group(1), reversemappings[resultconnect.group(1)]) print \"REWRITING CONNECT:\", resultconnect.group(1), \"-\", reversemappings[resultconnect.group(1)] # Replace IP in GET, POST, HEAD, etc elif (resultother != None and reversemappings.has_key(resultother.group(1))): data = data.replace(resultother.group(1), reversemappings[resultother.group(1)]) print \"REWRITING HTTP METHOD:\", resultother.group(1), \"-\", reversemappings[resultother.group(1)] self.firstdata = data self.receivedfirst = True print \"OUTGOING TCP: \", repr(data.split(\"\\r\")[0][:40]) # forward data portforward.ProxyServer.dataReceived(self, data) class ProxyFactory(portforward.ProxyFactory): protocol = ProxyServer def doStart(self): print \"\\t==== Android Proxy Up and Running ====\\n\" def main(): print \"AndroidProxy --- (C) Mathy Vanhoef\" print \"This program comes with ABSOLUTELY NO WARRANTY.\" print print \"DNS server will listen on localhost:53\" print \"HTTP Proxy will listen on localhost:8007\" print #print \"Physical device: Configure your computer dns server and as router (NOT as proxy) and execute\" #print \"\\tiptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8007\" #print \"\\tiptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 8007\" #print print \"Emulator: start it using: emulator @AvdName -http-proxy http://localhost:8007 -dns-server localhost\" print print \"Don't forget to start your normal proxy on localhost:8080\" print # Setup custom DNS server resolvers = [] #resolvers.append(ProxyResolver([('8.8.8.8', 53)])) resolvers.append(ProxyResolver([('10.0.141.20', 53)])) f = server.DNSServerFactory(clients=resolvers) p = dns.DNSDatagramProtocol(f) reactor.listenUDP(53, p) # Setup TCP proxy server endpoint = TCP4ServerEndpoint(reactor, 8007) endpoint.listen(ProxyFactory('localhost', 8080)) # Start DNS and TCP server reactor.run(); if __name__ == \"__main__\": main() Run this with sudo python AndroidProxy.py (assuming you saved it as that), and change your Emulators launch options to ~/Library/Android/sdk/tools/emulator -avd test -http-proxy localhost:8007 -dns-server localhost -debug-proxy. Running it with sudo is needed as the script starts a DNS server locally. The -debug-proxy option is optional, but is useful for further debugging of the traffic.\nAs a final note on the proxy script. At some stage it looked as though names were not being resolved correctly as I was seeing output as DNS: clients3.google.com - 1.1.1.4. This is just the internal storage key and not the IP it resolved :D\nsummary Like I previously mentioned, with limited knowledge about smali and all that jazz, I was able to patch the application to not do the jailbreak detection it is intended to do. Removing jailbreak detection may not be such a big deal, but what else can you change, and how do you protect against that?\n","wordCount":"3662","inLanguage":"en","datePublished":"2015-02-09T19:10:23Z","dateModified":"2015-02-09T19:10:23Z","author":{"@type":"Person","name":"Leon Jacobs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://leonjza.github.io/blog/2015/02/09/no-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching/"},"publisher":{"@type":"Organization","name":"#!/bin/note\n","logo":{"@type":"ImageObject","url":"https://leonjza.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://leonjza.github.io accesskey=h title="#!/bin/note
 (Alt + H)">#!/bin/note
</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://leonjza.github.io/about/ title="About Me">
<span>About Me</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/categories title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://leonjza.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://leonjza.github.io>Home</a>&nbsp;»&nbsp;<a href=https://leonjza.github.io/posts/>Posts</a></div>
<h1 class=post-title>
no more jailbreak detection an adventure into Android app reversing and smali patching
</h1>
<div class=post-meta>February 9, 2015&nbsp;·&nbsp;18 min&nbsp;·&nbsp;Leon Jacobs&nbsp;|&nbsp;<a href=https://github.com/leonjza/leonjza.github.io/tree/source/content/posts/2015-02-09-no-more-jailbreak-detection-an-adventure-into-android-reversing-and-smali-patching.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#introduction aria-label=introduction>introduction</a></li>
<li>
<a href=#so-what-about-jailbreaking aria-label="so what about jailbreaking">so what about jailbreaking</a></li>
<li>
<a href=#getting-started aria-label="getting started">getting started</a></li>
<li>
<a href=#preparing-an-actual-emulator aria-label="preparing an actual emulator">preparing an actual emulator</a></li>
<li>
<a href=#looking-at-the-apk-getting-the-juicy-bits aria-label="looking at the apk, getting the juicy bits">looking at the apk, getting the juicy bits</a></li>
<li>
<a href=#decompiling-the-classesdex aria-label="decompiling the classes.dex">decompiling the classes.dex</a></li>
<li>
<a href=#preparing-the-patch aria-label="preparing the patch">preparing the patch</a></li>
<li>
<a href=#repackaging-and-signing-the-apk aria-label="repackaging and signing the apk">repackaging and signing the apk</a></li>
<li>
<a href=#notes-about-traffic-interception aria-label="notes about traffic interception">notes about traffic interception</a></li>
<li>
<a href=#summary aria-label=summary>summary</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=introduction>introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2>
<p>I will start by saying that I am by <em>no means</em> a expert in anything you are about to read. I am also not 100% sure about the correct terminology for this type of patching. Maybe it should have been called binary patching? I don&rsquo;t know, but I do know that I was quite literally shocked by the ease of getting this job done, and figured its time to make some notes for me to reflect on later again.</p>
<figure>
<img loading=lazy src=/images/android_jailbreak_logo.png>
</figure>
<p>Recently I had the opportunity to poke at an Android <code>.apk</code>. My task was a little different from what I am about to blog about, but the fundamental idea remained the same. I wanted to inspect some traffic of an application, but the application had jailbreak detection built in and refused to run if the device its running on is detected as jailbroken. This had to be bypassed first. To play with the <code>apk</code>, I needed to get some tools setup and learn a few things about the Android environment <em>really</em> fast. There are tons of resources available online to describe to you the general idea behind Android, as well as how its all stitched together. You will quickly come to realize that apps can be written in Java. For the purpose of this post, the focus is to bypass the jailbreak detection the <code>apk</code> had and let it continue normal operations.</p>
<h2 id=so-what-about-jailbreaking>so what about jailbreaking<a hidden class=anchor aria-hidden=true href=#so-what-about-jailbreaking>#</a></h2>
<p>While I refer to jailbreaking, there are a number of terms used out there to describe the same thing. In the Android world, <em>rooting</em> seems to be what is more commonly known. However, the premise remains the same. Rooting/Jailbreaking your device means that you escape the OS implemented sandboxing and gain full <code>root</code> access to your device. Many mobile applications are against this as a compromised sandbox may have occurred unknowingly, effectively meaning that the device is compromised. So, as a safety measure, applications check for this and refuse to run because of it.</p>
<p>Jailbreak detection itself is a interesting field. From simple static file existence checks, to checking the exit codes of calls to <code>fork()</code> and <code>su</code> all the way to inspecting loaded <code>dynalibs</code> (in the iOS world), everything is fair game. While a compromised device is a totally legit reason to not run any sensitive applications (think credential theft, traffic redirection etc), there are cases where a jailbroken device occurred on purpose. In these cases, power users may find application jailbreak detection very annoying :)</p>
<h2 id=getting-started>getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h2>
<p>The very first thing one would obviously need is the application you want to modify. I already had the <code>apk</code> I wanted to modify at hand. If you don’t have it then there are many ways to get an already installed <code>apk</code> off a device. You just need to Google it :) Like, <a href=http://stackoverflow.com/questions/4032960/how-do-i-get-an-apk-file-from-an-android-device>this</a>.</p>
<p>Just having the <code>apk</code> though was not very useful. I needed something to run it on. I don’t have a hardware device handy so in comes the Android Studio, which includes the SDK and a Emulator. I downloaded the Android Studio <a href=http://developer.android.com/sdk/index.html>here</a> and promptly installed it. I fired it up and clicked next furiously, waiting for more crap to download, till finally it looked like it was done.</p>
<figure>
<img loading=lazy src=/images/android_jailbreak_android_studio.png>
</figure>
<p>The next daunting task was to find the SDK updater. I wanted to install the x86 Emulator Accelerator amongst other things. Some searching around got me to the directory <code>~/Library/Android/sdk/tools</code> which had the <code>android</code> and <code>emulator</code> programs I was after. I fired up the SDK updater with <code>~/Library/Android/sdk/tools/android</code> and updated/installed all the stuff I wanted (yay more downloading). In the end, my installed packages ended up as follows:</p>
<figure>
<img loading=lazy src=/images/android_jailbreak_sdk_manager.png>
</figure>
<h2 id=preparing-an-actual-emulator>preparing an actual emulator<a hidden class=anchor aria-hidden=true href=#preparing-an-actual-emulator>#</a></h2>
<p>With the software I needed for the emulator downloaded and ready, it was time to configure a <code>avd</code> (Android Virtual Device). I fired up the command <code>~/Library/Android/sdk/tools/android avd</code> and was presented with the Android Virtual Device Manager. I then proceeded to create a New device as follows:</p>
<figure>
<img loading=lazy src=/images/android_jailbreak_avd.png>
</figure>
<p>Saved that and quit the AVD Manager. That is all that I needed for the hardware portion. To test the <code>avd</code> that I have just made, I chose to run it quickly using <code>~/Library/Android/sdk/tools/emulator -avd test</code>:</p>
<figure>
<img loading=lazy src=/images/android_jailbreak_emulator_running.png>
</figure>
<p>Aaaand it works! I was actually testing network connectivity of the <code>apk</code> in question, so I will add the information for that at the end of the post as a small FYI.</p>
<p>With the emulator running and working, it was time to install the <code>apk</code> to test. To do this, we use a tool call <code>adb</code>. This can be found in <code>~/Library/Android/sdk/platform-tools/adb</code>. A number of features are available to us using <code>adb</code>, such as pushing files to and from the device and installing applications. The <code>apk</code> I was testing, was installed while the emulator was running:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>leonjza@laptop » ~/Library/Android/sdk/platform-tools/adb install ~/MyApplication.apk
* daemon not running. starting it now on port <span style=color:#ae81ff>5037</span> *
* daemon started successfully *
<span style=color:#ae81ff>2383</span> KB/s <span style=color:#f92672>(</span><span style=color:#ae81ff>4184313</span> bytes in 1.714s<span style=color:#f92672>)</span>
    pkg: /data/local/tmp/MyApplication.apk
Success
</code></pre></div><p>The application popped up under the menu on the emulator and I was able to launch it. However, the application sees the Andriod Emulator as a jailbroken device, and refuses to start up. Not a problem :)</p>
<p><strong>Note</strong> If you get a error such as <em>INSTALL_FAILED_DUPLICATE_PERMISSION</em>, it usually meant that the application is already installed. Simply uninstall it from the emulator and retry the install. The storage on the emulator was persistent throughout reboots for me which was quite nice too.</p>
<h2 id=looking-at-the-apk-getting-the-juicy-bits>looking at the apk, getting the juicy bits<a hidden class=anchor aria-hidden=true href=#looking-at-the-apk-getting-the-juicy-bits>#</a></h2>
<p>Before I could even begin to think about where to look for the Jailbreak checking code, I first had to understand very quickly how a <code>apk</code> gets to be, and what it contains. Most importantly, the <code>apk</code> can be unzipped and its contents further examined. <a href=http://en.wikipedia.org/wiki/Android_application_package>Wikipedia</a> does a very good of giving you a rundown on a very high level. Just enough to grasp which parts may be of interest. It seemed like the juicy bits I am after will be in <code>classes.dex</code>. This is what looks like to be the compiled logic in the [dex file format](<a href=http://en.wikipedia.org/wiki/Dalvik_(software)>http://en.wikipedia.org/wiki/Dalvik_(software)</a> understandable by the Dalvik virtual machine. Ok. But how do I make that into something <strong>I</strong> can understand?</p>
<p>In comes <a href=https://code.google.com/p/dex2jar/>dex2jar</a>. A utility that will convert android dex files into Java source. :) I <a href=https://dex2jar.googlecode.com/files/dex2jar-0.0.9.15.zip>downloaded</a> the latest archive and extracted it. I then extracted classes.dex from the <code>apk</code> too:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>leonjza@Laptop » unzip MyApplication.apk classes.dex
Archive:  MyApplication.apk
  inflating: classes.dex
</code></pre></div><p>With the <code>classes.dex</code> file ready, I ran it through <code>dex2jar</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>leonjza@Laptop » dex2jar-0.0.9.15/dex2jar.sh classes.dex
this cmd is deprecated, use the d2j-dex2jar <span style=color:#66d9ef>if</span> possible
dex2jar version: translator-0.0.9.15
dex2jar classes.dex -&gt; classes_dex2jar.jar
Done.
</code></pre></div><p>I now have a <code>jar</code> file that I could open up in something like <a href=http://deathmarine.github.io/Luyten/>Luyten</a> and examine further. I downloaded the latest <a href=https://github.com/deathmarine/Luyten/releases/download/v0.4.3/luyten-0.4.3.jar>Luyten jar</a> and opened the <code>classes_dex2jar.jar</code> file with <code>java -jar luyten-0.4.3.jar classes_dex2jar.jar</code>. This totally looks like Java sources for the application :D</p>
<p>I went through quite a large amount of code, trying to piece together how everything fits into one another. After some time, I finally came across <code>RootDetection.class</code>:</p>
<figure>
<img loading=lazy src=/images/android_jailbreak_root_detection_class.png>
</figure>
<p>This is only a section of the code that attempts to detect if the device that the application is running on is rooted. Quite a number of checks are present, however the failure comes in where its only 1 method that is being used to return the Jailbreak status. This method was right at the end and was called <code>isRooted</code>. You will see in the next few paragraphs how trivial it is to bypass this.</p>
<h2 id=decompiling-the-classesdex>decompiling the classes.dex<a hidden class=anchor aria-hidden=true href=#decompiling-the-classesdex>#</a></h2>
<p>With some knowledge about the code, and knowing what I am after (the <code>RootDetection</code> class, <code>isRooted</code> method), it was time to move on to decompiling the dex to smali. This can be done easily using <a href=https://code.google.com/p/smali/>smali/baksmali</a> which is an assembler/disassembler for Android&rsquo;s dex format. I downloaded the latest versions of <a href=https://bitbucket.org/JesusFreke/smali/downloads/smali-2.0.5.jar>smali</a> and <a href=https://bitbucket.org/JesusFreke/smali/downloads/baksmali-2.0.5.jar>baksmali</a> and prepared to disassemble the <code>classes.dex</code> file that we used earlier to get some Java sources out of.</p>
<p>Using the <code>baksmali</code> tool, I pushed <code>classes.dex</code> through it to a output directory of <code>out</code> with <code>java -jar baksmali-2.0.5.jar classes.dex -o out</code>. This produced the disassembled version of the classes.dex and allowed me to read through it. I don’t really get a lot of this <code>smali</code>, but it is not that hard to find what you may be looking for. A simple grep may reveal all the answers:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>leonjza@Laptop » grep -Ri isRooted out/
Binary file out//classes.dex matches
out//com/MyApplication/utils/RootDetection.smali:.method public isRooted<span style=color:#f92672>(</span>Landroid/content/pm/PackageManager;<span style=color:#f92672>)</span>Z
</code></pre></div><p>Yay. the <code>isRooted</code> method is easily identifiable. Opening the file containing the the <code>isRooted</code> method reveals the smali too:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>.method public isRooted(Landroid/content/pm/PackageManager;)Z
    .registers 3
    .param p1, &#34;pm&#34;    # Landroid/content/pm/PackageManager;

    .prologue
    .line 74
    invoke-direct {p0}, Lcom/MyApplication/utils/RootDetection;-&gt;isTestKeyBuild()Z

[... snip ...]

    .line 76
    :goto_19
    return v0

    :cond_1a
    const/4 v0, 0x0

    goto :goto_19
.end method
</code></pre></div><p>Awesome.</p>
<h2 id=preparing-the-patch>preparing the patch<a hidden class=anchor aria-hidden=true href=#preparing-the-patch>#</a></h2>
<p>As we can see, <code>isRooted</code> has quite a bit of logic in it. Referring back to the <code>jar</code> file I created with <code>dex2jar</code>, we can deduce that we want <code>isRooted</code> to return <code>false</code>. Makes sense right? Now, I don’t write smali out of my head, but that did not stop me. How can I see what smali code would look like to just return <code>false</code>? Well, I could just write my own <code>.java</code> code, compile it, and check what the output is like once its disassembled right? Yep!</p>
<p>So I created <code>RootDetection.java</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RootDetection</span>
<span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isRooted</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>As you can see, <code>isRooted</code> will now just return false as I&rsquo;d like it to! I had to hack away a bit at it to get the compilation to pass without errors, and this is probably the step that will usually require a bit of intuition. An important thing to note here is that I had to remove the argument from the original <code>isRooted</code> call. I had to keep this in mind when I was going to patch the original method. Anyways, I compiled the file <code>RootDetection.java</code> using the <code>javac</code> command line:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>leonjza@Laptop » javac -source 1.6 -target 1.6 RootDetection.java
warning: <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> bootstrap class path not set in conjunction with -source 1.6
<span style=color:#ae81ff>1</span> warning
------------------------------------------------------------
leonjza@Laptop » file RootDetection.class
RootDetection.class: compiled Java class data, version 50.0 <span style=color:#f92672>(</span>Java 1.6<span style=color:#f92672>)</span>
</code></pre></div><p>You will notice I specified the <code>-source</code> and <code>-target</code> flags for <code>javac</code>. If I did not do this, <code>baksmali</code> would have not been able to decompile the java class :(</p>
<p>With my compiled method ready, it was time to see what this looks like in smali. There was just one more thing stopping me from seeing that though. The compiled java is not in the dex format that Andriod uses. Luckily there is a tool to convert this that comes with the Android sdk and lives in <code>~/Library/Android/sdk/build-tools/21.1.1/dx</code>. I converted the <code>class</code> to <code>dex</code> format using the command <code>~/Library/Android/sdk/build-tools/21.1.1/dx --dex --output=RootDetection.dex RootDetection.class</code>. This produced a new file called <code>RootDetection.dex</code> which is recognizable by <code>baksmali</code>. I then proceeded to decompile the generated <code>.dex</code> with <code>baksmali</code> and set the output to <code>RootDetection/</code> with <code>java -jar baksmali-2.0.5.jar RootDetection.dex -o RootDetection/</code>. Inspecting the generated smali code, I now had a sample of what it would look like if it should simply return false:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># virtual methods
.method public isRooted()Z
    .registers 2

    .prologue
    .line 4
    const/4 v0, 0x0

    return v0
.end method
</code></pre></div><p>The plan now was to simply replace the originally generated smali from the <code>apk</code>&rsquo;s <code>classes.dex</code> and re-assemble it using <code>smali</code>. I opened up the original <code>isRooted</code> code and replaced it with the sample that I had generated myself. Remembering the argument I had to remove from my compiled version, I figured that because the original method defined <code>.registers 3</code>, and mine defined <code>.registers 2</code>, I had to up it to 3 to keep the method argument in mind. This was the last modification that I did.</p>
<p>With the <code>RootDetection</code> class now patched, I re-assembled the <code>classes.dex</code> file from the generated smali code with <code>java -jar smali-2.0.5.jar -o classes.dex out</code>. The Reassembly generated no errors so I assumed it was successful.</p>
<h2 id=repackaging-and-signing-the-apk>repackaging and signing the apk<a hidden class=anchor aria-hidden=true href=#repackaging-and-signing-the-apk>#</a></h2>
<p>With the patch applied and the new <code>classes.dex</code> generated, it was time to repackage the <code>apk</code>. The first step was to add the new <code>classes.dex</code> to the <code>apk</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>leonjza@Laptop » zip MyApplication.apk classes.dex
updating: classes.dex <span style=color:#f92672>(</span>deflated 56%<span style=color:#f92672>)</span>
</code></pre></div><p>Next, the package has to be resigned as the <code>classes.dex</code> will no longer have the same hashes in <code>META-INF/MANIFEST.MF</code> as it originally had. Attempts to install the repackeged <code>apk</code> without resigning it may result in a error such as <em>Failure [INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION]</em>. I used a tool called &lsquo;sign&rsquo; found <a href=https://github.com/appium/sign>here</a> to get hold of <code>sign.jar</code>. This would sign my apk using the test keys. I downloaded it using <code>wget https://github.com/appium/sign/raw/master/dist/sign.jar</code>, and ran it to sign my patched <code>apk</code> with <code>java -jar sign.jar MyApplication_no_root.apk</code>. This produced a file called <code>MyApplication_no_root.s.apk</code>.</p>
<p>Excellent. The only thing left for me to do was to install the application using <code>adb</code> and see if my patch worked, which it did! :D The usual error message about the jailbreak no longer displayed and I could continue with the rest of my testing.</p>
<h2 id=notes-about-traffic-interception>notes about traffic interception<a hidden class=anchor aria-hidden=true href=#notes-about-traffic-interception>#</a></h2>
<p>I have covered what I originally intended with the jailbreak detection patching, but want to add a few notes about traffic interception using the Emulator.</p>
<p>I used <a href=http://portswigger.net/burp/>Burp Suite</a> to intercept traffic and had it running locally, with a proxy open on <code>tcp/8080</code>. To redirect the emulators traffic though, I had to add a startup option to the emulator as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/Library/Android/sdk/tools/emulator -avd test -http-proxy localhost:8080
</code></pre></div><p>This proved affective and I was able to see <code>http</code> traffic just fine. However, when it came to <code>https</code> traffic, I wanted to take a spoon and remove my eye. Requests would just &lsquo;hang&rsquo;, the browser would freak out, the application I was testing would just stall, it was just a mess. Some research into the topic revealed I was not the only one planning some personal surgery and a few bright people have come up with some solutions.</p>
<p>The first pain I had was even though I installed the PortSwagger CA onto the device (via <code>~/Library/Android/sdk/platform-tools/adb push ~/Downloads/BurpCa.cer /storage/sdcard</code> and then the devices Settings -> Security -> Install form SD Card), the certificate validation would still just fail due to date errors. So, I moved the devices date on by 3 days, and viola! Grr.</p>
<p>The next pain was the fact that the Emulator (or Android OS?) would not attempt to make a request to hostnames, but to the IP&rsquo;s directly, making it very hard to trace in Burp. Luckily though, I found a script (and lost the original source, but I take no credit for this), that will help with the rewrites to hostnames and pass them to Burp as expected. This was mostly a problem in the application itself and not so much the web browser. The script to help with this was:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># TODO&#39;s:</span>
<span style=color:#75715e># - Script currently doesn&#39;t treat TCP connections a streamed data. Normally we should buffer input</span>
<span style=color:#75715e>#   untill enough data has been received and then do our checks. However since the connections are</span>
<span style=color:#75715e>#   local all data is received at once (most of the time) so this code does work :)</span>
<span style=color:#f92672>import</span> twisted
<span style=color:#f92672>from</span> twisted.names <span style=color:#f92672>import</span> server, dns, client
<span style=color:#f92672>from</span> twisted.internet <span style=color:#f92672>import</span> reactor, defer
<span style=color:#f92672>from</span> twisted.internet.endpoints <span style=color:#f92672>import</span> TCP4ServerEndpoint
<span style=color:#f92672>from</span> twisted.protocols <span style=color:#f92672>import</span> portforward
<span style=color:#f92672>import</span> re
<span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#f92672>import</span> struct

<span style=color:#75715e># symbolic definition of getsockopt parameter</span>
SO_ORIGINAL_DST <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>

<span style=color:#75715e># Mapping of domain name to given unique IP</span>
mappings <span style=color:#f92672>=</span> dict()
<span style=color:#75715e># Mapping of given unique IP to domain name</span>
reversemappings <span style=color:#f92672>=</span> dict()


<span style=color:#75715e># --------------------------------------- DNS SERVER ---------------------------------------</span>


<span style=color:#75715e># Custom DNS server which assigns a unique IP address to every domain, even if</span>
<span style=color:#75715e># in reality two domains share the same IP.</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyResolver</span>(client<span style=color:#f92672>.</span>Resolver):

        <span style=color:#75715e># Start with IP 1.1.1.1</span>
        <span style=color:#66d9ef>def</span> __init__(self, servers):
                client<span style=color:#f92672>.</span>Resolver<span style=color:#f92672>.</span>__init__(self, servers<span style=color:#f92672>=</span>servers)
                self<span style=color:#f92672>.</span>ttl <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
                self<span style=color:#f92672>.</span>ip <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>]

        <span style=color:#75715e># Helper function: Move to next IP and return it as a string</span>
        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>nextIp</span>(self):
                self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
                <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>1</span>,<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
                        <span style=color:#66d9ef>if</span> (self<span style=color:#f92672>.</span>ip[i] <span style=color:#f92672>==</span> <span style=color:#ae81ff>255</span>):
                                self<span style=color:#f92672>.</span>ip[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
                                self<span style=color:#f92672>.</span>ip[i<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
                <span style=color:#66d9ef>return</span> str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span>str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>2</span>]) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span>str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>3</span>])

        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lookupAddress</span>(self, name, timeout <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
                <span style=color:#75715e># If it&#39;s the first time a DNS lookup is done for this domain, assign it</span>
                <span style=color:#75715e># a unique IP and update the mappings</span>
                <span style=color:#66d9ef>if</span> (<span style=color:#f92672>not</span> mappings<span style=color:#f92672>.</span>has_key(name)):
                        ip <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>nextIp()
                        mappings[name] <span style=color:#f92672>=</span> ip
                        reversemappings[str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span>str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>2</span>]) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span>str(self<span style=color:#f92672>.</span>ip[<span style=color:#ae81ff>3</span>])] <span style=color:#f92672>=</span> name

                <span style=color:#75715e># Get the mapped IP!</span>
                ip <span style=color:#f92672>=</span> mappings[name]
                print <span style=color:#e6db74>&#34;DNS:&#34;</span>, name, <span style=color:#e6db74>&#34;-&gt;&#34;</span>, ip

                <span style=color:#75715e># From the manual: &#34;Defer is useful when you&#39;re writing synchronous code to an asynchronous</span>
                <span style=color:#75715e># interface: i.e., some code is calling you expecting a Deferred result, but you don&#39;t actually</span>
                <span style=color:#75715e># need to do anything asynchronous. Just return defer.succeed(theResult).&#34;</span>
                <span style=color:#66d9ef>return</span> defer<span style=color:#f92672>.</span>succeed([(dns<span style=color:#f92672>.</span>RRHeader(name, dns<span style=color:#f92672>.</span>A, dns<span style=color:#f92672>.</span>IN, self<span style=color:#f92672>.</span>ttl, dns<span style=color:#f92672>.</span>Record_A(ip, self<span style=color:#f92672>.</span>ttl)),), (), ()])


<span style=color:#75715e># --------------------------------------- HTTP PROXY ---------------------------------------</span>


<span style=color:#75715e># Communication between your actual proxy (Burp, WebScarab, ..) and our script.</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyClient</span>(portforward<span style=color:#f92672>.</span>ProxyClient):
        <span style=color:#66d9ef>def</span> __init__(self):
                self<span style=color:#f92672>.</span>gotestablished <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
                self<span style=color:#f92672>.</span>requestdata <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>

        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>setRequestData</span>(self, data):
                self<span style=color:#f92672>.</span>requestdata <span style=color:#f92672>=</span> data

        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dataReceived</span>(self, data):
                <span style=color:#75715e># TODO: How does this work when proxying a real device?! Connect shouldn&#39;t be sent then?!</span>
                <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>gotestablished <span style=color:#f92672>or</span> self<span style=color:#f92672>.</span>requestdata <span style=color:#f92672>==</span> <span style=color:#66d9ef>None</span>:
                        <span style=color:#75715e># If the connection has been established just forward the data to the emulator</span>
                        <span style=color:#75715e># TODO: Check this</span>
                        portforward<span style=color:#f92672>.</span>ProxyClient<span style=color:#f92672>.</span>dataReceived(self, data)
                <span style=color:#66d9ef>else</span>:
                        <span style=color:#75715e># TODO: Check this</span>
                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> <span style=color:#e6db74>&#34;HTTP/1.0 200 Connection established</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>in</span> data:
                                print <span style=color:#e6db74>&#34;Warning: Unexpected proxy reply:&#34;</span>, repr(data[:<span style=color:#ae81ff>30</span>])
                        <span style=color:#66d9ef>else</span>:
                                print <span style=color:#e6db74>&#34;Proxy CONNECT reply: &gt;&#34;</span>, repr(data[:<span style=color:#ae81ff>30</span>])

                        self<span style=color:#f92672>.</span>gotestablished <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
                        <span style=color:#75715e># Forward data to Android</span>
                        self<span style=color:#f92672>.</span>transport<span style=color:#f92672>.</span>write(self<span style=color:#f92672>.</span>requestdata)


<span style=color:#75715e># TODO: Check this</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyClientFactory</span>(portforward<span style=color:#f92672>.</span>ProxyClientFactory):
        protocol <span style=color:#f92672>=</span> ProxyClient


<span style=color:#75715e># Custom HTTP proxy. Intercepts the CONNECT &lt;ip&gt; command, looks up the corresponding domain name, and</span>
<span style=color:#75715e># forwards the correct CONNECT &lt;domain&gt; command to your actual proxy.</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyServer</span>(portforward<span style=color:#f92672>.</span>ProxyServer):
        clientProtocolFactory <span style=color:#f92672>=</span> ProxyClientFactory

        <span style=color:#66d9ef>def</span> __init__(self):
                self<span style=color:#f92672>.</span>receivedfirst <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
                self<span style=color:#f92672>.</span>connectre <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;CONNECT (\d+\.\d+\.\d+\.\d+):\d+ HTTP&#39;</span>)
                self<span style=color:#f92672>.</span>otherre <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;\w+ http://(\d+\.\d+\.\d+\.\d+)&#39;</span>)
                self<span style=color:#f92672>.</span>firstdata <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>


        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dataReceived</span>(self, data):
                <span style=color:#75715e># The first time we recieve data we must check for invisible proxiying and rewrite</span>
                <span style=color:#75715e># the CONNECT/GET requests to use the actual domain name.</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>receivedfirst:
                        print <span style=color:#e6db74>&#34;INCOMING TCP CONN: &gt;&#34;</span>, repr(data<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>)[<span style=color:#ae81ff>0</span>][:<span style=color:#ae81ff>40</span>])

                        <span style=color:#75715e># Of course invisible proxying is unnecessairy if the CONNECT command is actually used!</span>

                        <span style=color:#75715e># ------------------------- Invisible Proxying Support ---------------------------</span>

                        <span style=color:#75715e># TODO: This is UNTESTED and EXPERIMENTAL code</span>
                        <span style=color:#e6db74>&#34;&#34;&#34;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>                        # TODO: Get ourselves an Android VMWare image and test this :)
</span><span style=color:#e6db74>                        # Only do invisible proxifying if there is no CONNECT command
</span><span style=color:#e6db74>                        # TODO: We should actually check if it *START* with CONNECT
</span><span style=color:#e6db74>                        if not &#34;CONNECT&#34; in data:
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>                                # We support invisible proxying for real Android devicec, where the computer is configured
</span><span style=color:#e6db74>                                # as the router, and all HTTP(S) traffic is redirected to our tool. In this scenario we
</span><span style=color:#e6db74>                                # don&#39;t receive a CONNECT request. Instead we get the original destination IP address and
</span><span style=color:#e6db74>                                # manually construct the CONNECT request.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>                                # TODO: Test this on other operating systems than Linux
</span><span style=color:#e6db74>                                try:
</span><span style=color:#e6db74>                                        # Ask the OS the original destination of the connection
</span><span style=color:#e6db74>                                        dst = socket.getsockopt(self.transport.socket, SOL_IP, SO_ORIGINAL_DST, 16)
</span><span style=color:#e6db74>                                        # Exclamation mark tells unpack that dst is big-endian
</span><span style=color:#e6db74>                                        # 2x  : two pad bytes
</span><span style=color:#e6db74>                                        # H   : unsigned short (port)
</span><span style=color:#e6db74>                                        # 4s  : char string of 4 bytes (ip)
</span><span style=color:#e6db74>                                        # 8x  : eight pad bytes
</span><span style=color:#e6db74>                                        srv_port, srv_ip = struct.unpack(&#34;!2xH4s8x&#34;, dst)
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>                                        if srv_port == 443:
</span><span style=color:#e6db74>                                                self.peer.setRequestData(data)
</span><span style=color:#e6db74>                                                data = &#34;CONNECT &#34; + inet_ntoa(srv_ip) + &#34;:&#34; + str(srv_port) + &#34; HTTP/1.1</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>&#34;
</span><span style=color:#e6db74>                                                print &#34;PROXIFYING HTTPS: &#34; + repr(data.strip())
</span><span style=color:#e6db74>                                        # NOTE: If you uncomment this elif block, your proxy must support invisible proxying
</span><span style=color:#e6db74>                                        elif srv_port == 80:
</span><span style=color:#e6db74>                                                # Rewrite to absolute GET request if info available
</span><span style=color:#e6db74>                                                if reversemappings.has_key(inet_ntoa(srv_ip)):
</span><span style=color:#e6db74>                                                        data = re.sub(r&#39;^GET &#39;, &#34;GET http://&#34; + reversemappings[inet_ntoa(srv_ip)] + &#34;:&#34; + str(srv_port), data)
</span><span style=color:#e6db74>                                                else:
</span><span style=color:#e6db74>                                                        print &#34;Warning: got redirected HTTP request but unable to find destination hostname:port&#34;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>                                except Exception, e:
</span><span style=color:#e6db74>                                        print &#34;Something went wrong with invisible proxying:&#34;, e.getMessage()
</span><span style=color:#e6db74>                        &#34;&#34;&#34;</span>

                        <span style=color:#75715e># ------------------- Rewrite CONNECT/GET/POST with domain name ---------------------</span>

                        resultconnect <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>connectre<span style=color:#f92672>.</span>match(data)
                        resultother <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>otherre<span style=color:#f92672>.</span>match(data)

                        <span style=color:#75715e># TODO: We shouldn&#39;t use a normal replace after using regular expressions..</span>
                        <span style=color:#75715e># Replace IP in CONNECT</span>
                        <span style=color:#66d9ef>if</span> (resultconnect <span style=color:#f92672>!=</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>and</span> reversemappings<span style=color:#f92672>.</span>has_key(resultconnect<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>))):
                                data <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>replace(resultconnect<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>), reversemappings[resultconnect<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>)])
                                print <span style=color:#e6db74>&#34;REWRITING CONNECT:&#34;</span>, resultconnect<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>), <span style=color:#e6db74>&#34;-&gt;&#34;</span>, reversemappings[resultconnect<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>)]
                        <span style=color:#75715e># Replace IP in GET, POST, HEAD, etc</span>
                        <span style=color:#66d9ef>elif</span> (resultother <span style=color:#f92672>!=</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>and</span> reversemappings<span style=color:#f92672>.</span>has_key(resultother<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>))):
                                data <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>replace(resultother<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>), reversemappings[resultother<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>)])
                                print <span style=color:#e6db74>&#34;REWRITING HTTP METHOD:&#34;</span>, resultother<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>), <span style=color:#e6db74>&#34;-&gt;&#34;</span>, reversemappings[resultother<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>)]

                        self<span style=color:#f92672>.</span>firstdata <span style=color:#f92672>=</span> data
                        self<span style=color:#f92672>.</span>receivedfirst <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>

                        print <span style=color:#e6db74>&#34;OUTGOING TCP: &gt;&#34;</span>, repr(data<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>)[<span style=color:#ae81ff>0</span>][:<span style=color:#ae81ff>40</span>])


                <span style=color:#75715e># forward data</span>
                portforward<span style=color:#f92672>.</span>ProxyServer<span style=color:#f92672>.</span>dataReceived(self, data)



<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyFactory</span>(portforward<span style=color:#f92672>.</span>ProxyFactory):
        protocol <span style=color:#f92672>=</span> ProxyServer

        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>doStart</span>(self):
                print <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>==== Android Proxy Up and Running ====</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
        print <span style=color:#e6db74>&#34;AndroidProxy   ---   (C) Mathy Vanhoef&#34;</span>
        print <span style=color:#e6db74>&#34;This program comes with ABSOLUTELY NO WARRANTY.&#34;</span>
        print
        print <span style=color:#e6db74>&#34;DNS server will listen on localhost:53&#34;</span>
        print <span style=color:#e6db74>&#34;HTTP Proxy will listen on localhost:8007&#34;</span>
        print
        <span style=color:#75715e>#print &#34;Physical device: Configure your computer dns server and as router (NOT as proxy) and execute&#34;</span>
        <span style=color:#75715e>#print &#34;\tiptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8007&#34;</span>
        <span style=color:#75715e>#print &#34;\tiptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 8007&#34;</span>
        <span style=color:#75715e>#print</span>
        print <span style=color:#e6db74>&#34;Emulator: start it using: emulator @AvdName -http-proxy http://localhost:8007 -dns-server localhost&#34;</span>
        print
        print <span style=color:#e6db74>&#34;Don&#39;t forget to start your normal proxy on localhost:8080&#34;</span>
        print

        <span style=color:#75715e># Setup custom DNS server</span>
        resolvers <span style=color:#f92672>=</span> []
        <span style=color:#75715e>#resolvers.append(ProxyResolver([(&#39;8.8.8.8&#39;, 53)]))</span>
        resolvers<span style=color:#f92672>.</span>append(ProxyResolver([(<span style=color:#e6db74>&#39;10.0.141.20&#39;</span>, <span style=color:#ae81ff>53</span>)]))
        f <span style=color:#f92672>=</span> server<span style=color:#f92672>.</span>DNSServerFactory(clients<span style=color:#f92672>=</span>resolvers)
        p <span style=color:#f92672>=</span> dns<span style=color:#f92672>.</span>DNSDatagramProtocol(f)
        reactor<span style=color:#f92672>.</span>listenUDP(<span style=color:#ae81ff>53</span>, p)

        <span style=color:#75715e># Setup TCP proxy server</span>
        endpoint <span style=color:#f92672>=</span> TCP4ServerEndpoint(reactor, <span style=color:#ae81ff>8007</span>)
        endpoint<span style=color:#f92672>.</span>listen(ProxyFactory(<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>8080</span>))

        <span style=color:#75715e># Start DNS and TCP server</span>
        reactor<span style=color:#f92672>.</span>run();


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
        main()
</code></pre></div><p>Run this with <code>sudo python AndroidProxy.py</code> (assuming you saved it as that), and change your Emulators launch options to <code>~/Library/Android/sdk/tools/emulator -avd test -http-proxy localhost:8007 -dns-server localhost -debug-proxy</code>. Running it with sudo is needed as the script starts a DNS server locally. The <code>-debug-proxy</code> option is optional, but is useful for further debugging of the traffic.</p>
<p>As a final note on the proxy script. At some stage it looked as though names were not being resolved correctly as I was seeing output as <code>DNS: clients3.google.com -> 1.1.1.4</code>. This is just the internal storage key and not the IP it resolved :D</p>
<h2 id=summary>summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2>
<p>Like I previously mentioned, with limited knowledge about smali and all that jazz, I was able to patch the application to not do the jailbreak detection it is intended to do. Removing jailbreak detection may not be such a big deal, but what else can you change, and how do you protect against that?</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://leonjza.github.io/blog/2015/02/20/a-trivial-ios-jailbreak-detection-bypass/>
<span class=title>« Prev Page</span>
<br>
<span>a trivial iOS jailbreak detection bypass</span>
</a>
<a class=next href=https://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/>
<span class=title>Next Page »</span>
<br>
<span>hoof to root solving pegasus 1</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share no more jailbreak detection an adventure into Android app reversing and smali patching on twitter" href="https://twitter.com/intent/tweet/?text=no%20more%20jailbreak%20detection%20an%20adventure%20into%20Android%20app%20reversing%20and%20smali%20patching&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2015%2f02%2f09%2fno-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share no more jailbreak detection an adventure into Android app reversing and smali patching on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2015%2f02%2f09%2fno-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching%2f&title=no%20more%20jailbreak%20detection%20an%20adventure%20into%20Android%20app%20reversing%20and%20smali%20patching&summary=no%20more%20jailbreak%20detection%20an%20adventure%20into%20Android%20app%20reversing%20and%20smali%20patching&source=https%3a%2f%2fleonjza.github.io%2fblog%2f2015%2f02%2f09%2fno-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share no more jailbreak detection an adventure into Android app reversing and smali patching on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fleonjza.github.io%2fblog%2f2015%2f02%2f09%2fno-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching%2f&title=no%20more%20jailbreak%20detection%20an%20adventure%20into%20Android%20app%20reversing%20and%20smali%20patching"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share no more jailbreak detection an adventure into Android app reversing and smali patching on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fleonjza.github.io%2fblog%2f2015%2f02%2f09%2fno-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share no more jailbreak detection an adventure into Android app reversing and smali patching on whatsapp" href="https://api.whatsapp.com/send?text=no%20more%20jailbreak%20detection%20an%20adventure%20into%20Android%20app%20reversing%20and%20smali%20patching%20-%20https%3a%2f%2fleonjza.github.io%2fblog%2f2015%2f02%2f09%2fno-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share no more jailbreak detection an adventure into Android app reversing and smali patching on telegram" href="https://telegram.me/share/url?text=no%20more%20jailbreak%20detection%20an%20adventure%20into%20Android%20app%20reversing%20and%20smali%20patching&url=https%3a%2f%2fleonjza.github.io%2fblog%2f2015%2f02%2f09%2fno-more-jailbreak-detection-an-adventure-into-android-app-reversing-and-smali-patching%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>@leonjza</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>